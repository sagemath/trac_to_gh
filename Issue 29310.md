# Issue 29310: Update to matplotlib 3

archive/issues_029310.json:
```json
{
    "body": "CC:  @mkoeppe @egourgoulhon\n\nUpdate to the latest matplotlib, currently version 3.2.1. This is Python 3-only, so it will be for Sphinx 9.2. This is necessary for upgrading Sphinx.\n\nIssue created by migration from https://trac.sagemath.org/ticket/29547\n\n",
    "created_at": "2020-04-21T22:39:23Z",
    "labels": [
        "packages: standard",
        "critical",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.2",
    "title": "Update to matplotlib 3",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/29310",
    "user": "@jhpalmieri"
}
```
CC:  @mkoeppe @egourgoulhon

Update to the latest matplotlib, currently version 3.2.1. This is Python 3-only, so it will be for Sphinx 9.2. This is necessary for upgrading Sphinx.

Issue created by migration from https://trac.sagemath.org/ticket/29547





---

archive/issue_comments_415465.json:
```json
{
    "body": "See also #28449 and #27866#comment:25.",
    "created_at": "2020-04-21T22:40:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29310#issuecomment-415465",
    "user": "@jhpalmieri"
}
```

See also #28449 and #27866#comment:25.



---

archive/issue_comments_415466.json:
```json
{
    "body": "Doctests known to fail in matplotlib 3.1+\n\n```\nsage -t --long --warn-long 88.1 /usr/lib/python3.7/site-packages/sage/combinat/root_system/root_lattice_realizations.py\n**********************************************************************\nFile \"/usr/lib/python3.7/site-packages/sage/combinat/root_system/root_lattice_realizations.py\", line 3134, in sage.combinat.root_system.root_lattice_realizations.RootLatticeRealizations.ParentMethods.?\nFailed example:\n    L.plot_crystal(C)\nExpected:\n    Graphics object consisting of 16 graphics primitives\nGot:\n    doctest:warning\n      File \"/usr/lib/python-exec/python3.7/sage-runtests\", line 178, in <module>\n        err = DC.run()\n      File \"/usr/lib/python3.7/site-packages/sage/doctest/control.py\", line 1216, in run\n        self.run_doctests()\n      File \"/usr/lib/python3.7/site-packages/sage/doctest/control.py\", line 917, in run_doctests\n        self.dispatcher.dispatch()\n      File \"/usr/lib/python3.7/site-packages/sage/doctest/forker.py\", line 2033, in dispatch\n        self.parallel_dispatch()\n      File \"/usr/lib/python3.7/site-packages/sage/doctest/forker.py\", line 1925, in parallel_dispatch\n        w.start()  # This might take some time\n      File \"/usr/lib/python3.7/site-packages/sage/doctest/forker.py\", line 2200, in start\n        super(DocTestWorker, self).start()\n      File \"/usr/lib/python3.7/multiprocessing/process.py\", line 112, in start\n        self._popen = self._Popen(self)\n      File \"/usr/lib/python3.7/multiprocessing/context.py\", line 223, in _Popen\n        return _default_context.get_context().Process._Popen(process_obj)\n      File \"/usr/lib/python3.7/multiprocessing/context.py\", line 277, in _Popen\n        return Popen(process_obj)\n      File \"/usr/lib/python3.7/multiprocessing/popen_fork.py\", line 20, in __init__\n        self._launch(process_obj)\n      File \"/usr/lib/python3.7/multiprocessing/popen_fork.py\", line 74, in _launch\n        code = process_obj._bootstrap()\n      File \"/usr/lib/python3.7/multiprocessing/process.py\", line 297, in _bootstrap\n        self.run()\n      File \"/usr/lib/python3.7/site-packages/sage/doctest/forker.py\", line 2172, in run\n        task(self.options, self.outtmpfile, msgpipe, self.result_queue)\n      File \"/usr/lib/python3.7/site-packages/sage/doctest/forker.py\", line 2504, in __call__\n        doctests, extras = self._run(runner, options, results)\n      File \"/usr/lib/python3.7/site-packages/sage/doctest/forker.py\", line 2553, in _run\n        result = runner.run(test)\n      File \"/usr/lib/python3.7/site-packages/sage/doctest/forker.py\", line 897, in run\n        return self._run(test, compileflags, out)\n      File \"/usr/lib/python3.7/site-packages/sage/doctest/forker.py\", line 681, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/usr/lib/python3.7/site-packages/sage/doctest/forker.py\", line 1123, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.combinat.root_system.root_lattice_realizations.RootLatticeRealizations.ParentMethods.?[2]>\", line 1, in <module>\n        L.plot_crystal(C)\n      File \"/usr/lib/python3.7/site-packages/sage/repl/rich_output/display_manager.py\", line 811, in displayhook\n        plain_text, rich_output = self._rich_output_formatter(obj, dict())\n      File \"/usr/lib/python3.7/site-packages/sage/repl/rich_output/display_manager.py\", line 625, in _rich_output_formatter\n        rich_output = self._call_rich_repr(obj, rich_repr_kwds)\n      File \"/usr/lib/python3.7/site-packages/sage/repl/rich_output/display_manager.py\", line 585, in _call_rich_repr\n        return obj._rich_repr_(self)\n      File \"/usr/lib/python3.7/site-packages/sage/plot/graphics.py\", line 1006, in _rich_repr_\n        self.save, kwds, file_ext, output_container)\n      File \"/usr/lib/python3.7/site-packages/sage/repl/rich_output/display_manager.py\", line 713, in graphics_from_save\n        save_function(filename, **kwds)\n      File \"/usr/lib/python3.7/site-packages/sage/misc/decorators.py\", line 412, in wrapper\n        return func(*args, **kwds)\n      File \"/usr/lib/python3.7/site-packages/sage/plot/graphics.py\", line 3357, in save\n        figure.tight_layout()\n      File \"/usr/lib/python3.7/site-packages/matplotlib/figure.py\", line 2476, in tight_layout\n        pad=pad, h_pad=h_pad, w_pad=w_pad, rect=rect)\n      File \"/usr/lib/python3.7/site-packages/matplotlib/tight_layout.py\", line 362, in get_tight_layout_figure\n        pad=pad, h_pad=h_pad, w_pad=w_pad)\n      File \"/usr/lib/python3.7/site-packages/matplotlib/tight_layout.py\", line 172, in auto_adjust_subplotpars\n        cbook._warn_external('Tight layout not applied. The left and right '\n      File \"/usr/lib/python3.7/site-packages/matplotlib/cbook/__init__.py\", line 2055, in _warn_external\n        warnings.warn(message, category, stacklevel)\n      File \"/usr/lib/python3.7/warnings.py\", line 110, in _showwarnmsg\n        msg.file, msg.line)\n    :\n    UserWarning: Tight layout not applied. The left and right margins cannot be made large enough to accommodate all axes decorations. \n    Graphics object consisting of 16 graphics primitives\n```\n\nand\n\n```\nsage -t --long --warn-long 88.1 /usr/lib/python3.7/site-packages/sage/plot/multigraphics.py\n**********************************************************************\nFile \"/usr/lib/python3.7/site-packages/sage/plot/multigraphics.py\", line 1297, in sage.plot.multigraphics.GraphicsArray.position\nFailed example:\n    G.position(0)  # tol 1.0e-13\nExpected:\n    (0.028906249999999998,\n     0.038541666666666696,\n     0.45390624999999996,\n     0.9229166666666667)\nGot:\n    (0.023437500000000003,\n     0.03415488992713045,\n     0.4627803348994754,\n     0.9345951100728696)\nTolerance exceeded in 4 of 4:\n    0.028906249999999998 vs 0.023437500000000003, tolerance 2e-1 > 1e-13\n    0.038541666666666696 vs 0.03415488992713045, tolerance 2e-1 > 1e-13\n    0.45390624999999996 vs 0.4627803348994754, tolerance 2e-2 > 1e-13\n    0.9229166666666667 vs 0.9345951100728696, tolerance 2e-2 > 1e-13\n**********************************************************************\nFile \"/usr/lib/python3.7/site-packages/sage/plot/multigraphics.py\", line 1302, in sage.plot.multigraphics.GraphicsArray.position\nFailed example:\n    G.position(1)  # tol 1.0e-13\nExpected:\n    (0.5171874999999999,\n     0.038541666666666696,\n     0.45390624999999996,\n     0.9229166666666667)\nGot:\n    (0.5136230468749999,\n     0.19293222169724827,\n     0.46278033489947534,\n     0.617040446532634)\nTolerance exceeded in 4 of 4:\n    0.5171874999999999 vs 0.5136230468749999, tolerance 7e-3 > 1e-13\n    0.038541666666666696 vs 0.19293222169724827, tolerance 5e0 > 1e-13\n    0.45390624999999996 vs 0.46278033489947534, tolerance 2e-2 > 1e-13\n    0.9229166666666667 vs 0.617040446532634, tolerance 4e-1 > 1e-13\n**********************************************************************\n1 item had failures:\n   2 of   6 in sage.plot.multigraphics.GraphicsArray.position\n```\n\nThere may be more in 3.2 but I don't know of them yet.",
    "created_at": "2020-04-21T22:46:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29310#issuecomment-415466",
    "user": "@kiwifb"
}
```

Doctests known to fail in matplotlib 3.1+

```
sage -t --long --warn-long 88.1 /usr/lib/python3.7/site-packages/sage/combinat/root_system/root_lattice_realizations.py
**********************************************************************
File "/usr/lib/python3.7/site-packages/sage/combinat/root_system/root_lattice_realizations.py", line 3134, in sage.combinat.root_system.root_lattice_realizations.RootLatticeRealizations.ParentMethods.?
Failed example:
    L.plot_crystal(C)
Expected:
    Graphics object consisting of 16 graphics primitives
Got:
    doctest:warning
      File "/usr/lib/python-exec/python3.7/sage-runtests", line 178, in <module>
        err = DC.run()
      File "/usr/lib/python3.7/site-packages/sage/doctest/control.py", line 1216, in run
        self.run_doctests()
      File "/usr/lib/python3.7/site-packages/sage/doctest/control.py", line 917, in run_doctests
        self.dispatcher.dispatch()
      File "/usr/lib/python3.7/site-packages/sage/doctest/forker.py", line 2033, in dispatch
        self.parallel_dispatch()
      File "/usr/lib/python3.7/site-packages/sage/doctest/forker.py", line 1925, in parallel_dispatch
        w.start()  # This might take some time
      File "/usr/lib/python3.7/site-packages/sage/doctest/forker.py", line 2200, in start
        super(DocTestWorker, self).start()
      File "/usr/lib/python3.7/multiprocessing/process.py", line 112, in start
        self._popen = self._Popen(self)
      File "/usr/lib/python3.7/multiprocessing/context.py", line 223, in _Popen
        return _default_context.get_context().Process._Popen(process_obj)
      File "/usr/lib/python3.7/multiprocessing/context.py", line 277, in _Popen
        return Popen(process_obj)
      File "/usr/lib/python3.7/multiprocessing/popen_fork.py", line 20, in __init__
        self._launch(process_obj)
      File "/usr/lib/python3.7/multiprocessing/popen_fork.py", line 74, in _launch
        code = process_obj._bootstrap()
      File "/usr/lib/python3.7/multiprocessing/process.py", line 297, in _bootstrap
        self.run()
      File "/usr/lib/python3.7/site-packages/sage/doctest/forker.py", line 2172, in run
        task(self.options, self.outtmpfile, msgpipe, self.result_queue)
      File "/usr/lib/python3.7/site-packages/sage/doctest/forker.py", line 2504, in __call__
        doctests, extras = self._run(runner, options, results)
      File "/usr/lib/python3.7/site-packages/sage/doctest/forker.py", line 2553, in _run
        result = runner.run(test)
      File "/usr/lib/python3.7/site-packages/sage/doctest/forker.py", line 897, in run
        return self._run(test, compileflags, out)
      File "/usr/lib/python3.7/site-packages/sage/doctest/forker.py", line 681, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/usr/lib/python3.7/site-packages/sage/doctest/forker.py", line 1123, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.combinat.root_system.root_lattice_realizations.RootLatticeRealizations.ParentMethods.?[2]>", line 1, in <module>
        L.plot_crystal(C)
      File "/usr/lib/python3.7/site-packages/sage/repl/rich_output/display_manager.py", line 811, in displayhook
        plain_text, rich_output = self._rich_output_formatter(obj, dict())
      File "/usr/lib/python3.7/site-packages/sage/repl/rich_output/display_manager.py", line 625, in _rich_output_formatter
        rich_output = self._call_rich_repr(obj, rich_repr_kwds)
      File "/usr/lib/python3.7/site-packages/sage/repl/rich_output/display_manager.py", line 585, in _call_rich_repr
        return obj._rich_repr_(self)
      File "/usr/lib/python3.7/site-packages/sage/plot/graphics.py", line 1006, in _rich_repr_
        self.save, kwds, file_ext, output_container)
      File "/usr/lib/python3.7/site-packages/sage/repl/rich_output/display_manager.py", line 713, in graphics_from_save
        save_function(filename, **kwds)
      File "/usr/lib/python3.7/site-packages/sage/misc/decorators.py", line 412, in wrapper
        return func(*args, **kwds)
      File "/usr/lib/python3.7/site-packages/sage/plot/graphics.py", line 3357, in save
        figure.tight_layout()
      File "/usr/lib/python3.7/site-packages/matplotlib/figure.py", line 2476, in tight_layout
        pad=pad, h_pad=h_pad, w_pad=w_pad, rect=rect)
      File "/usr/lib/python3.7/site-packages/matplotlib/tight_layout.py", line 362, in get_tight_layout_figure
        pad=pad, h_pad=h_pad, w_pad=w_pad)
      File "/usr/lib/python3.7/site-packages/matplotlib/tight_layout.py", line 172, in auto_adjust_subplotpars
        cbook._warn_external('Tight layout not applied. The left and right '
      File "/usr/lib/python3.7/site-packages/matplotlib/cbook/__init__.py", line 2055, in _warn_external
        warnings.warn(message, category, stacklevel)
      File "/usr/lib/python3.7/warnings.py", line 110, in _showwarnmsg
        msg.file, msg.line)
    :
    UserWarning: Tight layout not applied. The left and right margins cannot be made large enough to accommodate all axes decorations. 
    Graphics object consisting of 16 graphics primitives
```

and

```
sage -t --long --warn-long 88.1 /usr/lib/python3.7/site-packages/sage/plot/multigraphics.py
**********************************************************************
File "/usr/lib/python3.7/site-packages/sage/plot/multigraphics.py", line 1297, in sage.plot.multigraphics.GraphicsArray.position
Failed example:
    G.position(0)  # tol 1.0e-13
Expected:
    (0.028906249999999998,
     0.038541666666666696,
     0.45390624999999996,
     0.9229166666666667)
Got:
    (0.023437500000000003,
     0.03415488992713045,
     0.4627803348994754,
     0.9345951100728696)
Tolerance exceeded in 4 of 4:
    0.028906249999999998 vs 0.023437500000000003, tolerance 2e-1 > 1e-13
    0.038541666666666696 vs 0.03415488992713045, tolerance 2e-1 > 1e-13
    0.45390624999999996 vs 0.4627803348994754, tolerance 2e-2 > 1e-13
    0.9229166666666667 vs 0.9345951100728696, tolerance 2e-2 > 1e-13
**********************************************************************
File "/usr/lib/python3.7/site-packages/sage/plot/multigraphics.py", line 1302, in sage.plot.multigraphics.GraphicsArray.position
Failed example:
    G.position(1)  # tol 1.0e-13
Expected:
    (0.5171874999999999,
     0.038541666666666696,
     0.45390624999999996,
     0.9229166666666667)
Got:
    (0.5136230468749999,
     0.19293222169724827,
     0.46278033489947534,
     0.617040446532634)
Tolerance exceeded in 4 of 4:
    0.5171874999999999 vs 0.5136230468749999, tolerance 7e-3 > 1e-13
    0.038541666666666696 vs 0.19293222169724827, tolerance 5e0 > 1e-13
    0.45390624999999996 vs 0.46278033489947534, tolerance 2e-2 > 1e-13
    0.9229166666666667 vs 0.617040446532634, tolerance 4e-1 > 1e-13
**********************************************************************
1 item had failures:
   2 of   6 in sage.plot.multigraphics.GraphicsArray.position
```

There may be more in 3.2 but I don't know of them yet.



---

archive/issue_comments_415467.json:
```json
{
    "body": "I'm seeing one more:\n\n```\nsage -t --long --warn-long 99.2 src/sage/interacts/test_jupyter.rst\n**********************************************************************\nFile \"src/sage/interacts/test_jupyter.rst\", line 280, in sage.interacts.test_jupyter\nFailed example:\n    test(interacts.statistics.coin)\nExpected:\n    Interactive function <function coin at ...> with 2 widgets\n      n: IntSlider(value=1000, description=u'Number of Tosses', max=10000, min=2, step=100)\n      interval: IntRangeSlider(value=(0, 0), description=u'Plotting range (y)', max=1)\n    doctest:...: UserWarning: Attempting to set identical bottom==top results\n    in singular transformations; automatically expanding.\n    bottom=0.0, top=0.0\nGot:\n    Interactive function <function coin at 0x1505aab00> with 2 widgets\n      n: IntSlider(value=1000, description='Number of Tosses', max=10000, min=2, step=100)\n      interval: IntRangeSlider(value=(0, 0), description='Plotting range (y)', max=1)\n    doctest:warning\n      File \"/Users/palmieri/Desktop/Sage_stuff/git/sage/src/bin/sage-runtests\", line 178, in <module>\n        err = DC.run()\n      File \"/Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python3.7/site-packages/sage/doctest/control.py\", line 1227, in run\n        self.run_doctests()\n      File \"/Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python3.7/site-packages/sage/doctest/control.py\", line 928, in run_doctests\n        self.dispatcher.dispatch()\n      File \"/Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python3.7/site-packages/sage/doctest/forker.py\", line 2033, in dispatch\n        self.parallel_dispatch()\n      File \"/Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python3.7/site-packages/sage/doctest/forker.py\", line 1925, in parallel_dispatch\n        w.start()  # This might take some time\n      File \"/Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python3.7/site-packages/sage/doctest/forker.py\", line 2200, in start\n        super(DocTestWorker, self).start()\n      File \"/usr/local/Cellar/python/3.7.7/Frameworks/Python.framework/Versions/3.7/lib/python3.7/multiprocessing/process.py\", line 112, in start\n        self._popen = self._Popen(self)\n      File \"/usr/local/Cellar/python/3.7.7/Frameworks/Python.framework/Versions/3.7/lib/python3.7/multiprocessing/context.py\", line 223, in _Popen\n        return _default_context.get_context().Process._Popen(process_obj)\n      File \"/usr/local/Cellar/python/3.7.7/Frameworks/Python.framework/Versions/3.7/lib/python3.7/multiprocessing/context.py\", line 277, in _Popen\n        return Popen(process_obj)\n      File \"/usr/local/Cellar/python/3.7.7/Frameworks/Python.framework/Versions/3.7/lib/python3.7/multiprocessing/popen_fork.py\", line 20, in __init__\n        self._launch(process_obj)\n      File \"/usr/local/Cellar/python/3.7.7/Frameworks/Python.framework/Versions/3.7/lib/python3.7/multiprocessing/popen_fork.py\", line 74, in _launch\n        code = process_obj._bootstrap()\n      File \"/usr/local/Cellar/python/3.7.7/Frameworks/Python.framework/Versions/3.7/lib/python3.7/multiprocessing/process.py\", line 297, in _bootstrap\n        self.run()\n      File \"/Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python3.7/site-packages/sage/doctest/forker.py\", line 2172, in run\n        task(self.options, self.outtmpfile, msgpipe, self.result_queue)\n      File \"/Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python3.7/site-packages/sage/doctest/forker.py\", line 2504, in __call__\n        doctests, extras = self._run(runner, options, results)\n      File \"/Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python3.7/site-packages/sage/doctest/forker.py\", line 2553, in _run\n        result = runner.run(test)\n      File \"/Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python3.7/site-packages/sage/doctest/forker.py\", line 897, in run\n        return self._run(test, compileflags, out)\n      File \"/Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python3.7/site-packages/sage/doctest/forker.py\", line 681, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python3.7/site-packages/sage/doctest/forker.py\", line 1123, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.interacts.test_jupyter[26]>\", line 1, in <module>\n        test(interacts.statistics.coin)\n      File \"<doctest sage.interacts.test_jupyter[3]>\", line 6, in test\n        return f(**kwargs)\n      File \"/Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python3.7/site-packages/sage/interacts/library.py\", line 781, in coin\n        show(point(c[1:], gridlines=[None, [0.5]], pointsize=1), ymin=interval[0], ymax=interval[1])\n      File \"/Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python3.7/site-packages/sage/repl/rich_output/pretty_print.py\", line 252, in show\n        pretty_print(*args, **kwds)\n      File \"/Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python3.7/site-packages/sage/repl/rich_output/pretty_print.py\", line 223, in pretty_print\n        dm.display_immediately(*args, **kwds)\n      File \"/Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python3.7/site-packages/sage/repl/rich_output/display_manager.py\", line 837, in display_immediately\n        plain_text, rich_output = self._rich_output_formatter(obj, rich_repr_kwds)\n      File \"/Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python3.7/site-packages/sage/repl/rich_output/display_manager.py\", line 625, in _rich_output_formatter\n        rich_output = self._call_rich_repr(obj, rich_repr_kwds)\n      File \"/Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python3.7/site-packages/sage/repl/rich_output/display_manager.py\", line 583, in _call_rich_repr\n        return obj._rich_repr_(self, **rich_repr_kwds)\n      File \"/Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python3.7/site-packages/sage/plot/graphics.py\", line 1006, in _rich_repr_\n        self.save, kwds, file_ext, output_container)\n      File \"/Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python3.7/site-packages/sage/repl/rich_output/display_manager.py\", line 713, in graphics_from_save\n        save_function(filename, **kwds)\n      File \"/Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python3.7/site-packages/sage/misc/decorators.py\", line 412, in wrapper\n        return func(*args, **kwds)\n      File \"/Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python3.7/site-packages/sage/plot/graphics.py\", line 3315, in save\n        figure = self.matplotlib(**options)\n      File \"/Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python3.7/site-packages/sage/plot/graphics.py\", line 2854, in matplotlib\n        subplot.set_ylim([ymin, ymax])\n      File \"/Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python3.7/site-packages/matplotlib/axes/_base.py\", line 3604, in set_ylim\n        f\"Attempting to set identical bottom == top == {bottom} \"\n      File \"/Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python3.7/site-packages/matplotlib/cbook/__init__.py\", line 1993, in _warn_external\n        warnings.warn(message, category, stacklevel)\n      File \"/usr/local/Cellar/python/3.7.7/Frameworks/Python.framework/Versions/3.7/lib/python3.7/warnings.py\", line 110, in _showwarnmsg\n        msg.file, msg.line)\n    :\n    UserWarning: Attempting to set identical bottom == top == 0.0 results in singular transformations; automatically expanding.\n**********************************************************************\n1 item had failures:\n   1 of  30 in sage.interacts.test_jupyter\n    [29 tests, 1 failure, 6.43 s]\n----------------------------------------------------------------------\nsage -t --long --warn-long 99.2 src/sage/interacts/test_jupyter.rst  # 1 doctest failed\n```\n",
    "created_at": "2020-04-22T01:17:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29310#issuecomment-415467",
    "user": "@jhpalmieri"
}
```

I'm seeing one more:

```
sage -t --long --warn-long 99.2 src/sage/interacts/test_jupyter.rst
**********************************************************************
File "src/sage/interacts/test_jupyter.rst", line 280, in sage.interacts.test_jupyter
Failed example:
    test(interacts.statistics.coin)
Expected:
    Interactive function <function coin at ...> with 2 widgets
      n: IntSlider(value=1000, description=u'Number of Tosses', max=10000, min=2, step=100)
      interval: IntRangeSlider(value=(0, 0), description=u'Plotting range (y)', max=1)
    doctest:...: UserWarning: Attempting to set identical bottom==top results
    in singular transformations; automatically expanding.
    bottom=0.0, top=0.0
Got:
    Interactive function <function coin at 0x1505aab00> with 2 widgets
      n: IntSlider(value=1000, description='Number of Tosses', max=10000, min=2, step=100)
      interval: IntRangeSlider(value=(0, 0), description='Plotting range (y)', max=1)
    doctest:warning
      File "/Users/palmieri/Desktop/Sage_stuff/git/sage/src/bin/sage-runtests", line 178, in <module>
        err = DC.run()
      File "/Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python3.7/site-packages/sage/doctest/control.py", line 1227, in run
        self.run_doctests()
      File "/Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python3.7/site-packages/sage/doctest/control.py", line 928, in run_doctests
        self.dispatcher.dispatch()
      File "/Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 2033, in dispatch
        self.parallel_dispatch()
      File "/Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 1925, in parallel_dispatch
        w.start()  # This might take some time
      File "/Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 2200, in start
        super(DocTestWorker, self).start()
      File "/usr/local/Cellar/python/3.7.7/Frameworks/Python.framework/Versions/3.7/lib/python3.7/multiprocessing/process.py", line 112, in start
        self._popen = self._Popen(self)
      File "/usr/local/Cellar/python/3.7.7/Frameworks/Python.framework/Versions/3.7/lib/python3.7/multiprocessing/context.py", line 223, in _Popen
        return _default_context.get_context().Process._Popen(process_obj)
      File "/usr/local/Cellar/python/3.7.7/Frameworks/Python.framework/Versions/3.7/lib/python3.7/multiprocessing/context.py", line 277, in _Popen
        return Popen(process_obj)
      File "/usr/local/Cellar/python/3.7.7/Frameworks/Python.framework/Versions/3.7/lib/python3.7/multiprocessing/popen_fork.py", line 20, in __init__
        self._launch(process_obj)
      File "/usr/local/Cellar/python/3.7.7/Frameworks/Python.framework/Versions/3.7/lib/python3.7/multiprocessing/popen_fork.py", line 74, in _launch
        code = process_obj._bootstrap()
      File "/usr/local/Cellar/python/3.7.7/Frameworks/Python.framework/Versions/3.7/lib/python3.7/multiprocessing/process.py", line 297, in _bootstrap
        self.run()
      File "/Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 2172, in run
        task(self.options, self.outtmpfile, msgpipe, self.result_queue)
      File "/Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 2504, in __call__
        doctests, extras = self._run(runner, options, results)
      File "/Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 2553, in _run
        result = runner.run(test)
      File "/Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 897, in run
        return self._run(test, compileflags, out)
      File "/Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 681, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 1123, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.interacts.test_jupyter[26]>", line 1, in <module>
        test(interacts.statistics.coin)
      File "<doctest sage.interacts.test_jupyter[3]>", line 6, in test
        return f(**kwargs)
      File "/Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python3.7/site-packages/sage/interacts/library.py", line 781, in coin
        show(point(c[1:], gridlines=[None, [0.5]], pointsize=1), ymin=interval[0], ymax=interval[1])
      File "/Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python3.7/site-packages/sage/repl/rich_output/pretty_print.py", line 252, in show
        pretty_print(*args, **kwds)
      File "/Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python3.7/site-packages/sage/repl/rich_output/pretty_print.py", line 223, in pretty_print
        dm.display_immediately(*args, **kwds)
      File "/Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python3.7/site-packages/sage/repl/rich_output/display_manager.py", line 837, in display_immediately
        plain_text, rich_output = self._rich_output_formatter(obj, rich_repr_kwds)
      File "/Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python3.7/site-packages/sage/repl/rich_output/display_manager.py", line 625, in _rich_output_formatter
        rich_output = self._call_rich_repr(obj, rich_repr_kwds)
      File "/Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python3.7/site-packages/sage/repl/rich_output/display_manager.py", line 583, in _call_rich_repr
        return obj._rich_repr_(self, **rich_repr_kwds)
      File "/Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python3.7/site-packages/sage/plot/graphics.py", line 1006, in _rich_repr_
        self.save, kwds, file_ext, output_container)
      File "/Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python3.7/site-packages/sage/repl/rich_output/display_manager.py", line 713, in graphics_from_save
        save_function(filename, **kwds)
      File "/Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python3.7/site-packages/sage/misc/decorators.py", line 412, in wrapper
        return func(*args, **kwds)
      File "/Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python3.7/site-packages/sage/plot/graphics.py", line 3315, in save
        figure = self.matplotlib(**options)
      File "/Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python3.7/site-packages/sage/plot/graphics.py", line 2854, in matplotlib
        subplot.set_ylim([ymin, ymax])
      File "/Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python3.7/site-packages/matplotlib/axes/_base.py", line 3604, in set_ylim
        f"Attempting to set identical bottom == top == {bottom} "
      File "/Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python3.7/site-packages/matplotlib/cbook/__init__.py", line 1993, in _warn_external
        warnings.warn(message, category, stacklevel)
      File "/usr/local/Cellar/python/3.7.7/Frameworks/Python.framework/Versions/3.7/lib/python3.7/warnings.py", line 110, in _showwarnmsg
        msg.file, msg.line)
    :
    UserWarning: Attempting to set identical bottom == top == 0.0 results in singular transformations; automatically expanding.
**********************************************************************
1 item had failures:
   1 of  30 in sage.interacts.test_jupyter
    [29 tests, 1 failure, 6.43 s]
----------------------------------------------------------------------
sage -t --long --warn-long 99.2 src/sage/interacts/test_jupyter.rst  # 1 doctest failed
```




---

archive/issue_comments_415468.json:
```json
{
    "body": "Here's a branch to work with.\n----\nNew commits:",
    "created_at": "2020-04-22T01:20:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29310#issuecomment-415468",
    "user": "@jhpalmieri"
}
```

Here's a branch to work with.
----
New commits:



---

archive/issue_comments_415469.json:
```json
{
    "body": "That one looks trivial to fix, like my second one. The first one will need more attention.",
    "created_at": "2020-04-22T01:21:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29310#issuecomment-415469",
    "user": "@kiwifb"
}
```

That one looks trivial to fix, like my second one. The first one will need more attention.



---

archive/issue_comments_415470.json:
```json
{
    "body": "That should take care of the easy to fix doctests. I'll go back to that last one later if no ones beats me to it.\n----\nNew commits:",
    "created_at": "2020-04-22T01:38:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29310#issuecomment-415470",
    "user": "@kiwifb"
}
```

That should take care of the easy to fix doctests. I'll go back to that last one later if no ones beats me to it.
----
New commits:



---

archive/issue_comments_415471.json:
```json
{
    "body": "For the remaining doctest failure, I suggest deleting the doctest, or at least deleting the labels. I have some old versions of Sage on my computer, and going back to Sage 8.4 (py2) and 8.5 (py3), I see the same awful picture: see the attachment at #28449. The difference is now that matplotlib produces a warning in addition to producing the same terrible picture, so let's get rid of the warning by eliminating the plot labels.",
    "created_at": "2020-04-22T02:35:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29310#issuecomment-415471",
    "user": "@jhpalmieri"
}
```

For the remaining doctest failure, I suggest deleting the doctest, or at least deleting the labels. I have some old versions of Sage on my computer, and going back to Sage 8.4 (py2) and 8.5 (py3), I see the same awful picture: see the attachment at #28449. The difference is now that matplotlib produces a warning in addition to producing the same terrible picture, so let's get rid of the warning by eliminating the plot labels.



---

archive/issue_comments_415472.json:
```json
{
    "body": "This is ready for testing, I think.\n----\nNew commits:",
    "created_at": "2020-04-22T02:38:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29310#issuecomment-415472",
    "user": "@jhpalmieri"
}
```

This is ready for testing, I think.
----
New commits:



---

archive/issue_comments_415473.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-04-22T02:38:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29310#issuecomment-415473",
    "user": "@jhpalmieri"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_415474.json:
```json
{
    "body": "I was just looking into it. I like your stuff there. But someone familiar with that section of sage should revisit the problem because the code produce horrible stuff whether we test it or not. And someone will have to fix it or establish limits in which it is useful. I guess #28449 should be assigned to someone who can do that.",
    "created_at": "2020-04-22T02:42:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29310#issuecomment-415474",
    "user": "@kiwifb"
}
```

I was just looking into it. I like your stuff there. But someone familiar with that section of sage should revisit the problem because the code produce horrible stuff whether we test it or not. And someone will have to fix it or establish limits in which it is useful. I guess #28449 should be assigned to someone who can do that.



---

archive/issue_comments_415475.json:
```json
{
    "body": "I just added a comment to #28449 about this. I think we should do this for now and let someone who knows the combinatorics part of things come up with a better fix.",
    "created_at": "2020-04-22T02:44:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29310#issuecomment-415475",
    "user": "@jhpalmieri"
}
```

I just added a comment to #28449 about this. I think we should do this for now and let someone who knows the combinatorics part of things come up with a better fix.



---

archive/issue_comments_415476.json:
```json
{
    "body": "Replying to [comment:14 jhpalmieri]:\n> I just added a comment to #28449 about this. I think we should do this for now and let someone who knows the combinatorics part of things come up with a better fix.\n\nAgreed.",
    "created_at": "2020-04-22T02:45:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29310#issuecomment-415476",
    "user": "@kiwifb"
}
```

Replying to [comment:14 jhpalmieri]:
> I just added a comment to #28449 about this. I think we should do this for now and let someone who knows the combinatorics part of things come up with a better fix.

Agreed.



---

archive/issue_comments_415477.json:
```json
{
    "body": "I have run ptestlong on vanilla sage 9.1.rc0 successfully - at least against stuff like matplotlib, my picked up system pari and ppl lead to some failures. But matplotlib-3.2.1 it is all good. We do mutual review of our changes or we find a third party?",
    "created_at": "2020-04-22T05:05:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29310#issuecomment-415477",
    "user": "@kiwifb"
}
```

I have run ptestlong on vanilla sage 9.1.rc0 successfully - at least against stuff like matplotlib, my picked up system pari and ppl lead to some failures. But matplotlib-3.2.1 it is all good. We do mutual review of our changes or we find a third party?



---

archive/issue_comments_415478.json:
```json
{
    "body": "`@`mkoeppe: when you have a chance, can you test this on some different platforms?",
    "created_at": "2020-04-22T05:29:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29310#issuecomment-415478",
    "user": "@jhpalmieri"
}
```

`@`mkoeppe: when you have a chance, can you test this on some different platforms?



---

archive/issue_comments_415479.json:
```json
{
    "body": "Replying to [comment:16 fbissey]:\n> We do mutual review of our changes or we find a third party?\n\nI'm pretty confident in it, and if we get it merged early in the 9.2 cycle, it will get lots of testing. So we could just review each other's changes.",
    "created_at": "2020-04-22T17:25:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29310#issuecomment-415479",
    "user": "@jhpalmieri"
}
```

Replying to [comment:16 fbissey]:
> We do mutual review of our changes or we find a third party?

I'm pretty confident in it, and if we get it merged early in the 9.2 cycle, it will get lots of testing. So we could just review each other's changes.



---

archive/issue_comments_415480.json:
```json
{
    "body": "Needs rebasing on top of current rc",
    "created_at": "2020-04-23T03:08:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29310#issuecomment-415480",
    "user": "@mkoeppe"
}
```

Needs rebasing on top of current rc



---

archive/issue_comments_415481.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2020-04-23T03:08:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29310#issuecomment-415481",
    "user": "@mkoeppe"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_415482.json:
```json
{
    "body": "`@`jhpalmieri, I am leaving the rebasing here to you as you are the current owner. I'll do #28856. MAy be add the `upstream_url` bit in matplotlib in this ticket.",
    "created_at": "2020-04-23T03:15:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29310#issuecomment-415482",
    "user": "@kiwifb"
}
```

`@`jhpalmieri, I am leaving the rebasing here to you as you are the current owner. I'll do #28856. MAy be add the `upstream_url` bit in matplotlib in this ticket.



---

archive/issue_comments_415483.json:
```json
{
    "body": "The rebase will already give you the correct `upstream_url` for matplotlib",
    "created_at": "2020-04-23T03:17:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29310#issuecomment-415483",
    "user": "@mkoeppe"
}
```

The rebase will already give you the correct `upstream_url` for matplotlib



---

archive/issue_comments_415484.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2020-04-23T05:15:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29310#issuecomment-415484",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_415485.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2020-04-23T05:15:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29310#issuecomment-415485",
    "user": "@jhpalmieri"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_415486.json:
```json
{
    "body": "Now that the branch is on top of 9.1.rc1, all that is needed is to push it to a github repository and it will test on various systems",
    "created_at": "2020-04-23T05:24:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29310#issuecomment-415486",
    "user": "@mkoeppe"
}
```

Now that the branch is on top of 9.1.rc1, all that is needed is to push it to a github repository and it will test on various systems



---

archive/issue_comments_415487.json:
```json
{
    "body": "I am seeing a strange doctest failure on two OS X machines:\n\n```\nFile \"src/sage/schemes/elliptic_curves/ell_number_field.py\", line 3944, in sage.schemes.elliptic_curves.ell_number_field.EllipticCurve_number_field.rational_points\nFailed example:\n    E.rational_points(bound=5)\nException raised:\n    Traceback (most recent call last):\n      File \"/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.1.rc1/local/lib/python3.7/site-packages/sage/schemes/generic/algebraic_scheme.py\", line 1820, in rational_points\n        return X.points(**kwds) # checks for proper bound done in points functions\n      File \"/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.1.rc1/local/lib/python3.7/site-packages/sage/schemes/projective/projective_homset.py\", line 275, in points\n        return sieve(X, B)\n      File \"/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.1.rc1/local/lib/python3.7/site-packages/sage/schemes/projective/projective_rational_point.py\", line 559, in sieve\n        rat_points = lift_all_points()\n      File \"/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.1.rc1/local/lib/python3.7/site-packages/sage/schemes/projective/projective_rational_point.py\", line 537, in lift_all_points\n        lifted_points.add(X(tuple(point)))\n      File \"/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.1.rc1/local/lib/python3.7/site-packages/sage/schemes/generic/scheme.py\", line 265, in __call__\n        return self.point(args)\n      File \"/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.1.rc1/local/lib/python3.7/site-packages/sage/schemes/projective/projective_subscheme.py\", line 126, in point\n        return self.point_homset()(v, check=check)\n      File \"/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.1.rc1/local/lib/python3.7/site-packages/sage/schemes/generic/homset.py\", line 275, in __call__\n        return Set_generic.__call__(self, *args, **kwds)\n      File \"sage/structure/parent.pyx\", line 902, in sage.structure.parent.Parent.__call__ (build/cythonized/sage/structure/parent.c:9245)\n        return mor._call_with_args(x, args, kwds)\n      File \"sage/structure/coerce_maps.pyx\", line 180, in sage.structure.coerce_maps.DefaultConvertMap_unique._call_with_args (build/cythonized/sage/structure/coerce_maps.c:5081)\n        raise\n      File \"sage/structure/coerce_maps.pyx\", line 170, in sage.structure.coerce_maps.DefaultConvertMap_unique._call_with_args (build/cythonized/sage/structure/coerce_maps.c:4871)\n        return C._element_constructor(x, **kwds)\n      File \"/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.1.rc1/local/lib/python3.7/site-packages/sage/schemes/generic/homset.py\", line 650, in _element_constructor_\n        return self.codomain()._point(self, v, **kwds)\n      File \"/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.1.rc1/local/lib/python3.7/site-packages/sage/schemes/generic/algebraic_scheme.py\", line 591, in _point\n        return self.__A._point(*args, **kwds)\n      File \"/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.1.rc1/local/lib/python3.7/site-packages/sage/schemes/projective/projective_space.py\", line 1327, in _point\n        return SchemeMorphism_point_projective_field(*args, **kwds)\n      File \"/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.1.rc1/local/lib/python3.7/site-packages/sage/schemes/projective/projective_point.py\", line 1063, in __init__\n        raise TypeError(\"v (=%s) must have %s components\"%(v, d))\n    TypeError: v (=('N',)) must have 3 components\n\n    During handling of the above exception, another exception occurred:\n\n    Traceback (most recent call last):\n      File \"/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.1.rc1/local/lib/python3.7/site-packages/sage/doctest/forker.py\", line 681, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.1.rc1/local/lib/python3.7/site-packages/sage/doctest/forker.py\", line 1123, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.schemes.elliptic_curves.ell_number_field.EllipticCurve_number_field.rational_points[3]>\", line 1, in <module>\n        E.rational_points(bound=Integer(5))\n      File \"/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.1.rc1/local/lib/python3.7/site-packages/sage/schemes/elliptic_curves/ell_number_field.py\", line 3966, in rational_points\n        return [E(pt) for pt in Curve(self).rational_points(**kwds)]\n      File \"/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.1.rc1/local/lib/python3.7/site-packages/sage/schemes/generic/algebraic_scheme.py\", line 1822, in rational_points\n        raise TypeError(\"Unable to enumerate points over %s.\"%F)\n    TypeError: Unable to enumerate points over Rational Field.\n**********************************************************************\nFile \"src/sage/schemes/elliptic_curves/ell_number_field.py\", line 3946, in sage.schemes.elliptic_curves.ell_number_field.EllipticCurve_number_field.rational_points\nFailed example:\n    E.rational_points(bound=6)\nException raised:\n    Traceback (most recent call last):\n      File \"/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.1.rc1/local/lib/python3.7/site-packages/sage/schemes/generic/algebraic_scheme.py\", line 1820, in rational_points\n        return X.points(**kwds) # checks for proper bound done in points functions\n      File \"/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.1.rc1/local/lib/python3.7/site-packages/sage/schemes/projective/projective_homset.py\", line 275, in points\n        return sieve(X, B)\n      File \"/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.1.rc1/local/lib/python3.7/site-packages/sage/schemes/projective/projective_rational_point.py\", line 559, in sieve\n        rat_points = lift_all_points()\n      File \"/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.1.rc1/local/lib/python3.7/site-packages/sage/schemes/projective/projective_rational_point.py\", line 537, in lift_all_points\n        lifted_points.add(X(tuple(point)))\n      File \"/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.1.rc1/local/lib/python3.7/site-packages/sage/schemes/generic/scheme.py\", line 265, in __call__\n        return self.point(args)\n      File \"/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.1.rc1/local/lib/python3.7/site-packages/sage/schemes/projective/projective_subscheme.py\", line 126, in point\n        return self.point_homset()(v, check=check)\n      File \"/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.1.rc1/local/lib/python3.7/site-packages/sage/schemes/generic/homset.py\", line 275, in __call__\n        return Set_generic.__call__(self, *args, **kwds)\n      File \"sage/structure/parent.pyx\", line 902, in sage.structure.parent.Parent.__call__ (build/cythonized/sage/structure/parent.c:9245)\n        return mor._call_with_args(x, args, kwds)\n      File \"sage/structure/coerce_maps.pyx\", line 180, in sage.structure.coerce_maps.DefaultConvertMap_unique._call_with_args (build/cythonized/sage/structure/coerce_maps.c:5081)\n        raise\n      File \"sage/structure/coerce_maps.pyx\", line 170, in sage.structure.coerce_maps.DefaultConvertMap_unique._call_with_args (build/cythonized/sage/structure/coerce_maps.c:4871)\n        return C._element_constructor(x, **kwds)\n      File \"/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.1.rc1/local/lib/python3.7/site-packages/sage/schemes/generic/homset.py\", line 650, in _element_constructor_\n        return self.codomain()._point(self, v, **kwds)\n      File \"/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.1.rc1/local/lib/python3.7/site-packages/sage/schemes/generic/algebraic_scheme.py\", line 591, in _point\n        return self.__A._point(*args, **kwds)\n      File \"/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.1.rc1/local/lib/python3.7/site-packages/sage/schemes/projective/projective_space.py\", line 1327, in _point\n        return SchemeMorphism_point_projective_field(*args, **kwds)\n      File \"/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.1.rc1/local/lib/python3.7/site-packages/sage/schemes/projective/projective_point.py\", line 1063, in __init__\n        raise TypeError(\"v (=%s) must have %s components\"%(v, d))\n    TypeError: v (=('N',)) must have 3 components\n\n    During handling of the above exception, another exception occurred:\n\n    Traceback (most recent call last):\n      File \"/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.1.rc1/local/lib/python3.7/site-packages/sage/doctest/forker.py\", line 681, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.1.rc1/local/lib/python3.7/site-packages/sage/doctest/forker.py\", line 1123, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.schemes.elliptic_curves.ell_number_field.EllipticCurve_number_field.rational_points[4]>\", line 1, in <module>\n        E.rational_points(bound=Integer(6))\n      File \"/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.1.rc1/local/lib/python3.7/site-packages/sage/schemes/elliptic_curves/ell_number_field.py\", line 3966, in rational_points\n        return [E(pt) for pt in Curve(self).rational_points(**kwds)]\n      File \"/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.1.rc1/local/lib/python3.7/site-packages/sage/schemes/generic/algebraic_scheme.py\", line 1822, in rational_points\n        raise TypeError(\"Unable to enumerate points over %s.\"%F)\n    TypeError: Unable to enumerate points over Rational Field.\n**********************************************************************\n1 item had failures:\n   2 of  10 in sage.schemes.elliptic_curves.ell_number_field.EllipticCurve_number_field.rational_points\n```\n\nThis is strange because (a) I can't figure out what it has to do with matplotlib, and (b) tests only fail when run with `--long`, but the indicated tests are not marked `# long time`. The closest place there is a `# long time` tag is over 200 lines earlier.",
    "created_at": "2020-04-23T05:28:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29310#issuecomment-415487",
    "user": "@jhpalmieri"
}
```

I am seeing a strange doctest failure on two OS X machines:

```
File "src/sage/schemes/elliptic_curves/ell_number_field.py", line 3944, in sage.schemes.elliptic_curves.ell_number_field.EllipticCurve_number_field.rational_points
Failed example:
    E.rational_points(bound=5)
Exception raised:
    Traceback (most recent call last):
      File "/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.1.rc1/local/lib/python3.7/site-packages/sage/schemes/generic/algebraic_scheme.py", line 1820, in rational_points
        return X.points(**kwds) # checks for proper bound done in points functions
      File "/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.1.rc1/local/lib/python3.7/site-packages/sage/schemes/projective/projective_homset.py", line 275, in points
        return sieve(X, B)
      File "/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.1.rc1/local/lib/python3.7/site-packages/sage/schemes/projective/projective_rational_point.py", line 559, in sieve
        rat_points = lift_all_points()
      File "/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.1.rc1/local/lib/python3.7/site-packages/sage/schemes/projective/projective_rational_point.py", line 537, in lift_all_points
        lifted_points.add(X(tuple(point)))
      File "/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.1.rc1/local/lib/python3.7/site-packages/sage/schemes/generic/scheme.py", line 265, in __call__
        return self.point(args)
      File "/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.1.rc1/local/lib/python3.7/site-packages/sage/schemes/projective/projective_subscheme.py", line 126, in point
        return self.point_homset()(v, check=check)
      File "/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.1.rc1/local/lib/python3.7/site-packages/sage/schemes/generic/homset.py", line 275, in __call__
        return Set_generic.__call__(self, *args, **kwds)
      File "sage/structure/parent.pyx", line 902, in sage.structure.parent.Parent.__call__ (build/cythonized/sage/structure/parent.c:9245)
        return mor._call_with_args(x, args, kwds)
      File "sage/structure/coerce_maps.pyx", line 180, in sage.structure.coerce_maps.DefaultConvertMap_unique._call_with_args (build/cythonized/sage/structure/coerce_maps.c:5081)
        raise
      File "sage/structure/coerce_maps.pyx", line 170, in sage.structure.coerce_maps.DefaultConvertMap_unique._call_with_args (build/cythonized/sage/structure/coerce_maps.c:4871)
        return C._element_constructor(x, **kwds)
      File "/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.1.rc1/local/lib/python3.7/site-packages/sage/schemes/generic/homset.py", line 650, in _element_constructor_
        return self.codomain()._point(self, v, **kwds)
      File "/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.1.rc1/local/lib/python3.7/site-packages/sage/schemes/generic/algebraic_scheme.py", line 591, in _point
        return self.__A._point(*args, **kwds)
      File "/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.1.rc1/local/lib/python3.7/site-packages/sage/schemes/projective/projective_space.py", line 1327, in _point
        return SchemeMorphism_point_projective_field(*args, **kwds)
      File "/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.1.rc1/local/lib/python3.7/site-packages/sage/schemes/projective/projective_point.py", line 1063, in __init__
        raise TypeError("v (=%s) must have %s components"%(v, d))
    TypeError: v (=('N',)) must have 3 components

    During handling of the above exception, another exception occurred:

    Traceback (most recent call last):
      File "/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.1.rc1/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 681, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.1.rc1/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 1123, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.schemes.elliptic_curves.ell_number_field.EllipticCurve_number_field.rational_points[3]>", line 1, in <module>
        E.rational_points(bound=Integer(5))
      File "/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.1.rc1/local/lib/python3.7/site-packages/sage/schemes/elliptic_curves/ell_number_field.py", line 3966, in rational_points
        return [E(pt) for pt in Curve(self).rational_points(**kwds)]
      File "/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.1.rc1/local/lib/python3.7/site-packages/sage/schemes/generic/algebraic_scheme.py", line 1822, in rational_points
        raise TypeError("Unable to enumerate points over %s."%F)
    TypeError: Unable to enumerate points over Rational Field.
**********************************************************************
File "src/sage/schemes/elliptic_curves/ell_number_field.py", line 3946, in sage.schemes.elliptic_curves.ell_number_field.EllipticCurve_number_field.rational_points
Failed example:
    E.rational_points(bound=6)
Exception raised:
    Traceback (most recent call last):
      File "/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.1.rc1/local/lib/python3.7/site-packages/sage/schemes/generic/algebraic_scheme.py", line 1820, in rational_points
        return X.points(**kwds) # checks for proper bound done in points functions
      File "/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.1.rc1/local/lib/python3.7/site-packages/sage/schemes/projective/projective_homset.py", line 275, in points
        return sieve(X, B)
      File "/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.1.rc1/local/lib/python3.7/site-packages/sage/schemes/projective/projective_rational_point.py", line 559, in sieve
        rat_points = lift_all_points()
      File "/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.1.rc1/local/lib/python3.7/site-packages/sage/schemes/projective/projective_rational_point.py", line 537, in lift_all_points
        lifted_points.add(X(tuple(point)))
      File "/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.1.rc1/local/lib/python3.7/site-packages/sage/schemes/generic/scheme.py", line 265, in __call__
        return self.point(args)
      File "/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.1.rc1/local/lib/python3.7/site-packages/sage/schemes/projective/projective_subscheme.py", line 126, in point
        return self.point_homset()(v, check=check)
      File "/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.1.rc1/local/lib/python3.7/site-packages/sage/schemes/generic/homset.py", line 275, in __call__
        return Set_generic.__call__(self, *args, **kwds)
      File "sage/structure/parent.pyx", line 902, in sage.structure.parent.Parent.__call__ (build/cythonized/sage/structure/parent.c:9245)
        return mor._call_with_args(x, args, kwds)
      File "sage/structure/coerce_maps.pyx", line 180, in sage.structure.coerce_maps.DefaultConvertMap_unique._call_with_args (build/cythonized/sage/structure/coerce_maps.c:5081)
        raise
      File "sage/structure/coerce_maps.pyx", line 170, in sage.structure.coerce_maps.DefaultConvertMap_unique._call_with_args (build/cythonized/sage/structure/coerce_maps.c:4871)
        return C._element_constructor(x, **kwds)
      File "/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.1.rc1/local/lib/python3.7/site-packages/sage/schemes/generic/homset.py", line 650, in _element_constructor_
        return self.codomain()._point(self, v, **kwds)
      File "/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.1.rc1/local/lib/python3.7/site-packages/sage/schemes/generic/algebraic_scheme.py", line 591, in _point
        return self.__A._point(*args, **kwds)
      File "/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.1.rc1/local/lib/python3.7/site-packages/sage/schemes/projective/projective_space.py", line 1327, in _point
        return SchemeMorphism_point_projective_field(*args, **kwds)
      File "/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.1.rc1/local/lib/python3.7/site-packages/sage/schemes/projective/projective_point.py", line 1063, in __init__
        raise TypeError("v (=%s) must have %s components"%(v, d))
    TypeError: v (=('N',)) must have 3 components

    During handling of the above exception, another exception occurred:

    Traceback (most recent call last):
      File "/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.1.rc1/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 681, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.1.rc1/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 1123, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.schemes.elliptic_curves.ell_number_field.EllipticCurve_number_field.rational_points[4]>", line 1, in <module>
        E.rational_points(bound=Integer(6))
      File "/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.1.rc1/local/lib/python3.7/site-packages/sage/schemes/elliptic_curves/ell_number_field.py", line 3966, in rational_points
        return [E(pt) for pt in Curve(self).rational_points(**kwds)]
      File "/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.1.rc1/local/lib/python3.7/site-packages/sage/schemes/generic/algebraic_scheme.py", line 1822, in rational_points
        raise TypeError("Unable to enumerate points over %s."%F)
    TypeError: Unable to enumerate points over Rational Field.
**********************************************************************
1 item had failures:
   2 of  10 in sage.schemes.elliptic_curves.ell_number_field.EllipticCurve_number_field.rational_points
```

This is strange because (a) I can't figure out what it has to do with matplotlib, and (b) tests only fail when run with `--long`, but the indicated tests are not marked `# long time`. The closest place there is a `# long time` tag is over 200 lines earlier.



---

archive/issue_comments_415488.json:
```json
{
    "body": "Looks like pari/lcalc/ratpoints stuff to me.",
    "created_at": "2020-04-23T05:31:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29310#issuecomment-415488",
    "user": "@kiwifb"
}
```

Looks like pari/lcalc/ratpoints stuff to me.



---

archive/issue_comments_415489.json:
```json
{
    "body": "Replying to [comment:26 fbissey]:\n> Looks like pari/lcalc/ratpoints stuff to me.\n\nWhy would that be triggered by an upgrade to matplotlib?",
    "created_at": "2020-04-23T16:52:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29310#issuecomment-415489",
    "user": "@jhpalmieri"
}
```

Replying to [comment:26 fbissey]:
> Looks like pari/lcalc/ratpoints stuff to me.

Why would that be triggered by an upgrade to matplotlib?



---

archive/issue_comments_415490.json:
```json
{
    "body": "Attachment [error_Couldnt_close_file.txt](tarball://root/attachments/some-uuid/ticket29547/error_Couldnt_close_file.txt) by @DaveWitteMorris created at 2020-04-23 23:41:23\n\nError message from running long tests by hand",
    "created_at": "2020-04-23T23:41:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29310#issuecomment-415490",
    "user": "@DaveWitteMorris"
}
```

Attachment [error_Couldnt_close_file.txt](tarball://root/attachments/some-uuid/ticket29547/error_Couldnt_close_file.txt) by @DaveWitteMorris created at 2020-04-23 23:41:23

Error message from running long tests by hand



---

archive/issue_comments_415491.json:
```json
{
    "body": "I think we have a case where stuff may not be in matplotlib itself but some use of matplotlib may prime the memory for an error in another component to happen. In this case it is more a matter of highlighting a bug in that other component.\n\nThe strange bit that could be related to matplotlib is the use of freetype on the calls leading to the error. Is the stuff supposed to display something? If not why is it involved.",
    "created_at": "2020-04-23T23:48:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29310#issuecomment-415491",
    "user": "@kiwifb"
}
```

I think we have a case where stuff may not be in matplotlib itself but some use of matplotlib may prime the memory for an error in another component to happen. In this case it is more a matter of highlighting a bug in that other component.

The strange bit that could be related to matplotlib is the use of freetype on the calls leading to the error. Is the stuff supposed to display something? If not why is it involved.



---

archive/issue_comments_415492.json:
```json
{
    "body": "I don't know whether this info will be of any use, but I opened a sage session and ran the `# long time` tests in the file by hand (plus lines that defined necessary variables), and then ran the test that gives an error. It crashed (and I got a dialogue box that python had quit unexpectedly).  The fundamental problem seems to be:\n\n```\nlibc++abi.dylib: terminating with uncaught exception of type std::runtime_error: Couldn't close file\n```\n\nMy sage session survived, but seems to be pretty hosed.  Now I get the crash even if I try `E.rational_points(bound=1)`. An error log (\"error_Couldnt_close_file.txt\u200b\") is attached.\n\nI did notice that the `# long time` tests on lines 2628, 2766, 2849, and 2855 involve `G.show`, which I suppose may involve matplotlib, so perhaps they have something to do with it.",
    "created_at": "2020-04-23T23:49:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29310#issuecomment-415492",
    "user": "@DaveWitteMorris"
}
```

I don't know whether this info will be of any use, but I opened a sage session and ran the `# long time` tests in the file by hand (plus lines that defined necessary variables), and then ran the test that gives an error. It crashed (and I got a dialogue box that python had quit unexpectedly).  The fundamental problem seems to be:

```
libc++abi.dylib: terminating with uncaught exception of type std::runtime_error: Couldn't close file
```

My sage session survived, but seems to be pretty hosed.  Now I get the crash even if I try `E.rational_points(bound=1)`. An error log ("error_Couldnt_close_file.txt") is attached.

I did notice that the `# long time` tests on lines 2628, 2766, 2849, and 2855 involve `G.show`, which I suppose may involve matplotlib, so perhaps they have something to do with it.



---

archive/issue_comments_415493.json:
```json
{
    "body": "That's good information and that definitely point to the possibility that there is some memory leakage leading to this.",
    "created_at": "2020-04-24T00:01:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29310#issuecomment-415493",
    "user": "@kiwifb"
}
```

That's good information and that definitely point to the possibility that there is some memory leakage leading to this.



---

archive/issue_comments_415494.json:
```json
{
    "body": "If you have time. Does any single one of the long time doctests you highlighted enough to trigger the issue?",
    "created_at": "2020-04-24T00:04:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29310#issuecomment-415494",
    "user": "@kiwifb"
}
```

If you have time. Does any single one of the long time doctests you highlighted enough to trigger the issue?



---

archive/issue_comments_415495.json:
```json
{
    "body": "Here is a short sequence of commands that triggers a problem for me:\n\n```\nsage: K.<i> = QuadraticField(-1)\nsage: E389 = EllipticCurve('389a1')\nsage: EK = E389.change_ring(K)\nsage: P = EK(-1,1); Q = EK(0,-1)\nsage: EK.saturation([P+Q, 17*Q], lower_ht_bound=0.1)\n([(4 : 8 : 1), (0 : -1 : 1)], 17, 0.152460177943143)\nsage: E2 = EllipticCurve(K, [0,0,0,0,1])\nsage: C = E2.isogeny_class()\nsage: G = C.graph()\nsage: G.show()\nLaunched png viewer for Graphics object consisting of 9 graphics primitives\nsage: E = EllipticCurve('11a1')\nsage: E.rational_points(bound=5)\nlibc++abi.dylib: terminating with uncaught exception of type std::runtime_error: Couldn't close file\n------------------------------------------------------------------------\n0   signals.cpython-37m-darwin.so       0x000000010ef05f22 print_backtrace + 66\n1   signals.cpython-37m-darwin.so       0x000000010ef0a1a7 sigdie + 39\n2   signals.cpython-37m-darwin.so       0x000000010ef0a120 sigdie_for_sig + 256\n3   libsystem_platform.dylib            0x00007fff7367d5fd _sigtramp + 29\n...\n```\n",
    "created_at": "2020-04-24T00:26:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29310#issuecomment-415495",
    "user": "@jhpalmieri"
}
```

Here is a short sequence of commands that triggers a problem for me:

```
sage: K.<i> = QuadraticField(-1)
sage: E389 = EllipticCurve('389a1')
sage: EK = E389.change_ring(K)
sage: P = EK(-1,1); Q = EK(0,-1)
sage: EK.saturation([P+Q, 17*Q], lower_ht_bound=0.1)
([(4 : 8 : 1), (0 : -1 : 1)], 17, 0.152460177943143)
sage: E2 = EllipticCurve(K, [0,0,0,0,1])
sage: C = E2.isogeny_class()
sage: G = C.graph()
sage: G.show()
Launched png viewer for Graphics object consisting of 9 graphics primitives
sage: E = EllipticCurve('11a1')
sage: E.rational_points(bound=5)
libc++abi.dylib: terminating with uncaught exception of type std::runtime_error: Couldn't close file
------------------------------------------------------------------------
0   signals.cpython-37m-darwin.so       0x000000010ef05f22 print_backtrace + 66
1   signals.cpython-37m-darwin.so       0x000000010ef0a1a7 sigdie + 39
2   signals.cpython-37m-darwin.so       0x000000010ef0a120 sigdie_for_sig + 256
3   libsystem_platform.dylib            0x00007fff7367d5fd _sigtramp + 29
...
```




---

archive/issue_comments_415496.json:
```json
{
    "body": "And here is the one that I found:\n\n```\npol26 = hilbert_class_polynomial(-4*26)\npol = x^6-x^5+2*x^4+x^3-2*x^2-x-1\nK.<a> = NumberField(pol)\nj1 = pol26.roots(K)[0][0]\nE = EllipticCurve(j=j1)\nC = E.isogeny_class(); len(C) # long time (~11s)\nG = C.graph()\nG.show(edge_labels=False) # long time\n\nE = EllipticCurve(\"11a1\")\nE.rational_points(bound=5)\nE.rational_points(bound=5)\n```\n\nNote that the last command needs to be done twice.  For me (9.1.rc1 on Mac OS 10.15.3), it works the first time, but crashes when it runs again.",
    "created_at": "2020-04-24T00:46:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29310#issuecomment-415496",
    "user": "@DaveWitteMorris"
}
```

And here is the one that I found:

```
pol26 = hilbert_class_polynomial(-4*26)
pol = x^6-x^5+2*x^4+x^3-2*x^2-x-1
K.<a> = NumberField(pol)
j1 = pol26.roots(K)[0][0]
E = EllipticCurve(j=j1)
C = E.isogeny_class(); len(C) # long time (~11s)
G = C.graph()
G.show(edge_labels=False) # long time

E = EllipticCurve("11a1")
E.rational_points(bound=5)
E.rational_points(bound=5)
```

Note that the last command needs to be done twice.  For me (9.1.rc1 on Mac OS 10.15.3), it works the first time, but crashes when it runs again.



---

archive/issue_comments_415497.json:
```json
{
    "body": "The commands from jhpalmieri don't give me an exception unless I do the last command twice (like in mine).\n\n```\nsage: K.<i> = QuadraticField(-1)\nsage: E389 = EllipticCurve('389a1')\nsage: EK = E389.change_ring(K)\nsage: P = EK(-1,1); Q = EK(0,-1)\nsage: EK.saturation([P+Q, 17*Q], lower_ht_bound=0.1)\n([(4 : 8 : 1), (0 : -1 : 1)], 17, 0.152460177943143)\nsage: E2 = EllipticCurve(K, [0,0,0,0,1])\nsage: C = E2.isogeny_class()\nsage: G = C.graph()\nsage: G.show()\nLaunched png viewer for Graphics object consisting of 9 graphics primitives\nsage: E = EllipticCurve('11a1')\nsage: E.rational_points(bound=5)\n[(0 : 1 : 0), (5 : 5 : 1)]\nsage: E.rational_points(bound=5)\nlibc++abi.dylib: terminating with uncaught exception of type std::runtime_error: Couldn't close file\n```\n\nPS `bound=3` gives me the same behavior as `bound=5`, but `bound=2` gives no error until I run it a third time.\n\n```\nsage: K.<i> = QuadraticField(-1)\nsage: E389 = EllipticCurve('389a1')\nsage: EK = E389.change_ring(K)\nsage: P = EK(-1,1); Q = EK(0,-1)\nsage: EK.saturation([P+Q, 17*Q], lower_ht_bound=0.1)\n([(4 : 8 : 1), (0 : -1 : 1)], 17, 0.152460177943143)\nsage: E2 = EllipticCurve(K, [0,0,0,0,1])\nsage: C = E2.isogeny_class()\nsage: G = C.graph()\nsage: G.show()\nLaunched png viewer for Graphics object consisting of 9 graphics primitives\nsage: E = EllipticCurve('11a1')\nsage: E.rational_points(bound=2)\n[(0 : 1 : 0)]\nsage: E.rational_points(bound=2)\n[(0 : 1 : 0)]\nsage: E.rational_points(bound=2)\nlibc++abi.dylib: terminating with uncaught exception of type std::runtime_error: Couldn't close file\n```\n",
    "created_at": "2020-04-24T01:08:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29310#issuecomment-415497",
    "user": "@DaveWitteMorris"
}
```

The commands from jhpalmieri don't give me an exception unless I do the last command twice (like in mine).

```
sage: K.<i> = QuadraticField(-1)
sage: E389 = EllipticCurve('389a1')
sage: EK = E389.change_ring(K)
sage: P = EK(-1,1); Q = EK(0,-1)
sage: EK.saturation([P+Q, 17*Q], lower_ht_bound=0.1)
([(4 : 8 : 1), (0 : -1 : 1)], 17, 0.152460177943143)
sage: E2 = EllipticCurve(K, [0,0,0,0,1])
sage: C = E2.isogeny_class()
sage: G = C.graph()
sage: G.show()
Launched png viewer for Graphics object consisting of 9 graphics primitives
sage: E = EllipticCurve('11a1')
sage: E.rational_points(bound=5)
[(0 : 1 : 0), (5 : 5 : 1)]
sage: E.rational_points(bound=5)
libc++abi.dylib: terminating with uncaught exception of type std::runtime_error: Couldn't close file
```

PS `bound=3` gives me the same behavior as `bound=5`, but `bound=2` gives no error until I run it a third time.

```
sage: K.<i> = QuadraticField(-1)
sage: E389 = EllipticCurve('389a1')
sage: EK = E389.change_ring(K)
sage: P = EK(-1,1); Q = EK(0,-1)
sage: EK.saturation([P+Q, 17*Q], lower_ht_bound=0.1)
([(4 : 8 : 1), (0 : -1 : 1)], 17, 0.152460177943143)
sage: E2 = EllipticCurve(K, [0,0,0,0,1])
sage: C = E2.isogeny_class()
sage: G = C.graph()
sage: G.show()
Launched png viewer for Graphics object consisting of 9 graphics primitives
sage: E = EllipticCurve('11a1')
sage: E.rational_points(bound=2)
[(0 : 1 : 0)]
sage: E.rational_points(bound=2)
[(0 : 1 : 0)]
sage: E.rational_points(bound=2)
libc++abi.dylib: terminating with uncaught exception of type std::runtime_error: Couldn't close file
```




---

archive/issue_comments_415498.json:
```json
{
    "body": "Let me make two unhelpful comments:\n- many of the doctests marked as `# long time` in this file don't actually take a long time. Maybe they used to, but perhaps algorithms have changed, and now they don't.\n- the plot produced in `G = C.graph()` and `G.show()` is very simple: 4 vertices and 4 edges arranged in a square. So it's not clear why `matplotlib` is triggering the problem here. It certainly seems to be, but I don't understand it. Maybe the problem is fundamentally somewhere else, and we're just seeing it now.",
    "created_at": "2020-04-24T03:05:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29310#issuecomment-415498",
    "user": "@jhpalmieri"
}
```

Let me make two unhelpful comments:
- many of the doctests marked as `# long time` in this file don't actually take a long time. Maybe they used to, but perhaps algorithms have changed, and now they don't.
- the plot produced in `G = C.graph()` and `G.show()` is very simple: 4 vertices and 4 edges arranged in a square. So it's not clear why `matplotlib` is triggering the problem here. It certainly seems to be, but I don't understand it. Maybe the problem is fundamentally somewhere else, and we're just seeing it now.



---

archive/issue_comments_415499.json:
```json
{
    "body": "I fairly convinced the update just made a memory leak visible. Either in freetype (which has just been updated) or pari.",
    "created_at": "2020-04-24T03:07:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29310#issuecomment-415499",
    "user": "@kiwifb"
}
```

I fairly convinced the update just made a memory leak visible. Either in freetype (which has just been updated) or pari.



---

archive/issue_comments_415500.json:
```json
{
    "body": "I'm using homebrew's freetype, so I'm guessing that's not it. I'll try building with `./configure --with-system-freetype=no` and see what happens.",
    "created_at": "2020-04-24T03:10:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29310#issuecomment-415500",
    "user": "@jhpalmieri"
}
```

I'm using homebrew's freetype, so I'm guessing that's not it. I'll try building with `./configure --with-system-freetype=no` and see what happens.



---

archive/issue_comments_415501.json:
```json
{
    "body": "Here are a couple of short crashers that use the same elliptic curve for both parts:\n\n```\nsage: E = EllipticCurve(\"11a1\")\nsage: C = E.isogeny_class()\nsage: G = C.graph()\nsage: G.show(edge_labels=False)\nLaunched png viewer for Graphics object consisting of 6 graphics primitives\nsage: E.rational_points(bound=5)\n[(0 : 1 : 0), (5 : 5 : 1)]\nsage: E.rational_points(bound=5)\nlibc++abi.dylib: terminating with uncaught exception of type std::runtime_error: Couldn't close file\n```\n\n\n```\nsage: E = EllipticCurve('389a1')\nsage: C = E.isogeny_class()\nsage: G = C.graph()\nsage: G.show(edge_labels=False)\nLaunched png viewer for Graphics object consisting of 2 graphics primitives\nsage: E.rational_points(bound=5)\nlibc++abi.dylib: terminating with uncaught exception of type std::runtime_error: Couldn't close file\n```\n\nIn the second one, the graph displayed by `G.show()` is a single vertex.",
    "created_at": "2020-04-24T08:53:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29310#issuecomment-415501",
    "user": "@DaveWitteMorris"
}
```

Here are a couple of short crashers that use the same elliptic curve for both parts:

```
sage: E = EllipticCurve("11a1")
sage: C = E.isogeny_class()
sage: G = C.graph()
sage: G.show(edge_labels=False)
Launched png viewer for Graphics object consisting of 6 graphics primitives
sage: E.rational_points(bound=5)
[(0 : 1 : 0), (5 : 5 : 1)]
sage: E.rational_points(bound=5)
libc++abi.dylib: terminating with uncaught exception of type std::runtime_error: Couldn't close file
```


```
sage: E = EllipticCurve('389a1')
sage: C = E.isogeny_class()
sage: G = C.graph()
sage: G.show(edge_labels=False)
Launched png viewer for Graphics object consisting of 2 graphics primitives
sage: E.rational_points(bound=5)
libc++abi.dylib: terminating with uncaught exception of type std::runtime_error: Couldn't close file
```

In the second one, the graph displayed by `G.show()` is a single vertex.



---

archive/issue_comments_415502.json:
```json
{
    "body": "Here is a much simpler example that I hope will help narrow down the issue. I get an exception even if the picture drawn by matplotlib has nothing to do with elliptic curves. \n\n```\nsage: text(\"hi\", (0,0)).show(axes=False)\nLaunched png viewer for Graphics object consisting of 1 graphics primitive\nsage: E = EllipticCurve('389a1')\nsage: E.rational_points(bound=5);\nsage: E.rational_points(bound=5);\nlibc++abi.dylib: terminating with uncaught exception of type std::runtime_error: Couldn't close file\n```\n\nI also get a crash when I change `text(\"hi\", (0,0)).show(axes=False)` to `Graphics().show()` (which only has the x-axis and y-axis, with labels), but not when I change it to `circle((1,1),1).show(axes=False)`. \n\nI think all known examples that cause the problem have text in the picture.",
    "created_at": "2020-04-24T18:36:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29310#issuecomment-415502",
    "user": "@DaveWitteMorris"
}
```

Here is a much simpler example that I hope will help narrow down the issue. I get an exception even if the picture drawn by matplotlib has nothing to do with elliptic curves. 

```
sage: text("hi", (0,0)).show(axes=False)
Launched png viewer for Graphics object consisting of 1 graphics primitive
sage: E = EllipticCurve('389a1')
sage: E.rational_points(bound=5);
sage: E.rational_points(bound=5);
libc++abi.dylib: terminating with uncaught exception of type std::runtime_error: Couldn't close file
```

I also get a crash when I change `text("hi", (0,0)).show(axes=False)` to `Graphics().show()` (which only has the x-axis and y-axis, with labels), but not when I change it to `circle((1,1),1).show(axes=False)`. 

I think all known examples that cause the problem have text in the picture.



---

archive/issue_comments_415503.json:
```json
{
    "body": "There is no crash (for me) if latex typesets the text. This seems to support the suggestion of fbissey in comment:36 that the real culprit may be freetype, rather than matplotlib itself.\n\n```\nsage: from matplotlib import rc\nsage: rc(\"text\", usetex=True)\nsage: text(\"hi\", (0,0)).show(axes=False)\nLaunched png viewer for Graphics object consisting of 1 graphics primitive\nsage: E = EllipticCurve('389a1')\nsage: E.rational_points(bound=5);\nsage: E.rational_points(bound=5);\nsage: E.rational_points(bound=5);\n```\n\nI wrote a loop to repeat the last line 100 times and did not get a crash.",
    "created_at": "2020-05-04T01:12:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29310#issuecomment-415503",
    "user": "@DaveWitteMorris"
}
```

There is no crash (for me) if latex typesets the text. This seems to support the suggestion of fbissey in comment:36 that the real culprit may be freetype, rather than matplotlib itself.

```
sage: from matplotlib import rc
sage: rc("text", usetex=True)
sage: text("hi", (0,0)).show(axes=False)
Launched png viewer for Graphics object consisting of 1 graphics primitive
sage: E = EllipticCurve('389a1')
sage: E.rational_points(bound=5);
sage: E.rational_points(bound=5);
sage: E.rational_points(bound=5);
```

I wrote a loop to repeat the last line 100 times and did not get a crash.



---

archive/issue_comments_415504.json:
```json
{
    "body": "I tried upgrading to freetype 2.10.2, the latest, and I still see the doctest failures.",
    "created_at": "2020-05-21T19:51:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29310#issuecomment-415504",
    "user": "@jhpalmieri"
}
```

I tried upgrading to freetype 2.10.2, the latest, and I still see the doctest failures.



---

archive/issue_comments_415505.json:
```json
{
    "body": "That's annoying. For those who know freetype well, or perhaps how matplotlib connects to it, this is presumably where we have some leakage\n\n```\n12  ft2font.cpython-37m-darwin.so       0x000000039a95d96d _ZL19close_file_callbackP13FT_StreamRec_ + 541\n13  libfreetype.6.dylib                 0x00000003912e4567 destroy_face + 234\n14  libfreetype.6.dylib                 0x00000003912e4427 FT_Done_Face + 153\n15  ft2font.cpython-37m-darwin.so       0x000000039a954ef1 _ZN7FT2FontD2Ev + 97\n16  ft2font.cpython-37m-darwin.so       0x000000039a954fcf _ZN7FT2FontD0Ev + 15\n17  ft2font.cpython-37m-darwin.so       0x000000039a95c668 _ZL17PyFT2Font_deallocP9PyFT2Font + 24\n```\n\nThe deallocation probably doesn't, or leave some objects behind. And on some machines we have a boom when that corrupted memory is accessed.",
    "created_at": "2020-05-21T21:26:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29310#issuecomment-415505",
    "user": "@kiwifb"
}
```

That's annoying. For those who know freetype well, or perhaps how matplotlib connects to it, this is presumably where we have some leakage

```
12  ft2font.cpython-37m-darwin.so       0x000000039a95d96d _ZL19close_file_callbackP13FT_StreamRec_ + 541
13  libfreetype.6.dylib                 0x00000003912e4567 destroy_face + 234
14  libfreetype.6.dylib                 0x00000003912e4427 FT_Done_Face + 153
15  ft2font.cpython-37m-darwin.so       0x000000039a954ef1 _ZN7FT2FontD2Ev + 97
16  ft2font.cpython-37m-darwin.so       0x000000039a954fcf _ZN7FT2FontD0Ev + 15
17  ft2font.cpython-37m-darwin.so       0x000000039a95c668 _ZL17PyFT2Font_deallocP9PyFT2Font + 24
```

The deallocation probably doesn't, or leave some objects behind. And on some machines we have a boom when that corrupted memory is accessed.



---

archive/issue_comments_415506.json:
```json
{
    "body": "I think we may have this https://github.com/matplotlib/matplotlib/pull/15104 in which case we may try to adopt the patch if we can.",
    "created_at": "2020-05-21T21:29:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29310#issuecomment-415506",
    "user": "@kiwifb"
}
```

I think we may have this https://github.com/matplotlib/matplotlib/pull/15104 in which case we may try to adopt the patch if we can.



---

archive/issue_comments_415507.json:
```json
{
    "body": "Ok technically the bug report is in https://github.com/matplotlib/matplotlib/issues/15410 but the fix for it is in the pull above.",
    "created_at": "2020-05-21T21:53:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29310#issuecomment-415507",
    "user": "@kiwifb"
}
```

Ok technically the bug report is in https://github.com/matplotlib/matplotlib/issues/15410 but the fix for it is in the pull above.



---

archive/issue_comments_415508.json:
```json
{
    "body": "This looks promising: tests pass on the file ell_number_field.py. I'm running full tests now. Fran\u00e7ois, can you make a new branch?",
    "created_at": "2020-05-21T22:42:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29310#issuecomment-415508",
    "user": "@jhpalmieri"
}
```

This looks promising: tests pass on the file ell_number_field.py. I'm running full tests now. Franois, can you make a new branch?



---

archive/issue_comments_415509.json:
```json
{
    "body": "Replying to [comment:46 jhpalmieri]:\n> This looks promising: tests pass on the file ell_number_field.py. I'm running full tests now. Fran\u00e7ois, can you make a new branch?\n\nFor the record, I cannot reproduce the problem on my machine. I'll prepare a branch ASAP.",
    "created_at": "2020-05-21T22:45:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29310#issuecomment-415509",
    "user": "@kiwifb"
}
```

Replying to [comment:46 jhpalmieri]:
> This looks promising: tests pass on the file ell_number_field.py. I'm running full tests now. Franois, can you make a new branch?

For the record, I cannot reproduce the problem on my machine. I'll prepare a branch ASAP.



---

archive/issue_comments_415510.json:
```json
{
    "body": "Would it be any easier for distro people if Sage applies the patch only on OS X?",
    "created_at": "2020-05-21T22:51:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29310#issuecomment-415510",
    "user": "@jhpalmieri"
}
```

Would it be any easier for distro people if Sage applies the patch only on OS X?



---

archive/issue_comments_415511.json:
```json
{
    "body": "Replying to [comment:48 jhpalmieri]:\n> Would it be any easier for distro people if Sage applies the patch only on OS X?\n\nI wouldn't think so. If anything distros that see cases may want to adopt the patch. I am thinking of gentoo in prefix on OS X and conda (because it ships on OS X) in particular.",
    "created_at": "2020-05-21T22:54:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29310#issuecomment-415511",
    "user": "@kiwifb"
}
```

Replying to [comment:48 jhpalmieri]:
> Would it be any easier for distro people if Sage applies the patch only on OS X?

I wouldn't think so. If anything distros that see cases may want to adopt the patch. I am thinking of gentoo in prefix on OS X and conda (because it ships on OS X) in particular.



---

archive/issue_comments_415512.json:
```json
{
    "body": "Generally speaking, this patch doesn't affect functionality or behavior in sage. So, from the point of view of distros it is safe. It only deals with a corner case that is not just a sage problem.\n\nBranch done.\n----\nNew commits:",
    "created_at": "2020-05-21T23:08:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29310#issuecomment-415512",
    "user": "@kiwifb"
}
```

Generally speaking, this patch doesn't affect functionality or behavior in sage. So, from the point of view of distros it is safe. It only deals with a corner case that is not just a sage problem.

Branch done.
----
New commits:



---

archive/issue_comments_415513.json:
```json
{
    "body": "This branch eliminates all of the crashes that I saw before. Thanks!",
    "created_at": "2020-05-22T00:36:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29310#issuecomment-415513",
    "user": "@DaveWitteMorris"
}
```

This branch eliminates all of the crashes that I saw before. Thanks!



---

archive/issue_comments_415514.json:
```json
{
    "body": "Replying to [comment:51 gh-DaveWitteMorris]:\n> This branch eliminates all of the crashes that I saw before. Thanks!\n\nGlad to hear it! I guess we are close to have a positive review now.",
    "created_at": "2020-05-22T00:42:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29310#issuecomment-415514",
    "user": "@kiwifb"
}
```

Replying to [comment:51 gh-DaveWitteMorris]:
> This branch eliminates all of the crashes that I saw before. Thanks!

Glad to hear it! I guess we are close to have a positive review now.



---

archive/issue_comments_415515.json:
```json
{
    "body": "Ideally, we would want this ticket to be in the first load of merges towards 9.2.beta0 so we can can proceed quickly with #28856 and have sphinx 3 in beta0 or beta1 at the latest. I and John are authors. Who will volunteer to put their name in the reviewer field towards a positive review.\n\nWe also have to remember that this ticket will break py2 compatibility. And we will have many of that kind asking to be merged very fast.",
    "created_at": "2020-05-22T07:11:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29310#issuecomment-415515",
    "user": "@kiwifb"
}
```

Ideally, we would want this ticket to be in the first load of merges towards 9.2.beta0 so we can can proceed quickly with #28856 and have sphinx 3 in beta0 or beta1 at the latest. I and John are authors. Who will volunteer to put their name in the reviewer field towards a positive review.

We also have to remember that this ticket will break py2 compatibility. And we will have many of that kind asking to be merged very fast.



---

archive/issue_comments_415516.json:
```json
{
    "body": "In my opinion, it's a pretty straightforward update of a standard package. The new patch is the main complicating factor, but that's been accepted upstream already.",
    "created_at": "2020-05-22T17:27:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29310#issuecomment-415516",
    "user": "@jhpalmieri"
}
```

In my opinion, it's a pretty straightforward update of a standard package. The new patch is the main complicating factor, but that's been accepted upstream already.



---

archive/issue_comments_415517.json:
```json
{
    "body": "Now that the upstream patch has been applied, I agree that this ticket seems straightforward. (All issues have been addressed, and the temporary fix mentioned in comment:10 will be remedied when I upload a PR to #28449.) However, the patchbots do not seem to be running on this (comment:24 says something about testing on various systems, but I haven't seen any results from that), and I don't feel I have enough sagemath experience yet to give a positive review on a substantial ticket. (My PRs often need minor corrections.) \n\ncomment:18 suggested that you might review each other's changes. If that is a possibility, then I would endorse it in this case. As an alternative, I would be willing to put my name in the reviewer field if fbissey gives an explicit endorsement of this ticket (I take comment:54 as an endorsement from jhpalmieri), and somebody explains to me why it is ok not to have any test results. But it's great if someone with more experience than me wants to step in.",
    "created_at": "2020-05-22T19:30:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29310#issuecomment-415517",
    "user": "@DaveWitteMorris"
}
```

Now that the upstream patch has been applied, I agree that this ticket seems straightforward. (All issues have been addressed, and the temporary fix mentioned in comment:10 will be remedied when I upload a PR to #28449.) However, the patchbots do not seem to be running on this (comment:24 says something about testing on various systems, but I haven't seen any results from that), and I don't feel I have enough sagemath experience yet to give a positive review on a substantial ticket. (My PRs often need minor corrections.) 

comment:18 suggested that you might review each other's changes. If that is a possibility, then I would endorse it in this case. As an alternative, I would be willing to put my name in the reviewer field if fbissey gives an explicit endorsement of this ticket (I take comment:54 as an endorsement from jhpalmieri), and somebody explains to me why it is ok not to have any test results. But it's great if someone with more experience than me wants to step in.



---

archive/issue_comments_415518.json:
```json
{
    "body": "I think it is best to have at least one other person in the reviewer fied as it show some more people have looked at it. It is not completely untested although not the traditional way you may expect. Both sage-on-gentoo and sage-on-arch ship a variant of this already. And there will be another round of CI before it is finally merged that could catch stuff we haven't already, especially on platform like cygwin.",
    "created_at": "2020-05-22T20:11:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29310#issuecomment-415518",
    "user": "@kiwifb"
}
```

I think it is best to have at least one other person in the reviewer fied as it show some more people have looked at it. It is not completely untested although not the traditional way you may expect. Both sage-on-gentoo and sage-on-arch ship a variant of this already. And there will be another round of CI before it is finally merged that could catch stuff we haven't already, especially on platform like cygwin.



---

archive/issue_comments_415519.json:
```json
{
    "body": "I looked more carefully at what is in the commits, and it all looks good to me. Thanks, both of you, for your work on this! I am setting to positive review.",
    "created_at": "2020-05-24T04:23:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29310#issuecomment-415519",
    "user": "@DaveWitteMorris"
}
```

I looked more carefully at what is in the commits, and it all looks good to me. Thanks, both of you, for your work on this! I am setting to positive review.



---

archive/issue_comments_415520.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-05-24T04:23:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29310#issuecomment-415520",
    "user": "@DaveWitteMorris"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_415521.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-05-26T21:44:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29310#issuecomment-415521",
    "user": "@vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_415522.json:
```json
{
    "body": "On OS Python 3.5:\n\n```\n****************************************************\nPackage 'matplotlib' is currently not installed\nNo legacy uninstaller found for 'matplotlib'; nothing to do\nNOTE: Set SAGE_MATPLOTLIB_GUI to anything but 'no' to try to build the Matplotlib GUI.\nNot building any matplotlib graphical backends.\nInstalling matplotlib-3.2.1\n  File \"setup.py\", line 139\n    raise IOError(f\"Failed to download jquery-ui.  Please download \"\n                                                                   ^\nSyntaxError: invalid syntax\nError: could not determine package name\n********************************************************************************\nError installing matplotlib-3.2.1\n********************************************************************************\n```\n\nWhat exactly are our new system requirements? I posted on sage-devel for clarification",
    "created_at": "2020-05-27T20:12:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29310#issuecomment-415522",
    "user": "@vbraun"
}
```

On OS Python 3.5:

```
****************************************************
Package 'matplotlib' is currently not installed
No legacy uninstaller found for 'matplotlib'; nothing to do
NOTE: Set SAGE_MATPLOTLIB_GUI to anything but 'no' to try to build the Matplotlib GUI.
Not building any matplotlib graphical backends.
Installing matplotlib-3.2.1
  File "setup.py", line 139
    raise IOError(f"Failed to download jquery-ui.  Please download "
                                                                   ^
SyntaxError: invalid syntax
Error: could not determine package name
********************************************************************************
Error installing matplotlib-3.2.1
********************************************************************************
```

What exactly are our new system requirements? I posted on sage-devel for clarification



---

archive/issue_comments_415523.json:
```json
{
    "body": "Resolution changed from fixed to ",
    "created_at": "2020-05-27T20:12:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29310#issuecomment-415523",
    "user": "@vbraun"
}
```

Resolution changed from fixed to 



---

archive/issue_comments_415524.json:
```json
{
    "body": "Changing status from closed to new.",
    "created_at": "2020-05-27T20:12:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29310#issuecomment-415524",
    "user": "@vbraun"
}
```

Changing status from closed to new.



---

archive/issue_comments_415525.json:
```json
{
    "body": "Changing status from new to needs_info.",
    "created_at": "2020-05-27T20:12:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29310#issuecomment-415525",
    "user": "@vbraun"
}
```

Changing status from new to needs_info.



---

archive/issue_comments_415526.json:
```json
{
    "body": "Should we make this change?\n\n```diff\ndiff --git a/build/pkgs/matplotlib/spkg-install.in b/build/pkgs/matplotlib/spkg-install.in\nindex 6b68b46ad5..a427dadccd 100644\n--- a/build/pkgs/matplotlib/spkg-install.in\n+++ b/build/pkgs/matplotlib/spkg-install.in\n@@ -1,5 +1,5 @@\n # Write a configuration file to src/setup.cfg\n-sage-system-python make-setup-config.py\n+sage-python23 make-setup-config.py\n \n cd src\n \n```\n\nThen we would be using Sage's Python to build here. This should be okay, since Python is a dependency for matplotlib.",
    "created_at": "2020-05-27T20:37:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29310#issuecomment-415526",
    "user": "@jhpalmieri"
}
```

Should we make this change?

```diff
diff --git a/build/pkgs/matplotlib/spkg-install.in b/build/pkgs/matplotlib/spkg-install.in
index 6b68b46ad5..a427dadccd 100644
--- a/build/pkgs/matplotlib/spkg-install.in
+++ b/build/pkgs/matplotlib/spkg-install.in
@@ -1,5 +1,5 @@
 # Write a configuration file to src/setup.cfg
-sage-system-python make-setup-config.py
+sage-python23 make-setup-config.py
 
 cd src
 
```

Then we would be using Sage's Python to build here. This should be okay, since Python is a dependency for matplotlib.



---

archive/issue_comments_415527.json:
```json
{
    "body": "Some Sage packages use `sage-system-python`, some use `sage-python23`. Some of the ones using `sage-system-python` are build before Python, which makes sense, but for packages like matplotlib, I don't see any reason to not use `sage-python23`.",
    "created_at": "2020-05-27T20:40:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29310#issuecomment-415527",
    "user": "@jhpalmieri"
}
```

Some Sage packages use `sage-system-python`, some use `sage-python23`. Some of the ones using `sage-system-python` are build before Python, which makes sense, but for packages like matplotlib, I don't see any reason to not use `sage-python23`.



---

archive/issue_comments_415528.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2020-05-27T22:19:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29310#issuecomment-415528",
    "user": "@jhpalmieri"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_415529.json:
```json
{
    "body": "New commits:",
    "created_at": "2020-05-27T22:19:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29310#issuecomment-415529",
    "user": "@jhpalmieri"
}
```

New commits:



---

archive/issue_comments_415530.json:
```json
{
    "body": "There should be just one new commit, the last one in that list. We've already seen the rest.",
    "created_at": "2020-05-27T22:21:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29310#issuecomment-415530",
    "user": "@jhpalmieri"
}
```

There should be just one new commit, the last one in that list. We've already seen the rest.



---

archive/issue_comments_415531.json:
```json
{
    "body": "Using `sage-python23` (which could, actually, be replaced by `python3` -- but this simplification should be done uniformly on another ticket) is the correct solution here. (See discussion in https://groups.google.com/d/msg/sage-devel/fgsSsJmVVXo/Taix5GaQAAAJ)",
    "created_at": "2020-05-28T03:43:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29310#issuecomment-415531",
    "user": "@mkoeppe"
}
```

Using `sage-python23` (which could, actually, be replaced by `python3` -- but this simplification should be done uniformly on another ticket) is the correct solution here. (See discussion in https://groups.google.com/d/msg/sage-devel/fgsSsJmVVXo/Taix5GaQAAAJ)



---

archive/issue_comments_415532.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-05-28T03:43:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29310#issuecomment-415532",
    "user": "@mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_415533.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-05-29T21:16:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29310#issuecomment-415533",
    "user": "@vbraun"
}
```

Resolution: fixed
