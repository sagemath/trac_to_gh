# Issue 14893: Docbuilder issue with BasisExchangeMatroid

Issue created by migration from https://trac.sagemath.org/ticket/15130

Original creator: jdemeyer

Original creation time: 2013-08-30 14:19:08

In sage-5.12.beta4, the command

```
rm -rf devel/sage/doc/output/ && ./sage -ba-force && make doc
```

yields

```
Traceback (most recent call last):
  File "/mazur/release/merger/sage-5.12.beta4/devel/sage/doc/common/builder.py", line 1452, in <module>
    getattr(get_builder(name), type)()
  File "/mazur/release/merger/sage-5.12.beta4/devel/sage/doc/common/builder.py", line 269, in _wrapper
    getattr(get_builder(document), 'inventory')(*args, **kwds)
  File "/mazur/release/merger/sage-5.12.beta4/devel/sage/doc/common/builder.py", line 472, in _wrapper
    pool.map_async(build_ref_doc, L, 1).get(99999)
  File "/mazur/release/merger/sage-5.12.beta4/local/lib/python/multiprocessing/pool.py", line 554, in get
    raise self._value
AttributeError: 'module' object has no attribute 'BasisExchangeMatroid'
```



---

Comment by jdemeyer created at 2013-09-26 13:23:25

Changing priority from blocker to critical.


---

Comment by vbraun created at 2013-10-05 15:40:12

I've tripped over this multiple times, too. This is due to circular imports in the matroid code. For example:

```
┌────────────────────────────────────────────────────────────────────┐
│ Sage Version 5.12.rc1, Release Date: 2013-10-04                    │
│ Type "notebook()" for the browser-based notebook interface.        │
│ Type "help()" for help.                                            │
└────────────────────────────────────────────────────────────────────┘
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ Warning: this is a prerelease version, and it may be unstable.     ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
sage: from sage.matroids.basis_exchange_matroid import BasisExchangeMatroid
---------------------------------------------------------------------------
AttributeError                            Traceback (most recent call last)
<ipython-input-1-2e7708db611e> in <module>()
----> 1 from sage.matroids.basis_exchange_matroid import BasisExchangeMatroid

/home/vbraun/Code/sage.git/basis_exchange_matroid.pyx in init sage.matroids.basis_exchange_matroid (sage/matroids/basis_exchange_matroid.c:20420)()

/home/vbraun/Code/sage.git/basis_exchange_matroid.pxd in init sage.matroids.matroid (sage/matroids/matroid.c:33184)()

AttributeError: 'module' object has no attribute 'BasisExchangeMatroid'
```

Depending on initialization order, importing matroids can fail. So if you delete `doc/output` and then run `make doc`, it works. But if some docs have been cached then the import order changes and *BOOM*. This is really bad. Python lets you get away with circular imports to some extend, but not forever. 

The matroid guys should linearize their imports, thats the only long-term solution.


---

Comment by vbraun created at 2013-10-05 15:54:50

Btw, here is a quick tutorial to debug this. Use the `-v` switch to display imports as they happen:

```
sage -python -v
>>> from sage.all import *
>>> from sage.matroids.basis_exchange_matroid import BasisExchangeMatroid
dlopen("/home/vbraun/Code/sage.git/local/lib/python2.7/site-packages/sage/matroids/basis_exchange_matroid.so", 2);
dlopen("/home/vbraun/Code/sage.git/local/lib/python2.7/site-packages/sage/matroids/matroid.so", 2);
dlopen("/home/vbraun/Code/sage.git/local/lib/python2.7/site-packages/sage/matroids/set_system.so", 2);
import sage.matroids.set_system # dynamically loaded from /home/vbraun/Code/sage.git/local/lib/python2.7/site-packages/sage/matroids/set_system.so
Traceback (most recent call last):
  File "<stdin>", line 1, in <module>
  File "basis_exchange_matroid.pyx", line 1, in init sage.matroids.basis_exchange_matroid (sage/matroids/basis_exchange_matroid.c:20420)
  File "basis_exchange_matroid.pxd", line 8, in init sage.matroids.matroid (sage/matroids/matroid.c:33184)
AttributeError: 'module' object has no attribute 'BasisExchangeMatroid'
```

So matroid imports from basis_exchange_matroid and vice versa. Which is bad. Circular imports are no magic, they just require Python to work with half-initialized module dicts. So while basis_exchange_matroid is loading, the `BasisExchangeMatroid` is not in the module namespace.


---

Comment by vbraun created at 2013-10-05 15:55:36

Changing component from documentation to matroid theory.


---

Comment by Stefan created at 2013-10-05 16:09:53

Let me explain the reason for those circular imports.

We have an abstract class Matroid with default implementations for nearly every method. For some of those, we return a subclass such as MinorMatroid or DualMatroid; for others (like is_isomorphic()) we convert to a BasisMatroid and use its implementation.

The class BasisMatroid is a subclass of BasisExchangeMatroid, which subclasses Matroid.

If you know of a way to get this functionality without circular imports, I'm all ears!


---

Comment by vbraun created at 2013-10-05 16:23:01

Obviously, the file containing the base must never import the derived at module level. 

You can import the derived class at method scope. Those imports are resolved only when you call the method.


---

Attachment


---

Comment by Stefan created at 2013-10-07 17:40:59

I changed matroid.pyx so it only imports derived classes at method scope. I also moved one import statement from the utilities module.

One of the imports used to be a cimport, and had to be changed to a normal import. This was not in a performance-critical method, so there should be no impact on the runtime of any code.

apply trac_15130_localize_imports.patch​


---

Comment by Stefan created at 2013-10-07 17:41:50

Changing status from new to needs_review.


---

Comment by vbraun created at 2013-10-07 23:06:13

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2013-10-07 23:06:13

Changing priority from critical to blocker.


---

Comment by vbraun created at 2013-10-07 23:06:13

Fixes the issue for me...

Jeroen: Would be nice to get this into sage-5.12 since its rather annoying to have the docbuild crash all the time.


---

Comment by jdemeyer created at 2013-10-08 10:40:12

Replying to [comment:9 vbraun]:
> Jeroen: Would be nice to get this into sage-5.12 since its rather annoying to have the docbuild crash all the time.
On the other hand, this is more of a developer issue than an end-user issue, so I think it's not that urgent.


---

Comment by jdemeyer created at 2013-10-12 09:45:56

Resolution: fixed


---

Comment by jdemeyer created at 2013-10-25 08:58:09

Please see also #15324.
