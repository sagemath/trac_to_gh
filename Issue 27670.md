# Issue 27670: Building gcc 7.2.0 fails on old systems because of crti.o

Issue created by migration from https://trac.sagemath.org/ticket/27907

Original creator: mkoeppe

Original creation time: 2019-05-31 18:43:13

CC:  dimpase stumpc5 jdemeyer vbraun embray

On various Linux systems with old compilers, building gcc 7.2.0 fails because either crti.o is not found, or there is 32/64 bit ABI mismatch on the one that is found.

Reported for Red Hat 6.10 at https://groups.google.com/d/msg/sage-devel/ze5SzgXZAgk/tai9F4flBQAJ:

```
/lib/crti.o: could not read symbols: File in wrong format 
```


On a different system: CentOS Linux release 7.6.1810 (Core), there is only `/lib64/crti.o` and the gcc build does not find it and fails as well. 
Fix for this system: 

```
export LIBRARY_PATH="/lib64"
```

before building sage.


---

Comment by stumpc5 created at 2019-05-31 19:04:21

This is the same issue as I have -- I first also had the "not found" error, which turned into the one I reported after the sysadmin tried to provide that file (I don't know what he actually did).


---

Comment by mkoeppe created at 2019-05-31 20:44:14

Replying to [comment:1 stumpc5]:
> This is the same issue as I have -- I first also had the "not found" error, which turned into the one I reported after the sysadmin tried to provide that file (I don't know what he actually did).
Thanks for the clarification.


---

Comment by mkoeppe created at 2019-05-31 21:49:01

This appears to be a frequent problem. See for example https://stackoverflow.com/questions/91576/crti-o-file-missing and https://github.com/Homebrew/linuxbrew-core/issues/7172

On the CentOS system mentioned in the ticket's description, the system's gcc is actually configured correctly: `gcc -print-search-dirs` has a long list of paths that includes `/lib64` (= `/usr/lib64` on this system).

The folks at Linuxbrew do the following in https://github.com/Homebrew/linuxbrew-core/blob/master/Formula/gcc`@`7.rb:

```
        # Set the search path for glibc libraries and objects, using the system's glibc
        # Fix the error: ld: cannot find crti.o: No such file or directory
        ENV.prepend_path "LIBRARY_PATH", Pathname.new(Utils.popen_read(ENV.cc, "-print-file-name=crti.o")).parent
```

On the CentOS system I can confirm that `gcc -print-file-name=crti.o` gives the correct file name. 
So this may be a sound approach.


---

Comment by mkoeppe created at 2019-06-01 17:53:52

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2019-06-01 17:53:52

New commits:


---

Comment by mkoeppe created at 2019-06-02 00:08:38

Changing status from needs_review to needs_work.


---

Comment by git created at 2019-06-02 01:28:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-06-02 01:50:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2019-06-02 08:11:14

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2019-06-02 17:36:22

Changing status from needs_review to needs_work.


---

Comment by stumpc5 created at 2019-06-02 19:28:10

Thank your for working on this!
Unfortunately, your fix does not yet solve it for me:

```
[stumpcl2@dlp762 sage]$ CRTI=$(${CC:-gcc} -print-file-name=crti.o 2>/dev/null || true)
[stumpcl2@dlp762 sage]$ echo $CRTI
/usr/lib/gcc/x86_64-redhat-linux/4.4.7/../../../../lib64/crti.o
[stumpcl2@dlp762 sage]$ if [ -n "$CRTI" ]; then
>  CRTI_DIR=$(dirname -- "$CRTI")
>  if [ -n "$CRTI_DIR" -a "$CRTI_DIR" != "." ]; then
>  export LIBRARY_PATH="$LIBRARY_PATH:$CRTI_DIR"
>  fi
> fi
[stumpcl2@dlp762 sage]$ echo $CRTI_DIR
/usr/lib/gcc/x86_64-redhat-linux/4.4.7/../../../../lib64
[stumpcl2@dlp762 sage]$ echo $LIBRARY_PATH
/lib64:/usr/lib/gcc/x86_64-redhat-linux/4.4.7/../../../../lib64
```

while building from scratch yields the error

```
[gcc-7.2.0] /usr/lib/gcc/x86_64-redhat-linux/4.4.7/../../../../lib64/../lib/crti.o: could not read symbols: File in wrong format
```

So it leaves `lib64` again and goes back to `lib` to look for `crti.o`.


---

Comment by mkoeppe created at 2019-06-02 19:30:32

I'd suggest to first check with your sysadmin what it is that he did to try to fix the original problem and to undo that.


---

Comment by stumpc5 created at 2019-06-02 20:33:34

> I'd suggest to first check with your sysadmin what it is that he did to try to fix the original problem and to undo that.

Well, he installed `gcc-7.2.0` systemwide (and then also `gcc-7.3.0`). If I use either of these (making it available using `ini gcc`), I get the errors I originally reported on `sage-devel` (`gfan-0.6.2.p1`, `ppl-1.2.p1`). If I do not use that gcc, but the older `gcc-4.4.7`, the not-found-error turned into the given could-not-read-symbols-error.


---

Comment by mkoeppe created at 2019-06-02 22:49:58

OK, thanks for the clarification


---

Comment by mkoeppe created at 2019-06-02 23:35:32

Needs more work also for one of my systems, where it succeeds in building and installing gcc, but that gcc does not work without setting the LIBRARY_PATH variable during its runtime!


---

Comment by mkoeppe created at 2019-06-02 23:39:00

Replying to [comment:17 mkoeppe]:
> OK, thanks for the clarification
Could you try the following: 

```
file /usr/lib/gcc/x86_64-redhat-linux/4.4.7/../../../../lib64/crt*.o
```



---

Comment by mkoeppe created at 2019-06-02 23:59:02

Replying to [comment:18 mkoeppe]:
> Needs more work also for one of my systems, where it succeeds in building and installing gcc, but that gcc does not work without setting the LIBRARY_PATH variable during its runtime!

Possible solution, again from Linuxbrew:

```
      gcc = bin/"gcc-7"
      libgcc = Pathname.new(Utils.popen_read(gcc, "-print-libgcc-file-name")).parent
      raise "command failed: #{gcc} -print-libgcc-file-name" if $CHILD_STATUS.exitstatus.nonzero?

      glibc = Formula["glibc"]
      glibc_installed = glibc.any_version_installed?

      # Symlink crt1.o and friends where gcc can find it.
      if glibc_installed
        crtdir = glibc.opt_lib
      else
        crtdir = Pathname.new(Utils.popen_read("/usr/bin/cc", "-print-file-name=crti.o")).parent
      end
      ln_sf Dir[crtdir/"*crt?.o"], libgcc

```



---

Comment by git created at 2019-06-03 02:54:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by stumpc5 created at 2019-06-03 07:39:51

Based on this `73be6cf`, the error becomes

```
[gcc-7.2.0] /usr/lib/../lib/crti.o: could not read symbols: File in wrong format
```

with

```
[stumpcl2@dlp762 sage]$ file /usr/lib/../lib/crti.o
/usr/lib/../lib/crti.o: ELF 32-bit LSB relocatable, Intel 80386, version 1 (SYSV), not stripped
```



---

Comment by mkoeppe created at 2019-06-03 07:49:22

But what does `file /usr/lib64/crt*.o` give?


---

Comment by stumpc5 created at 2019-06-03 07:58:28


```
[stumpcl2@dlp762 sage]$ file /usr/lib64/crt*.o
/usr/lib64/crt1.o: ELF 64-bit LSB relocatable, x86-64, version 1 (SYSV), for GNU/Linux 2.6.18, not stripped
/usr/lib64/crti.o: ELF 64-bit LSB relocatable, x86-64, version 1 (SYSV), not stripped
/usr/lib64/crtn.o: ELF 64-bit LSB relocatable, x86-64, version 1 (SYSV), stripped
```



---

Comment by mkoeppe created at 2019-06-03 08:14:51

Could you attach the latest .log file?


---

Comment by mkoeppe created at 2019-06-03 08:17:04

The current version works on the CentOS Linux system where I first encountered this problem.


---

Comment by mkoeppe created at 2019-06-03 08:17:04

Changing status from needs_work to needs_review.


---

Comment by stumpc5 created at 2019-06-03 08:21:28

Replying to [comment:25 mkoeppe]:
> Could you attach the latest .log file?

posted on sage-devel


---

Comment by mkoeppe created at 2019-06-04 00:25:17

Looks like configure was not regenerated. When you get a chance, please run ./bootstrap (this needs autotools installed...)
If it still fails, please post both config.log and the gcc-7.2.0.log


---

Comment by stumpc5 created at 2019-06-04 14:33:34

This now also works for me compiling gcc-7.2.0, many thanks for fixing this! (Unfortunately, the next error occurred right after on Red Hat 6.10.


---

Comment by mkoeppe created at 2019-06-05 15:02:41

Let's please get this into the next beta so that this can be tested by people without having to regenerate the configure scripts.


---

Comment by stumpc5 created at 2019-06-05 15:54:43

Yes, I agree. But do you see a way to auto-generate

```
# Location of system crti.o, in case we build our own gcc
export SAGE_CRTI_DIR="/usr/lib/gcc/x86_64-redhat-linux/4.4.7/../../../../lib64"
```

which I tweaked by hand?


---

Comment by mkoeppe created at 2019-06-06 17:33:42

Replying to [comment:31 stumpc5]:
> Yes, I agree. But do you see a way to auto-generate
> {{{
> # Location of system crti.o, in case we build our own gcc
> export SAGE_CRTI_DIR="/usr/lib/gcc/x86_64-redhat-linux/4.4.7/../../../../lib64"
> }}}
> which I tweaked by hand?
The scripts already do all of that. Something is broken in your setup that stops your copy of sage from regenerating the autotools scripts correctly. For example, in the last set of logs you posted there is no trace of the crti test at configure time. After `make distclean` your copy of sage likely downloaded the configure scripts from the latest beta, instead of regenerating them.


---

Comment by mkoeppe created at 2019-06-06 17:38:39

Changing priority from major to critical.


---

Comment by dimpase created at 2019-06-06 17:40:44

could it be that the machine either has no autotools installed, or they are outdated/broken?


---

Comment by mkoeppe created at 2019-06-06 17:44:46

Replying to [comment:34 dimpase]:
> could it be that the machine either has no autotools installed, or they are outdated/broken?
Yes, that's my guess too.

In any case, I have tested this ticket on one of my machines that had the same problem.


---

Comment by embray created at 2019-06-07 18:31:27

Regarding the `spkg-postinst`, could you please add a complementary `spkg-postrm` which removes the symlink, if it exists?


---

Comment by git created at 2019-06-19 22:59:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2019-06-19 23:03:46

New commits:


---

Comment by mkoeppe created at 2019-06-19 23:03:46

Changing status from needs_review to needs_work.


---

Comment by git created at 2019-06-20 05:11:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-06-20 05:19:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-06-20 20:51:24

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-06-21 00:06:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-06-21 16:51:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-06-21 20:15:11

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2019-06-22 00:17:14

Replying to [comment:36 embray]:
> Regarding the `spkg-postinst`, could you please add a complementary `spkg-postrm` which removes the symlink, if it exists?

Took me a while to find my way through this little maze of scripts.
Seems to work now, the crt symlinks are now removed by the postrm script. Please take a look. 

I notice that after `make gcc-clean`, an empty chain of directories `gcc/x86_64-pc-linux-gnu/7.2.0/plugin/include/ada` remains under `$SAGE_LOCAL/lib`.
I think it's unrelated to this ticket.


---

Comment by mkoeppe created at 2019-06-22 00:17:14

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2019-06-28 17:24:04

Needs review.


---

Comment by embray created at 2019-07-01 12:27:45

I'm confused.  What you used to have as `spkg-postinst` you _renamed_ to `spkg-postrm`, which is not what I intended.

It also now reads:


```
-spkg-postinst
\ No newline at end of file
+# -*- mode: shell-script -*-
+
+# Force re-installation of gmp, mpir, mpfr and mpc with the GCC that we
+# just built. This is needed in particular because gmp/mpir was first
+# built without C++ support.
```


This script is run _after_ you _uninstall_ a package, so the comment about "the GCC that we just built" can't be accurate (it was accurate for when this was a `postinst` script.

I will have to take more time to actually understand what you're trying to do here.  As it is I believe we are spending too much technical debt on trying to maintain gcc builds for old platforms...


---

Comment by embray created at 2019-07-01 12:40:30

Also I wonder if we could base this on top of #21707?  (Not to add additional hurdles to this ticket, as I want to move forward on #21707 ASAP as the number of build-related variables in sage-env-config is starting to get out of hand :)


---

Comment by embray created at 2019-07-01 12:56:07

Went ahead and rebased on current develop so it could incorporate all the additional variables we've since added.

I didn't change the name of the script yet; I would still prefer to shorten it but if anyone disagrees we can leave it as-is.
----
New commits:


---

Comment by embray created at 2019-07-01 12:56:49

Ack! Wrong ticket, sorry.
----
Last 10 new commits:


---

Comment by vbraun created at 2019-07-01 18:19:13

On fedora 30 (gcc 9) I'm also getting

```
[gcc-7.2.0] /home/buildbot-sage/slave/binary_pkg/build/source/SageMath/jc4b6yulaujayb9sr94ia88eourzeqip0oidmas39/local/var/tmp/sage/build/gcc-7.2.0/gcc-build/./gcc/xgcc -B/home/buildbot-sage/slave/binary_pkg/build/source/SageMath/jc4b6yulaujayb9sr94ia88eourzeqip0oidmas39/local/var/tmp/sage/build/gcc-7.2.0/gcc-build/./gcc/ -B/home/buildbot-sage/slave/binary_pkg/build/source/SageMath/jc4b6yulaujayb9sr94ia88eourzeqip0oidmas39/local/x86_64-pc-linux-gnu/bin/ -B/home/buildbot-sage/slave/binary_pkg/build/source/SageMath/jc4b6yulaujayb9sr94ia88eourzeqip0oidmas39/local/x86_64-pc-linux-gnu/lib/ -isystem /home/buildbot-sage/slave/binary_pkg/build/source/SageMath/jc4b6yulaujayb9sr94ia88eourzeqip0oidmas39/local/x86_64-pc-linux-gnu/include -isystem /home/buildbot-sage/slave/binary_pkg/build/source/SageMath/jc4b6yulaujayb9sr94ia88eourzeqip0oidmas39/local/x86_64-pc-linux-gnu/sys-include    -O2  -g -O2 -DIN_GCC    -W -Wall -Wno-narrowing -Wwrite-strings -Wcast-qual -Wno-format -Wstrict-prototypes -Wmissing-prototypes -Wold-style-definition  -isystem ./include   -fpic -mlong-double-80 -DUSE_ELF_SYMVER -g -DIN_LIBGCC2 -fbuilding-libgcc -fno-stack-protector  -shared -nodefaultlibs -Wl,--soname=libgcc_s.so.1 -Wl,--version-script=libgcc.map -o ./libgcc_s.so.1.tmp -g -O2 -B./ _muldi3_s.o _negdi2_s.o _lshrdi3_s.o _ashldi3_s.o _ashrdi3_s.o _cmpdi2_s.o _ucmpdi2_s.o _clear_cache_s.o _trampoline_s.o __main_s.o _absvsi2_s.o _absvdi2_s.o _addvsi3_s.o _addvdi3_s.o _subvsi3_s.o _subvdi3_s.o _mulvsi3_s.o _mulvdi3_s.o _negvsi2_s.o _negvdi2_s.o _ctors_s.o _ffssi2_s.o _ffsdi2_s.o _clz_s.o _clzsi2_s.o _clzdi2_s.o _ctzsi2_s.o _ctzdi2_s.o _popcount_tab_s.o _popcountsi2_s.o _popcountdi2_s.o _paritysi2_s.o _paritydi2_s.o _powisf2_s.o _powidf2_s.o _powixf2_s.o _mulhc3_s.o _mulsc3_s.o _muldc3_s.o _mulxc3_s.o _divhc3_s.o _divsc3_s.o _divdc3_s.o _divxc3_s.o _bswapsi2_s.o _bswapdi2_s.o _clrsbsi2_s.o _clrsbdi2_s.o _fixunssfsi_s.o _fixunsdfsi_s.o _fixunsxfsi_s.o _fixsfdi_s.o _fixdfdi_s.o _fixxfdi_s.o _fixunssfdi_s.o _fixunsdfdi_s.o _fixunsxfdi_s.o _floatdisf_s.o _floatdidf_s.o _floatdixf_s.o _floatundisf_s.o _floatundidf_s.o _floatundixf_s.o _divdi3_s.o _moddi3_s.o _divmoddi4_s.o _udivdi3_s.o _umoddi3_s.o _udivmoddi4_s.o _udiv_w_sdiv_s.o cpuinfo_s.o sfp-exceptions_s.o addtf3_s.o divtf3_s.o multf3_s.o negtf2_s.o subtf3_s.o unordtf2_s.o fixtfsi_s.o fixunstfsi_s.o floatsitf_s.o floatunsitf_s.o fixtfdi_s.o fixunstfdi_s.o floatditf_s.o floatunditf_s.o fixtfti_s.o fixunstfti_s.o floattitf_s.o floatuntitf_s.o extendsftf2_s.o extenddftf2_s.o extendxftf2_s.o trunctfsf2_s.o trunctfdf2_s.o trunctfxf2_s.o getf2_s.o letf2_s.o eqtf2_s.o _divtc3_s.o _multc3_s.o _powitf2_s.o enable-execute-stack_s.o unwind-dw2_s.o unwind-dw2-fde-dip_s.o unwind-sjlj_s.o unwind-c_s.o emutls_s.o libgcc.a -lc && rm -f ./libgcc_s.so && if [ -f ./libgcc_s.so.1 ]; then mv -f ./libgcc_s.so.1 ./libgcc_s.so.1.backup; else true; fi && mv ./libgcc_s.so.1.tmp ./libgcc_s.so.1 && (echo "/* GNU ld script"; echo "   Use the shared library, but some functions are only in"; echo "   the static library.  */"; echo "GROUP ( libgcc_s.so.1 -lgcc )" ) > ./libgcc_s.so
[gcc-7.2.0] /usr/bin/ld: cannot find crti.o: No such file or directory
[gcc-7.2.0] collect2: error: ld returned 1 exit status
[gcc-7.2.0] make[9]: *** [Makefile:982: libgcc_s.so] Error 1
```

For the record, its `/lib64/crti.o`

```
[release@zen Sage]$ cc -print-file-name=crti.o
/usr/lib/gcc/x86_64-redhat-linux/9/../../../../lib64/crti.o
```



---

Comment by mkoeppe created at 2019-07-01 18:25:15

Replying to [comment:51 vbraun]:
> On fedora 30 (gcc 9) I'm also getting
> {{{
> [gcc-7.2.0] /home/buildbot-sage/slave/binary_pkg/build/source/SageMath/jc4b6yulaujayb9sr94ia88eourzeqip0oidmas39/local/var/tmp/sage/build/gcc-7.2.0/gcc-build/./gcc/xgcc -B/home/buildbot-sage/slave/binary_pkg/build/source/SageMath/jc4b6yulaujayb9sr94ia88eourzeqip0oidmas39/local/var/tmp/sage/build/gcc-7.2.0/gcc-build/./gcc/ -B/home/buildbot-sage/slave/binary_pkg/build/source/SageMath/jc4b6yulaujayb9sr94ia88eourzeqip0oidmas39/local/x86_64-pc-linux-gnu/bin/ -B/home/buildbot-sage/slave/binary_pkg/build/source/SageMath/jc4b6yulaujayb9sr94ia88eourzeqip0oidmas39/local/x86_64-pc-linux-gnu/lib/ -isystem /home/buildbot-sage/slave/binary_pkg/build/source/SageMath/jc4b6yulaujayb9sr94ia88eourzeqip0oidmas39/local/x86_64-pc-linux-gnu/include -isystem /home/buildbot-sage/slave/binary_pkg/build/source/SageMath/jc4b6yulaujayb9sr94ia88eourzeqip0oidmas39/local/x86_64-pc-linux-gnu/sys-include    -O2  -g -O2 -DIN_GCC    -W -Wall -Wno-narrowing -Wwrite-strings -Wcast-qual -Wno-format -Wstrict-prototypes -Wmissing-prototypes -Wold-style-definition  -isystem ./include   -fpic -mlong-double-80 -DUSE_ELF_SYMVER -g -DIN_LIBGCC2 -fbuilding-libgcc -fno-stack-protector  -shared -nodefaultlibs -Wl,--soname=libgcc_s.so.1 -Wl,--version-script=libgcc.map -o ./libgcc_s.so.1.tmp -g -O2 -B./ _muldi3_s.o _negdi2_s.o _lshrdi3_s.o _ashldi3_s.o _ashrdi3_s.o _cmpdi2_s.o _ucmpdi2_s.o _clear_cache_s.o _trampoline_s.o __main_s.o _absvsi2_s.o _absvdi2_s.o _addvsi3_s.o _addvdi3_s.o _subvsi3_s.o _subvdi3_s.o _mulvsi3_s.o _mulvdi3_s.o _negvsi2_s.o _negvdi2_s.o _ctors_s.o _ffssi2_s.o _ffsdi2_s.o _clz_s.o _clzsi2_s.o _clzdi2_s.o _ctzsi2_s.o _ctzdi2_s.o _popcount_tab_s.o _popcountsi2_s.o _popcountdi2_s.o _paritysi2_s.o _paritydi2_s.o _powisf2_s.o _powidf2_s.o _powixf2_s.o _mulhc3_s.o _mulsc3_s.o _muldc3_s.o _mulxc3_s.o _divhc3_s.o _divsc3_s.o _divdc3_s.o _divxc3_s.o _bswapsi2_s.o _bswapdi2_s.o _clrsbsi2_s.o _clrsbdi2_s.o _fixunssfsi_s.o _fixunsdfsi_s.o _fixunsxfsi_s.o _fixsfdi_s.o _fixdfdi_s.o _fixxfdi_s.o _fixunssfdi_s.o _fixunsdfdi_s.o _fixunsxfdi_s.o _floatdisf_s.o _floatdidf_s.o _floatdixf_s.o _floatundisf_s.o _floatundidf_s.o _floatundixf_s.o _divdi3_s.o _moddi3_s.o _divmoddi4_s.o _udivdi3_s.o _umoddi3_s.o _udivmoddi4_s.o _udiv_w_sdiv_s.o cpuinfo_s.o sfp-exceptions_s.o addtf3_s.o divtf3_s.o multf3_s.o negtf2_s.o subtf3_s.o unordtf2_s.o fixtfsi_s.o fixunstfsi_s.o floatsitf_s.o floatunsitf_s.o fixtfdi_s.o fixunstfdi_s.o floatditf_s.o floatunditf_s.o fixtfti_s.o fixunstfti_s.o floattitf_s.o floatuntitf_s.o extendsftf2_s.o extenddftf2_s.o extendxftf2_s.o trunctfsf2_s.o trunctfdf2_s.o trunctfxf2_s.o getf2_s.o letf2_s.o eqtf2_s.o _divtc3_s.o _multc3_s.o _powitf2_s.o enable-execute-stack_s.o unwind-dw2_s.o unwind-dw2-fde-dip_s.o unwind-sjlj_s.o unwind-c_s.o emutls_s.o libgcc.a -lc && rm -f ./libgcc_s.so && if [ -f ./libgcc_s.so.1 ]; then mv -f ./libgcc_s.so.1 ./libgcc_s.so.1.backup; else true; fi && mv ./libgcc_s.so.1.tmp ./libgcc_s.so.1 && (echo "/* GNU ld script"; echo "   Use the shared library, but some functions are only in"; echo "   the static library.  */"; echo "GROUP ( libgcc_s.so.1 -lgcc )" ) > ./libgcc_s.so
> [gcc-7.2.0] /usr/bin/ld: cannot find crti.o: No such file or directory
> [gcc-7.2.0] collect2: error: ld returned 1 exit status
> [gcc-7.2.0] make[9]: *** [Makefile:982: libgcc_s.so] Error 1
> }}}
> For the record, its `/lib64/crti.o`
> {{{
> [release`@`zen Sage]$ cc -print-file-name=crti.o
> /usr/lib/gcc/x86_64-redhat-linux/9/../../../../lib64/crti.o
> }}}
Has `CRTI_DIR` been set correctly in `src/bin/sage-env-config` on this system?


---

Comment by mkoeppe created at 2019-07-01 18:29:40

Replying to [comment:47 embray]:
> I'm confused.  What you used to have as `spkg-postinst` you _renamed_ to `spkg-postrm`, which is not what I intended.

Before this ticket, `spkg-postrm` was a symlink to `spkg-postinst`. 
In both `spkg-postrm` and `spkg-postinst`, the same actions (trigger uninstalls, reconfigure) are taken.

I added additional things to the front of `spkg-postinst`.

(The diff does not show this very well.)


---

Comment by git created at 2019-07-01 18:34:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2019-07-01 18:37:13

Replying to [comment:47 embray]:
> [...] `spkg-postrm`  [...] is run _after_ you _uninstall_ a package, so the comment about "the GCC that we just built" can't be accurate

I have updated the explanation in `spkg-postrm`.
(Actually, in the `spkg-postrm` situation, I don't know why `--keep-files` would be used; but it's beyond the scope of this ticket to change it.)


---

Comment by embray created at 2019-07-02 12:08:01

Got it--this is starting to make sense to me now.  The part where you actually _modify_ the the postrm script on the fly is interesting: That was not an explicitly supported use case, so it makes me a little nervous (since it means now we _do_ have to support that), but if it works it works.

If for some reason we need to change things such that it would not be easy to support this usage, I believe a different solution could be found.


---

Comment by embray created at 2019-07-03 11:37:56

Moving tickets from the Sage 8.8 milestone that have been actively worked on in the last six months to the next release milestone (optimistically).


---

Comment by vbraun created at 2019-07-05 12:11:20

I would just unconditionally delete `*crt?.o` in the postrm script, more predictable and fewer moving parts. But either way is imho an acceptable solution, unless Eric objects I'm going to go ahead with this ticket....


---

Comment by vbraun created at 2019-07-18 07:13:57

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2019-07-20 09:11:04

Resolution: fixed


---

Comment by mkoeppe created at 2019-08-02 17:37:47

`@`stumpc5 Merged in 8.9.beta4, please test
