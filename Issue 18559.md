# Issue 18559: Python 3 preparation: Cleaning up the bit rot that occurred  to a number of Python fixes

Issue created by migration from https://trac.sagemath.org/ticket/18796

Original creator: wluebbe

Original creation time: 2015-06-26 17:30:15

Keywords: python3

A number of the Python 3 tickets that are tracked in #15980 and that had been closed have to be addressed again: instances of the migration problems that they fixed have surfaced again.


---

Comment by wluebbe created at 2015-06-27 13:26:39

These first 5 commits follow up the tickets (again using `2to3`:
#15982 Change the syntax of the except clause   `2to3 -w -f except src/sage`
#16067 Semantic of filter() function changed   `2to3 -w -f filter src/sage`
#15983 Sames of some function attributes   `2to3 -w -f funcattrs src/sage`
#15784 Use `in` instead of `has_key()`   `2to3 -w -f has_key src/sage`
#15984 Use more modern Python idioms   `2to3 -w -f idioms src/sage`

I had to backout the proposed change for `src/sage/game_theory/normal_form_game.py` (see also the 4 reverted modules mentioned in #15984).
----
New commits:


---

Comment by git created at 2015-06-27 16:55:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by wluebbe created at 2015-06-27 17:09:58

The next 5 commits follow up these tickets
#15986 - Change names of some method attributes   `2to3 -w -f methodattrs src/sage`
#15743 - <> is not Python 3 compatible   `2to3 -w -f ne src/sage`
#15990 - Change syntax of raise statement  `2to3 -w -f raise src/sage`
#16078 - reduce() is no more a builtin function  `2to3 -w -f reduce src/sage`
#15993 - Remove implicit tuple parameter unpacking  `2to3 -w -f tuple_params src/sage`

Three proposed module changes by `raise` involve raise `with_traceback()`:
`src/sage/interfaces/expect.py`
`src/sage/interfaces/singular.py`
`src/sage/sage/schemes/elliptic_curves/ell_number_field.py`
This requires the use of a compatibility library and therefor belongs to stage 2 (see meta-ticket #16052). This 3 modules will be handled in a separate ticket #18799.


---

Comment by wluebbe created at 2015-06-27 17:09:58

Changing status from new to needs_review.


---

Comment by aapitzsch created at 2015-06-28 01:04:12

Please fix the formatting of

```
if    ( isinstance(self, type(other))\
            and self._ambient_space_functor == other._ambient_space_functor\
            and self._generators            == other._generators ):
```

and others in `src/sage/modular/modform_hecketriangle/functors.py`.
`\` is not necessary.


---

Comment by aapitzsch created at 2015-06-28 01:04:12

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2015-06-28 08:01:52

Why do you replace

```
type(self) == type(other)
```

by

```
isinstance(self, type(other))
```

That doesn't seem correct (the 2 are certainly not equivalent)


---

Comment by wluebbe created at 2015-06-28 09:18:08

Replying to [comment:5 aapitzsch]:
> Please fix the formatting of
...
> and others in `src/sage/modular/modform_hecketriangle/functors.py`.
> `\` is not necessary.
The change was generated by `2to3 -w -f idioms src/sage`. I did not change any formatting here as in some previous Python3 ticket I was asked by the reviewer to undo those improvements as they were not strictly required by the task at hand. I complied :-/

I agree that the mentioned code is not pretty and not quite PEP8 compliant.
But before fixing it I'd like to discuss comment:6.


---

Comment by wluebbe created at 2015-06-28 09:49:12

Replying to [comment:6 jdemeyer]:
> Why do you replace
> ...
All the changes were generated by `2to3 -w -f idioms src/sage`.

While `type(self) == type(other)` means strict type identity the expression `isinstance(self, type(other))` allows subclasses. The Python documentation (https://docs.python.org/2.7/library/functions.html?highlight=type#type) says: //The isinstance() built-in function is recommended for testing the type of an object.//

There was one generated change (see comment:1) that I reverted because of failing doctests. Failing of doctests was the only method I used to determine that the change was not correct. I have no deep understanding of the code.

Therefor one can reason that without more insight all changes from `type()` to `isinstance()` should be reverted.
Or to keep them until proved guilty.

Remark: In ticket #15984 we made a large number of such changes supported by the same reasoning. This was in Sage 6.2 15 month ago. So there is some evidence that the approach is reasonable.


---

Comment by jdemeyer created at 2015-06-28 10:01:30

Replying to [comment:8 wluebbe]:
> I have no deep understanding of the code.
You should really never make changes that you don't understand.

> Therefor one can reason that without more insight all changes from `type()` to `isinstance()` should be reverted.
Indeed.


---

Comment by git created at 2015-06-29 06:50:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by wluebbe created at 2015-06-29 06:59:39

This commit undoes the changes from `type()` to `isinstance()` in the 6 affected modules. 

I recommend not to employ `2to3 -w -f idioms src/sage` anymore since those changes not essential to Py3 compatibility and not always correct. But they improve the code if used with sufficient care.


---

Comment by wluebbe created at 2015-06-29 06:59:39

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2015-06-29 18:49:10

`(x_y[0],x_y[1])` is just `x_y`


---

Comment by jdemeyer created at 2015-06-29 18:49:10

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2015-06-29 18:49:34

Don't remove comments like `# make sure that the first two columns are "11, 12, ..., 1n, 21, 22, ..."`


---

Comment by jdemeyer created at 2015-06-29 18:56:17

If you're changing `func_code` to `__code__`, you also need to change

```
hasattr(obj, 'func_code')
```

to

```
hasattr(obj, '__code__')
```



---

Comment by git created at 2015-07-01 13:28:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by wluebbe created at 2015-07-01 13:32:49

Changing status from needs_work to needs_review.


---

Comment by wluebbe created at 2015-07-01 13:32:49

* Changed `(x_y[0],x_y[1])` in `bidb.py`
* Added removed comment in `latin_squares.py`
- Changed `func_code` in `sageinspect.py`
- Changed `has_key` in `integrable_representations.py`
- Changed type equality tests into type identity tests in `functors.py`, `graded_ring_element.py` and `display_manager.py`. This similar to #18809.
- Stripped lots of trailing whitespace in `display_manager.py`


---

Comment by jdemeyer created at 2015-07-14 12:50:26

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2015-07-15 08:59:03

Resolution: fixed
