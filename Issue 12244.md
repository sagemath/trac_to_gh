# Issue 12244: Mercurial assumes that any system with XCode *installed* will use XCode to *build* Mercurial

Issue created by migration from https://trac.sagemath.org/ticket/12416

Original creator: jdemeyer

Original creation time: 2012-02-02 20:44:39

Assignee: tbd

This is an except from upstream's `setup.py`:

```
if sys.platform == 'darwin' and os.path.exists('/usr/bin/xcodebuild'):
    # XCode 4.0 dropped support for ppc architecture, which is hardcoded in
    # distutils.sysconfig
    version = runcmd(['/usr/bin/xcodebuild', '-version'], {})[0].splitlines()[0]
    # Also parse only first digit, because 3.2.1 can't be parsed nicely
    if (version.startswith('Xcode') and
        StrictVersion(version.split()[1]) >= StrictVersion('4.0')):
        os.environ['ARCHFLAGS'] = '-arch i386 -arch x86_64'
```


The `ARCHFLAGS` are passed to `gcc` during the setup of Mercurial.  This obviously breaks on a system with XCode installed, but where the "gcc" found in the `PATH` isn't XCode's gcc.

In later upstream releases, the last line is changed to

```
os.environ['ARCHFLAGS'] = '-arch i386 -arch x86_64'
```


So I propose to backport this change.


---

Comment by jdemeyer created at 2012-02-02 20:59:54

Diff for the mercurial spkg, for review only


---

Comment by jdemeyer created at 2012-02-02 21:00:55

Changing status from new to needs_review.


---

Attachment


---

Comment by ohanar created at 2012-02-10 16:41:14

Changing status from needs_review to positive_review.


---

Comment by ohanar created at 2012-02-10 16:41:14

looks good, works good


---

Comment by jdemeyer created at 2012-02-14 14:22:56

Resolution: fixed
