# Issue 11298: Re-enable at symbol in notebook username

Issue created by migration from https://trac.sagemath.org/ticket/11470

Original creator: kcrisman

Original creation time: 2011-06-13 23:57:26

Assignee: jason, mpatel, was

CC:  jason

We had to disable the '`@`' symbol in the notebook because it breaks TinyMCE.

See #11343 and the links in [this thread](http://groups.google.com/group/sage-notebook/browse_thread/thread/f0ceaa24700f4059) on sage-notebook for further work.


---

Comment by rkirov created at 2011-06-19 00:06:27

no such problem in flask. see http://code.google.com/p/sagenb/issues/detail?id=26&can=1
you can test on sagenb.org


---

Comment by kcrisman created at 2011-06-23 03:25:46

Not true, at least not at demo2.sagenb.org or sagenb.org (I tried both)

```
http://demo2.sagenb.org/home/b%40b/0/
```

is the name but it still causes problems.   You can try this with password 'abc123'.  Note that the user name at the top (next to Toggle) is still `b`@`b`, this could be relevant?  

So *please* either fix it or merge #11343 into the flask "main" body.  Many, many beginning users like to use their email addresses for usernames.


---

Comment by rkirov created at 2011-06-23 04:23:38

mac os - chrome 12


---

Attachment

mac os - firefox 3.6


---

Attachment

hmmm, can't reproduce the bug in either chrome or firefox on mac os *screenshots attached*. Can we get more people to test it?


---

Comment by kini created at 2011-06-23 05:16:09

[works for me](http://img857.imageshack.us/img857/4143/201106222208581280x800s.png) (see bottom of the screenshot for system info)


---

Comment by kini created at 2011-06-23 05:20:12

[works for me on sagenb.org](http://img36.imageshack.us/img36/7434/201106222218521276x782s.png), in fact.


---

Comment by kini created at 2011-06-23 06:11:22

Works [in Chromium](http://img28.imageshack.us/img28/2613/201106222231551276x782s.png) too, btw.


---

Comment by kcrisman created at 2011-06-23 12:58:24

Very interesting.  I use Safari.  Hang on a second...


---

Attachment

Mac OS 10.6 with Safari 5, reopening existing text cell


---

Attachment

Mac OS 10.6 with Safari 5, opening new text cell


---

Comment by kcrisman created at 2011-06-23 13:02:19

I can confirm that FF works fine.  Safari is in bad shape.

So what should we do regarding #11343?  I'm a little torn, as this is browser-specific, but a lot of current Sage folks use Safari since they are on Mac OS X.


---

Attachment

mac os - safari - problem with error stack


---

Comment by rkirov created at 2011-06-24 01:26:04

aha, I can reproduce this on Safari 5. You can see in the error trace below that TinyMCE is making the wrong url requests with break everything /home/b`@`/... . I will try to fix it, if not will incorporate kcrisman's patch before the spkg, gets made.

Of course, help is welcome.


---

Comment by kini created at 2011-06-24 02:38:36

It's actually `/home/b`@`demo2.sagenb.org/...` (where it should be `/home/b%40b/...`), which seems to tie this to [this](http://stackoverflow.com/questions/3726573/tinymce-bug-symbol-in-link-url-makes-http-mce-host-appear) (which I think kcrisman found earlier)...


---

Comment by kini created at 2011-06-24 02:44:36

Oops, link in the OP of that is broken - the original bug report is [here](http://tinymce.moxiecode.com/develop/bugtracker_view.php?id=3064).


---

Comment by kini created at 2011-12-26 00:02:00

So is this bug invalid, or what? #11343 has positive review. Should I merge it into the flask notebook?


---

Comment by kcrisman created at 2011-12-26 15:51:06

Replying to [comment:12 kini]:
> So is this bug invalid, or what? #11343 has positive review. Should I merge it into the flask notebook?
See [the Google code bug I opened recently](http://code.google.com/p/sagenb/issues/detail?id=88).  It is not in the flask notebook yet.  My feeling is that something like it should be, though.


---

Comment by jason created at 2011-12-26 18:12:38

As far as I remember, I never merged anything into the flask notebook that disabled the `@` sign in usernames because it wasn't a problem there.  However, I just checked with Safari, and indeed, it appears that the URLs still contain an `@` sign and on Safari, with the current sagenb, the tinymce doesn't work.

I'd rather just fix the URL encoding problem with the `@` sign in the flask notebook, rather than merging this.


---

Comment by kcrisman created at 2011-12-27 05:05:41

Replying to [comment:14 jason]:
> As far as I remember, I never merged anything into the flask notebook that disabled the `@` sign in usernames because it wasn't a problem there.  However, I just checked with Safari, and indeed, it appears that the URLs still contain an `@` sign and on Safari, with the current sagenb, the tinymce doesn't work.
> 
> I'd rather just fix the URL encoding problem with the `@` sign in the flask notebook, rather than merging this.

Well, this ticket is for re-enabling :) But you mean merging #11343.  

Naturally, if you can just fix it, that would be even better.   Is that possible?  (I mean without fixing Safari or TinyMCE?  I assume that sagenb itself is not the problem.)


---

Comment by dimpase created at 2011-12-27 05:19:22

Replying to [comment:14 jason]:
> As far as I remember, I never merged anything into the flask notebook that disabled the `@` sign in usernames because it wasn't a problem there.  However, I just checked with Safari, and indeed, it appears that the URLs still contain an `@` sign and on Safari, with the current sagenb, the tinymce doesn't work.
> 
> I'd rather just fix the URL encoding problem with the `@` sign in the flask notebook, rather than merging this.

I would rather ignore these little browser specific quirks for the time being, as they come and go as browsers get updated.


---

Comment by jason created at 2011-12-27 15:23:32

Is it browser-specific?  I was under the impression it wasn't.


---

Comment by jason created at 2011-12-27 15:24:25

Ah, I see above that FF works.

Well, I don't know if this is a browser-specific  bug, or if there is a real bug that FF is being lenient on.  If the latter, we should still fix our codebase, for sure.


---

Comment by dimpase created at 2011-12-27 15:49:19

Changing priority from major to minor.


---

Comment by dimpase created at 2011-12-27 15:49:19

Replying to [comment:18 jason]:
> Ah, I see above that FF works.
> 
> Well, I don't know if this is a browser-specific  bug, or if there is a real bug that FF is being lenient on.  If the latter, we should still fix our codebase, for sure.

#11343 (the 3-months old part of the discussion there) is quite informative about the browser-specific reasons for this.
As you see, #11343 disables new registrations using `@`, while still allowing the existing ones to work.
So you merged #11343 into the flask version, right? Then I would like to put this ticket on the wish-list, and be done with it for the time being.


---

Comment by kini created at 2011-12-27 17:29:43

Well, Rado reverted #11343 in the flask notebook, thinking it only applied to the old notebook (due to him testing on firefox), thus the creation of this ticket to track that fact. After we determined it is broken on Safari, nobody un-reverted #11343 in the flask notebook. Hence my bump.


---

Comment by jason created at 2011-12-27 18:17:14

Isn't the solution just a matter of URL-encoding the username when making worksheet URLs?


---

Comment by jason created at 2011-12-27 23:28:09

Changing status from new to needs_review.


---

Comment by jason created at 2011-12-27 23:28:09

I think I fixed the underlying issue in this pull request: https://github.com/sagemath/sagenb/pull/11


---

Comment by jason created at 2011-12-28 01:41:21

By the way, I verified that this problem happens in Chrome and Firefox on OSX.


---

Comment by kini created at 2011-12-28 09:38:56

Awesome! Strange that it turned out to be OS X and not Safari specifically. I wonder what could be happening at the OS level to cause it to work fine on Linux. Just to be sure, maybe we should wait for kcrisman to verify that this fixes the problem, since before jason's confirmation he was the only person to see this bug (afaik).


---

Comment by dimpase created at 2011-12-28 09:51:46

Replying to [comment:24 kini]:
> Awesome! Strange that it turned out to be OS X and not Safari specifically. I wonder what could be happening at the OS level to cause it to work fine on Linux. Just to be sure, maybe we should wait for kcrisman to verify that this fixes the problem, since before jason's confirmation he was the only person to see this bug (afaik).

well, I can try to see whether I can see the bug on 4.8. I didn't manage to reproduce it on when working on #11343.


---

Comment by jason created at 2011-12-28 14:52:59

I wonder if the unpredictability has to do with caching, rather than the OS or browser.  The bit of code is run when the tinymce file is initialized in order to determine where to fetch the tinymce files from.  If that initialization is already set somewhere, it may not cause a problem.  It may also be a difference between browsers/OS, as it asks the window for the current URL, and maybe there are differences there.


---

Comment by jason created at 2011-12-28 14:53:36

In fact, I remember not seeing the problem once on Chrome, but then later seeing it.  That points to caching.


---

Comment by kcrisman created at 2011-12-28 15:32:34

Replying to [comment:25 dimpase]:
> Replying to [comment:24 kini]:
> > Awesome! Strange that it turned out to be OS X and not Safari specifically. I wonder what could be happening at the OS level to cause it to work fine on Linux. Just to be sure, maybe we should wait for kcrisman to verify that this fixes the problem, since before jason's confirmation he was the only person to see this bug (afaik).
> 
> well, I can try to see whether I can see the bug on 4.8. I didn't manage to reproduce it on when working on #11343.

It looks like there isn't really a "patch" to apply there, and in any case I can't test it locally because my Sage installs are all ones which already disallow '`@`' from #11343!  And I'm definitely not going to try to sort out installing the flask sagenb at this point.  Sorry.  

But if this is updated on sagenb or someplace like that I'd be happy to test a before and after for you.  

Also, I can definitely confirm that it wasn't just me that saw it.   A number of students this semester saw it, because they had created usernames on our server before we upgraded, and tried to use them when I was teaching them how to use LaTeX in various places, including Sage.  I feel like there was at least one sage-support request, but I know I wouldn't find it right now.

Thanks very much for tracking this down, Jason!


---

Comment by jason created at 2011-12-28 16:11:14

The diff is here: https://github.com/jasongrout/sagenb/commit/5b1b4c50437db1aa3d912040d29dd33c5e24d80d.diff


---

Comment by kcrisman created at 2011-12-28 17:38:00

Yes, I was able to view the second part of the diff before, though the first part won't view on github and seems far too long on your link as well.  My point is that it's not a patch I can import, particularly not to the old sagenb.

Anyway, the bigger point is that I have no way of testing it locally.


---

Comment by dimpase created at 2011-12-29 00:22:00

Replying to [comment:30 kcrisman]:
> Yes, I was able to view the second part of the diff before, though the first part won't view on github and seems far too long on your link as well.  My point is that it's not a patch I can import, particularly not to the old sagenb.
> 
> Anyway, the bigger point is that I have no way of testing it locally.

Hi Karl-Dieter,

The 1st part of the diff is irrelevant, because it is the diff of the file obtained from the 2nd file, by some kind of preprocessing, called minification,  improving the performance (something akin to .pyc vs .py files in Python). 

Jason, by the way, what is the reason to distribute the 1st file, shouldn't it be created at installation time?

For the purposes of testing, the 1st file can be replaced with the 2nd at no loss.

You can take the diff, and apply it using good old patch tool, too.

You can test with the old sagenb,  by installing the new sagenb and applying the patch via git, then replacing the tiny_mce you have in the old sagenb with this new one, that is, the whole devel/sagenb/sagenb/data/tiny_mce/

Or, even easier, unpack the new sagenb spkg, and apply the patch manually, then  replace the tiny_mce you have in the old sagenb with this new one, that is, the whole devel/sagenb/sagenb/data/tiny_mce/


---

Comment by jason created at 2011-12-29 01:54:12

To review it, it's better just to download the two files and replace your versions with them.  To do that, go to the pull request, click on  "Diff", and then for each file, click on "view file".  Then click the "raw" versions of the files at that commit.  Here are links to the files:

https://raw.github.com/jasongrout/sagenb/5b1b4c50437db1aa3d912040d29dd33c5e24d80d/sagenb/data/tiny_mce/tiny_mce.js

https://raw.github.com/jasongrout/sagenb/5b1b4c50437db1aa3d912040d29dd33c5e24d80d/sagenb/data/tiny_mce/tiny_mce_src.js

To answer dimpase: The entire tinymce directory is just an uncompressed tinymce release tarball.  I'd rather not duplicate their release process and minifying, but rather would like to just use their straight release.


---

Comment by dimpase created at 2011-12-29 02:40:36

Replying to [comment:32 jason]:

> To answer dimpase: The entire tinymce directory is just an uncompressed tinymce release tarball.  I'd rather not duplicate their release process and minifying, but rather would like to just use their straight release.

Hi Jason,
I wonder how do you do the minifying. Thanks,
Dima


---

Comment by jason created at 2011-12-29 02:43:14

I don't do any minifying.  I just extract the tinymce tarball I downloaded from the website.  The minified version is already included in the standard tinymce release tarball.


---

Comment by dimpase created at 2011-12-29 03:31:26

Replying to [comment:34 jason]:
> I don't do any minifying.  I just extract the tinymce tarball I downloaded from the website.  The minified version is already included in the standard tinymce release tarball.

Well, but where does the diff for the minified file come from?


---

Comment by jason created at 2011-12-29 03:33:40

I hand-modified both files, the minified version since it's the version we actually send to the browser, and the _src file so that it would be easier to see what the changes were.


---

Comment by dimpase created at 2011-12-29 03:41:37

Replying to [comment:36 jason]:
> I hand-modified both files, the minified version since it's the version we actually send to the browser, and the _src file so that it would be easier to see what the changes were.

Wow, it comes close to fixing a bug in a, say, C program by editing the .o file. :–)
I certainly would have looked for a tool to do it...

Shouldn't we minify the rest of the js code in sagenb, for the same reason, minimizing load times?


---

Comment by kini created at 2011-12-31 18:50:23

kcrisman, jason has applied the fix to `test.sagenb.org`. Can you give it a try?


---

Comment by jason created at 2011-12-31 18:59:45

I also had to restart sagenb.org, so the fix should be there too.  Can you try it either on test.sagenb.org or just plain sagenb.org?


---

Comment by jason created at 2011-12-31 19:00:26

(remember to control-refresh or option-refresh or whatever so that your javascript cache gets overwritten)


---

Comment by kcrisman created at 2012-01-02 16:11:52

Changing status from needs_review to positive_review.


---

Comment by kcrisman created at 2012-01-02 16:11:52

Okay, I didn't even have to do anything with the cache - I had never seen that option before.

Anyway, works on both the test accounts here and at #11343.  It does behave slightly different in terms of the default fonts and sizes, I think, but that is not very important.  At least it works now!  Thanks much.


---

Comment by jdemeyer created at 2012-01-04 19:15:35

Changing status from positive_review to needs_info.


---

Comment by jdemeyer created at 2012-01-04 19:15:35

What should I (as release manager) do with this?  Is there anything to be merged or is it all in the flask-sagenb?


---

Comment by jason created at 2012-01-04 22:20:00

There is nothing to merge.  We've already merged the fix to the underlying problem in flask-sagenb.  I guess this isn't technically in Sage yet, so maybe this ticket should be closed when the flask notebook is merged.  That is similar to how reported bugs in other upstream projects are handled, I think.  When the new version of the upstream version is merged, the appropriate bugs are closed.


---

Comment by jdemeyer created at 2012-01-05 08:57:42

Resolution: duplicate
