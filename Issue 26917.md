# Issue 26917: speed_up_Burge

archive/issues_026917.json:
```json
{
    "body": "\n\nIssue created by migration from https://trac.sagemath.org/ticket/27154\n\n",
    "created_at": "2019-01-27T22:15:11Z",
    "labels": [
        "PLEASE CHANGE",
        "major"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.0",
    "title": "speed_up_Burge",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/26917",
    "user": "@mantepse"
}
```


Issue created by migration from https://trac.sagemath.org/ticket/27154





---

archive/issue_comments_378740.json:
```json
{
    "body": "Changing type from PLEASE CHANGE to enhancement.",
    "created_at": "2019-01-27T22:36:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26917",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26917#issuecomment-378740",
    "user": "@mantepse"
}
```

Changing type from PLEASE CHANGE to enhancement.



---

archive/issue_comments_378741.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-01-27T22:36:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26917",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26917#issuecomment-378741",
    "user": "@mantepse"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_378742.json:
```json
{
    "body": "Changing component from PLEASE CHANGE to combinatorics.",
    "created_at": "2019-01-27T22:36:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26917",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26917#issuecomment-378742",
    "user": "@mantepse"
}
```

Changing component from PLEASE CHANGE to combinatorics.



---

archive/issue_comments_378743.json:
```json
{
    "body": "New commits:",
    "created_at": "2019-01-27T22:36:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26917",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26917#issuecomment-378743",
    "user": "@mantepse"
}
```

New commits:



---

archive/issue_comments_378744.json:
```json
{
    "body": "What sort of timings do you get?\n\nI am not sure about the `_make_partitions` function. You do incur an extra (python) function call, which might be slower than going via `_Partitions()` (once that is more optimized). So I might just inline it. Yet, I am not sure about that as it does bring down the readability and I am not sure how much of an optimization those changes end up being. So I need a bit more information on the effects of that change before proceeding. If we do keep it as-is, it will need a doctest.",
    "created_at": "2019-02-05T16:53:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26917",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26917#issuecomment-378744",
    "user": "@tscrim"
}
```

What sort of timings do you get?

I am not sure about the `_make_partitions` function. You do incur an extra (python) function call, which might be slower than going via `_Partitions()` (once that is more optimized). So I might just inline it. Yet, I am not sure about that as it does bring down the readability and I am not sure how much of an optimization those changes end up being. So I need a bit more information on the effects of that change before proceeding. If we do keep it as-is, it will need a doctest.



---

archive/issue_comments_378745.json:
```json
{
    "body": "Thank you for enduring all my performance troubles!\n\nAfter the patch, most of the time is spent in creating the partition - this is without #27146, which I created for the problem here.  Old code:\n\n```\nsage: r = 10; l = [random_matrix(ZZ, r, r, x=0, y=10) for _ in range(20)]\nsage: save(l, \"test_burge.sobj\")\nsage: %timeit all(Burge(labels=Burge(m).out_labels()) == Burge(m) for m in l)\n1 loop, best of 3: 6.04 s per loop\n```\n\nNew code:\n\n```\nsage: l = load(\"test_burge.sobj\")\nsage: %timeit all(Burge(labels=Burge(m).out_labels()) == Burge(m) for m in l)\n1 loop, best of 3: 3.11 s per loop\n```\n\nProfile of new code:\n\n```\nsage: %prun all(Burge(labels=Burge(m).out_labels()) == Burge(m) for m in l)\n         2266956 function calls (2230814 primitive calls) in 4.789 seconds\n\n   Ordered by: internal time\n\n   ncalls  tottime  percall  cumtime  percall filename:lineno(function)\n   519168    1.284    0.000    2.092    0.000 partition.py:550(<genexpr>)\n     4000    0.879    0.000    3.382    0.001 growth.py:3883(forward_rule)\n   519568    0.820    0.000    0.820    0.000 non_negative_integers.py:94(__contains__)\n     2000    0.418    0.000    1.250    0.001 growth.py:3930(backward_rule)\n   685752    0.372    0.000    0.372    0.000 {min}\n   6083/1    0.225    0.000    4.789    4.789 {all}\n   344490    0.160    0.000    0.160    0.000 {max}\n     6480    0.153    0.000    2.589    0.000 partition.py:524(__init__)\n...\n```\n\nLine profile:\n\n```\nsage: %lprun -f sage.combinat.growth.RuleBurge.forward_rule -f sage.combinat.growth.RuleBurge.backward_rule all(Burge(labels=Burge(m).out_labels()) ==\n....:  Burge(m) for m in l)\nTimer unit: 1e-06 s\n\nTotal time: 7.25262 s\nFile: /home/martin/sage-develop/local/lib/python2.7/site-packages/sage/combinat/growth.py\nFunction: forward_rule at line 3883\n\nLine #      Hits         Time  Per Hit   % Time  Line Contents\n==============================================================\n  3883                                               def forward_rule(self, y, t, x, content):\n  3884                                                   r\"\"\"\n  3885                                                   Return the output shape given three shapes and the content.\n  3886                                           \n  3887                                                   See [Kra2006]_ `(F^4 0)-(F^4 2)`.\n  3888                                           \n  3889                                                   INPUT:\n  3890                                           \n  3891                                                   - ``y, t, x`` -- three  from a cell in a growth diagram,\n  3892                                                     labelled as::\n  3893                                           \n  3894                                                         t x\n  3895                                                         y\n  3896                                           \n  3897                                                   - ``content`` -- a non-negative integer; the content of the cell\n  3898                                           \n  3899                                                   OUTPUT:\n  3900                                           \n  3901                                                   The fourth partition according to the Burge correspondence.\n  3902                                           \n  3903                                                   EXAMPLES::\n  3904                                           \n  3905                                                       sage: Burge = GrowthDiagram.rules.Burge()\n  3906                                                       sage: Burge.forward_rule([2,1],[2,1],[2,1],1)\n  3907                                                       [3, 1]\n  3908                                           \n  3909                                                       sage: Burge.forward_rule([1],[],[2],2)\n  3910                                                       [2, 1, 1, 1]\n  3911                                                   \"\"\"\n  3912                                                   # n is the maximal length of longest decreasing chain by\n  3913                                                   # Kleitman-Greene's theorem\n  3914      4000      43133.0     10.8      0.6          n = content + len(x) + len(y)\n  3915      4000      57192.0     14.3      0.8          x += [0]*(n-len(x))\n  3916      4000      55115.0     13.8      0.8          y += [0]*(n-len(y))\n  3917      4000      54349.0     13.6      0.7          t += [0]*(n-len(t))\n  3918      4000      15419.0      3.9      0.2          z = [0]*n\n  3919      4000       7256.0      1.8      0.1          carry = content\n  3920    231508     545791.0      2.4      7.5          for i, (row1, row2, row3) in enumerate(zip(x, t, y)):\n  3921    230736     960780.0      4.2     13.2              s = min(int(row1 == row2 == row3), carry)\n  3922    230736     641938.0      2.8      8.9              new_part = max(row1, row3) + s\n  3923    230736     401136.0      1.7      5.5              if new_part:\n  3924    227508     436347.0      1.9      6.0                  z[i] = new_part\n  3925    227508     675160.0      3.0      9.3                  carry += -s + min(row1, row3) - row2\n  3926                                                       else:\n  3927      3228      24721.0      7.7      0.3                  break\n  3928      4000    3334283.0    833.6     46.0          return _make_partition(z)\n\nTotal time: 2.52685 s\nFile: /home/martin/sage-develop/local/lib/python2.7/site-packages/sage/combinat/growth.py\nFunction: backward_rule at line 3930\n\nLine #      Hits         Time  Per Hit   % Time  Line Contents\n==============================================================\n  3930                                               def backward_rule(self, y, z, x):\n  3931                                                   r\"\"\"\n  3932                                                   Return the content and the input shape.\n  3933                                           \n  3934                                                   See [Kra2006]_ `(B^4 0)-(B^4 2)`.  (In the arXiv version of\n  3935                                                   the article there is a typo: in the computation of carry in\n  3936                                                   `(B^4 2)` , `\\rho` must be replaced by `\\lambda`).\n  3937                                           \n  3938                                                   INPUT:\n  3939                                           \n  3940                                                   - ``y, z, x`` -- three partitions from a cell in a\n  3941                                                     growth diagram, labelled as::\n  3942                                           \n  3943                                                         x\n  3944                                                       y z\n  3945                                           \n  3946                                                   OUTPUT:\n  3947                                           \n  3948                                                   A pair ``(t, content)`` consisting of the shape of the fourth\n  3949                                                   partition according to the Burge correspondence and the content of\n  3950                                                   the cell.\n  3951                                           \n  3952                                                   EXAMPLES::\n  3953                                           \n  3954                                                       sage: Burge = GrowthDiagram.rules.Burge()\n  3955                                                       sage: Burge.backward_rule([1,1,1],[2,1,1,1],[2,1,1])\n  3956                                                       ([1, 1], 0)\n  3957                                           \n  3958                                                   TESTS::\n  3959                                           \n  3960                                                       sage: w = [4,1,8,3,6,5,2,7,9]; G = Burge(w)\n  3961                                                       sage: GrowthDiagram(Burge, labels=G._out_labels).to_word() == w  # indirect doctest\n  3962                                                       True\n  3963                                                   \"\"\"\n  3964      2000      18758.0      9.4      0.7          t = [0]*len(z) # z must be the longest partition\n  3965      2000      36897.0     18.4      1.5          mu = [0]*(len(z)-len(x)) + x[::-1]\n  3966      2000      35824.0     17.9      1.4          nu = [0]*(len(z)-len(y)) + y[::-1]\n  3967      2000      15525.0      7.8      0.6          la = z[::-1]\n  3968      2000       4381.0      2.2      0.2          carry = 0\n  3969    115754     277390.0      2.4     11.0          for i, (mu_i, la_i, nu_i) in enumerate(zip(mu, la, nu)):\n  3970    113754     474543.0      4.2     18.8              s = min(int(mu_i == nu_i == la_i), carry)\n  3971    113754     367423.0      3.2     14.5              t[i] = min(mu_i, nu_i) - s\n  3972    113754     353673.0      3.1     14.0              carry += -s + la_i - max(mu_i, nu_i)\n  3973      2000       5772.0      2.9      0.2          t.reverse()\n  3974      2000     936664.0    468.3     37.1          return (_make_partition(t), carry)\n```\n",
    "created_at": "2019-02-05T17:34:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26917",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26917#issuecomment-378745",
    "user": "@mantepse"
}
```

Thank you for enduring all my performance troubles!

After the patch, most of the time is spent in creating the partition - this is without #27146, which I created for the problem here.  Old code:

```
sage: r = 10; l = [random_matrix(ZZ, r, r, x=0, y=10) for _ in range(20)]
sage: save(l, "test_burge.sobj")
sage: %timeit all(Burge(labels=Burge(m).out_labels()) == Burge(m) for m in l)
1 loop, best of 3: 6.04 s per loop
```

New code:

```
sage: l = load("test_burge.sobj")
sage: %timeit all(Burge(labels=Burge(m).out_labels()) == Burge(m) for m in l)
1 loop, best of 3: 3.11 s per loop
```

Profile of new code:

```
sage: %prun all(Burge(labels=Burge(m).out_labels()) == Burge(m) for m in l)
         2266956 function calls (2230814 primitive calls) in 4.789 seconds

   Ordered by: internal time

   ncalls  tottime  percall  cumtime  percall filename:lineno(function)
   519168    1.284    0.000    2.092    0.000 partition.py:550(<genexpr>)
     4000    0.879    0.000    3.382    0.001 growth.py:3883(forward_rule)
   519568    0.820    0.000    0.820    0.000 non_negative_integers.py:94(__contains__)
     2000    0.418    0.000    1.250    0.001 growth.py:3930(backward_rule)
   685752    0.372    0.000    0.372    0.000 {min}
   6083/1    0.225    0.000    4.789    4.789 {all}
   344490    0.160    0.000    0.160    0.000 {max}
     6480    0.153    0.000    2.589    0.000 partition.py:524(__init__)
...
```

Line profile:

```
sage: %lprun -f sage.combinat.growth.RuleBurge.forward_rule -f sage.combinat.growth.RuleBurge.backward_rule all(Burge(labels=Burge(m).out_labels()) ==
....:  Burge(m) for m in l)
Timer unit: 1e-06 s

Total time: 7.25262 s
File: /home/martin/sage-develop/local/lib/python2.7/site-packages/sage/combinat/growth.py
Function: forward_rule at line 3883

Line #      Hits         Time  Per Hit   % Time  Line Contents
==============================================================
  3883                                               def forward_rule(self, y, t, x, content):
  3884                                                   r"""
  3885                                                   Return the output shape given three shapes and the content.
  3886                                           
  3887                                                   See [Kra2006]_ `(F^4 0)-(F^4 2)`.
  3888                                           
  3889                                                   INPUT:
  3890                                           
  3891                                                   - ``y, t, x`` -- three  from a cell in a growth diagram,
  3892                                                     labelled as::
  3893                                           
  3894                                                         t x
  3895                                                         y
  3896                                           
  3897                                                   - ``content`` -- a non-negative integer; the content of the cell
  3898                                           
  3899                                                   OUTPUT:
  3900                                           
  3901                                                   The fourth partition according to the Burge correspondence.
  3902                                           
  3903                                                   EXAMPLES::
  3904                                           
  3905                                                       sage: Burge = GrowthDiagram.rules.Burge()
  3906                                                       sage: Burge.forward_rule([2,1],[2,1],[2,1],1)
  3907                                                       [3, 1]
  3908                                           
  3909                                                       sage: Burge.forward_rule([1],[],[2],2)
  3910                                                       [2, 1, 1, 1]
  3911                                                   """
  3912                                                   # n is the maximal length of longest decreasing chain by
  3913                                                   # Kleitman-Greene's theorem
  3914      4000      43133.0     10.8      0.6          n = content + len(x) + len(y)
  3915      4000      57192.0     14.3      0.8          x += [0]*(n-len(x))
  3916      4000      55115.0     13.8      0.8          y += [0]*(n-len(y))
  3917      4000      54349.0     13.6      0.7          t += [0]*(n-len(t))
  3918      4000      15419.0      3.9      0.2          z = [0]*n
  3919      4000       7256.0      1.8      0.1          carry = content
  3920    231508     545791.0      2.4      7.5          for i, (row1, row2, row3) in enumerate(zip(x, t, y)):
  3921    230736     960780.0      4.2     13.2              s = min(int(row1 == row2 == row3), carry)
  3922    230736     641938.0      2.8      8.9              new_part = max(row1, row3) + s
  3923    230736     401136.0      1.7      5.5              if new_part:
  3924    227508     436347.0      1.9      6.0                  z[i] = new_part
  3925    227508     675160.0      3.0      9.3                  carry += -s + min(row1, row3) - row2
  3926                                                       else:
  3927      3228      24721.0      7.7      0.3                  break
  3928      4000    3334283.0    833.6     46.0          return _make_partition(z)

Total time: 2.52685 s
File: /home/martin/sage-develop/local/lib/python2.7/site-packages/sage/combinat/growth.py
Function: backward_rule at line 3930

Line #      Hits         Time  Per Hit   % Time  Line Contents
==============================================================
  3930                                               def backward_rule(self, y, z, x):
  3931                                                   r"""
  3932                                                   Return the content and the input shape.
  3933                                           
  3934                                                   See [Kra2006]_ `(B^4 0)-(B^4 2)`.  (In the arXiv version of
  3935                                                   the article there is a typo: in the computation of carry in
  3936                                                   `(B^4 2)` , `\rho` must be replaced by `\lambda`).
  3937                                           
  3938                                                   INPUT:
  3939                                           
  3940                                                   - ``y, z, x`` -- three partitions from a cell in a
  3941                                                     growth diagram, labelled as::
  3942                                           
  3943                                                         x
  3944                                                       y z
  3945                                           
  3946                                                   OUTPUT:
  3947                                           
  3948                                                   A pair ``(t, content)`` consisting of the shape of the fourth
  3949                                                   partition according to the Burge correspondence and the content of
  3950                                                   the cell.
  3951                                           
  3952                                                   EXAMPLES::
  3953                                           
  3954                                                       sage: Burge = GrowthDiagram.rules.Burge()
  3955                                                       sage: Burge.backward_rule([1,1,1],[2,1,1,1],[2,1,1])
  3956                                                       ([1, 1], 0)
  3957                                           
  3958                                                   TESTS::
  3959                                           
  3960                                                       sage: w = [4,1,8,3,6,5,2,7,9]; G = Burge(w)
  3961                                                       sage: GrowthDiagram(Burge, labels=G._out_labels).to_word() == w  # indirect doctest
  3962                                                       True
  3963                                                   """
  3964      2000      18758.0      9.4      0.7          t = [0]*len(z) # z must be the longest partition
  3965      2000      36897.0     18.4      1.5          mu = [0]*(len(z)-len(x)) + x[::-1]
  3966      2000      35824.0     17.9      1.4          nu = [0]*(len(z)-len(y)) + y[::-1]
  3967      2000      15525.0      7.8      0.6          la = z[::-1]
  3968      2000       4381.0      2.2      0.2          carry = 0
  3969    115754     277390.0      2.4     11.0          for i, (mu_i, la_i, nu_i) in enumerate(zip(mu, la, nu)):
  3970    113754     474543.0      4.2     18.8              s = min(int(mu_i == nu_i == la_i), carry)
  3971    113754     367423.0      3.2     14.5              t[i] = min(mu_i, nu_i) - s
  3972    113754     353673.0      3.1     14.0              carry += -s + la_i - max(mu_i, nu_i)
  3973      2000       5772.0      2.9      0.2          t.reverse()
  3974      2000     936664.0    468.3     37.1          return (_make_partition(t), carry)
```




---

archive/issue_comments_378746.json:
```json
{
    "body": "Now the same thing with #27146 additionally, and inlining `_make_partition`:\n\n```\nsage: %timeit all(Burge(labels=Burge(m).out_labels()) == Burge(m) for m in l)\n1 loop, best of 3: 1.59 s per loop\n```\n\nProfile:\n\n```\nsage: %prun all(Burge(labels=Burge(m).out_labels()) == Burge(m) for m in l)\n         1210898 function calls (1180798 primitive calls) in 2.354 seconds\n\n   Ordered by: internal time\n\n   ncalls  tottime  percall  cumtime  percall filename:lineno(function)\n     4000    0.899    0.000    1.499    0.000 growth.py:3883(forward_rule)\n     2000    0.423    0.000    0.707    0.000 growth.py:3930(backward_rule)\n   685752    0.366    0.000    0.366    0.000 {min}\n   344490    0.158    0.000    0.158    0.000 {max}\n67341/37281    0.075    0.000    0.109    0.000 {len}\n     6480    0.060    0.000    0.086    0.000 combinat.py:1259(__init__)\n     6480    0.058    0.000    0.183    0.000 partition.py:521(__init__)\n\n```\n\nLine profile:\n\n```\n sage: %lprun -f sage.combinat.growth.RuleBurge.forward_rule -f sage.combinat.growth.RuleBurge.backward_rule all(Burge(labels=Burge(m).out_labels()) =\n....:  Burge(m) for m in l)\nTimer unit: 1e-06 s\n\nTotal time: 4.15456 s\nFile: /home/martin/sage-develop/local/lib/python2.7/site-packages/sage/combinat/growth.py\nFunction: forward_rule at line 3883\n\nLine #      Hits         Time  Per Hit   % Time  Line Contents\n==============================================================\n  3883                                               def forward_rule(self, y, t, x, content):\n  3884                                                   r\"\"\"\n  3885                                                   Return the output shape given three shapes and the content.\n  3886                                           \n  3887                                                   See [Kra2006]_ `(F^4 0)-(F^4 2)`.\n  3888                                           \n  3889                                                   INPUT:\n  3890                                           \n  3891                                                   - ``y, t, x`` -- three  from a cell in a growth diagram,\n  3892                                                     labelled as::\n  3893                                           \n  3894                                                         t x\n  3895                                                         y\n  3896                                           \n  3897                                                   - ``content`` -- a non-negative integer; the content of the cell\n  3898                                           \n  3899                                                   OUTPUT:\n  3900                                           \n  3901                                                   The fourth partition according to the Burge correspondence.\n  3902                                           \n  3903                                                   EXAMPLES::\n  3904                                           \n  3905                                                       sage: Burge = GrowthDiagram.rules.Burge()\n  3906                                                       sage: Burge.forward_rule([2,1],[2,1],[2,1],1)\n  3907                                                       [3, 1]\n  3908                                           \n  3909                                                       sage: Burge.forward_rule([1],[],[2],2)\n  3910                                                       [2, 1, 1, 1]\n  3911                                                   \"\"\"\n  3912                                                   # n is the maximal length of longest decreasing chain by\n  3913                                                   # Kleitman-Greene's theorem\n  3914      4000      43584.0     10.9      1.0          n = content + len(x) + len(y)\n  3915      4000      58114.0     14.5      1.4          x += [0]*(n-len(x))\n  3916      4000      55990.0     14.0      1.3          y += [0]*(n-len(y))\n  3917      4000      55342.0     13.8      1.3          t += [0]*(n-len(t))\n  3918      4000      15600.0      3.9      0.4          z = [0]*n\n  3919      4000       7306.0      1.8      0.2          carry = content\n  3920    231508     551113.0      2.4     13.3          for i, (row1, row2, row3) in enumerate(zip(x, t, y)):\n  3921    230736     974409.0      4.2     23.5              s = min(int(row1 == row2 == row3), carry)\n  3922    230736     652322.0      2.8     15.7              new_part = max(row1, row3) + s\n  3923    230736     403578.0      1.7      9.7              if new_part:\n  3924    227508     444328.0      2.0     10.7                  z[i] = new_part\n  3925    227508     689619.0      3.0     16.6                  carry += -s + min(row1, row3) - row2\n  3926                                                       else:\n  3927      3228      25046.0      7.8      0.6                  break\n  3928      4000     178205.0     44.6      4.3          return _Partitions.element_class(_Partitions, z)\n\nTotal time: 1.70078 s\nFile: /home/martin/sage-develop/local/lib/python2.7/site-packages/sage/combinat/growth.py\nFunction: backward_rule at line 3930\n\nLine #      Hits         Time  Per Hit   % Time  Line Contents\n==============================================================\n  3930                                               def backward_rule(self, y, z, x):\n  3931                                                   r\"\"\"\n  3932                                                   Return the content and the input shape.\n  3933                                           \n  3934                                                   See [Kra2006]_ `(B^4 0)-(B^4 2)`.  (In the arXiv version of\n  3935                                                   the article there is a typo: in the computation of carry in\n  3936                                                   `(B^4 2)` , `\\rho` must be replaced by `\\lambda`).\n  3937                                           \n  3938                                                   INPUT:\n  3939                                           \n  3940                                                   - ``y, z, x`` -- three partitions from a cell in a\n  3941                                                     growth diagram, labelled as::\n  3942                                           \n  3943                                                         x\n  3944                                                       y z\n  3945                                           \n  3946                                                   OUTPUT:\n  3947                                           \n  3948                                                   A pair ``(t, content)`` consisting of the shape of the fourth\n  3949                                                   partition according to the Burge correspondence and the content of\n  3950                                                   the cell.\n  3951                                           \n  3952                                                   EXAMPLES::\n  3953                                           \n  3954                                                       sage: Burge = GrowthDiagram.rules.Burge()\n  3955                                                       sage: Burge.backward_rule([1,1,1],[2,1,1,1],[2,1,1])\n  3956                                                       ([1, 1], 0)\n  3957                                           \n  3958                                                   TESTS::\n  3959                                           \n  3960                                                       sage: w = [4,1,8,3,6,5,2,7,9]; G = Burge(w)\n  3961                                                       sage: GrowthDiagram(Burge, labels=G._out_labels).to_word() == w  # indirect doctest\n  3962                                                       True\n  3963                                                   \"\"\"\n  3964      2000      18747.0      9.4      1.1          t = [0]*len(z) # z must be the longest partition\n  3965      2000      36688.0     18.3      2.2          mu = [0]*(len(z)-len(x)) + x[::-1]\n  3966      2000      36038.0     18.0      2.1          nu = [0]*(len(z)-len(y)) + y[::-1]\n  3967      2000      15670.0      7.8      0.9          la = z[::-1]\n  3968      2000       4433.0      2.2      0.3          carry = 0\n  3969    115754     282888.0      2.4     16.6          for i, (mu_i, la_i, nu_i) in enumerate(zip(mu, la, nu)):\n  3970    113754     486350.0      4.3     28.6              s = min(int(mu_i == nu_i == la_i), carry)\n  3971    113754     372067.0      3.3     21.9              t[i] = min(mu_i, nu_i) - s\n  3972    113754     361935.0      3.2     21.3              carry += -s + la_i - max(mu_i, nu_i)\n  3973      2000       5785.0      2.9      0.3          t.reverse()\n  3974      2000      80175.0     40.1      4.7          return (_Partitions.element_class(_Partitions, t), carry)\n```\n",
    "created_at": "2019-02-05T17:50:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26917",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26917#issuecomment-378746",
    "user": "@mantepse"
}
```

Now the same thing with #27146 additionally, and inlining `_make_partition`:

```
sage: %timeit all(Burge(labels=Burge(m).out_labels()) == Burge(m) for m in l)
1 loop, best of 3: 1.59 s per loop
```

Profile:

```
sage: %prun all(Burge(labels=Burge(m).out_labels()) == Burge(m) for m in l)
         1210898 function calls (1180798 primitive calls) in 2.354 seconds

   Ordered by: internal time

   ncalls  tottime  percall  cumtime  percall filename:lineno(function)
     4000    0.899    0.000    1.499    0.000 growth.py:3883(forward_rule)
     2000    0.423    0.000    0.707    0.000 growth.py:3930(backward_rule)
   685752    0.366    0.000    0.366    0.000 {min}
   344490    0.158    0.000    0.158    0.000 {max}
67341/37281    0.075    0.000    0.109    0.000 {len}
     6480    0.060    0.000    0.086    0.000 combinat.py:1259(__init__)
     6480    0.058    0.000    0.183    0.000 partition.py:521(__init__)

```

Line profile:

```
 sage: %lprun -f sage.combinat.growth.RuleBurge.forward_rule -f sage.combinat.growth.RuleBurge.backward_rule all(Burge(labels=Burge(m).out_labels()) =
....:  Burge(m) for m in l)
Timer unit: 1e-06 s

Total time: 4.15456 s
File: /home/martin/sage-develop/local/lib/python2.7/site-packages/sage/combinat/growth.py
Function: forward_rule at line 3883

Line #      Hits         Time  Per Hit   % Time  Line Contents
==============================================================
  3883                                               def forward_rule(self, y, t, x, content):
  3884                                                   r"""
  3885                                                   Return the output shape given three shapes and the content.
  3886                                           
  3887                                                   See [Kra2006]_ `(F^4 0)-(F^4 2)`.
  3888                                           
  3889                                                   INPUT:
  3890                                           
  3891                                                   - ``y, t, x`` -- three  from a cell in a growth diagram,
  3892                                                     labelled as::
  3893                                           
  3894                                                         t x
  3895                                                         y
  3896                                           
  3897                                                   - ``content`` -- a non-negative integer; the content of the cell
  3898                                           
  3899                                                   OUTPUT:
  3900                                           
  3901                                                   The fourth partition according to the Burge correspondence.
  3902                                           
  3903                                                   EXAMPLES::
  3904                                           
  3905                                                       sage: Burge = GrowthDiagram.rules.Burge()
  3906                                                       sage: Burge.forward_rule([2,1],[2,1],[2,1],1)
  3907                                                       [3, 1]
  3908                                           
  3909                                                       sage: Burge.forward_rule([1],[],[2],2)
  3910                                                       [2, 1, 1, 1]
  3911                                                   """
  3912                                                   # n is the maximal length of longest decreasing chain by
  3913                                                   # Kleitman-Greene's theorem
  3914      4000      43584.0     10.9      1.0          n = content + len(x) + len(y)
  3915      4000      58114.0     14.5      1.4          x += [0]*(n-len(x))
  3916      4000      55990.0     14.0      1.3          y += [0]*(n-len(y))
  3917      4000      55342.0     13.8      1.3          t += [0]*(n-len(t))
  3918      4000      15600.0      3.9      0.4          z = [0]*n
  3919      4000       7306.0      1.8      0.2          carry = content
  3920    231508     551113.0      2.4     13.3          for i, (row1, row2, row3) in enumerate(zip(x, t, y)):
  3921    230736     974409.0      4.2     23.5              s = min(int(row1 == row2 == row3), carry)
  3922    230736     652322.0      2.8     15.7              new_part = max(row1, row3) + s
  3923    230736     403578.0      1.7      9.7              if new_part:
  3924    227508     444328.0      2.0     10.7                  z[i] = new_part
  3925    227508     689619.0      3.0     16.6                  carry += -s + min(row1, row3) - row2
  3926                                                       else:
  3927      3228      25046.0      7.8      0.6                  break
  3928      4000     178205.0     44.6      4.3          return _Partitions.element_class(_Partitions, z)

Total time: 1.70078 s
File: /home/martin/sage-develop/local/lib/python2.7/site-packages/sage/combinat/growth.py
Function: backward_rule at line 3930

Line #      Hits         Time  Per Hit   % Time  Line Contents
==============================================================
  3930                                               def backward_rule(self, y, z, x):
  3931                                                   r"""
  3932                                                   Return the content and the input shape.
  3933                                           
  3934                                                   See [Kra2006]_ `(B^4 0)-(B^4 2)`.  (In the arXiv version of
  3935                                                   the article there is a typo: in the computation of carry in
  3936                                                   `(B^4 2)` , `\rho` must be replaced by `\lambda`).
  3937                                           
  3938                                                   INPUT:
  3939                                           
  3940                                                   - ``y, z, x`` -- three partitions from a cell in a
  3941                                                     growth diagram, labelled as::
  3942                                           
  3943                                                         x
  3944                                                       y z
  3945                                           
  3946                                                   OUTPUT:
  3947                                           
  3948                                                   A pair ``(t, content)`` consisting of the shape of the fourth
  3949                                                   partition according to the Burge correspondence and the content of
  3950                                                   the cell.
  3951                                           
  3952                                                   EXAMPLES::
  3953                                           
  3954                                                       sage: Burge = GrowthDiagram.rules.Burge()
  3955                                                       sage: Burge.backward_rule([1,1,1],[2,1,1,1],[2,1,1])
  3956                                                       ([1, 1], 0)
  3957                                           
  3958                                                   TESTS::
  3959                                           
  3960                                                       sage: w = [4,1,8,3,6,5,2,7,9]; G = Burge(w)
  3961                                                       sage: GrowthDiagram(Burge, labels=G._out_labels).to_word() == w  # indirect doctest
  3962                                                       True
  3963                                                   """
  3964      2000      18747.0      9.4      1.1          t = [0]*len(z) # z must be the longest partition
  3965      2000      36688.0     18.3      2.2          mu = [0]*(len(z)-len(x)) + x[::-1]
  3966      2000      36038.0     18.0      2.1          nu = [0]*(len(z)-len(y)) + y[::-1]
  3967      2000      15670.0      7.8      0.9          la = z[::-1]
  3968      2000       4433.0      2.2      0.3          carry = 0
  3969    115754     282888.0      2.4     16.6          for i, (mu_i, la_i, nu_i) in enumerate(zip(mu, la, nu)):
  3970    113754     486350.0      4.3     28.6              s = min(int(mu_i == nu_i == la_i), carry)
  3971    113754     372067.0      3.3     21.9              t[i] = min(mu_i, nu_i) - s
  3972    113754     361935.0      3.2     21.3              carry += -s + la_i - max(mu_i, nu_i)
  3973      2000       5785.0      2.9      0.3          t.reverse()
  3974      2000      80175.0     40.1      4.7          return (_Partitions.element_class(_Partitions, t), carry)
```




---

archive/issue_comments_378747.json:
```json
{
    "body": "Finally, the timing without inlining is identical to the timing above.",
    "created_at": "2019-02-05T17:53:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26917",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26917#issuecomment-378747",
    "user": "@mantepse"
}
```

Finally, the timing without inlining is identical to the timing above.



---

archive/issue_comments_378748.json:
```json
{
    "body": "Ticket retargeted after milestone closed (if you don't believe this ticket is appropriate for the Sage 8.8 release please retarget manually)",
    "created_at": "2019-03-25T10:56:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26917",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26917#issuecomment-378748",
    "user": "@embray"
}
```

Ticket retargeted after milestone closed (if you don't believe this ticket is appropriate for the Sage 8.8 release please retarget manually)



---

archive/issue_comments_378749.json:
```json
{
    "body": "Moving tickets from the Sage 8.8 milestone that have been actively worked on in the last six months to the next release milestone (optimistically).",
    "created_at": "2019-07-03T11:37:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26917",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26917#issuecomment-378749",
    "user": "@embray"
}
```

Moving tickets from the Sage 8.8 milestone that have been actively worked on in the last six months to the next release milestone (optimistically).



---

archive/issue_comments_378750.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2019-10-29T13:51:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26917",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26917#issuecomment-378750",
    "user": "@fchapoton"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_378751.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-10-30T10:48:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26917",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26917#issuecomment-378751",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_378752.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2019-10-30T10:49:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26917",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26917#issuecomment-378752",
    "user": "@mantepse"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_378753.json:
```json
{
    "body": "I should do new timings, I guess.",
    "created_at": "2019-10-30T10:49:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26917",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26917#issuecomment-378753",
    "user": "@mantepse"
}
```

I should do new timings, I guess.



---

archive/issue_comments_378754.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2019-11-18T09:34:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26917",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26917#issuecomment-378754",
    "user": "@fchapoton"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_378755.json:
```json
{
    "body": "red branch",
    "created_at": "2019-11-18T09:34:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26917",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26917#issuecomment-378755",
    "user": "@fchapoton"
}
```

red branch



---

archive/issue_comments_378756.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-11-18T18:13:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26917",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26917#issuecomment-378756",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_378757.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2019-11-18T18:25:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26917",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26917#issuecomment-378757",
    "user": "@mantepse"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_378758.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-11-18T19:52:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26917",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26917#issuecomment-378758",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_378759.json:
```json
{
    "body": "failing doctests in the new hidden function (missing import in the doctests)",
    "created_at": "2019-11-19T19:06:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26917",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26917#issuecomment-378759",
    "user": "@fchapoton"
}
```

failing doctests in the new hidden function (missing import in the doctests)



---

archive/issue_comments_378760.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2019-11-19T19:06:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26917",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26917#issuecomment-378760",
    "user": "@fchapoton"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_378761.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-11-19T20:08:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26917",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26917#issuecomment-378761",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_378762.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2019-11-19T20:09:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26917",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26917#issuecomment-378762",
    "user": "@mantepse"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_378763.json:
```json
{
    "body": "sorry about that...",
    "created_at": "2019-11-19T20:09:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26917",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26917#issuecomment-378763",
    "user": "@mantepse"
}
```

sorry about that...



---

archive/issue_comments_378764.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-11-20T08:24:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26917",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26917#issuecomment-378764",
    "user": "@fchapoton"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_378765.json:
```json
{
    "body": "ok, good to go",
    "created_at": "2019-11-20T08:24:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26917",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26917#issuecomment-378765",
    "user": "@fchapoton"
}
```

ok, good to go



---

archive/issue_comments_378766.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-11-28T21:53:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26917",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26917#issuecomment-378766",
    "user": "@vbraun"
}
```

Resolution: fixed
