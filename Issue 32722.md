# Issue 32722: Upgrade to givaro-4.2.0 fflas-ffpack-2.5.0 linbox-1.7.0

Issue created by migration from https://trac.sagemath.org/ticket/32959

Original creator: cpernet

Original creation time: 2021-12-02 10:49:33

CC:  fbissey mjo




---

Comment by mkoeppe created at 2021-12-02 18:32:55

I see numerous build errors in https://github.com/linbox-team/fflas-ffpack/runs/4383290866?check_suite_focus=true that will need fixing before we can do these updates


---

Comment by cpernet created at 2021-12-03 08:35:38

Of course. I just created this ticket to start working on a its branch, which will help us fix the last issues before cutting the final releases.
Btw, I did not manage to access to the full artifact of the givaro install log givaro which caused the failures in these github action builds (only the tail of the givaro-log is displayed in the sage build log in your link). Is there any way to access it? (I could not find it in the whole log archive).


---

Comment by cpernet created at 2021-12-03 14:13:09

New commits:


---

Comment by mkoeppe created at 2021-12-03 18:27:43

Replying to [comment:5 cpernet]:
> I did not manage to access to the full artifact of the givaro install log givaro which caused the failures in these github action builds (only the tail of the givaro-log is displayed in the sage build log in your link). Is there any way to access it? (I could not find it in the whole log archive).

In each run, such as https://github.com/linbox-team/fflas-ffpack/runs/4383290866?check_suite_focus=true, there is a section "Print out logs for immediate inspection" in the output, which shows all logs of failing package builds in full.

When all jobs have completed, the summary page, such as https://github.com/linbox-team/fflas-ffpack/actions/runs/1526437644, gives access to the log artifacts.
For example, `logs-commit-3e42b4a1aaa585bce832738d5a8885dcf7c4273e-tox-docker-ubuntu-xenial-standard` (https://github.com/linbox-team/fflas-ffpack/suites/4521078418/artifacts/121757925) gives a zip file within which you will find `logs/pkgs/givaro-git.log`


---

Comment by mkoeppe created at 2021-12-03 18:28:33

We have a bit of documentation on this at https://doc.sagemath.org/html/en/developer/portability_testing.html#automatic-parallel-tox-runs-on-github-actions; if you feel anything needs to be added, let me know


---

Comment by cpernet created at 2021-12-04 08:44:35

Thanks a lot for the pointers.


---

Comment by git created at 2021-12-07 13:13:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-12-08 00:31:43

The `checksums.ini` files should get `upstream_url` lines, see https://doc.sagemath.org/html/en/developer/packaging.html#upstream-urls


---

Comment by git created at 2021-12-14 10:30:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by cpernet created at 2021-12-14 10:42:36

I just released the three libraries and updated this branch with the corresponding checksums, and added the upstream_url as requested.

I could check that the testsuite passes on 2 machines (broadwell and skylake-X both running Linux mint).

I only had to comment out `local/include/factory/factory.h` line 92 (`#define IntegerDomain 1`), because this define by Singular gets in the way of Givaro's `Givaro::IntegerDomain`. See [https://groups.google.com/g/sage-devel/c/lC941Lab5ck](https://groups.google.com/g/sage-devel/c/lC941Lab5ck)

Dima suggested to pacth this file, but I am not sure to see where this should be done in sage install process. Any help would be most welcome.


---

Comment by dimpase created at 2021-12-14 12:03:26

Does https://github.com/Singular/Singular/commit/18bb792edcc6d3f65af0111f93ed61118123ffd1
do the job? Or they made an error there, it doesn't fix anything for you?


---

Comment by dimpase created at 2021-12-14 12:10:45

Replying to [comment:16 dimpase]:
> Does https://github.com/Singular/Singular/commit/18bb792edcc6d3f65af0111f93ed61118123ffd1
> do the job? Or they made an error there, it doesn't fix anything for you?

Note that the patched file is actually meant to be preprocessed by Singular's `./factory/bin/makeheader`


---

Comment by mjo created at 2021-12-14 13:12:14

Replying to [comment:15 cpernet]:
> 
> Dima suggested to pacth this file, but I am not sure to see where this should be done in sage install process. Any help would be most welcome.

I don't think there's such an easy solution. The straightforward one is to wait for a new singular release, and then upgrade singular and givaro in sage at the same time, after enough distributions have packaged them both.


---

Comment by mkoeppe created at 2021-12-14 16:38:33

I would suggest to work around this clash in Givaro.


---

Comment by mkoeppe created at 2021-12-14 16:44:34

The latest run of the integration testing workflow - https://github.com/linbox-team/fflas-ffpack/runs/4511137082?check_suite_focus=true - fails badly on all platforms


---

Comment by cpernet created at 2021-12-14 17:31:54

Replying to [comment:20 mkoeppe]:
> The latest run of the integration testing workflow - https://github.com/linbox-team/fflas-ffpack/runs/4511137082?check_suite_focus=true - fails badly on all platforms
This run does not correspond to the released package and the failure there has been fixed in a more recent commit which is in the release.


---

Comment by mkoeppe created at 2021-12-14 17:35:11

You may want to cancel the runs that are no longer needed so that the current one gets a chance to run


---

Comment by cpernet created at 2021-12-14 17:36:44

Replying to [comment:19 mkoeppe]:
> I would suggest to work around this clash in Givaro.
`Givaro::IntegerDomain` is in the public API of Givaro, and used for instance by fflas-ffpack, but possibly other external users or libraries.
It is rather hard to justify such a change on Givaro's side. I'd like to investigate further the option of changing the include order.


---

Comment by cpernet created at 2021-12-14 17:38:58

Replying to [comment:23 mkoeppe]:
> You may want to cancel the runs that are no longer needed so that the current one gets a chance to run
I was precisely doing this.
I'll look into how to reduce the number of builds: it is quite a waste of energy to launch the whole build at any PR or push on master.


---

Comment by arojas created at 2021-12-14 18:06:23

Replying to [comment:16 dimpase]:
> Does https://github.com/Singular/Singular/commit/18bb792edcc6d3f65af0111f93ed61118123ffd1
> do the job? Or they made an error there, it doesn't fix anything for you?

I can confirm that this Singular commit fixes the API conflicts, and Sage builds fine against the new linbox with this branch.


---

Comment by mkoeppe created at 2021-12-14 18:46:06

Replying to [comment:25 cpernet]:
> I'll look into how to reduce the number of builds: it is quite a waste of energy to launch the whole build at any PR or push on master.

You could for example change it to running only when a tag is pushed


---

Comment by mkoeppe created at 2021-12-14 20:36:49

By the way, the singular update ticket #32907 needs review. Perhaps the patch should be added there?


---

Comment by mjo created at 2021-12-14 23:19:18

Replying to [comment:28 mkoeppe]:
> By the way, the singular update ticket #32907 needs review. Perhaps the patch should be added there?

Please don't; if this ticket is then merged, that would magnify the problem from a small upstream annoyance to once that affects all distributions.


---

Comment by mkoeppe created at 2021-12-14 23:25:39

Hm? Isn't this an upstream commit that will be in some later version of Singular anyway?


---

Comment by mjo created at 2021-12-14 23:28:25

Replying to [comment:30 mkoeppe]:
> Hm? Isn't this an upstream commit that will be in some later version of Singular anyway?

Yes, but once sage has a patched singular, it can upgrade givaro/linbox/fflas-ffpack, while distros cannot (without backporting the patch).


---

Comment by mkoeppe created at 2021-12-15 00:23:41

Replying to [comment:24 cpernet]:
> Replying to [comment:19 mkoeppe]:
> > I would suggest to work around this clash in Givaro.
> `Givaro::IntegerDomain` is in the public API of Givaro, and used for instance by fflas-ffpack, but possibly other external users or libraries.
> It is rather hard to justify such a change on Givaro's side.

Has it been in the API of any released version of Givaro?


---

Comment by cpernet created at 2022-01-05 07:51:23

Replying to [comment:32 mkoeppe]:
> Has it been in the API of any released version of Givaro? 

Since v4.0.1 (2016-02-24).

It seems that are only left with the following options:
- delay the review of this ticket until Singular releases a new version including the fix, and all distros sage wants to support package it
- change givaro's API and fflas-ffpack usage of this API
- investigate the include chain and revert to a situation where singular is included after givaro and fflas-ffpack (this is probably why the problem did not show up previously)

Am I missing something?


---

Comment by git created at 2022-01-05 13:06:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by cpernet created at 2022-01-05 13:10:34

I pushed a fix for the naming conflict, forcing the include of `givinteger.h` before the include of `factory.h`. This was the cleaner way I could find. Trying to identify all situation where singular was included before givaro and swapping them, ended up in a mess.


---

Comment by dimpase created at 2022-01-13 17:27:48

Singular 4.3.0 has been released - with the Singular patch in comment:26 merged.


---

Comment by mkoeppe created at 2022-02-01 00:27:59

Changing priority from major to critical.


---

Comment by mkoeppe created at 2022-02-06 20:27:08

Replying to [comment:35 cpernet]:
> I pushed a fix for the naming conflict, forcing the include of `givinteger.h` before the include of `factory.h`. This was the cleaner way I could find. Trying to identify all situation where singular was included before givaro and swapping them, ended up in a mess.

This looks like a good solution for now, but this will become an obstacle to modularization pretty soon.


---

Comment by cpernet created at 2022-02-07 07:41:05

Replying to [comment:39 mkoeppe]:
> This looks like a good solution for now, but this will become an obstacle to modularization pretty soon.
Should I revert this commit, as the fixed Singular is now released ? I am not sure what's the best move to get thinks rolling. Just let me know.


---

Comment by mkoeppe created at 2022-02-07 16:48:39

This would depend on 
- actually making the Singular update (#33160, which needs help)
- tightening our version requirement in `build/pkgs/singular/spkg-configure.m4`


---

Comment by mkoeppe created at 2022-02-07 16:52:22

By the way, I've marked this ticket for Sage 9.7 because of the increased compiler requirements (see #32074).

Also before we can merge this upgrade, Cygwin support needs to repaired (https://github.com/linbox-team/fflas-ffpack/runs/4658698318)


---

Comment by mkoeppe created at 2022-02-07 16:54:00

Also, 32bit platforms seem broken


---

Comment by mkoeppe created at 2022-08-25 20:16:13

`@`cpernet Is it planned to release new versions of the packages that include patches you may have received from distribution packaging?


---

Comment by cpernet created at 2022-08-26 12:15:39

Yes, I'm finally getting back to it, and would like to cut a minor version in a near future (say september or october) fixing the various issues raised here and in other PRs.
