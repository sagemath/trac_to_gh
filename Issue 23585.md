# Issue 23585: Python3 build error: unicode problem in pip_installed_packages()

archive/issues_023585.json:
```json
{
    "body": "The python 3 build was broken by #23615 because of incorrect unicode usage causing the building of sage failing in the following way\n\n\n```\nchapoton@icj-laptop:~/sage3$ ./sage -br\ncd . && export                                    \\\n    SAGE_ROOT=/doesnotexist                               \\\n    SAGE_SRC=/doesnotexist                                \\\n    SAGE_SRC_ROOT=/doesnotexist                           \\\n    SAGE_DOC_SRC=/doesnotexist                            \\\n    SAGE_BUILD_DIR=/doesnotexist                          \\\n    SAGE_PKGS=/home/chapoton/sage3/build/pkgs                \\\n    SAGE_CYTHONIZED=/home/chapoton/sage3/src/build/cythonized      \\\n&& sage-python23 -u setup.py --no-user-cfg build install\n************************************************************************\nTraceback (most recent call last):\n  File \"setup.py\", line 69, in <module>\n    from module_list import ext_modules, library_order, aliases\n  File \"/home/chapoton/sage3/src/module_list.py\", line 166, in <module>\n    from sage_setup.optional_extension import OptionalExtension\n  File \"/home/chapoton/sage3/src/sage_setup/optional_extension.py\", line 24, in <module>\n    all_packages = list_packages(local=True)\n  File \"/home/chapoton/sage3/src/sage/misc/package.py\", line 226, in list_packages\n    installed = installed_packages(exclude_pip)\n  File \"/home/chapoton/sage3/src/sage/misc/package.py\", line 286, in installed_packages\n    installed.update(pip_installed_packages())\n  File \"/home/chapoton/sage3/src/sage/misc/package.py\", line 148, in pip_installed_packages\n    return {package['name'].lower():package['version'] for package in json.loads(stdout)}\n  File \"/home/chapoton/sage3/local/lib/python3.6/json/__init__.py\", line 354, in loads\n    return _default_decoder.decode(s)\n  File \"/home/chapoton/sage3/local/lib/python3.6/json/decoder.py\", line 339, in decode\n    obj, end = self.raw_decode(s, idx=_w(s, 0).end())\n  File \"/home/chapoton/sage3/local/lib/python3.6/json/decoder.py\", line 357, in raw_decode\n    raise JSONDecodeError(\"Expecting value\", s, err.value) from None\njson.decoder.JSONDecodeError: Expecting value: line 1 column 1 (char 0)\n************************************************************************\nError building the Sage library\n************************************************************************\nMakefile:34 : la recette pour la cible \u00ab sage \u00bb a \u00e9chou\u00e9e\nmake: *** [sage] Erreur 1\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/23822\n\n",
    "created_at": "2017-09-10T12:44:20Z",
    "labels": [
        "component: python3",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.1",
    "title": "Python3 build error: unicode problem in pip_installed_packages()",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/23585",
    "user": "https://github.com/koffie"
}
```
The python 3 build was broken by #23615 because of incorrect unicode usage causing the building of sage failing in the following way


```
chapoton@icj-laptop:~/sage3$ ./sage -br
cd . && export                                    \
    SAGE_ROOT=/doesnotexist                               \
    SAGE_SRC=/doesnotexist                                \
    SAGE_SRC_ROOT=/doesnotexist                           \
    SAGE_DOC_SRC=/doesnotexist                            \
    SAGE_BUILD_DIR=/doesnotexist                          \
    SAGE_PKGS=/home/chapoton/sage3/build/pkgs                \
    SAGE_CYTHONIZED=/home/chapoton/sage3/src/build/cythonized      \
&& sage-python23 -u setup.py --no-user-cfg build install
************************************************************************
Traceback (most recent call last):
  File "setup.py", line 69, in <module>
    from module_list import ext_modules, library_order, aliases
  File "/home/chapoton/sage3/src/module_list.py", line 166, in <module>
    from sage_setup.optional_extension import OptionalExtension
  File "/home/chapoton/sage3/src/sage_setup/optional_extension.py", line 24, in <module>
    all_packages = list_packages(local=True)
  File "/home/chapoton/sage3/src/sage/misc/package.py", line 226, in list_packages
    installed = installed_packages(exclude_pip)
  File "/home/chapoton/sage3/src/sage/misc/package.py", line 286, in installed_packages
    installed.update(pip_installed_packages())
  File "/home/chapoton/sage3/src/sage/misc/package.py", line 148, in pip_installed_packages
    return {package['name'].lower():package['version'] for package in json.loads(stdout)}
  File "/home/chapoton/sage3/local/lib/python3.6/json/__init__.py", line 354, in loads
    return _default_decoder.decode(s)
  File "/home/chapoton/sage3/local/lib/python3.6/json/decoder.py", line 339, in decode
    obj, end = self.raw_decode(s, idx=_w(s, 0).end())
  File "/home/chapoton/sage3/local/lib/python3.6/json/decoder.py", line 357, in raw_decode
    raise JSONDecodeError("Expecting value", s, err.value) from None
json.decoder.JSONDecodeError: Expecting value: line 1 column 1 (char 0)
************************************************************************
Error building the Sage library
************************************************************************
Makefile:34 : la recette pour la cible « sage » a échouée
make: *** [sage] Erreur 1
```


Issue created by migration from https://trac.sagemath.org/ticket/23822





---

archive/issue_comments_330126.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-09-10T12:53:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23585#issuecomment-330126",
    "user": "https://github.com/koffie"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_330127.json:
```json
{
    "body": "New commits:",
    "created_at": "2017-09-10T12:53:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23585#issuecomment-330127",
    "user": "https://github.com/koffie"
}
```

New commits:



---

archive/issue_comments_330128.json:
```json
{
    "body": "ok, let it be",
    "created_at": "2017-09-18T08:01:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23585#issuecomment-330128",
    "user": "https://github.com/fchapoton"
}
```

ok, let it be



---

archive/issue_comments_330129.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-09-18T08:01:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23585#issuecomment-330129",
    "user": "https://github.com/fchapoton"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_330130.json:
```json
{
    "body": "Do you need the `.decode`, or can you just use\n\n```\nstdout = proc.communicate()[0]\n```\n\n?",
    "created_at": "2017-09-18T15:49:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23585#issuecomment-330130",
    "user": "https://github.com/jhpalmieri"
}
```

Do you need the `.decode`, or can you just use

```
stdout = proc.communicate()[0]
```

?



---

archive/issue_comments_330131.json:
```json
{
    "body": "In python 2 it is not needed but good praxis.  In python 3 it is needed since stdout is a bytestring before decoding and the json library only takes unicode strings and not bytestrings as input.",
    "created_at": "2017-09-18T21:49:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23585#issuecomment-330131",
    "user": "https://github.com/koffie"
}
```

In python 2 it is not needed but good praxis.  In python 3 it is needed since stdout is a bytestring before decoding and the json library only takes unicode strings and not bytestrings as input.



---

archive/issue_comments_330132.json:
```json
{
    "body": "When I was looking at #23876, I came across this bug and didn't use `.decode`, and it seemed to work with Python 3. That is, before making any changes, Sage crashed on startup, complaining about this problem, but when I switched to `stdout = proc.communicate()[0]`, it didn't complain about that. (It crashed elsewhere, as described at #23876.) So I am not convinced that it is needed with Python 3.\n\nOkay, I checked the Python documentation. I agree that `stdout` should be a binary stream, but according to the [json documentation](https://docs.python.org/3/library/json.html#json.loads), `json.loads` can take something of type `bytes` as input.\n\nEdit: this behavior of `json` is new as of Python 3.6.",
    "created_at": "2017-09-18T22:00:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23585#issuecomment-330132",
    "user": "https://github.com/jhpalmieri"
}
```

When I was looking at #23876, I came across this bug and didn't use `.decode`, and it seemed to work with Python 3. That is, before making any changes, Sage crashed on startup, complaining about this problem, but when I switched to `stdout = proc.communicate()[0]`, it didn't complain about that. (It crashed elsewhere, as described at #23876.) So I am not convinced that it is needed with Python 3.

Okay, I checked the Python documentation. I agree that `stdout` should be a binary stream, but according to the [json documentation](https://docs.python.org/3/library/json.html#json.loads), `json.loads` can take something of type `bytes` as input.

Edit: this behavior of `json` is new as of Python 3.6.



---

archive/issue_comments_330133.json:
```json
{
    "body": "I could have sworn that I only added the decode() because it was failing otherwise. But sage was already on 3.6 when I wrote this. I dont think either solution is clearly better then the other. But the one with a decode already has positive review so I propose to leave it as is.",
    "created_at": "2017-09-18T22:36:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23585#issuecomment-330133",
    "user": "https://github.com/koffie"
}
```

I could have sworn that I only added the decode() because it was failing otherwise. But sage was already on 3.6 when I wrote this. I dont think either solution is clearly better then the other. But the one with a decode already has positive review so I propose to leave it as is.



---

archive/issue_comments_330134.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-09-20T22:26:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23585#issuecomment-330134",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
