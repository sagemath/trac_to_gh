# Issue 18158: (moderate) Speedup in layout_spring

Issue created by migration from https://trac.sagemath.org/ticket/18395

Original creator: ncohen

Original creation time: 2015-05-10 08:57:53

CC:  vbraun vdelecroix dcoudert

This branch improves (a bit) the performances of the 'layout_spring' algorithm, i.e. the attraction/repulsion layout for graphs.

I tested it on the `CameronGraph` (big and dense), with the following results:

Before:


```
sage: g = graphs.CameronGraph()
sage: %time _=g.layout_spring(iterations=100000)
CPU times: user 30.8 s, sys: 8 ms, total: 30.8 s
Wall time: 30.8 s
```


After


```
sage: g = graphs.CameronGraph()
sage: %time _=g.layout_spring(iterations=100000)
CPU times: user 14.3 s, sys: 4 ms, total: 14.3 s
Wall time: 14.3 s
```


Honestly, that is mostly a failure. Most of the speedup comes from templating the code so that `dim=2` and `dim=3` are decided at compile-time. Most of the time it spend mulsitplying floats, and that's what I have been trying to reduce. Not with obvious success `:-/`

Nathann


---

Comment by ncohen created at 2015-05-10 08:58:09

Changing status from new to needs_review.


---

Comment by git created at 2015-05-10 08:59:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2015-05-10 09:05:10

`mulsitplying floats`? Never heard of that ;-)


---

Comment by ncohen created at 2015-05-10 09:07:19

> `mulsitplying floats`? Never heard of that ;-)

Can't you fix the typo instead of commenting on it?


---

Comment by git created at 2015-06-27 16:17:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dcoudert created at 2015-07-19 12:34:50

Changing status from needs_review to needs_work.


---

Comment by dcoudert created at 2015-07-19 12:34:50

I tried on top of 6.8.rc0

```
sage -t --long src/sage/graphs/generic_graph_pyx.pyx
**********************************************************************
File "src/sage/graphs/generic_graph_pyx.pyx", line 54, in sage.graphs.generic_graph_pyx.spring_layout_fast_split
Failed example:
    spring_layout_fast_split(G)
Expected:
    {0: [0.452..., 0.247...], ..., 502: [25.7..., 0.505...]}
Got:
    {0: [nan, nan],
     1: [nan, nan],
     2: [nan, nan],
...
     902: [nan, nan]}
**********************************************************************
File "src/sage/graphs/generic_graph_pyx.pyx", line 97, in sage.graphs.generic_graph_pyx.spring_layout_fast
Failed example:
    spring_layout_fast(G)
Expected:
    {0: [-0.0733..., 0.157...], ..., 502: [-0.551..., 0.682...]}
Got:
    {0: [nan, nan],
     1: [nan, nan],
...
     902: [nan, nan]}
**********************************************************************
File "src/sage/graphs/generic_graph_pyx.pyx", line 113, in sage.graphs.generic_graph_pyx.spring_layout_fast
Failed example:
    spring_layout_fast(G, by_component = True)
Expected:
    {0: [2.12..., -0.321...], ..., 502: [26.0..., -0.812...]}
Got:
    {0: [nan, nan],
     1: [nan, nan],
...
     902: [nan, nan]}
**********************************************************************
File "src/sage/graphs/generic_graph_pyx.pyx", line 346, in sage.graphs.generic_graph_pyx.sqrt_approx
Failed example:
    polar_plot([1,lambda x:dist(cos(x),sin(x))], (0, 2*pi))
Expected:
    Launched png viewer for Graphics object consisting of 2 graphics primitives
Got:
    Graphics object consisting of 2 graphics primitives
**********************************************************************
3 items had failures:
   2 of   9 in sage.graphs.generic_graph_pyx.spring_layout_fast
   1 of   5 in sage.graphs.generic_graph_pyx.spring_layout_fast_split
   1 of   3 in sage.graphs.generic_graph_pyx.sqrt_approx
    [81 tests, 4 failures, 3.03 s]
----------------------------------------------------------------------
sage -t --long src/sage/graphs/generic_graph_pyx.pyx  # 4 doctests failed
----------------------------------------------------------------------
Total time for all tests: 3.1 seconds
    cpu time: 2.8 seconds
    cumulative wall time: 3.0 seconds
```



---

Comment by git created at 2015-07-20 12:07:26

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-07-20 12:14:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by ncohen created at 2015-07-20 12:15:06

Changing status from needs_work to needs_review.


---

Comment by dcoudert created at 2015-07-20 15:40:08

Changing status from needs_review to needs_work.


---

Comment by dcoudert created at 2015-07-20 15:40:08

some problems remain :(

```
sage -t --long src/sage/graphs/generic_graph_pyx.pyx
**********************************************************************
File "src/sage/graphs/generic_graph_pyx.pyx", line 54, in sage.graphs.generic_graph_pyx.spring_layout_fast_split
Failed example:
    spring_layout_fast_split(G)
Expected:
    {0: [0.452..., 0.247...], ..., 502: [25.7..., 0.505...]}
Got:
    {0: [0.7785109925614286, 0.06976708739098784],
     1: [0.7761449200341834, 0.5516862310233024],
...
     902: [3.130511551759616, 0.22735834286143738]}
**********************************************************************
File "src/sage/graphs/generic_graph_pyx.pyx", line 97, in sage.graphs.generic_graph_pyx.spring_layout_fast
Failed example:
    spring_layout_fast(G)
Expected:
    {0: [-0.0733..., 0.157...], ..., 502: [-0.551..., 0.682...]}
Got:
    {0: [0.007496865679470362, 0.04129113197411667],
     1: [0.01495366592880235, 0.08850535412927439],
     2: [0.05849657218327249, 0.09484847570321614],
...
     901: [-0.4474352390771702, -0.10570013179405174],
     902: [-0.47861195812354, -0.10660577880837746]}
**********************************************************************
File "src/sage/graphs/generic_graph_pyx.pyx", line 113, in sage.graphs.generic_graph_pyx.spring_layout_fast
Failed example:
    spring_layout_fast(G, by_component = True)
Expected:
    {0: [2.12..., -0.321...], ..., 502: [26.0..., -0.812...]}
Got:
    {0: [2.2186445972355, -0.008574741789712105],
     1: [2.121454111190332, 0.5076017939042802],
...
     902: [3.0706796988471234, 0.8610997979963941]}
**********************************************************************
File "src/sage/graphs/generic_graph_pyx.pyx", line 348, in sage.graphs.generic_graph_pyx.sqrt_approx
Failed example:
    polar_plot([1,lambda x:dist(cos(x),sin(x))], (0, 2*pi))
Expected:
    Launched png viewer for Graphics object consisting of 2 graphics primitives
Got:
    Graphics object consisting of 2 graphics primitives
**********************************************************************
3 items had failures:
   2 of   9 in sage.graphs.generic_graph_pyx.spring_layout_fast
   1 of   5 in sage.graphs.generic_graph_pyx.spring_layout_fast_split
   1 of   3 in sage.graphs.generic_graph_pyx.sqrt_approx
    [81 tests, 4 failures, 3.42 s]
----------------------------------------------------------------------
sage -t --long src/sage/graphs/generic_graph_pyx.pyx  # 4 doctests failed
----------------------------------------------------------------------
Total time for all tests: 3.5 seconds
    cpu time: 3.2 seconds
    cumulative wall time: 3.4 seconds
```



---

Comment by git created at 2015-07-20 17:02:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by ncohen created at 2015-07-20 17:03:01

Changing status from needs_work to needs_review.


---

Comment by ncohen created at 2015-07-20 17:03:01

Sorry 'bout that `:-/`

Fixed.

Nathann


---

Comment by vbraun created at 2015-07-20 17:40:58

Those two almost certainly compile to the same binary:

```
-              for x from 0 <= x < dim:
-                  disp_i[x] += delta[x] * force
-                  disp_j[x] -= delta[x] * force
+              for x in range(dim):
+                  d_tmp = delta[x] * force
+                  disp_i[x] += d_tmp
+                  disp_j[x] -= d_tmp
```

You can probably speed it by a few orders of magnitude by not using Euler's method.


---

Comment by mderickx created at 2017-08-30 18:29:49

Changing status from needs_review to needs_work.


---

Comment by mderickx created at 2017-08-30 18:29:49

Needs to be rebased on sage8.1beta3


---

Comment by dcoudert created at 2017-08-31 11:10:43

I tried but there are merge conflicts in file `generic_graph_pyx.pyx` and I don't know how to fix that (I need some help/pointer/training to do that).


---

Comment by vdelecroix created at 2017-08-31 15:32:13

Replying to [comment:17 dcoudert]:
> I tried but there are merge conflicts in file `generic_graph_pyx.pyx` and I don't know how to fix that (I need some help/pointer/training to do that).

For example https://gist.github.com/karenyyng/f19ff75c60f18b4b8149

You can also google "git resolve conflicts" or "git mergetool" and pick the link you prefer.


---

Comment by git created at 2017-08-31 16:17:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dcoudert created at 2017-08-31 16:24:08

Outch... I did a `git add .` before the commit. Sorry for that.
How can I erase that and try again ?


---

Comment by vdelecroix created at 2017-08-31 16:29:25

To cancel the last commit `git reset HEAD^`. Then do what you want. At the time you will update the remote branch on trac with `git push ...` you will have a complain because you changed history. You will have to add the option `-f` (for `force`), i.e. do `git push -f ...`.


---

Comment by vdelecroix created at 2017-08-31 16:29:49

Though if your commit is a merge commit that is not a good idea...


---

Comment by vdelecroix created at 2017-08-31 16:31:40

In the case you want to redo the merge, just start from scratch from `​0a5461d`. In other words, something like

```
$ git checkout -b my_new_merge ​0a5461d
$ git merge develop    # or whatever how this is called
```



---

Comment by dcoudert created at 2017-08-31 16:45:37

It's working !!! I'm currently recompiling / testing. It will be long.

is this correct to push the changes `git push -f trac HEAD:public/18395` ? 

Thank you very much.


---

Comment by vdelecroix created at 2017-08-31 17:23:25

Replying to [comment:24 dcoudert]:
> is this correct to push the changes `git push -f trac HEAD:public/18395` ? 

It is.


---

Comment by git created at 2017-08-31 19:09:51

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by dcoudert created at 2017-08-31 19:16:35

I followed what we said, but when I look at the branch it's really weird. Let me know if I show try again with a different set of commands. Thanks.


---

Comment by dcoudert created at 2017-09-04 15:00:19

Changing status from needs_work to needs_review.


---

Comment by dcoudert created at 2017-09-16 11:33:28

I have created a new branched, on top of 8.1.beta5, containing all previous modifications. This way we get rid of all the mess I made with git. I hope we can now go forward with this ticket.
----
New commits:


---

Comment by tscrim created at 2017-09-17 14:44:00

LGTM except some more nitpick-type things:

```diff
-    Approximation of sqrt(x^2+y^2).
+    Approximation of `\sqrt(x^2 + y^2)`.
 
-    Assuming that x>y>0, it is a taylor expansion at x^2. To see how 'bad' the
-    approximation is::
+    Assuming that `x > y > 0`, it is a Taylor expansion at `x^2`. To see how 'bad' the
+    approximation is:
 
+    .. PLOT::
+
+        def dist(x,y):
+            x = abs(x)
+            y = abs(y)
+            return max(x,y) + min(x,y)**2/(2*max(x,y))
+        sphinx_plot(polar_plot([1, lambda x: dist(cos(x),sin(x))], (0, 2*pi)))
```

(Please check that the plot of the graph is correct.)


---

Comment by git created at 2017-09-17 17:55:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dcoudert created at 2017-09-17 17:58:43

I did the changes in the text (better reading), but not the `PLOT` part since the method is not in the html doc.


---

Comment by tscrim created at 2017-09-17 18:00:08

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2017-09-17 18:00:08

Oh that's right, `cdef` functions are not included. Thanks.


---

Comment by vbraun created at 2017-09-19 07:02:37

Fails on 32-bit, e.g. http://build.sagemath.org/#/builders/36/builds/14


---

Comment by vbraun created at 2017-09-19 07:02:42

Changing status from positive_review to needs_work.


---

Comment by dcoudert created at 2017-09-19 13:18:22

Numerical issues. I don't know how to make the tests robust to such issues. Anyone has a proposal?


---

Comment by mderickx created at 2017-09-19 13:29:32

It is quite easy to fix. One should just modify the doctest to only check for the correct ammount of digits. So one could just remove some digits that change between 32 and 64 bits before the ... in the current doctest. A more elegant solution would be to use the support in sage doctest to tolerate a certain ammount of numerical noise. See the  **tolerance** section of: http://doc.sagemath.org/html/en/developer/coding_basics.html#special-markup-to-influence-doctests


---

Comment by tscrim created at 2017-09-19 14:33:08

There are also flags you can set for doctest outout specifically for 32 bit and 64 bit machines.


---

Comment by mderickx created at 2017-09-19 14:38:49

Ah yes, tscrims solution is better in this case, since my solution would uneccesarily sacrifice precission. How to do this is also documented at the link I send previously


---

Comment by git created at 2017-09-19 15:20:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dcoudert created at 2017-09-19 15:22:00

I used the values from http://build.sagemath.org/#/builders/36/builds/14 for 32-bits machine, since I don't have access to such CPU. I hope it's ok.


---

Comment by dcoudert created at 2017-09-19 15:22:37

Changing status from needs_work to needs_review.


---

Comment by git created at 2017-09-30 12:29:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dcoudert created at 2017-09-30 12:32:19

The patchbot reports incompatibility with python 3. I fixed that.

The patchbot reports an issue with doctest continuation ([here](https://patchbot.sagemath.org/log/18395/Ubuntu/14.04/i686/3.13.0-95-generic/arando/2017-09-29%2019:57:07?plugin=doctest_continuation)) but I don't know what to do with it. Any help is more than welcome.


---

Comment by mderickx created at 2017-09-30 13:12:07

It means you should replace the `...` by `....:`  as explained on http://doc.sagemath.org/html/en/developer/coding_basics.html#writing-testable-examples under the heading multiline doctests.


---

Comment by dcoudert created at 2017-09-30 13:31:23

I'm using `...` for the output, as for other doctests in the same file for which the patchbot is not complaining, and as explained on [http://doc.sagemath.org/html/en/developer/coding_basics.html#special-markup-to-influence-doctests](http://doc.sagemath.org/html/en/developer/coding_basics.html#special-markup-to-influence-doctests). It's not for the code part.

I suspect a conflict with the `# 32-bit` and `# 64-bit` tags.


---

Comment by tscrim created at 2017-09-30 15:39:00

Patchbot plugins can be a little dumb at times. However, it does look like there still is some numerical issues.


---

Comment by dcoudert created at 2017-09-30 16:55:02

I don't know what to do. All tests pass on my 64-bit OSX computer, but since the method uses random initial positions, the result may change from a computer to another.


---

Comment by tscrim created at 2017-09-30 16:59:51

Two options: Raise the tolerance by removing sig-figs from the output or mark them with a `# rel tol` or `# abs tol`. I would suggest the second (unless the doctest framework doesn't like it) as it is more robust (i.e., a difference of `0.01` could change the first decimal place).


---

Comment by git created at 2017-09-30 17:17:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dcoudert created at 2017-09-30 17:18:12

Let's see if it's better this way.


---

Comment by tscrim created at 2017-09-30 18:39:00

Hmm...that doesn't seem to work. Probably due to a mixing of the ellipses and the rel tol. I guess we just have to lower the sigfigs in the output.


---

Comment by git created at 2017-10-01 08:59:57

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dcoudert created at 2017-10-01 09:01:16

I was not using correctly `rel tol`. Also, I have simplified the output.


---

Comment by tscrim created at 2017-10-01 15:11:41

Since you have changed the output format, you should also add a check that the length is 902. Once done, you can set a positive review on my behalf.


---

Comment by git created at 2017-10-01 18:38:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dcoudert created at 2017-10-01 18:41:14

902 is not the length but the largest index of a vertex (`pos` is a dictionary). 
The graph has 50 vertices. I added a test to check that `pos` has 50 entries.

I set the ticket to positive review as you proposed.

Thank you.


---

Comment by dcoudert created at 2017-10-01 18:41:14

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2017-10-04 06:49:23


```
File "src/sage/graphs/generic_graph_pyx.pyx", line 113, in sage.graphs.generic_graph_pyx.spring_layout_fast
Failed example:
    pos[902] # abs tol 0.03
Expected:
    [-0.48..., -0.10...]
Got:
    [-0.48914249502701945, -0.13939583925593196]
Tolerance exceeded in 1 of 2:
    -0.10 vs -0.13939583925593196, tolerance 4e-02 > 3e-02
**********************************************************************
1 item had failures:
   1 of  15 in sage.graphs.generic_graph_pyx.spring_layout_fast
    [94 tests, 1 failure, 2.32 s]
```



---

Comment by vbraun created at 2017-10-04 06:49:23

Changing status from positive_review to needs_work.


---

Comment by dcoudert created at 2017-10-05 14:57:49

I can either increase the tolerance to e.g. 0.1, or remove this test, but I don't know what would be better.


---

Comment by tscrim created at 2017-10-05 15:23:13

Increase the tolerance (or choose another output that is slightly higher if you think the current is on the low side).


---

Comment by git created at 2017-10-05 20:59:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dcoudert created at 2017-10-05 21:00:41

I have changed the tolerance to 0.1. It should be more robust to the various cpus / systems.


---

Comment by dcoudert created at 2017-10-05 21:03:28

Changing status from needs_work to needs_review.


---

Comment by tscrim created at 2017-10-05 21:05:05

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2017-10-15 09:22:26

Resolution: fixed
