# Issue 12951: Move SAGE_DATA to SAGE_LOCAL/share/sage/data

Issue created by migration from https://trac.sagemath.org/ticket/13123

Original creator: ohanar

Original creation time: 2012-06-16 08:53:14

Assignee: tdb

CC:  kini jdemeyer robertwb burcin

This is in preparation for the transition to git. `SAGE_EXTCODE` will be moved to `SAGE_ROOT/devel/ext`


---

Comment by ohanar created at 2012-06-19 04:44:09

Ok, everything should work now.


---

Comment by ohanar created at 2012-06-19 04:44:09

Changing status from new to needs_review.


---

Comment by fbissey created at 2012-06-19 11:07:34

That will cause me a lot of work in sage-on-gentoo but overall that will make my life easier in the long term. I cannot comment on trac13123_extcode.patch and trac13123_scripts.patch as I don't know the code in there all that well. But for the rest:
* I will need to check the spkg individually for correctness but I assume it will be OK it is the easy part.
* trac13123_library.patch : I am spotting something that I should have reported as a bug a long time ago. In sage/interfaces/gap.py GAP_STAMP is created in $SAGE_LOCAL/bin. This is a no-no if sage is installed globally and accessible by many users. That means all users would need to be able to write to $SAGE_LOCAL/bin to use gap from sage. There is no reason why GAP_STAMP has to be stored there. It should be moved to $DOT_SAGE or possibly even $GAP_DIR. There is a similar problem with qepcad but your patch doesn't touch that particular bit.


---

Comment by jdemeyer created at 2012-06-19 11:38:17

Please make it clear in the ticket description which patches have to be applied where.


---

Comment by jdemeyer created at 2012-06-19 11:45:22

You should use `cp -R` instead of `cp -r` (like it was before).

You should deal with upgrading (probably in the new extcode installer): if `SAGE_ROOT/data` exists, then move `SAGE_ROOT/data/extcode` to `SAGE_ROOT/devel/ext-main` and delete the whole directory `SAGE_ROOT/data`.


---

Comment by jdemeyer created at 2012-06-19 11:48:58

Why don't you

```
mkdir -p "$SAGE_DATA"
```

in `spkg/install`?  That's easier than doing it in the various packages.


---

Comment by jdemeyer created at 2012-06-19 11:51:53

Replying to [comment:7 fbissey]:
> * trac13123_library.patch : I am spotting something that I should have reported as a bug a long time ago. In sage/interfaces/gap.py GAP_STAMP is created in $SAGE_LOCAL/bin. This is a no-no if sage is installed globally and accessible by many users. That means all users would need to be able to write to $SAGE_LOCAL/bin to use gap from sage. There is no reason why GAP_STAMP has to be stored there. It should be moved to $DOT_SAGE or possibly even $GAP_DIR. There is a similar problem with qepcad but your patch doesn't touch that particular bit.
See #5155.


---

Comment by ohanar created at 2012-06-19 19:12:20

Replying to [comment:10 jdemeyer]:
> Why don't you
> {{{
> mkdir -p "$SAGE_DATA"
> }}}
> in `spkg/install`?  That's easier than doing it in the various packages.

Maybe easier, but since I was bumping the versions of these spkgs anyways for upgrading purposes, I figured I would have them take care of their own installation, rather than relying upon the build scripts.


---

Comment by ohanar created at 2012-06-19 19:16:49

Replying to [comment:7 fbissey]:
> That will cause me a lot of work in sage-on-gentoo but overall that will make my life easier in the long term.

You should expect to see a number of these types of changes from me over the next few months. It should definitely simply things for you as the environment variables `SAGE_DATA` and `SAGE_EXTCODE` will now be globally respected in Sage.


---

Comment by ohanar created at 2012-06-19 19:25:59

Replying to [comment:9 jdemeyer]:
> You should use `cp -R` instead of `cp -r` (like it was before).
> 
> You should deal with upgrading (probably in the new extcode installer): if `SAGE_ROOT/data` exists, then move `SAGE_ROOT/data/extcode` to `SAGE_ROOT/devel/ext-main` and delete the whole directory `SAGE_ROOT/data`.

Done and done.


---

Comment by fbissey created at 2012-06-19 22:19:14

Should we deal with gap_stamp in this ticket or should I add it to #5155 and try to push its review for 5.1?


---

Comment by ohanar created at 2012-06-19 22:37:39

Replying to [comment:16 fbissey]:
> Should we deal with gap_stamp in this ticket or should I add it to #5155 and try to push its review for 5.1?

Since I'm already touching that line, I may as well do it here. If you do end up finishing #5155 in time for 5.1, I'll have to rebase anyway :). (This is under the assumption that this ticket doesn't make it into 5.1, which I feel like is a pretty safe assumption.)


---

Comment by fbissey created at 2012-06-19 22:49:36

Thanks. Yes considering that Jeroen wants beta5 to be the last beta before rc our target for both tickets becomes 5.2. I think gap_stamp should go in DOT_SAGE, GAP_DIR seems to be reserved for some gap workspace and it may unwise to put it in there.


---

Comment by ohanar created at 2012-06-19 22:57:47

Actually `GAP_DIR/workspace-*/` are the gap workspaces, so it should be fine to place in `GAP_DIR`.


---

Comment by fbissey created at 2012-06-19 23:05:44

You are right, I missed a line or two in the original file. Looks good to me.


---

Comment by fbissey created at 2012-06-28 22:58:25

Question, why do we sometimes get the SAGE_* variables from os.environ and sometimes from sage.misc.misc? Should we try to be uniform and do it one way only?


---

Comment by ohanar created at 2012-06-29 05:55:11

Replying to [comment:21 fbissey]:
> Question, why do we sometimes get the SAGE_* variables from os.environ and sometimes from sage.misc.misc? Should we try to be uniform and do it one way only?

I would have it imported from `sage.misc.misc` (well actually I would move it to `sage.misc.env`, but that currently doesn't exist). I think that I only left one instance of `os.environ` between `SAGE_DATA` and `SAGE_EXTCODE` with this patch (I haven't touched the other `SAGE_*` with this patch).


---

Comment by ohanar created at 2012-06-30 20:42:59

FYI, looking at the code there might be an issue with using a `GAP_STAMP` shared by multiple copies of Sage (I'm not positive, I don't really know the code). For right now I'm using the `SAGE_EXTCODE` directory as the `GAP_STAMP`.


---

Comment by fbissey created at 2012-07-01 22:20:39

Replying to [comment:23 ohanar]:
> FYI, looking at the code there might be an issue with using a `GAP_STAMP` shared by multiple copies of Sage (I'm not positive, I don't really know the code). For right now I'm using the `SAGE_EXTCODE` directory as the `GAP_STAMP`.

Putting it in SAGE_EXTCODE is about as bad as putting it in SAGE_LOCAL/bin as it was initially. If you are concerned about multiple sage session running in parallel that's would still be a problem wherever you put it. I am not sure how the file is used but we don't remove it or anything. The real question is: is it actively used by gap? If gap just check for it's presence then it is OK. If it is used then it may have to be unique for each sage session and be cleaned on exit.


---

Comment by ohanar created at 2012-07-02 04:24:37

Replying to [comment:24 fbissey]:
> Putting it in SAGE_EXTCODE is about as bad as putting it in SAGE_LOCAL/bin as it was initially.
Not really, since it removes yet another instance of sage trying to write to someplace it shouldn't be at runtime.

The purpose of `GAP_STAMP` seems to be a check on whether it needs to refresh the workspaces. Really, this will all become a moot point if/when libgap is finished.


---

Comment by fbissey created at 2012-07-02 04:43:06

As far as I am concerned SAGE_EXTCODE is a place sage shouldn't write at runtime. On a system wide installation that would be a folder that a user is not supposed to own. If a sys-admin install sage under /usr/local/sage-xxx for example, it would resolve to /usr/local/sage-xxx/local/share/sage/ext and as a sys-admin I object that my users have to write something there. Their home folder, tmp and any scratch space set for them is where it should go.

That's my perspective.


---

Comment by ohanar created at 2012-07-02 05:11:34

Replying to [comment:26 fbissey]:
> As far as I am concerned SAGE_EXTCODE is a place sage shouldn't write at runtime.
I don't write to `SAGE_EXTCODE`, I just use its creation for the timestamp that gap wants. It used to be that when you first started sage, it would touch `SAGE_LOCAL/bin/gap_stamp` and then use the timestamp of that.

I agree, nothing should try to write to `SAGE_LOCAL` or its subdirectories in the long run.


---

Comment by fbissey created at 2012-07-03 02:29:49

OK. If we just want a GAP_STAMP file for everyone and in SAGE_EXTCODE it should really be created by the extcode spkg. Is it a file we really need?


---

Comment by ohanar created at 2012-09-09 23:18:42

`@`fbissey

Do you think you are capable of finishing your review of this? (No pressure, just want to know if you can, so that I can find someone else to review it if you aren't able to.)


---

Comment by fbissey created at 2012-09-10 08:46:28

Yes, I will hopefully tomorrow. I was a bit down today - but this is important and we should move this.


---

Comment by jdemeyer created at 2012-09-10 08:52:38

Why `local/share/sage/data` and not `local/share/sage` or even `local/share`?


---

Comment by jdemeyer created at 2012-09-10 08:57:10

I would argue for `local/share` because the stuff in `SAGE_DATA` (apart from extcode) isn't part of Sage.  It's part of external packages/databases.  So I think it's wrong to use a `sage` subdirectory.

Installing databases in `local/share/sage/data` is like installing all binaries in `local/bin/sage/binaries` and we don't do that either.

For extcode, `local/share/sage` makes sense.


---

Comment by jdemeyer created at 2012-09-10 09:10:48

As far as I can tell, this ticket will break upgrading because an upgraded Sage will still have the `SAGE_ROOT/data` directory.  This could be simply ignored and therefore harmless, but then it needs to be kept inside `.hgignore`.  Alternatively, you could move `SAGE_ROOT/data` or even delete it.

Also, the database packages should depend on `SAGE_ROOT_REPO`, otherwise they won't see the new `sage-env` when upgrading.


---

Comment by fbissey created at 2012-09-10 09:18:06

I can agree with the SAGE_DATA location argument of Jeroen. The only argument against is that for most of them sage is the only application I can think of that make use of it. The splitting of the data is purely a convenience because it ease maintenance. In that case local/share/sage would be most appropriate.


---

Comment by ohanar created at 2012-09-10 21:18:56

Sure, my main thing is just removing SAGE_ROOT/data and moving the databases that were there to some place in SAGE_LOCAL.


---

Comment by jdemeyer created at 2012-09-11 06:30:49

Changing status from needs_review to needs_work.


---

Attachment

for review purposes


---

Attachment

for review purpose


---

Comment by ohanar created at 2012-09-11 07:55:22

for review purposes


---

Attachment

for review purposes


---

Comment by ohanar created at 2012-09-11 08:02:09

Changing status from needs_work to needs_review.


---

Attachment

Ok, moved everything to `SAGE_LOCAL/share` (added `SAGE_SHARE` for convenience), and removed the `SAGE_DATA` environment variable.

I also added a bit to `SAGE_ROOT/spkg/install` to handle upgrading.


---

Comment by jdemeyer created at 2012-09-11 09:13:19

Some optional/experimental packages use `SAGE_DATA`:
 1. cunningham_tables-1.0
 1. p_group_cohomology-2.1.2
 1. database_stein_watkins_mini.p0
 1. sage-mode-0.7
 1. database_cremona_ellcurve-20120827
 1. database_sloane_oeis-2005-12
 1. database_jones_numfield-v4
 1. soya-0.11.2.p0

Some optional packages use `$SAGE_ROOT/data':
 1. database_odlyzko_zeta
 1. database_symbolic_data-20070206
 1. database_kohel-20060803

For these reasons, I would keep `SAGE_DATA` as synonym of `SAGE_SHARE` and also make a symlink

```
$SAGE_ROOT/data -> local/share
```



---

Comment by fbissey created at 2012-09-11 10:26:38

Keeping SAGE_DATA for a little while as a symlink definitely sound like a good idea. I don't remember  explain_picklejar to be removed in trac13123_library.patch before nor do I understand the rational for the removal. Care to shade some light on that?


---

Comment by jdemeyer created at 2012-09-11 10:33:46

In the extcode patch, this comment is clearly wrong:

```
cp -pR * "$SAGE_ROOT/devel/ext-main/" # Creates new sagenb-main dir
```



---

Comment by jdemeyer created at 2012-09-11 10:37:56

Why change the logic in `sage/databases/cremona.py`?


---

Comment by jdemeyer created at 2012-09-11 15:30:45

In extcode `spkg-install`, why do

```
if [ -d .hg ]
```


You _know_ that `.hg` exists (if not, that would be a bug).


---

Comment by jdemeyer created at 2012-09-11 15:32:42

`spkg/install`: indentation should be 4 spaces.


---

Comment by ohanar created at 2012-09-11 20:08:16

I changed the logic in `sage.databases.cremona` since I wrote it, and it when replacing everything, it annoyed me that it wasn't factored appropriately.

I'll see about fixing the extcode `spkg-install` (most of the code there comes from a recent version of the sagenb `spkg-install`) and`spkg/install`, as well as adding a symlink for `SAGE_DATA`.


---

Comment by ohanar created at 2012-09-11 20:08:16

Changing status from needs_review to needs_work.


---

Comment by ohanar created at 2012-09-11 20:26:45

apply to extcode repo


---

Attachment

apply to scripts repo


---

Comment by ohanar created at 2012-09-11 20:30:42

Changing status from needs_work to needs_review.


---

Comment by ohanar created at 2012-09-11 20:30:42

I also fixed the commit message for the patches for the sage repos (I had already fixed the commit messages for the spkgs).


---

Comment by jdemeyer created at 2012-09-12 08:09:15

I would really prefer to separate the refactoring of the Cremona database code from this ticket (and then have either this ticket depend on that or the other way around).


---

Comment by jdemeyer created at 2012-09-12 08:52:50

`sage/interfaces/gap.py`: why change `hash(SAGE_ROOT)` to `hash(SAGE_LOCAL)`?  I don't understand why you made that change, nor the implications of that change.


---

Comment by jdemeyer created at 2012-09-12 09:03:48

Based on purely reading the patches: *positive review* modulo my reviewer patches and the Cremona and GAP changes that I mentioned.

In any case, this still needs massive amounts of testing.


---

Comment by fbissey created at 2012-09-12 09:16:13

Sorry but I still don't understand the changes in sage/misc/explain_pickle.py and how they are related to the rest of the ticket. It may just be due to a lack of understanding on my part on the working of the pickle jar but the change seems unrelated to the rest of the ticket. Could someone offer me an explanation?


---

Comment by jdemeyer created at 2012-09-12 14:46:17

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2012-09-12 20:07:53

Changing status from needs_work to needs_review.


---

Attachment


---

Comment by jdemeyer created at 2012-09-12 21:04:22

This should be fixed:

```
sage -t --optional --long "devel/sage/sage/databases/symbolic_data.py"
**********************************************************************
File "/release/sage-5.4.beta2-try13123/devel/sage/sage/databases/symbolic_data.py", line 37:
    sage: sd = SymbolicData(); sd # optional - database_symbolic_data
Exception raised:
    Traceback (most recent call last):
      File "/release/sage-5.4.beta2-try13123/local/bin/ncadoctest.py", line 1231, in run_one_test
        self.run_one_example(test, example, filename, compileflags)
      File "/release/sage-5.4.beta2-try13123/local/bin/sagedoctest.py", line 38, in run_one_example
        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)
      File "/release/sage-5.4.beta2-try13123/local/bin/ncadoctest.py", line 1172, in run_one_example
        compileflags, 1) in test.globs
      File "<doctest __main__.example_0[2]>", line 1, in <module>
        sd = SymbolicData(); sd # optional - database_symbolic_data###line 37:
    sage: sd = SymbolicData(); sd # optional - database_symbolic_data
      File "/release/sage-5.4.beta2-try13123/local/lib/python/site-packages/sage/databases/symbolic_data.py", line 78, in __init__
        path=os.path.join(sage.misc.misc.SAGE_SHARE, 'symbolic_data')
    NameError: global name 'sage' is not defined
**********************************************************************
```



---

Comment by jdemeyer created at 2012-09-12 21:04:22

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2012-09-12 21:10:47

Also, I can't get the `sloane_database` optional doctests to work in `sage/databases/sloane.py`, but I don't think it's because of this ticket.


---

Comment by ohanar created at 2012-09-12 21:28:47

apply to sage library


---

Comment by ohanar created at 2012-09-12 21:33:17

Changing status from needs_work to needs_review.


---

Attachment

`@`fbissey

Because the commented out code references `SAGE_DATA/extcode` and hasn't been used in a long long time (see #6233).

Ok, updated. Changes:

 * Removed refactoring of `sage.databases.cremona`
 * Reverted change of `SAGE_ROOT -> SAGE_LOCAL` in `sage.interfaces.gap` (better done in #13432)
 * fixed `sage.databases.symbolic_data`


---

Comment by jdemeyer created at 2012-09-13 06:27:11

`sage --bdist` doesn't copy `devel/ext`, leading to non-working binary builds.


---

Comment by jdemeyer created at 2012-09-13 06:27:11

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2012-09-13 06:47:14

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2012-09-13 09:06:41

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2012-09-13 11:51:52

Changing status from needs_work to needs_review.


---

Attachment


---

Comment by jdemeyer created at 2012-09-16 17:28:45

Tested building from scratch, sdist, bdist, works fine.  Positive review to everything not authored by me.

I agree with the deleting of the commented-out code in `sage/misc/explain_pickle.py`.  If people really want to do something with that code, it's still in the Mercurial history.

My reviewer patches still need review.


---

Comment by ohanar created at 2012-09-16 20:57:56

Changing status from needs_review to needs_work.


---

Comment by ohanar created at 2012-09-16 20:57:56

Mercurial should no longer be marked as a dependency for the extcode spkg (it is no longer used in the spkg-install).


---

Attachment


---

Comment by jdemeyer created at 2012-09-16 21:46:26

Changing status from needs_work to needs_review.


---

Comment by fbissey created at 2012-09-17 00:56:24

Looks all clear to me. I didn't really notice that the explain_pickle code was commented out last week, probably because of other stuff going on locally. But still happy that this is related to the rest of the ticket and not a freebie done at the same time.

As far as I can see it is ready to go.


---

Comment by fbissey created at 2012-09-17 00:56:24

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2012-09-18 06:41:19

Resolution: fixed


---

Comment by jdemeyer created at 2012-09-19 06:38:01

apply to root repo


---

Attachment

Rebased [attachment:trac13123_root.patch] because of fuzz.


---

Comment by jdemeyer created at 2013-01-17 11:43:58

Why was `GAP_STAMP` changed from

```
GAP_STAMP = '%s/local/bin/gap_stamp'%SAGE_ROOT
```

to

```
GAP_STAMP = SAGE_EXTCODE
```


This seems a mistake and might be the cause of #13963.
