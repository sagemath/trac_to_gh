# Issue 27255: Bug in parallelized computations involving symbolic functions

archive/issues_027255.json:
```json
{
    "body": "CC:  @man74cio @rwst @mkoeppe @tscrim\n\nKeywords: parallelization, symbolic functions\n\nAs reported in this [sage-devel post](https://groups.google.com/forum/#!topic/sage-devel/k4W5eo4nQ50), Sage fails silently on some parallelized computations involving symbolic functions. A minimal example with \nSage 8.7.beta7 (**python2** version) is\n\n```\nsage: Parallelism().set(nproc=2)\nsage: M = Manifold(2, 'M')\nsage: X.<x,y> = M.chart()\nsage: a = function('f')(x)\nsage: t = M.tensor_field(0, 2)\nsage: t[0,0], t[0,1], t[1,1] = a, x+y, x-y\nsage: v = M.vector_field()\nsage: v[0], v[1] = 1 + x*y, -x^2\nsage: s = t.contract(v)  # parallelized computation occurs here\nsage: s0 = s[0].expr(); s0  # symbolic expression OK\n-x^3 - (x^2 - x*f(x))*y + f(x)\nsage: s0.coefficient(a, 1)  # incorrect output\n0\n```\nThe correct result should be `x*y + 1`. The latter is obtained if one sets `nproc=1` in the first line (i.e. no parallelization). Furthermore, if one replaces the line\n\n```\nsage: a = function('f')(x)\n```\nby \n\n```\nsage: a = sin(x)\n```\none gets a correct result as well.\n\nWith the **python3** version of Sage 8.7.beta7, one does not get a silent failure but an error message when the parallel computation is performed, i.e. at the line `s = t.contract(v)`: \n\n```\nTypeError                                 Traceback (most recent call last)\n/home/eric/sage/py3/local/lib/python3.6/site-packages/sage/symbolic/function_factory.py in function_factory(name, nargs, latex_name, conversions, evalf_params_first, eval_func, evalf_func, conjugate_func, real_part_func, imag_part_func, derivative_func, tderivative_func, power_func, series_func, print_func, print_latex_func)\n    109             setattr(NewSymbolicFunction, '_%s_'%func_name, func)\n    110 \n--> 111     return NewSymbolicFunction()\n    112 \n    113 \n...\nTypeError: expected str, bytes found\n```\nThe full error message is attached.\n\nIssue created by migration from https://trac.sagemath.org/ticket/27492\n\n",
    "created_at": "2019-03-15T13:21:59Z",
    "labels": [
        "component: symbolics",
        "bug"
    ],
    "title": "Bug in parallelized computations involving symbolic functions",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/27255",
    "user": "https://github.com/egourgoulhon"
}
```
CC:  @man74cio @rwst @mkoeppe @tscrim

Keywords: parallelization, symbolic functions

As reported in this [sage-devel post](https://groups.google.com/forum/#!topic/sage-devel/k4W5eo4nQ50), Sage fails silently on some parallelized computations involving symbolic functions. A minimal example with 
Sage 8.7.beta7 (**python2** version) is

```
sage: Parallelism().set(nproc=2)
sage: M = Manifold(2, 'M')
sage: X.<x,y> = M.chart()
sage: a = function('f')(x)
sage: t = M.tensor_field(0, 2)
sage: t[0,0], t[0,1], t[1,1] = a, x+y, x-y
sage: v = M.vector_field()
sage: v[0], v[1] = 1 + x*y, -x^2
sage: s = t.contract(v)  # parallelized computation occurs here
sage: s0 = s[0].expr(); s0  # symbolic expression OK
-x^3 - (x^2 - x*f(x))*y + f(x)
sage: s0.coefficient(a, 1)  # incorrect output
0
```
The correct result should be `x*y + 1`. The latter is obtained if one sets `nproc=1` in the first line (i.e. no parallelization). Furthermore, if one replaces the line

```
sage: a = function('f')(x)
```
by 

```
sage: a = sin(x)
```
one gets a correct result as well.

With the **python3** version of Sage 8.7.beta7, one does not get a silent failure but an error message when the parallel computation is performed, i.e. at the line `s = t.contract(v)`: 

```
TypeError                                 Traceback (most recent call last)
/home/eric/sage/py3/local/lib/python3.6/site-packages/sage/symbolic/function_factory.py in function_factory(name, nargs, latex_name, conversions, evalf_params_first, eval_func, evalf_func, conjugate_func, real_part_func, imag_part_func, derivative_func, tderivative_func, power_func, series_func, print_func, print_latex_func)
    109             setattr(NewSymbolicFunction, '_%s_'%func_name, func)
    110 
--> 111     return NewSymbolicFunction()
    112 
    113 
...
TypeError: expected str, bytes found
```
The full error message is attached.

Issue created by migration from https://trac.sagemath.org/ticket/27492





---

archive/issue_comments_383644.json:
```json
{
    "body": "Attachment [error_message_py3.txt](tarball://root/attachments/some-uuid/ticket27492/error_message_py3.txt) by @egourgoulhon created at 2019-03-15 13:27:25",
    "created_at": "2019-03-15T13:27:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27255",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27255#issuecomment-383644",
    "user": "https://github.com/egourgoulhon"
}
```

Attachment [error_message_py3.txt](tarball://root/attachments/some-uuid/ticket27492/error_message_py3.txt) by @egourgoulhon created at 2019-03-15 13:27:25



---

archive/issue_comments_383645.json:
```json
{
    "body": "Ticket retargeted after milestone closed (if you don't believe this ticket is appropriate for the Sage 8.8 release please retarget manually)",
    "created_at": "2019-03-25T10:56:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27255",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27255#issuecomment-383645",
    "user": "https://github.com/embray"
}
```

Ticket retargeted after milestone closed (if you don't believe this ticket is appropriate for the Sage 8.8 release please retarget manually)



---

archive/issue_events_068261.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-03-25T10:56:15Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/27255",
    "milestone": "sage-8.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27255#event-68261"
}
```



---

archive/issue_events_068262.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-06-14T14:55:02Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/27255",
    "milestone": "sage-8.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27255#event-68262"
}
```



---

archive/issue_comments_383646.json:
```json
{
    "body": "As the Sage-8.8 release milestone is pending, we should delete the sage-8.8 milestone for tickets that are not actively being worked on or that still require significant work to move forward.  If you feel that this ticket should be included in the next Sage release at the soonest please set its milestone to the next release milestone (sage-8.9).",
    "created_at": "2019-06-14T14:55:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27255",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27255#issuecomment-383646",
    "user": "https://github.com/embray"
}
```

As the Sage-8.8 release milestone is pending, we should delete the sage-8.8 milestone for tickets that are not actively being worked on or that still require significant work to move forward.  If you feel that this ticket should be included in the next Sage release at the soonest please set its milestone to the next release milestone (sage-8.9).



---

archive/issue_comments_383647.json:
```json
{
    "body": "To help you along with this: it's probably a matter that the existence of the symbolic function 'f' isn't properly coordinated across the inter-process communication, so that a new symbolic function, also called 'f' is created at some point:\n\n```\nsage: a_new=s0.operands()[2]\nsage: a\nf(x)\nsage: a_new\nf(x)\nsage: a - a\n0\nsage: a - a_new #this indicates something fishy\n-f(x) + f(x)\nsage: bool( a==a_new)\nTrue\nsage: s0.subs({a_new: a})\n-x^3 - (x^2 - x*f(x))*y + f(x)\nsage: s0.subs({a_new: a}).coefficient(a,1)\nx*y + 1\n```\nIf may pickling that's (part of) the problem:\n\n```\nsage: function('f')(x)-function('f')(x)\n0\nsage: function('f')(x)-SR('f(x)')\n0\nsage: loads(dumps(SR('f(x)')))-SR('f(x)')\n0\nsage: function('f')(x)-SR('f(x)')\nf(x) - f(x)\nsage: loads(dumps(function('f')(x)))-function('f')(x)\n-f(x) + f(x)\nsage: loads(dumps(function('f')(x)))-SR('f(x)')\n0\n```\nas you can see, the different ways of creating a symbolic function start out as giving the same result. However, as soon as pickling has been involved, something changes, and results are not compatible any more. from that point onwards, `SR('f(x)')` seems to produce results consistent with pickling, but `function('f')(x)` is reliably not compatible (and in fact, further investigation shows that `function('f')(x)` across different invocations of pickle returns unidentical results. So there's some naste cache wiping/corruption going on somewhere.\n\nYou can see part of it here:\n\n```\nsage: explain_pickle(dumps(function('f')(x)))\npg_Expression = unpickle_global('sage.symbolic.expression', 'Expression')\nsi = unpickle_newobj(pg_Expression, ())\nunpickle_build(si, (0r, ['x'], 'GARC\\x03\\tfunction\\x00class\\x00symbol\\x00x\\x00name\\x00seq\\x00python\\x00f\\x00sage_ex\\x00\\x01\\x08\\x01\\x02\\x02\\n\\x02\"\\x03\\x04\\n\\x00+\\x001\\x00\"\\x07'))\nsi\n```\nAs you can see, there's a rather opague string involved. The `unpickle_build` is part of the getstate/setstate protocol, and reading `sage.symbolic.expression.Expression.__setstate__` and `sage.symbolic.expression.Expression.__getstate__` shows you that a Pynac archive is involved. It's not hard to imagine the coordination problems that can arise when using such low-level tools. This needs a pynac expert. See https://github.com/pynac/pynac/issues/349 (if github is preferred for tracking pynac)",
    "created_at": "2019-10-27T18:54:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27255",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27255#issuecomment-383647",
    "user": "https://github.com/nbruin"
}
```

To help you along with this: it's probably a matter that the existence of the symbolic function 'f' isn't properly coordinated across the inter-process communication, so that a new symbolic function, also called 'f' is created at some point:

```
sage: a_new=s0.operands()[2]
sage: a
f(x)
sage: a_new
f(x)
sage: a - a
0
sage: a - a_new #this indicates something fishy
-f(x) + f(x)
sage: bool( a==a_new)
True
sage: s0.subs({a_new: a})
-x^3 - (x^2 - x*f(x))*y + f(x)
sage: s0.subs({a_new: a}).coefficient(a,1)
x*y + 1
```
If may pickling that's (part of) the problem:

```
sage: function('f')(x)-function('f')(x)
0
sage: function('f')(x)-SR('f(x)')
0
sage: loads(dumps(SR('f(x)')))-SR('f(x)')
0
sage: function('f')(x)-SR('f(x)')
f(x) - f(x)
sage: loads(dumps(function('f')(x)))-function('f')(x)
-f(x) + f(x)
sage: loads(dumps(function('f')(x)))-SR('f(x)')
0
```
as you can see, the different ways of creating a symbolic function start out as giving the same result. However, as soon as pickling has been involved, something changes, and results are not compatible any more. from that point onwards, `SR('f(x)')` seems to produce results consistent with pickling, but `function('f')(x)` is reliably not compatible (and in fact, further investigation shows that `function('f')(x)` across different invocations of pickle returns unidentical results. So there's some naste cache wiping/corruption going on somewhere.

You can see part of it here:

```
sage: explain_pickle(dumps(function('f')(x)))
pg_Expression = unpickle_global('sage.symbolic.expression', 'Expression')
si = unpickle_newobj(pg_Expression, ())
unpickle_build(si, (0r, ['x'], 'GARC\x03\tfunction\x00class\x00symbol\x00x\x00name\x00seq\x00python\x00f\x00sage_ex\x00\x01\x08\x01\x02\x02\n\x02"\x03\x04\n\x00+\x001\x00"\x07'))
si
```
As you can see, there's a rather opague string involved. The `unpickle_build` is part of the getstate/setstate protocol, and reading `sage.symbolic.expression.Expression.__setstate__` and `sage.symbolic.expression.Expression.__getstate__` shows you that a Pynac archive is involved. It's not hard to imagine the coordination problems that can arise when using such low-level tools. This needs a pynac expert. See https://github.com/pynac/pynac/issues/349 (if github is preferred for tracking pynac)



---

archive/issue_comments_383648.json:
```json
{
    "body": "Since false results are produced, it seems to be a severe bug. On this, I'd suggest either to solve it for milestone 9 or at least to disable the feature or give it a warning in the documentation until a solution is found.",
    "created_at": "2019-11-21T12:28:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27255",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27255#issuecomment-383648",
    "user": "https://github.com/DeRhamSource"
}
```

Since false results are produced, it seems to be a severe bug. On this, I'd suggest either to solve it for milestone 9 or at least to disable the feature or give it a warning in the documentation until a solution is found.



---

archive/issue_comments_383649.json:
```json
{
    "body": "Replying to [comment:7 gh-DeRhamSource]:\n> Since false results are produced, it seems to be a severe bug. On this, I'd suggest either to solve it for milestone 9 or at least to disable the feature or give it a warning in the documentation until a solution is found.\n\nFortunately, with Python 3 (and hence Sage 9.0), there is no longer any silent error: a `TypeError` exception is raised instead. So there is no need to disable a feature (parallelization) that is massively used in tensor calculus on manifolds (see e.g. many of [these examples](https://sagemanifolds.obspm.fr/examples.html)).",
    "created_at": "2019-11-21T13:02:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27255",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27255#issuecomment-383649",
    "user": "https://github.com/egourgoulhon"
}
```

Replying to [comment:7 gh-DeRhamSource]:
> Since false results are produced, it seems to be a severe bug. On this, I'd suggest either to solve it for milestone 9 or at least to disable the feature or give it a warning in the documentation until a solution is found.

Fortunately, with Python 3 (and hence Sage 9.0), there is no longer any silent error: a `TypeError` exception is raised instead. So there is no need to disable a feature (parallelization) that is massively used in tensor calculus on manifolds (see e.g. many of [these examples](https://sagemanifolds.obspm.fr/examples.html)).



---

archive/issue_comments_383650.json:
```json
{
    "body": "Ah I see. And in conclusion, python2 will not even be supported anymore?\n\nSorry for interfering then. :)",
    "created_at": "2019-11-21T13:50:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27255",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27255#issuecomment-383650",
    "user": "https://github.com/DeRhamSource"
}
```

Ah I see. And in conclusion, python2 will not even be supported anymore?

Sorry for interfering then. :)



---

archive/issue_comments_383651.json:
```json
{
    "body": "Replying to [comment:9 gh-DeRhamSource]:\n> Ah I see. And in conclusion, python2 will not even be supported anymore?\n> \n\n\nPython 2 is almost dead: https://pythonclock.org/",
    "created_at": "2019-11-21T15:55:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27255",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27255#issuecomment-383651",
    "user": "https://github.com/egourgoulhon"
}
```

Replying to [comment:9 gh-DeRhamSource]:
> Ah I see. And in conclusion, python2 will not even be supported anymore?
> 


Python 2 is almost dead: https://pythonclock.org/



---

archive/issue_comments_383652.json:
```json
{
    "body": "What about this ticket?",
    "created_at": "2020-08-01T13:06:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27255",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27255#issuecomment-383652",
    "user": "https://github.com/mkoeppe"
}
```

What about this ticket?



---

archive/issue_comments_383653.json:
```json
{
    "body": "This bug is really annoying in terms of applications. You need parallelization to speed things up, especially in this case. I thought maybe you have some ideas to contribute. If not, my apologies.",
    "created_at": "2020-08-01T13:09:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27255",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27255#issuecomment-383653",
    "user": "https://github.com/mjungmath"
}
```

This bug is really annoying in terms of applications. You need parallelization to speed things up, especially in this case. I thought maybe you have some ideas to contribute. If not, my apologies.



---

archive/issue_comments_383654.json:
```json
{
    "body": "Could you try to update & clarify the ticket description please? It's OK to delete everything related to python2. We no longer support it.",
    "created_at": "2020-08-01T15:28:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27255",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27255#issuecomment-383654",
    "user": "https://github.com/mkoeppe"
}
```

Could you try to update & clarify the ticket description please? It's OK to delete everything related to python2. We no longer support it.



---

archive/issue_comments_383655.json:
```json
{
    "body": "Attachment [error_message_Sage_9.2.beta6.txt](tarball://root/attachments/some-uuid/ticket27492/error_message_Sage_9.2.beta6.txt) by @egourgoulhon created at 2020-08-01 21:01:37",
    "created_at": "2020-08-01T21:01:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27255",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27255#issuecomment-383655",
    "user": "https://github.com/egourgoulhon"
}
```

Attachment [error_message_Sage_9.2.beta6.txt](tarball://root/attachments/some-uuid/ticket27492/error_message_Sage_9.2.beta6.txt) by @egourgoulhon created at 2020-08-01 21:01:37



---

archive/issue_comments_383656.json:
```json
{
    "body": "Well, there are lots of libraries involved in symbolics, so lots of questions.\n\nI guess the first question to ask is whether the parallelization that you use involves several threads in one process, or several processes.\n\nThe reported error comes from Maxima, which runs in ECL. Is ECL prepared and configured for threadsafe operation? Are the parts of Maxima that the symbolics code uses threadsafe? (The assumptions code that I touched in #30074 is definitely not threadsafe.)",
    "created_at": "2020-08-04T19:57:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27255",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27255#issuecomment-383656",
    "user": "https://github.com/mkoeppe"
}
```

Well, there are lots of libraries involved in symbolics, so lots of questions.

I guess the first question to ask is whether the parallelization that you use involves several threads in one process, or several processes.

The reported error comes from Maxima, which runs in ECL. Is ECL prepared and configured for threadsafe operation? Are the parts of Maxima that the symbolics code uses threadsafe? (The assumptions code that I touched in #30074 is definitely not threadsafe.)



---

archive/issue_comments_383657.json:
```json
{
    "body": "See #31047 for a related issue.",
    "created_at": "2020-12-16T10:08:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27255",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27255#issuecomment-383657",
    "user": "https://github.com/egourgoulhon"
}
```

See #31047 for a related issue.



---

archive/issue_comments_383658.json:
```json
{
    "body": "Replying to [comment:15 mkoeppe]:\n> Could you try to update & clarify the ticket description please? It's OK to delete everything related to python2. We no longer support it.\n\n\nDone.",
    "created_at": "2020-12-16T10:15:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27255",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27255#issuecomment-383658",
    "user": "https://github.com/egourgoulhon"
}
```

Replying to [comment:15 mkoeppe]:
> Could you try to update & clarify the ticket description please? It's OK to delete everything related to python2. We no longer support it.


Done.



---

archive/issue_comments_383659.json:
```json
{
    "body": "Replying to [comment:17 mkoeppe]:\n> Well, there are lots of libraries involved in symbolics, so lots of questions.\n> \n> I guess the first question to ask is whether the parallelization that you use involves several threads in one process, or several processes.\n\n\nThe parallelization is based on the Python module [multiprocessing](https://docs.python.org/3/library/multiprocessing.html), so it involves several processes. \n> \n> The reported error comes from Maxima, which runs in ECL. Is ECL prepared and configured for threadsafe operation? Are the parts of Maxima that the symbolics code uses threadsafe? (The assumptions code that I touched in #30074 is definitely not threadsafe.)\n\n\nThere is no error when the involved symbolic expressions do not contain any symbolic function, so I would say that is not an issue with Maxima and parallelization, but rather an issue with Sage's symbolic functions (cf. comment:4 and #31047).",
    "created_at": "2020-12-16T10:24:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27255",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27255#issuecomment-383659",
    "user": "https://github.com/egourgoulhon"
}
```

Replying to [comment:17 mkoeppe]:
> Well, there are lots of libraries involved in symbolics, so lots of questions.
> 
> I guess the first question to ask is whether the parallelization that you use involves several threads in one process, or several processes.


The parallelization is based on the Python module [multiprocessing](https://docs.python.org/3/library/multiprocessing.html), so it involves several processes. 
> 
> The reported error comes from Maxima, which runs in ECL. Is ECL prepared and configured for threadsafe operation? Are the parts of Maxima that the symbolics code uses threadsafe? (The assumptions code that I touched in #30074 is definitely not threadsafe.)


There is no error when the involved symbolic expressions do not contain any symbolic function, so I would say that is not an issue with Maxima and parallelization, but rather an issue with Sage's symbolic functions (cf. comment:4 and #31047).



---

archive/issue_comments_383660.json:
```json
{
    "body": "Attachment [error_message_Sage_9.3.beta6.txt](tarball://root/attachments/some-uuid/ticket27492/error_message_Sage_9.3.beta6.txt) by @egourgoulhon created at 2021-01-18 09:59:30",
    "created_at": "2021-01-18T09:59:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27255",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27255#issuecomment-383660",
    "user": "https://github.com/egourgoulhon"
}
```

Attachment [error_message_Sage_9.3.beta6.txt](tarball://root/attachments/some-uuid/ticket27492/error_message_Sage_9.3.beta6.txt) by @egourgoulhon created at 2021-01-18 09:59:30
