# Issue 27255: Bug in parallelized computations involving symbolic functions

Issue created by migration from https://trac.sagemath.org/ticket/27492

Original creator: egourgoulhon

Original creation time: 2019-03-15 13:21:59

CC:  mmancini rws mkoeppe tscrim

Keywords: parallelization, symbolic functions

As reported in this [sage-devel post](https://groups.google.com/forum/#!topic/sage-devel/k4W5eo4nQ50), Sage fails silently on some parallelized computations involving symbolic functions. A minimal example with 
Sage 8.7.beta7 (**python2** version) is

```
sage: Parallelism().set(nproc=2)
sage: M = Manifold(2, 'M')
sage: X.<x,y> = M.chart()
sage: a = function('f')(x)
sage: t = M.tensor_field(0, 2)
sage: t[0,0], t[0,1], t[1,1] = a, x+y, x-y
sage: v = M.vector_field()
sage: v[0], v[1] = 1 + x*y, -x^2
sage: s = t.contract(v)  # parallelized computation occurs here
sage: s0 = s[0].expr(); s0  # symbolic expression OK
-x^3 - (x^2 - x*f(x))*y + f(x)
sage: s0.coefficient(a, 1)  # incorrect output
0
```

The correct result should be `x*y + 1`. The latter is obtained if one sets `nproc=1` in the first line (i.e. no parallelization). Furthermore, if one replaces the line

```
sage: a = function('f')(x)
```

by 

```
sage: a = sin(x)
```

one gets a correct result as well.

With the **python3** version of Sage 8.7.beta7, one does not get a silent failure but an error message when the parallel computation is performed, i.e. at the line `s = t.contract(v)`: 

```
TypeError                                 Traceback (most recent call last)
/home/eric/sage/py3/local/lib/python3.6/site-packages/sage/symbolic/function_factory.py in function_factory(name, nargs, latex_name, conversions, evalf_params_first, eval_func, evalf_func, conjugate_func, real_part_func, imag_part_func, derivative_func, tderivative_func, power_func, series_func, print_func, print_latex_func)
    109             setattr(NewSymbolicFunction, '_%s_'%func_name, func)
    110 
--> 111     return NewSymbolicFunction()
    112 
    113 
...
TypeError: expected str, bytes found
```

The full error message is attached.


---

Attachment


---

Comment by embray created at 2019-03-25 10:56:15

Ticket retargeted after milestone closed (if you don't believe this ticket is appropriate for the Sage 8.8 release please retarget manually)


---

Comment by embray created at 2019-06-14 14:55:02

As the Sage-8.8 release milestone is pending, we should delete the sage-8.8 milestone for tickets that are not actively being worked on or that still require significant work to move forward.  If you feel that this ticket should be included in the next Sage release at the soonest please set its milestone to the next release milestone (sage-8.9).


---

Comment by nbruin created at 2019-10-27 18:54:13

To help you along with this: it's probably a matter that the existence of the symbolic function 'f' isn't properly coordinated across the inter-process communication, so that a new symbolic function, also called 'f' is created at some point:

```
sage: a_new=s0.operands()[2]
sage: a
f(x)
sage: a_new
f(x)
sage: a - a
0
sage: a - a_new #this indicates something fishy
-f(x) + f(x)
sage: bool( a==a_new)
True
sage: s0.subs({a_new: a})
-x^3 - (x^2 - x*f(x))*y + f(x)
sage: s0.subs({a_new: a}).coefficient(a,1)
x*y + 1
```

If may pickling that's (part of) the problem:

```
sage: function('f')(x)-function('f')(x)
0
sage: function('f')(x)-SR('f(x)')
0
sage: loads(dumps(SR('f(x)')))-SR('f(x)')
0
sage: function('f')(x)-SR('f(x)')
f(x) - f(x)
sage: loads(dumps(function('f')(x)))-function('f')(x)
-f(x) + f(x)
sage: loads(dumps(function('f')(x)))-SR('f(x)')
0
```

as you can see, the different ways of creating a symbolic function start out as giving the same result. However, as soon as pickling has been involved, something changes, and results are not compatible any more. from that point onwards, `SR('f(x)')` seems to produce results consistent with pickling, but `function('f')(x)` is reliably not compatible (and in fact, further investigation shows that `function('f')(x)` across different invocations of pickle returns unidentical results. So there's some naste cache wiping/corruption going on somewhere.

You can see part of it here:

```
sage: explain_pickle(dumps(function('f')(x)))
pg_Expression = unpickle_global('sage.symbolic.expression', 'Expression')
si = unpickle_newobj(pg_Expression, ())
unpickle_build(si, (0r, ['x'], 'GARC\x03\tfunction\x00class\x00symbol\x00x\x00name\x00seq\x00python\x00f\x00sage_ex\x00\x01\x08\x01\x02\x02\n\x02"\x03\x04\n\x00+\x001\x00"\x07'))
si
```

As you can see, there's a rather opague string involved. The `unpickle_build` is part of the getstate/setstate protocol, and reading `sage.symbolic.expression.Expression.__setstate__` and `sage.symbolic.expression.Expression.__getstate__` shows you that a Pynac archive is involved. It's not hard to imagine the coordination problems that can arise when using such low-level tools. This needs a pynac expert. See https://github.com/pynac/pynac/issues/349 (if github is preferred for tracking pynac)


---

Comment by @DeRhamSource created at 2019-11-21 12:28:02

Since false results are produced, it seems to be a severe bug. On this, I'd suggest either to solve it for milestone 9 or at least to disable the feature or give it a warning in the documentation until a solution is found.


---

Comment by egourgoulhon created at 2019-11-21 13:02:30

Replying to [comment:7 gh-DeRhamSource]:
> Since false results are produced, it seems to be a severe bug. On this, I'd suggest either to solve it for milestone 9 or at least to disable the feature or give it a warning in the documentation until a solution is found.
Fortunately, with Python 3 (and hence Sage 9.0), there is no longer any silent error: a `TypeError` exception is raised instead. So there is no need to disable a feature (parallelization) that is massively used in tensor calculus on manifolds (see e.g. many of [these examples](https://sagemanifolds.obspm.fr/examples.html)).


---

Comment by @DeRhamSource created at 2019-11-21 13:50:17

Ah I see. And in conclusion, python2 will not even be supported anymore?

Sorry for interfering then. :)


---

Comment by egourgoulhon created at 2019-11-21 15:55:30

Replying to [comment:9 gh-DeRhamSource]:
> Ah I see. And in conclusion, python2 will not even be supported anymore?
> 

Python 2 is almost dead: https://pythonclock.org/


---

Comment by mkoeppe created at 2020-08-01 13:06:19

What about this ticket?


---

Comment by @mjungmath created at 2020-08-01 13:09:20

This bug is really annoying in terms of applications. You need parallelization to speed things up, especially in this case. I thought maybe you have some ideas to contribute. If not, my apologies.


---

Comment by mkoeppe created at 2020-08-01 15:28:38

Could you try to update & clarify the ticket description please? It's OK to delete everything related to python2. We no longer support it.


---

Attachment


---

Comment by mkoeppe created at 2020-08-04 19:57:50

Well, there are lots of libraries involved in symbolics, so lots of questions.

I guess the first question to ask is whether the parallelization that you use involves several threads in one process, or several processes.

The reported error comes from Maxima, which runs in ECL. Is ECL prepared and configured for threadsafe operation? Are the parts of Maxima that the symbolics code uses threadsafe? (The assumptions code that I touched in #30074 is definitely not threadsafe.)


---

Comment by egourgoulhon created at 2020-12-16 10:08:19

See #31047 for a related issue.


---

Comment by egourgoulhon created at 2020-12-16 10:15:09

Replying to [comment:15 mkoeppe]:
> Could you try to update & clarify the ticket description please? It's OK to delete everything related to python2. We no longer support it.

Done.


---

Comment by egourgoulhon created at 2020-12-16 10:24:50

Replying to [comment:17 mkoeppe]:
> Well, there are lots of libraries involved in symbolics, so lots of questions.
> 
> I guess the first question to ask is whether the parallelization that you use involves several threads in one process, or several processes.

The parallelization is based on the Python module [multiprocessing](https://docs.python.org/3/library/multiprocessing.html), so it involves several processes. 
> 
> The reported error comes from Maxima, which runs in ECL. Is ECL prepared and configured for threadsafe operation? Are the parts of Maxima that the symbolics code uses threadsafe? (The assumptions code that I touched in #30074 is definitely not threadsafe.)

There is no error when the involved symbolic expressions do not contain any symbolic function, so I would say that is not an issue with Maxima and parallelization, but rather an issue with Sage's symbolic functions (cf. comment:4 and #31047).


---

Attachment
