# Issue 28752: Bug in proper cycles of indefinite binary quadratic forms

Issue created by migration from https://trac.sagemath.org/ticket/28989

Original creator: @sloebrich

Original creation time: 2020-01-11 10:21:07

Keywords: binary quadratic forms

The proper cycle of the indefinite quadratic form x<sup>2</sup>+xy-y<sup>2</sup> consists of x<sup>2</sup>+xy-y<sup>2</sup> and -x<sup>2</sup>+xy-y<sup>2</sup>. Sage gives only one element.


```
sage: Q=BinaryQF(1,1,-1)
sage: Q.cycle(proper=True) 
[x^2 + x*y - y^2]
```


As a consequence, consider two quadratic forms of discriminant 5. Two such forms are always properly equivalent. However, we get


```
sage: Q1, Q2 = BinaryQF(1,1,-1), BinaryQF(-1,1,1) 
sage: Q1.is_equivalent(Q2, proper=True) 
False
```


To check proper equivalence, note that


```
sage: M=Matrix(ZZ,2,2, [1,1,-1,0])
sage: det(M)
1
sage: Q2 == Q1.matrix_action_right(M)
True
```



---

Comment by @DaveWitteMorris created at 2020-01-11 20:42:22

Thanks for reporting the bug. My patch fixes an error in the definition of the `cycle` function.


```
sage: Q=BinaryQF(1,1,-1)
sage: Q.cycle(proper=True)
[x^2 + x*y - y^2, -x^2 + x*y + y^2]
sage: Q1, Q2 = BinaryQF(1,1,-1), BinaryQF(-1,1,1) 
sage: Q1.is_equivalent(Q2, proper=True)
True
```


I am not setting this to "needs review" yet, for two reasons: the doctests need work, and I am not sure this gives correct answers for quadratic forms whose first coefficient is negative. (The reference [BV2007] seems to require the first coefficient to be positive.) I think I should be able to get this figured out, but it's great if someone who knows about quadratic forms wants to chime in.
----
New commits:


---

Comment by @DaveWitteMorris created at 2020-01-11 20:42:22

Changing priority from minor to major.


---

Comment by @DaveWitteMorris created at 2020-01-11 23:21:50

The second item in the output of `Q.cycle(proper=True)` seems to have a sign error in the `y^2` term. I'll have to look into this.


---

Comment by git created at 2020-01-12 03:21:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @DaveWitteMorris created at 2020-01-12 03:39:09

I fixed an additional mistake in the definition of `cycle`. (The statement of Proposition 6.10.5 of [BV2007] is ambiguous, and the original algorithm interpreted it incorrectly.) I validated the new algorithm on a couple of examples from [BV2007], and will add these as doctests. 

However, I also still need to look at quadratic forms whose coefficient of `x^2` is negative.

PS [BV2007] = Johannes Buchmann and Ulrich Vollmer, _Binary Quadratic Forms_, Springer, 2007.
----
New commits:


---

Comment by @DaveWitteMorris created at 2020-01-12 06:03:54

OK, I think the mathematics is correct, but I will modify the docstrings to clarify that the  definition of "cycle" used here is not quite the same as in [BV2007].


---

Comment by git created at 2020-01-15 23:00:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @DaveWitteMorris created at 2020-01-15 23:13:56

Changing status from new to needs_review.


---

Comment by @DaveWitteMorris created at 2020-01-15 23:13:56

I added several doctests and corrected (or replaced) some of the ones that were already there, rewrote the docstring of `cycle`, and fixed two more bugs (including one that was my fault).

The main purpose of this ticket is to rewrite the few lines of code that compute proper cycles of indefinite forms. I believe that function is now correct. The ticket also fixes a bug in `is_equivalent`. (The quadratic form `self` might not be reduced, so it needed to be replaced with `selfred` at one point.) 

I verified a few examples by hand, and also validated against some examples that I found on the internet. I did not look at the code for definite forms at all, but that is older and presumably better tested.


---

Comment by chapoton created at 2020-01-17 12:55:48

please do not use comments (starting with #) in the documentation, but make sentences.


---

Comment by git created at 2020-01-17 18:44:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2020-01-20 04:43:20

A few minor things:

```diff
-        TESTS::
+        TESTS:
 
         Check an example in :trac:`28989`::
+
-            sage: Q=BinaryQF(1,1,-1)
+            sage: Q = BinaryQF(1,1,-1)
             sage: Q.cycle(proper=True)
             [x^2 + x*y - y^2, -x^2 + x*y + y^2]
 
         This is Example 6.10.6 of [BUVO2007]_::
+
-            sage: Q=BinaryQF(1,7,-6)
+            sage: Q = BinaryQF(1,7,-6)
```

and any other similar changes.

```diff
-        Try an example where a is negative::
-            sage: Q=BinaryQF(-1, 8, 3)
+        Try an example where `a` is negative::
+
+            sage: Q = BinaryQF(-1, 8, 3)
```

The for-loop part is over-indented here:

```
            for i in range(len(C)//2):
                    C[2*i+1] = C[2*i+1]._Tau()
```


```diff
-                C = C + C
+                C += C
```

I also don't understand the point of this test:

```
            sage: hasattr(Q, '_cycle_list')
            False
```



---

Comment by git created at 2020-01-22 03:16:52

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @DaveWitteMorris created at 2020-01-22 03:21:36

Thanks for looking at the ticket, and for your corrections. I made all of the changes that you suggested, and searched to correct similar mistakes. I also noticed that the spacing in lists was inconsistent, so I standardized by always putting a space after commas.

You were right to question the `hasattr` test, because it does not really make sense as a doctest. So I deleted it, and also the similar test a few lines later.


---

Comment by tscrim created at 2020-01-22 03:38:58

Thank you. However, all of these changes except for the one I pointed out are wrong:

```diff
-TESTS::
+TESTS:
```

When there are two colons `::`, what should follow is indented and doctests. If there is only one colon `:`, then it should be normal text.


---

Comment by git created at 2020-01-22 03:52:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @DaveWitteMorris created at 2020-01-22 03:54:18

Sorry, I didn't know that (obviously). I think it is correct now.


---

Comment by tscrim created at 2020-01-22 03:55:31

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2020-01-22 03:55:31

Thank you.


---

Comment by vbraun created at 2020-01-25 17:27:44

Resolution: fixed
