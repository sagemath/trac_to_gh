# Issue 16067: Non-deterministic ordering of GMP-ECM output

Issue created by migration from Trac.

Original creator: pbruin

Original creation time: 2014-05-07 14:52:48

CC:  zimmerma

Keywords: gmp-ecm elliptic curve factoring

It seems that there is a small but positive probability that the factors found by the GMP-ECM elliptic curve factorisation program are in non-increasing order.  From [a recent patchbot report](http://patchbot.sagemath.org/log/11475/debian/wheezy/sid/x86_64/3.2.0-57-generic/selmer/2014-05-07%2007:23:33%20+0100):

```
sage -t --long src/sage/interfaces/ecm.py
**********************************************************************
File "src/sage/interfaces/ecm.py", line 548, in sage.interfaces.ecm.ECM.find_factor
Failed example:
    f.find_factor(n)
Expected:
    [79792266297612017, 6366805760909027985741435139224233]
Got:
    [6366805760909027985741435139224233, 79792266297612017]
**********************************************************************
1 item had failures:
   1 of   6 in sage.interfaces.ecm.ECM.find_factor
    [44 tests, 1 failure, 15.27 s]
```

I have not been able to reproduce this, nor can Google find it in other patchbot reports.

This is related to #10951, which makes GMP-ECM's optional `sigma` argument accessible in the interface; passing such a sigma would give deterministic behaviour.


---

Comment by zimmerma created at 2014-05-07 15:16:24

indeed, the closer the (smallest) factors, the higher is the probability that the factor
found is non-deterministic:

```
sage: f = ECM()
sage: n=6366805760909033411615543376840901
sage: f.find_factor(n)
[79792266297612017, 79792266297612053]
sage: f.find_factor(n)
[79792266297612053, 79792266297612017]
```

A better check would be to first sort the liste returned (in case of two prime factors).

Paul


---

Comment by zimmerma created at 2014-05-07 15:16:53

> A better check would be to first sort the liste returned (in case of two prime factors).

sorry, I meant "list" instead of "liste".

Paul


---

Comment by pbruin created at 2014-05-07 15:30:01

Replying to [comment:1 zimmerma]:
> A better check would be to first sort the liste returned (in case of two prime factors).
How about letting `_parse_output()` always sort the list of pairs `(factor, probable_prime)` before returning it, regardless of the number of factors and the value of `probable_prime` for each?


---

Comment by zimmerma created at 2014-05-07 15:39:54

> How about letting `_parse_output()` always sort the list of pairs `(factor, probable_prime)` before returning it, regardless of the number of factors and the value of `probable_prime` for each?

but then we would lose some information, since the first factor is the one which is really found by ECM.

And with 3 prime factors or more, we would still have non-deterministic output.

Paul


---

Comment by pbruin created at 2014-05-07 15:47:36

Replying to [comment:4 zimmerma]:
> > How about letting `_parse_output()` always sort the list of pairs `(factor, probable_prime)` before returning it, regardless of the number of factors and the value of `probable_prime` for each?
> 
> but then we would lose some information, since the first factor is the one which is really found by ECM.
> 
> And with 3 prime factors or more, we would still have non-deterministic output.
Ah, right.  Then maybe the most reasonable solution is not to change the code at all, but to make the doctests resistant to non-deterministic results: sort the output in those tests where _n_ has only two prime factors, and check that the output consists of at least 2 factors with the correct product if _n_ has at least three prime factors.


---

Comment by pbruin created at 2015-08-17 12:17:28

Am I right in thinking that #10951 makes the factorisation deterministic, thereby solving the problem in this ticket?


---

Comment by pbruin created at 2015-08-17 12:17:28

Changing status from new to needs_info.


---

Comment by zimmerma created at 2015-08-17 16:59:46

Replying to [comment:8 pbruin]:
> Am I right in thinking that #10951 makes the factorisation deterministic, thereby solving the problem in this ticket?

no, unless we fix the sigma values used by ECM, it should still be non deterministic.


---

Comment by nbruin created at 2015-08-17 17:15:11

Just put a `sorted(...)` around each of the problematic lines.


---

Comment by pbruin created at 2015-08-17 17:35:13

Replying to [comment:9 zimmerma]:
> Replying to [comment:8 pbruin]:
> > Am I right in thinking that #10951 makes the factorisation deterministic, thereby solving the problem in this ticket?
> 
> no, unless we fix the sigma values used by ECM, it should still be non deterministic.
OK, I see, #10951 only makes it possible to pass a sigma value; the default `sigma=0` apparently means that a random one is chosen.


---

Comment by pbruin created at 2015-08-17 17:35:45

Replying to [comment:10 nbruin]:
> Just put a `sorted(...)` around each of the problematic lines.
We could do that, but see comment:4.
