# Issue 31618: Patch/upgrade gmpy2 to add python 3.10 support

Issue created by migration from https://trac.sagemath.org/ticket/31855

Original creator: mkoeppe

Original creation time: 2021-05-24 23:58:02

CC:  vdelecroix dimpase mjo fbissey

`gmpy2` fails to build with Python 3.10: error: ‘_PyHASH_NAN’ undeclared - https://bugzilla.redhat.com/show_bug.cgi?id=1959010 ... 

- patches at https://copr-dist-git.fedorainfracloud.org/cgit/`@`python/python3.10/python-gmpy2.git/tree/


---

Comment by mkoeppe created at 2021-05-25 00:19:48

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2021-05-25 00:19:48

New commits:


---

Comment by vdelecroix created at 2021-05-30 07:48:00

Why not use upstream patch https://github.com/aleaxit/gmpy/pull/297?


---

Comment by mkoeppe created at 2021-05-30 07:54:05

No idea, why doesn't upstream make a proper release at some point?


---

Comment by vdelecroix created at 2021-05-30 08:04:49

Replying to [comment:4 mkoeppe]:
> No idea, why doesn't upstream make a proper release at some point?

No idea, worth asking. Though the patch was merged a week ago.


---

Comment by dimpase created at 2021-06-26 08:13:49

Replying to [comment:5 vdelecroix]:
> Replying to [comment:4 mkoeppe]:
> > No idea, why doesn't upstream make a proper release at some point?
> 
> No idea, worth asking. Though the patch was merged a week ago.
I've opened 
https://github.com/aleaxit/gmpy/issues/303


---

Comment by dimpase created at 2021-06-26 08:16:16

How about using the upstream patch https://patch-diff.githubusercontent.com/raw/aleaxit/gmpy/pull/297.diff
instead?


---

Comment by mkoeppe created at 2021-08-28 01:28:07

Looks like upstream is preparing a proper release now - https://github.com/aleaxit/gmpy/commit/97424526eaf30ed33390d7b12d20d411583c6322


---

Comment by git created at 2021-09-15 23:51:56

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mjo created at 2021-09-17 10:50:01

OK by me when the GH actions finish. Everyone is already using beta5, so it's not like rc1 is a step down in purported release quality.


---

Comment by mkoeppe created at 2021-10-10 23:25:11

Let's get this in please.


---

Comment by mkoeppe created at 2021-10-10 23:25:11

Changing priority from major to critical.


---

Comment by enriqueartal created at 2021-11-03 22:43:25

I am in Fedora 35 now and I would like to test it. I can use python3.10 (following the hack of the packager of sagemath in Fedora) but I do not know how to deal with cysignals. Any clue?


---

Comment by mkoeppe created at 2021-11-03 22:51:07

See #32576 for cysignals


---

Comment by enriqueartal created at 2021-11-03 23:33:35

I saw it but I am not how to deal with it. Apparently in Fedora they were able to compile cysignals and to use it as a system package.


---

Comment by mkoeppe created at 2021-11-03 23:38:50

You can help on #32576 by reviewing the proposed changes to cysignals


---

Comment by enriqueartal created at 2021-11-04 10:46:10

This is the status. I used the configure file of sagemath.spec in fedora which allows to use python3.10.0 in the system. Using the link in  #32576 I used the revised cysignals, and I also used gmpy2.1.0rc1, both are compiled. The only unsuccessful package is pyzmq; the fedora system package python3-zmq exists and I was able to recompile it locally. The error in Sage is:

gcc build/temp.linux-x86_64-3.9/tmp/timer_createq5lapz40.o -o build/temp.linux-x86_64-3.9/a.out
  error: [Errno 2] No such file or directory: 'a.out'

It happens with 22.2.1 and 22.0.3
I do not know how to use the system package for this.


---

Comment by mkoeppe created at 2021-11-05 17:11:02

I have opened #32828 for the issues with `pyzmq`. I think they are unrelated to python 3.10


---

Comment by mkoeppe created at 2021-11-08 00:47:54

Tests look good, let's please get this update in.


---

Comment by dimpase created at 2021-11-17 16:40:36

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2021-11-17 16:40:36

lgtm


---

Comment by mkoeppe created at 2021-11-17 18:13:51

Thanks!


---

Comment by vbraun created at 2021-12-05 11:15:44

Resolution: fixed


---

Comment by dimpase created at 2021-12-15 15:53:48

gmpy2 stable version 2.1 has been released.
