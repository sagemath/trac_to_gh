# Issue 29036: add system packages info for R

Issue created by migration from https://trac.sagemath.org/ticket/29273

Original creator: dimpase

Original creation time: 2020-03-03 11:23:02

CC:  mkoeppe fbissey mjo

this is a followup to #29053 which missed packages mentioned on #28884


---

Comment by mkoeppe created at 2020-03-03 12:07:59

See also #29129


---

Comment by dimpase created at 2020-03-03 12:38:22

New commits:


---

Comment by dimpase created at 2020-03-03 12:38:22

Changing status from new to needs_review.


---

Comment by git created at 2020-03-03 23:01:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-03-03 23:54:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-03-03 23:57:19

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2020-03-04 00:03:26

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2020-03-04 00:10:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-03-04 00:25:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-03-04 09:45:31

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by dimpase created at 2020-03-04 09:49:13

rebased over 9.1.beta6


---

Comment by fbissey created at 2020-03-04 09:59:01

I am getting concerned that a rather unusual feature of gentoo may need additional description. The useflags. While packages in binary distro are built with all possible options [and when that is not possible either the best sets or variants of the package are offered] in Gentoo we leave the end user to choose a number of options by themselves. So not only do I want a package list, I want the option to go with it. Like for `pari`, we really want to use the gmp option (although I think it would just be slower in that case) and the doc option [not negotiable I even spent time making sure the doc was usable for cypari and sage when when it was part of it]. 

A list of useflags for Gentoo is at https://github.com/cschwan/sage-on-gentoo/blob/master/package.use/sage - some of the packages - pplpy, pynac and lcalc - are not in the main gentoo tree, only in the sage-on-gentoo overlay.


---

Comment by dimpase created at 2020-03-04 10:25:35

perhaps there should be an extra optional datapoint for each gentoo package, the needed useflags, and then the installation advice would be generated by combining these flags into one list somehow?


---

Comment by dimpase created at 2020-03-04 10:36:35

by the way, could you people, fbissey or mjo, update  `sci-mathematics/gfan` to 0.6.2?
It's currently only 0.5, too old, in Gentoo.

I've filed https://bugs.gentoo.org/711492 to track this.


---

Comment by git created at 2020-03-04 10:45:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-03-04 10:56:38

Replying to [comment:15 dimpase]:
> perhaps there should be an extra optional datapoint for each gentoo package, the needed useflags, and then the installation advice would be generated by combining these flags into one list somehow? 

Sounds good. Same format as a "package.use" file?


---

Comment by dimpase created at 2020-03-04 11:12:52

I've also filed https://bugs.gentoo.org/711498 to request m4rie to be packaged in Gentoo.


---

Comment by git created at 2020-03-04 13:37:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mjo created at 2020-03-04 14:37:25

The dependency syntax for Gentoo includes the USE flags in square brackets after the package name, like `media-libs/gd[jpeg,png]`. I noticed that we're going to need that information, but I'm not sure where/how these text files are meant to be displayed to the end user, so I'm not sure of "dependency" format or package.use format is better.

One idea I had was that, until all of sage is packaged, maybe we could have people create a local package set called `@`sagemath:

https://wiki.gentoo.org/wiki/Package_sets

If gentoo.txt contains entries like `media-libs/gd[jpeg,png]`, then we could tell users to `cat build/pkgs/*/distros/gentoo.txt > /etc/portage/sets/sagemath` and then `emerge --autounmask-use --autounmask-write `@`sagemath` would automatically add those flags to package.use before installing the associated packages. That lets us use dependency syntax, and portage takes care of turning it into package.use entries.

That's how I'm keeping track of my system-sage packages for now. Package sets are a bad substitute for a meta package, but they're easier for non-technical users to create and manage.

OTOH, it may be simpler with package.use format to just specify a list of USE flags that works. Saying "we need this and this and this... you figure it out" is elegant, but experience has taught me that sometimes you just need to be able to tell the computer to "shut up and use this."


---

Comment by mkoeppe created at 2020-03-04 14:44:32

Replying to [comment:21 mjo]:
> I noticed that we're going to need that information, but I'm not sure where/how these text files are meant to be displayed to the end user, so I'm not sure of "dependency" format or package.use format is better.

Ideally, we will provide a script that formats a command line that the user can run directly. Similar to the `apt-get` lines shown in the Sage installation manual (formatted automatically as of #26964). See also #27351 (At end of configure, suggest a list of system packages to install) -- which should ideally also format a command line.

> [...] Saying "we need this and this and this... you figure it out" is elegant, but experience has taught me that sometimes you just need to be able to tell the computer to "shut up and use this."

Indeed.


---

Comment by mkoeppe created at 2020-03-04 14:47:03

Replying to [comment:21 mjo]:
> The dependency syntax for Gentoo includes the USE flags in square brackets after the package name, like `media-libs/gd[jpeg,png]`.

Sounds like this would be a better match for our gentoo.txt files than the package.use format.


---

Comment by dimpase created at 2020-03-04 19:04:18

Does this syntax allow for things like `foo/bar[baz/oz, buz/biz]`, i.e. with dependencies names spelled in full ?

There could also be non-dependency USE flags needed for configuration, but if the latter works it hopefully covers most of our needs.


---

Comment by mjo created at 2020-03-05 03:28:09

Replying to [comment:24 dimpase]:
> Does this syntax allow for things like `foo/bar[baz/oz, buz/biz]`, i.e. with dependencies names spelled in full ?
> 
> There could also be non-dependency USE flags needed for configuration, but if the latter works it hopefully covers most of our needs.
>  

The things inside the square brackets are the names of USE flags, not packages. So `foo/bar[baz,buz]` says that we need the package `foo/bar` built with both `USE=baz` and `USE=buz` set. Sometimes the USE flag names match up with package names, but ideally (and in general) they won't.


---

Comment by dimpase created at 2020-03-05 13:18:17

Let's handle the fine points of Gentoo setup on a follow-up ticket.


---

Comment by mkoeppe created at 2020-03-05 20:19:18

I don't know how to check any of the gentoo things (see #29105).


---

Comment by dimpase created at 2020-03-05 20:28:01

I am checking Gentoo things. The problem is that Gentoo is very fluid.


---

Comment by mkoeppe created at 2020-03-05 20:33:31

Replying to [comment:28 dimpase]:
> The problem is that Gentoo is very fluid.

Exactly because of that I want to define an environment using Docker so that the statement "it works on gentoo" is well-defined.


---

Comment by dimpase created at 2020-03-05 21:24:59

Replying to [comment:27 mkoeppe]:
> I don't know how to check any of the gentoo things (see #29105).

get the list of packages from all these gentoo.txt files, and run, as root,

`emerge --ask <this list>` 

e.g. `emerge --ask dev-lang/python foo/bar baz`

this is interactive, and you either will get an error, or a prompt inviting you to start the installation. cf https://wiki.gentoo.org/wiki/Gentoo_Cheat_Sheet etc

(I don't have any machines ready to run docker, kernel options aren't right; I'll try on lxc using one of images here https://us.images.linuxcontainers.org/)


---

Comment by dimpase created at 2020-03-05 21:28:27

An alternative would be to merge this as is (checking non-gentoo things), and deal with gentoo on a separate ticket, which might take a while.


---

Comment by git created at 2020-03-05 23:11:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2020-03-05 23:30:07

In addition to the fix in the last commit,
on the lxc gentoo/current image I picked on https://uk.images.linuxcontainers.org/, I needed to add

``` 
sci-mathematics/arb
sci-mathematics/flint
sci-mathematics/cliquer
sci-libs/m4ri
sci-mathematics/planarity
media-gfx/tachyon
```

to `/etc/portage/package.keywords`, as these packages are masked with `~amd64`.
Perhaps there is a quicker way to accomplish this.

`givaro` needed  agreeing to a license treatment, i.e.

```
# required by sci-libs/givaro (argument)
>=sci-libs/givaro-4.1.1 CeCILL-B
```

added to `/etc/portage/package.license`.
And, naturally, `etc-update` had to be run a number of times, resulting in
`/etc/portage/package.use/zz-autounmask` getting

```
# package.use# required by sci-mathematics/flint[ntl] (argument)
>=sci-mathematics/flint-2.5.2-r1 ntl
# required by dev-lang/R-3.4.1::gentoo
# required by dev-lang/R (argument)
>=sys-libs/zlib-1.2.11-r2 minizip
# required by m4ri[png] (argument)
>=sci-libs/m4ri-20200115 png
```

after this, the build with all the `gentoo.txt`-mentioned packages started.

Thus, perhaps, installation instructions can have 
commands like `run, as root`:

```
cat $SAGE_ROOT/build/portage/package.keywords >> /etc/portage/package.keywords
```



---

Comment by mkoeppe created at 2020-03-06 02:19:39

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2020-03-06 02:19:39

Looks good to me. Tests at https://github.com/mkoeppe/sage/actions/runs/50456287


---

Comment by mkoeppe created at 2020-03-06 02:24:43

Replying to [comment:31 dimpase]:
> deal with gentoo on a separate ticket, which might take a while.

Let's use #29105 (Extend dockerfile generator to gentoo) for that.


---

Comment by mkoeppe created at 2020-03-06 02:25:29

Replying to [comment:33 dimpase]:
> ... Thus, perhaps, installation instructions can have 
> commands like `run, as root`:
> {{{
> cat $SAGE_ROOT/build/portage/package.keywords >> /etc/portage/package.keywords
> }}}

Sounds OK to me.


---

Comment by git created at 2020-03-06 10:42:23

Changing status from positive_review to needs_review.


---

Comment by git created at 2020-03-06 10:42:23

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by dimpase created at 2020-03-06 10:47:41

The gentoo.txt files still need work, as the current configuration pulls in wrong blas/lapack, and llvm/clang (sic!), something we definitely don't want.


---

Comment by dimpase created at 2020-03-06 10:47:41

Changing status from needs_review to positive_review.


---

Comment by git created at 2020-03-06 15:12:01

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by git created at 2020-03-06 15:12:01

Changing status from positive_review to needs_review.


---

Comment by dimpase created at 2020-03-06 16:41:11

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2020-03-06 16:41:11

OK, I should stop fiddling with this. Gentoo stuff needs moar workz.


---

Comment by vbraun created at 2020-03-08 22:14:48

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2020-03-08 22:14:48

Merge conflict


---

Comment by git created at 2020-03-08 22:19:33

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2020-03-08 22:19:45

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2020-03-08 22:28:30

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2020-03-08 22:28:30

Merge conflict


---

Comment by git created at 2020-03-09 00:49:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-03-09 00:50:05

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2020-03-11 23:46:18

Resolution: fixed


---

Comment by dimpase created at 2020-03-17 18:38:18

a followup on #29352
