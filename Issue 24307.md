# Issue 24307: cleaning linbox declarations

Issue created by migration from Trac.

Original creator: vdelecroix

Original creation time: 2018-01-15 16:11:49

CC:  cpernet tscrim

We organize linbox declarations (`sage/libs/linbox/`) and make the Sage code independent of the `interfaces/sage` that is in linbox.


---

Comment by vdelecroix created at 2018-01-15 16:15:25

See the attached branch for an experimental version. All tests pass on my computer. Though many tests in `sage/matrix/linbox_solver_modn_sparse.pyx` are there for showing potential bugs in linbox `solve`.
----
New commits:


---

Comment by git created at 2018-01-15 16:53:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-02-03 12:14:09

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vdelecroix created at 2018-02-03 16:09:42

The current branch at `7ec9610` does compile but Sage crashes when launched with

```
/opt/sage/local/lib/python2.7/site-packages/sage/matrix/linbox_solver_modn_sparse.pxd in init sage.matrix.matrix_modn_sparse()
      6 from sage.modules.vector_modn_dense cimport Vector_modn_dense
      7 
----> 8 cdef class LinBoxSolver_modn_sparse(object):
        global cdef = undefined
        global LinBoxSolver_modn_sparse = undefined
        global object = undefined
      9     r"""
     10     Solving linear equations in Sage using LinBox.
     11     """
     12     cdef object Vin
ImportError: /opt/sage/local/lib/python2.7/site-packages/sage/matrix/linbox_solver_modn_sparse.so: undefined symbol:
_ZNK6LinBox15MVProductDomainIN6Givaro7ModularImmEEE22mulColDenseSpecializedINS_10BlasVectorIS3_St6vectorImSaImEEEENS_15TransposeMatrixINS_9Protected19SparseMatrixGenericIS3_S7_ISt4pairImmESaISF_EENS_16VectorCategories23SparseSequenceVectorTagEEENS_16MatrixCategories12RowMatrixTagEEES9_EERT_RKNS_12VectorDomainIS3_EESP_RKT0_RKT1_SJ_
```



---

Comment by jdemeyer created at 2018-02-03 20:09:42

Why are you using comments like

```
# return a new LinBox vector from a Sage vector
# (such vector has to be deallocated with a "del" statement)
# INPUT:
#   F - LinBox field
#   v - Sage vector
```

instead of docstring syntax like

```
"""
Return a new LinBox vector from a Sage vector
(such vector has to be deallocated with a "del" statement)

INPUT:

- F -- LinBox field
- v -- Sage vector
"""
```



---

Comment by jdemeyer created at 2018-02-03 20:12:36

Regarding

```
# without this function, Cython produces a wrong C file
# Namely, at compilation
#
#
def _dummy():
    raise RuntimeError("this is a cython bug")
```

could you report that bug on the Cython github page and put a link to that bug report in the comment?


---

Comment by jdemeyer created at 2018-02-03 20:13:26

Same for the other places where you claim "Cython bug".


---

Comment by jdemeyer created at 2018-02-03 20:14:18

This ticket does a lot of things... would it be possible to separate the changes to `src/sage/libs/linbox`?


---

Comment by jdemeyer created at 2018-02-03 20:19:40

`src/sage/libs/linbox/linbox_flint_interface.pxd` defines only Cython functions, why did you add the `# distutils` stuff?


---

Comment by jdemeyer created at 2018-02-03 20:20:12

Typo: `Inteer` -> `Integer`


---

Comment by jdemeyer created at 2018-02-03 20:24:06

Why the explicit `PyInt_FromLong` here?

```
return PyInt_FromLong(A_rank)
```

Cython knows how to convert a `long` to a Python object.


---

Comment by git created at 2018-03-05 17:30:26

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by vdelecroix created at 2018-03-05 17:31:16

Replying to [comment:15 jdemeyer]:
> Why the explicit `PyInt_FromLong` here?
> {{{
> return PyInt_FromLong(A_rank)
> }}}
> Cython knows how to convert a `long` to a Python object.

Otherwise, I obtain a Python long by default which is not the same behavior as the other rank functions on matrices.


---

Comment by vdelecroix created at 2018-03-05 17:32:49

The current branch based on sage-7.2.beta7 (commit `6e8aa61`) crashes similarly to what is described in [comment:8 comment:8].


---

Comment by vdelecroix created at 2018-04-29 12:52:58

Changing status from new to needs_review.


---

Comment by vdelecroix created at 2018-04-29 12:52:58

Apparently, I can not use `Modular<uint64_t>` within solve (see [LinBox issue 117](https://github.com/linbox-team/linbox/issues/117)). The rest looks fine! Needs review :-)
----
New commits:


---

Comment by git created at 2018-04-30 10:58:06

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by tscrim created at 2018-05-02 00:08:55

From my look-over, everything seems okay, but I don't have as experienced of an eye as Jeroen for these things. So Jeoren, I would appreciate it if you could give it another quick look-over.

Minor nitpick from me is the formatting of the docstrings in `conversion.pxd`.


---

Comment by vdelecroix created at 2018-05-02 05:21:01

Replying to [comment:25 tscrim]:
> From my look-over, everything seems okay, but I don't have as experienced of an eye as Jeroen for these things. So Jeoren, I would appreciate it if you could give it another quick look-over.
> 
> Minor nitpick from me is the formatting of the docstrings in `conversion.pxd`.

These are inline C functions that will not appear anywhere and are not even accessible from `??`. These docstrings as for people using the code. Adding extra ```a``` make them less readable I think.


---

Comment by tscrim created at 2018-05-02 05:44:25

Replying to [comment:26 vdelecroix]:
> Replying to [comment:25 tscrim]:
> > Minor nitpick from me is the formatting of the docstrings in `conversion.pxd`.
> 
> These are inline C functions that will not appear anywhere and are not even accessible from `??`. These docstrings as for people using the code. Adding extra ```a``` make them less readable I think.

I don't care that strongly. I am so used to seeing the Sage-formatted docstrings, it took me a little bit of extra time to mentally parse it. So if you are opposed to such a change, then I am okay to call it bikeshedding and move on.


---

Comment by git created at 2018-05-02 17:49:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2018-05-02 21:16:48

What does this mean?

```
NOTE: this function is not part of the interface (ie the .pxd file) to keep the
module C-compatible
```



---

Comment by vdelecroix created at 2018-05-02 21:38:41

Replying to [comment:29 jdemeyer]:
> What does this mean?
> {{{
> NOTE: this function is not part of the interface (ie the .pxd file) to keep the
> module C-compatible
> }}}

The pxd file only contains C declarations and is hence compatible with Cython C files compiled with `gcc` not `g++`. I don't know whether it makes a difference but as flint is a pure C library I thought it would be better this way.


---

Comment by git created at 2018-05-02 21:39:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2018-05-03 07:36:39

Still conflicts with #24742.


---

Comment by jdemeyer created at 2018-05-03 07:53:10

The determinant of a 0x0 matrix should be 1.


---

Comment by git created at 2018-05-03 08:17:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-05-03 08:51:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-05-03 20:18:17

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2018-05-10 14:59:48

Anything more? I would like this one merged before touching #23214.


---

Comment by tscrim created at 2018-05-14 23:04:03

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2018-05-14 23:04:03

LGTM.


---

Comment by vbraun created at 2018-05-15 22:35:18

Merge conflict


---

Comment by vbraun created at 2018-05-15 22:35:18

Changing status from positive_review to needs_work.


---

Comment by git created at 2018-05-18 20:49:11

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by vdelecroix created at 2018-05-18 20:50:12

rebased on 8.3-beta2 (build and all tests pass in matrix/ currently building doc)


---

Comment by vdelecroix created at 2018-05-18 20:50:12

Changing status from needs_work to needs_review.


---

Comment by vdelecroix created at 2018-05-19 17:45:35

Everything's fine (as far as I can test). Since nothing changed (beyond the rebase) I am setting back to positive review.


---

Comment by vdelecroix created at 2018-05-19 17:45:35

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2018-05-21 22:34:54

Fails on OSX:

```
[sagelib-8.3.beta2] In file included from build/cythonized/sage/matrix/matrix_modn_sparse.cpp:689:
[sagelib-8.3.beta2] In file included from /Users/buildslave-sage/slave/sage_git/build/local/include/linbox/matrix/dense-matrix.h:79:
[sagelib-8.3.beta2] In file included from /Users/buildslave-sage/slave/sage_git/build/local/include/linbox/matrix/densematrix/blas-matrix.h:44:
[sagelib-8.3.beta2] /Users/buildslave-sage/slave/sage_git/build/local/include/linbox/vector/blas-vector.h:306:11: error: member reference base type 'const long' is not a structure or union
[sagelib-8.3.beta2]                         _size(V.size()),_1stride(1),_rep(V.size(), F.zero),_ptr(&_rep[0]),_field(&F)
[sagelib-8.3.beta2]                               ~^~~~~
```

Full log: http://build.sagemath.org/#/builders/32/builds/83/steps/5/logs/stdio


---

Comment by vbraun created at 2018-05-21 22:34:54

Changing status from positive_review to needs_work.


---

Comment by chapoton created at 2018-06-26 14:03:09

Changing keywords from "" to "linbox".


---

Comment by chapoton created at 2018-06-26 14:16:56

What's the status of the problem on OsX ?


---

Comment by vdelecroix created at 2018-06-26 18:59:17

Replying to [comment:45 chapoton]:
> What's the status of the problem on OsX ?

Thanks for your concern. I don't have any OSX machine and don't plan to buy any. I can not help with this issue. The only thing I know is [comment:43 comment:43].


---

Comment by chapoton created at 2018-06-26 20:07:13

is this not an issue that should be reported to linbox ?


---

Comment by vdelecroix created at 2018-06-26 20:12:01

Replying to [comment:47 chapoton]:
> is this not an issue that should be reported to linbox ?

Would be better to have something reproducible outside of Sage. Otherwise it might just be closed by upstream as was [issue 118](https://github.com/linbox-team/linbox/issues/118).


---

Comment by chapoton created at 2018-06-26 20:13:27

but this looks like something that breaks the build, nothing really sage related ?


---

Comment by vdelecroix created at 2018-06-26 20:15:47

Replying to [comment:49 chapoton]:
> but this looks like something that breaks the build, nothing really sage related ?

Sure, you can open an issue on github. My comment was just what I thought was best.


---

Comment by chapoton created at 2018-07-06 13:07:56

The link given by Volker in comment:43 leads to an empty page.

Is there somebody around with a mac, that could help ? Or maybe Clement has an idea on the problem ?


---

Attachment

Log of failure


---

Comment by alexjbest created at 2018-07-08 19:31:21

I tried this on my laptop running OS X with `git trac try 24544` and `make` and it failed, I have attached the log. If anyone has suggestions I'm happy to try them out on my machine.


---

Comment by chapoton created at 2018-07-17 07:14:03

according to the log given by Alex (thanks !), and by looking at `matrix_modn_sparse.cpp`, maybe the problematic lines are

```
"sage/matrix/matrix_modn_sparse.pyx":1053
```

and

```
"sage/matrix/matrix_modn_sparse.pyx":1146
```

Namely

```
        cdef DenseVector_Modular_int64 * b = new DenseVector_Modular_int64(F[0], self._nrows)
```

and

```
        cdef DenseVector_Modular_int64 * b = new DenseVector_Modular_int64(F[0], self._nrows)
```



---

Comment by vdelecroix created at 2018-08-03 19:20:18

update milestone 8.3 -> 8.4


---

Comment by vdelecroix created at 2018-08-30 12:49:27

This is why I don't understand. The exact same lines appear in the function `new_linbox_vector_modn_dense` (`sage/libs/linbox/conversion.pxd`) and correspond to the constructor `DenseVector_Modular_int64 (Field &F, long& m)` of the class `DenseVector_Modular_int64` that corresponds to `LinBox::DenseVector<Givaro::Modular<int64_t>>`.


---

Comment by chapoton created at 2018-09-02 17:01:01

I would really like to see progress here, and on the sequel ticket.. but not able to help..

Branch is red now.


---

Comment by vdelecroix created at 2018-09-02 18:21:32

I am working on it. I will isolate the problematic change from `LinBox::DenseVector<Givaro::Modular<unsigned int>>` to `LinBox::DenseVector<Givaro::Modular<int64_t>>`. Clement gave me the advice to do this change but since then (~6 months ago) it does not compile and Clement did not answer any of my mail.


---

Comment by git created at 2018-09-02 18:40:56

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vdelecroix created at 2018-09-02 18:46:52

Changing status from needs_work to needs_review.


---

Comment by vdelecroix created at 2018-09-02 20:54:14

Strange doctests failure with the petitbonum patchbot

```
sage -t --long --warn-long 58.5 src/sage/interfaces/ecm.py
**********************************************************************
File "src/sage/interfaces/ecm.py", line 457, in sage.interfaces.ecm.ECM.one_curve
Failed example:
    f.one_curve(n, B1=500000, algorithm="P-1")
Expected:
    [67872792749091946529, 6366805760909027985741435139224233]
Got:
    [1, 432132887883903108009802143314445113500016816977037257]
**********************************************************************
File "src/sage/interfaces/ecm.py", line 460, in sage.interfaces.ecm.ECM.one_curve
Failed example:
    f.one_curve(n, B1=2000, algorithm="P+1", x0=5)
Expected:
    [328006342451, 6366805760909027985741435139224233]
Got:
    [1, 2088352670731726262548647919416588631875815083]
**********************************************************************
1 item had failures:
   2 of   9 in sage.interfaces.ecm.ECM.one_curve
    [44 tests, 2 failures, 5.94 s]
```



---

Comment by vdelecroix created at 2018-09-02 20:54:37

Though patchbot arando is happy :-)


---

Comment by tscrim created at 2018-09-03 02:20:09

LGTM (from the description, the failures in comment:43 should no longer apply). (I've also seen the failures in comment:62 on other tickets that patchbot has tested.)


---

Comment by tscrim created at 2018-09-03 02:20:09

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2018-09-05 16:43:54

Resolution: fixed
