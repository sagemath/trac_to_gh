# Issue 25154: SageMath fails to build on on Fedora 28 with gcc 8.1

archive/issues_025154.json:
```json
{
    "body": "CC:  @dimpase\n\nKeywords: gcc8.1 python3 python2 linbox fedora28 compilation build\n\nSageMath building produces 3 different errors when run on Fedora 28 64bit with  gcc 8.1, specifically when building the packages:\n- python 3.6.1\n- python 2.7.14\n- linbox 1.5.2\n\nThe following errors are respectively reported:\n- Failure to import the crypt module\n- Failure to generate posix vars\n- \n\n```\n../../linbox/matrix/densematrix/blas-transposed-matrix.h:74:8: error: too many template-parameter-lists\n  class TransposedBlasMatrix< TransposedBlasMatrix< Matrix > > : public Matrix{\n      ^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n```\n\nThe first error is due to an unspecified issue with Fedora 28 implementation of *crypt()* or its usage in pyhton 3.6.1.\n\nThe errors in the last two packages, instead, are due to more general issues with the new 8.1 version of gcc.\nPython 2.7.14 fails to build because the way structs are aligned in C was changed in gcc 8.1, as described in https://bugs.python.org/issue33374#msg315857 .\n\n\nLinbox fails to build because it uses a construct previously accepted in gcc 7 that instead produces an error in gcc 8, specifically a templated template specialization done in the following way:\n\n```\ntemplate<>\ntemplate<typename T>\nclass Class1<Type1<T>>{\n...\n}\n```\n\nFor specifics on how the errors are solved by the attached patches, see the sage-devel discussion at https://groups.google.com/forum/#!msg/sage-devel/NgzlZknrizg/o-_Exw8jCAAJ\n\n**crypt.patch** is to be added to python3 package\n**zzz_conf.patch** is to be added to python3 package\n\n**packing.patch** is to be added to python2 package\n\n**multiple_templates.patch** is to be added to linbox package\n\nIssue created by migration from https://trac.sagemath.org/ticket/25391\n\n",
    "created_at": "2018-05-18T05:06:44Z",
    "labels": [
        "component: build",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-duplicate/invalid/wontfix",
    "title": "SageMath fails to build on on Fedora 28 with gcc 8.1",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/25154",
    "user": "https://trac.sagemath.org/admin/accounts/users/Vaush"
}
```
CC:  @dimpase

Keywords: gcc8.1 python3 python2 linbox fedora28 compilation build

SageMath building produces 3 different errors when run on Fedora 28 64bit with  gcc 8.1, specifically when building the packages:
- python 3.6.1
- python 2.7.14
- linbox 1.5.2

The following errors are respectively reported:
- Failure to import the crypt module
- Failure to generate posix vars
- 

```
../../linbox/matrix/densematrix/blas-transposed-matrix.h:74:8: error: too many template-parameter-lists
  class TransposedBlasMatrix< TransposedBlasMatrix< Matrix > > : public Matrix{
      ^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
```

The first error is due to an unspecified issue with Fedora 28 implementation of *crypt()* or its usage in pyhton 3.6.1.

The errors in the last two packages, instead, are due to more general issues with the new 8.1 version of gcc.
Python 2.7.14 fails to build because the way structs are aligned in C was changed in gcc 8.1, as described in https://bugs.python.org/issue33374#msg315857 .


Linbox fails to build because it uses a construct previously accepted in gcc 7 that instead produces an error in gcc 8, specifically a templated template specialization done in the following way:

```
template<>
template<typename T>
class Class1<Type1<T>>{
...
}
```

For specifics on how the errors are solved by the attached patches, see the sage-devel discussion at https://groups.google.com/forum/#!msg/sage-devel/NgzlZknrizg/o-_Exw8jCAAJ

**crypt.patch** is to be added to python3 package
**zzz_conf.patch** is to be added to python3 package

**packing.patch** is to be added to python2 package

**multiple_templates.patch** is to be added to linbox package

Issue created by migration from https://trac.sagemath.org/ticket/25391





---

archive/issue_comments_353831.json:
```json
{
    "body": "Linbox patch",
    "created_at": "2018-05-18T05:07:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25154#issuecomment-353831",
    "user": "https://trac.sagemath.org/admin/accounts/users/Vaush"
}
```

Linbox patch



---

archive/issue_comments_353832.json:
```json
{
    "body": "Attachment [multiple_templates.patch](tarball://root/attachments/some-uuid/ticket25391/multiple_templates.patch) by Vaush created at 2018-05-18 05:09:05\n\nPython2 patch",
    "created_at": "2018-05-18T05:09:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25154#issuecomment-353832",
    "user": "https://trac.sagemath.org/admin/accounts/users/Vaush"
}
```

Attachment [multiple_templates.patch](tarball://root/attachments/some-uuid/ticket25391/multiple_templates.patch) by Vaush created at 2018-05-18 05:09:05

Python2 patch



---

archive/issue_comments_353833.json:
```json
{
    "body": "Attachment [crypt.patch](tarball://root/attachments/some-uuid/ticket25391/crypt.patch) by Vaush created at 2018-05-18 05:09:27\n\nPython3 patch - 1 of 2",
    "created_at": "2018-05-18T05:09:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25154#issuecomment-353833",
    "user": "https://trac.sagemath.org/admin/accounts/users/Vaush"
}
```

Attachment [crypt.patch](tarball://root/attachments/some-uuid/ticket25391/crypt.patch) by Vaush created at 2018-05-18 05:09:27

Python3 patch - 1 of 2



---

archive/issue_comments_353834.json:
```json
{
    "body": "Python3 patch - 2 of 2",
    "created_at": "2018-05-18T05:09:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25154#issuecomment-353834",
    "user": "https://trac.sagemath.org/admin/accounts/users/Vaush"
}
```

Python3 patch - 2 of 2



---

archive/issue_comments_353835.json:
```json
{
    "body": "Attachment [zzz_conf.patch](tarball://root/attachments/some-uuid/ticket25391/zzz_conf.patch) by Vaush created at 2018-05-18 15:05:27",
    "created_at": "2018-05-18T15:05:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25154#issuecomment-353835",
    "user": "https://trac.sagemath.org/admin/accounts/users/Vaush"
}
```

Attachment [zzz_conf.patch](tarball://root/attachments/some-uuid/ticket25391/zzz_conf.patch) by Vaush created at 2018-05-18 15:05:27



---

archive/issue_comments_353836.json:
```json
{
    "body": "I added dependencies to #25204,#25353 which respectively fix the python 2 issue and the linbox (and fflas, which is not described here) issue.\nThe commit to be made will be based on them, and will only modify the python 3 package",
    "created_at": "2018-05-18T15:06:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25154#issuecomment-353836",
    "user": "https://trac.sagemath.org/admin/accounts/users/Vaush"
}
```

I added dependencies to #25204,#25353 which respectively fix the python 2 issue and the linbox (and fflas, which is not described here) issue.
The commit to be made will be based on them, and will only modify the python 3 package



---

archive/issue_comments_353837.json:
```json
{
    "body": "New commits:",
    "created_at": "2018-05-18T15:47:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25154#issuecomment-353837",
    "user": "https://trac.sagemath.org/admin/accounts/users/Vaush"
}
```

New commits:



---

archive/issue_comments_353838.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-05-18T15:47:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25154#issuecomment-353838",
    "user": "https://trac.sagemath.org/admin/accounts/users/Vaush"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_353839.json:
```json
{
    "body": "I'll be checking that this does not break on other systems.",
    "created_at": "2018-05-19T09:01:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25154#issuecomment-353839",
    "user": "https://github.com/dimpase"
}
```

I'll be checking that this does not break on other systems.



---

archive/issue_comments_353840.json:
```json
{
    "body": "Have you run tests on your branch?: `make ptest`\n(or `make ptestlong` for more tests)\n\nThis is something the ticket's author should do in such cases.\n(It would not be surprising if something unrelated to your changes fails, as gcc 8 is pretty much untested, but good to know anyway).",
    "created_at": "2018-05-19T09:44:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25154#issuecomment-353840",
    "user": "https://github.com/dimpase"
}
```

Have you run tests on your branch?: `make ptest`
(or `make ptestlong` for more tests)

This is something the ticket's author should do in such cases.
(It would not be surprising if something unrelated to your changes fails, as gcc 8 is pretty much untested, but good to know anyway).



---

archive/issue_comments_353841.json:
```json
{
    "body": "I haven't, but will do",
    "created_at": "2018-05-19T12:53:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25154#issuecomment-353841",
    "user": "https://trac.sagemath.org/admin/accounts/users/Vaush"
}
```

I haven't, but will do



---

archive/issue_comments_353842.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-05-25T13:01:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25154#issuecomment-353842",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_353843.json:
```json
{
    "body": "What is happening with this on the current 8.3.beta6?\nNote that python2 has been updated.",
    "created_at": "2018-06-20T10:22:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25154#issuecomment-353843",
    "user": "https://github.com/dimpase"
}
```

What is happening with this on the current 8.3.beta6?
Note that python2 has been updated.



---

archive/issue_comments_353844.json:
```json
{
    "body": "For Python3, it's apparently https://github.com/python/cpython/pull/4691 which is still under review.",
    "created_at": "2018-06-20T10:31:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25154#issuecomment-353844",
    "user": "https://github.com/dimpase"
}
```

For Python3, it's apparently https://github.com/python/cpython/pull/4691 which is still under review.



---

archive/issue_comments_353845.json:
```json
{
    "body": "I am missing some context and documentation. The current branch only fixes Python 3. That is not consistent with the ticket description which mentions several packages and doesn't even mention the actual failure that the Python 3 patch is trying to fix.",
    "created_at": "2018-06-20T11:19:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25154#issuecomment-353845",
    "user": "https://github.com/jdemeyer"
}
```

I am missing some context and documentation. The current branch only fixes Python 3. That is not consistent with the ticket description which mentions several packages and doesn't even mention the actual failure that the Python 3 patch is trying to fix.



---

archive/issue_comments_353846.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2018-06-20T11:19:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25154#issuecomment-353846",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_353847.json:
```json
{
    "body": "The patch files should also contain some description, at a minimum a link to the upstream issue.\n\nAnd if you add a patch to a package, you should bump the package version.",
    "created_at": "2018-06-20T11:20:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25154#issuecomment-353847",
    "user": "https://github.com/jdemeyer"
}
```

The patch files should also contain some description, at a minimum a link to the upstream issue.

And if you add a patch to a package, you should bump the package version.



---

archive/issue_comments_353848.json:
```json
{
    "body": "Ok, I'm sorry if the description or the execution aren't up to par, this is my first ticket, so I'm getting used to it.\\\\\nThe ticket was originally opened to describe the bug. After that, I succeeded in manually fixing all the bugs listed in the description, but it was brought to my attention that two of my bugs were solved in separate tickets at the same time (see the dependencies field), so I merged those tickets and added my own fix for python3, thus fixing all the issues and solving the problem stated in the ticket title, that is [SageMath](SageMath) not compiling on Fedora 28 with gcc 8.1.\\\\\nSince the commits include the fixes for the other 2 bugs, even if by merging, I thought this counted as having a fix for all 3 of them in the branch, is this wrong?\\\\\nThere is a description for the python 3 bug, since the bug is literally \"Python tries to call crypt instead of crypt_r on Fedora, and this for some reason breaks things, so let's allow it to call crypt_r\", and the reason why it breaks things is, as pointed out by dimpase, apparently that fedora has a completely different crypt implementation, as can be seen here https://fedoraproject.org/wiki/Changes/Replace_glibc_libcrypt_with_libxcrypt.\\\\\nI'll expand on the description a bit, anyway, to make this clearer, and also to reflect the fact that this ticket only directly fixes the python3 bug, since it's only reported in the comments.\nI'll also quickly add a description and a link to the patch",
    "created_at": "2018-06-20T11:43:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25154#issuecomment-353848",
    "user": "https://trac.sagemath.org/admin/accounts/users/Vaush"
}
```

Ok, I'm sorry if the description or the execution aren't up to par, this is my first ticket, so I'm getting used to it.\\
The ticket was originally opened to describe the bug. After that, I succeeded in manually fixing all the bugs listed in the description, but it was brought to my attention that two of my bugs were solved in separate tickets at the same time (see the dependencies field), so I merged those tickets and added my own fix for python3, thus fixing all the issues and solving the problem stated in the ticket title, that is [SageMath](SageMath) not compiling on Fedora 28 with gcc 8.1.\\
Since the commits include the fixes for the other 2 bugs, even if by merging, I thought this counted as having a fix for all 3 of them in the branch, is this wrong?\\
There is a description for the python 3 bug, since the bug is literally "Python tries to call crypt instead of crypt_r on Fedora, and this for some reason breaks things, so let's allow it to call crypt_r", and the reason why it breaks things is, as pointed out by dimpase, apparently that fedora has a completely different crypt implementation, as can be seen here https://fedoraproject.org/wiki/Changes/Replace_glibc_libcrypt_with_libxcrypt.\\
I'll expand on the description a bit, anyway, to make this clearer, and also to reflect the fact that this ticket only directly fixes the python3 bug, since it's only reported in the comments.
I'll also quickly add a description and a link to the patch



---

archive/issue_comments_353849.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-06-20T12:08:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25154#issuecomment-353849",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_353850.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2018-06-20T13:08:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25154#issuecomment-353850",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_353851.json:
```json
{
    "body": "Changing keywords from \"gcc8.1 python3 python2 linbox fedora28 compilation build\" to \"gcc8.1 python3 fedora28 compilation build\".",
    "created_at": "2018-06-20T13:08:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25154#issuecomment-353851",
    "user": "https://github.com/dimpase"
}
```

Changing keywords from "gcc8.1 python3 python2 linbox fedora28 compilation build" to "gcc8.1 python3 fedora28 compilation build".



---

archive/issue_comments_353852.json:
```json
{
    "body": "Jeroen, how do you feel about merging Python 3 patch which is still being out for reviewing by Python people?",
    "created_at": "2018-06-20T13:08:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25154#issuecomment-353852",
    "user": "https://github.com/dimpase"
}
```

Jeroen, how do you feel about merging Python 3 patch which is still being out for reviewing by Python people?



---

archive/issue_comments_353853.json:
```json
{
    "body": "Replying to [comment:14 Vaush]:\n> Ok, I'm sorry if the description or the execution aren't up to par, this is my first ticket, so I'm getting used to it.\n\n\nAs a general tip: when you fix a bug, it's always important to mention what the bug is. You're certainly not the first one to post a fix for something without even mentioning what that fix is supposed to fix.",
    "created_at": "2018-06-20T14:35:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25154#issuecomment-353853",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:14 Vaush]:
> Ok, I'm sorry if the description or the execution aren't up to par, this is my first ticket, so I'm getting used to it.


As a general tip: when you fix a bug, it's always important to mention what the bug is. You're certainly not the first one to post a fix for something without even mentioning what that fix is supposed to fix.



---

archive/issue_comments_353854.json:
```json
{
    "body": "Do you have a build log of the failed Python 3 build?",
    "created_at": "2018-06-20T14:38:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25154#issuecomment-353854",
    "user": "https://github.com/jdemeyer"
}
```

Do you have a build log of the failed Python 3 build?



---

archive/issue_comments_353855.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2018-06-20T14:38:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25154#issuecomment-353855",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_353856.json:
```json
{
    "body": "Replying to [comment:17 dimpase]:\n> Jeroen, how do you feel about merging Python 3 patch which is still being out for reviewing by Python people?\n\n\nI don't mind in principle. However, I'd very much like to know what the actual bug is that this ticket is supposed to fix.",
    "created_at": "2018-06-20T14:39:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25154#issuecomment-353856",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:17 dimpase]:
> Jeroen, how do you feel about merging Python 3 patch which is still being out for reviewing by Python people?


I don't mind in principle. However, I'd very much like to know what the actual bug is that this ticket is supposed to fix.



---

archive/issue_comments_353857.json:
```json
{
    "body": "I'm attaching the log file of the failed build for python 3, when the patches are not applied.",
    "created_at": "2018-06-20T16:16:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25154#issuecomment-353857",
    "user": "https://trac.sagemath.org/admin/accounts/users/Vaush"
}
```

I'm attaching the log file of the failed build for python 3, when the patches are not applied.



---

archive/issue_comments_353858.json:
```json
{
    "body": "Log of the failed python3 build",
    "created_at": "2018-06-20T16:18:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25154#issuecomment-353858",
    "user": "https://trac.sagemath.org/admin/accounts/users/Vaush"
}
```

Log of the failed python3 build



---

archive/issue_comments_353859.json:
```json
{
    "body": "Attachment [python3-3.6.1.p1.log](tarball://root/attachments/some-uuid/ticket25391/python3-3.6.1.p1.log) by @dimpase created at 2018-06-20 16:26:00\n\nThe log has a number of tries to build python3, only the one at the bottom of the log has this error, see line 32452:\n\n```\nTesting importing of various modules...\nctypes module imported OK\nmath module imported OK\nhashlib module imported OK\n./spkg-build: line 157: 21845 Segmentation fault      (core dumped) $PYTHON -c \"import $module\"\ncrypt module failed to import\nreadline module imported OK\nsocket module imported OK\nError: One or more modules failed to import.\n```\n\nand this is due to\n\n```\nsage/build/python3-3.6.1.p1/src/Modules/_cryptmodule.c: In function 'crypt_crypt_impl':\nsage/build/python3-3.6.1.p1/src/Modules/_cryptmodule.c:39:31: warning: implicit declaration of function 'crypt' [-Wimplicit-function-declaration]\n     return Py_BuildValue(\"s\", crypt(word, salt));\n                               ^~~~~\n```\n\nBasically, there is no `crypt` implementation available in the libraries used, one needs to use another library, and this is done in the branch of this ticket.",
    "created_at": "2018-06-20T16:26:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25154#issuecomment-353859",
    "user": "https://github.com/dimpase"
}
```

Attachment [python3-3.6.1.p1.log](tarball://root/attachments/some-uuid/ticket25391/python3-3.6.1.p1.log) by @dimpase created at 2018-06-20 16:26:00

The log has a number of tries to build python3, only the one at the bottom of the log has this error, see line 32452:

```
Testing importing of various modules...
ctypes module imported OK
math module imported OK
hashlib module imported OK
./spkg-build: line 157: 21845 Segmentation fault      (core dumped) $PYTHON -c "import $module"
crypt module failed to import
readline module imported OK
socket module imported OK
Error: One or more modules failed to import.
```

and this is due to

```
sage/build/python3-3.6.1.p1/src/Modules/_cryptmodule.c: In function 'crypt_crypt_impl':
sage/build/python3-3.6.1.p1/src/Modules/_cryptmodule.c:39:31: warning: implicit declaration of function 'crypt' [-Wimplicit-function-declaration]
     return Py_BuildValue("s", crypt(word, salt));
                               ^~~~~
```

Basically, there is no `crypt` implementation available in the libraries used, one needs to use another library, and this is done in the branch of this ticket.



---

archive/issue_comments_353860.json:
```json
{
    "body": "see also https://bugzilla.redhat.com/show_bug.cgi?id=1576671 (!Redhat/Fedora bug tracker)",
    "created_at": "2018-06-20T16:45:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25154#issuecomment-353860",
    "user": "https://github.com/dimpase"
}
```

see also https://bugzilla.redhat.com/show_bug.cgi?id=1576671 (!Redhat/Fedora bug tracker)



---

archive/issue_comments_353861.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2018-06-20T16:46:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25154#issuecomment-353861",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_353862.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2018-06-21T05:32:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25154#issuecomment-353862",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_353863.json:
```json
{
    "body": "Thanks for the info. It's clear to me now that the bug that we're fixing is a different one from the upstream pull request https://github.com/python/cpython/pull/4691\n\nCan you try if Python 3.7.0 (currently in rc: https://www.python.org/downloads/release/python-370rc1/) by chance fixes it?",
    "created_at": "2018-06-21T05:32:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25154#issuecomment-353863",
    "user": "https://github.com/jdemeyer"
}
```

Thanks for the info. It's clear to me now that the bug that we're fixing is a different one from the upstream pull request https://github.com/python/cpython/pull/4691

Can you try if Python 3.7.0 (currently in rc: https://www.python.org/downloads/release/python-370rc1/) by chance fixes it?



---

archive/issue_comments_353864.json:
```json
{
    "body": "Something else to try is compiling Python 3 without optimization (`-O0`). Can you do that for Python 3.7.0 and post the log file?",
    "created_at": "2018-06-21T05:35:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25154#issuecomment-353864",
    "user": "https://github.com/jdemeyer"
}
```

Something else to try is compiling Python 3 without optimization (`-O0`). Can you do that for Python 3.7.0 and post the log file?



---

archive/issue_comments_353865.json:
```json
{
    "body": "To clarify: the upstream's \u200bhttps://github.com/python/cpython/pull/4691 does not fix a bug, it provides for using `crypt_r` if available. \n\nIt also does a proper handling (introduces `HAVE_CRYPT_H`) of `crypt` and `crypt_r` at the configuration stage---without it there is a reliance on `glibc` providing `crypt` and a header different from `crypt.h` providing a prototype.",
    "created_at": "2018-06-21T06:53:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25154#issuecomment-353865",
    "user": "https://github.com/dimpase"
}
```

To clarify: the upstream's ​https://github.com/python/cpython/pull/4691 does not fix a bug, it provides for using `crypt_r` if available. 

It also does a proper handling (introduces `HAVE_CRYPT_H`) of `crypt` and `crypt_r` at the configuration stage---without it there is a reliance on `glibc` providing `crypt` and a header different from `crypt.h` providing a prototype.



---

archive/issue_comments_353866.json:
```json
{
    "body": "Attachment [crypt_debug.patch](tarball://root/attachments/some-uuid/ticket25391/crypt_debug.patch) by @jdemeyer created at 2018-06-21 08:31:54",
    "created_at": "2018-06-21T08:31:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25154#issuecomment-353866",
    "user": "https://github.com/jdemeyer"
}
```

Attachment [crypt_debug.patch](tarball://root/attachments/some-uuid/ticket25391/crypt_debug.patch) by @jdemeyer created at 2018-06-21 08:31:54



---

archive/issue_comments_353867.json:
```json
{
    "body": "One final thing to try: put the file [attachment:crypt_debug.patch] in `build/pkgs/python3/patches`, rebuild Python 3.6.1 with it and report back what happens.",
    "created_at": "2018-06-21T08:33:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25154#issuecomment-353867",
    "user": "https://github.com/jdemeyer"
}
```

One final thing to try: put the file [attachment:crypt_debug.patch] in `build/pkgs/python3/patches`, rebuild Python 3.6.1 with it and report back what happens.



---

archive/issue_comments_353868.json:
```json
{
    "body": "Replying to [comment:23 dimpase]:\n> and this is due to\n> \n> ```\n> sage/build/python3-3.6.1.p1/src/Modules/_cryptmodule.c: In function 'crypt_crypt_impl':\n> sage/build/python3-3.6.1.p1/src/Modules/_cryptmodule.c:39:31: warning: implicit declaration of function 'crypt' [-Wimplicit-function-declaration]\n>      return Py_BuildValue(\"s\", crypt(word, salt));\n>                                ^~~~~\n> ```\n> \n> Basically, there is no `crypt` implementation available in the libraries used, one needs to use another library, and this is done in the branch of this ticket.\n\n\nI'm not convinced by this argument. If there would no `crypt` implementation, then we would get a linking error (either at compile time or runtime). But in the log file, there is a segmentation fault. So my impression is that `crypt()` is called but that it's causing a crash somehow.",
    "created_at": "2018-06-21T08:43:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25154#issuecomment-353868",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:23 dimpase]:
> and this is due to
> 
> ```
> sage/build/python3-3.6.1.p1/src/Modules/_cryptmodule.c: In function 'crypt_crypt_impl':
> sage/build/python3-3.6.1.p1/src/Modules/_cryptmodule.c:39:31: warning: implicit declaration of function 'crypt' [-Wimplicit-function-declaration]
>      return Py_BuildValue("s", crypt(word, salt));
>                                ^~~~~
> ```
> 
> Basically, there is no `crypt` implementation available in the libraries used, one needs to use another library, and this is done in the branch of this ticket.


I'm not convinced by this argument. If there would no `crypt` implementation, then we would get a linking error (either at compile time or runtime). But in the log file, there is a segmentation fault. So my impression is that `crypt()` is called but that it's causing a crash somehow.



---

archive/issue_comments_353869.json:
```json
{
    "body": "Replying to [comment:30 jdemeyer]:\n> Replying to [comment:23 dimpase]:\n> > and this is due to\n> > \n> > ```\n> > sage/build/python3-3.6.1.p1/src/Modules/_cryptmodule.c: In function 'crypt_crypt_impl':\n> > sage/build/python3-3.6.1.p1/src/Modules/_cryptmodule.c:39:31: warning: implicit declaration of function 'crypt' [-Wimplicit-function-declaration]\n> >      return Py_BuildValue(\"s\", crypt(word, salt));\n> >                                ^~~~~\n> > ```\n> > \n> > Basically, there is no `crypt` implementation available in the libraries used, one needs to use another library, and this is done in the branch of this ticket.\n\n> \n> I'm not convinced by this argument. If there would no `crypt` implementation, then we would get a linking error (either at compile time or runtime). But in the log file, there is a segmentation fault. So my impression is that `crypt()` is called but that it's causing a crash somehow.\n\n\nyou are right, my bad here. Anyhow, `crypt` is called without a prototype.\nOne can in fact make sure that it is called with a prototype, by removing the chunk \nabout using `crypt_r` from the branch on this ticket, i.e. the lines\n\n```\n+@@ -36,7 +41,13 @@\n+ {\n+     /* On some platforms (AtheOS) crypt returns NULL for an invalid\n+        salt. Return None in that case. XXX Maybe raise an exception?  */\n++#ifdef HAVE_CRYPT_R\n++    struct crypt_data data;\n++    data.initialized = 0;\n++    return Py_BuildValue(\"s\", crypt_r(word, salt, &data));\n++#else\n+     return Py_BuildValue(\"s\", crypt(word, salt));\n++#endif\n+ }\n+ \n+ \n```\nperhaps there would be more messages from the compiler then...",
    "created_at": "2018-06-21T08:53:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25154#issuecomment-353869",
    "user": "https://github.com/dimpase"
}
```

Replying to [comment:30 jdemeyer]:
> Replying to [comment:23 dimpase]:
> > and this is due to
> > 
> > ```
> > sage/build/python3-3.6.1.p1/src/Modules/_cryptmodule.c: In function 'crypt_crypt_impl':
> > sage/build/python3-3.6.1.p1/src/Modules/_cryptmodule.c:39:31: warning: implicit declaration of function 'crypt' [-Wimplicit-function-declaration]
> >      return Py_BuildValue("s", crypt(word, salt));
> >                                ^~~~~
> > ```
> > 
> > Basically, there is no `crypt` implementation available in the libraries used, one needs to use another library, and this is done in the branch of this ticket.

> 
> I'm not convinced by this argument. If there would no `crypt` implementation, then we would get a linking error (either at compile time or runtime). But in the log file, there is a segmentation fault. So my impression is that `crypt()` is called but that it's causing a crash somehow.


you are right, my bad here. Anyhow, `crypt` is called without a prototype.
One can in fact make sure that it is called with a prototype, by removing the chunk 
about using `crypt_r` from the branch on this ticket, i.e. the lines

```
+@@ -36,7 +41,13 @@
+ {
+     /* On some platforms (AtheOS) crypt returns NULL for an invalid
+        salt. Return None in that case. XXX Maybe raise an exception?  */
++#ifdef HAVE_CRYPT_R
++    struct crypt_data data;
++    data.initialized = 0;
++    return Py_BuildValue("s", crypt_r(word, salt, &data));
++#else
+     return Py_BuildValue("s", crypt(word, salt));
++#endif
+ }
+ 
+ 
```
perhaps there would be more messages from the compiler then...



---

archive/issue_comments_353870.json:
```json
{
    "body": "I'm sorry for the confusion, I think I can explain what happens (not why, but at least what).\\\\\nThe *crypt()* call goes through perfectly, without issues, and returns a seemingly correct value. This value is then passed to Py_BuildValue and retrieved through varargs, but if one checks the two char* in question, that is the return value of crypt and the one Py_BuildValue retrieves, the latter is almost identical, but with the first 3-4 digits zeroed out. As an example, if crypt returns a pointer to 0xfe5ab234 (I completely made up this address), Py_BuildValue will get a pointer to 0x000ab234, and get illegal memory access when it tries to use it.\\\\\nThe missing prototype is not really a problem, at least it wasn't when I tried, because I tried adding the needed header without success.\\\\\nI want to try python 3.7.0, but are there any major differences one would have to account for, or can I just put the source code in the upstream folder and modify checksum.ini?",
    "created_at": "2018-06-21T09:42:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25154#issuecomment-353870",
    "user": "https://trac.sagemath.org/admin/accounts/users/Vaush"
}
```

I'm sorry for the confusion, I think I can explain what happens (not why, but at least what).\\
The *crypt()* call goes through perfectly, without issues, and returns a seemingly correct value. This value is then passed to Py_BuildValue and retrieved through varargs, but if one checks the two char* in question, that is the return value of crypt and the one Py_BuildValue retrieves, the latter is almost identical, but with the first 3-4 digits zeroed out. As an example, if crypt returns a pointer to 0xfe5ab234 (I completely made up this address), Py_BuildValue will get a pointer to 0x000ab234, and get illegal memory access when it tries to use it.\\
The missing prototype is not really a problem, at least it wasn't when I tried, because I tried adding the needed header without success.\\
I want to try python 3.7.0, but are there any major differences one would have to account for, or can I just put the source code in the upstream folder and modify checksum.ini?



---

archive/issue_comments_353871.json:
```json
{
    "body": "Replying to [comment:32 Vaush]:\n> I'm sorry for the confusion, I think I can explain what happens (not why, but at least what).\\\\\n> The *crypt()* call goes through perfectly, without issues, and returns a seemingly correct value. This value is then passed to Py_BuildValue and retrieved through varargs, but if one checks the two char* in question, that is the return value of crypt and the one Py_BuildValue retrieves, the latter is almost identical, but with the first 3-4 digits zeroed out. As an example, if crypt returns a pointer to 0xfe5ab234 (I completely made up this address), Py_BuildValue will get a pointer to 0x000ab234, and get illegal memory access when it tries to use it.\n\n\nIf that's true, then the error has nothing to with `crypt()` at all and I would expect much more breakage. Can you post the code that you used to come to the conclusion above and the exact results (no \"completely made up\" address!).",
    "created_at": "2018-06-21T09:49:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25154#issuecomment-353871",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:32 Vaush]:
> I'm sorry for the confusion, I think I can explain what happens (not why, but at least what).\\
> The *crypt()* call goes through perfectly, without issues, and returns a seemingly correct value. This value is then passed to Py_BuildValue and retrieved through varargs, but if one checks the two char* in question, that is the return value of crypt and the one Py_BuildValue retrieves, the latter is almost identical, but with the first 3-4 digits zeroed out. As an example, if crypt returns a pointer to 0xfe5ab234 (I completely made up this address), Py_BuildValue will get a pointer to 0x000ab234, and get illegal memory access when it tries to use it.


If that's true, then the error has nothing to with `crypt()` at all and I would expect much more breakage. Can you post the code that you used to come to the conclusion above and the exact results (no "completely made up" address!).



---

archive/issue_comments_353872.json:
```json
{
    "body": "Replying to [comment:32 Vaush]:\n> I want to try python 3.7.0, but are there any major differences one would have to account for, or can I just put the source code in the upstream folder and modify checksum.ini?\n\n\nI don't think anybody has tried. I guess what you said should just work.",
    "created_at": "2018-06-21T09:50:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25154#issuecomment-353872",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:32 Vaush]:
> I want to try python 3.7.0, but are there any major differences one would have to account for, or can I just put the source code in the upstream folder and modify checksum.ini?


I don't think anybody has tried. I guess what you said should just work.



---

archive/issue_comments_353873.json:
```json
{
    "body": "I can't post the code because I didn't use any, I just stepped through the code with gdb. I checked the stack trace for the segfault, set a breakpoint to the line that called the function which calls crypt, and then stepped through manually to understand what was happening.\\\\\nI can try and get some proof from gdb later in the day, but there's not much more I can do.",
    "created_at": "2018-06-21T09:54:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25154#issuecomment-353873",
    "user": "https://trac.sagemath.org/admin/accounts/users/Vaush"
}
```

I can't post the code because I didn't use any, I just stepped through the code with gdb. I checked the stack trace for the segfault, set a breakpoint to the line that called the function which calls crypt, and then stepped through manually to understand what was happening.\\
I can try and get some proof from gdb later in the day, but there's not much more I can do.



---

archive/issue_comments_353874.json:
```json
{
    "body": "Replying to [comment:35 Vaush]:\n> I can't post the code because I didn't use any, I just stepped through the code with gdb. I checked the stack trace for the segfault, set a breakpoint to the line that called the function which calls crypt, and then stepped through manually to understand what was happening.\\\\\n> I can try and get some proof from gdb later in the day, but there's not much more I can do. \n\n\nMy understanding is that `crypt` returns a pointer to a statically allocated location. Indeed, its man page says: `return value points to static data whose content is overwritten by each call`.\nWhereas `crypt_r` does something else, as such design as for `crypt` is not thread-safe.\n\nPerhaps this unusual design of `crypt` is the reason the breakage is not bigger?",
    "created_at": "2018-06-21T10:26:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25154#issuecomment-353874",
    "user": "https://github.com/dimpase"
}
```

Replying to [comment:35 Vaush]:
> I can't post the code because I didn't use any, I just stepped through the code with gdb. I checked the stack trace for the segfault, set a breakpoint to the line that called the function which calls crypt, and then stepped through manually to understand what was happening.\\
> I can try and get some proof from gdb later in the day, but there's not much more I can do. 


My understanding is that `crypt` returns a pointer to a statically allocated location. Indeed, its man page says: `return value points to static data whose content is overwritten by each call`.
Whereas `crypt_r` does something else, as such design as for `crypt` is not thread-safe.

Perhaps this unusual design of `crypt` is the reason the breakage is not bigger?



---

archive/issue_comments_353875.json:
```json
{
    "body": "In fact,  the call to `Py_BuildValue`  is\n\n```\nreturn Py_BuildValue(\"s\", crypt(word, salt));\n```\n(where we see a warning in the logs).\n\nHere `\"s\"` stands for [string](https://docs.python.org/3/c-api/arg.html) \nIt would be very interesting to see what values of `word` and `salt` are used.\nOtherwise what length it assumes by default is anyone's guess (perhaps that's why you see some bits chopped off). Indeed, it does\n\n```\nConvert a null-terminated C string to a Python str object using 'utf-8' encoding. \n```\n\nNote that Python 2 does not do `utf-8` here, so this might be a problem.\n \nHow about you try modifying the patch as I suggest in comment 31 (removing `crypt_r`-related  chunk)? This would call `crypt`, but supply a correct prototype.",
    "created_at": "2018-06-21T10:57:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25154#issuecomment-353875",
    "user": "https://github.com/dimpase"
}
```

In fact,  the call to `Py_BuildValue`  is

```
return Py_BuildValue("s", crypt(word, salt));
```
(where we see a warning in the logs).

Here `"s"` stands for [string](https://docs.python.org/3/c-api/arg.html) 
It would be very interesting to see what values of `word` and `salt` are used.
Otherwise what length it assumes by default is anyone's guess (perhaps that's why you see some bits chopped off). Indeed, it does

```
Convert a null-terminated C string to a Python str object using 'utf-8' encoding. 
```

Note that Python 2 does not do `utf-8` here, so this might be a problem.
 
How about you try modifying the patch as I suggest in comment 31 (removing `crypt_r`-related  chunk)? This would call `crypt`, but supply a correct prototype.



---

archive/issue_comments_353876.json:
```json
{
    "body": "I can do that later if you want, but it's not the string that gets chopped, it's the string's address.",
    "created_at": "2018-06-21T10:59:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25154#issuecomment-353876",
    "user": "https://trac.sagemath.org/admin/accounts/users/Vaush"
}
```

I can do that later if you want, but it's not the string that gets chopped, it's the string's address.



---

archive/issue_comments_353877.json:
```json
{
    "body": "What I don't know is what is supposed to happen on the import attempt. Does `crypt` get called at all? This does not seem to be necessary, as the import is about setting up a structure to call `crypt` from Python, not about calling it with any values.\n\nDid you see crypt actually being called? And with what values of `word` and `salt`?\nThis is something that is totally unclear. If they are set to bad values, or just left uninitialised, stuff can happen...",
    "created_at": "2018-06-21T11:16:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25154#issuecomment-353877",
    "user": "https://github.com/dimpase"
}
```

What I don't know is what is supposed to happen on the import attempt. Does `crypt` get called at all? This does not seem to be necessary, as the import is about setting up a structure to call `crypt` from Python, not about calling it with any values.

Did you see crypt actually being called? And with what values of `word` and `salt`?
This is something that is totally unclear. If they are set to bad values, or just left uninitialised, stuff can happen...



---

archive/issue_comments_353878.json:
```json
{
    "body": "I remember them being set up correctly, and the call worked. Still, I am recompiling the whole of sage with debug symbols, I'll step through it again and report when I have news",
    "created_at": "2018-06-21T11:26:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25154#issuecomment-353878",
    "user": "https://trac.sagemath.org/admin/accounts/users/Vaush"
}
```

I remember them being set up correctly, and the call worked. Still, I am recompiling the whole of sage with debug symbols, I'll step through it again and report when I have news



---

archive/issue_comments_353879.json:
```json
{
    "body": "Replying to [comment:35 Vaush]:\n> and then stepped through manually to understand what was happening.\n\n\nPosting the actual output from gdb would have been useful here...",
    "created_at": "2018-06-21T11:33:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25154#issuecomment-353879",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:35 Vaush]:
> and then stepped through manually to understand what was happening.


Posting the actual output from gdb would have been useful here...



---

archive/issue_comments_353880.json:
```json
{
    "body": "Replying to [comment:37 dimpase]:\n> Here `\"s\"` stands for [string](https://docs.python.org/3/c-api/arg.html) \n> It would be very interesting to see what values of `word` and `salt` are used.\n\n\nThat's what my debugging patch [attachment:crypt_debug.patch] does.",
    "created_at": "2018-06-21T11:34:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25154#issuecomment-353880",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:37 dimpase]:
> Here `"s"` stands for [string](https://docs.python.org/3/c-api/arg.html) 
> It would be very interesting to see what values of `word` and `salt` are used.


That's what my debugging patch [attachment:crypt_debug.patch] does.



---

archive/issue_comments_353881.json:
```json
{
    "body": "Replying to [comment:41 jdemeyer]:\n> Replying to [comment:35 Vaush]:\n> > and then stepped through manually to understand what was happening.\n\n> \n> Posting the actual output from gdb would have been useful here...\n\nYes, the point is that I don't have it anymore, since I did that 2 or 3 weeks ago. As I said, I am now recompiling sage with debug symbols to redo it and post the output.",
    "created_at": "2018-06-21T11:35:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25154#issuecomment-353881",
    "user": "https://trac.sagemath.org/admin/accounts/users/Vaush"
}
```

Replying to [comment:41 jdemeyer]:
> Replying to [comment:35 Vaush]:
> > and then stepped through manually to understand what was happening.

> 
> Posting the actual output from gdb would have been useful here...

Yes, the point is that I don't have it anymore, since I did that 2 or 3 weeks ago. As I said, I am now recompiling sage with debug symbols to redo it and post the output.



---

archive/issue_comments_353882.json:
```json
{
    "body": "Attachment [gdb_screenshot.png](tarball://root/attachments/some-uuid/ticket25391/gdb_screenshot.png) by Vaush created at 2018-06-21 13:45:18\n\nScreenshot of gdb's output",
    "created_at": "2018-06-21T13:45:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25154#issuecomment-353882",
    "user": "https://trac.sagemath.org/admin/accounts/users/Vaush"
}
```

Attachment [gdb_screenshot.png](tarball://root/attachments/some-uuid/ticket25391/gdb_screenshot.png) by Vaush created at 2018-06-21 13:45:18

Screenshot of gdb's output



---

archive/issue_comments_353883.json:
```json
{
    "body": "Ok, for some reason I can't seem to step into crypt anymore, while earlier I could see the fact that crypt on my system was a wrap around crypt_r.\\\\\nAnyway, I used jdemeyer's patch, and I'm attaching gdb's output.\\\\\nWhat happens is that Python now segfaults on the printing attempt.\nI don't have any way of confirming what I said earlier about the value being returned by crypt being fine, but causing segfaults when accessed outside of it.\\\\",
    "created_at": "2018-06-21T13:45:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25154#issuecomment-353883",
    "user": "https://trac.sagemath.org/admin/accounts/users/Vaush"
}
```

Ok, for some reason I can't seem to step into crypt anymore, while earlier I could see the fact that crypt on my system was a wrap around crypt_r.\\
Anyway, I used jdemeyer's patch, and I'm attaching gdb's output.\\
What happens is that Python now segfaults on the printing attempt.
I don't have any way of confirming what I said earlier about the value being returned by crypt being fine, but causing segfaults when accessed outside of it.\\



---

archive/issue_comments_353884.json:
```json
{
    "body": "Could you post the output of ldd called on the corresponding *.so file?\n\nDid you use a custom-built crypt library at your 1st attempt?\n\nAnd, finally, could you add a print to show the value of the pointer `res`\nbefore the print that causes the crash? (E.g. it could return NULL, or some\nobviously invalid value...)",
    "created_at": "2018-06-21T14:13:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25154#issuecomment-353884",
    "user": "https://github.com/dimpase"
}
```

Could you post the output of ldd called on the corresponding *.so file?

Did you use a custom-built crypt library at your 1st attempt?

And, finally, could you add a print to show the value of the pointer `res`
before the print that causes the crash? (E.g. it could return NULL, or some
obviously invalid value...)



---

archive/issue_comments_353885.json:
```json
{
    "body": "I don't remember using any custom-built library, so the answer would be no.\\\\\nThis is the output of ldd on the built python executable and on libcrypt:\n\n```\n[vaush@jesu-c290 src]$ ldd /lib64/libcrypt.so.1\n\tlinux-vdso.so.1 (0x00007ffe913d6000)\n\tlibc.so.6 => /lib64/libc.so.6 (0x00007f32ada5e000)\n\t/lib64/ld-linux-x86-64.so.2 (0x00007f32ae046000)\n[vaush@jesu-c290 src]$ ldd ./python\n\tlinux-vdso.so.1 (0x00007ffd247ec000)\n\tlibpython3.6dm.so.1.0 => not found\n\tlibpthread.so.0 => /lib64/libpthread.so.0 (0x00007fd8b8512000)\n\tlibdl.so.2 => /lib64/libdl.so.2 (0x00007fd8b830e000)\n\tlibutil.so.1 => /lib64/libutil.so.1 (0x00007fd8b810b000)\n\tlibm.so.6 => /lib64/libm.so.6 (0x00007fd8b7d77000)\n\tlibc.so.6 => /lib64/libc.so.6 (0x00007fd8b79b8000)\n\t/lib64/ld-linux-x86-64.so.2 (0x00007fd8b8731000)\n\n```\nFinally, no, I can't print anything about it, unless you mean before the return value of crypt is assigned to it, since we introduced it with jdemeyer's patch.",
    "created_at": "2018-06-21T14:32:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25154#issuecomment-353885",
    "user": "https://trac.sagemath.org/admin/accounts/users/Vaush"
}
```

I don't remember using any custom-built library, so the answer would be no.\\
This is the output of ldd on the built python executable and on libcrypt:

```
[vaush@jesu-c290 src]$ ldd /lib64/libcrypt.so.1
	linux-vdso.so.1 (0x00007ffe913d6000)
	libc.so.6 => /lib64/libc.so.6 (0x00007f32ada5e000)
	/lib64/ld-linux-x86-64.so.2 (0x00007f32ae046000)
[vaush@jesu-c290 src]$ ldd ./python
	linux-vdso.so.1 (0x00007ffd247ec000)
	libpython3.6dm.so.1.0 => not found
	libpthread.so.0 => /lib64/libpthread.so.0 (0x00007fd8b8512000)
	libdl.so.2 => /lib64/libdl.so.2 (0x00007fd8b830e000)
	libutil.so.1 => /lib64/libutil.so.1 (0x00007fd8b810b000)
	libm.so.6 => /lib64/libm.so.6 (0x00007fd8b7d77000)
	libc.so.6 => /lib64/libc.so.6 (0x00007fd8b79b8000)
	/lib64/ld-linux-x86-64.so.2 (0x00007fd8b8731000)

```
Finally, no, I can't print anything about it, unless you mean before the return value of crypt is assigned to it, since we introduced it with jdemeyer's patch.



---

archive/issue_comments_353886.json:
```json
{
    "body": "Replying to [comment:46 Vaush]:\n> I don't remember using any custom-built library, so the answer would be no.\\\\\n> This is the output of ldd on the built python executable and on libcrypt:\n\n\nno, I mean the crypt.*.so or _crypt.*.so or whatever it is called; on one system I have it's here:\n\n```\n$ ldd local/lib/python3.6/lib-dynload/_crypt.cpython-36m-x86_64-linux-gnu.so\n        linux-vdso.so.1 =>  (0x00007fffdff5e000)\n        libcrypt.so.1 => /lib/x86_64-linux-gnu/libcrypt.so.1 (0x00007da738262000)\n        libpython3.6m.so.1.0 => /home/dima/sagetrac-mirror/local/lib/libpython3.6m.so.1.0 (0x00007da737d32000)\n        libpthread.so.0 => /lib/x86_64-linux-gnu/libpthread.so.0 (0x00007da737b15000)\n        libc.so.6 => /lib/x86_64-linux-gnu/libc.so.6 (0x00007da73774b000)\n        libdl.so.2 => /lib/x86_64-linux-gnu/libdl.so.2 (0x00007da737547000)\n        libutil.so.1 => /lib/x86_64-linux-gnu/libutil.so.1 (0x00007da737344000)\n        libm.so.6 => /lib/x86_64-linux-gnu/libm.so.6 (0x00007da73703b000)\n        /lib64/ld-linux-x86-64.so.2 (0x00007da73869c000)\n```\n\n\n> Finally, no, I can't print anything about it, unless you mean before the return value of crypt is assigned to it, since we introduced it with jdemeyer's patch.\n\n\nI meant, certainly, that you modify Jeroen's patch so that you print the **value** of the\npointer `res` (i.e. the address) after the call to crypt(), before printing the \nstring it points to (the latter print crashes).",
    "created_at": "2018-06-21T14:54:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25154#issuecomment-353886",
    "user": "https://github.com/dimpase"
}
```

Replying to [comment:46 Vaush]:
> I don't remember using any custom-built library, so the answer would be no.\\
> This is the output of ldd on the built python executable and on libcrypt:


no, I mean the crypt.*.so or _crypt.*.so or whatever it is called; on one system I have it's here:

```
$ ldd local/lib/python3.6/lib-dynload/_crypt.cpython-36m-x86_64-linux-gnu.so
        linux-vdso.so.1 =>  (0x00007fffdff5e000)
        libcrypt.so.1 => /lib/x86_64-linux-gnu/libcrypt.so.1 (0x00007da738262000)
        libpython3.6m.so.1.0 => /home/dima/sagetrac-mirror/local/lib/libpython3.6m.so.1.0 (0x00007da737d32000)
        libpthread.so.0 => /lib/x86_64-linux-gnu/libpthread.so.0 (0x00007da737b15000)
        libc.so.6 => /lib/x86_64-linux-gnu/libc.so.6 (0x00007da73774b000)
        libdl.so.2 => /lib/x86_64-linux-gnu/libdl.so.2 (0x00007da737547000)
        libutil.so.1 => /lib/x86_64-linux-gnu/libutil.so.1 (0x00007da737344000)
        libm.so.6 => /lib/x86_64-linux-gnu/libm.so.6 (0x00007da73703b000)
        /lib64/ld-linux-x86-64.so.2 (0x00007da73869c000)
```


> Finally, no, I can't print anything about it, unless you mean before the return value of crypt is assigned to it, since we introduced it with jdemeyer's patch.


I meant, certainly, that you modify Jeroen's patch so that you print the **value** of the
pointer `res` (i.e. the address) after the call to crypt(), before printing the 
string it points to (the latter print crashes).



---

archive/issue_comments_353887.json:
```json
{
    "body": "Ok, sorry for the misunderstandings.\\\\\nHere is the output of ldd:\n\n```\nvaush@jesu-c290:src$ ldd build/lib.linux-x86_64-3.6-pydebug/_crypt.cpython-36dm-x86_64-linux-gnu.so\n\tlinux-vdso.so.1 (0x00007ffeca7f6000)\n\tlibcrypt.so.1 => /lib64/libcrypt.so.1 (0x00007fe30d625000)\n\tlibpython3.6dm.so.1.0 => /run/media/vaush/SageMath/SageMath/local/var/tmp/sage/build/python3-3.6.1.p1/src/libpython3.6dm.so.1.0 (0x00007fe30d0c4000)\n\tlibpthread.so.0 => /lib64/libpthread.so.0 (0x00007fe30cea5000)\n\tlibc.so.6 => /lib64/libc.so.6 (0x00007fe30cae6000)\n\tlibdl.so.2 => /lib64/libdl.so.2 (0x00007fe30c8e2000)\n\tlibutil.so.1 => /lib64/libutil.so.1 (0x00007fe30c6df000)\n\tlibm.so.6 => /lib64/libm.so.6 (0x00007fe30c34b000)\n\t/lib64/ld-linux-x86-64.so.2 (0x00007fe30da50000)\n\n```\nWhile now python outputs this during compilation:\n\n```\n[python3-3.6.1.p1] crypt('', '$6$Ukf2OXfG3jHYFFCX')\n[python3-3.6.1.p1] Address = '0xc4c020'\n\n```\nAs you can see, the address is compatible with the theory I presented, that in some way the value of the pointer gets chopped when coming out of crypt. Still no success in stepping into crypt, but I don't see why, it was so easy the first time around...",
    "created_at": "2018-06-21T15:09:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25154#issuecomment-353887",
    "user": "https://trac.sagemath.org/admin/accounts/users/Vaush"
}
```

Ok, sorry for the misunderstandings.\\
Here is the output of ldd:

```
vaush@jesu-c290:src$ ldd build/lib.linux-x86_64-3.6-pydebug/_crypt.cpython-36dm-x86_64-linux-gnu.so
	linux-vdso.so.1 (0x00007ffeca7f6000)
	libcrypt.so.1 => /lib64/libcrypt.so.1 (0x00007fe30d625000)
	libpython3.6dm.so.1.0 => /run/media/vaush/SageMath/SageMath/local/var/tmp/sage/build/python3-3.6.1.p1/src/libpython3.6dm.so.1.0 (0x00007fe30d0c4000)
	libpthread.so.0 => /lib64/libpthread.so.0 (0x00007fe30cea5000)
	libc.so.6 => /lib64/libc.so.6 (0x00007fe30cae6000)
	libdl.so.2 => /lib64/libdl.so.2 (0x00007fe30c8e2000)
	libutil.so.1 => /lib64/libutil.so.1 (0x00007fe30c6df000)
	libm.so.6 => /lib64/libm.so.6 (0x00007fe30c34b000)
	/lib64/ld-linux-x86-64.so.2 (0x00007fe30da50000)

```
While now python outputs this during compilation:

```
[python3-3.6.1.p1] crypt('', '$6$Ukf2OXfG3jHYFFCX')
[python3-3.6.1.p1] Address = '0xc4c020'

```
As you can see, the address is compatible with the theory I presented, that in some way the value of the pointer gets chopped when coming out of crypt. Still no success in stepping into crypt, but I don't see why, it was so easy the first time around...



---

archive/issue_comments_353888.json:
```json
{
    "body": "Replying to [comment:48 Vaush]:\n> Still no success in stepping into crypt, but I don't see why, it was so easy the first time around...\n\n\nI don't see how you'd step in a system library in a meaningful way - they usually are stripped, you won't see any symbols.\n\nHave a look at https://fedoraproject.org/wiki/StackTraces#Installing_debuginfo_RPMs_using_DNF",
    "created_at": "2018-06-21T17:11:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25154#issuecomment-353888",
    "user": "https://github.com/dimpase"
}
```

Replying to [comment:48 Vaush]:
> Still no success in stepping into crypt, but I don't see why, it was so easy the first time around...


I don't see how you'd step in a system library in a meaningful way - they usually are stripped, you won't see any symbols.

Have a look at https://fedoraproject.org/wiki/StackTraces#Installing_debuginfo_RPMs_using_DNF



---

archive/issue_comments_353889.json:
```json
{
    "body": "I installed the debug infos already, to no avail.\nAnyway, I know that it shouldn't be possible, but the first time around I just naively did it, and stepped into the function in some way",
    "created_at": "2018-06-21T19:17:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25154#issuecomment-353889",
    "user": "https://trac.sagemath.org/admin/accounts/users/Vaush"
}
```

I installed the debug infos already, to no avail.
Anyway, I know that it shouldn't be possible, but the first time around I just naively did it, and stepped into the function in some way



---

archive/issue_comments_353890.json:
```json
{
    "body": "I have a theory. The `implicit declaration of function 'crypt'` warning causes GCC to guess the return type as `int` (which is 32 bits). Now in reality the return type is `char *` (64 bits). So that might explain the zeroed bits.\n\nIf this theory is correct, then simply adding\n\n```\n#include <crypt.h>\n```\nshould fix the problem.\n\nCould you try just adding that line to `_cryptmodule.c`?",
    "created_at": "2018-06-21T19:40:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25154#issuecomment-353890",
    "user": "https://github.com/jdemeyer"
}
```

I have a theory. The `implicit declaration of function 'crypt'` warning causes GCC to guess the return type as `int` (which is 32 bits). Now in reality the return type is `char *` (64 bits). So that might explain the zeroed bits.

If this theory is correct, then simply adding

```
#include <crypt.h>
```
should fix the problem.

Could you try just adding that line to `_cryptmodule.c`?



---

archive/issue_comments_353891.json:
```json
{
    "body": "Replying to [comment:51 jdemeyer]:\n> I have a theory. The `implicit declaration of function 'crypt'` warning causes GCC to guess the return type as `int` (which is 32 bits). Now in reality the return type is `char *` (64 bits). So that might explain the zeroed bits.\n> \n> If this theory is correct, then simply adding\n> \n> ```\n> #include <crypt.h>\n> ```\n> should fix the problem.\n> \n> Could you try just adding that line to `_cryptmodule.c`?\n\n\nOr, as I have been saying already, just change the patch you are adding so that it drops `crypt_r` chunk, as it would be precisely the same thing...\nAnyhow, this theory is easy to confirm:\n\n```\n/* cry.c */\n#include <stdio.h>\n#ifdef CRYP\n#include <crypt.h>\n#endif\nint main()\n{\nchar *word=\"blah\";\nchar *salt=\"foo\";\nchar *res;\nres = crypt(word, salt);\nprintf(\"%s\\n\",res);\nreturn 0;\n}\n```\nNow trying this out, with the right include:\n\n```\n$ gcc -DCRYP cry.c -lcrypt\n$ ./a.out \nfo9NXBQQtNBSA\n```\nand without include\n\n```\n$ gcc cry.c -lcrypt\ncry.c: In function \u2018main\u2019:\ncry.c:10:7: warning: implicit declaration of function \u2018crypt\u2019 [-Wimplicit-function-declaration]\n res = crypt(word, salt);\n       ^~~~~\ncry.c:10:5: warning: assignment makes pointer from integer without a cast [-Wint-conversion]\n res = crypt(word, salt);\n     ^\n$ ./a.out \nSegmentation fault\n```\n\nMorale: pay attention to compiler warnings :-)",
    "created_at": "2018-06-22T00:35:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25154#issuecomment-353891",
    "user": "https://github.com/dimpase"
}
```

Replying to [comment:51 jdemeyer]:
> I have a theory. The `implicit declaration of function 'crypt'` warning causes GCC to guess the return type as `int` (which is 32 bits). Now in reality the return type is `char *` (64 bits). So that might explain the zeroed bits.
> 
> If this theory is correct, then simply adding
> 
> ```
> #include <crypt.h>
> ```
> should fix the problem.
> 
> Could you try just adding that line to `_cryptmodule.c`?


Or, as I have been saying already, just change the patch you are adding so that it drops `crypt_r` chunk, as it would be precisely the same thing...
Anyhow, this theory is easy to confirm:

```
/* cry.c */
#include <stdio.h>
#ifdef CRYP
#include <crypt.h>
#endif
int main()
{
char *word="blah";
char *salt="foo";
char *res;
res = crypt(word, salt);
printf("%s\n",res);
return 0;
}
```
Now trying this out, with the right include:

```
$ gcc -DCRYP cry.c -lcrypt
$ ./a.out 
fo9NXBQQtNBSA
```
and without include

```
$ gcc cry.c -lcrypt
cry.c: In function ‘main’:
cry.c:10:7: warning: implicit declaration of function ‘crypt’ [-Wimplicit-function-declaration]
 res = crypt(word, salt);
       ^~~~~
cry.c:10:5: warning: assignment makes pointer from integer without a cast [-Wint-conversion]
 res = crypt(word, salt);
     ^
$ ./a.out 
Segmentation fault
```

Morale: pay attention to compiler warnings :-)



---

archive/issue_comments_353892.json:
```json
{
    "body": "Replying to [comment:52 dimpase]:\n> Morale: pay attention to compiler warnings :-)\n\n\nAbsolutely. I was totally confused earlier because the upstream PR incorrectly states \"Because crypt() only depends on primitive C types, we currently get\naway with calling it without it being declared.\"",
    "created_at": "2018-06-22T05:18:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25154#issuecomment-353892",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:52 dimpase]:
> Morale: pay attention to compiler warnings :-)


Absolutely. I was totally confused earlier because the upstream PR incorrectly states "Because crypt() only depends on primitive C types, we currently get
away with calling it without it being declared."



---

archive/issue_comments_353893.json:
```json
{
    "body": "This should be fixed in 3.7.0, so we should just upgrade when that version comes out.",
    "created_at": "2018-06-22T07:57:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25154#issuecomment-353893",
    "user": "https://github.com/jdemeyer"
}
```

This should be fixed in 3.7.0, so we should just upgrade when that version comes out.



---

archive/issue_events_063756.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2018-06-22T07:57:34Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/25154",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/25154#event-63756"
}
```



---

archive/issue_comments_353894.json:
```json
{
    "body": "Resolution: duplicate",
    "created_at": "2018-06-22T07:57:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25154#issuecomment-353894",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: duplicate



---

archive/issue_events_063757.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2018-06-22T07:57:34Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/25154",
    "milestone": "sage-duplicate/invalid/wontfix",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/25154#event-63757"
}
```



---

archive/issue_comments_353895.json:
```json
{
    "body": "I made #25771 to update to Python 3.6.6 which contains the backported crypt fix",
    "created_at": "2018-07-04T14:53:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25154#issuecomment-353895",
    "user": "https://github.com/vbraun"
}
```

I made #25771 to update to Python 3.6.6 which contains the backported crypt fix
