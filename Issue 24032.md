# Issue 24032: py3: first pass at getting pexpect interfaces working (gap + maxima)

Issue created by migration from https://trac.sagemath.org/ticket/24269

Original creator: embray

Original creation time: 2017-11-22 16:02:22

Keywords: gap maxima

With these changes, at the very least, I was able to get 1+1 working:


```
sage: gap('1+1;')
2
sage: maxima('1+1;')
2
```


However, see #24268 for further discussion.


---

Comment by embray created at 2017-11-27 10:35:29

Changing status from new to needs_review.


---

Comment by git created at 2018-01-22 16:11:27

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2018-01-29 14:19:10

Comment in `sagespawn.pyx` is no longer correct. There is also a typo `targt`


---

Comment by jdemeyer created at 2018-01-29 14:19:10

Changing status from needs_review to needs_work.


---

Comment by embray created at 2018-01-30 11:35:46

Oh right--this commit is actually rather old at this point. I will just update the comment, rebase this, and squash.


---

Comment by git created at 2018-02-02 10:21:31

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by embray created at 2018-02-02 10:23:11

Changing status from needs_work to needs_review.


---

Comment by embray created at 2018-02-02 10:23:11

Fixed the comment in `SagePtyProcess`.  Not super happy with how loosely encodings are being used in the expect interfaces currently, but at the same time the vast majority of the text going in and out of them is ASCII anyways.  This is just a first pass.


---

Comment by chapoton created at 2018-02-17 15:11:47

Looks good to me. But I am a bit surprised by all these added `b` to turn strings to bytes..


---

Comment by git created at 2018-02-19 17:51:01

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2018-02-20 14:11:07

In principle this commit is good, but I'd to know what your overall strategy is to deal with pexpect interfaces. Right now, it seems that you just plan to add explicit conversions between `bytes` and `str` everywhere. If pexpect only deals with `bytes`, perhaps we should write some specific methods to encode/decode to `str` and use those specific methods?


---

Comment by embray created at 2018-02-20 17:08:24

I made #24268 for discussing overall strategy, but as you can see from this ticket and others the strategy I've gone with for now is leaving pexpect to deal in bytes, and sprinkle conversions all around.  I'm not particularly happy with this strategy and fear that it might backfire.

Adding specific methods might not be a bad idea, and I've considered it. The `Expect` class (seemingly inexplicably) has a `_before()` method which just returns the `.before` attribute.  It's used in just a handful of places, and most other interfaces use `self._expect.before` directly.

It might make more sense to get rid of `Expect._before` but add an `Expect.before` property that wraps `self._expect.before` with the relevant string conversion (and likewise for `after`).  That might be a start in a better direction, anyways...


---

Comment by git created at 2018-03-12 12:35:16

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by embray created at 2018-03-12 12:36:04

Reworked this a bit on top of #24957 which simplifies things a bit, reducing the number of manual `bytes_to_str` calls.


---

Comment by git created at 2018-03-13 15:01:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2018-03-13 15:02:18

Added a commit from my big python3 branch that really should have been included here (without it the fixes in this ticket actually crashed at sage startup).


---

Comment by chapoton created at 2018-03-28 14:56:50

The patchbots report a doctest failure in singular expect interface.


---

Comment by embray created at 2018-03-28 16:38:05

There's just a missing line in the doctest I added.


---

Comment by git created at 2018-03-28 16:43:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2018-05-17 08:47:49

We should really move on here now..


---

Comment by embray created at 2018-05-17 15:48:21

Okay? I agree...  Is there anything this still needs?


---

Comment by chapoton created at 2018-05-17 15:49:29

For me, its ok. Though I have not tried it with python3.

Jeroen, do you have some comments ?


---

Comment by chapoton created at 2018-05-20 07:11:02

rebased on 8.3.b2
----
New commits:


---

Comment by chapoton created at 2018-05-20 10:01:22

I have checked that this does fix the broken start of sage with py3.


---

Comment by chapoton created at 2018-05-20 10:10:51

But not quite doing as well as promised:

```
sage: gap('1+1;')
2
sage: maxima('1+1;')
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/interfaces/expect.py in eval(self, code, strip, synchronize, locals, allow_use_file, split_lines, **kwds)
   1355                     return '\n'.join([self._eval_line(L, allow_use_file=allow_use_file, **kwds)
-> 1356                                         for L in code.split('\n') if L != ''])
   1357                 else:

/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/interfaces/expect.py in <listcomp>(.0)
   1355                     return '\n'.join([self._eval_line(L, allow_use_file=allow_use_file, **kwds)
-> 1356                                         for L in code.split('\n') if L != ''])
   1357                 else:

/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/interfaces/maxima.py in _eval_line(self, line, allow_use_file, wait_for_prompt, reformat, error_check, restart_if_needed)
    783 
--> 784         self._synchronize()
    785 

/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/interfaces/maxima.py in _synchronize(self)
    853                 self._expect_expr(timeout=0.5)
--> 854                 if not s in bytes_to_str(self._before()):
    855                     self._expect_expr(s,timeout=0.5)

/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/cpython/string.pxd in sage.cpython.string.bytes_to_str (build/cythonized/sage/cpython/string.c:1556)()

/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/cpython/string.pxd in sage.cpython.string.bytes_to_str (build/cythonized/sage/cpython/string.c:1410)()

TypeError: expected bytes, str found

During handling of the above exception, another exception occurred:

TypeError                                 Traceback (most recent call last)
<ipython-input-2-e25f09e1dc17> in <module>()
----> 1 maxima('1+1;')

/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/interfaces/interface.py in __call__(self, x, name)
    278 
    279         if isinstance(x, string_types):
--> 280             return cls(self, x, name=name)
    281         try:
    282             return self._coerce_from_special_method(x)

/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/interfaces/maxima.py in __init__(self, parent, value, is_name, name)
   1168             True
   1169         """
-> 1170         ExpectElement.__init__(self, parent, value, is_name=False, name=None)
   1171 
   1172     def display2d(self, onscreen=True):

/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/interfaces/expect.py in __init__(self, parent, value, is_name, name)
   1440         else:
   1441             try:
-> 1442                 self._name = parent._create(value, name=name)
   1443             # Convert ValueError and RuntimeError to TypeError for
   1444             # coercion to work properly.

/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/interfaces/interface.py in _create(self, value, name)
    474     def _create(self, value, name=None):
    475         name = self._next_var_name() if name is None else name
--> 476         self.set(name, value)
    477         return name
    478 

/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/interfaces/maxima.py in set(self, var, value)
   1013             self._batch(cmd, batchload=True)
   1014         else:
-> 1015             self._eval_line(cmd)
   1016             #self._sendline(cmd)
   1017             #self._expect_expr()

/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/interfaces/maxima.py in _eval_line(self, line, allow_use_file, wait_for_prompt, reformat, error_check, restart_if_needed)
    793             return repr(a)
    794         else:
--> 795             self._sendline(line)
    796 
    797         line_echo = self._readline()

/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/interfaces/maxima.py in _sendline(self, string)
    654             '9'
    655         """
--> 656         self._sendstr(string)
    657         os.write(self._expect.child_fd, os.linesep.encode('ascii'))
    658 

/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/interfaces/expect.py in _sendstr(self, string)
   1221         """
   1222         if self._expect is None:
-> 1223             self._start()
   1224         try:
   1225             os.write(self._expect.child_fd, str_to_bytes(string))

/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/interfaces/maxima.py in _start(self)
    619 
    620         """
--> 621         Expect._start(self)
    622         self._sendline(r":lisp (defun tex-derivative (x l r) (tex (if $derivabbrev (tex-dabbrev x) (tex-d x '\\partial)) l r lop rop ))")
    623 

/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/interfaces/expect.py in _start(self, alt_message, block_during_init)
    530             if block_during_init:
    531                 for X in self.__init_code:
--> 532                     self.eval(X)
    533             else:
    534                 for X in self.__init_code:

/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/interfaces/expect.py in eval(self, code, strip, synchronize, locals, allow_use_file, split_lines, **kwds)
   1361         # In particular, do NOT call self._keyboard_interrupt()
   1362         except TypeError as s:
-> 1363             raise TypeError('error evaluating "%s":\n%s'%(code,s))
   1364 
   1365     ############################################################

TypeError: error evaluating "display2d : false":
expected bytes, str found
```



---

Comment by git created at 2018-05-20 13:03:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-05-20 17:58:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2018-05-21 12:10:10

Well, this used to work.  Let me see if I can fix it again.  There is a follow-up ticket somewhere that makes several more fixes to the expect interfaces.  This was just a small proof of concept change to get the bare minimum working.


---

Comment by embray created at 2018-05-21 12:19:45

I'm going to set this back to my branch.  But I'll incorporate the fixes from pyflakes.


---

Comment by embray created at 2018-05-21 13:06:56

Ok, this should be working again, just at the bare minimum level promised by the original ticket description.
----
New commits:


---

Comment by chapoton created at 2018-05-21 14:28:40

I confirm that this works on python3. Let us wait for the python2-patchbot, and then it will be good to go.


---

Comment by embray created at 2018-05-21 15:05:41

Huh. Weirdly a commit with the same message as 6c8a6f0 was already merged some time ago, but with different content.  Oh well, the text is still basically accurate...


---

Comment by git created at 2018-05-21 15:11:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2018-05-21 16:09:55

checked again that it works with py3; now waiting for py2 patchbots


---

Comment by chapoton created at 2018-05-21 16:28:08

The patchbots report a doctest failure in singular expect interface. As in comment:16 !


---

Comment by git created at 2018-05-21 17:13:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2018-05-21 18:59:35

checked once again that it works with py3; now waiting for py2 patchbots

Also, for the record,

```
sage: singular('1+1;')
2
```

works too.


---

Comment by chapoton created at 2018-05-22 06:27:14

ok, let it be


---

Comment by chapoton created at 2018-05-22 06:27:14

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2018-05-24 07:10:56

Resolution: fixed
