# Issue 23636: to_noncrossing_partition should return a set partition

archive/issues_023636.json:
```json
{
    "body": "CC:  stumpc5\n\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/23873\n\n",
    "created_at": "2017-09-16T17:06:18Z",
    "labels": [
        "PLEASE CHANGE",
        "major"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.7",
    "title": "to_noncrossing_partition should return a set partition",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/23636",
    "user": "@mantepse"
}
```
CC:  stumpc5



Issue created by migration from https://trac.sagemath.org/ticket/23873





---

archive/issue_comments_331071.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-09-16T17:17:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23636",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23636#issuecomment-331071",
    "user": "@mantepse"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_331072.json:
```json
{
    "body": "Changing component from PLEASE CHANGE to combinatorics.",
    "created_at": "2017-09-16T17:17:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23636",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23636#issuecomment-331072",
    "user": "@mantepse"
}
```

Changing component from PLEASE CHANGE to combinatorics.



---

archive/issue_comments_331073.json:
```json
{
    "body": "Changing type from PLEASE CHANGE to enhancement.",
    "created_at": "2017-09-16T17:17:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23636",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23636#issuecomment-331073",
    "user": "@mantepse"
}
```

Changing type from PLEASE CHANGE to enhancement.



---

archive/issue_comments_331074.json:
```json
{
    "body": "Depending on the overhead, it might be worth having a flag that prevents the set partition to be created, and to return a list/tuple instead...",
    "created_at": "2017-09-16T19:01:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23636",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23636#issuecomment-331074",
    "user": "stumpc5"
}
```

Depending on the overhead, it might be worth having a flag that prevents the set partition to be created, and to return a list/tuple instead...



---

archive/issue_comments_331075.json:
```json
{
    "body": "Thanks, in fact, 90% of the time is spent in creating the set partition.  I don't get it that the constructors are so slow.",
    "created_at": "2017-09-18T06:50:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23636",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23636#issuecomment-331075",
    "user": "@mantepse"
}
```

Thanks, in fact, 90% of the time is spent in creating the set partition.  I don't get it that the constructors are so slow.



---

archive/issue_comments_331076.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-09-18T06:50:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23636",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23636#issuecomment-331076",
    "user": "@mantepse"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_331077.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2017-09-29T02:05:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23636",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23636#issuecomment-331077",
    "user": "@tscrim"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_331078.json:
```json
{
    "body": "This does not currently depend on #23880, #23877, so I am removing those as a dependency and setting a positive review. If you want to delay this until one or both of those tickets are there, you can set the milestone to sage-pending.",
    "created_at": "2017-09-29T02:05:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23636",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23636#issuecomment-331078",
    "user": "@tscrim"
}
```

This does not currently depend on #23880, #23877, so I am removing those as a dependency and setting a positive review. If you want to delay this until one or both of those tickets are there, you can set the milestone to sage-pending.



---

archive/issue_comments_331079.json:
```json
{
    "body": "`@`Travis: please recheck comments 3 and 4 which suggest that this should not go into sage as is but that we need a flag preventing the set partition from being created... or do you think otherwise?",
    "created_at": "2017-09-29T04:15:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23636",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23636#issuecomment-331079",
    "user": "stumpc5"
}
```

`@`Travis: please recheck comments 3 and 4 which suggest that this should not go into sage as is but that we need a flag preventing the set partition from being created... or do you think otherwise?



---

archive/issue_comments_331080.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2017-09-29T04:15:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23636",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23636#issuecomment-331080",
    "user": "stumpc5"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_331081.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2017-09-29T04:42:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23636",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23636#issuecomment-331081",
    "user": "@tscrim"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_331082.json:
```json
{
    "body": "`@`stumpc5 I did, which those comments tell me (and anyone else reading this) virtually nothing about the overhead. IMO, this should return a `SetPartition` rather than a list (of lists), and there should not be a flag that would change that output. So functionally, this ticket is an improvement and good to go. Now, for speed, we have\n\n```\nsage: D = DyckWord([1, 1, 0, 1, 0, 0])\nsage: %timeit D.to_noncrossing_partition()\n100000 loops, best of 3: 5.23 \u00b5s per loop\nsage: %timeit SetPartition(D.to_noncrossing_partition())\n10000 loops, best of 3: 131 \u00b5s per loop\nsage: %timeit SP = SetPartitions(D.semilength()); SP(D.to_noncrossing_partition())\n1000 loops, best of 3: 253 \u00b5s per loop\n```\n\nSo if this is in a tight loop, then it's a problem. If you want to wait for #23877 and/or #23880, then as per comment:7, you can leave milestone to sage-pending until that is done. However, #23877 shouldn't be too long to a positive review. Here is what the speed gain should be by:\n\n```\nsage: SP = SetPartitions(D.semilength())\nsage: ncp = D.to_noncrossing_partition()\nsage: x = SP(ncp)\nsage: %timeit x.check()\n10000 loops, best of 3: 161 \u00b5s per loop\n```\n\nSo #23877 should get it down to around 90 \u00b5s. I don't think #23880 would have as noticeable an impact on the speed, but I haven't tried.\n\nIf instead you think this should return a lists of lists, you should mark it as invalid.",
    "created_at": "2017-09-29T04:42:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23636",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23636#issuecomment-331082",
    "user": "@tscrim"
}
```

`@`stumpc5 I did, which those comments tell me (and anyone else reading this) virtually nothing about the overhead. IMO, this should return a `SetPartition` rather than a list (of lists), and there should not be a flag that would change that output. So functionally, this ticket is an improvement and good to go. Now, for speed, we have

```
sage: D = DyckWord([1, 1, 0, 1, 0, 0])
sage: %timeit D.to_noncrossing_partition()
100000 loops, best of 3: 5.23 µs per loop
sage: %timeit SetPartition(D.to_noncrossing_partition())
10000 loops, best of 3: 131 µs per loop
sage: %timeit SP = SetPartitions(D.semilength()); SP(D.to_noncrossing_partition())
1000 loops, best of 3: 253 µs per loop
```

So if this is in a tight loop, then it's a problem. If you want to wait for #23877 and/or #23880, then as per comment:7, you can leave milestone to sage-pending until that is done. However, #23877 shouldn't be too long to a positive review. Here is what the speed gain should be by:

```
sage: SP = SetPartitions(D.semilength())
sage: ncp = D.to_noncrossing_partition()
sage: x = SP(ncp)
sage: %timeit x.check()
10000 loops, best of 3: 161 µs per loop
```

So #23877 should get it down to around 90 µs. I don't think #23880 would have as noticeable an impact on the speed, but I haven't tried.

If instead you think this should return a lists of lists, you should mark it as invalid.



---

archive/issue_comments_331083.json:
```json
{
    "body": "> If instead you think this should return a lists of lists, you should mark it as invalid.\n\n`@`Travis, thanks for your further tests -- I think it should return a set partition. And in fact I do not care personally about optionally returning a list of lists in bottleneck situations.\n\nBut I find it weird to accept such a huge overhead that makes this piece of code possibly unusable.",
    "created_at": "2017-09-29T05:48:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23636",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23636#issuecomment-331083",
    "user": "stumpc5"
}
```

> If instead you think this should return a lists of lists, you should mark it as invalid.

`@`Travis, thanks for your further tests -- I think it should return a set partition. And in fact I do not care personally about optionally returning a list of lists in bottleneck situations.

But I find it weird to accept such a huge overhead that makes this piece of code possibly unusable.



---

archive/issue_comments_331084.json:
```json
{
    "body": "Changing status from positive_review to needs_review.",
    "created_at": "2017-09-29T15:36:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23636",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23636#issuecomment-331084",
    "user": "@tscrim"
}
```

Changing status from positive_review to needs_review.



---

archive/issue_comments_331085.json:
```json
{
    "body": "Actually, I do not know why it didn't occur to me that this should depend on #23877 to get the speedup. Now I get\n\n```\nsage: D = DyckWord([1, 1, 0, 1, 0, 0])\nsage: %timeit D.to_noncrossing_partition()\nThe slowest run took 12.39 times longer than the fastest. This could mean that an intermediate result is being cached.\n10000 loops, best of 3: 63 \u00b5s per loop\n```\n\nSo now the overhead is somewhat minimalized, and I suspect the overhead time will not be a serious bottleneck in applications (although perhaps running this though building the FindStat database might be a good stress test).\n----\nNew commits:",
    "created_at": "2017-09-29T15:36:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23636",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23636#issuecomment-331085",
    "user": "@tscrim"
}
```

Actually, I do not know why it didn't occur to me that this should depend on #23877 to get the speedup. Now I get

```
sage: D = DyckWord([1, 1, 0, 1, 0, 0])
sage: %timeit D.to_noncrossing_partition()
The slowest run took 12.39 times longer than the fastest. This could mean that an intermediate result is being cached.
10000 loops, best of 3: 63 µs per loop
```

So now the overhead is somewhat minimalized, and I suspect the overhead time will not be a serious bottleneck in applications (although perhaps running this though building the FindStat database might be a good stress test).
----
New commits:



---

archive/issue_comments_331086.json:
```json
{
    "body": "**ping**",
    "created_at": "2017-10-26T00:07:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23636",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23636#issuecomment-331086",
    "user": "@tscrim"
}
```

**ping**



---

archive/issue_comments_331087.json:
```json
{
    "body": "ping",
    "created_at": "2019-03-11T04:18:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23636",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23636#issuecomment-331087",
    "user": "@tscrim"
}
```

ping



---

archive/issue_comments_331088.json:
```json
{
    "body": "I would like to clean up the following.  I realise that the only way that it is related to this ticket is performance and clean code, please bear with me.\n\nIt seems to me that we now have two coding patterns that achieve roughly the same thing:\n\n1. in `set_partition.py`, we have `SetPartitions._element_constructor_(self, s, check=True)`, which calls `self.element_class(self, s, check=check)`.  The check that `s` is valid input is done in the element class (in the case at hand, using a `check` protocol implemented by `ClonableArray`.\n\n2. in `partitions.py` we have `Partitions._element_constructor_(self, lst)`, which does the checking, and then calls `self.element_class(self, lst)`.\n\nShouldn't we promote a uniform pattern?  The second seems much more sensible to me.  Why does `CloneableArray` implement its own thing?",
    "created_at": "2019-03-11T06:22:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23636",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23636#issuecomment-331088",
    "user": "@mantepse"
}
```

I would like to clean up the following.  I realise that the only way that it is related to this ticket is performance and clean code, please bear with me.

It seems to me that we now have two coding patterns that achieve roughly the same thing:

1. in `set_partition.py`, we have `SetPartitions._element_constructor_(self, s, check=True)`, which calls `self.element_class(self, s, check=check)`.  The check that `s` is valid input is done in the element class (in the case at hand, using a `check` protocol implemented by `ClonableArray`.

2. in `partitions.py` we have `Partitions._element_constructor_(self, lst)`, which does the checking, and then calls `self.element_class(self, lst)`.

Shouldn't we promote a uniform pattern?  The second seems much more sensible to me.  Why does `CloneableArray` implement its own thing?



---

archive/issue_comments_331089.json:
```json
{
    "body": "There are benefits to both, so -1 on promoting one particular method. For instance, the first allows you to control more as every element creation must go through the `__init__` and you can do extra processing on the input data (e.g., striping trailing zeros for a partition) to help make the checks easier. Also, the `ClonableArray` has an extra feature with a context that permits you to mutate an object in a controlled way and verifies that you haven't destroyed the meaning of your object. However, we never currently have use it in production code as there hasn't be a reason to. Also, I see it more of an object's responsibility to check that it is valid rather than the parent's.\n\nIf you want to continue this discussion, I think it is better on a separate ticket or sage-combinat-devel.",
    "created_at": "2019-03-11T07:50:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23636",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23636#issuecomment-331089",
    "user": "@tscrim"
}
```

There are benefits to both, so -1 on promoting one particular method. For instance, the first allows you to control more as every element creation must go through the `__init__` and you can do extra processing on the input data (e.g., striping trailing zeros for a partition) to help make the checks easier. Also, the `ClonableArray` has an extra feature with a context that permits you to mutate an object in a controlled way and verifies that you haven't destroyed the meaning of your object. However, we never currently have use it in production code as there hasn't be a reason to. Also, I see it more of an object's responsibility to check that it is valid rather than the parent's.

If you want to continue this discussion, I think it is better on a separate ticket or sage-combinat-devel.



---

archive/issue_comments_331090.json:
```json
{
    "body": "Ticket retargeted after milestone closed (if you don't believe this ticket is appropriate for the Sage 8.8 release please retarget manually)",
    "created_at": "2019-03-25T10:56:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23636",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23636#issuecomment-331090",
    "user": "@embray"
}
```

Ticket retargeted after milestone closed (if you don't believe this ticket is appropriate for the Sage 8.8 release please retarget manually)



---

archive/issue_comments_331091.json:
```json
{
    "body": "Moving tickets from the Sage 8.8 milestone that have been actively worked on in the last six months to the next release milestone (optimistically).",
    "created_at": "2019-07-03T11:37:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23636",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23636#issuecomment-331091",
    "user": "@embray"
}
```

Moving tickets from the Sage 8.8 milestone that have been actively worked on in the last six months to the next release milestone (optimistically).



---

archive/issue_comments_331092.json:
```json
{
    "body": "Ticket retargeted after milestone closed",
    "created_at": "2019-12-30T14:48:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23636",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23636#issuecomment-331092",
    "user": "@embray"
}
```

Ticket retargeted after milestone closed



---

archive/issue_comments_331093.json:
```json
{
    "body": "Batch modifying tickets that will likely not be ready for 9.1, based on a review of the ticket title, branch/review status, and last modification date.",
    "created_at": "2020-04-14T19:41:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23636",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23636#issuecomment-331093",
    "user": "@mkoeppe"
}
```

Batch modifying tickets that will likely not be ready for 9.1, based on a review of the ticket title, branch/review status, and last modification date.



---

archive/issue_comments_331094.json:
```json
{
    "body": "Setting new milestone based on a cursory review of ticket status, priority, and last modification date.",
    "created_at": "2021-03-15T22:07:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23636",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23636#issuecomment-331094",
    "user": "@mkoeppe"
}
```

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.



---

archive/issue_comments_331095.json:
```json
{
    "body": "Setting a new milestone for this ticket based on a cursory review.",
    "created_at": "2021-07-19T00:44:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23636",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23636#issuecomment-331095",
    "user": "@mkoeppe"
}
```

Setting a new milestone for this ticket based on a cursory review.



---

archive/issue_comments_331096.json:
```json
{
    "body": "Stalled in `needs_review` or `needs_info`; likely won't make it into Sage 9.5.",
    "created_at": "2021-12-18T19:53:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23636",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23636#issuecomment-331096",
    "user": "@mkoeppe"
}
```

Stalled in `needs_review` or `needs_info`; likely won't make it into Sage 9.5.



---

archive/issue_comments_331097.json:
```json
{
    "body": "Ping. I think this just needs someone to review my changes.",
    "created_at": "2022-04-07T06:36:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23636",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23636#issuecomment-331097",
    "user": "@tscrim"
}
```

Ping. I think this just needs someone to review my changes.



---

archive/issue_comments_331098.json:
```json
{
    "body": "OK, lets go.",
    "created_at": "2022-04-22T07:13:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23636",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23636#issuecomment-331098",
    "user": "@mantepse"
}
```

OK, lets go.



---

archive/issue_comments_331099.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-04-22T07:13:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23636",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23636#issuecomment-331099",
    "user": "@mantepse"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_331100.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2022-05-17T21:00:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23636",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23636#issuecomment-331100",
    "user": "@vbraun"
}
```

Resolution: fixed
