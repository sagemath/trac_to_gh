# Issue 23636: to_noncrossing_partition should return a set partition

Issue created by migration from Trac.

Original creator: mantepse

Original creation time: 2017-09-16 17:06:18

CC:  stumpc5




---

Comment by mantepse created at 2017-09-16 17:17:57

Changing status from new to needs_review.


---

Comment by mantepse created at 2017-09-16 17:17:57

Changing component from PLEASE CHANGE to combinatorics.


---

Comment by mantepse created at 2017-09-16 17:17:57

Changing type from PLEASE CHANGE to enhancement.


---

Comment by stumpc5 created at 2017-09-16 19:01:56

Depending on the overhead, it might be worth having a flag that prevents the set partition to be created, and to return a list/tuple instead...


---

Comment by mantepse created at 2017-09-18 06:50:02

Thanks, in fact, 90% of the time is spent in creating the set partition.  I don't get it that the constructors are so slow.


---

Comment by mantepse created at 2017-09-18 06:50:19

Changing status from needs_review to needs_work.


---

Comment by tscrim created at 2017-09-29 02:05:36

Changing status from needs_work to positive_review.


---

Comment by tscrim created at 2017-09-29 02:05:36

This does not currently depend on #23880, #23877, so I am removing those as a dependency and setting a positive review. If you want to delay this until one or both of those tickets are there, you can set the milestone to sage-pending.


---

Comment by stumpc5 created at 2017-09-29 04:15:48

`@`Travis: please recheck comments 3 and 4 which suggest that this should not go into sage as is but that we need a flag preventing the set partition from being created... or do you think otherwise?


---

Comment by stumpc5 created at 2017-09-29 04:15:48

Changing status from positive_review to needs_work.


---

Comment by tscrim created at 2017-09-29 04:42:09

Changing status from needs_work to positive_review.


---

Comment by tscrim created at 2017-09-29 04:42:09

`@`stumpc5 I did, which those comments tell me (and anyone else reading this) virtually nothing about the overhead. IMO, this should return a `SetPartition` rather than a list (of lists), and there should not be a flag that would change that output. So functionally, this ticket is an improvement and good to go. Now, for speed, we have

```
sage: D = DyckWord([1, 1, 0, 1, 0, 0])
sage: %timeit D.to_noncrossing_partition()
100000 loops, best of 3: 5.23 µs per loop
sage: %timeit SetPartition(D.to_noncrossing_partition())
10000 loops, best of 3: 131 µs per loop
sage: %timeit SP = SetPartitions(D.semilength()); SP(D.to_noncrossing_partition())
1000 loops, best of 3: 253 µs per loop
```

So if this is in a tight loop, then it's a problem. If you want to wait for #23877 and/or #23880, then as per comment:7, you can leave milestone to sage-pending until that is done. However, #23877 shouldn't be too long to a positive review. Here is what the speed gain should be by:

```
sage: SP = SetPartitions(D.semilength())
sage: ncp = D.to_noncrossing_partition()
sage: x = SP(ncp)
sage: %timeit x.check()
10000 loops, best of 3: 161 µs per loop
```

So #23877 should get it down to around 90 µs. I don't think #23880 would have as noticeable an impact on the speed, but I haven't tried.

If instead you think this should return a lists of lists, you should mark it as invalid.


---

Comment by stumpc5 created at 2017-09-29 05:48:36

> If instead you think this should return a lists of lists, you should mark it as invalid.

`@`Travis, thanks for your further tests -- I think it should return a set partition. And in fact I do not care personally about optionally returning a list of lists in bottleneck situations.

But I find it weird to accept such a huge overhead that makes this piece of code possibly unusable.


---

Comment by tscrim created at 2017-09-29 15:36:33

Changing status from positive_review to needs_review.


---

Comment by tscrim created at 2017-09-29 15:36:33

Actually, I do not know why it didn't occur to me that this should depend on #23877 to get the speedup. Now I get

```
sage: D = DyckWord([1, 1, 0, 1, 0, 0])
sage: %timeit D.to_noncrossing_partition()
The slowest run took 12.39 times longer than the fastest. This could mean that an intermediate result is being cached.
10000 loops, best of 3: 63 µs per loop
```

So now the overhead is somewhat minimalized, and I suspect the overhead time will not be a serious bottleneck in applications (although perhaps running this though building the FindStat database might be a good stress test).
----
New commits:


---

Comment by tscrim created at 2017-10-26 00:07:40

**ping**


---

Comment by tscrim created at 2019-03-11 04:18:49

ping


---

Comment by mantepse created at 2019-03-11 06:22:28

I would like to clean up the following.  I realise that the only way that it is related to this ticket is performance and clean code, please bear with me.

It seems to me that we now have two coding patterns that achieve roughly the same thing:

1. in `set_partition.py`, we have `SetPartitions._element_constructor_(self, s, check=True)`, which calls `self.element_class(self, s, check=check)`.  The check that `s` is valid input is done in the element class (in the case at hand, using a `check` protocol implemented by `ClonableArray`.

2. in `partitions.py` we have `Partitions._element_constructor_(self, lst)`, which does the checking, and then calls `self.element_class(self, lst)`.

Shouldn't we promote a uniform pattern?  The second seems much more sensible to me.  Why does `CloneableArray` implement its own thing?


---

Comment by tscrim created at 2019-03-11 07:50:51

There are benefits to both, so -1 on promoting one particular method. For instance, the first allows you to control more as every element creation must go through the `__init__` and you can do extra processing on the input data (e.g., striping trailing zeros for a partition) to help make the checks easier. Also, the `ClonableArray` has an extra feature with a context that permits you to mutate an object in a controlled way and verifies that you haven't destroyed the meaning of your object. However, we never currently have use it in production code as there hasn't be a reason to. Also, I see it more of an object's responsibility to check that it is valid rather than the parent's.

If you want to continue this discussion, I think it is better on a separate ticket or sage-combinat-devel.


---

Comment by embray created at 2019-03-25 10:56:15

Ticket retargeted after milestone closed (if you don't believe this ticket is appropriate for the Sage 8.8 release please retarget manually)


---

Comment by embray created at 2019-07-03 11:37:56

Moving tickets from the Sage 8.8 milestone that have been actively worked on in the last six months to the next release milestone (optimistically).


---

Comment by embray created at 2019-12-30 14:48:17

Ticket retargeted after milestone closed


---

Comment by mkoeppe created at 2020-04-14 19:41:51

Batch modifying tickets that will likely not be ready for 9.1, based on a review of the ticket title, branch/review status, and last modification date.


---

Comment by mkoeppe created at 2021-03-15 22:07:04

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.


---

Comment by mkoeppe created at 2021-07-19 00:44:56

Setting a new milestone for this ticket based on a cursory review.


---

Comment by mkoeppe created at 2021-12-18 19:53:12

Stalled in `needs_review` or `needs_info`; likely won't make it into Sage 9.5.


---

Comment by tscrim created at 2022-04-07 06:36:05

Ping. I think this just needs someone to review my changes.


---

Comment by mantepse created at 2022-04-22 07:13:26

OK, lets go.


---

Comment by mantepse created at 2022-04-22 07:13:26

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2022-05-17 21:00:34

Resolution: fixed
