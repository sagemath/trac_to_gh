# Issue 30515: switch the default mp library to gmp

Issue created by migration from https://trac.sagemath.org/ticket/30752

Original creator: dimpase

Original creation time: 2020-10-11 10:00:20

CC:  jhpalmieri mkoeppe mjo

currently the default mp library is mpir: the default `--with-mp` is `system`, and in
`build/pkgs/mpir/spkg-configure.m4` we have

```
SAGE_SPKG_CONFIGURE([mpir], [
dnl Implement cases for what to do on different options here
    case "$with_mp" in
        system)
            AC_CHECK_HEADER(gmp.h, [], [sage_spkg_install_mpir=yes])
...

dnl Set SAGE_MP_LIBRARY depending on the with_mp option
    case "$with_mp" in
    mpir|system)
        SAGE_MP_LIBRARY=mpir
        ;;
    gmp)
        SAGE_MP_LIBRARY=gmp
```


as `mpir` is getting more and more bitrotten, this should be switched to `gmp` as the default.

Also, 

```
  --with-mp=system        use the system GMP as multiprecision library, if
                          possible (default)
```

is a lie, as can be seen from above, the default is `mpir`, not `gmp`.




---

Comment by dimpase created at 2020-10-11 17:57:55

Changing priority from major to critical.


---

Comment by dimpase created at 2020-10-11 17:57:55

marking it critical, as it corrects the `./configure -h` misleading info.
----
New commits:


---

Comment by dimpase created at 2020-10-11 18:29:37

Changing status from new to needs_review.


---

Comment by dimpase created at 2020-10-11 18:29:37

the reporting is still a bit misleading:

```
...
gmp-6.1.2:                                   using system package; SPKG will not be installed
...
mpir-3.0.0-644faf502c56f97d9accd301965fc57d6ec70868.p0:no suitable system package; will be installed as an SPKG
...
```

but this not a regression.


---

Comment by jhpalmieri created at 2020-10-11 20:33:30

In principle this is okay, and I'm testing it on OS X, but I think it should be merged early in a release, not late in this one, since it needs testing on a wide variety of platforms.


---

Comment by dimpase created at 2020-10-11 21:16:17

perhaps you'd like to try this together with #30625 - upgrade of Sage's GMP.

I've moved this to 9.3.


---

Comment by jhpalmieri created at 2020-10-12 00:29:07

With Xcode 12, OS X Catalina: works on its own and in combination with #30625.


---

Comment by mkoeppe created at 2020-11-10 19:50:12

This will affect all `-minimal` builds - so I am testing it with GH Actions


---

Comment by mkoeppe created at 2020-11-11 17:06:07

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2020-11-11 17:06:07

This breaks lots of `-minimal` builds - see for example `fedora-31-minimal`  (https://github.com/mkoeppe/sage/runs/1381716520)

```
  gcc -pthread -shared -Wl,-rpath-link,/sage/local/lib -L/sage/local/lib -Wl,-rpath,/sage/local/lib -L. -Wl,-rpath-link,/sage/local/lib -L/sage/local/lib -Wl,-rpath,/sage/local/lib -Wl,-rpath-link,/sage/local/lib -L/sage/local/lib -Wl,-rpath,/sage/local/lib build/temp.linux-x86_64-3.8/cypari2/closure.o -L/sage/local/lib -L/sage/local/lib64 -L/sage/local/lib -lgmp -lpari -o build/lib.linux-x86_64-3.8/cypari2/closure.cpython-38-x86_64-linux-gnu.so -lpari
  /usr/bin/ld: cannot find -lgmp
  collect2: error: ld returned 1 exit status
  error: command 'gcc' failed with exit status 1
  Building wheel for cypari2 (setup.py): finished with status 'error'
```



---

Comment by dimpase created at 2020-11-12 09:25:24

a logic error in spkg-configure (of mpir or gmp)

```
2020-11-10T22:56:48.4470802Z Checking whether SageMath should install SPKG mpir...
2020-11-10T22:56:48.4471312Z checking gmp.h usability... no
2020-11-10T22:56:48.4471747Z checking gmp.h presence... no
2020-11-10T22:56:48.4472119Z checking for gmp.h... no
2020-11-10T22:56:48.4472533Z checking gmpxx.h usability... no
2020-11-10T22:56:48.4472984Z checking gmpxx.h presence... no
2020-11-10T22:56:48.4473541Z checking for gmpxx.h... no
2020-11-10T22:56:48.4473965Z checking for library containing __gmpq_cmp_z... no
2020-11-10T22:56:48.4474813Z configure: will use system package and not install SPKG mpir
2020-11-10T22:56:48.4475426Z using gmp SPKG (via --with-mp=gmp)
2020-11-10T22:56:48.4475906Z -----------------------------------------------------------------------------
2020-11-10T22:56:48.4476313Z Checking whether SageMath should install SPKG gmp...
2020-11-10T22:56:48.4476849Z configure: will use system package and not install SPKG gmp
```

somehow it thinks that system GMP is available.


---

Comment by git created at 2020-11-12 11:17:38

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by dimpase created at 2020-11-12 11:24:26

fixed this (and rebased over latest beta).
Tested with/without gmp present, with various options for `--with-mp=`, all seems to work.


---

Comment by dimpase created at 2020-11-12 11:24:26

Changing status from needs_work to needs_review.


---

Comment by dimpase created at 2020-11-13 09:34:06

this round of GH actions looks better, several "minimal" jobs completed successfully.
These that failed (e.g. ubunuty-trusty) seemed to have failed for an unrelated reason.
Although it's hart to see atm, for the latter one can only see that sagelib build failed somewhere, but the full log is not there - is it supposed to become available at some point after the run completes?


---

Comment by mkoeppe created at 2020-11-14 23:55:04

The full logs are now available as the run has completed


---

Comment by dimpase created at 2020-11-15 10:06:19

Replying to [comment:13 mkoeppe]:
> The full logs are now available as the run has completed
I don't know where to find  full untruncated logs, such as install.log for e.g. 
docker (ubuntu-trusty, minimal).
"last whatever lines" do not show the real error.


---

Comment by mkoeppe created at 2020-11-15 19:33:50

In the build artifacts listed at https://github.com/mkoeppe/sage/actions/runs/360142559, such as this one: https://github.com/mkoeppe/sage/suites/1493083844/artifacts/26253188
for ubuntu-trusty-minimal


---

Comment by dimpase created at 2020-11-15 22:32:00

Replying to [comment:15 mkoeppe]:
> In the build artifacts listed at https://github.com/mkoeppe/sage/actions/runs/360142559, such as this one: https://github.com/mkoeppe/sage/suites/1493083844/artifacts/26253188
> for ubuntu-trusty-minimal

OK, thanks for pointing to the right direction. In this case the error is about a giac header,
as can be seen in `logs/pkgs/sagelib-9.3.beta1.log`


```
[197/523] creating build/temp.linux-x86_64-3.8/build/cythonized/sage/libs/giac
gcc -Wno-unused-result -Wsign-compare -DNDEBUG -g -fwrapv -O3 -Wall -Wno-unused -fPIC -Isage/libs/giac -I./sage/cpython -I/sage/local/lib/python3.8/site-packages/cysignals -I/sage/build/pkgs/sagelib/src -I/sage/l
ocal/include/python3.8 -I/sage/local/lib/python3.8/site-packages/numpy/core/include -Ibuild/cythonized -I/sage/local/include/python3.8 -c build/cythonized/sage/libs/giac/giac.cpp -o build/temp.linux-x86_64-3.8/bu
ild/cythonized/sage/libs/giac/giac.o -fno-strict-aliasing -DCYTHON_CLINE_IN_TRACEBACK=1 -fno-tree-copyrename -std=c++11
build/cythonized/sage/libs/giac/giac.cpp:676:23: fatal error: giac/giac.h: No such file or directory
 #include "giac/giac.h"
                       ^
compilation terminated.
```

Looks as if `-I$SAGE_LOCAL/include` is missing in CFLAGS, or something like this.
Nothing to do with the branch on this ticket, anyway.


---

Comment by mkoeppe created at 2020-11-17 03:13:41

The problem with giac is probably just that missing dependency, fixed in #30858


---

Comment by mkoeppe created at 2020-11-17 03:20:22

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2020-11-22 15:06:55

Resolution: fixed


---

Comment by vbraun created at 2020-11-22 22:22:24

Changing status from closed to new.


---

Comment by vbraun created at 2020-11-22 22:22:24

On OSX:

```
vbraun@osx Sage % ./sage -p gmp                       
Found local metadata for gmp-6.2.0
Using cached file /Users/vbraun/Sage/upstream/gmp-6.2.0.tar.xz
gmp-6.2.0
====================================================
Setting up build directory for gmp-6.2.0
Error: Unknown file type: /Users/vbraun/Sage/upstream/gmp-6.2.0.tar.xz
Finished extraction
```

The inability to extract xz is apparently ignored, but obviously install fails sooner or later.


---

Comment by vbraun created at 2020-11-22 22:22:24

Resolution changed from fixed to 


---

Comment by vbraun created at 2020-11-22 22:22:47

New commits:


---

Comment by jhpalmieri created at 2020-11-22 22:58:11

What does this have to do with this ticket? If you can't extract xz files, then you can't extract tarballs for Python, symmetrica, gcc, and gmp.


---

Comment by mkoeppe created at 2020-11-22 23:00:19

These other packages declare a dependency on `xz` (see #30559)


---

Comment by jhpalmieri created at 2020-11-22 23:53:21

But on OS X, the included version of Python 3, at least as of 10.15.7, can extract `.tar.xz` files using its `tarfile` module. It looks like this feature was added in Python 3.3. We shouldn't need the `xz` executable for this, unless the system only has an old version of Python. Rather than using #30948, or maybe in addition, maybe we should modify the code in `sage_bootstrap.uncompress.tar_file` that handles `xz` files.


---

Comment by mkoeppe created at 2020-11-23 00:53:13

That's true, but as of #29890, we prefer system python 2 because with python3 we have run into SSL problems. (The correct fix is discussed in the ticket description of #29418.)


---

Comment by mkoeppe created at 2020-11-23 02:02:27

Replying to [comment:25 mkoeppe]:
> The correct fix is discussed in the ticket description of #29418.
I've opened #30950 for this -- but for the present ticket, let's just add `xz` to the dependencies.


---

Comment by mkoeppe created at 2020-11-25 00:06:19

New commits:


---

Comment by mkoeppe created at 2020-11-25 00:06:19

Changing status from new to needs_review.


---

Comment by dimpase created at 2020-11-25 10:07:13

lgtm


---

Comment by dimpase created at 2020-11-25 10:07:13

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2020-12-05 22:13:31

Resolution: fixed
