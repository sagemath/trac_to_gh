# Issue 12546: polynomial substitution overflow hell (libsingular bug?)

Issue created by migration from Trac.

Original creator: was

Original creation time: 2012-03-21 18:41:05

Assignee: malb


```
sage: R.<x,y> = QQ[]
sage: n=1000; f = x^n; f.subs(x = x^n)
x^1000000
sage: n=100000; f = x^n; f.subs(x = x^n)
x^1410065408*y^2 
```



---

Comment by malb created at 2012-03-21 22:55:10

Ah, crap, we took care of the actual overflows but missed this one. I'll try to port our fix from `__pow__` over this weekend.


---

Comment by was created at 2012-03-22 13:36:52

By the way, this bug was quickly hit by Ben Hutz, who is doing research in arithmetic dynamics, which involves dynamics of *iterating* maps.


---

Comment by malb created at 2012-03-24 14:33:03

Changing status from new to needs_review.


---

Comment by malb created at 2012-03-24 14:36:03

I am not sure what I am supposed to do about this *stopgap* business.


---

Comment by was created at 2012-03-29 12:35:49

REFEREE REPORT:

  This looks _great_ except for one little thing. Can you give examples to illustrate the `max_degree_per_variable` parameter in the Python-callable functions that define it.


---

Comment by was created at 2012-03-29 12:35:49

Changing status from needs_review to needs_work.


---

Attachment


---

Comment by malb created at 2012-04-14 00:23:53

Changing status from needs_work to needs_review.


---

Comment by malb created at 2012-04-14 00:24:46

I removed `max_degree_per_variable` because it turns out to not work anyway.


---

Comment by vbraun created at 2012-04-19 14:37:51

Looks good!


---

Comment by vbraun created at 2012-04-19 14:38:32

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2012-04-20 07:41:02

In `cdef int singular_polynomial_subst()`, did you verify that adding the `sig_on()` conditions doesn't slow things down?  If you need a function call to determine whether to call `sig_on()`, it's probably faster to always call `sig_on()`.


---

Comment by jdemeyer created at 2012-04-20 08:06:43

Never mind, the difference is hardly noticable anyway.  Your way (with the conditional `sig_on()`) seems to be very slightly faster.


---

Comment by malb created at 2012-04-20 08:52:45

Btw. it's the "standard" way we do it in the singular interface. I think Joel Mohler introduced it ages ago.


---

Comment by jdemeyer created at 2012-04-28 11:52:04

Changing status from positive_review to needs_work.


---

Comment by jdemeyer created at 2012-04-28 11:52:04

On 32-bit systems:

```
**********************************************************************
File "/Users/buildbot/build/sage/moufang-1/moufang_full/build/sage-5.0.beta15/devel/sage-main/sage/rings/polynomial/multi_polynomial_libsingular.pyx", line 3154:
    sage: n=1000; f = x^n; f.subs(x = x^n)
Exception raised:
    Traceback (most recent call last):
      File "/Users/buildbot/build/sage/moufang-1/moufang_full/build/sage-5.0.beta15/local/bin/ncadoctest.py", line 1231, in run_one_test
        self.run_one_example(test, example, filename, compileflags)
      File "/Users/buildbot/build/sage/moufang-1/moufang_full/build/sage-5.0.beta15/local/bin/sagedoctest.py", line 38, in run_one_example
        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)
      File "/Users/buildbot/build/sage/moufang-1/moufang_full/build/sage-5.0.beta15/local/bin/ncadoctest.py", line 1172, in run_one_example
        compileflags, 1) in test.globs
      File "<doctest __main__.example_61[28]>", line 1, in <module>
        n=Integer(1000); f = x**n; f.subs(x = x**n)###line 3154:
    sage: n=1000; f = x^n; f.subs(x = x^n)
      File "multi_polynomial_libsingular.pyx", line 3240, in sage.rings.polynomial.multi_polynomial_libsingular.MPolynomial_libsingular.subs (sage/rings/polynomial/multi_polynomial_libsingular.cpp:21411)
        raise OverflowError("Exponent overflow (%d)."%(degree))
    OverflowError: Exponent overflow (1000000).
**********************************************************************
File "/Users/buildbot/build/sage/moufang-1/moufang_full/build/sage-5.0.beta15/devel/sage-main/sage/rings/polynomial/multi_polynomial_libsingular.pyx", line 3157:
    sage: n=100000; f = x^n; f.subs(x = x^n)
Expected:
    Traceback (most recent call last):
    ...
    OverflowError: Exponent overflow (10000000000).
Got:
    Traceback (most recent call last):
      File "/Users/buildbot/build/sage/moufang-1/moufang_full/build/sage-5.0.beta15/local/bin/ncadoctest.py", line 1231, in run_one_test
        self.run_one_example(test, example, filename, compileflags)
      File "/Users/buildbot/build/sage/moufang-1/moufang_full/build/sage-5.0.beta15/local/bin/sagedoctest.py", line 38, in run_one_example
        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)
      File "/Users/buildbot/build/sage/moufang-1/moufang_full/build/sage-5.0.beta15/local/bin/ncadoctest.py", line 1172, in run_one_example
        compileflags, 1) in test.globs
      File "<doctest __main__.example_61[29]>", line 1, in <module>
        n=Integer(100000); f = x**n; f.subs(x = x**n)###line 3157:
    sage: n=100000; f = x^n; f.subs(x = x^n)
      File "multi_polynomial_libsingular.pyx", line 2347, in sage.rings.polynomial.multi_polynomial_libsingular.MPolynomial_libsingular.__pow__ (sage/rings/polynomial/multi_polynomial_libsingular.cpp:16619)
        singular_polynomial_pow(&_p, self._poly, exp, _ring)
      File "polynomial.pyx", line 322, in sage.libs.singular.polynomial.singular_polynomial_pow (sage/libs/singular/polynomial.cpp:3976)
      File "singular.pyx", line 667, in sage.libs.singular.singular.overflow_check (sage/libs/singular/singular.cpp:6526)
    OverflowError: Exponent overflow (100000).
**********************************************************************
```



---

Comment by malb created at 2014-06-27 01:08:11

Changing keywords from "" to "sd59".


---

Comment by malb created at 2014-06-27 01:08:11

Changing status from needs_work to needs_review.


---

Comment by malb created at 2014-06-27 01:08:11

A mere two years later â€¦ and I fixed those doctest failures.
----
New commits:


---

Comment by git created at 2014-06-27 16:15:14

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by malb created at 2014-06-27 16:16:42

fixed segfault.


---

Comment by malb created at 2014-07-07 15:43:22

anyone up for reviewing this?


---

Comment by vbraun created at 2014-07-07 17:38:30

I'm getting a bunch of doctest errors, including

```
sage -t --long src/sage/rings/polynomial/multi_polynomial_libsingular.pyx
**********************************************************************
File "src/sage/rings/polynomial/multi_polynomial_libsingular.pyx", line 3279, in sage.rings.polynomial.multi_polynomial_libsingular.MPolynomial_libsingular.subs
Failed example:
    try:
      f.subs(x = x^n)
      print "no overflow"
    except OverflowError:
      print "overflow"
Expected:
    no overflow 
Got:
    x^1000000
    no overflow
```

but really there is a bunch more. Did you run the tests?


---

Comment by malb created at 2014-07-07 20:09:23

Changing status from needs_review to needs_work.


---

Comment by malb created at 2014-07-07 20:09:23

I did and they passed (I thought at least), but I'm now getting these, too. Damn.


---

Comment by git created at 2014-07-07 21:34:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-07-08 09:16:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by malb created at 2014-07-08 09:54:02

Changing status from needs_work to needs_review.


---

Comment by malb created at 2014-07-08 09:54:02

Okay, figured out what went wrong:

* the doctest failure Volker posted was missed because I ran my last tests on 32-bit not on 64-bit, but it only shows on 64-bit
* the other doctest failures were introduced in my last - seemingly innocent - fix

I've addressed these and ran doctests on one 64-bit and one 32-bit system. They passed.


---

Comment by vbraun created at 2014-07-08 18:51:57

Resolution: fixed
