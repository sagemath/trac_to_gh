# Issue 19765: stand-alone interrupt.pyx

Issue created by migration from Trac.

Original creator: malb

Original creation time: 2016-02-02 09:14:45

CC:  jdemeyer vdelecroix fbissey vbraun

This ticket is about turning Sageâ€™s interrupt  handling into something that can be easily installed from PyPI.

See also https://groups.google.com/d/topic/sage-devel/oA9NsF26eOA/discussion


---

Comment by vdelecroix created at 2016-02-02 18:41:00

I am interested, partly because of [pplpy](https://pypi.python.org/pypi/pplpy).


---

Comment by jdemeyer created at 2016-02-04 11:19:25

This is certainly something that I would like to work on, I think it fits very well with [https://github.com/OpenDreamKit/OpenDreamKit/issues/52](https://github.com/OpenDreamKit/OpenDreamKit/issues/52).


---

Comment by jdemeyer created at 2016-02-06 20:23:38

Cool! I guess the next step is to figure out how to actually make this `signals.pyx` available to external packages (you need to install the `.pxd`, `.pxi` and `.h` files).

I think it would be very useful to have an example package using `signals.pyx`. Both as documentation, but also as an additional test.


---

Comment by malb created at 2016-02-07 15:52:46

I created a [cysignals](https://github.com/malb/fpylll/commits/cysignals) branch for fpylll which uses the new cysignals.


---

Comment by git created at 2016-02-11 12:33:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2016-02-11 13:00:03

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2016-02-11 13:00:30

`@`vbraun: please test on buildbots.


---

Comment by malb created at 2016-02-11 14:07:53

Couldn't we use the `include_path=sys.path` trick to avoid patching Cython, just in case they don't accept the pull request?


---

Comment by jdemeyer created at 2016-02-11 15:39:33

Replying to [comment:16 malb]:
> Couldn't we use the `include_path=sys.path` trick to avoid patching Cython, just in case they don't accept the pull request?

The problem is that we have to support:
1. the Sage library
2. the `cython(...)` command
3. the `%cython` notebook magic
4. `./sage somefile.spyx`
5. external spkgs using `cysignals`

Instead of patching all these, I think it is much cleaner to apply just the Cython patch.


---

Comment by malb created at 2016-02-11 16:46:53

Makes sense to me.


---

Comment by malb created at 2016-02-15 13:24:25

Building a fresh Sage installation and running `make ptestlong` works on 64-bit Debian/GNU Linux.


---

Comment by malb created at 2016-02-15 13:47:51

- What is our convention for dependencies in SPKG.txt, shall we mention Pari?
- I'm no fan of "init_interrupts -> init_cysignals". Why not fix up cysignals if that's needed?


---

Comment by malb created at 2016-02-15 13:48:24

Changing status from needs_review to needs_info.


---

Comment by fbissey created at 2016-02-15 23:30:40

Replying to [comment:21 malb]:
> - What is our convention for dependencies in SPKG.txt, shall we mention Pari?

It is redundant with another file but since both `python` and `cython` are there, I guess it should be added.

> - I'm no fan of "init_interrupts -> init_cysignals". Why not fix up cysignals if that's needed?

It is fixed on master but not in 0.9. Got bitten by that when I tried to build the thing with sage-on-gentoo (does build now against `cysignals` master instead of patching 0.9. )


---

Comment by jdemeyer created at 2016-02-16 08:13:44

Changing status from needs_info to needs_work.


---

Comment by git created at 2016-02-16 15:51:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2016-02-16 15:51:55

Changing status from needs_work to needs_review.


---

Comment by malb created at 2016-02-16 16:15:33

This resolves all issues I had, so positive review from me.


---

Comment by malb created at 2016-02-16 16:15:33

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2016-02-17 00:02:31


```
Running the test suite for cysignals-1.0rc0...
python setup.py build
running build
running build_py
running build_ext
running build_scripts
python setup.py install
running install
running build
running build_py
running build_ext
running build_scripts
running install_lib
running install_scripts
changing mode of /Users/buildslave-sage/slave/sage_git/build/local/bin/cysignals-CSI to 755
changing mode of /Users/buildslave-sage/slave/sage_git/build/local/bin/cysignals-CSI-helper.py to 755
running install_egg_info
Removing /Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/cysignals-1.0rc0-py2.7.egg-info
Writing /Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/cysignals-1.0rc0-py2.7.egg-info
python -m doctest src/cysignals/*.pyx
cd example && python setup.py build
Compiling cysignals_example.pyx because it changed.
[1/1] Cythonizing cysignals_example.pyx
running build
running build_ext
building 'cysignals_example' extension
creating build
creating build/temp.macosx-10.9-x86_64-2.7
gcc -fno-strict-aliasing -I/Users/buildslave-sage/slave/sage_git/build/local/var/tmp/sage/build/python2-2.7.10.p0/include -DNDEBUG -g -fwrapv -O3 -Wall -Wno-unused -I/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/cysignals -I/Users/buildslave-sage/slave/sage_git/build/local/include/python2.7 -c cysignals_example.c -o build/temp.macosx-10.9-x86_64-2.7/cysignals_example.o
creating build/lib.macosx-10.9-x86_64-2.7
gcc -bundle -undefined dynamic_lookup -L/Users/buildslave-sage/slave/sage_git/build/local/lib -Wl,-rpath,/Users/buildslave-sage/slave/sage_git/build/local/lib -L/Users/buildslave-sage/slave/sage_git/build/local/lib -Wl,-rpath,/Users/buildslave-sage/slave/sage_git/build/local/lib build/temp.macosx-10.9-x86_64-2.7/cysignals_example.o -L/Users/buildslave-sage/slave/sage_git/build/local/lib -o build/lib.macosx-10.9-x86_64-2.7/cysignals_example.so -lpari -Ddummy
**********************************************************************
File "src/cysignals/tests.pyx", line 491, in tests.pyx
Failed example:
    print Popen(['python', '-c', cmd], stdout=PIPE, stderr=PIPE).communicate()[1]  # doctest: +ELLIPSIS
Expected:
    ------------------------------------------------------------------------
    ...
    ------------------------------------------------------------------------
    ------------------------------------------------------------------------
    <BLANKLINE>
Got:
    ------------------------------------------------------------------------
    0   signals.so                          0x000000010d478885 print_backtrace + 37
    ------------------------------------------------------------------------
    <BLANKLINE>
**********************************************************************
File "src/cysignals/tests.pyx", line 536, in tests.pyx
Failed example:
    print Popen(['python', '-c', cmd], stdout=PIPE, stderr=PIPE).communicate()[1]  # doctest: +ELLIPSIS
Expected:
    ------------------------------------------------------------------------
    ...
    ------------------------------------------------------------------------
    ------------------------------------------------------------------------
    Unhandled SIG...
    This probably occurred because a *compiled* module has a bug
    in it and is not properly wrapped with sig_on(), sig_off().
    Python will now terminate.
    ------------------------------------------------------------------------
    <BLANKLINE>
Got:
    ------------------------------------------------------------------------
    0   signals.so                          0x000000010e85f885 print_backtrace + 37
    ------------------------------------------------------------------------
    Unhandled SIGSEGV: A segmentation fault occurred.
    This probably occurred because a *compiled* module has a bug
    in it and is not properly wrapped with sig_on(), sig_off().
    Python will now terminate.
    ------------------------------------------------------------------------
    <BLANKLINE>
**********************************************************************
File "src/cysignals/tests.pyx", line 575, in tests.pyx
Failed example:
    print Popen(['python', '-c', cmd], stdout=PIPE, stderr=PIPE).communicate()[1]  # doctest: +ELLIPSIS
Expected:
    ------------------------------------------------------------------------
    ...
    ------------------------------------------------------------------------
    ------------------------------------------------------------------------
    Unhandled SIGABRT: An abort() occurred.
    This probably occurred because a *compiled* module has a bug
    in it and is not properly wrapped with sig_on(), sig_off().
    Python will now terminate.
    ------------------------------------------------------------------------
    <BLANKLINE>
Got:
    ------------------------------------------------------------------------
    0   signals.so                          0x00000001099ff885 print_backtrace + 37
    ------------------------------------------------------------------------
    Unhandled SIGABRT: An abort() occurred.
    This probably occurred because a *compiled* module has a bug
    in it and is not properly wrapped with sig_on(), sig_off().
    Python will now terminate.
    ------------------------------------------------------------------------
    <BLANKLINE>
**********************************************************************
File "src/cysignals/tests.pyx", line 599, in tests.pyx
Failed example:
    print Popen(['python', '-c', cmd], stdout=PIPE, stderr=PIPE).communicate()[1]  # doctest: +ELLIPSIS
Expected:
    ------------------------------------------------------------------------
    ...
    ------------------------------------------------------------------------
    ------------------------------------------------------------------------
    An error occured during signal handling.
    This probably occurred because a *compiled* module has a bug
    in it and is not properly wrapped with sig_on(), sig_off().
    Python will now terminate.
    ------------------------------------------------------------------------
    <BLANKLINE>
Got:
    ------------------------------------------------------------------------
    0   signals.so                          0x000000010c6de885 print_backtrace + 37
    ------------------------------------------------------------------------
    An error occured during signal handling.
    This probably occurred because a *compiled* module has a bug
    in it and is not properly wrapped with sig_on(), sig_off().
    Python will now terminate.
    ------------------------------------------------------------------------
    <BLANKLINE>
**********************************************************************
1 items had failures:
   4 of  97 in tests.pyx
***Test Failed*** 4 failures.
make[3]: *** [check-doctest] Error 1
make[3]: Target `check' not remade because of errors.
```



---

Comment by vbraun created at 2016-02-17 00:02:31

Changing status from positive_review to needs_work.


---

Comment by git created at 2016-02-18 10:22:43

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2016-02-18 10:23:33

Changing status from needs_work to needs_review.


---

Comment by fbissey created at 2016-02-18 10:25:09

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2016-02-18 23:40:15

The test is now hanging for half an hour on my desktop:

```
buildsl+ 11539  0.0  0.0 117516  3068 ?        SN   Feb18   0:00 bash ./install start
buildsl+ 11568  0.0  0.0 115080  2948 ?        SN   Feb18   0:00 make -j8 start
buildsl+ 11576  0.0  0.0 116776  4588 ?        SN   Feb18   0:00 make -j8 all-sage
vbraun   13964  0.0  0.0 117000  2256 pts/4    S+   00:30   0:00 grep --color=auto buildsl
buildsl+ 24718  0.0  0.0 117512  3144 ?        SN   Feb18   0:00 bash /mnt/disk/home/buildslave-sage/slave/sage_git/build/build/bin/sage-logger sage-spkg cysignals-1.0rc1 /mnt/disk/home/buildslave-sage/slave/sage_git/build/logs/pkgs/cysignals-1.0rc1.log
buildsl+ 24735  0.0  0.0 117512  1828 ?        SN   Feb18   0:00 bash /mnt/disk/home/buildslave-sage/slave/sage_git/build/build/bin/sage-logger sage-spkg cysignals-1.0rc1 /mnt/disk/home/buildslave-sage/slave/sage_git/build/logs/pkgs/cysignals-1.0rc1.log
buildsl+ 24737  0.0  0.0 117512   220 ?        SN   Feb18   0:00 bash /mnt/disk/home/buildslave-sage/slave/sage_git/build/build/bin/sage-logger sage-spkg cysignals-1.0rc1 /mnt/disk/home/buildslave-sage/slave/sage_git/build/logs/pkgs/cysignals-1.0rc1.log
buildsl+ 24739  0.0  0.0 112180  1856 ?        SN   Feb18   0:00 tee -a /mnt/disk/home/buildslave-sage/slave/sage_git/build/logs/pkgs/cysignals-1.0rc1.log
buildsl+ 24740  0.0  0.0 117648  3120 ?        SN   Feb18   0:00 bash /mnt/disk/home/buildslave-sage/slave/sage_git/build/build/bin/sage-spkg cysignals-1.0rc1
buildsl+ 25822  0.0  0.0   9636  2456 ?        SN   Feb18   0:00 bash ./spkg-check
buildsl+ 25823  0.0  0.0   6720  1980 ?        SN   Feb18   0:00 make check
buildsl+ 25828  0.1  0.0 116652 18112 ?        SN   Feb18   0:08 python -m doctest src/cysignals/alarm.pyx src/cysignals/signals.pyx src/cysignals/tests.pyx
```

After killing it 

```
cd example && python setup.py build
Compiling cysignals_example.pyx because it changed.
[1/1] Cythonizing cysignals_example.pyx
running build
running build_ext
building 'cysignals_example' extension
creating build
creating build/temp.linux-x86_64-2.7-pydebug
gcc -fno-strict-aliasing -g -O2 -g -O0 -Wall -Wno-unused -fPIC -I/mnt/disk/home/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/cysignals -I/mnt/disk/home/buildslave-sage/slave/sage_git/build/local/include/python2.7 -c cysignals_example.c -o build/temp.linux-x86_64-2.7-pydebug/cysignals_example.o
creating build/lib.linux-x86_64-2.7-pydebug
gcc -pthread -shared -L/mnt/disk/home/buildslave-sage/slave/sage_git/build/local/lib -Wl,-rpath,/mnt/disk/home/buildslave-sage/slave/sage_git/build/local/lib -L/mnt/disk/home/buildslave-sage/slave/sage_git/build/local/lib -Wl,-rpath,/mnt/disk/home/buildslave-sage/slave/sage_git/build/local/lib build/temp.linux-x86_64-2.7-pydebug/cysignals_example.o -L/mnt/disk/home/buildslave-sage/slave/sage_git/build/local/lib -lpython2.7 -o build/lib.linux-x86_64-2.7-pydebug/cysignals_example.so -lpari -Ddummy
Makefile:40: recipe for target 'check-doctest' failed
make[3]: *** [check-doctest] Terminated
make[3]: Target 'check' not remade because of errors.
make[3]: Leaving directory '/mnt/disk/home/buildslave-sage/slave/sage_git/build/local/var/tmp/sage/build/cysignals-1.0rc1/src'
```

GDB

```
(gdb) bt
#0  0x00007fb1ed0f24ec in __lll_lock_wait_private () from /lib64/libc.so.6
#1  0x00007fb1ed05f863 in ptmalloc_lock_all () from /lib64/libc.so.6
#2  0x00007fb1ed0aa832 in fork () from /lib64/libc.so.6
#3  0x00007fb1e786b957 in signal_pid_after_delay (signum=2, killpid=16455, ms=200, 
    interval=0, n=1) at src/cysignals/tests_helper.c:66
#4  0x00007fb1e7875934 in __pyx_pf_9cysignals_5tests_70test_signal_during_malloc (
    __pyx_self=0x0, __pyx_v_delay=200) at build/src/cysignals/tests.c:7948
#5  0x00007fb1e78758a1 in __pyx_pw_9cysignals_5tests_71test_signal_during_malloc (
    __pyx_self=0x0, __pyx_args=0x7fb1ee2eb060, __pyx_kwds=0x0)
    at build/src/cysignals/tests.c:7894
#6  0x00007fb1edd7d798 in PyCFunction_Call (func=0x7fb1e7828678, arg=0x7fb1ee2eb060, kw=0x0)
    at Objects/methodobject.c:85
#7  0x00007fb1ede23bf6 in call_function (pp_stack=0x7ffc6fbe3110, oparg=0)
    at Python/ceval.c:4035
#8  0x00007fb1ede1e642 in PyEval_EvalFrameEx (f=0x7fb1e90727e0, throwflag=0)
    at Python/ceval.c:2681
#9  0x00007fb1ede2110b in PyEval_EvalCodeEx (co=0x7fb1e7844460, globals=0x7fb1e783fe78, 
    locals=0x7fb1e783fe78, args=0x0, argcount=0, kws=0x0, kwcount=0, defs=0x0, defcount=0, 
    closure=0x0) at Python/ceval.c:3267
#10 0x00007fb1ede16998 in PyEval_EvalCode (co=0x7fb1e7844460, globals=0x7fb1e783fe78, 
    locals=0x7fb1e783fe78) at Python/ceval.c:669
#11 0x00007fb1ede2671b in exec_statement (f=0x2054750, prog=0x7fb1e7844460, 
    globals=0x7fb1e783fe78, locals=0x7fb1e783fe78) at Python/ceval.c:4732
#12 0x00007fb1ede1acea in PyEval_EvalFrameEx (f=0x2054750, throwflag=0) at Python/ceval.c:1883
#13 0x00007fb1ede2110b in PyEval_EvalCodeEx (co=0x7fb1ecd59b40, globals=0x7fb1ee2df958, 
    locals=0x0, args=0x2050a28, argcount=4, kws=0x2050a48, kwcount=0, defs=0x0, defcount=0, 
    closure=0x0) at Python/ceval.c:3267
#14 0x00007fb1ede24233 in fast_function (func=0x7fb1e9076ae0, pp_stack=0x7ffc6fbe3a20, n=4, 
    na=4, nk=0) at Python/ceval.c:4131
#15 0x00007fb1ede23e00 in call_function (pp_stack=0x7ffc6fbe3a20, oparg=3)
    at Python/ceval.c:4056
---Type <return> to continue, or q <return> to quit---
#16 0x00007fb1ede1e642 in PyEval_EvalFrameEx (f=0x2050860, throwflag=0) at Python/ceval.c:2681
#17 0x00007fb1ede2110b in PyEval_EvalCodeEx (co=0x7fb1ecd59d50, globals=0x7fb1ee2df958, 
    locals=0x0, args=0x203fe20, argcount=2, kws=0x203fe30, kwcount=0, defs=0x7fb1e9075c88, 
    defcount=3, closure=0x0) at Python/ceval.c:3267
#18 0x00007fb1ede24233 in fast_function (func=0x7fb1e9076cd8, pp_stack=0x7ffc6fbe3ee0, n=2, 
    na=2, nk=0) at Python/ceval.c:4131
#19 0x00007fb1ede23e00 in call_function (pp_stack=0x7ffc6fbe3ee0, oparg=1)
    at Python/ceval.c:4056
#20 0x00007fb1ede1e642 in PyEval_EvalFrameEx (f=0x203fc20, throwflag=0) at Python/ceval.c:2681
#21 0x00007fb1ede2110b in PyEval_EvalCodeEx (co=0x7fb1ec8eda90, globals=0x7fb1ee2df958, 
    locals=0x0, args=0x1fa72a8, argcount=1, kws=0x1fa72b0, kwcount=1, defs=0x7fb1eba93988, 
    defcount=11, closure=0x0) at Python/ceval.c:3267
#22 0x00007fb1ede24233 in fast_function (func=0x7fb1e90795a0, pp_stack=0x7ffc6fbe43a0, n=3, 
    na=1, nk=1) at Python/ceval.c:4131
#23 0x00007fb1ede23e00 in call_function (pp_stack=0x7ffc6fbe43a0, oparg=257)
    at Python/ceval.c:4056
#24 0x00007fb1ede1e642 in PyEval_EvalFrameEx (f=0x1fa70d0, throwflag=0) at Python/ceval.c:2681
#25 0x00007fb1ede24119 in fast_function (func=0x7fb1e907be28, pp_stack=0x7ffc6fbe46d0, n=0, 
    na=0, nk=0) at Python/ceval.c:4121
#26 0x00007fb1ede23e00 in call_function (pp_stack=0x7ffc6fbe46d0, oparg=0)
    at Python/ceval.c:4056
#27 0x00007fb1ede1e642 in PyEval_EvalFrameEx (f=0x1e551a0, throwflag=0) at Python/ceval.c:2681
#28 0x00007fb1ede2110b in PyEval_EvalCodeEx (co=0x7fb1ec8f7d50, globals=0x7fb1ee2df958, 
    locals=0x7fb1ee2df958, args=0x0, argcount=0, kws=0x0, kwcount=0, defs=0x0, defcount=0, 
    closure=0x0) at Python/ceval.c:3267
#29 0x00007fb1ede16998 in PyEval_EvalCode (co=0x7fb1ec8f7d50, globals=0x7fb1ee2df958, 
    locals=0x7fb1ee2df958) at Python/ceval.c:669
#30 0x00007fb1ede2671b in exec_statement (f=0x1f8cb20, prog=0x7fb1ec8f7d50, 
    globals=0x7fb1ee2df958, locals=0x7fb1ee2df958) at Python/ceval.c:4732
#31 0x00007fb1ede1acea in PyEval_EvalFrameEx (f=0x1f8cb20, throwflag=0) at Python/ceval.c:1883
#32 0x00007fb1ede2110b in PyEval_EvalCodeEx (co=0x7fb1ecd62930, globals=0x7fb1ecd806c8, 
---Type <return> to continue, or q <return> to quit---
    locals=0x0, args=0x1ede0c8, argcount=7, kws=0x1ede100, kwcount=0, defs=0x7fb1ecd65aa8, 
    defcount=5, closure=0x0) at Python/ceval.c:3267
#33 0x00007fb1ede24233 in fast_function (func=0x7fb1ecd8d300, pp_stack=0x7ffc6fbe4fe0, n=7, 
    na=7, nk=0) at Python/ceval.c:4131
#34 0x00007fb1ede23e00 in call_function (pp_stack=0x7ffc6fbe4fe0, oparg=7)
    at Python/ceval.c:4056
#35 0x00007fb1ede1e642 in PyEval_EvalFrameEx (f=0x1eddef0, throwflag=0) at Python/ceval.c:2681
#36 0x00007fb1ede2110b in PyEval_EvalCodeEx (co=0x7fb1ecd7e1a0, globals=0x7fb1ecd806c8, 
    locals=0x0, args=0x7fb1ecda4da8, argcount=2, kws=0x0, kwcount=0, defs=0x7fb1ecd85e18, 
    defcount=1, closure=0x0) at Python/ceval.c:3267
#37 0x00007fb1edd5996f in function_call (func=0x7fb1ecd90b88, arg=0x7fb1ecda4d80, kw=0x0)
    at Objects/funcobject.c:526
#38 0x00007fb1edd19a7c in PyObject_Call (func=0x7fb1ecd90b88, arg=0x7fb1ecda4d80, kw=0x0)
    at Objects/abstract.c:2529
#39 0x00007fb1ede6e49c in RunModule (module=0x1e55010 "doctest", set_argv0=1)
    at Modules/main.c:192
#40 0x00007fb1ede6f42b in Py_Main (argc=6, argv=0x7ffc6fbe55c8) at Modules/main.c:587
#41 0x0000000000400846 in main (argc=6, argv=0x7ffc6fbe55c8) at ./Modules/python.c:23
```

Retried and hangs again at same spot.

This is a debug Python build (`SAGE_DEBUG=yes`)


---

Comment by vbraun created at 2016-02-18 23:40:15

Changing status from positive_review to needs_work.


---

Comment by fbissey created at 2016-02-19 00:00:21

Considering the change between rc0 and rc1 it is very strange if it didn't happen before.


---

Comment by jdemeyer created at 2016-02-19 09:35:52

It's also surprising that it doesn't happen with the interrupt code currently in Sage... it's the same code as in `cysignals`.


---

Comment by jdemeyer created at 2016-02-19 10:30:02

The `malloc()` problem is genuine. I will update `cysignals`.


---

Comment by git created at 2016-02-19 17:38:51

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2016-02-19 17:39:15

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2016-02-19 17:40:21

I disabled the failing `malloc()` test. Eventually we should move `sage_malloc()` and friends to `cysignals` too and re-enable the test.


---

Comment by jdemeyer created at 2016-02-22 08:35:59

needs review...


---

Comment by fbissey created at 2016-02-22 08:41:06

Changing status from needs_review to positive_review.


---

Comment by fbissey created at 2016-02-22 08:41:06

There, let's put it on one more time.


---

Comment by vbraun created at 2016-02-23 08:26:19

Resolution: fixed
