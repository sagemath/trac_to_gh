# Issue 25760: Fix bug in matrix space with prescribed implementation

Issue created by migration from https://trac.sagemath.org/ticket/25997

Original creator: SimonKing

Original creation time: 2018-08-04 10:17:46

CC:  vdelecroix jdemeyer tscrim

Currently, with SharedMeatAxe being installed, I get

```
sage: MS = MatrixSpace(GF(3),5, implementation='meataxe')
---------------------------------------------------------------------------
ValueError                                Traceback (most recent call last)
<ipython-input-3-d39fb0c2de0f> in <module>()
----> 1 MS = MatrixSpace(GF(Integer(3)),Integer(5), implementation='meataxe')

/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/misc/classcall_metaclass.pyx in sage.misc.classcall_metaclass.ClasscallMetaclass.__call__ (build/cythonized/sage/misc/classcall_metaclass.c:1639)()
    327         """
    328         if cls.classcall is not None:
--> 329             return cls.classcall(cls, *args, **kwds)
    330         else:
    331             # Fast version of type.__call__(cls, *args, **kwds)

/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/matrix/matrix_space.pyc in __classcall__(cls, base_ring, nrows, ncols, sparse, implementation)
    478             raise OverflowError("number of rows and columns may be at most %s" % sys.maxsize)
    479 
--> 480         matrix_cls = get_matrix_class(base_ring, nrows, ncols, sparse, implementation)
    481         return super(MatrixSpace, cls).__classcall__(
    482                 cls, base_ring, nrows, ncols, sparse, matrix_cls)

/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/matrix/matrix_space.pyc in get_matrix_class(R, nrows, ncols, sparse, implementation)
    306         # generic fallback
    307         if implementation != 'generic' and implementation is not None:
--> 308             raise ValueError("unknown matrix implementation %r over %r" % (implementation, R))
    309         else:
    310             return matrix_generic_dense.Matrix_generic_dense

ValueError: unknown matrix implementation 'meataxe' over Finite Field of size 3
```


I am unsure what component to choose. The bug isn't really about the optional package itself.


---

Comment by SimonKing created at 2018-08-04 10:18:05

Changing keywords from "" to "meataxe matrix space".


---

Comment by SimonKing created at 2018-08-04 10:26:42


```
sage: from sage.matrix.matrix_space import get_matrix_class
sage: get_matrix_class(GF(3),4,4,False, 'meataxe')
---------------------------------------------------------------------------
ValueError                                Traceback (most recent call last)
<ipython-input-2-9827f9b2c640> in <module>()
----> 1 get_matrix_class(GF(Integer(3)),Integer(4),Integer(4),False, 'meataxe')

/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/matrix/matrix_space.pyc in get_matrix_class(R, nrows, ncols, sparse, implementation)
    306         # generic fallback
    307         if implementation != 'generic' and implementation is not None:
--> 308             raise ValueError("unknown matrix implementation %r over %r" % (implementation, R))
    309         else:
    310             return matrix_generic_dense.Matrix_generic_dense

ValueError: unknown matrix implementation 'meataxe' over Finite Field of size 3
```


Oddly enough, it turns out that `get_matrix_class` doesn't even get as far as testing whether the base ring is a finite field.


---

Comment by SimonKing created at 2018-08-04 10:30:01

Gosh, the bug is in the test for an integer mod ring:

```
sage: sage.rings.finite_rings.integer_mod_ring.is_IntegerModRing(GF(3))
True
```


So, apparently its implementation has changed. I am not gonna argue about `is_IntegerModRing`, because mathematically `GF(3)` IS an integer mod ring. but then to the very least `get_matrix_class` should first test for finite fields and only later for integer mod rings.


---

Comment by SimonKing created at 2018-08-04 10:51:43

A finite prime field is at the same time an integer mod ring. So, if the implementation "meataxe" is requested for a matrix over a finite prime field, this case should be dealt with in the "if" clause testing for an integer mod ring. With that fix, at least the tests in src/sage/matrix pass. So, I'll push the branch in a minute...


---

Comment by SimonKing created at 2018-08-04 10:56:34

Changing status from new to needs_review.


---

Comment by SimonKing created at 2018-08-04 10:56:34

New commits:


---

Comment by jdemeyer created at 2018-08-04 11:07:19

I don't really like the logic of the code and the code duplication. That being said, this isn't your fault and maybe it would be too much to ask to refactor the code just to fix this bug.


---

Comment by SimonKing created at 2018-08-04 11:16:01

Replying to [comment:7 jdemeyer]:
> I don't really like the logic of the code and the code duplication. That being said, this isn't your fault and maybe it would be too much to ask to refactor the code just to fix this bug.

I'll try to see if I can simplify it a bit.


---

Comment by SimonKing created at 2018-08-04 11:19:07

I guess the logic should be:
1. Is a specific implementation requested? If this is the case, test whether this specific implementation supports the given base ring.
2. Otherwise, choose a default implementation according to whether R is finite, a field, a quotient ring, etc.

Currently, these two tasks are intertwined. First, some properties of the ring are checked and only then it is considered whether an implementation is requested.


---

Comment by git created at 2018-08-04 13:43:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by SimonKing created at 2018-08-04 13:47:21

I think the new commit provides a cleaner way of choosing the implementation for a matrix. The tests in src/sage/matrix pass (with optional meataxe), but I didn't run the full test suite yet.

Still needs review, of course.


---

Comment by tscrim created at 2018-08-04 22:26:59

Just two quick minor comments:

I believe there is a very mild behavior change when passing `implementation=''` (or `0` or `[]`, etc.) as now that will be treated the same as `implementation=None`.

I don't think you need the nested `if` inside of the `CDF` case (as you already have `not implementation` being `True`).


---

Comment by SimonKing created at 2019-07-21 07:12:56

Replying to [comment:13 tscrim]:
> Just two quick minor comments:
> 
> I believe there is a very mild behavior change when passing `implementation=''` (or `0` or `[]`, etc.) as now that will be treated the same as `implementation=None`.
> 
> I don't think you need the nested `if` inside of the `CDF` case (as you already have `not implementation` being `True`).

I just notice that I forgot to react.

Do you recall what "mild behaviour change" you see?


---

Comment by tscrim created at 2019-07-21 07:19:21

Replying to [comment:14 SimonKing]:
> Replying to [comment:13 tscrim]:
> > Just two quick minor comments:
> > 
> > I believe there is a very mild behavior change when passing `implementation=''` (or `0` or `[]`, etc.) as now that will be treated the same as `implementation=None`.
>
> Do you recall what "mild behaviour change" you see?

Before this would result in an error, but with you change, it now should get treated as if you passed `None`. It is not a bad thing IMO, but just something I noticed and am pointing out.


---

Comment by embray created at 2019-12-30 14:48:17

Ticket retargeted after milestone closed


---

Comment by vdelecroix created at 2020-02-22 15:45:19

Changing status from needs_review to needs_work.


---

Comment by vdelecroix created at 2020-02-22 15:45:19

I also think that `if implementation is None` should be prefered to `if not implementation`.


---

Comment by vdelecroix created at 2020-02-22 15:46:29

Could you put appropriate spacings as any other example in the file?

```
sage: get_matrix_class(GF(25,'x'),4,4,False, 'meataxe')
```

should be

```
sage: get_matrix_class(GF(25, 'x'), 4, 4, False, 'meataxe')
```



---

Comment by SimonKing created at 2020-02-22 16:18:54

Why am I getting errors when checking out the ticket branch?

```
remote branch: u/SimonKing/matrix_space_meataxe

From git://trac.sagemath.org/sage
 * branch                  u/SimonKing/matrix_space_meataxe -> FETCH_HEAD

Traceback (most recent call last):
  File "/home/king/.local/bin/git-trac", line 18, in <module>
    cmdline.launch()
  File "/home/king/Sage/git/git-trac-command/git_trac/cmdline.py", line 224, in launch
    app.pull(args.ticket_or_branch)
  File "/home/king/Sage/git/git-trac-command/git_trac/app.py", line 93, in pull
    self.repo.pull(remote)
  File "/home/king/Sage/git/git-trac-command/git_trac/git_repository.py", line 190, in pull
    self.git.echo.merge('FETCH_HEAD')
  File "/home/king/Sage/git/git-trac-command/git_trac/git_interface.py", line 341, in meth
    return self.execute(git_cmd, *args, **kwds)
  File "/home/king/Sage/git/git-trac-command/git_trac/git_interface.py", line 98, in execute
    popen_stderr=subprocess.PIPE)
  File "/home/king/Sage/git/git-trac-command/git_trac/git_interface.py", line 263, in _run
    raise GitError(result)
git_trac.git_error.GitError: git returned with non-zero exit code (1) when executing "git merge FETCH_HEAD"
    STDOUT: Auto-merging src/sage/matrix/matrix_space.py
    STDOUT: CONFLICT (content): Merge conflict in src/sage/matrix/matrix_space.py
    STDOUT: Automatic merge failed; fix conflicts and then commit the result.
    STDERR: Recorded preimage for 'src/sage/matrix/matrix_space.py'
```

I guess I will delete my local branch and try again.


---

Comment by git created at 2020-02-22 16:22:11

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by SimonKing created at 2020-02-22 16:22:29

Changing status from needs_work to needs_review.


---

Comment by vdelecroix created at 2020-02-22 16:44:13

I did some global cleaning. If it fits you, you can set positive review.
----
New commits:


---

Comment by SimonKing created at 2020-02-22 16:46:46

Replying to [comment:23 vdelecroix]:
> I did some global cleaning. If it fits you, you can set positive review.
> ----
> New commits:
> ||[7741f08](https://git.sagemath.org/sage.git/commit?id=7741f086c35387969cf1b41cf30c3dd320b932e9)||`25997: uniformize error message and code organization`||

Looks good, but I'd like to wait till there is a green blob... (or tests pass on my laptop, at least...).


---

Comment by SimonKing created at 2020-02-23 11:55:23

Changing status from needs_review to positive_review.


---

Comment by SimonKing created at 2020-02-23 11:55:23

Tests pass both without and with meataxe installed. Hence, I guess it is positive review.


---

Comment by vbraun created at 2020-02-25 19:51:14

Resolution: fixed
