# Issue 23848: mpir-3.0.0 does not compile on skylake chips

Issue created by migration from https://trac.sagemath.org/ticket/24085

Original creator: andrew.mathas

Original creation time: 2017-10-22 04:42:35

CC:  wbhart fbissey

Keywords: skylake, mpir

As discussed on [sage-devel](https://groups.google.com/forum/#!topic/sage-devel/P4GtTf2zo8k), mpir does not build skylake chips. As reported by Bill Hart,

    We know what the problem is now, but don't have a working patch to fix it. It's the JMPENT macro in mpn/x86_64/x86_64-defs.m4 that doesn't work on 64 bit OSX. Details of the issue can be found [https://gmplib.org/list-archives/gmp-bugs/2012-December/002836.html here.

A work around is to:
* unpack $SAGE_ROOT/upstream/mpir-3.0.0.tar.bz2
* delete the three files:
  - mpir-3.0.0/mpn/x86_64w/skylake/avx/addmul_1.as
  - mpir-3.0.0/mpn/x86_64w/skylake/avx/mul_basecase.asm
  - mpir-3.0.0/mpn/x86_64w/skylake/avx/sqr_basecase.asm
* recreate mpir-3.0.0.tar.bz2
* Fix thepackage  checksums: ./sage --package fix-checksum
* Rebuild mpri with: ./sage -f mpir


---

Comment by dimpase created at 2017-11-18 22:02:40

making this a blocker - we do want skylake in, no?


---

Comment by dimpase created at 2017-11-18 22:02:40

Changing priority from critical to blocker.


---

Comment by dimpase created at 2017-11-18 22:25:58

Changing status from new to needs_review.


---

Comment by dimpase created at 2017-11-18 22:25:58

New commits:


---

Comment by slelievre created at 2017-11-18 22:27:35

(Minor typo fixes and reformatting of ticket description.)


---

Comment by dimpase created at 2017-11-18 22:38:21

the actual state of the ticket reflected in the descr. now.


---

Comment by roed created at 2017-11-19 04:10:00

When I pull this change to a build that failed before, I get

```
[mpir-3.0.0.p0] libtool: link: /usr/bin/gcc -dynamiclib -Wl,-undefined -Wl,dynamic_lookup -o .libs/libmpir.23.dylib  .libs/assert.o .libs/compat.o .libs/errno.o .libs/extract-dbl.o .libs/invalid.o .libs/memory.o .li
[mpir-3.0.0.p0] ld: in section __DATA,__const reloc 0: X86_64_RELOC_SUBTRACTOR must have r_extern=1 file 'mpn/.libs/addmul_1.o' for architecture x86_64
[mpir-3.0.0.p0] clang: error: linker command failed with exit code 1 (use -v to see invocation)
```

Full log posted at http://www.pitt.edu/~roed/mpir-24085.log.

I'll try starting from a fresh sage-8.1.rc2.


---

Comment by roed created at 2017-11-19 04:26:46

Very similar looking error when trying with a fresh Sage.  Log posted at http://www.pitt.edu/~roed/mpir-24085_2.log


---

Comment by dimpase created at 2017-11-19 07:49:27

Changing status from needs_review to needs_work.


---

Comment by dimpase created at 2017-11-19 08:06:58

Well, I merely presented in a patch form what was reported by Andrew to be a working workaround. Without access to the corresponding OS/arch combo, I can't do much.


---

Comment by dimpase created at 2017-11-19 14:34:47

David, could you post the output of MPIR's ./config.guess for your system?

I'm thinking about a better way to fix this: detect skylake+OSX combo and
pass a different (working) arch to the MPIR build system.


---

Comment by roed created at 2017-11-19 17:01:29

Replying to [comment:9 dimpase]:
> David, could you post the output of MPIR's ./config.guess for your system?

It's at http://www.pitt.edu/~roed/config.guess


---

Comment by dimpase created at 2017-11-19 17:24:05

Replying to [comment:10 roed]:
> Replying to [comment:9 dimpase]:
> > David, could you post the output of MPIR's ./config.guess for your system?
> 
> It's at http://www.pitt.edu/~roed/config.guess

this looks like a script. I meant: `cd $SAGE_ROOT/upstream; tar xf mpir-3.0.0.tar.gz; cd mpir-3.0.0; ./config.guess`

e.g. on my laptop I get the output
`skylakeavx-unknown-linux-gnu`


---

Comment by roed created at 2017-11-19 17:32:33

Replying to [comment:11 dimpase]:
> Replying to [comment:10 roed]:
> > Replying to [comment:9 dimpase]:
> > > David, could you post the output of MPIR's ./config.guess for your system?
> > 
> > It's at http://www.pitt.edu/~roed/config.guess
> 
> this looks like a script. I meant: `cd $SAGE_ROOT/upstream; tar xf mpir-3.0.0.tar.gz; cd mpir-3.0.0; ./config.guess`

Ah, thanks.
 
> e.g. on my laptop I get the output
> `skylakeavx-unknown-linux-gnu`

I get `skylakeavx-apple-darwin16.7.0`


---

Comment by alexjbest created at 2017-11-19 18:09:41

So I also don't have the set up to test this, but it looks like deleting the files in x86_64w is the wrong place. the 64w folder is for windows code and wouldn't be used by osx? Perhaps deleting the files just in x86_64 will work.
(If we look at David's log it does config.status: linking mpn/x86_64/skylake/avx/addmul_1.asm to mpn/addmul_1.asm so osx is using the x86_64 code)


---

Comment by roed created at 2017-11-20 03:29:27

Deleting the files in x86_64 or x86_64w?  There's also x86w....


---

Comment by alexjbest created at 2017-11-20 03:48:56

x86_64 is 64bit *nix abi, x86_64w is 64bit windows, x86(w) is older 32-bit stuff for linux (resp. windows) . mpn/x86_64/ is what's being linked on your machine.


---

Comment by roed created at 2017-11-20 04:22:52

I tried

```
cd upstream/mpir-3.0.0/mpn/x86_64
rm -rf *
cd $SAGE_ROOT && make
```


I still get

```
[mpir-3.0.0.p1] libtool: link: gcc -dynamiclib -Wl,-undefined -Wl,dynamic_lookup -o .libs/libmpir.23.dylib  .libs/assert.o .libs/compat.o .libs/errno.o .libs/extract-dbl.o .libs/invalid.o .libs/memory.o .libs/mp_bpi
[mpir-3.0.0.p1] ld: in section __DATA,__const reloc 0: X86_64_RELOC_SUBTRACTOR must have r_extern=1 file 'mpn/.libs/addmul_1.o' for architecture x86_64
[mpir-3.0.0.p1] clang: error: linker command failed with exit code 1 (use -v to see invocation)
```


Let me know if you have any other ideas....


---

Comment by alexjbest created at 2017-11-20 04:29:26

Sorry I was being lazy you don't want to remove all the x86_64 code just the 3 from before just from the right folder:
mpir-3.0.0/mpn/x86_64/skylake/avx/addmul_1.asm
mpir-3.0.0/mpn/x86_64/skylake/avx/mul_basecase.asm
mpir-3.0.0/mpn/x86_64/skylake/avx/sqr_basecase.asm
also you need to re-run ./configure after this, is sage make doing that?


---

Comment by roed created at 2017-11-20 05:23:54

I downloaded a fresh copy of sage and deleted the files.   At first I didn't see your comment about `./configure`, but after getting an error, I ran `./configure && make`, to no avail:

```
[mpir-3.0.0.p0] /bin/sh ./libtool  --tag=CC   --mode=link gcc  -m64 -O2 -march=skylake -mtune=skylake  -g    -version-info 23:3:0 -L/Users/roed/sage/sage-8.1.rc2/local/lib -Wl,-rpath,/Users/roed/sage/sage-8.1.rc2/ls
[mpir-3.0.0.p0] libtool: link: gcc -dynamiclib -Wl,-undefined -Wl,dynamic_lookup -o .libs/libmpir.23.dylib  .libs/assert.o .libs/compat.o .libs/errno.o .libs/extract-dbl.o .libs/invalid.o .libs/memory.o .libs/mp_bps
[mpir-3.0.0.p0] ld: in section __DATA,__const reloc 0: X86_64_RELOC_SUBTRACTOR must have r_extern=1 file 'mpn/.libs/addmul_1.o' for architecture x86_64
[mpir-3.0.0.p0] clang: error: linker command failed with exit code 1 (use -v to see invocation)
```



---

Comment by dimpase created at 2017-11-20 08:09:56

Following a tip from Bill, I am able to reproduce the issue on a non-skylake OSX 10.12 machine (with XCode 9). To do this (in MPIR source dir), do 

```
./configure --host=skylakeavx-apple-darwin16.7.0
make
```

and get the familiar

```
ld: in section __DATA,__const reloc 0: X86_64_RELOC_SUBTRACTOR must have r_extern=1 file 'mpn/.libs/addmul_1.o' for architecture x86_64
```


(This should also work on Travis CI, if you are so inclined (although in my experience Travis is quite slow on OSX).

Now the plan is to lift the fix for the responsible m4 off GMP...


---

Comment by dimpase created at 2017-11-20 16:09:57

I am trying the following patch, basically taken from GMP

```
diff --git a/mpn/x86_64/x86_64-defs.m4 b/mpn/x86_64/x86_64-defs.m4
index 120efc7..0f65e55 100644
--- a/mpn/x86_64/x86_64-defs.m4
+++ b/mpn/x86_64/x86_64-defs.m4
@@ -129,9 +129,10 @@ dnl  Usage: JMPENT(targlabel,tablabel)
 
 define(`JMPENT',`dnl
 ifdef(`PIC',
-    `.long  $1-$2'
+        `.set   $1_tmp, $1-$2
+        .long   $1_tmp'
 ,
-    `.quad  $1'
+        `.quad  $1'
 )')
 
 dnl  Usage: call_mcount
@@ -666,7 +667,7 @@ define(`R8',
                 $1,`%r14',`%r14b',
                 $1,`%r15',`%r15b')')
 
-define(`JUMPTABSECT', `.section .data.rel.ro.local,"aw",@progbits')
+define(`JUMPTABSECT', `.text')
 
 
 dnl  Usage: JMPENT(targlabel,tablabel)
```

but it does not work, neither with the native (clang) toolchain, nor with gcc-7.2. (Same error with `addmul_1.o` as above).
Could it be something to do with internal vs non-internal assembly?


---

Comment by dimpase created at 2017-11-21 14:44:55

Changing status from needs_work to needs_review.


---

Comment by dimpase created at 2017-11-21 14:44:55

Please try this on the "real" skylake. It builds on the fake one (i.e. with `--host=skylakeavx-apple-darwin16.7.0`).

In the previous attempt I missed that JMPENT and JUMPTABSECT are defined twice...
----
New commits:


---

Comment by jdemeyer created at 2017-11-21 16:02:55

Changing status from needs_review to needs_info.


---

Comment by jdemeyer created at 2017-11-21 16:02:55

The ticket says "Workaround found; Bug reported upstream." but where is the upstream report?

And please add a link to this ticket in the patch file.


---

Comment by roed created at 2017-11-21 16:04:08

I'm past the mpir compilation: looking good so far.  I'll report once it's done and I've run tests.


---

Comment by roed created at 2017-11-21 17:05:38

I'm getting an error building gcc:

```
[gcc-7.2.0] /Users/roed/sage/sage-8.1.rc2/local/var/tmp/sage/build/gcc-7.2.0/gcc-build/./gcc/xgcc -B/Users/roed/sage/sage-8.1.rc2/local/var/tmp/sage/build/gcc-7.2.0/gcc-build/./gcc/ -nostdinc -x c /dev/null -S -o /d
[gcc-7.2.0] <built-in>: internal compiler error: Bus error: 10
[gcc-7.2.0] libbacktrace could not find executable to open
[gcc-7.2.0] Please submit a full bug report,
[gcc-7.2.0] with preprocessed source if appropriate.
[gcc-7.2.0] See <https://gcc.gnu.org/bugs/> for instructions.
[gcc-7.2.0] make[6]: *** [s-selftest] Error 1
[gcc-7.2.0] rm gcc.pod
[gcc-7.2.0] make[5]: *** [all-stage1-gcc] Error 2
[gcc-7.2.0] make[4]: *** [stage1-bubble] Error 2
[gcc-7.2.0] make[3]: *** [all] Error 2
```

Full log at http://www.pitt.edu/~roed/gcc_24085.log


---

Comment by dimpase created at 2017-11-21 17:23:16

OK, now I see that on my machine MPIR with this patch fails standalone tests. :-(

That's probably why gcc can't be built (mpir is used )
Let me try few variations to see if I can make it work.


---

Comment by dimpase created at 2017-11-21 17:59:48

In fact, it's linking errors that I get; the MPIR tests fail with the following:

```
$ less tests/t-constants.log 
dyld: Symbol not found: .Ll0m4_tmp
  Referenced from: /Volumes/Sage/sage/upstream/mpir-3.0.0/.libs/libmpir.23.dylib
  Expected in: flat namespace
 in /Volumes/Sage/sage/upstream/mpir-3.0.0/.libs/libmpir.23.dylib
```



---

Comment by dimpase created at 2017-11-22 12:04:37

Right, the problem turns out to be that some assembler code in MPIR does not work with the new version of the JMPENT macro.
Updating it still leads to two errors in MPIR testsuite. See https://github.com/wbhart/mpir/issues/232

It would be great if someone can tell how to write an m4 macro that is conditional on the OS type (we only need to change JMPENT on OSX).


---

Comment by vbraun created at 2017-11-22 17:50:29

This ticket doesn't look like it'll be ready any time soon, skip it for 8.1?


---

Comment by dimpase created at 2017-11-22 17:54:44

Replying to [comment:29 vbraun]:
> This ticket doesn't look like it'll be ready any time soon, skip it for 8.1?

I hope to have a working version by the end of today... But it's up to you, I think Apple should not slow Sage down (without paying us, for sure :-))


---

Comment by roed created at 2017-11-22 19:34:52

Replying to [comment:30 dimpase]:
> Replying to [comment:29 vbraun]:
> > This ticket doesn't look like it'll be ready any time soon, skip it for 8.1?
> 
> I hope to have a working version by the end of today... But it's up to you, I think Apple should not slow Sage down (without paying us, for sure :-))

I can't help with the fix itself, but I'm happy to keep helping with testing.


---

Comment by dimpase created at 2017-11-23 15:35:03

Replying to [comment:31 roed]:
> Replying to [comment:30 dimpase]:
> > Replying to [comment:29 vbraun]:
> > > This ticket doesn't look like it'll be ready any time soon, skip it for 8.1?
> > 
> > I hope to have a working version by the end of today... But it's up to you, I think Apple should not slow Sage down (without paying us, for sure :-))
> 
> I can't help with the fix itself, but I'm happy to keep helping with testing.

Could you try out (the master of) https://github.com/dimpase/mpir.git ?
that is, 

```
git clone https://github.com/dimpase/mpir.git
cd mpir
./autogen.sh
./configure CC=cc --prefix=/tmp/blah && make -j8 && make -j8 check
```

(assuming you have `yasm` installed)
This fails 2 tests on non-skylake, perhaps it would work on skylake?


---

Comment by andrew.mathas created at 2017-11-23 17:07:44

I'm running xcode Version 9.0 (9A235) on on mscox 10.12.16. I got the following errors:

```
PASS: t-addadd_n
PASS: t-addsub_n
PASS: t-aors_1
../../test-driver: line 107: 94805 Bus error: 10           "$@" > $log_file 2>&1
../../test-driver: line 107: 94803 Bus error: 10           "$@" > $log_file 2>&1
FAIL: t-dc_bdiv_q
PASS: t-asmtype
FAIL: t-dc_bdiv_q_n
../../test-driver: line 107: 94861 Bus error: 10           "$@" > $log_file 2>&1
../../test-driver: line 107: 94862 Bus error: 10           "$@" > $log_file 2>&1
../../test-driver: line 107: 94863 Bus error: 10           "$@" > $log_file 2>&1
FAIL: t-dc_div_q
FAIL: t-dc_bdiv_qr
FAIL: t-dc_bdiv_qr_n
../../test-driver: line 107: 94918 Bus error: 10           "$@" > $log_file 2>&1
../../test-driver: line 107: 94920 Bus error: 10           "$@" > $log_file 2>&1
../../test-driver: line 107: 94919 Bus error: 10           "$@" > $log_file 2>&1
FAIL: t-dc_div_qr_n
FAIL: t-dc_divappr_q
FAIL: t-dc_div_qr
PASS: t-divrem_1
PASS: t-divebyff
PASS: t-divebyfobm1
../../test-driver: line 107: 95028 Bus error: 10           "$@" > $log_file 2>&1
../../test-driver: line 107: 95027 Bus error: 10           "$@" > $log_file 2>&1
FAIL: t-gcdext
FAIL: t-fat
PASS: t-get_d
PASS: t-instrument
../../test-driver: line 107: 95085 Bus error: 10           "$@" > $log_file 2>&1
FAIL: t-hgcd
../../test-driver: line 107: 95115 Bus error: 10           "$@" > $log_file 2>&1
FAIL: t-inv_div_q
../../test-driver: line 107: 95141 Bus error: 10           "$@" > $log_file 2>&1
../../test-driver: line 107: 95142 Bus error: 10           "$@" > $log_file 2>&1
FAIL: t-inv_div_qr
FAIL: t-inv_div_qr_n
../../test-driver: line 107: 95174 Bus error: 10           "$@" > $log_file 2>&1
FAIL: t-inv_divappr_q
../../test-driver: line 107: 95199 Bus error: 10           "$@" > $log_file 2>&1
../../test-driver: line 107: 95198 Bus error: 10           "$@" > $log_file 2>&1
FAIL: t-invert
FAIL: t-inv_divappr_q_n
PASS: t-iord_u
../../test-driver: line 107: 95255 Bus error: 10           "$@" > $log_file 2>&1
FAIL: t-matrix22
PASS: t-mp_bases
../../test-driver: line 107: 95307 Bus error: 10           "$@" > $log_file 2>&1
FAIL: t-mullow_basecase
../../test-driver: line 107: 95326 Bus error: 10           "$@" > $log_file 2>&1
FAIL: t-mullowhigh
../../test-driver: line 107: 95364 Bus error: 10           "$@" > $log_file 2>&1
FAIL: t-mulmod_2expm1
PASS: t-lorrshift1
../../test-driver: line 107: 95383 Bus error: 10           "$@" > $log_file 2>&1
FAIL: t-mulmod_2expp1
../../test-driver: line 107: 95345 Bus error: 10           "$@" > $log_file 2>&1
FAIL: t-mulmid
PASS: t-perfsqr
../../test-driver: line 107: 95441 Bus error: 10           "$@" > $log_file 2>&1
FAIL: t-redc_1
PASS: t-neg
../../test-driver: line 107: 95455 Bus error: 10           "$@" > $log_file 2>&1
FAIL: t-sb_bdiv_q
../../test-driver: line 107: 95479 Bus error: 10           "$@" > $log_file 2>&1
FAIL: t-sb_bdiv_qr
../../test-driver: line 107: 95495 Bus error: 10           "$@" > $log_file 2>&1
FAIL: t-sb_div_q
../../test-driver: line 107: 95499 Bus error: 10           "$@" > $log_file 2>&1
FAIL: t-sb_div_qr
../../test-driver: line 107: 95536 Bus error: 10           "$@" > $log_file 2>&1
FAIL: t-sb_divappr_q
PASS: t-scan
../../test-driver: line 107: 95558 Segmentation fault: 11  "$@" > $log_file 2>&1
FAIL: t-sizeinbase
PASS: t-subadd_n
../../test-driver: line 107: 95609 Bus error: 10           "$@" > $log_file 2>&1
FAIL: t-tdiv_q
../../test-driver: line 107: 95614 Bus error: 10           "$@" > $log_file 2>&1
FAIL: t-tdiv_qr
PASS: st_fat
PASS: st_instrument
```

Happy to upload the log but I couldn't find it...


---

Comment by dimpase created at 2017-11-23 17:16:37

Could we get the `./configure` log?


---

Comment by roed created at 2017-11-23 18:10:23

I get similar errors; my log is at http://www.pitt.edu/~roed/config_24085.log


---

Attachment

Log file for failed build


---

Comment by dimpase created at 2017-11-23 19:38:10

Please try the latest updates: do `git pull` in the mpir git repo, then
`make distclean` followed by `./autogen.sh` etc.


---

Comment by roed created at 2017-11-24 04:30:41

Still similar looking failures.  I've uploaded the new log to http://www.pitt.edu/~roed/config_24085_2.log


---

Comment by roed created at 2017-11-24 04:31:37

The test output is

```
/Library/Developer/CommandLineTools/usr/bin/make  check-TESTS
../../test-driver: line 107: 31065 Bus error: 10           "$@" > $log_file 2>&1
PASS: t-asmtype
FAIL: t-dc_bdiv_q
PASS: t-aors_1
../../test-driver: line 107: 31068 Bus error: 10           "$@" > $log_file 2>&1
PASS: t-addsub_n
FAIL: t-dc_bdiv_q_n
../../test-driver: line 107: 31067 Bus error: 10           "$@" > $log_file 2>&1
../../test-driver: line 107: 31069 Bus error: 10           "$@" > $log_file 2>&1
FAIL: t-dc_bdiv_qr
FAIL: t-dc_bdiv_qr_n
PASS: t-addadd_n
../../test-driver: line 107: 31217 Bus error: 10           "$@" > $log_file 2>&1
../../test-driver: line 107: 31214 Bus error: 10           "$@" > $log_file 2>&1
../../test-driver: line 107: 31218 Bus error: 10           "$@" > $log_file 2>&1
FAIL: t-dc_div_qr
FAIL: t-dc_div_qr_n
FAIL: t-dc_divappr_q
../../test-driver: line 107: 31215 Bus error: 10           "$@" > $log_file 2>&1
FAIL: t-dc_div_q
PASS: t-divebyff
PASS: t-divrem_1
../../test-driver: line 107: 31225 Bus error: 10           "$@" > $log_file 2>&1
FAIL: t-fat
../../test-driver: line 107: 31352 Bus error: 10           "$@" > $log_file 2>&1
PASS: t-instrument
../../test-driver: line 107: 31350 Bus error: 10           "$@" > $log_file 2>&1
../../test-driver: line 107: 31346 Bus error: 10           "$@" > $log_file 2>&1
FAIL: t-inv_div_q
FAIL: t-hgcd
FAIL: t-gcdext
PASS: t-get_d
PASS: t-divebyfobm1
../../test-driver: line 107: 31423 Bus error: 10           "$@" > $log_file 2>&1
FAIL: t-inv_div_qr
../../test-driver: line 107: 31442 Bus error: 10           "$@" > $log_file 2>&1
FAIL: t-inv_div_qr_n
../../test-driver: line 107: 31480 Bus error: 10           "$@" > $log_file 2>&1
FAIL: t-inv_divappr_q
../../test-driver: line 107: 31484 Bus error: 10           "$@" > $log_file 2>&1
../../test-driver: line 107: 31482 Bus error: 10           "$@" > $log_file 2>&1
PASS: t-iord_u
FAIL: t-invert
FAIL: t-inv_divappr_q_n
../../test-driver: line 107: 31489 Bus error: 10           "$@" > $log_file 2>&1
FAIL: t-matrix22
PASS: t-mp_bases
../../test-driver: line 107: 31591 Bus error: 10           "$@" > $log_file 2>&1
FAIL: t-mullow_basecase
../../test-driver: line 107: 31628 Bus error: 10           "$@" > $log_file 2>&1
FAIL: t-mullowhigh
../../test-driver: line 107: 31632 Bus error: 10           "$@" > $log_file 2>&1
FAIL: t-mulmod_2expm1
PASS: t-perfsqr
../../test-driver: line 107: 31709 Bus error: 10           "$@" > $log_file 2>&1
FAIL: t-redc_1
../../test-driver: line 107: 31730 Bus error: 10           "$@" > $log_file 2>&1
FAIL: t-sb_bdiv_q
../../test-driver: line 107: 31750 Bus error: 10           "$@" > $log_file 2>&1
FAIL: t-sb_bdiv_qr
../../test-driver: line 107: 31762 Bus error: 10           "$@" > $log_file 2>&1
FAIL: t-sb_div_q
../../test-driver: line 107: 31781 Bus error: 10           "$@" > $log_file 2>&1
FAIL: t-sb_div_qr
../../test-driver: line 107: 31806 Bus error: 10           "$@" > $log_file 2>&1
FAIL: t-sb_divappr_q
PASS: t-scan
PASS: t-neg
../../test-driver: line 107: 31839 Segmentation fault: 11  "$@" > $log_file 2>&1
FAIL: t-sizeinbase
PASS: t-subadd_n
PASS: st_fat
PASS: st_instrument
../../test-driver: line 107: 31881 Bus error: 10           "$@" > $log_file 2>&1
FAIL: t-tdiv_q
../../test-driver: line 107: 31907 Bus error: 10           "$@" > $log_file 2>&1
FAIL: t-tdiv_qr
../../test-driver: line 107: 31631 Bus error: 10           "$@" > $log_file 2>&1
FAIL: t-mulmid
../../test-driver: line 107: 31933 Bus error: 10           "$@" > $log_file 2>&1
FAIL: t-mulmod_2expp1
PASS: t-lorrshift1
============================================================================
Testsuite summary for MPIR 3.0.0
============================================================================
# TOTAL: 50
# PASS:  18
# SKIP:  0
# XFAIL: 0
# FAIL:  32
# XPASS: 0
# ERROR: 0
============================================================================
See tests/mpn/test-suite.log
Please report to http://groups.google.co.uk/group/mpir-devel/
============================================================================
make[5]: *** [test-suite.log] Error 1
make[4]: *** [check-TESTS] Error 2
make[3]: *** [check-am] Error 2
make[2]: *** [check-recursive] Error 1
make[1]: *** [check-recursive] Error 1
make: *** [check] Error 2
```



---

Comment by dimpase created at 2017-11-24 12:17:20

Changing status from needs_info to needs_work.


---

Comment by dimpase created at 2017-11-24 12:17:20

Changing priority from blocker to critical.


---

Comment by dimpase created at 2017-11-24 12:17:20

OK, I give up on trying to fix the assembler code there. This needs debugging on an actual box.


---

Comment by dimpase created at 2017-11-24 16:44:07

OK, please try the latest
https://github.com/dimpase/mpir 

[this commit](https://github.com/dimpase/mpir/commit/65bb82fdf65765e6edfbbbf8edb47c726413b8da) should hopefully suffice.


---

Comment by dimpase created at 2017-11-24 16:44:17

Changing status from needs_work to needs_review.


---

Comment by roed created at 2017-11-24 17:53:08

The commit passes all tests in

```
./configure CC=cc --prefix=/tmp/blah && make -j8 && make -j8 check
```

Wonderful!

Now I'm trying the Sage fix.


---

Comment by dimpase created at 2017-11-24 18:09:45

OK, great.

Oops, sorry, there is no Sage patch up yet. I was waiting for a confirmation that this fix works. Now I need to make a patch against mpir 3.0.0. Please bear with me.


---

Comment by roed created at 2017-11-24 18:52:41

No problem!  Thanks for your work on this; debugging assembler without access to the architecture+OS sounds hard....

I could also have noticed that there was no new patch, but I'd just woken up. :-)


---

Comment by dimpase created at 2017-11-24 19:11:32

Just asked upstream for a new release - packaging all these changes since 3.0.0 is
a pain.


---

Comment by dimpase created at 2017-11-24 19:39:42

get the non-official tarball from http://users.ox.ac.uk/~coml0531/sage/mpir-3.0.1.tar.bz2
Please test.

The upstream promises a release, but it's not instant.
----
New commits:


---

Comment by roed created at 2017-11-24 21:34:41

I downloaded a fresh sage-8.1.rc3, downloaded the mpir tarball and put it in `upstream`, deleted `mpir-3.0.0.tar.bz2`, applied the branch on this ticket and then ran `make`.  It resulted in the following error:

```
sage-logger -p 'sage-spkg mpir-3.0.1.p0' '/Users/roed/sage/sage-8.1.rc3/logs/pkgs/mpir-3.0.1.p0.log'
[mpir-3.0.1.p0] Found local metadata for mpir-3.0.1.p0
[mpir-3.0.1.p0] Using cached file /Users/roed/sage/sage-8.1.rc3/upstream/mpir-3.0.1.tar.bz2
[mpir-3.0.1.p0] mpir-3.0.1.p0
[mpir-3.0.1.p0] ====================================================
[mpir-3.0.1.p0] Setting up build directory for mpir-3.0.1.p0
[mpir-3.0.1.p0] Finished extraction
[mpir-3.0.1.p0] No patch files found in ../patches
[mpir-3.0.1.p0] ****************************************************
[mpir-3.0.1.p0] Host system:
[mpir-3.0.1.p0] Darwin Davids-MBP.home.int.hackorp.com 16.7.0 Darwin Kernel Version 16.7.0: Thu Jun 15 17:36:27 PDT 2017; root:xnu-3789.70.16~2/RELEASE_X86_64 x86_64
[mpir-3.0.1.p0] ****************************************************
[mpir-3.0.1.p0] C compiler: gcc
[mpir-3.0.1.p0] C compiler version:
[mpir-3.0.1.p0] Configured with: --prefix=/Library/Developer/CommandLineTools/usr --with-gxx-include-dir=/usr/include/c++/4.2.1
[mpir-3.0.1.p0] Apple LLVM version 9.0.0 (clang-900.0.37)
[mpir-3.0.1.p0] Target: x86_64-apple-darwin16.7.0
[mpir-3.0.1.p0] Thread model: posix
[mpir-3.0.1.p0] InstalledDir: /Library/Developer/CommandLineTools/usr/bin
[mpir-3.0.1.p0] ****************************************************
[mpir-3.0.1.p0] Machine type (default): x86_64-apple-darwin16.7.0
[mpir-3.0.1.p0] Machine type (mpir): skylakeavx-apple-darwin16.7.0
[mpir-3.0.1.p0] Building a 64-bit version of MPIR, which is the default.
[mpir-3.0.1.p0] Building a reduced version of MPIR to bootstrap GCC.
[mpir-3.0.1.p0] MPIR will later get rebuilt (with the C++ interface and static libraries
[mpir-3.0.1.p0] enabled) using the new compiler.
[mpir-3.0.1.p0] ------------------------------------------------------------------------
[mpir-3.0.1.p0] Configuring MPIR with empty CFLAGS to determine the defaults:
[mpir-3.0.1.p0] configure: error: cannot find install-sh, install.sh, or shtool in "." "./.." "./../.."
[mpir-3.0.1.p0] Error configuring MPIR (with CFLAGS unset).
[mpir-3.0.1.p0] Consult /Users/roed/sage/sage-8.1.rc3/local/var/tmp/sage/build/mpir-3.0.1.p0/src/config.log for for details.
[mpir-3.0.1.p0] 
[mpir-3.0.1.p0] real	0m0.695s
[mpir-3.0.1.p0] user	0m0.240s
[mpir-3.0.1.p0] sys	0m0.343s
[mpir-3.0.1.p0] ************************************************************************
[mpir-3.0.1.p0] Error installing package mpir-3.0.1.p0
[mpir-3.0.1.p0] ************************************************************************
[mpir-3.0.1.p0] Please email sage-devel (http://groups.google.com/group/sage-devel)
[mpir-3.0.1.p0] explaining the problem and including the log file
[mpir-3.0.1.p0]   /Users/roed/sage/sage-8.1.rc3/logs/pkgs/mpir-3.0.1.p0.log
[mpir-3.0.1.p0] Describe your computer, operating system, etc.
[mpir-3.0.1.p0] If you want to try to fix the problem yourself, *don't* just cd to
[mpir-3.0.1.p0] /Users/roed/sage/sage-8.1.rc3/local/var/tmp/sage/build/mpir-3.0.1.p0 and type 'make' or whatever is appropriate.
[mpir-3.0.1.p0] Instead, the following commands setup all environment variables
[mpir-3.0.1.p0] correctly and load a subshell for you to debug the error:
[mpir-3.0.1.p0]   (cd '/Users/roed/sage/sage-8.1.rc3/local/var/tmp/sage/build/mpir-3.0.1.p0' && '/Users/roed/sage/sage-8.1.rc3/sage' --sh)
[mpir-3.0.1.p0] When you are done debugging, you can type "exit" to leave the subshell.
[mpir-3.0.1.p0] ************************************************************************
make[2]: *** [/Users/roed/sage/sage-8.1.rc3/local/var/lib/sage/installed/mpir-3.0.1.p0] Error 1
make[1]: *** [all-toolchain] Error 2
```

I've posted `local/var/tmp/sage/build/mpir-3.0.1.p0/src/config.log` at http://www.pitt.edu/~roed/config_24085_3.log


---

Comment by wbhart created at 2017-11-24 21:37:11

I think I should clarify that there is no "upstream". I am happy to advise on what needs to be done and upload tarballs to the website, but MPIR is a community supported project now. I am of course merging patches, and my repository is still the official repository, but that is the limit of my contribution, unless I personally need something myself.


---

Comment by wbhart created at 2017-11-24 21:41:31

I'm not sure how the tarball was created, but in general you can't make a tarball from the MPIR repository without running make dist, since it does some post changes. And make dist should only be run if all the paperwork is up-to-date, version numbers have been updated and the .so versioning is taken care of.


---

Comment by dimpase created at 2017-11-24 21:55:35

Replying to [comment:47 roed]:
> I downloaded a fresh sage-8.1.rc3, downloaded the mpir tarball and put it in `upstream`, deleted `mpir-3.0.0.tar.bz2`, applied the branch on this ticket and then ran `make`.


IMHO you might need to run `./configure` before running `make`. It could be that the install procedure got confused about the package versions...

The tarball worked for me on an installation of Sage, where I 
dropped it to upstream/, pulled the branch, and ran `./sage -f mpir` followed by make...


---

Comment by dimpase created at 2017-11-24 22:12:51

Replying to [comment:49 wbhart]:
> I'm not sure how the tarball was created, but in general you can't make a tarball from the MPIR repository without running make dist, since it does some post changes. And make dist should only be run if all the paperwork is up-to-date, version numbers have been updated and the .so versioning is taken care of.

Hereby, in regard of allegations of fragrant tarball paperwork forgery, I invoke the 5th.

Whereas, there is no direct connection between Sage package numbers and versions of the library. Thus the tarball will pretend to be mpir 3.0.0, I think...


---

Comment by roed created at 2017-11-24 23:31:55

Replying to [comment:50 dimpase]:
> Replying to [comment:47 roed]:
> > I downloaded a fresh sage-8.1.rc3, downloaded the mpir tarball and put it in `upstream`, deleted `mpir-3.0.0.tar.bz2`, applied the branch on this ticket and then ran `make`.
> 
> 
> IMHO you might need to run `./configure` before running `make`. It could be that the install procedure got confused about the package versions...

I tried `./configure && make`, with no success. 
 
> The tarball worked for me on an installation of Sage, where I 
> dropped it to upstream/, pulled the branch, and ran `./sage -f mpir` followed by make...

I didn't pull anything, but I wouldn't expect that to be necessary given that you made a tarball with the changes.  I'm not sure how to proceed....


---

Comment by dimpase created at 2017-11-24 23:48:00

Replying to [comment:52 roed]:
> Replying to [comment:50 dimpase]:
> > Replying to [comment:47 roed]:
> > > I downloaded a fresh sage-8.1.rc3, downloaded the mpir tarball and put it in `upstream`, deleted `mpir-3.0.0.tar.bz2`, applied the branch on this ticket and then ran `make`.
> > 
> > 
> > IMHO you might need to run `./configure` before running `make`. It could be that the install procedure got confused about the package versions...
> 
> I tried `./configure && make`, with no success. 
>  
> > The tarball worked for me on an installation of Sage, where I 
> > dropped it to upstream/, pulled the branch, and ran `./sage -f mpir` followed by make...
> 
> I didn't pull anything, but I wouldn't expect that to be necessary given that you made a tarball with the changes.  I'm not sure how to proceed....

You do need to pull the branch `u/dimpase/skylakefix`.  It is very short:

```
diff --git a/build/pkgs/mpir/checksums.ini b/build/pkgs/mpir/checksums.ini
index 185e5ca..d2acf76 100644
--- a/build/pkgs/mpir/checksums.ini
+++ b/build/pkgs/mpir/checksums.ini
@@ -1,4 +1,4 @@
 tarball=mpir-VERSION.tar.bz2
-sha1=8300b351b730891dfb9cb1e411a5ca39eee73fda
-md5=4e5d16676e0cd6773f43bbbeb5cb0016
-cksum=2173521258
+sha1=1f7081c2f4a83fb4e9e3453bbafb6aa18f1c5d5a
+md5=308f4a981c0a2e796aa41ff3ac805b81
+cksum=2473237225
diff --git a/build/pkgs/mpir/package-version.txt b/build/pkgs/mpir/package-version.txt
index e3e3689..a7590f2 100644
--- a/build/pkgs/mpir/package-version.txt
+++ b/build/pkgs/mpir/package-version.txt
@@ -1 +1 @@
-3.0.0.p0
+3.0.1.p0
```


There are no patches to MPIR in the branch, they are indeed packaged in the tarball.
 
Tarballs are matched by `package-version.txt`, which gives you `VERSION`
in `tarball=mpir-VERSION.tar.bz2`, and checked for authenticity using sha1 and md5.


---

Comment by roed created at 2017-11-24 23:54:52

Replying to [comment:53 dimpase]:
> Replying to [comment:52 roed]:
> > Replying to [comment:50 dimpase]:
> > > Replying to [comment:47 roed]:
> > > > I downloaded a fresh sage-8.1.rc3, downloaded the mpir tarball and put it in `upstream`, deleted `mpir-3.0.0.tar.bz2`, applied the branch on this ticket and then ran `make`.
> > > 
> > > 
> > > IMHO you might need to run `./configure` before running `make`. It could be that the install procedure got confused about the package versions...
> > 
> > I tried `./configure && make`, with no success. 
> >  
> > > The tarball worked for me on an installation of Sage, where I 
> > > dropped it to upstream/, pulled the branch, and ran `./sage -f mpir` followed by make...
> > 
> > I didn't pull anything, but I wouldn't expect that to be necessary given that you made a tarball with the changes.  I'm not sure how to proceed....
> 
> You do need to pull the branch `u/dimpase/skylakefix`. 

Oh, I misunderstood you: I thought you meant pull from the mpir repo.  I did pull the branch on this ticket, so I'm using the correct tarball.

> There are no patches to MPIR in the branch, they are indeed packaged in the tarball.
>  
> Tarballs are matched by `package-version.txt`, which gives you `VERSION`
> in `tarball=mpir-VERSION.tar.bz2`, and checked for authenticity using sha1 and md5.
> 
>


---

Comment by git created at 2017-11-25 01:02:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2017-11-25 01:09:33

I've updated the tarball and the branch, hopefully it works now...
----
New commits:


---

Comment by roed created at 2017-11-25 09:00:22

It's looking good: the build has made it to compiling the Sage library.  I'm going to run tests, but need to go to sleep now.  Assuming tests pass, positive review from me (probably in about 8 hours).


---

Comment by roed created at 2017-11-25 10:16:31

So, the build finished, but Sage doesn't start.  The error that it gives doesn't seem particularly related to mpir though....

I've put the crash report at http://www.pitt.edu/~roed/crash_report_24085.txt in case anyone wants to take a look.  I'm going to sleep now; I'll try to take a look tomorrow.


---

Comment by dimpase created at 2017-11-25 10:28:25

at the bottom of your log one sees certain looking dodgy `~/.venvburrito/` directory reference

```
/Users/roed/.venvburrito/lib/python2.7/site-packages/six.pyc in with_metaclass(meta=<type 'sage.misc.classcall_metaclass.ClasscallMetaclass'>, *bases=())
```


I would have moved it out of the way and tried to start Sage again. If you still have issues like this afterwards, I'd have moved `~/.sage/` too.


---

Comment by roed created at 2017-11-25 19:25:04

Thanks.  I had to use Homebrew to install autotools; I think that's where the `~/.venvburrito` came from. I've moved it, and now tests are running.


---

Comment by dimpase created at 2017-11-25 22:30:34

on my museum (7.y.o.) MacBookAir I get a timeout in one test:

```
sage -t --long --warn-long 1000.9 src/sage/rings/padics/padic_generic_element.pyx
...
sage: R = Zp(17,10^6) ## line 2626 ##
sage: a = 17 * R.random_element() ## line 2627 ##
sage: b = a.exp()    # should be rather fast ## line 2628 ##
------------------------------------------------------------------------
0   signals.so                          0x000000010995b2d8 print_backtrace + 40
1   ???                                 0x98c0d8bd7ba6be0e 0x0 + 11007035797628435982
------------------------------------------------------------------------

**********************************************************************
----------------------------------------------------------------------
sage -t --long --warn-long 1000.9 src/sage/rings/padics/padic_generic_element.pyx  # Timed out
Total time for all tests: 1800.1 seconds
...
```

If I try this `b=a.exp()` at the Sage prompt it keeps running seemingly forever.
Perhaps knowing concrete values (not random `a`) to test would help here...

If I use `10^5` instead of `10^6` in the definition of `R`, it still seems to return in about 10 sec.


---

Comment by andrew.mathas created at 2017-11-25 23:47:04

Thanks for this! Once I moved `mpir-3.0.1.tar.bz2` into upstream sage built without any problem (macbook pro with a skylake chip running 10.12.6). I'm currently running the tests and so far they have all passed, up to `src/sage/plot/plot3d/shapes.pyx` but it's time for me to crash...


---

Comment by andrew.mathas created at 2017-11-25 23:53:37

Oh, and for me the tests pass with `sage -t --long --warn-long 1000.9 src/sage/rings/padics/padic_generic_element.pyx` but I get the same problems with:

```
sage: R = Zp(17,10^6) ## line 2626 ##
sage: a = 17 * R.random_element() ## line 2627 ##
sage: b = a.exp()    # should be rather fast ## line 2628 ##
```



---

Comment by roed created at 2017-11-26 05:41:39

Changing status from needs_review to positive_review.


---

Comment by roed created at 2017-11-26 05:41:39

All tests pass on my machine.  Given that 8.1 is about to be released and this change makes Sage buildable on a Skylake Mac, I think it's reasonable to try to get it in and worry about any potential slowdowns on another ticket.

I'm not seeing issues with `src/sage/rings/padics/padic_generic_element.pyx`, but note that changes in mpir could affect that code.  The code that's eventually getting called is the `padicexp` function in `src/sage/rings/padics/transcendental.c`.


---

Comment by jdemeyer created at 2017-11-28 10:20:47

Changing status from positive_review to needs_info.


---

Comment by jdemeyer created at 2017-11-28 10:20:47

Could you better document where you obtained this tarball? I can't find it on http://mpir.org/downloads.html


---

Comment by jdemeyer created at 2017-11-28 10:23:28

See also [comment:23]


---

Comment by roed created at 2017-11-28 10:24:01

There's not an official release: Dima made a tarball which is available at ​http://users.ox.ac.uk/~coml0531/sage/mpir-3.0.1.tar.bz2


---

Comment by dimpase created at 2017-11-28 10:30:56

The tarball has been made from https://github.com/dimpase/mpir/commit/65bb82fdf65765e6edfbbbf8edb47c726413b8da
(now merged in https://github.com/wbhart/mpir/pull/234)
by following (already outdated, as Billa says) https://github.com/wbhart/mpir/commit/1b3d5976292c6308c3f121c5ea2c406da0324bc8
and running `make dist`.

Bill is planning a new release, I gather.


---

Comment by jdemeyer created at 2017-11-28 10:38:49

Replying to [comment:69 dimpase]:
> The tarball has been made from https://github.com/dimpase/mpir/commit/65bb82fdf65765e6edfbbbf8edb47c726413b8da
> (now merged in https://github.com/wbhart/mpir/pull/234)
> by following (already outdated, as Billa says) https://github.com/wbhart/mpir/commit/1b3d5976292c6308c3f121c5ea2c406da0324bc8
> and running `make dist`.

1. What does "made from X by following Y mean"?

2. Can you please document this in `SPKG.txt` or somewhere where people will find it?


---

Comment by jdemeyer created at 2017-11-28 10:41:03

3. Do not call it `mpir-3.0.1`. Call it `mpir-3.0.0-dima` or `mpir-3.0.0-1b3d5976292c6308c3f121c5ea2c406da0324bc8` or whatever.


---

Comment by jdemeyer created at 2017-11-28 10:43:37

Replying to [comment:68 roed]:
> There's not an official release: Dima made a tarball which is available at ​http://users.ox.ac.uk/~coml0531/sage/mpir-3.0.1.tar.bz2

Fine for me, but how you expect people to know this?

I don't mind custom tarballs, as long as it is absolutely clear what is going on.


---

Comment by dimpase created at 2017-11-28 10:44:59

MPIR used to have a convoluted way to make releases, involving modifying  version numbers some files, running autoconf, editing generated configure, running configure, and then running `make dist` to make a tarball. And the said tarball needs to be pruned for heaps of MSVC-specific config files, that take 10 times more space than the code...

Riding trains Oxford-London-Paris, might be unable to do much before evening.


---

Comment by jdemeyer created at 2017-11-28 10:53:52

Replying to [comment:73 dimpase]:
> MPIR used to have a convoluted way to make releases, involving modifying  version numbers some files, running autoconf, editing generated configure, running configure, and then running `make dist` to make a tarball. And the said tarball needs to be pruned for heaps of MSVC-specific config files, that take 10 times more space than the code...

Then are you sure that simply adding a patch isn't simpler?


---

Comment by dimpase created at 2017-11-28 11:03:38

Replying to [comment:74 jdemeyer]:
> Replying to [comment:73 dimpase]:
> > MPIR used to have a convoluted way to make releases, involving modifying  version numbers some files, running autoconf, editing generated configure, running configure, and then running `make dist` to make a tarball. And the said tarball needs to be pruned for heaps of MSVC-specific config files, that take 10 times more space than the code...
> 
> Then are you sure that simply adding a patch isn't simpler?

because my patches are not against mpir 3.0.0, they are against last week's master.
And there is a hundred of commits in between, and also 3.0.0 is a different branch, in fact.
I tried created a patch against 3.0.0, but it would have been magabytes in size and a lot of time to create.


---

Comment by dimpase created at 2017-11-28 11:05:41

anyhow, I can rename the tarball and the corr. different version in the package-version,
but don't ask me to do tarball creation from scratch again.


---

Comment by jdemeyer created at 2017-11-28 11:45:22

Replying to [comment:76 dimpase]:
> anyhow, I can rename the tarball and the corr. different version in the package-version,
> but don't ask me to do tarball creation from scratch again.

I am asking you to _document_ what you did, not to do it again.


---

Comment by git created at 2017-11-28 12:53:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2017-11-28 12:54:21

I've renamed the tarball.
----
New commits:


---

Comment by dimpase created at 2017-11-28 12:54:21

Changing status from needs_info to needs_review.


---

Comment by jdemeyer created at 2017-11-28 13:16:45

> 3.0.1prerelease is built from https://github.com/wbhart/mpir/pull/234

Can you instead refer to an exact commit on the git repo?

> following the (outdated) procedure outlined in https://github.com/wbhart/mpir/commit/1b3d5976292c6308c3f121c5ea2c406da0324bc8

That's also not clear. How does this commit outline a procedure?


---

Comment by jdemeyer created at 2017-11-28 13:17:46

Changing status from needs_review to needs_work.


---

Comment by dimpase created at 2017-11-28 13:25:22

Perhaps you have not had a look at the commit I mention? There are files to edit, scripts to run, and it is outdated. I am not going to spend time describing details- I am sure anyone with an idea on how mpir tarballs are made will manage to reproduce this.


---

Comment by dimpase created at 2017-11-28 13:26:12

Changing status from needs_work to needs_review.


---

Comment by vbraun created at 2017-11-29 00:09:32

Release or not release, that is the question ;-)

I'm hesitant to ship some half-baked tarball. On the plus side, it does pass on the buildbot....


---

Comment by dimpase created at 2017-11-29 00:32:55

I have followed the master tarball baker's instructions, as close as  I could, short of writing my own cookbook, that is.
If you really insist I could write a hacky spkg-src, although I would rather not at this  point.


---

Comment by roed created at 2017-11-29 00:35:39

Replying to [comment:84 vbraun]:
> Release or not release, that is the question ;-)
> 
> I'm hesitant to ship some half-baked tarball. On the plus side, it does pass on the buildbot....

I understand the hesitancy, especially since this change includes a bunch of additional changes to mpir between 3.0.0 and master.  But Skylake + OS X seems like a fairly common combination: it would be good to be able to build Sage again on my machine.


---

Comment by jdemeyer created at 2017-11-29 08:04:31

Replying to [comment:82 dimpase]:
> I am sure anyone with an idea on how mpir tarballs are made will manage to reproduce this.

That's essentially a tautology. This docs are not for the people "with an idea on how mpir tarballs are made". They are for the people without such an idea.


---

Comment by jdemeyer created at 2017-11-29 14:38:23

Replying to [comment:82 dimpase]:
> Perhaps you have not had a look at the commit I mention? There are files to edit

You mean the files edited on that commit? Most of that seems to be related to changing the version number. That shouldn't be needed here. 

> scripts to run

You mean `autogen.sh`? But Bill says (in a comment on that commit) that this might not work...

> and it is outdated.

In that case, it can serve even less as documentation.


---

Comment by jdemeyer created at 2017-11-29 14:40:57

Replying to [comment:75 dimpase]:
> I tried created a patch against 3.0.0, but it would have been magabytes in size and a lot of time to create.

Why would running `git diff commit1 commit2` take a lot of time?

And why would it be so large? Are there any auto-generated files in the git repo?


---

Comment by dimpase created at 2017-11-29 14:48:24

Replying to [comment:89 jdemeyer]:
> Replying to [comment:75 dimpase]:
> > I tried created a patch against 3.0.0, but it would have been magabytes in size and a lot of time to create.
> 
> Why would running `git diff commit1 commit2` take a lot of time?

because many patches created this way do not apply to the 3.0.0 branch.
And there was about 80 patches to look at.
I have better things to do than manually deal with 80 non-applying patches.


---

Comment by dimpase created at 2017-11-29 14:51:19

And they are big, big, as may of them involve big changes to assembler code, or just new assembler code, not in 3.0.0.

Even my changes to the assembler code run into many thousands of lines
(they are almost all about renaming jumplabels, though).


---

Comment by jdemeyer created at 2017-11-29 14:56:35

Replying to [comment:90 dimpase]:
> because many patches created this way do not apply to the 3.0.0 branch.

If you diff against the 3.0.0 branch, they will surely apply.


---

Comment by dimpase created at 2017-11-29 14:56:50

Replying to [comment:88 jdemeyer]:
> Replying to [comment:82 dimpase]:
> > Perhaps you have not had a look at the commit I mention? There are files to edit
> 
> You mean the files edited on that commit? Most of that seems to be related to changing the version number. That shouldn't be needed here. 

I don't understand. We need to bump up version numbers of the package, and of the libraries built.
 
> 
> > scripts to run
> 
> You mean `autogen.sh`? But Bill says (in a comment on that commit) that this might not work...


Oh Holy Jesus, I have done a job. It is a unique one-off job, why do you want a full
documentation of the process? Nobody won't need to redo it, ever.
A new way of making MPIR releases is underway.

> 
> > and it is outdated.
> 
> In that case, it can serve even less as documentation.
You do not need this documentation, noone needs it. See above.


---

Comment by dimpase created at 2017-11-29 14:58:23

Replying to [comment:92 jdemeyer]:
> Replying to [comment:90 dimpase]:
> > because many patches created this way do not apply to the 3.0.0 branch.
> 
> If you diff against the 3.0.0 branch, they will surely apply.

Whatever. You will not want to review these megabytes.

What is the problem? I do solemnly swear that I do not work for any 3-letter orgs, and I have not sneaked in anything dodgy.


---

Comment by jdemeyer created at 2017-11-29 15:04:43

Replying to [comment:94 dimpase]:
> What is the problem?

I see at least these issues:

(A) you could have done some wrong in creating the tarball, subtly breaking it somehow. Usually, when I review a ticket creating a custom tarball, then checking the tarball distribution process is part of the review because things can go wrong there.

(B) distros will not be happy to package this unofficial version of MPIR (see [ODK D3.10](https://github.com/OpenDreamKit/OpenDreamKit/issues/59)). If the changes only involve Skylake support, then there is no issue here. However, you seem to imply that there are a lot of other unrelated changes too.


---

Comment by fbissey created at 2017-11-29 17:40:45

Distros use gmp not mpir in the general case. Otherwise I may have complained too. Sometimes it is hard to isolate the changes you want, so long as nothing else but skylake om OS X is affected (in that they now build) then this is neutral.

If it changes doctests and behavior, then sure it is not neutral and things become very hard. But it is not the case here I believe.


---

Comment by dimpase created at 2017-11-29 22:45:22

The diff between the MPIR 3.0.0 and the current master is about 700K in size, or which about 50% is various Windows-only stuff and can be ignored, but the rest is still many times bigger than any other Sage patch (and commit by commit it is much bigger, still).
Further untangling this to make patch smaller is not something we should spend time on, I think.

This makes (B) pretty much unfixable. As to (A), well, as Volker says, buildbots are happy with the tarball.
I attach the git diff between the MPIR master and the tarball (this is naturally only the git-tracked files that show in that very small patch; one naturally can get the rest by running ./autogen)


---

Comment by dimpase created at 2017-11-29 22:46:37

the tarball vs the MPIR master


---

Attachment

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2017-11-30 08:41:31

Replying to [comment:93 dimpase]:
> > You mean `autogen.sh`? But Bill says (in a comment on that commit) that this might not work...
> 
> 
> Oh Holy Jesus, I have done a job. It is a unique one-off job, why do you want a full
> documentation of the process?

Why so offensive? You say that you did X and Bill isn't sure whether X will work. Given that the official maintainer of MPIR questions your procedure, I feel that I am right to ask this question.


---

Comment by jdemeyer created at 2017-11-30 08:42:11

Anyway, let me try to recreate the tarball (without the patch, we don't need that).


---

Comment by jdemeyer created at 2017-11-30 09:14:24

Changing status from needs_review to needs_work.


---

Comment by dimpase created at 2017-11-30 09:19:58

Replying to [comment:100 jdemeyer]:
> Anyway, let me try to recreate the tarball (without the patch, we don't need that).

Why? Surely distributions need libraries' versions to be bumped up.


---

Comment by jdemeyer created at 2017-11-30 09:49:12

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2017-11-30 09:49:12

New commits:


---

Comment by jdemeyer created at 2017-11-30 09:50:34

Replying to [comment:98 git]:
> Branch pushed to git repo; I updated commit sha1. New commits:
> ||[9764442](https://git.sagemath.org/sage.git/commit/?id=9764442aa3bddc303a32ccc808c80c96a3130bc4)||`simplified detailed instruction to produce tarball`||

That wasn't so hard. I put those instructions in a `spkg-src` script and created a new tarball using that script.

Please review.


---

Comment by jdemeyer created at 2017-11-30 09:52:30

Replying to [comment:102 dimpase]:
> Why? Surely distributions need libraries' versions to be bumped up.

This is answered adequately in [comment:96]


---

Comment by dimpase created at 2017-11-30 09:54:43

Please also remove `mpir.net/` from the tarball.


---

Comment by dimpase created at 2017-11-30 09:57:02

Replying to [comment:106 jdemeyer]:
> Replying to [comment:102 dimpase]:
> > Why? Surely distributions need libraries' versions to be bumped up.
> 
> This is answered adequately in [comment:96]

not really - we are shipping 350K of diffs to MPIR 3.0.0, not a little skylake/OSX-only fix.


---

Comment by jdemeyer created at 2017-11-30 10:03:39

Replying to [comment:107 dimpase]:
> Please also remove `mpir.net/` from the tarball.

That wasn't in your instructions :-)


---

Comment by jdemeyer created at 2017-11-30 10:06:29

Replying to [comment:107 dimpase]:
> Please also remove `mpir.net/` from the tarball.

I don't know what you mean... there is no such file/directory in the tarball.


---

Comment by dimpase created at 2017-11-30 10:33:00

Replying to [comment:110 jdemeyer]:
> Replying to [comment:107 dimpase]:
> > Please also remove `mpir.net/` from the tarball.
> 
> I don't know what you mean... there is no such file/directory in the tarball.
OK, sorry - I actually did it the other way around:
removed directories and edited the dist target of the makefile
and ran make dist only then. I didn't notice they don't package mpir.net.


---

Comment by jdemeyer created at 2017-11-30 10:40:23

Well, I tried to follow your instructions as literally as possible (apart from changing the version number)...


---

Comment by dimpase created at 2017-11-30 10:42:01

Replying to [comment:112 jdemeyer]:
> Well, I tried to follow your instructions as literally as possible (apart from changing the version number)...
I can only say https://github.com/wbhart/mpir/issues/237


---

Comment by jdemeyer created at 2017-11-30 10:42:59

Replying to [comment:102 dimpase]:
> Why? Surely distributions need libraries' versions to be bumped up.

Distributions are not going to ship this tarball anyway. So it is simply not relevant.


---

Comment by dimpase created at 2017-11-30 11:18:40

Replying to [comment:114 jdemeyer]:
> Replying to [comment:102 dimpase]:
> > Why? Surely distributions need libraries' versions to be bumped up.
> 
> Distributions are not going to ship this tarball anyway. So it is simply not relevant.

I think it is relevant, as it's simply misleading not to bump up versions in this case.


---

Comment by jdemeyer created at 2017-11-30 11:33:56

Replying to [comment:115 dimpase]:
> I think it is relevant, as it's simply misleading not to bump up versions in this case.

We typically do not change `.so` version numbers if we patch. And the difference between adding a patch or using a new tarball is purely technical. So if we don't change versions for patches, we shouldn't change the version number for this either.


---

Comment by dimpase created at 2017-11-30 11:55:22

this is not a typical case. we basically do a prerelease of 3.0.1 here. the difference is too big to be a patch.


---

Comment by wbhart created at 2017-11-30 19:02:10

I think I should have been clearer about two things: Firstly, I (Bill) am not performing all the functions of an official maintainer any more. I am merely accepting pull requests on [GitHub](GitHub), uploading tarballs to the website and answering questions as the community takes over the project. Secondly, I did not promise to "do" a new release. I said that I think a new release is the best way forward and that I am happy to advise on how to accomplish that.

More specifically, I think a patch release to fix some of the issues with the previous release is in order here. This includes all updates to the Windows build files that Brian Gladman has made, the inclusion of mpir.net, which was accidentally left out of the last tarball. And there have also been some additional patches merged to fix various reported issues, which I accepted since the last release.

The new release should be called 3.0.1. There is no reason to go through an alpha/beta cycle for a patch release, so long as everything is passing on Travis/Appveyor and the bugs that are meant to be fixed are confirmed to be fixed (which appears to be the case).

The steps remaining for a release are: checking that all FSF copyright notices were updated correctly by Dima (i.e. review), update the Changelog, NEWS, Authors, change the version and .so numbers, make the tarballs, test them on at least one Linux machine and ask Brian to test them on a Windows box, and at least make a brief announcement on mpir-devel about the release and what it is for. I will put the tarballs up on the website, update the website and accept any PR's needed.

We cannot do a full (minor) release, since Flint is broken on Windows due to changes that were made to the interface in the last release, and this needs fixing. Also, Jens Nurmann and David Cleaver were working on Broadwell support. I think I have some patches from them that would need to go into a minor release to support Broadwell, but this includes a nontrivial amount of work, since the patches would need to be tested and profiled to check they are faster than what was there (Jens did not have access to a Broadwell machine). Also, there is a slowdown reported by someone that Jens Nurmann tried to fix, but the original person who reported it produced a better fix. I don't know the status of this, since I have not heard anything about it since. But those are the current blockers for a new minor release of MPIR, which is why I would advocate doing a patch release for Sage (update to 3.0.1) instead of a minor release (update to 3.1.0).


---

Comment by dimpase created at 2017-11-30 19:42:14

OK, I am actually OK with Jeroen's version, as he's certainly more stubborn than me.
We probably should arrange for another way to resolve this between us, like riding an wielertoerist version of Ronde van Vlaanderen and see who wins ;-)
  
The only complaint is that the tarball name is way too long, the longest in upstream/. For all practical purposes it would be fine to shorten the commit string in PACKAGEVERSION to the first 7 characters.


---

Comment by jdemeyer created at 2017-11-30 20:21:13

Replying to [comment:117 dimpase]:
> this is not a typical case. we basically do a prerelease of 3.0.1 here.

I don't think that we are in a position to call something a prerelease of 3.0.1. Who knows how that version will look like or whether there will even be such a version.


---

Comment by vbraun created at 2017-11-30 22:34:19

So are we good?

If Bill wants to release a 3.0.1 in the future then we shouldn't produce a 3.0.1 ourselves, this one should be obvious.


---

Comment by dimpase created at 2017-11-30 23:34:12

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2017-11-30 23:34:12

OK, let it have the longest tarball name in Sage history :-)


---

Comment by dimpase created at 2017-12-02 14:15:40

Volker, is this merged?


---

Comment by vbraun created at 2017-12-02 14:53:23

Resolution: fixed


---

Comment by vbraun created at 2017-12-02 14:55:04

yes, its all good
