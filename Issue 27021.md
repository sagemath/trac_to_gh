# Issue 27021: spkg-configure.m4 for mpfr

Issue created by migration from https://trac.sagemath.org/ticket/27258

Original creator: dimpase

Original creation time: 2019-02-12 09:55:35

CC:  embray fbissey

something like this:

```
SAGE_SPKG_CONFIGURE([mpfr], [
    AC_CHECK_HEADER(mpfr.h, [], [sage_spkg_install_mpfr=yes])
dnl mpfr_free_pool appeared in r11922 (Dec 2017) on MPFR svn 
    AC_SEARCH_LIBS([mpfr_free_pool], [mpfr], [break], [sage_spkg_install_mpfr=yes])
])
```



---

Comment by dimpase created at 2019-02-12 09:55:57

Changing keywords from "" to "spkg-configure".


---

Comment by mmezzarobba created at 2019-02-12 14:23:09

Two stupid questions (I don't think I'm good enough with autoconf to review this ticket, but I'd like to understand the mechanism):
* Is there a particular reason for using `AC_SEARCH_LIBS` rather that `AC_CHECK_LIB` here?
* What is the `break` instruction for? Will the generated code be part of a loop that tries several options or something like that? I couldn't locate the corresponding logic.


---

Comment by dimpase created at 2019-02-12 14:33:34

from autoconf docs:

```
AC_CHECK_LIB requires some care in usage, and should be avoided in some common cases. Many standard functions like gethostbyname appear in the standard C library on some hosts, and in special libraries like nsl on other hosts. On some hosts the special libraries contain variant implementations that you may not want to use. These days it is normally better to use AC_SEARCH_LIBS([gethostbyname], [nsl]) instead of AC_CHECK_LIB([nsl], [gethostbyname]).
```

I guess Erik can comment better than me about the use of `break`.


---

Comment by mmezzarobba created at 2019-02-12 14:35:07

Replying to [comment:3 dimpase]:
> from autoconf docs:
> {{{
> AC_CHECK_LIB requires some care in usage, and should be avoided in some common cases. Many standard functions like gethostbyname appear in the standard C library on some hosts, and in special libraries like nsl on other hosts. On some hosts the special libraries contain variant implementations that you may not want to use. These days it is normally better to use AC_SEARCH_LIBS([gethostbyname], [nsl]) instead of AC_CHECK_LIB([nsl], [gethostbyname]).
> }}}

Thanks. But I think this is purely about the case where the same function can be found in several different libraries.


---

Comment by dimpase created at 2019-02-25 23:38:24

mpfrcx's spkg-install hardcodes the location of mpfr to SAGE_LOCAL. So this will need to be fixed.


---

Comment by dimpase created at 2019-02-26 13:06:36

New commits:


---

Comment by dimpase created at 2019-02-26 13:06:36

Changing status from new to needs_review.


---

Comment by dimpase created at 2019-02-26 13:07:29

only the last commit is new, the rest are from #27212.


---

Comment by embray created at 2019-02-26 13:22:58

Are you sure in all these cases that it's safe to pass `--with-mpfr="$SAGE_MPFR_PREFIX"` when `$SAGE_MPFR_PREFIX` is empty?

I found that a number of packages do not have sensible defaults for `--with-gmp=` passed an empty value, which is why I had to define


```sh
if [ -n "$SAGE_GMP_PREFIX" ]; then
    export SAGE_CONFIGURE_GMP="--with-gmp=$SAGE_GMP_PREFIX"
fi
```


And then pass various configure scripts `$SAGE_CONFIGURE_GMP` instead of `--with-gmp=$SAGE_GMP_PREFIX`.

Not saying that's always necessary though; might depend on the package and how it handles an empty value for the flag :(


---

Comment by embray created at 2019-02-26 13:31:42

On Ubuntu 16.04 I tried `./bootstrap && ./configure`.  On first attempt `mpfr.h` was not detected.  Ok, `apt-get install libmpfr-dev` and tried `./configure` again and it found the headers but failed to find `mpfr_free_pool`.  Apparently the system package (despite the package being named "libmpfr4") is version 3.1.4 of MPFR, so maybe it doesn't have `mpfr_free_pool`?

Why was `mpfr_free_pool` chosen?  Do we have a specific dependency on it?  Or is it possible in principle to use version 3.1.x?  If not then that's fine; if the system package is too old it's too old, so we don't use it.  I'm just curious.


---

Comment by embray created at 2019-02-26 13:32:49

In Ubuntu 18.04 (bionic) it now has "libmpfr6" which is v4.0.1 so I might try testing against that next.


---

Comment by embray created at 2019-02-26 14:42:27

Got all the way through building sagelib with MPFR 3.1.4, but then at runtime I get

```
ImportError: /home/sage/sage/local/lib/python2.7/site-packages/sage/rings/real_mpfr.so: undefined symbol: mpfr_rootn_ui
```


where `mpfr_rootn_ui` is a function introduced in 4.0.0, as is `mpfr_free_pool`.  ISTM that specific requirement could be worked around, but I'm happy to just say "ok 4.0.0 is the minimum required MPFR" for now.

I'll make an Ubuntu 18.04 container and try it in there.


---

Comment by dimpase created at 2019-02-26 14:58:39

Are you saying that the test for `mpfr_free_pool` actually succeeds on MPFR 3.1.4?
OK, let's switch to testing for `mpfr_rootn_ui` then.


---

Comment by embray created at 2019-02-26 15:01:25

Oops, no, I just changed it to `mpfr_init` for the sake of testing against 3.1.4.  mpfr_free_pool is fine (though mpfr_rootn_ui has the advantage of explicitly being used by sage).


---

Comment by embray created at 2019-02-26 16:54:59

Completed a successful build from scratch and `make ptestlong` on Ubuntu 18.04 using the system mpfr.  So maybe this is OK as-is.


---

Comment by dimpase created at 2019-02-26 17:12:52

I've also tested this on Gentoo, on Debian.


---

Comment by dimpase created at 2019-02-26 17:37:58

Oops, this does break (optional) mpfrcx, one of 4 packages that depend on mpfr.
So indeed most likely it needs akin to `$SAGE_CONFIGURE_GMP`.


---

Comment by dimpase created at 2019-02-26 17:37:58

Changing status from needs_review to needs_work.


---

Comment by dimpase created at 2019-02-26 17:57:54

and I forgot about the need to SAGE_MPRF_* things in sage-env-config.in. This means that the tests ran with these being empty - mostly OK for system libs, but should be deadly for the case where things should come from SAGE_LOCAL...


---

Comment by git created at 2019-02-26 18:43:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-02-27 22:02:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-03-20 14:42:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2019-03-20 14:43:59

Changing status from needs_work to needs_review.


---

Comment by dimpase created at 2019-03-20 14:43:59

merged with the latest #27212 and Sage 8.7.rc0


---

Comment by embray created at 2019-03-25 10:56:15

Ticket retargeted after milestone closed (if you don't believe this ticket is appropriate for the Sage 8.8 release please retarget manually)


---

Comment by git created at 2019-04-04 21:04:41

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by git created at 2019-04-19 10:01:48

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Attachment

updated configure spkg


---

Comment by embray created at 2019-05-03 15:45:10

I don't understand why the addition of the `--with-mpfr` flag.  This should already be covered by #27567.


---

Comment by embray created at 2019-05-03 15:51:27

It seems like this would also be able to benefit from #27641.  In this case you would want to add the bits that set


```
AC_SUBST(SAGE_MPFR_INCLUDE, ...)
AC_SUBST(SAGE_MPFR_PREFIX, ...)
```


in the "POST" argument, since it's something that should _always_ be done (the values of those variables would of course still depend on checks performed earlier in the macro).

This would be similar then to the POST argument added for MPIR in #27641.

That's a strong part of what it's for: If we have some `AC_SUBST` variables that will be fed into another template file, such as `sage-env-config.in`, we want to ensure that those substitutions are _always_ made by mpfr/spkg-configure.m4 regardless what else was determined w.r.t. MPFR.


---

Comment by git created at 2019-05-08 15:15:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2019-05-08 15:22:18

Replying to [comment:28 embray]:
> It seems like this would also be able to benefit from #27641.  In this case you would want to add the bits that set
> 
> {{{
> AC_SUBST(SAGE_MPFR_INCLUDE, ...)
> AC_SUBST(SAGE_MPFR_PREFIX, ...)
> }}}
> 
> in the "POST" argument, since it's something that should _always_ be done (the values of those variables would of course still depend on checks performed earlier in the macro).
> 
> This would be similar then to the POST argument added for MPIR in #27641.
> 
> That's a strong part of what it's for: If we have some `AC_SUBST` variables that will be fed into another template file, such as `sage-env-config.in`, we want to ensure that those substitutions are _always_ made by mpfr/spkg-configure.m4 regardless what else was determined w.r.t. MPFR.

I don't quite understand this. At present AC_SUBSTs are done if `$with_mpfr` is either `system` or `install`. Can it have any other values? If not, the code is already covered everything. If yes, then it's totally unclear how and where to get meaningful values to use in AC_SUBSTs.

A nice syntactic sugar might be to be able to put the `system` case in one `[...]` block, and `[...]` in another (instead of writing an explicit `case` statement).


---

Comment by embray created at 2019-05-09 15:18:53

Again, I would just compare with mpir.  In the argument 5 ("POST") it checks `$sage_spkg_install_mpir` (as well as `$sage_spkg_install_gmp`) and sets the values that go in sage-env-config accordingly.

I'll take a try at it.


---

Comment by dimpase created at 2019-05-09 15:27:30

Please remove the configure bump from this branch, while you're at it.


---

Comment by embray created at 2019-05-09 15:39:50

This worked for me at least insofar as detecting my system mpfr properly.  Now let's see if it builds...
----
New commits:


---

Comment by embray created at 2019-05-09 15:42:41

Fixed [this](https://git.sagemath.org/sage.git/commit?id=15ba794c6397871ff308fdd5eb213087fb45f36c) by the way.  I wonder if this was causing you any grief...


---

Comment by git created at 2019-05-09 15:46:26

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2019-05-09 16:03:23

Replying to [comment:34 embray]:
> Fixed [this](https://git.sagemath.org/sage.git/commit?id=15ba794c6397871ff308fdd5eb213087fb45f36c) by the way.  I wonder if this was causing you any grief...

I didn't see any fallout from it, and I recall fixing some copy/paste oopsies like this one in `sage-env-config.in`, perhaps it's a result of too many rebases that this one stayed :-)


---

Comment by embray created at 2019-05-09 16:34:44

Build (from scratch) succeeded with no problem with system gmp+mpfr on Ubuntu 18.04, at least.  I'll run the tests next just to be sure.


---

Comment by dimpase created at 2019-05-09 21:42:51

it seems to conflict with #27642 (in your `m4/sage_spkg_configure.m4`)- can you rebase it? Otherwise, all good.


---

Comment by dimpase created at 2019-05-10 10:20:52

namely, here you only add `$4` and `$5` to `SAGE_SPKG_CONFIGURE` macro, whereas on #27642 you not only add them, but also do


```diff
+
+AS_VAR_SET([sage_spkg_name], SPKG_NAME)
+
+$4
+
+AS_IF([test -n "`ls "${SAGE_SPKG_INST}/${sage_spkg_name}"-* 2>/dev/null`"],
+SPKG_INSTALL_VAR[=yes;] SPKG_USE_SYSTEM[=no], [
 m4_ifval(
 [$2],
 [AS_VAR_SET_IF(SPKG_INSTALL_VAR, [], SPKG_INSTALL_VAR[=no])],
 [AS_VAR_SET_IF(SPKG_INSTALL_VAR, [], SPKG_INSTALL_VAR[=yes])])
+])
+
```

I presume the latter should take the precedence. I'll rebase accordingly.


---

Comment by git created at 2019-05-10 10:24:26

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2019-05-10 11:01:30

Changing status from needs_review to needs_work.


---

Comment by embray created at 2019-05-10 11:01:30

I don't know why you pushed that last commit.   I need to rebase #27642, and in turn rebase this on top of that.  Please don't add spurious new commits that duplicate changes from other tickets as it will only make a mess of things later (e.g. become superfluous empty commits).


---

Comment by git created at 2019-05-10 11:10:11

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by dimpase created at 2019-05-10 11:10:35

oops, sorry, I didn't realise that #27642 has an old base :-(


---

Comment by embray created at 2019-05-10 11:11:39

I deleted your last commit; it doesn't really belong on this branch, and it's not strictly related by any means.

That change is specifically related to #27642 and does not conflict with anything here.


---

Comment by embray created at 2019-05-10 11:12:39

Replying to [comment:32 dimpase]:
> Please remove the configure bump from this branch, while you're at it.

To be clear, is this because we plan to consolidate this ticket with others?


---

Comment by dimpase created at 2019-05-10 11:19:55

Replying to [comment:46 embray]:
> Replying to [comment:32 dimpase]:
> > Please remove the configure bump from this branch, while you're at it.
> 
> To be clear, is this because we plan to consolidate this ticket with others?
yes, indeed, otherwise it's too hard to get into the release.
It's fine as long as it's just new `spkg-configure.m4` files, but if it's more then
the hell breaks loose.

Perhaps `./bootstrap` should have a remote service to run autoconf ;-)


---

Comment by embray created at 2019-05-10 11:21:06

Ok, I'll tidy this up a bit more and then see if I can incorporate mpc as well.


---

Comment by git created at 2019-05-10 11:25:40

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by embray created at 2019-05-10 11:28:18

Okay, I removed the confball update and squashed a bunch of intermediate commits away.  I think this is pretty clean now.  Now let's take a look at mpc...

mpfr and mpc should probably be bundled together--do you think anything else should go with them? ntl maybe?


---

Comment by embray created at 2019-05-10 11:28:18

Changing status from needs_work to needs_review.


---

Comment by dimpase created at 2019-05-10 11:29:47

perhaps not only mpc, but also ntl, arb, and flint. They all call each other and modify 
`src/bin/sage-env-config.in`...


---

Comment by dimpase created at 2019-05-10 11:34:28

I didn't mean to undo your change of dependency without asking, but I don't understand, aren't you using the branch of #27642 here?


---

Comment by git created at 2019-05-10 11:37:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2019-05-10 11:52:26

No, I decided not to--they're not strictly related at all.

I think #27642 will merge cleanly with these other tickets, and still needs more work anyways.


---

Comment by dimpase created at 2019-05-10 11:57:09

Replying to [comment:53 git]:
> Branch pushed to git repo; I updated commit sha1. New commits:
> ||[1948e33](https://git.sagemath.org/sage.git/commit/?id=1948e335c3b5c447c674c8ec27c49f6472556ecf)||`Add one missing SAGE_CONFIGURE_MPFR, for building gcc`||

and once `mpc` is added to the picture, one would also need to fix `--with-mpc="$SAGE_LOCAL"` - that's really why it's best to do them all together...


---

Comment by embray created at 2019-05-10 12:07:26

Yeah, I'm adding that in the branch for mpc now.  I agree it makes sense to bundle them together.


---

Comment by embray created at 2019-05-10 14:42:05

(BTW I'm trying to organize all these spkg-configure tickets under the "build: configure" component)


---

Comment by embray created at 2019-05-10 14:42:05

Changing component from build to build: configure.


---

Comment by embray created at 2019-05-10 14:42:05

Changing keywords from "spkg-configure" to "spkg-configure mpfr".


---

Comment by dimpase created at 2019-05-11 10:02:08

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2019-05-11 10:02:08

all clear


---

Comment by vbraun created at 2019-05-11 14:53:25

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2019-05-11 14:53:25

Merge conflict, please fix


---

Comment by dimpase created at 2019-05-11 22:06:57

Volker, we have `u/dimpase/build/mpfr-mpc-ntl`, which is the merged mpfr+mpc - the branch of #27259, also includes this one (#27258), and ntl from #27265.
They are modifying many common files, and should be merged together.
How do we go about it? We can add a configure bump to `u/dimpase/build/mpfr-mpc-ntl`,
after rebasing it appropriately, so that #27258, #27259, and #27265 are all
merged together in one go.

We can open a special ticket for it if you prefer, or deal with it here.


---

Comment by git created at 2019-05-13 14:42:43

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by embray created at 2019-05-13 14:43:24

Rebased.  Not sure why it had a merge conflict, as there were no conflicts found during rebasing.


---

Comment by embray created at 2019-05-13 14:43:24

Changing status from needs_work to positive_review.


---

Comment by embray created at 2019-05-13 15:30:56

This ticket should probably not be merged by itself.  Instead please merge #27822 which incorporates this one.


---

Comment by vbraun created at 2019-05-17 11:45:51

Resolution: fixed


---

Comment by vbraun created at 2019-05-20 18:26:16

Changing status from closed to new.


---

Comment by vbraun created at 2019-05-20 18:26:16

Resolution changed from fixed to 


---

Comment by dimpase created at 2019-05-20 18:36:25

The comment:63 did say this should not be merged on its own, didn't?


---

Comment by dimpase created at 2019-05-20 23:32:17

Changing status from new to needs_review.


---

Comment by dimpase created at 2019-05-20 23:32:31

Changing status from needs_review to positive_review.


---

Comment by chapoton created at 2019-06-28 10:05:34

Resolution: duplicate
