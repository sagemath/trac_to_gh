# Issue 20537: Basic singularity analysis for algebraic curves

archive/issues_020537.json:
```json
{
    "body": "CC:  @bhutz @miguelmarco\n\nKeywords: gsoc2016\n\nCompute the set of singular points of a generic algebraic curve.\n\nFor plane curves, implement functionality to compute the multiplicity of a singular point, determine whether a singular point is ordinary or not, and compute the tangents of the curve at a point.\n\nIssue created by migration from https://trac.sagemath.org/ticket/20774\n\n",
    "created_at": "2016-06-03T18:23:25Z",
    "labels": [
        "component: algebraic geometry",
        "minor"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.3",
    "title": "Basic singularity analysis for algebraic curves",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/20537",
    "user": "https://trac.sagemath.org/admin/accounts/users/gjorgenson"
}
```
CC:  @bhutz @miguelmarco

Keywords: gsoc2016

Compute the set of singular points of a generic algebraic curve.

For plane curves, implement functionality to compute the multiplicity of a singular point, determine whether a singular point is ordinary or not, and compute the tangents of the curve at a point.

Issue created by migration from https://trac.sagemath.org/ticket/20774





---

archive/issue_comments_283312.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. Last 10 new commits:",
    "created_at": "2016-06-10T01:54:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20537#issuecomment-283312",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:



---

archive/issue_comments_283313.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-06-10T04:26:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20537#issuecomment-283313",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_283314.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2016-06-10T04:31:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20537#issuecomment-283314",
    "user": "https://trac.sagemath.org/admin/accounts/users/gjorgenson"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_283315.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2016-06-10T12:48:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20537#issuecomment-283315",
    "user": "https://github.com/bhutz"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_283316.json:
```json
{
    "body": "some comments in no particular order\n\n- the values I've checked agree with Magma.\n\n- I would rather see a while loop than a for/break since you are using the loop variable later when you are getting an appropriate affine patch\n\n- examples are all QQ or number field. I'd like to see some other fields (assuming they work)\n\n- in multiplicity: why don't you change ring first to get the ordering, and then use R.ideal to create the ideal. That way you only have to change_ring once instead of twice.\n\n- OUTPUT: an integer.   You don't have to make a list when it is a simple output\n\n- multiplicity = 0: do you really want to allow this? I think returning an error that the point is not on the curve may be more intuitive. If you change it: in tangents: if r < 1 isn't needed. Either way, this should be described in the doc\n\n- in is_ordinary: OUTPUT: Boolean. You should document that an error is returned for a non-singular point\n\n- in singular_points: I think putting F=F is better than adding the 0 as the first parameter.\n\n- do you want to add C.singular_subscheme()?\n\n- I see many places you are restricting to fields. Should there be a field subclass?\n\n- Things like Q.is_ordinary_singularity(), Q.tangents(), Q.multiplicity() don't work when Q is the curve point.\n\n- Q.is_singular() and C.is_singular(Q) would be nice to have.",
    "created_at": "2016-06-10T12:48:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20537#issuecomment-283316",
    "user": "https://github.com/bhutz"
}
```

some comments in no particular order

- the values I've checked agree with Magma.

- I would rather see a while loop than a for/break since you are using the loop variable later when you are getting an appropriate affine patch

- examples are all QQ or number field. I'd like to see some other fields (assuming they work)

- in multiplicity: why don't you change ring first to get the ordering, and then use R.ideal to create the ideal. That way you only have to change_ring once instead of twice.

- OUTPUT: an integer.   You don't have to make a list when it is a simple output

- multiplicity = 0: do you really want to allow this? I think returning an error that the point is not on the curve may be more intuitive. If you change it: in tangents: if r < 1 isn't needed. Either way, this should be described in the doc

- in is_ordinary: OUTPUT: Boolean. You should document that an error is returned for a non-singular point

- in singular_points: I think putting F=F is better than adding the 0 as the first parameter.

- do you want to add C.singular_subscheme()?

- I see many places you are restricting to fields. Should there be a field subclass?

- Things like Q.is_ordinary_singularity(), Q.tangents(), Q.multiplicity() don't work when Q is the curve point.

- Q.is_singular() and C.is_singular(Q) would be nice to have.



---

archive/issue_comments_283317.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-06-11T07:10:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20537#issuecomment-283317",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_283318.json:
```json
{
    "body": "Thanks. I added some examples with different fields. It looks like multiplicity works with RR and CC, and with finite fields. I think only number fields work with the tangents functions though, since they use the function factor().\n\nI implemented an is_singular function which just uses the is_smooth functions of affine/projective subschemes. If given a point it returns whether it's singular or not, otherwise it returns whether the curve is singular or not. I added a singular_subscheme function as well.\n\nCurrently, only plane curves over general rings can be defined. In the space curve initialization, dimension is checked. Could we get around this by checking the dimension of the new curve created by embedding the defining polynomials of the original curve into the polynomial ring with coefficients from the field of fractions of the base ring (assuming it's an integral domain)?\n\nIf we add classes for curves over rings, would the naming scheme AffineCurve_ring, ProjectiveCurve_ring for generic curves over rings, and renaming\nAffineCurve --> AffineCurve_field\nProjectiveCurve --> ProjectiveCurve_field\nbe okay?\n\nI haven't yet implemented the corresponding singularity analysis functions for points on curves; do you think it might be good for me to create classes for points on  general curves first? Maybe similar to what's done in ell_point.py for points on elliptic curves?",
    "created_at": "2016-06-11T07:20:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20537#issuecomment-283318",
    "user": "https://trac.sagemath.org/admin/accounts/users/gjorgenson"
}
```

Thanks. I added some examples with different fields. It looks like multiplicity works with RR and CC, and with finite fields. I think only number fields work with the tangents functions though, since they use the function factor().

I implemented an is_singular function which just uses the is_smooth functions of affine/projective subschemes. If given a point it returns whether it's singular or not, otherwise it returns whether the curve is singular or not. I added a singular_subscheme function as well.

Currently, only plane curves over general rings can be defined. In the space curve initialization, dimension is checked. Could we get around this by checking the dimension of the new curve created by embedding the defining polynomials of the original curve into the polynomial ring with coefficients from the field of fractions of the base ring (assuming it's an integral domain)?

If we add classes for curves over rings, would the naming scheme AffineCurve_ring, ProjectiveCurve_ring for generic curves over rings, and renaming
AffineCurve --> AffineCurve_field
ProjectiveCurve --> ProjectiveCurve_field
be okay?

I haven't yet implemented the corresponding singularity analysis functions for points on curves; do you think it might be good for me to create classes for points on  general curves first? Maybe similar to what's done in ell_point.py for points on elliptic curves?



---

archive/issue_comments_283319.json:
```json
{
    "body": "At a quick glance the code changes look good, but due to traveling I won't get to really test them for a couple days.\n\nI forgot we need to check dimension in the curve initialization. Yes, you could probably pass to the fractionfield in most cases and go from there (certainly for projective curves), but with that much complication, creating a field/ring class should be a different ticket. I consider it low priority and can be done possibly at a later date if you decide you have enough differentiated functionality to warrant it.\n\nIt does look to me like it is time for a point class for curves. Some things can be done in the corresponding point class for subschemes, but I think you have enough curve.point specific functionality to warrant its own class. This can be a different ticket where you create the class and add the corresponding singular analysis point functions. Most of the basic functionality for points can just inherit directly from appropriate subscheme point class.",
    "created_at": "2016-06-11T13:14:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20537#issuecomment-283319",
    "user": "https://github.com/bhutz"
}
```

At a quick glance the code changes look good, but due to traveling I won't get to really test them for a couple days.

I forgot we need to check dimension in the curve initialization. Yes, you could probably pass to the fractionfield in most cases and go from there (certainly for projective curves), but with that much complication, creating a field/ring class should be a different ticket. I consider it low priority and can be done possibly at a later date if you decide you have enough differentiated functionality to warrant it.

It does look to me like it is time for a point class for curves. Some things can be done in the corresponding point class for subschemes, but I think you have enough curve.point specific functionality to warrant its own class. This can be a different ticket where you create the class and add the corresponding singular analysis point functions. Most of the basic functionality for points can just inherit directly from appropriate subscheme point class.



---

archive/issue_comments_283320.json:
```json
{
    "body": "Okay, if classes and singularity analysis for points are implemented in another ticket, I think this one is ready for review. I opened #20811 for the points functionality. Is it okay to put the new point classes in the files for the subscheme point classes, or would it be better to make a points file in the curves folder for them?",
    "created_at": "2016-06-11T17:26:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20537#issuecomment-283320",
    "user": "https://trac.sagemath.org/admin/accounts/users/gjorgenson"
}
```

Okay, if classes and singularity analysis for points are implemented in another ticket, I think this one is ready for review. I opened #20811 for the points functionality. Is it okay to put the new point classes in the files for the subscheme point classes, or would it be better to make a points file in the curves folder for them?



---

archive/issue_comments_283321.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2016-06-11T17:26:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20537#issuecomment-283321",
    "user": "https://trac.sagemath.org/admin/accounts/users/gjorgenson"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_283322.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2016-06-13T12:46:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20537#issuecomment-283322",
    "user": "https://github.com/bhutz"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_283323.json:
```json
{
    "body": "except for the merge conflict, this functionality looks fine.",
    "created_at": "2016-06-13T12:46:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20537#issuecomment-283323",
    "user": "https://github.com/bhutz"
}
```

except for the merge conflict, this functionality looks fine.



---

archive/issue_comments_283324.json:
```json
{
    "body": "Maybe you should add doctests that illustrate the possible errors raised.",
    "created_at": "2016-06-13T13:10:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20537#issuecomment-283324",
    "user": "https://github.com/miguelmarco"
}
```

Maybe you should add doctests that illustrate the possible errors raised.



---

archive/issue_comments_283325.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-06-13T23:31:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20537#issuecomment-283325",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_283326.json:
```json
{
    "body": "Merging with beta4 broke the example in the singular_points function at line 260 of curve.py; too few points seem to be returned now.\n\nIt looks like this is due to the point search changes for 0 dimensional subschemes from #20780. Replacing the new point search with the old one from before the merge resolves the problem. Here's the failed example modified a bit:\n\n\n```\nR.<a> = QQ[]\nK.<b> = NumberField(a^8 - a^4 + 1)\nP.<x,y,z> = ProjectiveSpace(K, 2)\nC = Curve([359/12*x*y^2*z^2 + 2*y*z^4 + 187/12*y^3*z^2 + x*z^4\\\n+ 67/3*x^2*y*z^2 + 117/4*y^5 + 9*x^5 + 6*x^3*z^2 + 393/4*x*y^4\\\n+ 145*x^2*y^3 + 115*x^3*y^2 + 49*x^4*y], P)\nX = C.singular_subscheme()\nQ = P([1/2*b^5 + 1/2*b^3 - 1/2*b - 1,1,0])\nX(Q)\n(1/2*b^5 + 1/2*b^3 - 1/2*b - 1 : 1 : 0)\nX.rational_points() # Q is on X, but not in set of rational points anymore\n[(2/3*b^4 - 1/3 : 0 : 1), (b^6 : -b^6 : 1), (-b^6 : b^6 : 1), (-2/3*b^4 + 1/3 : 0 : 1)]\n```\n\n\nI thought the point search method in #20780 looked good when I reviewed it, and I think this issue might just be from a weird special case. For this example, during the part of the algorithm using the affine patch corresponding to y = 1, the Groebner basis used is `[x^2 + 2*x + 1/2*z^2 + 3/2, x*z + z, z^3 + z]`. The rightmost polynomial has z = 0 among its roots, but substituting z = 0 and y = 1 into the next polynomial `x*z + z` yields 0, and I think this causes the algorithm to skip any points with z = 0, y = 1. But if those values had been kept for the last polynomial `x^2 + 2*x + 1/2*z^2 + 3/2`, substituting them in would give `x^2 + 2*x + 3/2` which would give the x values of the missing points.\n\nI think a way to resolve this might be to just add something like\n\n```\nelse:\n    new_points.append(P)\n    good = 1\n```\n\nafter the if statement `if L != 0:` in line 159 of projective_homset.py. Doing this doesn't seem to break any examples, but does it mess up the algorithm at all?",
    "created_at": "2016-06-14T07:38:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20537#issuecomment-283326",
    "user": "https://trac.sagemath.org/admin/accounts/users/gjorgenson"
}
```

Merging with beta4 broke the example in the singular_points function at line 260 of curve.py; too few points seem to be returned now.

It looks like this is due to the point search changes for 0 dimensional subschemes from #20780. Replacing the new point search with the old one from before the merge resolves the problem. Here's the failed example modified a bit:


```
R.<a> = QQ[]
K.<b> = NumberField(a^8 - a^4 + 1)
P.<x,y,z> = ProjectiveSpace(K, 2)
C = Curve([359/12*x*y^2*z^2 + 2*y*z^4 + 187/12*y^3*z^2 + x*z^4\
+ 67/3*x^2*y*z^2 + 117/4*y^5 + 9*x^5 + 6*x^3*z^2 + 393/4*x*y^4\
+ 145*x^2*y^3 + 115*x^3*y^2 + 49*x^4*y], P)
X = C.singular_subscheme()
Q = P([1/2*b^5 + 1/2*b^3 - 1/2*b - 1,1,0])
X(Q)
(1/2*b^5 + 1/2*b^3 - 1/2*b - 1 : 1 : 0)
X.rational_points() # Q is on X, but not in set of rational points anymore
[(2/3*b^4 - 1/3 : 0 : 1), (b^6 : -b^6 : 1), (-b^6 : b^6 : 1), (-2/3*b^4 + 1/3 : 0 : 1)]
```


I thought the point search method in #20780 looked good when I reviewed it, and I think this issue might just be from a weird special case. For this example, during the part of the algorithm using the affine patch corresponding to y = 1, the Groebner basis used is `[x^2 + 2*x + 1/2*z^2 + 3/2, x*z + z, z^3 + z]`. The rightmost polynomial has z = 0 among its roots, but substituting z = 0 and y = 1 into the next polynomial `x*z + z` yields 0, and I think this causes the algorithm to skip any points with z = 0, y = 1. But if those values had been kept for the last polynomial `x^2 + 2*x + 1/2*z^2 + 3/2`, substituting them in would give `x^2 + 2*x + 3/2` which would give the x values of the missing points.

I think a way to resolve this might be to just add something like

```
else:
    new_points.append(P)
    good = 1
```

after the if statement `if L != 0:` in line 159 of projective_homset.py. Doing this doesn't seem to break any examples, but does it mess up the algorithm at all?



---

archive/issue_comments_283327.json:
```json
{
    "body": "Yes, I agree with that fix for points. It looks like it was dropping the point if the 'next' poly in the basis was already 0. Your 'else' makes sure it keeps that point.",
    "created_at": "2016-06-14T12:40:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20537#issuecomment-283327",
    "user": "https://github.com/bhutz"
}
```

Yes, I agree with that fix for points. It looks like it was dropping the point if the 'next' poly in the basis was already 0. Your 'else' makes sure it keeps that point.



---

archive/issue_comments_283328.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-06-14T20:08:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20537#issuecomment-283328",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_283329.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2016-06-14T20:10:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20537#issuecomment-283329",
    "user": "https://trac.sagemath.org/admin/accounts/users/gjorgenson"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_283330.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-06-14T21:04:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20537#issuecomment-283330",
    "user": "https://github.com/bhutz"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_283331.json:
```json
{
    "body": "Interestingly the point issue came up in another ticket I was testing today as well. This fix also resolves those instances as well.\n\ntests pass and docs build for me.",
    "created_at": "2016-06-14T21:04:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20537#issuecomment-283331",
    "user": "https://github.com/bhutz"
}
```

Interestingly the point issue came up in another ticket I was testing today as well. This fix also resolves those instances as well.

tests pass and docs build for me.



---

archive/issue_comments_283332.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2016-06-15T18:47:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20537#issuecomment-283332",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_019500.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2016-06-15T18:47:25Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/20537",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/20537#event-19500"
}
```
