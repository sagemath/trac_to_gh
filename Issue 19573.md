# Issue 19573: Cached function: add Cython version of get_key()

Issue created by migration from Trac.

Original creator: jdemeyer

Original creation time: 2015-12-30 14:12:51

The code to determine the actual key from `*args` and `**kwds` is duplicated (even with slightly different implementations!) in many methods. This should be moved to exactly one place. We also try to optimize things where applicable.


---

Comment by git created at 2015-12-30 19:08:33

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2015-12-30 19:12:34

Changing status from new to needs_review.


---

Comment by nbruin created at 2015-12-30 20:42:50

Do we have figures on what kind of optimization gain is obtained by these changes? Or are we just getting the benefit of having more streamlined and hence more maintainable code?

I noticed this one:

```
-        new = lambda x: not has_key(get_key(*x[0],**x[1]))
+        new = lambda x: not has_key(self.get_key(*x[0],**x[1]))
         arglist = filter(new, map(normalize_input, arglist))
```

Writing that as a list comprehension should avoid an extra (expensive) python call, so should be a little faster.


---

Comment by jdemeyer created at 2015-12-30 21:44:56

Replying to [comment:8 nbruin]:
> Do we have figures on what kind of optimization gain is obtained by these changes?
On first sight, not very much compared to the overhead of cached functions (less than I hoped).

> Or are we just getting the benefit of having more streamlined and hence more maintainable code?
That's an additional advantage. Cached functions need a big cleanup, and this ticket is part of that (I already did #19695 and #19768 earlier).


---

Comment by git created at 2015-12-31 08:47:52

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2015-12-31 10:14:50

The speed gain is about 12% for a function with 1 argument.


---

Comment by jdemeyer created at 2016-01-02 12:53:51

One further remark: I think that there should be a separate class for a cached method _bound_ to a class. This could simplify the code even further. I didn't do that on this ticket since there are already enough changes here.


---

Comment by tscrim created at 2016-01-04 02:35:25

Nils, are you planning/doing a review of this ticket?


---

Comment by nbruin created at 2016-01-04 07:27:43

Replying to [comment:14 tscrim]:
> Nils, are you planning/doing a review of this ticket?
If you're willing to do it, please go ahead. If not, I might try, but not in the next couple of days.


---

Comment by tscrim created at 2016-01-04 11:18:17

Okay, thanks.

This LGTM and does net a nice little speed bump as far as I can tell.


---

Comment by tscrim created at 2016-01-04 11:18:17

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2016-01-04 12:53:39

Thanks!


---

Comment by vbraun created at 2016-01-06 00:01:24

Resolution: fixed
