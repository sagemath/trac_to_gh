# Issue 19573: Cached function: add Cython version of get_key()

archive/issues_019573.json:
```json
{
    "body": "The code to determine the actual key from `*args` and `**kwds` is duplicated (even with slightly different implementations!) in many methods. This should be moved to exactly one place. We also try to optimize things where applicable.\n\nIssue created by migration from https://trac.sagemath.org/ticket/19810\n\n",
    "created_at": "2015-12-30T14:12:51Z",
    "labels": [
        "misc",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.0",
    "title": "Cached function: add Cython version of get_key()",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/19573",
    "user": "@jdemeyer"
}
```
The code to determine the actual key from `*args` and `**kwds` is duplicated (even with slightly different implementations!) in many methods. This should be moved to exactly one place. We also try to optimize things where applicable.

Issue created by migration from https://trac.sagemath.org/ticket/19810





---

archive/issue_comments_268891.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2015-12-30T19:08:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19573",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19573#issuecomment-268891",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_268892.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2015-12-30T19:12:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19573",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19573#issuecomment-268892",
    "user": "@jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_268893.json:
```json
{
    "body": "Do we have figures on what kind of optimization gain is obtained by these changes? Or are we just getting the benefit of having more streamlined and hence more maintainable code?\n\nI noticed this one:\n\n```\n-        new = lambda x: not has_key(get_key(*x[0],**x[1]))\n+        new = lambda x: not has_key(self.get_key(*x[0],**x[1]))\n         arglist = filter(new, map(normalize_input, arglist))\n```\n\nWriting that as a list comprehension should avoid an extra (expensive) python call, so should be a little faster.",
    "created_at": "2015-12-30T20:42:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19573",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19573#issuecomment-268893",
    "user": "@nbruin"
}
```

Do we have figures on what kind of optimization gain is obtained by these changes? Or are we just getting the benefit of having more streamlined and hence more maintainable code?

I noticed this one:

```
-        new = lambda x: not has_key(get_key(*x[0],**x[1]))
+        new = lambda x: not has_key(self.get_key(*x[0],**x[1]))
         arglist = filter(new, map(normalize_input, arglist))
```

Writing that as a list comprehension should avoid an extra (expensive) python call, so should be a little faster.



---

archive/issue_comments_268894.json:
```json
{
    "body": "Replying to [comment:8 nbruin]:\n> Do we have figures on what kind of optimization gain is obtained by these changes?\nOn first sight, not very much compared to the overhead of cached functions (less than I hoped).\n\n> Or are we just getting the benefit of having more streamlined and hence more maintainable code?\nThat's an additional advantage. Cached functions need a big cleanup, and this ticket is part of that (I already did #19695 and #19768 earlier).",
    "created_at": "2015-12-30T21:44:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19573",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19573#issuecomment-268894",
    "user": "@jdemeyer"
}
```

Replying to [comment:8 nbruin]:
> Do we have figures on what kind of optimization gain is obtained by these changes?
On first sight, not very much compared to the overhead of cached functions (less than I hoped).

> Or are we just getting the benefit of having more streamlined and hence more maintainable code?
That's an additional advantage. Cached functions need a big cleanup, and this ticket is part of that (I already did #19695 and #19768 earlier).



---

archive/issue_comments_268895.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-12-31T08:47:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19573",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19573#issuecomment-268895",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_268896.json:
```json
{
    "body": "The speed gain is about 12% for a function with 1 argument.",
    "created_at": "2015-12-31T10:14:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19573",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19573#issuecomment-268896",
    "user": "@jdemeyer"
}
```

The speed gain is about 12% for a function with 1 argument.



---

archive/issue_comments_268897.json:
```json
{
    "body": "One further remark: I think that there should be a separate class for a cached method *bound* to a class. This could simplify the code even further. I didn't do that on this ticket since there are already enough changes here.",
    "created_at": "2016-01-02T12:53:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19573",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19573#issuecomment-268897",
    "user": "@jdemeyer"
}
```

One further remark: I think that there should be a separate class for a cached method *bound* to a class. This could simplify the code even further. I didn't do that on this ticket since there are already enough changes here.



---

archive/issue_comments_268898.json:
```json
{
    "body": "Nils, are you planning/doing a review of this ticket?",
    "created_at": "2016-01-04T02:35:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19573",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19573#issuecomment-268898",
    "user": "@tscrim"
}
```

Nils, are you planning/doing a review of this ticket?



---

archive/issue_comments_268899.json:
```json
{
    "body": "Replying to [comment:14 tscrim]:\n> Nils, are you planning/doing a review of this ticket?\nIf you're willing to do it, please go ahead. If not, I might try, but not in the next couple of days.",
    "created_at": "2016-01-04T07:27:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19573",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19573#issuecomment-268899",
    "user": "@nbruin"
}
```

Replying to [comment:14 tscrim]:
> Nils, are you planning/doing a review of this ticket?
If you're willing to do it, please go ahead. If not, I might try, but not in the next couple of days.



---

archive/issue_comments_268900.json:
```json
{
    "body": "Okay, thanks.\n\nThis LGTM and does net a nice little speed bump as far as I can tell.",
    "created_at": "2016-01-04T11:18:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19573",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19573#issuecomment-268900",
    "user": "@tscrim"
}
```

Okay, thanks.

This LGTM and does net a nice little speed bump as far as I can tell.



---

archive/issue_comments_268901.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-01-04T11:18:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19573",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19573#issuecomment-268901",
    "user": "@tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_268902.json:
```json
{
    "body": "Thanks!",
    "created_at": "2016-01-04T12:53:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19573",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19573#issuecomment-268902",
    "user": "@jdemeyer"
}
```

Thanks!



---

archive/issue_comments_268903.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2016-01-06T00:01:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19573",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19573#issuecomment-268903",
    "user": "@vbraun"
}
```

Resolution: fixed
