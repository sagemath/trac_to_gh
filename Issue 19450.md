# Issue 19450: upgrade cvxopt to version 1.1.8

Issue created by migration from https://trac.sagemath.org/ticket/19687

Original creator: dimpase

Original creation time: 2015-12-09 21:52:21

CC:  jdemeyer ncohen

this is the current stable version


---

Comment by dimpase created at 2015-12-09 22:24:01

Changing status from new to needs_review.


---

Comment by dimpase created at 2015-12-09 22:24:01

New commits:


---

Comment by fbissey created at 2015-12-11 20:38:37

Changing status from needs_review to positive_review.


---

Comment by fbissey created at 2015-12-11 20:38:37

Looks good to me. No doctest broken on linux x86_64.


---

Comment by vbraun created at 2015-12-21 19:02:05

On older linux (Ubuntu 12.04) I get 

```
ImportError: /mnt/highperf/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/cvxopt/amd.so: undefined symbol: clock_gettime
```

according to man page, needs to "link with -lrt (only for glibc versions before 2.17)" but does not.


---

Comment by vbraun created at 2015-12-21 19:02:21

Changing status from positive_review to needs_work.


---

Comment by fbissey created at 2015-12-21 19:12:05

Upstream probably doesn't build on older machines. Should be trivial to fix.


---

Comment by dimpase created at 2015-12-21 20:50:56

Replying to [comment:3 vbraun]:
> On older linux (Ubuntu 12.04) I get 
> {{{
> ImportError: /mnt/highperf/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/cvxopt/amd.so: undefined symbol: clock_gettime
> }}}
> according to man page, needs to "link with -lrt (only for glibc versions before 2.17)" but does not.

It does not seem that testing glibc version tells you the right thing. Indeed, on Ubuntu 14.04, where this all works, I see

```
>>> import platform
>>> platform.libc_ver() 
('glibc', '2.4')
```

And I don't even have librt. I will just add it unconditionally, for every Linux...


---

Comment by git created at 2015-12-21 20:55:41

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by dimpase created at 2015-12-21 20:57:11

Changing status from needs_work to needs_review.


---

Comment by fbissey created at 2015-12-21 21:02:28

Wrong solution

```
if SUITESPARSE_EXT_LIB:
    amd = Extension('amd',
        libraries = ['amd','suitesparseconfig'],
        include_dirs = [SUITESPARSE_INC_DIR],
        library_dirs = [SUITESPARSE_LIB_DIR],
        sources = ['src/C/amd.c'])
else:
    amd = Extension('amd', 
        include_dirs = [ 'src/C/SuiteSparse/AMD/Include', 
            'src/C/SuiteSparse/SuiteSparse_config' ],
        define_macros = MACROS,
        sources = [ 'src/C/amd.c', 'src/C/SuiteSparse/SuiteSparse_config/SuiteSparse_config.c'] +
        glob('src/C/SuiteSparse/AMD/Source/*.c') )
```

The `amd` extension doesn't use `libraries` so I would be surprised if it worked by adding it to `BLAS_LIBS`.


---

Comment by git created at 2015-12-21 21:57:04

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by dimpase created at 2015-12-21 22:00:54

right, it should have gone to the amd Extension chunk, sorry.
The patch is longer, as I fixed all the fizz, by cloning https://github.com/cvxopt/cvxopt
and making a new patch using the old one.
Then I just added `libraries=['rt']` unconditionally there -- should this be done for Linux only?


---

Comment by fbissey created at 2015-12-21 22:03:36

No `librt` on OS X as far as I can tell, I don't know about cygwin. I would restrict it.


---

Comment by fbissey created at 2015-12-21 22:14:11

`clock_gettime` is not in the `AMD` code it is in the `SuiteSparse_config` I am checking the implications.


---

Comment by git created at 2015-12-21 22:23:54

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by dimpase created at 2015-12-21 22:33:50

Replying to [comment:13 fbissey]:
> `clock_gettime` is not in the `AMD` code it is in the `SuiteSparse_config` I am checking the implications.

well, the import error is in `amd.so`, and `src/C/SuiteSparse/SuiteSparse_config/SuiteSparse_config.c`
gets complied into the amd extension. So this looks right what I do now...


---

Comment by git created at 2015-12-21 22:37:23

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by fbissey created at 2015-12-21 22:48:18

Volker reported one failure, there may be other hidden behind the first one. That file is also included in `cholmod` and `umfpack` so they are potentially affected too. However the code should only be enabled if `SUITESPARSE_TIMER_ENABLED` is defined, in turn it depends on whether `NTIMER` is defined (which it is for `cholmod` and `umfpack` so in the end they won't be affected). A better solution in my opinion is to add `[('NTIMER', '1')]` to the line `define_macros` for the `amd` section.
----
New commits:


---

Comment by dimpase created at 2015-12-21 23:03:14

adding things like `[('NTIMER', '1')]` looks like going too far, as you're changing the behaviour of upstream code this way...


---

Comment by fbissey created at 2015-12-21 23:12:33

I don't think `cvxopt` cares about timing of the code, in fact `SuiteSparse_{tic,toc,time}` are used nowhere in `AMD`'s code. It is only enabled as part of `SuiteSparse_config.c` by accident I would argue. In contrast `cholmod` and `umfpack` have code that can use `SuiteSparse_time` and it is disabled on purpose in those. Those function are only used to measure performance, I don't think `cvxopt` would be doing it that way, if it was interested in measuring the performance of the `SuiteSparse` code.


---

Comment by fbissey created at 2015-12-21 23:14:16

I would further argue that we should point to upstream that unless they want to use those timing functions in the future, `NTIMER` should be in the default macros variable that is currently empty.


---

Comment by dimpase created at 2015-12-21 23:30:02

I just asked upstream [here](https://groups.google.com/d/msg/cvxopt/G57kX4Ocw0I/GDpeHcGlBwAJ) on this.


---

Comment by fbissey created at 2015-12-21 23:36:29

OK, I'll add an argument: 
`SuiteSparse_config.c` is not part of `amd`'s sources. If you were using an external `suitesparse` install, you would have a `suitesparse_config` library and `amd` would get the functions from this library as needed. But here we have a custom system that makes `SuiteSparse_config.c` a part of the used `amd` source code and including all the function of `SuiteSparse_config.c` instead of just the one needed by `amd`. That include the timing functions.


---

Comment by git created at 2015-12-22 19:38:37

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by dimpase created at 2015-12-22 19:39:22

indeed, that was the right suggestion for the fix. The upstream fixed this in dev [here](https://github.com/cvxopt/cvxopt/commit/9d55fa22ec849d460444fa08d17a841f5b3e06c1?diff=unified) 3 weeks ago...

please see the latest commit update. 
----
New commits:


---

Comment by fbissey created at 2015-12-22 19:41:50

I am happy with that resolution. Back to positive review.


---

Comment by fbissey created at 2015-12-22 19:41:50

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2015-12-23 11:06:35

Resolution: fixed
