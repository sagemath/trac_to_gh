# Issue 17148: Cleanup Graph.__init__ and DiGraph.__init__

Issue created by migration from https://trac.sagemath.org/ticket/17385

Original creator: vdelecroix

Original creation time: 2014-11-23 21:05:09

CC:  ncohen

While reading #17384, I thought that a global cleanup of `Graph.__init__` and `DiGraph.__init__` would be good. We implement:

1)

```
- data = dict([u, list(data[u])] for u in data)
+ data = {u: list(v) for u,v in data.iteritems()}
```


2) call to `uniq` is bad since it calls a useless `sorted`: each appearance of ``len(uniq(X))`` is replaced with ``len(set(X))``.

3) `dict.iteritems` is more readable and faster

```
sage: d = {randint(0,1000): [randint(0,1000) for _ in range(10)] for _ in range(100)}
sage: timeit("for i in d: j = d[i]", number=2000)
2000 loops, best of 3: 9.75 µs per loop
sage: timeit("for i,j in d.iteritems(): pass", number=2000)
2000 loops, best of 3: 7.3 µs per loop
```


4) avoid iterating through the elements of the adjacency matrix when possible

and more...


---

Comment by vdelecroix created at 2014-11-23 22:28:50

Changing status from new to needs_review.


---

Comment by git created at 2014-11-23 22:28:52

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dcoudert created at 2014-11-24 00:37:32

I was not expecting `bool is False` to be faster than `bool === False`. Amazing.

```
sage: bool = True
sage: %timeit bool is False
10000000 loops, best of 3: 70.3 ns per loop
sage: %timeit bool == False
10000000 loops, best of 3: 88.7 ns per loop
sage:
sage: bool = False
sage: %timeit bool == False
10000000 loops, best of 3: 88.9 ns per loop
sage: %timeit bool is False
10000000 loops, best of 3: 70.2 ns per loop
```


For me the patch is OK (installation, test, doc), so I give positive review.


---

Comment by dcoudert created at 2014-11-24 00:37:32

Changing status from needs_review to positive_review.


---

Comment by vdelecroix created at 2014-11-24 00:46:34

Thanks for the review.

To answer your interrogation `is` and `==` are *very* different, and `is` will *always* be faster.

The command `bool is False` is treated without asking anything to the object `bool`. It is just the Python kernel that checks whether the memory addresses match or not. For `==` a method of the object `bool` is called. Even if the comparison is implemented with something like `return self is other` you do not avoid that function call.

But I am not sure that those 18 non seconds are of critical importance in the creation of a graph... it was more a matter of uniformization ;-)

Vincent


---

Comment by tscrim created at 2014-11-24 00:48:08

While that's an improvement, the fastest way is to do `if x:` or `if not x:`.

```
sage: x = True
sage: %timeit if x is True: pass
10000000 loops, best of 3: 165 ns per loop
sage: %timeit if x is False: pass
10000000 loops, best of 3: 148 ns per loop
sage: %timeit if x: pass
10000000 loops, best of 3: 91.9 ns per loop
sage: %timeit if not x: pass
10000000 loops, best of 3: 80.1 ns per loop
sage: x = False
sage: %timeit if x is True: pass
10000000 loops, best of 3: 148 ns per loop
sage: %timeit if x is False: pass
10000000 loops, best of 3: 165 ns per loop
sage: %timeit if x: pass
10000000 loops, best of 3: 79.1 ns per loop
sage: %timeit if not x: pass
10000000 loops, best of 3: 91.9 ns per loop
```

So I'd change things to use that. Plus you can simplify things like:

```diff
+         if ((loops is None or loops is False) and
-         if (not loops and
```

(and if statements like that are more common).


---

Comment by vdelecroix created at 2014-11-24 00:54:37

Changing status from positive_review to needs_work.


---

Comment by vdelecroix created at 2014-11-24 00:54:37

Replying to [comment:5 tscrim]:
> While that's an improvement, the fastest way is to do `if x:` or `if not x:`.

You are right... I will do the changes (but your timings are not complete since you forgot the case `x = None`). There were occurrences at other places in the code. The advantage I see is that, while you read it, you know that `None` is one possible choice whereas

```
if not x and some_condition:
    if x is False:
        raise ValueError
    x = True
```

is a bit less verbose.

Vincent


---

Comment by tscrim created at 2014-11-24 01:04:03

True. When I was doing my timings I wasn't thinking of the `None` simplifications, but FTR:

```
sage: x = None
sage: %timeit if x is None: pass
10000000 loops, best of 3: 117 ns per loop
sage: %timeit if x is not None: pass
10000000 loops, best of 3: 102 ns per loop
sage: %timeit if x: pass
10000000 loops, best of 3: 88 ns per loop
sage: %timeit if not x: pass
10000000 loops, best of 3: 101 ns per loop
```

I would say the loss of verbosity (according to FF, I'm not making that word up like I thought) is covered by python ducktyping. Anyways, I don't really care that much, so if you don't think it should be changed, then feel free to leave it. Thanks for cleaning this up.


---

Comment by dcoudert created at 2014-11-24 01:17:37

I agree that we should try to let the code as readable as possible, especially for non critical code.

If we want to optimize further, there is apparently a small difference between `x is not None` and `not x is None` ;-)

```
sage: x = None
sage: %timeit if x is not None: pass
10000000 loops, best of 3: 57.8 ns per loop
sage: %timeit if not x is None: pass
10000000 loops, best of 3: 57.2 ns per loop
```



---

Comment by vdelecroix created at 2014-11-24 01:20:54

Hi,

Actually it was good to have another look at the code since I introduced a bug for weighted digraph.... (see the test in the last commit that will appear in a second).

`@`dcoudert: actually `is not` is an operator that should be as fast as `is`. While `not` involves some function call... it is strange that you get those timings.

Vincent


---

Comment by git created at 2014-11-24 01:28:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2014-11-24 01:30:52

I am a bit worried about the code duplication. It was a pain to me to look systematically at both `graph.py` and `digraph.py` to search for potential mistakes. And most of it are very similar if not identical... if you have a magic solution for that.


---

Comment by vdelecroix created at 2014-11-24 01:30:52

Changing status from needs_work to needs_review.


---

Comment by git created at 2014-11-24 01:31:22

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vdelecroix created at 2014-11-24 01:31:51

(wrong commit message, sorry)


---

Comment by dcoudert created at 2014-11-24 02:28:03

I don't understand why you write

```
if not loops and any(u in neighb for u,neighb in data.iteritems()):
   if loops is False:
```

Obviously, if the first test is True, then we have `loops==False`. So you don't need the second one.

The same holds for `if not weighted and any(...): if weighted is False:` and `if not multiedges and any(...): if multiedges is False:` and ...


---

Comment by vdelecroix created at 2014-11-24 02:37:37

Replying to [comment:14 dcoudert]:
> I don't understand why you write
> {{{
> if not loops and any(u in neighb for u,neighb in data.iteritems()):
>    if loops is False:
> }}}
> Obviously, if the first test is True, then we have `loops==False`. So you don't need the second one.

Nope: `loops` can be `None` (or anything that does evaluate to `False` such as `0`, `[]`, `()`, etc). Have a look at [comment:6].


---

Comment by ncohen created at 2014-11-24 03:55:07

Yoooooooo !!

"While reading #17384, I thought that a global cleanup of Graph.__init__ and DiGraph.__init__ would be good. We implement:"

Aahahaha. And do you want to know why I did not rewrite it all ? Because I thought that nobody would be willing to review the patch afterwards `:-P`

Thanks for your branch, I will try to review it today `;-)`

Nathann


---

Comment by vdelecroix created at 2014-11-24 04:10:50

Already two reviewers on #17385... for a "nobody" it is a lot! But if you have improvements to share, please do.

Vincent


---

Comment by ncohen created at 2014-11-24 04:12:32

Yo !

> Already two reviewers on #17385... for a "nobody" it is a lot! But if you have improvements to share, please do.

True true, I do not complain `:-P`

As to improvements, it was not really the goal: I would really like to make those functions cleaner by splitting them into subfunction, and perhaphs unify a bit better Graph/Digraph is possible. Just a rewrite, but for a cleaner code.

Nathann


---

Comment by ncohen created at 2014-11-24 04:13:42

By the way there is also this thing that has been waiting for a year or so ... #15706.

Nathann


---

Comment by ncohen created at 2014-11-24 05:10:45

Hellooooooooo !

Well, I just finished reading the patch and it looks good, thanks for that ! One remark:

* Error on a loop: in the doctest you added, the error messages refers to a
  dictionary that the user never built. Also, "no loop but a loop" is not very
  informative.... What about 'The graph was built with loops=False but a loop
  was found in its data' or something ?

Nathann


---

Comment by ncohen created at 2014-12-11 05:39:25

Changing status from needs_review to needs_info.


---

Comment by git created at 2014-12-12 21:25:11

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2014-12-12 21:25:56

Changing status from needs_info to needs_review.


---

Comment by ncohen created at 2014-12-13 04:52:07

Changing status from needs_review to needs_work.


---

Comment by ncohen created at 2014-12-13 04:52:07


```
sage -t --long /home/ncohen/.Sage/src/doc/en/thematic_tutorials/lie/affine_finite_crystals.rst
**********************************************************************
File "/home/ncohen/.Sage/src/doc/en/thematic_tutorials/lie/affine_finite_crystals.rst", line 359, in doc.en.thematic_tutorials.lie.affine_finite_crystals
Failed example:
    G.is_isomorphic(Gdual, edge_labels = True, certify = True)
Expected:
    (True, {[[1]]: [[-2]], [[2]]: [[-1]], [[-2]]: [[1]], [[-1]]: [[2]], []: [[0]]})
Got:
    (True, {[]: [[0]], [[1]]: [[-2]], [[2]]: [[-1]], [[-2]]: [[1]], [[-1]]: [[2]]})
```



---

Comment by vdelecroix created at 2014-12-13 11:07:40

Replying to [comment:25 ncohen]:
> {{{
> sage -t --long /home/ncohen/.Sage/src/doc/en/thematic_tutorials/lie/affine_finite_crystals.rst
> **********************************************************************
> File "/home/ncohen/.Sage/src/doc/en/thematic_tutorials/lie/affine_finite_crystals.rst", line 359, in doc.en.thematic_tutorials.lie.affine_finite_crystals
> Failed example:
>     G.is_isomorphic(Gdual, edge_labels = True, certify = True)
> Expected:
>     (True, {[This is the Trac macro *1* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#1-macro): [This is the Trac macro *-2* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#-2-macro), [This is the Trac macro *2* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#2-macro): [This is the Trac macro *-1* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#-1-macro), [This is the Trac macro *-2* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#-2-macro): [This is the Trac macro *1* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#1-macro), [This is the Trac macro *-1* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#-1-macro): [This is the Trac macro *2* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#2-macro), []: [This is the Trac macro *0* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#0-macro)})
> Got:
>     (True, {[]: [This is the Trac macro *0* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#0-macro), [This is the Trac macro *1* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#1-macro): [This is the Trac macro *-2* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#-2-macro), [This is the Trac macro *2* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#2-macro): [This is the Trac macro *-1* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#-1-macro), [This is the Trac macro *-2* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#-2-macro): [This is the Trac macro *1* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#1-macro), [This is the Trac macro *-1* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#-1-macro): [This is the Trac macro *2* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#2-macro)})
> }}}

This has something to do with this ticket? Strictly speaking, those dictionary are the same... the thing is that the keys have no well defined ordering. The only reasonable thing I see is to remove this `certify = True` in the test. What do you think?

Vincent


---

Comment by ncohen created at 2014-12-13 11:09:36

> This has something to do with this ticket?

It seems. Does not happen otherwise `O_o`

> Strictly speaking, those dictionary are the same... the thing is that the keys have no well defined ordering. The only reasonable thing I see is to remove this `certify = True` in the test. What do you think?

It is possible to test it with `the_certificate == { the actual dictionary }` but it seems overkill. +1 for a `certify=False`.

Nathann


---

Comment by git created at 2014-12-13 11:11:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2014-12-13 11:12:04

Changing status from needs_work to needs_review.


---

Comment by ncohen created at 2014-12-13 15:12:46

Looks good, thanks !

Nathann

P.S.: You should do a "git pull" on the develop branch


---

Comment by ncohen created at 2014-12-13 15:12:46

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2014-12-15 23:23:41

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2014-12-15 23:23:41

Conflicts, probably #15706


---

Comment by git created at 2015-01-17 16:19:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-01-17 16:21:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2015-01-17 16:24:58

Changing status from needs_work to needs_review.


---

Comment by vdelecroix created at 2015-01-17 16:24:58

Merged. I guess a last check-up would be fine.

Vincent


---

Comment by ncohen created at 2015-01-17 18:42:44

> Merged. I guess a last check-up would be fine.

I ran a "make ptestlong" just because my office's computer was feeling useless. No problem, good to go `;-)`

Nathann


---

Comment by ncohen created at 2015-01-17 18:42:44

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2015-01-23 23:40:45

Resolution: fixed
