# Issue 18389: fix gap_packages (Guava) optional tests

Issue created by migration from https://trac.sagemath.org/ticket/18626

Original creator: dimpase

Original creation time: 2015-06-06 22:02:26

CC:  vbraun jdemeyer ncohen wdj

in Sage 6.8.beta3 optional gap_packages tests fail in Guava;
see http://trac.sagemath.org/attachment/ticket/17390/gua

The 1st of errors I just reported on https://github.com/osj1961/guava/issues/1


---

Comment by dimpase created at 2015-06-07 00:30:40

New commits:


---

Comment by dimpase created at 2015-06-07 00:31:17

Replying to [comment:2 dimpase]:
> New commits:
> ||[4b17832](http://git.sagemath.org/sage.git/commit/?id=4b178327727c76d60f7423ecd3ce28c4bea8bdf7)||`don't compute MatrixAutomorphisms of empty matrices`||

this takes care of 2 out of 7 failures


---

Attachment

gap/libgap discrepancy...


---

Comment by dimpase created at 2015-06-08 11:30:46

must be in the current working directory


---

Attachment

With the fix I proposed here:
https://github.com/osj1961/guava/pull/2
I see a strange discrepancy between GAP and libGAP.
Namely:
   * apply the patch from the pull request to `SAGELOCAL/gap/current/pkg/guava/lib`
   * download two attachments to somewhere; 
   * start Sage in in there, and `load("l.sage")`
   * watch `libgap` succeeding, and `gap` failing...

What is going on, any clues?


---

Comment by dimpase created at 2015-06-08 11:44:44

Replying to [comment:4 dimpase]:

> What is going on, any clues?

could it be pexpect acting up?


---

Comment by dimpase created at 2015-06-08 12:37:37

Replying to [comment:5 dimpase]:
> Replying to [comment:4 dimpase]:
> 
> > What is going on, any clues?
> 
> could it be pexpect acting up?

OK, this was just a stale GAP workspace. They should be wiped up after `gap_packages` spkg is installed!


---

Comment by git created at 2015-06-08 13:30:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2015-06-08 15:42:31

The latter commit was not enough - also Guava C code needed a small fix, to accommodate very long tempfile names we get nowadays. This is the 2nd commit in https://github.com/osj1961/guava/pull/2

we can either make a new spkg with these fixes, or wait for upstream, hopefully they can be quick...


---

Comment by dimpase created at 2015-06-08 22:47:19

By the way, are we replacing `os.system()` by `subprocess.call()`, or leave them?


---

Comment by vbraun created at 2015-06-09 07:25:09

IMHO you should always use subprocess.call over os.system, its such a no-braner. You want the Pythonic interface or do you want the bare posix wrapper?


---

Comment by dimpase created at 2015-06-09 07:35:55

Replying to [comment:11 vbraun]:
> IMHO you should always use subprocess.call over os.system, its such a no-braner. You want the Pythonic interface or do you want the bare posix wrapper?

it's  about old Sage code that uses `os.system()`. While I am at it I can do a fly-by patch...


---

Comment by git created at 2015-06-09 13:24:06

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2015-06-09 13:36:58

You don't really need to create a temporary file just to redirect output to, you can use `subprocess.check_output()` which is exactly meant for this use-case (unless the subprocess really doesn't work with a piped stdout, but that's unlikely).


---

Comment by git created at 2015-06-10 09:31:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-06-18 22:59:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-06-18 23:02:39

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by dimpase created at 2015-06-18 23:04:36

Changing status from new to needs_review.


---

Comment by dimpase created at 2015-06-18 23:04:36

with the gap 4.7.8 (see #18689), all tests pass!


---

Comment by ncohen created at 2015-06-28 18:41:00

Hello Dima,

In this patch you add a block of code with is indented with 3 spaces instead of 4, right before a block of code with a 4-spaces indentation. So you have a 'if' inside of a loop, just because of 1 space. The code seems to behave as intended.

This being said, wouldn't it be better to *not* move this big block of code, and just add this?

```
if gap("Length(matCwt)") <= 0: 
    continue
```


Nathann


---

Comment by dimpase created at 2015-06-28 19:19:15

Replying to [comment:20 ncohen]:
> Hello Dima,
> 
> In this patch you add a block of code with is indented with 3 spaces instead of 4, right before a block of code with a 4-spaces indentation. So you have a 'if' inside of a loop, just because of 1 space. The code seems to behave as intended.
> 
ok, I'll fix this.

> This being said, wouldn't it be better to *not* move this big block of code, and just add this?
> {{{
> if gap("Length(matCwt)") <= 0: 
>     continue
> }}}

IMHO, `continue` is even less readable than `goto`...


---

Comment by ncohen created at 2015-06-28 19:22:32

> IMHO, `continue` is even less readable than `goto`...

With a 'continue' you do not have to change the indentation of 10 lines of code only because you want to make an assumption.

And I will start minding 'continue' the day Python will be compiled. A language that stores classes methods in a *dictionary* does not deserve this kind of respect.

Nathann


---

Comment by dimpase created at 2015-06-28 19:40:23

Replying to [comment:22 ncohen]:
> > IMHO, `continue` is even less readable than `goto`...
> 
> With a 'continue' you do not have to change the indentation of 10 lines of code only because you want to make an assumption.

well, but it results in unreadable crap. Given that this loop already has a number of `break`s,
in particular.

> 
> And I will start minding 'continue' the day Python will be compiled. A language that stores classes methods in a *dictionary* does not deserve this kind of respect.

Language, perhaps. But the mere mortals who need to read the code?


---

Comment by dimpase created at 2015-06-28 23:44:23

just checked that the rebased version (in public/18626) works, long tests pass.


---

Comment by git created at 2015-06-29 10:15:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-06-29 10:19:15

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by ncohen created at 2015-06-29 10:20:18

Sorry for the mess! I pushed to much by mistake... It should be fixed now: I added a commit which changes the formatting of a broken internet doctest. If it's good for you, you can update the ticket's status.

Nathann


---

Comment by dimpase created at 2015-06-29 11:04:08

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2015-06-30 12:57:56

Resolution: fixed
