# Issue 28619: Support sphinx >= 2.1

Issue created by migration from https://trac.sagemath.org/ticket/28856

Original creator: @timokau

Original creation time: 2019-12-09 09:36:27

CC:  arojas fbissey saraedum fchapoton jhpalmieri jdemeyer mpatel thansen strogdon

The attributes "todo_all_todos" and "citations" were previously
implicitly initialized by sphinx. That changed in sphinx 2.1 due to some
refactoring:

https://github.com/sphinx-doc/sphinx/commit/9abb4820b18201f63d77fdccb4ef394a21442f7a
https://github.com/sphinx-doc/sphinx/commit/885d35e374b56d1d17f5036fe07b74229cdbec7f

So now we need to check for the case where they are not initialized yet.
We can't actually update to sphinx 2.1 yet, since its python3 only. This
is mostly intended to make things easier for distros and allow us to
update in the future.


---

Comment by @timokau created at 2019-12-09 09:36:48

Changing status from new to needs_review.


---

Comment by @timokau created at 2019-12-09 09:36:48

New commits:


---

Comment by git created at 2019-12-09 09:39:55

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2019-12-09 22:38:27

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2019-12-10 09:36:07

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2019-12-11 12:33:51

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by @timokau created at 2019-12-11 23:06:10

Changing status from needs_review to needs_work.


---

Comment by @timokau created at 2019-12-11 23:06:10

Remaining problem:


```
[manifolds] Exception occurred:
[manifolds]   File "/nix/store/ldl3rb92yvl070c7q3nnjgwl5mdx2wvb-python3.7-sphinx-2.0.0/lib/python3.7/site-packages/sphinx/ext/intersphinx.py", line 207, in load_mappings
[manifolds]     for key, (name, (uri, invs)) in app.config.intersphinx_mapping.items():
[manifolds] ValueError: too many values to unpack (expected 2)
[manifolds] The full traceback has been saved in /build/sphinx-err-erras5d4.log, if you want to report the issue to the developers.
[manifolds] Please also report this if it was a user error, so that a better error message can be provided next time.
[manifolds] A bug report can be filed in the tracker at <https://github.com/sphinx-doc/sphinx/issues>. Thanks!
Traceback (most recent call last):
  File "/nix/store/9894fxjpg8v99j14kip6b13rdfgf4m5k-python3-3.7.5/lib/python3.7/runpy.py", line 193, in _run_module_as_main
    "__main__", mod_spec)
  File "/nix/store/9894fxjpg8v99j14kip6b13rdfgf4m5k-python3-3.7.5/lib/python3.7/runpy.py", line 85, in _run_code
    exec(code, run_globals)
  File "/nix/store/i0gjbmskaxkmj2qif96ayvb803l6hm4k-python3.7-sagelib-9.0.beta6/lib/python3.7/site-packages/sage_setup/docbuild/sphinxbuild.py", line 328, in <module>
    runsphinx()
  File "/nix/store/i0gjbmskaxkmj2qif96ayvb803l6hm4k-python3.7-sagelib-9.0.beta6/lib/python3.7/site-packages/sage_setup/docbuild/sphinxbuild.py", line 317, in runsphinx
    sys.stderr.raise_errors()
  File "/nix/store/i0gjbmskaxkmj2qif96ayvb803l6hm4k-python3.7-sagelib-9.0.beta6/lib/python3.7/site-packages/sage_setup/docbuild/sphinxbuild.py", line 252, in raise_errors
    raise OSError(self._error)
OSError: Exception occurred:
Error building the documentation.
Traceback (most recent call last):
  File "/nix/store/9894fxjpg8v99j14kip6b13rdfgf4m5k-python3-3.7.5/lib/python3.7/runpy.py", line 193, in _run_module_as_main
    "__main__", mod_spec)
  File "/nix/store/9894fxjpg8v99j14kip6b13rdfgf4m5k-python3-3.7.5/lib/python3.7/runpy.py", line 85, in _run_code
    exec(code, run_globals)
  File "/nix/store/i0gjbmskaxkmj2qif96ayvb803l6hm4k-python3.7-sagelib-9.0.beta6/lib/python3.7/site-packages/sage_setup/docbuild/__main__.py", line 2, in <module>
    main()
  File "/nix/store/i0gjbmskaxkmj2qif96ayvb803l6hm4k-python3.7-sagelib-9.0.beta6/lib/python3.7/site-packages/sage_setup/docbuild/__init__.py", line 1671, in main
    builder()
  File "/nix/store/i0gjbmskaxkmj2qif96ayvb803l6hm4k-python3.7-sagelib-9.0.beta6/lib/python3.7/site-packages/sage_setup/docbuild/__init__.py", line 310, in _wrapper
    getattr(get_builder(document), name)(*args, **kwds)
  File "/nix/store/i0gjbmskaxkmj2qif96ayvb803l6hm4k-python3.7-sagelib-9.0.beta6/lib/python3.7/site-packages/sage_setup/docbuild/__init__.py", line 504, in _wrapper
    build_many(build_ref_doc, L)
  File "/nix/store/i0gjbmskaxkmj2qif96ayvb803l6hm4k-python3.7-sagelib-9.0.beta6/lib/python3.7/site-packages/sage_setup/docbuild/__init__.py", line 258, in build_many
    _build_many(target, args, processes=NUM_THREADS)
  File "/nix/store/i0gjbmskaxkmj2qif96ayvb803l6hm4k-python3.7-sagelib-9.0.beta6/lib/python3.7/site-packages/sage_setup/docbuild/utils.py", line 283, in build_many
    raise worker_exc.original_exception
subprocess.CalledProcessError: Command '['python', '-um', 'sage_setup.docbuild.sphinxbuild', '-N', '-b', 'html', '-d', '/build/share/doc/sage/doctrees/en/reference/manifolds', '-D', 'multidoc_first_pass=0', '/bui>
builder for '/nix/store/rbwjmqg1dp0padhni45xkhj4vqmxc4x9-sagedoc-9.0.beta6.drv' failed with exit code 1
```


Related to https://github.com/sphinx-doc/sphinx/pull/5826 and the way we use intersphinx.


---

Comment by slelievre created at 2019-12-12 03:52:02

Changing keywords from "" to "sphinx".


---

Comment by @timokau created at 2019-12-12 14:42:41

Since I have little experience with sphinx and don't know how and why our intersphinx usage differs from normal usage, I'm having issues fixing this issue.

I've CC'ed some people who have touched the sphinx config in the past. Can anybody help with the second issue described in the top post (regarding intersphinx)?


---

Comment by @timokau created at 2019-12-22 17:34:12

Does anyone have experience with sphinx hooks? Understanding why the hook introduced in https://github.com/sphinx-doc/sphinx/pull/5826 isn't called would help a lot.


---

Comment by @mwageringel created at 2019-12-22 21:38:42

I do not have much experience with sphinx, but, at the bottom of `src/sage/docs/conf.py`, it appears that intersphinx is not loaded the usual way by adding it to the `extensions` list, but instead it is manually initialized in order to inject a custom function for `missing_reference`.


```python
        app.add_config_value('intersphinx_mapping', {}, False)
        app.add_config_value('intersphinx_cache_limit', 5, False)
        # We do *not* fully initialize intersphinx since we call it by hand
        # in find_sage_dangling_links.
        #   app.connect('missing-reference', missing_reference)
        app.connect('missing-reference', find_sage_dangling_links)
        import sphinx.ext.intersphinx
        app.connect('builder-inited', set_intersphinx_mappings)
        app.connect('builder-inited', sphinx.ext.intersphinx.load_mappings)
```


Probably this means that `normalize_intersphinx_mapping` is never called, but adjusting the code above as [in the PR](https://github.com/sphinx-doc/sphinx/pull/5826/commits/556f599e6ec343e2594b39f55d72d651a64e2458#diff-f4c986083e6865961f08356c4b080199L363-R372) might fix it.


---

Comment by embray created at 2020-01-06 14:10:03

Ticket retargeted after milestone closed


---

Comment by @timokau created at 2020-01-20 10:52:15

For what it's worth, I have not been able to get this working and don't have time to work on it any further right now. My current attempt (trying to get the normalization in there at the right point):


```
diff --git a/src/sage/docs/conf.py b/src/sage/docs/conf.py
index d86fc9c6d1..013f1794e4 100644
--- a/src/sage/docs/conf.py
+++ b/src/sage/docs/conf.py
@@ -8,6 +8,7 @@ from docutils import nodes
 from docutils.transforms import Transform
 from sphinx.ext.doctest import blankline_re
 from sphinx import highlighting
+import sphinx.ext.intersphinx as intersphinx
 from IPython.lib.lexers import IPythonConsoleLexer, IPyLexer
 
 # If your extensions are in another directory, add it here.
@@ -175,7 +176,7 @@ intersphinx_mapping = {
                              "python{}.inv".format(python_version))),
     'pplpy': (PPLPY_DOCS, None)}
 
-def set_intersphinx_mappings(app, _config):
+def set_intersphinx_mappings(app, config):
     """
     Add precompiled inventory (the objects.inv)
     """
@@ -201,6 +202,8 @@ def set_intersphinx_mappings(app, _config):
             dst = os.path.join(invpath, directory, 'objects.inv')
             app.config.intersphinx_mapping[src] = dst
 
+    intersphinx.normalize_intersphinx_mapping(app, config)
+
 
 # By default document are not master.
 multidocs_is_master = True
@@ -669,7 +672,7 @@ def call_intersphinx(app, env, node, contnode):
     """
     debug_inf(app, "???? Trying intersphinx for %s" % node['reftarget'])
     builder = app.builder
-    res =  sphinx.ext.intersphinx.missing_reference(
+    res =  intersphinx.missing_reference(
         app, env, node, contnode)
     if res:
         # Replace absolute links to $SAGE_DOC by relative links: this
@@ -852,12 +855,11 @@ def setup(app):
     if app.srcdir.startswith(SAGE_DOC_SRC):
         app.add_config_value('intersphinx_mapping', {}, False)
         app.add_config_value('intersphinx_cache_limit', 5, False)
+        app.connect('config-inited', set_intersphinx_mappings)
+        # app.connect('config-inited', intersphinx.normalize_intersphinx_mapping)
+        app.connect('builder-inited', intersphinx.load_mappings)
         # We do *not* fully initialize intersphinx since we call it by hand
         # in find_sage_dangling_links.
         #   app.connect('missing-reference', missing_reference)
         app.connect('missing-reference', find_sage_dangling_links)
-        import sphinx.ext.intersphinx
-        app.connect('config-inited', set_intersphinx_mappings)
-        app.connect('config-inited', sphinx.ext.intersphinx.normalize_intersphinx_mapping)
-        app.connect('builder-inited', sphinx.ext.intersphinx.load_mappings)
         app.connect('builder-inited', nitpick_patch_config)

```



---

Comment by jhpalmieri created at 2020-01-25 00:18:13

I have been attempting to initialize intersphinx as an ordinary Sphinx extension. The reference manual builds this way, but other pieces of the documentation fail because of missing citations, and I don't know why. But succeeding with the reference manual seems like progress. Anyway, here is my current attempt; this is using the version of Sphinx which is included in Sage — I thought I would try get that to work first with this approach, and then move on to a more recent version of Sphinx.

```diff
diff --git a/src/sage/docs/conf.py b/src/sage/docs/conf.py
index 23cf5d6792..226e68a31b 100644
--- a/src/sage/docs/conf.py
+++ b/src/sage/docs/conf.py
@@ -25,6 +25,7 @@ extensions = ['inventory_builder',
               'sphinx.ext.inheritance_diagram',
               'sphinx.ext.todo',
               'sphinx.ext.extlinks',
+              'sphinx.ext.intersphinx',
               'IPython.sphinxext.ipython_directive',
               'matplotlib.sphinxext.plot_directive']
 
@@ -88,11 +89,6 @@ from sage.all_cmdline import *
 plot_html_show_formats = False
 plot_formats = ['svg', 'pdf', 'png']
 
-# We do *not* fully initialize intersphinx since we call it by hand
-# in find_sage_dangling_links.
-#, 'sphinx.ext.intersphinx']
-
-
 # Add any paths that contain templates here, relative to this directory.
 templates_path = [os.path.join(SAGE_DOC_SRC, 'common', 'templates'), 'templates']
 
@@ -850,10 +846,6 @@ def setup(app):
     # set to a temporary directory.  We don't want to use intersphinx,
     # etc., when doing introspection.
     if app.srcdir.startswith(SAGE_DOC_SRC):
-        app.add_config_value('intersphinx_mapping', {}, False)
-        app.add_config_value('intersphinx_cache_limit', 5, False)
-        # We do *not* fully initialize intersphinx since we call it by hand
-        # in find_sage_dangling_links.
         #   app.connect('missing-reference', missing_reference)
         app.connect('missing-reference', find_sage_dangling_links)
         import sphinx.ext.intersphinx
```



---

Comment by @timokau created at 2020-01-25 16:33:32

Sounds like good progress indeed! Throwing away our hacks and becoming a "normal" intersphinx consumer would be the best solution.


---

Comment by arojas created at 2020-01-28 20:14:59

Opened #29095 for the runtime issues with latest sphinx (which are much easier to fix)


---

Comment by @timokau created at 2020-03-09 11:06:13

Just as a heads-up: The combination of an outdated sphinx version and a newer (>=0.15) docutils version leads to (harmless) doctest failures:


```
File "/nix/store/kyzn2mbdpjgdh1n8ldqwah3s1k4b6mza-sage-src-8.9/src/sage/interfaces/tachyon.py", line 191, in sage.interfaces.tachyon.TachyonRT.help
Failed example:
    t.help(use_pager=False)
Expected:
    This help, which was written by John Stone, describes ...
Got:
    doctest:warning
      File "/nix/store/kra72yycg2ixhkmx944qgrlgaqhr6ia4-sage-with-env-8.9/bin/sage-runtests", line 179, in <module>
        err = DC.run()
      File "/nix/store/3j74nni97qk6pj1slbbgn67q5qw4r51s-python-2.7.17-env/lib/python2.7/site-packages/sage/doctest/control.py", line 1227, in run
        self.run_doctests()
      File "/nix/store/3j74nni97qk6pj1slbbgn67q5qw4r51s-python-2.7.17-env/lib/python2.7/site-packages/sage/doctest/control.py", line 928, in run_doctests
        self.dispatcher.dispatch()
      File "/nix/store/3j74nni97qk6pj1slbbgn67q5qw4r51s-python-2.7.17-env/lib/python2.7/site-packages/sage/doctest/forker.py", line 2041, in dispatch
        self.parallel_dispatch()
      File "/nix/store/3j74nni97qk6pj1slbbgn67q5qw4r51s-python-2.7.17-env/lib/python2.7/site-packages/sage/doctest/forker.py", line 1933, in parallel_dispatch
        w.start()  # This might take some time
      File "/nix/store/3j74nni97qk6pj1slbbgn67q5qw4r51s-python-2.7.17-env/lib/python2.7/site-packages/sage/doctest/forker.py", line 2208, in start
        super(DocTestWorker, self).start()
      File "/nix/store/k5iyhnvy9cdlq3mpavw6s8blyr0px522-python-2.7.17/lib/python2.7/multiprocessing/process.py", line 130, in start
        self._popen = Popen(self)
      File "/nix/store/k5iyhnvy9cdlq3mpavw6s8blyr0px522-python-2.7.17/lib/python2.7/multiprocessing/forking.py", line 126, in __init__
        code = process_obj._bootstrap()
      File "/nix/store/k5iyhnvy9cdlq3mpavw6s8blyr0px522-python-2.7.17/lib/python2.7/multiprocessing/process.py", line 267, in _bootstrap
        self.run()
      File "/nix/store/3j74nni97qk6pj1slbbgn67q5qw4r51s-python-2.7.17-env/lib/python2.7/site-packages/sage/doctest/forker.py", line 2180, in run
        task(self.options, self.outtmpfile, msgpipe, self.result_queue)
      File "/nix/store/3j74nni97qk6pj1slbbgn67q5qw4r51s-python-2.7.17-env/lib/python2.7/site-packages/sage/doctest/forker.py", line 2512, in __call__
        doctests, extras = self._run(runner, options, results)
      File "/nix/store/3j74nni97qk6pj1slbbgn67q5qw4r51s-python-2.7.17-env/lib/python2.7/site-packages/sage/doctest/forker.py", line 2561, in _run
        result = runner.run(test)
      File "/nix/store/3j74nni97qk6pj1slbbgn67q5qw4r51s-python-2.7.17-env/lib/python2.7/site-packages/sage/doctest/forker.py", line 897, in run
        return self._run(test, compileflags, out)
      File "/nix/store/3j74nni97qk6pj1slbbgn67q5qw4r51s-python-2.7.17-env/lib/python2.7/site-packages/sage/doctest/forker.py", line 681, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/nix/store/3j74nni97qk6pj1slbbgn67q5qw4r51s-python-2.7.17-env/lib/python2.7/site-packages/sage/doctest/forker.py", line 1131, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.interfaces.tachyon.TachyonRT.help[2]>", line 1, in <module>
        t.help(use_pager=False)
      File "/nix/store/3j74nni97qk6pj1slbbgn67q5qw4r51s-python-2.7.17-env/lib/python2.7/site-packages/sage/interfaces/tachyon.py", line 784, in help
        f = format(s)
      File "/nix/store/3j74nni97qk6pj1slbbgn67q5qw4r51s-python-2.7.17-env/lib/python2.7/site-packages/sage/misc/sagedoc.py", line 720, in format
        s = detex(s, embedded=embedded)
      File "/nix/store/3j74nni97qk6pj1slbbgn67q5qw4r51s-python-2.7.17-env/lib/python2.7/site-packages/sage/misc/sagedoc.py", line 228, in detex
        s = sphinxify(s, format='text')
      File "/nix/store/3j74nni97qk6pj1slbbgn67q5qw4r51s-python-2.7.17-env/lib/python2.7/site-packages/sage/misc/sphinxify.py", line 123, in sphinxify
        sphinx_app.build(None, [rst_name])
      File "/nix/store/3j74nni97qk6pj1slbbgn67q5qw4r51s-python-2.7.17-env/lib/python2.7/site-packages/sphinx/application.py", line 338, in build
        self.builder.build_specific(filenames)
      File "/nix/store/3j74nni97qk6pj1slbbgn67q5qw4r51s-python-2.7.17-env/lib/python2.7/site-packages/sphinx/builders/__init__.py", line 335, in build_specific
        summary=__('%d source files given on command line') % len(to_write))
      File "/nix/store/3j74nni97qk6pj1slbbgn67q5qw4r51s-python-2.7.17-env/lib/python2.7/site-packages/sphinx/builders/__init__.py", line 360, in build
        updated_docnames = set(self.read())
      File "/nix/store/3j74nni97qk6pj1slbbgn67q5qw4r51s-python-2.7.17-env/lib/python2.7/site-packages/sphinx/builders/__init__.py", line 468, in read
        self._read_serial(docnames)
      File "/nix/store/3j74nni97qk6pj1slbbgn67q5qw4r51s-python-2.7.17-env/lib/python2.7/site-packages/sphinx/builders/__init__.py", line 490, in _read_serial
        self.read_doc(docname)
      File "/nix/store/3j74nni97qk6pj1slbbgn67q5qw4r51s-python-2.7.17-env/lib/python2.7/site-packages/sphinx/builders/__init__.py", line 534, in read_doc
        doctree = read_doc(self.app, self.env, self.env.doc2path(docname))
      File "/nix/store/3j74nni97qk6pj1slbbgn67q5qw4r51s-python-2.7.17-env/lib/python2.7/site-packages/sphinx/io.py", line 318, in read_doc
        pub.publish()
      File "/nix/store/3j74nni97qk6pj1slbbgn67q5qw4r51s-python-2.7.17-env/lib/python2.7/site-packages/docutils/core.py", line 219, in publish
        self.apply_transforms()
      File "/nix/store/3j74nni97qk6pj1slbbgn67q5qw4r51s-python-2.7.17-env/lib/python2.7/site-packages/docutils/core.py", line 200, in apply_transforms
        self.document.transformer.apply_transforms()
      File "/nix/store/3j74nni97qk6pj1slbbgn67q5qw4r51s-python-2.7.17-env/lib/python2.7/site-packages/sphinx/transforms/__init__.py", line 90, in apply_transforms
        Transformer.apply_transforms(self)
      File "/nix/store/3j74nni97qk6pj1slbbgn67q5qw4r51s-python-2.7.17-env/lib/python2.7/site-packages/docutils/transforms/__init__.py", line 171, in apply_transforms
        transform.apply(**kwargs)
      File "/nix/store/3j74nni97qk6pj1slbbgn67q5qw4r51s-python-2.7.17-env/lib/python2.7/site-packages/sphinx/transforms/__init__.py", line 245, in apply
        apply_source_workaround(n)
      File "/nix/store/3j74nni97qk6pj1slbbgn67q5qw4r51s-python-2.7.17-env/lib/python2.7/site-packages/sphinx/util/nodes.py", line 94, in apply_source_workaround
        for classifier in reversed(node.parent.traverse(nodes.classifier)):
      File "/nix/store/3j74nni97qk6pj1slbbgn67q5qw4r51s-python-2.7.17-env/lib/python2.7/site-packages/docutils/nodes.py", line 46, in wrapper
        warnings.warn(msg, FutureWarning, stacklevel=2)
    :
    FutureWarning: 
       The iterable returned by Node.traverse()
       will become an iterator instead of a list in Docutils > 0.16.
    This help, which was written by John Stone, describes how to create
    scene files.
    <BLANKLINE>
    At the present time, scene description files are very simple. The
    parser can't handle multiple file scene descriptions, although they
    may be added in the future.  Most of the objects and their scene
    description are closely related to the RAY API *(See the API docs for
    additional info.)*
```

These will likely turn into errors for docutils 0.16, but are already fixed in sphinx upstream: https://github.com/sphinx-doc/sphinx/commit/faedcc48ccb942b9a7b758b699b30f0d026c0771


---

Comment by jhpalmieri created at 2020-03-22 18:50:20

In the meantime, a beta for Sphinx 3.0.0 is available: see https://github.com/sphinx-doc/sphinx/blob/3.0.x/CHANGES


---

Comment by fbissey created at 2020-04-07 10:04:52

A user of sage-on-gentoo did go and talk to upstream about our difficulties with intersphinx in https://github.com/sphinx-doc/sphinx/issues/7409 and one of the dev took it to heart. Apparently we have to switch from `builder-inetd` to `config-inetd` and make sure we have sphinx including https://github.com/sphinx-doc/sphinx/pull/7415

I haven't got around figuring out how to use all that information.


---

Comment by fbissey created at 2020-04-07 10:29:52

And now that I have looked more closely, it is all included in the newly released sphinx-3.0.


---

Comment by fbissey created at 2020-04-14 03:09:46

I am trying to get to support sphinx 3.0 in gentoo in time for sage-9.1. So far I have combined the branch attached to this ticket plus comment:15. 

```diff
--- a/sage/docs/conf.py
+++ b/sage/docs/conf.py
@@ -8,6 +8,7 @@ from docutils import nodes
 from docutils.transforms import Transform
 from sphinx.ext.doctest import blankline_re
 from sphinx import highlighting
+import sphinx.ext.intersphinx as intersphinx
 from IPython.lib.lexers import IPythonConsoleLexer, IPyLexer
 
 # If your extensions are in another directory, add it here.
@@ -175,7 +176,7 @@ intersphinx_mapping = {
                              "python{}.inv".format(python_version))),
     'pplpy': (PPLPY_DOCS, None)}
 
-def set_intersphinx_mappings(app):
+def set_intersphinx_mappings(app, config):
     """
     Add precompiled inventory (the objects.inv)
     """
@@ -201,6 +202,8 @@ def set_intersphinx_mappings(app):
             dst = os.path.join(invpath, directory, 'objects.inv')
             app.config.intersphinx_mapping[src] = dst
 
+    intersphinx.normalize_intersphinx_mapping(app, config)
+
 
 # By default document are not master.
 multidocs_is_master = True
@@ -669,7 +672,7 @@ def call_intersphinx(app, env, node, contnode):
     """
     debug_inf(app, "???? Trying intersphinx for %s" % node['reftarget'])
     builder = app.builder
-    res =  sphinx.ext.intersphinx.missing_reference(
+    res =  intersphinx.missing_reference(
         app, env, node, contnode)
     if res:
         # Replace absolute links to $SAGE_DOC by relative links: this
@@ -852,11 +855,11 @@ def setup(app):
     if app.srcdir.startswith(SAGE_DOC_SRC):
         app.add_config_value('intersphinx_mapping', {}, False)
         app.add_config_value('intersphinx_cache_limit', 5, False)
+        app.connect('config-inited', set_intersphinx_mappings)
+        # app.connect('config-inited', intersphinx.normalize_intersphinx_mapping)
+        app.connect('builder-inited', intersphinx.load_mappings)
         # We do *not* fully initialize intersphinx since we call it by hand
         # in find_sage_dangling_links.
         #   app.connect('missing-reference', missing_reference)
         app.connect('missing-reference', find_sage_dangling_links)
-        import sphinx.ext.intersphinx
-        app.connect('builder-inited', set_intersphinx_mappings)
-        app.connect('builder-inited', sphinx.ext.intersphinx.load_mappings)
         app.connect('builder-inited', nitpick_patch_config)
diff --git a/sage_setup/docbuild/ext/multidocs.py b/sage_setup/docbuild/ext/multidocs.py
index 71a08cd..3a3d09a 100644
--- a/sage_setup/docbuild/ext/multidocs.py
+++ b/sage_setup/docbuild/ext/multidocs.py
@@ -47,24 +47,30 @@ def merge_environment(app, env):
     - domaindata['py']['modules'] # list of python modules
     """
     logger.info(bold('Merging environment/index files...'))
+    if not hasattr(env, "todo_all_todos"):
+        env.todo_all_todos = []
+    if not hasattr(env.domaindata["std"], "citations"):
+        env.domaindata["std"]["citations"] = dict()
     for curdoc in app.env.config.multidocs_subdoc_list:
         logger.info("    %s:"%curdoc, nonl=1)
         docenv = get_env(app, curdoc)
         if docenv is not None:
             fixpath = lambda path: os.path.join(curdoc, path)
+            todos = docenv.todo_all_todos if hasattr(docenv, "todo_all_todos") else []
+            citations = docenv.domaindata["std"].get("citations", dict())
             logger.info(" %s todos, %s index, %s citations"%(
-                    len(docenv.todo_all_todos),
+                    len(todos),
                     len(docenv.indexentries),
-                    len(docenv.domaindata["std"]["citations"])
+                    len(citations)
                     ), nonl=1)
 
             # merge titles
             for t in docenv.titles:
                 env.titles[fixpath(t)] = docenv.titles[t]
             # merge the todo links
-            for dct in docenv.todo_all_todos:
+            for dct in todos:
                 dct['docname'] = fixpath(dct['docname'])
-            env.todo_all_todos += docenv.todo_all_todos
+            env.todo_all_todos += todos
             # merge the html index links
             newindex = {}
             for ind in docenv.indexentries:
@@ -86,8 +92,7 @@ def merge_environment(app, env):
                 env.metadata[ind] = md
             # merge the citations
             newcite = {}
-            citations = docenv.domaindata["std"]["citations"]
-            for ind, (path, tag, lineno) in six.iteritems(docenv.domaindata["std"]["citations"]):
+            for ind, (path, tag, lineno) in six.iteritems(citations):
                 # TODO: Warn on conflicts
                 newcite[ind] = (fixpath(path), tag, lineno)
             env.domaindata["std"]["citations"].update(newcite)
@@ -253,7 +258,7 @@ def fetch_citation(app, env):
     with open(filename, 'rb') as f:
         cache = cPickle.load(f)
     logger.info("done (%s citations)."%len(cache))
-    cite = env.domaindata["std"]["citations"]
+    cite = env.domaindata["std"].get("citations", dict())
     for ind, (path, tag, lineno) in six.iteritems(cache):
         if ind not in cite: # don't override local citation
             cite[ind] = (os.path.join("..", path), tag, lineno)
```

And it goes some way with multiple warnings

```
[plot3d   ] /usr/lib/python3.7/site-packages/sphinx/pycode/__init__.py:186: RemovedInSphinx40Warning: ModuleAnalyzer.encoding is deprecated.
[plot3d   ]   RemovedInSphinx40Warning)
```

which is probably coming from something else (like docutils - I have to track it). But ultimately it breaks down at


```
[combinat ] /dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python3_7/build/lib/sage/combinat/permutation.py:docstring of sage.combinat.permutation.Permutation.left_action_product:1: WARNING: duplicate object description of sage.combinat.permutation.Permutation.left_action_product, other instance in sage/combinat/permutation, use :noindex: for one of them
[combinat ] /dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python3_7/build/lib/sage/combinat/permutation.py:docstring of sage.combinat.permutation.Permutation.right_action_product:1: WARNING: duplicate object description of sage.combinat.permutation.Permutation.right_action_product, other instance in sage/combinat/permutation, use :noindex: for one of them
```

which leads to the build of documentation stopping

```
Error building the documentation.
Traceback (most recent call last):
  File "sage_setup/docbuild/__main__.py", line 2, in <module>
    main()
  File "/dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python3_7/sage_setup/docbuild/__init__.py", line 1720, in main
    builder()
  File "/dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python3_7/sage_setup/docbuild/__init__.py", line 327, in _wrapper
    getattr(get_builder(document), 'inventory')(*args, **kwds)
  File "/dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python3_7/sage_setup/docbuild/__init__.py", line 552, in _wrapper
    self._build_everything_except_bibliography(lang, format, *args, **kwds)
  File "/dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python3_7/sage_setup/docbuild/__init__.py", line 538, in _build_everything_except_bibliography
    build_many(build_ref_doc, non_references)
  File "/dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python3_7/sage_setup/docbuild/__init__.py", line 280, in build_many
    _build_many(target, args, processes=NUM_THREADS)
  File "/dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python3_7/sage_setup/docbuild/utils.py", line 283, in build_many
    raise worker_exc.original_exception
OSError: /dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python3_7/build/lib/`sage/combinat/permutation.py:docstring of sage.combinat.permutation.Permutation.left_action_product:1: WARNING: duplicate object description of sage.combinat.permutation.Permutation.left_action_product, other instance in sage/combinat/permutation, use :noindex: for one of them
```

I have looked at `sage/combinat/permutation.py` but I cannot figure where I should add `:noindex:`. Some assistance at this stage would be welcome.


---

Comment by arojas created at 2020-04-14 09:41:31

The deprecation warnings come from sage itself, specifically from https://github.com/sagemath/sagetrac-mirror/blob/master/src/sage_setup/docbuild/ext/sage_autodoc.py#n539 - fixing it gives a similar amount of warnings, this time about safe_getmembers. Haven't looked into the replacement for that one yet.

Building with -k makes it go past the duplicate object error, but then one gets again the `ValueError: too many values to unpack` error when it reaches the second pass.


---

Comment by fbissey created at 2020-04-14 09:58:29

I see the `safe_getmembers` warnings as well - without fixing sage_autodoc. It floods a little less :) I thought sphinx-3.0 was supposed to help with the "too many value to unpack". I guess that was too optimistic.


---

Comment by arojas created at 2020-04-14 18:20:58

I added some debug, seems that normalize_intersphinx_mapping is never being run


---

Comment by arojas created at 2020-04-16 11:38:11

Alright, turns out that was my fault... conf.py was moved to sagelib a while ago so I was using the (unpatched) version from the installed sagemath instead of the patched one in the source code when building sagemath-doc.

Now, after sorting it out, the new errors (on the second pass) are:

```
[tutorial ]   File "/usr/lib/python3.8/urllib/parse.py", line 108, in <genexpr>
[tutorial ]     return tuple(x.decode(encoding, errors) if x else '' for x in args)
[tutorial ] AttributeError: 'tuple' object has no attribute 'decode'
```

These seem to be cause by a bad intersphinx mapping normalization... looks like normalize_intersphinx_mapping is not idempotent, and when running it on an already normalized item it will try to renormalize it and break its format.


---

Comment by arojas created at 2020-04-16 16:40:18

Getting closer: with the attached patch the double normalization issue is worked around and the compilation finishes (with -k). It also fixes the most annoying deprecation warnings. However, there are many files missing which were present when compiling with sphinx 1.

Not sure if it's related, but at the end of the first pass one gets the error:

```
[reference] Extension error:
[reference] Domain 'index' is not registered
```

so it seems that the `index` attribute also needs to be explicitely initialized now, similar to `citations` and `todo_all_todos`


**obsolete patch removed**


---

Comment by arojas created at 2020-04-16 19:50:25

Updated patch that fixes the `Domain 'index' is not registered` error and all sphinx deprecation warnings. Still, html for the reference manual subdirs is not being generated.

**obsolete patch removed**


---

Comment by fbissey created at 2020-04-16 20:51:25

Well, that's some progress I guess. I think we should move this ticket milestone to 9.2 and make it "upgrade to sphinx 3", that would be more honest because I don't think we can keep it compatible with sphinx-1.8 at the same time.


---

Comment by arojas created at 2020-04-17 18:13:44

Found the problem, some used sphinx API has been removed. With the attached version the docs compile (still with -k). Next issue: citation links are not working.


```diff
--- a/src/sage_setup/docbuild/__init__.py
+++ b/src/sage_setup/docbuild/__init__.py
@@ -817,9 +817,13 @@ class ReferenceSubBuilder(DocBuilder):
 
         env_pickle = os.path.join(self._doctrees_dir(), 'environment.pickle')
         try:
-            env = BuildEnvironment.frompickle(env_pickle, FakeApp(self.dir))
-            logger.debug("Opened Sphinx environment: %s", env_pickle)
-            return env
+            with open(env_pickle, 'rb') as f:
+                import pickle
+                env = pickle.load(f)
+                env.app = FakeApp(self.dir)
+                env.config.values = env.app.config.values
+                logger.debug("Opened Sphinx environment: %s", env_pickle)
+                return env
         except IOError as err:
             logger.debug("Failed to open Sphinx environment: %s", err)
 
--- a/src/sage/docs/conf.py
+++ b/src/sage/docs/conf.py
@@ -8,6 +8,7 @@ from docutils import nodes
 from docutils.transforms import Transform
 from sphinx.ext.doctest import blankline_re
 from sphinx import highlighting
+import sphinx.ext.intersphinx as intersphinx
 from IPython.lib.lexers import IPythonConsoleLexer, IPyLexer
 
 # If your extensions are in another directory, add it here.
@@ -169,13 +169,8 @@ todo_include_todos = True
 
 # Cross-links to other project's online documentation.
 python_version = sys.version_info.major
-intersphinx_mapping = {
-    'python': ('https://docs.python.org/',
-                os.path.join(SAGE_DOC_SRC, "common",
-                             "python{}.inv".format(python_version))),
-    'pplpy': (PPLPY_DOCS, None)}
 
-def set_intersphinx_mappings(app):
+def set_intersphinx_mappings(app, config):
     """
     Add precompiled inventory (the objects.inv)
     """
@@ -186,7 +182,11 @@ def set_intersphinx_mappings(app):
         app.config.intersphinx_mapping = {}
         return
 
-    app.config.intersphinx_mapping = intersphinx_mapping
+    app.config.intersphinx_mapping =  {
+    'python': ('https://docs.python.org/',
+                os.path.join(SAGE_DOC_SRC, "common",
+                             "python{}.inv".format(python_version))),
+    'pplpy': (PPLPY_DOCS, None)}
 
     # Add master intersphinx mapping
     dst = os.path.join(invpath, 'objects.inv')
@@ -201,6 +201,7 @@ def set_intersphinx_mappings(app):
             dst = os.path.join(invpath, directory, 'objects.inv')
             app.config.intersphinx_mapping[src] = dst
 
+    intersphinx.normalize_intersphinx_mapping(app, config)
 
 # By default document are not master.
 multidocs_is_master = True
@@ -669,7 +672,7 @@ def call_intersphinx(app, env, node, contnode):
     """
     debug_inf(app, "???? Trying intersphinx for %s" % node['reftarget'])
     builder = app.builder
-    res =  sphinx.ext.intersphinx.missing_reference(
+    res =  intersphinx.missing_reference(
         app, env, node, contnode)
     if res:
         # Replace absolute links to $SAGE_DOC by relative links: this
@@ -852,11 +855,10 @@ def setup(app):
     if app.srcdir.startswith(SAGE_DOC_SRC):
         app.add_config_value('intersphinx_mapping', {}, False)
         app.add_config_value('intersphinx_cache_limit', 5, False)
+        app.connect('config-inited', set_intersphinx_mappings)
+        app.connect('builder-inited', intersphinx.load_mappings)
         # We do *not* fully initialize intersphinx since we call it by hand
         # in find_sage_dangling_links.
         #   app.connect('missing-reference', missing_reference)
         app.connect('missing-reference', find_sage_dangling_links)
-        import sphinx.ext.intersphinx
-        app.connect('builder-inited', set_intersphinx_mappings)
-        app.connect('builder-inited', sphinx.ext.intersphinx.load_mappings)
         app.connect('builder-inited', nitpick_patch_config)
--- a/src/sage_setup/docbuild/ext/multidocs.py
+++ b/src/sage_setup/docbuild/ext/multidocs.py
@@ -47,32 +47,39 @@ def merge_environment(app, env):
     - domaindata['py']['modules'] # list of python modules
     """
     logger.info(bold('Merging environment/index files...'))
+    if not hasattr(env, "todo_all_todos"):
+        env.todo_all_todos = []
+    if not env.domaindata["std"].get("citations"):
+        env.domaindata["std"]["citations"] = dict()
     for curdoc in app.env.config.multidocs_subdoc_list:
         logger.info("    %s:"%curdoc, nonl=1)
         docenv = get_env(app, curdoc)
         if docenv is not None:
             fixpath = lambda path: os.path.join(curdoc, path)
+            todos = docenv.todo_all_todos if hasattr(docenv, "todo_all_todos") else []
+            citations = docenv.domaindata["std"].get("citations", dict())
+            indexentries = docenv.domaindata["index"].get("entries", dict())
             logger.info(" %s todos, %s index, %s citations"%(
-                    len(docenv.todo_all_todos),
-                    len(docenv.indexentries),
-                    len(docenv.domaindata["std"]["citations"])
+                    len(todos),
+                    len(indexentries),
+                    len(citations)
                     ), nonl=1)
 
             # merge titles
             for t in docenv.titles:
                 env.titles[fixpath(t)] = docenv.titles[t]
             # merge the todo links
-            for dct in docenv.todo_all_todos:
+            for dct in todos:
                 dct['docname'] = fixpath(dct['docname'])
-            env.todo_all_todos += docenv.todo_all_todos
+            env.todo_all_todos += todos
             # merge the html index links
             newindex = {}
-            for ind in docenv.indexentries:
+            for ind in indexentries:
                 if ind.startswith('sage/'):
-                    newindex[fixpath(ind)] = docenv.indexentries[ind]
+                    newindex[fixpath(ind)] = indexentries[ind]
                 else:
-                    newindex[ind] = docenv.indexentries[ind]
-            env.indexentries.update(newindex)
+                    newindex[ind] = indexentries[ind]
+            env.domaindata['index']['entries'].update(newindex)
             # merge the all_docs links, needed by the js index
             newalldoc = {}
             for ind in docenv.all_docs:
@@ -86,24 +93,23 @@ def merge_environment(app, env):
                 env.metadata[ind] = md
             # merge the citations
             newcite = {}
-            citations = docenv.domaindata["std"]["citations"]
-            for ind, (path, tag, lineno) in six.iteritems(docenv.domaindata["std"]["citations"]):
+            for ind, (path, tag, lineno) in six.iteritems(citations):
                 # TODO: Warn on conflicts
                 newcite[ind] = (fixpath(path), tag, lineno)
-            env.domaindata["std"]["citations"].update(newcite)
+            env.domaindata['std']['citations'].update(newcite)
             # merge the py:module indexes
             newmodules = {}
-            for ind,(modpath,v1,v2,v3) in (
+            for ind,(modpath,v1,v2,v3,v4) in (
                 six.iteritems(docenv.domaindata['py']['modules'])):
-                newmodules[ind] = (fixpath(modpath),v1,v2,v3)
+                newmodules[ind] = (fixpath(modpath),v1,v2,v3,v4)
             env.domaindata['py']['modules'].update(newmodules)
             logger.info(", %s modules"%(len(newmodules)))
     logger.info('... done (%s todos, %s index, %s citations, %s modules)'%(
             len(env.todo_all_todos),
-            len(env.indexentries),
-            len(env.domaindata["std"]["citations"]),
+            len(env.domaindata['index']['entries']),
+            len(env.domaindata['std']['citations']),
             len(env.domaindata['py']['modules'])))
-    write_citations(app, env.domaindata["std"]["citations"])
+    write_citations(app, env.domaindata['std']['citations'])
 
 
 def get_env(app, curdoc):
@@ -253,7 +259,7 @@ def fetch_citation(app, env):
     with open(filename, 'rb') as f:
         cache = cPickle.load(f)
     logger.info("done (%s citations)."%len(cache))
-    cite = env.domaindata["std"]["citations"]
+    cite = env.domaindata["std"].get("citations", dict())
     for ind, (path, tag, lineno) in six.iteritems(cache):
         if ind not in cite: # don't override local citation
             cite[ind] = (os.path.join("..", path), tag, lineno)
--- a/src/sage_setup/docbuild/ext/sage_autodoc.py
+++ b/src/sage_setup/docbuild/ext/sage_autodoc.py
@@ -35,14 +35,15 @@ import sys
 from docutils.statemachine import ViewList
 
 import sphinx
-from sphinx.ext.autodoc.importer import mock, import_object, get_object_members
+from sphinx.ext.autodoc import mock
+from sphinx.ext.autodoc.importer import import_object, get_object_members, get_module_members
 from sphinx.locale import _, __
 from sphinx.pycode import ModuleAnalyzer
 from sphinx.errors import PycodeError
 from sphinx.util import logging
 from sphinx.util import rpartition, force_decode
 from sphinx.util.docstrings import prepare_docstring
-from sphinx.util.inspect import isdescriptor, safe_getmembers, \
+from sphinx.util.inspect import isdescriptor, \
     safe_getattr, object_description, is_builtin_class_method, \
     isenumattribute, isclassmethod, isstaticmethod, getdoc
 
@@ -536,7 +537,7 @@ class Documenter(object):
 
         # add content from docstrings
         if not no_docstring:
-            encoding = self.analyzer and self.analyzer.encoding
+            encoding = self.analyzer and self.analyzer._encoding
             docstrings = self.get_doc(encoding)
             if not docstrings:
                 # append at least a dummy docstring, so that the event
@@ -882,7 +883,7 @@ class ModuleDocumenter(Documenter):
             if not hasattr(self.object, '__all__'):
                 # for implicit module members, check __module__ to avoid
                 # documenting imported objects
-                return True, safe_getmembers(self.object)
+                return True, get_module_members(self.object)
             else:
                 memberlist = self.object.__all__
                 # Sometimes __all__ is broken...
@@ -893,7 +894,7 @@ class ModuleDocumenter(Documenter):
                         '(in module %s) -- ignoring __all__' %
                         (memberlist, self.fullname))
                     # fall back to all members
-                    return True, safe_getmembers(self.object)
+                    return True, get_module_members(self.object)
         else:
             memberlist = self.options.members or []
         ret = []
```



---

Comment by arojas created at 2020-04-17 18:14:45

Replying to [comment:30 fbissey]:
> Well, that's some progress I guess. I think we should move this ticket milestone to 9.2 and make it "upgrade to sphinx 3", that would be more honest because I don't think we can keep it compatible with sphinx-1.8 at the same time.

That seems totally reasonable to me - it's too late for 9.1, and I hope nobody will object to move on to py3-only for 9.2


---

Comment by arojas created at 2020-04-19 10:24:46

I've pushed the current status to the branch. This now builds fine with -k, including references and citations.

It remains to figure out the `WARNING: duplicate object description` so it builds without -k (or decide that it's not important and whitelist the warning)
----
New commits:


---

Comment by @mwageringel created at 2020-04-19 11:00:35

Replying to [comment:35 arojas]:
> It remains to figure out the `WARNING: duplicate object description` so it builds without -k (or decide that it's not important and whitelist the warning)

The methods `left_action_product` and `right_action_product` actually do appear twice in [the documentation](https://doc.sagemath.org/html/en/reference/combinat/sage/combinat/permutation.html), which is caused by this block:

```
    .. automethod:: Permutation.left_action_product
    .. automethod:: Permutation.right_action_product
```

In the past, this block was referencing private functions `_left_to_right_multiply_on_right`/`_left_to_right_multiply_on_left`, so the `automethod` directive was used to make those underscore functions appear in the documentation. Since these functions are not private anymore and appear in the documentation by default, this block is not needed anymore and removing it should solve the problem I hope.


---

Comment by arojas created at 2020-04-19 12:03:47

Removing those lines does indeed fix this warning. But then compilation stops a while later with another warning:

```
OSError: /build/sagemath-doc/src/sage-9.0/src/doc/en/thematic_tutorials/structures_in_coding_theory.rst:722: WARNING: Could not lex literal_block as "python". Highlighting skipped.
```



---

Comment by git created at 2020-04-19 12:06:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by thansen created at 2020-04-19 13:49:16

Thanks for the patch. I tried it with sphinx 2.4.3 which is what we have in Debian now.
It failed with the following error:


```
[dochtml] [reference] Merging environment/index files...
[dochtml] [reference] Exception occurred:
[dochtml] [reference]   File "/home/thansen/src/sage/sagemath/sagemath/sage/src/sage_setup/docbuild/ext/multidocs.py", line 105, in merge_environment
[dochtml] [reference]     for ind,(modpath,v1,v2,v3,v4) in (
[dochtml] [reference] ValueError: not enough values to unpack (expected 5, got 4)
```


Do I have to change anything for sphinx 2.4? Which command are you running with -k?


---

Comment by arojas created at 2020-04-19 14:19:29

Replying to [comment:39 thansen]:
> Thanks for the patch. I tried it with sphinx 2.4.3 which is what we have in Debian now.
> It failed with the following error:
> 
> {{{
> [dochtml] [reference] Merging environment/index files...
> [dochtml] [reference] Exception occurred:
> [dochtml] [reference]   File "/home/thansen/src/sage/sagemath/sagemath/sage/src/sage_setup/docbuild/ext/multidocs.py", line 105, in merge_environment
> [dochtml] [reference]     for ind,(modpath,v1,v2,v3,v4) in (
> [dochtml] [reference] ValueError: not enough values to unpack (expected 5, got 4)
> }}}
> 
> Do I have to change anything for sphinx 2.4? Which command are you running with -k?


Yes, the relevant sphinx change [1] is only in 3.x. For 2.4, remove the two line changes adding the `v4` parameter from the patch.

The command I'm using to build the docs is `python sage_setup/docbuild --no-pdf-links --mathjax all html -k`

[1] https://github.com/sphinx-doc/sphinx/commit/5ff3b9dc4d07b5c324680e17b2aeaa298e619a9a


---

Comment by git created at 2020-04-19 21:28:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by arojas created at 2020-04-20 09:52:29

I see the `WARNING: Could not lex literal_block as "python"` issue already came up in https://groups.google.com/forum/#!msg/sage-release/xcGXMuHuEOw/eqISWOiDAAAJ but, in that case, it affected python2 only.


---

Comment by jhpalmieri created at 2020-04-20 21:48:01

With Sphinx 3.0.2 I see

```
Building reference manual, first pass.

[reference] Exception occurred:
[reference]   File "/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.1.rc0/local/lib/python3.7/site-packages/matplotlib/sphinxext/plot_directive.py", line 268, in setup
[reference]     app.add_directive('plot', plot_directive, True, (0, 2, False), **options)
[reference] TypeError: add_directive() got an unexpected keyword argument 'alt'
```

This is coming from matplotlib 2.2.4. Do I need to upgrade matplotlib?

By the way, to install the new version of Sphinx in Sage, we need to add some other packages: `sphinxcontrib-applehelp` and about 5 others.


---

Comment by jhpalmieri created at 2020-04-20 21:59:57

To answer my own question: upgrading matplotlib helps.


---

Comment by jhpalmieri created at 2020-04-20 23:00:59

I'm now seeing another issue:

```
[plotting ] /Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.1.rc0/local/lib/python3.7/site-packages/sage/plot/contour_plot.py:docstring of sage.plot.contour_plot.contour_plot:438: WARNING: Exception occurred in plotting contour_plot-24
[plotting ]  from /Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.1.rc0/src/doc/en/reference/plotting/sage/plot/contour_plot.rst:
[plotting ] Traceback (most recent call last):
[plotting ]   File "/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.1.rc0/local/lib/python3.7/site-packages/matplotlib/sphinxext/plot_directive.py", line 484, in run_code
[plotting ]     exec(code, ns)
[plotting ]   File "<string>", line 4, in <module>
[plotting ]   File "<string>", line 28, in sphinx_plot
[plotting ]   File "/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.1.rc0/local/lib/python3.7/site-packages/sage/plot/graphics.py", line 2778, in matplotlib
[plotting ]     g._render_on_subplot(subplot)
[plotting ]   File "/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.1.rc0/local/lib/python3.7/site-packages/sage/plot/contour_plot.py", line 222, in _render_on_subplot
[plotting ]     cb = colorbar.Colorbar(cax, CSF, **kwds)
[plotting ]   File "/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.1.rc0/local/lib/python3.7/site-packages/matplotlib/colorbar.py", line 1220, in __init__
[plotting ]     ColorbarBase.__init__(self, ax, **kw)
[plotting ]   File "/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.1.rc0/local/lib/python3.7/site-packages/matplotlib/colorbar.py", line 459, in __init__
[plotting ]     ['uniform', 'proportional'], spacing=spacing)
[plotting ]   File "/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.1.rc0/local/lib/python3.7/site-packages/matplotlib/cbook/__init__.py", line 2145, in _check_in_list
[plotting ]     .format(v, k, ', '.join(map(repr, values))))
[plotting ] ValueError: None is not a valid value for spacing; supported values are 'uniform', 'proportional'
```



---

Comment by fbissey created at 2020-04-20 23:20:56

Which version of matplotlib did you go for? I think arch has stuff for 3.2+ but 3.1 should be OK.


---

Comment by mkoeppe created at 2020-04-21 00:40:28

#29444	upgraded matplotlib to 2.2.5, which is the last release supporting py2. Am I right that this ticket is for 9.2, in which we drop python 3 support?


---

Comment by jhpalmieri created at 2020-04-21 00:56:38

Replying to [comment:46 fbissey]:
> Which version of matplotlib did you go for? I think arch has stuff for 3.2+ but 3.1 should be OK.
I upgraded to 3.2.1 (within Sage).


---

Comment by jhpalmieri created at 2020-04-21 00:56:48

Replying to [comment:47 mkoeppe]:
> #29444	upgraded matplotlib to 2.2.5, which is the last release supporting py2. Am I right that this ticket is for 9.2, in which we drop python 3 support?

Yes, I think it has to be.


---

Comment by arojas created at 2020-04-21 06:54:37

Replying to [comment:45 jhpalmieri]:
> I'm now seeing another issue:
> {{{
> [plotting ] /Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.1.rc0/local/lib/python3.7/site-packages/sage/plot/contour_plot.py:docstring of sage.plot.contour_plot.contour_plot:438: WARNING: Exception occurred in plotting contour_plot-24
> [plotting ]  from /Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.1.rc0/src/doc/en/reference/plotting/sage/plot/contour_plot.rst:
> [plotting ] Traceback (most recent call last):
> [plotting ]   File "/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.1.rc0/local/lib/python3.7/site-packages/matplotlib/sphinxext/plot_directive.py", line 484, in run_code
> [plotting ]     exec(code, ns)
> [plotting ]   File "<string>", line 4, in <module>
> [plotting ]   File "<string>", line 28, in sphinx_plot
> [plotting ]   File "/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.1.rc0/local/lib/python3.7/site-packages/sage/plot/graphics.py", line 2778, in matplotlib
> [plotting ]     g._render_on_subplot(subplot)
> [plotting ]   File "/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.1.rc0/local/lib/python3.7/site-packages/sage/plot/contour_plot.py", line 222, in _render_on_subplot
> [plotting ]     cb = colorbar.Colorbar(cax, CSF, **kwds)
> [plotting ]   File "/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.1.rc0/local/lib/python3.7/site-packages/matplotlib/colorbar.py", line 1220, in __init__
> [plotting ]     ColorbarBase.__init__(self, ax, **kw)
> [plotting ]   File "/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.1.rc0/local/lib/python3.7/site-packages/matplotlib/colorbar.py", line 459, in __init__
> [plotting ]     ['uniform', 'proportional'], spacing=spacing)
> [plotting ]   File "/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.1.rc0/local/lib/python3.7/site-packages/matplotlib/cbook/__init__.py", line 2145, in _check_in_list
> [plotting ]     .format(v, k, ', '.join(map(repr, values))))
> [plotting ] ValueError: None is not a valid value for spacing; supported values are 'uniform', 'proportional'
> }}}

You need another patch for matplotlib 3.2: https://git.archlinux.org/svntogit/community.git/tree/trunk/sagemath-matplotlib-3.2.patch?h=packages/sagemath


---

Comment by arojas created at 2020-04-21 07:00:02

The remaining warning comes from the lines

```
.. CODE-BLOCK:: python

    :class:`sage.coding.repetition_code.BinaryRepetitionCode <sage.coding.repetition_code.BinaryRepetitionCode>`
    #the line above creates a link to the class in the html documentation of coding theory library
    from sage.coding.repetition_code import BinaryRepetitionCode
```

in `structures_in_coding_theory.rst`. This is because the backtick is no longer valid syntax in python3.

I don't understand what this code block is meant to do. In the python2 version, it displayed a code block with those three lines, which doesn't make much sense to me (the first line is not python code). Perhaps the link to the class is meant to be outside the code block? (which still doesn't make sense to me in the overall context of the page)


---

Comment by git created at 2020-04-21 10:14:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by fbissey created at 2020-04-21 10:59:39

Nice little commit. So far building without `-k` and I passed the point where it would have bailed out because of missing citations in `[tensor_fr]`. But `citation` and `citations`, we have to be careful not to get too confused.


---

Comment by fbissey created at 2020-04-21 11:04:41

But bail out at `structures_in_coding_theory.rst` as should have been expected. Until that one is sorted we still need the `-k`.


---

Comment by arojas created at 2020-04-21 11:07:41

For now I'm removing the first two lines of the affected code block downstream until someone clears that up. Doesn't seem much of a loss. After that it builds fine without `-k`


---

Comment by arojas created at 2020-04-21 11:33:50

FTR, this was marked as a python code block in #27549


---

Comment by jhpalmieri created at 2020-04-21 16:15:43

I think it's fine to delete the first two lines of that code block.


---

Comment by jhpalmieri created at 2020-04-21 16:40:09

Replying to [comment:51 arojas]:
> You need another patch for matplotlib 3.2: https://git.archlinux.org/svntogit/community.git/tree/trunk/sagemath-matplotlib-3.2.patch?h=packages/sagemath

Thanks, that works.

Now I'm seeing a ton of messages like

```
WARNING: citation not found: BM2012
```

which causes the build to fail unless I use `-k`.


---

Comment by arojas created at 2020-04-21 16:41:19

Replying to [comment:59 jhpalmieri]:
> Replying to [comment:51 arojas]:
> > You need another patch for matplotlib 3.2: https://git.archlinux.org/svntogit/community.git/tree/trunk/sagemath-matplotlib-3.2.patch?h=packages/sagemath
> 
> Thanks, that works.
> 
> Now I'm seeing a ton of messages like
> {{{
> WARNING: citation not found: BM2012
> }}}
> which causes the build to fail unless I use `-k`.

Did you pull the latest commit?


---

Comment by jhpalmieri created at 2020-04-21 16:56:41

Replying to [comment:60 arojas]:
> Replying to [comment:59 jhpalmieri]:
> > Replying to [comment:51 arojas]:
> > > You need another patch for matplotlib 3.2: https://git.archlinux.org/svntogit/community.git/tree/trunk/sagemath-matplotlib-3.2.patch?h=packages/sagemath
> > 
> > Thanks, that works.
> > 
> > Now I'm seeing a ton of messages like
> > {{{
> > WARNING: citation not found: BM2012
> > }}}
> > which causes the build to fail unless I use `-k`.
> 
> Did you pull the latest commit?

I'm sorry, no. I meant to and then started having computer problems, which distracted me. With the latest commit, everything builds!


---

Comment by git created at 2020-04-21 17:01:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by arojas created at 2020-04-21 17:06:54

It remains to sort out the Sage packaging side: add the missing sphinx dependencies, open a ticket to upgrade matplotlib and make it a dependency of this one. I'll leave that to someone else, I've had enough of this ticket for a while.


---

Comment by fbissey created at 2020-04-21 19:55:29

Replying to [comment:63 arojas]:
> It remains to sort out the Sage packaging side: add the missing sphinx dependencies, open a ticket to upgrade matplotlib and make it a dependency of this one. I'll leave that to someone else, I've had enough of this ticket for a while.

That's fine, you did a good job here and we in distros are now ready to tackle 9.1 in python3 only. Thank you very much for your work here.

I should be able to find time to shepherd the rest in early 9.2.


---

Comment by fbissey created at 2020-04-21 21:58:31

`@`jhpalmieri do you have something ready for `matplotlib` or should I go ahead with a new ticket and branch?


---

Comment by fbissey created at 2020-04-21 22:12:45

I am going to add the following `sphinxcontrib` packages following the dependencies of the Gentoo ebuild
* `sphinxcontrib-applehelp`
* `sphinxcontrib-devhelp`
* `sphinxcontrib-jsmath`
* `sphinxcontrib-htmlhelp`
* `sphinxcontrib-serializinghtml`
* `sphinxcontrib-qthelp`

which should cover `@`jhpalmieri's remark about needing 6 new `sphinxcontrib` packages. Did anyone identify something else missing from the current list of sage packages?


---

Comment by jhpalmieri created at 2020-04-21 22:36:18

Those are the ones. With those, Sphinx 3.0.2 builds for me with Sage 9.1.rc0 (py3) on OS X.


---

Comment by jhpalmieri created at 2020-04-21 22:36:39

Replying to [comment:65 fbissey]:
> `@`jhpalmieri do you have something ready for `matplotlib` or should I go ahead with a new ticket and branch?

I can open up a ticket. I have a version which builds, but I haven't run doctests yet.

Edit: #29547


---

Comment by fbissey created at 2020-04-21 22:41:08

Darn, we are still on 3.0.1. I'll bump to 3.0.2 while I am at it. Do open the ticket for the new matplotlib. We do know that some doctests needs fixing from 3.1 onwards. I'll fill the details on #29547 if it is not there already.


---

Comment by fbissey created at 2020-04-21 23:18:03

Branch with sphinx 3.0.2 and all new packages.
----
New commits:


---

Comment by jhpalmieri created at 2020-04-22 02:45:10

Ready for review?


---

Comment by fbissey created at 2020-04-22 02:52:34

I'd say. I haven't tested everything in vanilla sage but this builds on sage-on-gentoo and presumably sage-on-arch [with sphinx 3.0.1 in gentoo so we could find an issue]. My packaging needs to be checked.


---

Comment by fbissey created at 2020-04-22 03:16:13

Changing status from needs_work to needs_review.


---

Comment by jhpalmieri created at 2020-04-22 04:38:03

It builds for me on OS X (with some homebrew packages).


---

Comment by jhpalmieri created at 2020-04-22 05:27:33

I get two doctest failures (this is combined with #29547):

```
sage -t --long --warn-long 80.3 src/sage/misc/sagedoc.py
**********************************************************************
File "src/sage/misc/sagedoc.py", line 23, in sage.misc.sagedoc
Failed example:
    with open(docfilename) as fobj:  # optional - dochtml
        for line in fobj:
            if "#sage.symbolic.expression.Expression.numerical_approx" in line:
                print(line)
Expected:
    <code class="descname">numerical_approx</code><span class="sig-paren">(</span><em>prec=None</em>, <em>digits=None</em>, <em>algorithm=None</em><span class="sig-paren">)</span>...
Got:
    <code class="sig-name descname">numerical_approx</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">prec</span><span class="o">=</span><span class="default_value">None</span></em>, <em class="sig-param"><span class="n">digits</span><span class="o">=</span><span class="default_value">None</span></em>, <em class="sig-param"><span class="n">algorithm</span><span class="o">=</span><span class="default_value">None</span></em><span class="sig-paren">)</span><a class="headerlink" href="#sage.symbolic.expression.Expression.numerical_approx" title="Permalink to this definition">¶</a></dt>
    <BLANKLINE>
```

and

```
sage -t --long --warn-long 80.3 src/sage/docs/conf.py
**********************************************************************
File "src/sage/docs/conf.py", line 666, in sage.docs.conf.call_intersphinx
Failed example:
    for line in open(thematic_index).readlines():  # optional - dochtml
        if "padics" in line:
            _ = sys.stdout.write(line)
Expected:
    <li><a class="reference external" href="../reference/padics/sage/rings/padics/tutorial.html#sage-rings-padics-tutorial" title="(in Sage... Reference Manual: p-Adics v...)"><span>Introduction to the p-adics</span></a></li>
Got:
    <li><p><a class="reference external" href="../reference/padics/sage/rings/padics/tutorial.html#sage-rings-padics-tutorial" title="(in Sage 9.1.rc0 Reference Manual: p-Adics v9.1.rc0)"><span>Introduction to the p-adics</span></a></p></li>
```

They don't look hard to fix.


---

Comment by fbissey created at 2020-04-22 05:35:10

Unexpected. I didn't see that in my doctesting in Gentoo, may be one of the package sphinx/sphinxcontrib bumps caused this. But as you say, it is trivial to fix.


---

Comment by jhpalmieri created at 2020-04-22 17:19:33

I'm trying again, building from scratch, just to make sure.


---

Comment by mkoeppe created at 2020-04-23 03:10:50

Needs rebasing on top of 9.1.rc1.

Also please add an `upstream_url` field (see https://wiki.sagemath.org/ReleaseTours/sage-9.1)


---

Comment by mkoeppe created at 2020-04-23 03:12:00

Changing status from needs_review to needs_work.


---

Comment by fbissey created at 2020-04-23 03:17:16

That's a cool new feature considering all the instances of "please the package is not on the mirror" on sage-release and sage-devel.


---

Comment by git created at 2020-04-23 03:37:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by fbissey created at 2020-04-23 03:38:05

Changing status from needs_work to needs_review.


---

Comment by jhpalmieri created at 2020-04-23 05:26:49

I see the same doctest failures on two different machines, so I think they're real.


---

Comment by fbissey created at 2020-04-23 05:29:10

I'll fix them then. Having trouble building sage-on-gentoo right now. The head from Volker (past 9.1.rc1) doesn't build for me. I will have to test on the plain develop branch which is unusual for me these days.


---

Comment by git created at 2020-04-23 10:27:32

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by fbissey created at 2020-04-23 10:28:16

All fixed now.


---

Comment by arojas created at 2020-04-23 16:54:03

Only one of them is fixed AFAICS


---

Comment by mkoeppe created at 2020-04-23 17:40:24

For `upstream_url`, it's better to use pypi.io URLs because they will be stable for the next updates
(see matplotlib, for example)


---

Comment by mkoeppe created at 2020-04-23 17:42:19

Replying to [comment:81 fbissey]:
> That's a cool new feature considering all the instances of "please the package is not on the mirror" on sage-release and sage-devel.
Glad you like it. Note that it's not enabled by default, so that developers still complain when the release manager forgets to upload it to the mirror.


---

Comment by fbissey created at 2020-04-23 19:57:25

Replying to [comment:88 arojas]:
> Only one of them is fixed AFAICS

Weird only one of my changes made it up. I must have fumbled a git command last night.


---

Comment by git created at 2020-04-23 20:01:24

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by fbissey created at 2020-04-23 20:07:29

Replying to [comment:89 mkoeppe]:
> For `upstream_url`, it's better to use pypi.io URLs because they will be stable for the next updates
> (see matplotlib, for example)

OK, is this some sort of secret API or something? Because it is not visible (anymore) from the pypi website. I do vaguely recall it being done that way in the past. Will it go away completely sometime in the future?


---

Comment by fbissey created at 2020-04-23 20:08:11

Replying to [comment:91 fbissey]:
> Replying to [comment:88 arojas]:
> > Only one of them is fixed AFAICS
> 
> Weird only one of my changes made it up. I must have fumbled a git command last night.

Fixed now.


---

Comment by mkoeppe created at 2020-04-23 21:16:14

Replying to [comment:93 fbissey]:
> Replying to [comment:89 mkoeppe]:
> > For `upstream_url`, it's better to use pypi.io URLs because they will be stable for the next updates
> > (see matplotlib, for example)
> 
> OK, is this some sort of secret API or something? Because it is not visible (anymore) from the pypi website. I do vaguely recall it being done that way in the past. Will it go away completely sometime in the future?
`@`isuruf showed me this trick, I don't know where this is documented. It's also mentioned here: https://stackoverflow.com/questions/47781035/does-pypi-have-simple-urls-for-package-downloads


---

Comment by git created at 2020-04-23 21:25:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by fbissey created at 2020-04-23 21:26:32

Replying to [comment:95 mkoeppe]:
> Replying to [comment:93 fbissey]:
> > Replying to [comment:89 mkoeppe]:
> > > For `upstream_url`, it's better to use pypi.io URLs because they will be stable for the next updates
> > > (see matplotlib, for example)
> > 
> > OK, is this some sort of secret API or something? Because it is not visible (anymore) from the pypi website. I do vaguely recall it being done that way in the past. Will it go away completely sometime in the future?
> `@`isuruf showed me this trick, I don't know where this is documented. It's also mentioned here: https://stackoverflow.com/questions/47781035/does-pypi-have-simple-urls-for-package-downloads

OK, I have gone ahead and made the change. I think we are all done here.


---

Comment by mkoeppe created at 2020-04-23 21:30:35

Best to replace `pip` in `dependencies` by `$(PYTHON_TOOLCHAIN)`, see #26018


---

Comment by fbissey created at 2020-04-23 21:34:34

Oh, right. I had seen that. Doing after my (ongoing) morning meeting.


---

Comment by git created at 2020-04-23 21:40:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by fbissey created at 2020-04-23 21:40:57

Was bored. Done. Any other things that should be migrated to new toys?


---

Comment by mkoeppe created at 2020-04-23 22:44:33

Replying to [comment:101 fbissey]:
> Any other things that should be migrated to new toys?

Migrate, I don't know, but you could test this branch with the new CI system by pushing the branch to a github repo.
For extra fun, use a pull request against the branch of #29530.


---

Comment by fbissey created at 2020-04-23 22:46:51

Replying to [comment:102 mkoeppe]:
> Replying to [comment:101 fbissey]:
> > Any other things that should be migrated to new toys?
> 
> Migrate, I don't know, but you could test this branch with the new CI system by pushing the branch to a github repo.
> For extra fun, use a pull request against the branch of #29530.

I really should give that a try. Not sure about #29530 though.


---

Comment by fbissey created at 2020-04-24 06:00:48

Anyone tried to build the pdf doc? I got difficulties with it in sage-on-gentoo. Volker usually doesn't think it is critical though, more a nice to have.


---

Comment by fbissey created at 2020-04-24 07:53:02

That's what I get at the end of a serial build, it is a bit scary

```
[1528]

LaTeX Warning: Hyper reference `sage/combinat/tableau:sage.combinat.tableau.Row
StandardTableaux' on page 1529 undefined on input line 132175.

[1529]
! TeX capacity exceeded, sorry [input stack size=5000].
\font@name ->
             \TS1/ptm/m/n/10 
l.132260 ...ikipedia article Zolotarev’s\_lemma}
                                                  ^^M
If you really absolutely need more capacity,
you can ask a wizard to enlarge me.

 
Here is how much of TeX's memory you used:
 21911 strings out of 481640
 403969 string characters out of 5928785
 1146413 words of memory out of 5000000
 31270 multiletter control sequences out of 15000+600000
 610234 words of font info for 159 fonts, out of 8000000 for 9000
 817 hyphenation exceptions out of 8191
 5000i,29n,9989p,5239b,810s stack positions out of 5000i,500n,10000p,200000b,80000s
!  ==> Fatal error occurred, no output PDF file produced!
```



---

Comment by jhpalmieri created at 2020-04-24 19:00:30

I explored some of this "by hand": I did `./sage --docbuild all latex` and then ran `pdflatex` on a bunch of the LaTeX files. I've found three errors like this, and they all arise from this sort of line:

```
See \sphinxhref{https://en.wikipedia.org/wiki/Dilworth\textquotesingle{}s\_theorem}{Wikipedia article Dilworth’s\_theorem}.
```

Removing `\textquotesingle{}` allows the file to compile.

Can we rewrite our `:wikipedia:` markup converter to fix this? Or is it an issue with a change in Sphinx?


---

Comment by jhpalmieri created at 2020-04-24 19:10:47

The file `sphinx/util/texescape.py` seems to contain the change causing the issue, so the question is how we handle this within the Sage library. 

(In Sphinx, commenting out the line

```
("'", r'\textquotesingle{}'),  # else ' renders curly, and '' is a ligature
```

in `sphinx/util/texescape.py` fixes it, but we want to avoid patching Sphinx. I'm guessing that our introduction of the `:wikipedia:` markup is not done the "right way".)


---

Comment by @mwageringel created at 2020-04-24 19:37:14

You could try to escape single quotes in external links by `%27` in `process_extlinks` in `sagedoc.py`, e.g. https://en.wikipedia.org/wiki/Dilworth%27s_theorem.

Edit: Or use `urllib.parse.quote` (actually, this might escape too much).


---

Comment by fbissey created at 2020-04-24 20:34:46

I am running a sage-on-gentoo github issue in parallel at https://github.com/cschwan/sage-on-gentoo/issues/582 I have more details on some of my failures. Both you in here and Steven Trogdon on github have been busy while I was snoozing. 

Have to assemble the info from both threads sometimes today.


---

Comment by fbissey created at 2020-04-24 22:39:45

Indication seem to be that using `%27` after `:wikipedia:` is effective, but there are quite a few place that replacement can be made. I would aim for consistency

```
src/sage/categories/semigroups.py:                - :wikipedia:`Green's_relations`
src/sage/categories/semigroups.py:                - :wikipedia:`Green's_relations`
src/sage/categories/semigroups.py:                - :wikipedia:`Green's_relations`
src/sage/categories/semigroups.py:                - :wikipedia:`Green's_relations`
src/sage/combinat/partition.py:        - :wikipedia:`Zolotarev's_lemma`
src/sage/combinat/posets/posets.py:        :wikipedia:`Dilworth's_theorem` for more information. The width is
src/sage/combinat/posets/posets.py:        See :wikipedia:`Dilworth's_theorem`.
src/sage/combinat/root_system/plot.py::wikipedia:`Wikipedia's E8 3D picture <File:E8_3D.png>`::
src/sage/functions/jacobi.py:- :wikipedia:`Jacobi's_elliptic_functions`
src/sage/geometry/riemannian_manifolds/surface3d_generators.py:        For more information, see :wikipedia:`Dini's_surface`.
src/sage/graphs/generators/smallgraphs.py:    :wikipedia:`Tietze's_graph`.
src/sage/graphs/path_enumeration.pyx:    See [Yen1970]_ and the :wikipedia:`Yen's_algorithm` for more details on the
src/sage/graphs/base/static_sparse_graph.pyx:    :wikipedia:`Tarjan's_strongly_connected_components_algorithm`.
src/sage/graphs/bipartite_graph.py:            algorithm (:wikipedia:`Kőnig's_theorem_(graph_theory)`)
src/sage/graphs/spanning_tree.pyx:        - :wikipedia:`Kruskal's_algorithm`
src/sage/graphs/spanning_tree.pyx:        - :wikipedia:`Kruskal's_algorithm`
src/sage/matroids/linear_matroid.pyx:        See also :wikipedia:`Kirchhoff's_theorem`.
```

Plus

```
src/sage/plot/plot3d/parametric_plot3d.py:    Boy's surface (:wikipedia:`Boy%27s_surface` and https://mathcurve.com/surfaces/boy/boy.shtml)::
```

which I just changed.


---

Comment by strogdon created at 2020-04-24 22:55:01


```
sage: from sage.misc.sagedoc import process_extlinks
sage: process_extlinks(":wikipedia:`Boy's`")
"https://en.wikipedia.org/wiki/Boy's"
```

So, can `process_extlinks` be modified to replace `'` with `%27`? Or is `process_extlinks` the wrong place?


---

Comment by jhpalmieri created at 2020-04-24 23:03:22

`process_extlinks` won't help: as far as I can tell, the `extlinks` dictionary is passes as is to Sphinx for processing. (`process_extlinks` is for printing docstrings for introspection at the command line.)


---

Comment by fbissey created at 2020-04-24 23:05:10

I am currently replacing all those pesky `'` that I have quoted earlier. I will let you know how that goes.


---

Comment by jhpalmieri created at 2020-04-24 23:07:26

Replying to [comment:114 fbissey]:
> I am currently replacing all those pesky `'` that I have quoted earlier. I will let you know how that goes.

Independently I was doing the same thing. Here is a branch. It works for me; please test it.

(The html and pdf are uglier, since the links now include "%27" instead of an apostrophe, but I think we have to settle for that.)
----
New commits:


---

Comment by fbissey created at 2020-04-24 23:09:27

I had two left to go :) oh well, you beat me to it.


---

Comment by jhpalmieri created at 2020-04-24 23:40:32

There was also a missing space in `matrix_gps/finitely_generated.py` that caused problems.


---

Comment by fbissey created at 2020-04-25 00:09:22

Works for me. I guess modulo a rebase when 9.1 is out, we are ready.


---

Comment by thansen created at 2020-04-25 06:56:41

Did you try searching in the html documentation? For me this does not work anymore with Sphinx 2.4 and the patches from here. It never returns any results.

The reason I tested it is that the Debian packaging tool dh_sphinxdoc performs some sanity checks on sphinx documentation and complained that (at least) one of the search.html does not load searchindex.js. The checks it performs can be seen here:
https://salsa.debian.org/python-team/modules/sphinx/-/blob/debian/master/debian/dh-sphinxdoc/dh_sphinxdoc#L284


---

Comment by arojas created at 2020-04-25 07:26:25

Replying to [comment:120 thansen]:
> Did you try searching in the html documentation? For me this does not work anymore with Sphinx 2.4 and the patches from here. It never returns any results.

Works for me. I do get some missing labels and icons on the search page, but I see the exact same thing when using sphinx 1 and on the online version


---

Comment by fbissey created at 2020-04-25 07:27:04

Replying to [comment:120 thansen]:
> Did you try searching in the html documentation? For me this does not work anymore with Sphinx 2.4 and the patches from here. It never returns any results.
> 
> The reason I tested it is that the Debian packaging tool dh_sphinxdoc performs some sanity checks on sphinx documentation and complained that (at least) one of the search.html does not load searchindex.js. The checks it performs can be seen here:
> https://salsa.debian.org/python-team/modules/sphinx/-/blob/debian/master/debian/dh-sphinxdoc/dh_sphinxdoc#L284

Most of my development is remote and I must say it must have been years since I tried that particular functionality.


---

Comment by arojas created at 2020-04-25 07:53:51

I've opened #29576 for the broken search page


---

Comment by fbissey created at 2020-05-21 07:59:39

`@`jhpalmieri you own the branch on this ticket and #29547. May be we should rebase them. I think we should go ahead with #29547, although we could try upgrading freetype to 2.10.2 for the people who experience the crash.


---

Comment by arojas created at 2020-05-21 08:19:05

I'm getting a new error now, not sure when it started (with 3.0.3)

```
OSError: /build/sagemath-doc/src/sage-9.1/src/doc/en/installation/source.rst:237: WARNING: Include file '/build/sagemath-doc/src/sage-9.1/src/doc/en/installation/debian.txt' not found or reading it failed
```



---

Comment by fbissey created at 2020-05-21 08:26:08

During the development of 9.1 a bootstrap step has been added for the documentation. I think I mentioned it somewhere else, did you run it? https://github.com/cschwan/sage-on-gentoo/blob/master/sci-mathematics/sage/sage-9.1.ebuild#L328 in sage-on-gentoo (`${S}`  is `SAGE_ROOT/src` in vanilla sage terms).


---

Comment by fbissey created at 2020-05-21 08:40:45

Replying to [comment:125 arojas]:
> I'm getting a new error now, not sure when it started (with 3.0.3)
> {{{
> OSError: /build/sagemath-doc/src/sage-9.1/src/doc/en/installation/source.rst:237: WARNING: Include file '/build/sagemath-doc/src/sage-9.1/src/doc/en/installation/debian.txt' not found or reading it failed
> }}}

Yes this is totally what happened to you. Look at my comment #29053#comment:78 on the ticket that introduced the change.


---

Comment by arojas created at 2020-05-21 09:23:16

Replying to [comment:127 fbissey]:

> Yes this is totally what happened to you. Look at my comment #29053#comment:78 on the ticket that introduced the change.

Thanks, clearly I wasn't paying much attention to that ticket.


---

Comment by git created at 2020-05-21 21:02:40

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by jhpalmieri created at 2020-05-21 21:04:08

Replying to [comment:124 fbissey]:
> `@`jhpalmieri you own the branch on this ticket and #29547. May be we should rebase them. 

I just rebased this one. 

> I think we should go ahead with #29547, although we could try upgrading freetype to 2.10.2 for the people who experience the crash.

With #29547, `git rebase develop` works with no intervention, but also upgrading freetype doesn't seem to fix the doctest failures, so I'm not sure what to do with that ticket.


---

Comment by fbissey created at 2020-05-21 21:15:36

We need at least Matplotlib 3.1 but I suspect even that could have an issue with freetype. Note that the problem may not be freetype itself but the interface to it in matplotlib.


---

Comment by fbissey created at 2020-05-23 03:07:00

We have a merge conflict with #28000 (removal of py2 support from sagelib). Not very surprising. I will try to merge our branch with it and fix all the conflicts (removal of all calls to `six`). Volker is currently merging #28000 in his dev branch where he merges tickets incrementally before doing releases.


---

Comment by fbissey created at 2020-05-23 03:07:51

I should mention that #29547 is not affected by #28000 which is already something.


---

Comment by fbissey created at 2020-05-23 04:55:47

Merged with #28000 so no more merge conflicts there.
----
New commits:


---

Comment by git created at 2020-05-23 05:10:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by fbissey created at 2020-05-25 22:39:20

Ticket to keep a lookout on: #29633 it changes `SPKG.txt` to `SPKG.rst`. We may want to align the format if it is merged first.


---

Comment by fbissey created at 2020-06-09 01:54:27

I will make a last bump to 3.0.4 which I know is safe. I don't know yet about 3.1.0 released in the last 24 hours. But I think it is time we move this ticket to positive review. Any volunteer reviewers?


---

Comment by git created at 2020-06-09 01:55:11

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by arojas created at 2020-06-09 06:36:39

Unsurprisingly, 3.1 doesn't work


```
[reference] dumping object inventory... failed
[reference] Exception occurred:
[reference]   File "/usr/lib/python3.8/site-packages/sphinx/domains/python.py", line 1325, in get_objects
[reference]     yield (modname, modname, 'module', mod.docname, mod.node_id, 0)
[reference] AttributeError: 'tuple' object has no attribute 'docname'
```



---

Comment by fbissey created at 2020-06-09 07:54:42

I would prefer if we could merge this one already as is and open a new one for 3.1.x.


---

Comment by jhpalmieri created at 2020-06-12 18:01:53

This doesn't merge cleanly with 9.2.beta0.


---

Comment by jhpalmieri created at 2020-06-12 22:25:10

Let's move forward with this, though. (Maybe the merge problems can be fixed by squashing some commits? I don't really see what needs doing: the rebasing fails for multidocs.py, but after I clean up the rebasing, my diff looks just like the diff on this ticket.)


---

Comment by jhpalmieri created at 2020-06-12 22:25:10

Changing status from needs_review to positive_review.


---

Comment by fbissey created at 2020-06-13 01:28:01

I actually have a branch that merges 9.2.beta0 and #29547. I should double check it and push it. It should merge cleanly.


---

Comment by git created at 2020-06-13 01:33:21

Changing status from positive_review to needs_review.


---

Comment by git created at 2020-06-13 01:33:21

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by fbissey created at 2020-06-13 01:34:16

It should merge cleanly now.


---

Comment by jhpalmieri created at 2020-06-13 03:42:19

Now `git merge develop` works for me. Thank you for rebasing!


---

Comment by jhpalmieri created at 2020-06-13 03:42:19

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2020-06-21 22:37:15

Resolution: fixed


---

Comment by arojas created at 2020-06-27 11:16:40

3.1 upgrade up at #30001


---

Comment by @kliem created at 2020-06-28 12:45:21

It seems that this ticket breaks building sage on centos 7.

I opened #30008, please fix.
