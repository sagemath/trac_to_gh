# Issue 28619: Support sphinx >= 2.1

archive/issues_028619.json:
```json
{
    "body": "CC:  @antonio-rojas @kiwifb @saraedum fchapoton @jhpalmieri @jdemeyer @qed777 @tobihan @strogdon\n\nThe attributes \"todo_all_todos\" and \"citations\" were previously\nimplicitly initialized by sphinx. That changed in sphinx 2.1 due to some\nrefactoring:\n\nhttps://github.com/sphinx-doc/sphinx/commit/9abb4820b18201f63d77fdccb4ef394a21442f7a\nhttps://github.com/sphinx-doc/sphinx/commit/885d35e374b56d1d17f5036fe07b74229cdbec7f\n\nSo now we need to check for the case where they are not initialized yet.\nWe can't actually update to sphinx 2.1 yet, since its python3 only. This\nis mostly intended to make things easier for distros and allow us to\nupdate in the future.\n\nIssue created by migration from https://trac.sagemath.org/ticket/28856\n\n",
    "created_at": "2019-12-09T09:36:27Z",
    "labels": [
        "component: packages: standard"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.2",
    "title": "Support sphinx >= 2.1",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/28619",
    "user": "https://github.com/timokau"
}
```
CC:  @antonio-rojas @kiwifb @saraedum fchapoton @jhpalmieri @jdemeyer @qed777 @tobihan @strogdon

The attributes "todo_all_todos" and "citations" were previously
implicitly initialized by sphinx. That changed in sphinx 2.1 due to some
refactoring:

https://github.com/sphinx-doc/sphinx/commit/9abb4820b18201f63d77fdccb4ef394a21442f7a
https://github.com/sphinx-doc/sphinx/commit/885d35e374b56d1d17f5036fe07b74229cdbec7f

So now we need to check for the case where they are not initialized yet.
We can't actually update to sphinx 2.1 yet, since its python3 only. This
is mostly intended to make things easier for distros and allow us to
update in the future.

Issue created by migration from https://trac.sagemath.org/ticket/28856





---

archive/issue_comments_403453.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-12-09T09:36:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403453",
    "user": "https://github.com/timokau"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_403454.json:
```json
{
    "body": "New commits:",
    "created_at": "2019-12-09T09:36:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403454",
    "user": "https://github.com/timokau"
}
```

New commits:



---

archive/issue_comments_403455.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-12-09T09:39:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403455",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_403456.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-12-09T22:38:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403456",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_403457.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-12-10T09:36:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403457",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_403458.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-12-11T12:33:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403458",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_403459.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2019-12-11T23:06:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403459",
    "user": "https://github.com/timokau"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_403460.json:
```json
{
    "body": "Remaining problem:\n\n\n```\n[manifolds] Exception occurred:\n[manifolds]   File \"/nix/store/ldl3rb92yvl070c7q3nnjgwl5mdx2wvb-python3.7-sphinx-2.0.0/lib/python3.7/site-packages/sphinx/ext/intersphinx.py\", line 207, in load_mappings\n[manifolds]     for key, (name, (uri, invs)) in app.config.intersphinx_mapping.items():\n[manifolds] ValueError: too many values to unpack (expected 2)\n[manifolds] The full traceback has been saved in /build/sphinx-err-erras5d4.log, if you want to report the issue to the developers.\n[manifolds] Please also report this if it was a user error, so that a better error message can be provided next time.\n[manifolds] A bug report can be filed in the tracker at <https://github.com/sphinx-doc/sphinx/issues>. Thanks!\nTraceback (most recent call last):\n  File \"/nix/store/9894fxjpg8v99j14kip6b13rdfgf4m5k-python3-3.7.5/lib/python3.7/runpy.py\", line 193, in _run_module_as_main\n    \"__main__\", mod_spec)\n  File \"/nix/store/9894fxjpg8v99j14kip6b13rdfgf4m5k-python3-3.7.5/lib/python3.7/runpy.py\", line 85, in _run_code\n    exec(code, run_globals)\n  File \"/nix/store/i0gjbmskaxkmj2qif96ayvb803l6hm4k-python3.7-sagelib-9.0.beta6/lib/python3.7/site-packages/sage_setup/docbuild/sphinxbuild.py\", line 328, in <module>\n    runsphinx()\n  File \"/nix/store/i0gjbmskaxkmj2qif96ayvb803l6hm4k-python3.7-sagelib-9.0.beta6/lib/python3.7/site-packages/sage_setup/docbuild/sphinxbuild.py\", line 317, in runsphinx\n    sys.stderr.raise_errors()\n  File \"/nix/store/i0gjbmskaxkmj2qif96ayvb803l6hm4k-python3.7-sagelib-9.0.beta6/lib/python3.7/site-packages/sage_setup/docbuild/sphinxbuild.py\", line 252, in raise_errors\n    raise OSError(self._error)\nOSError: Exception occurred:\nError building the documentation.\nTraceback (most recent call last):\n  File \"/nix/store/9894fxjpg8v99j14kip6b13rdfgf4m5k-python3-3.7.5/lib/python3.7/runpy.py\", line 193, in _run_module_as_main\n    \"__main__\", mod_spec)\n  File \"/nix/store/9894fxjpg8v99j14kip6b13rdfgf4m5k-python3-3.7.5/lib/python3.7/runpy.py\", line 85, in _run_code\n    exec(code, run_globals)\n  File \"/nix/store/i0gjbmskaxkmj2qif96ayvb803l6hm4k-python3.7-sagelib-9.0.beta6/lib/python3.7/site-packages/sage_setup/docbuild/__main__.py\", line 2, in <module>\n    main()\n  File \"/nix/store/i0gjbmskaxkmj2qif96ayvb803l6hm4k-python3.7-sagelib-9.0.beta6/lib/python3.7/site-packages/sage_setup/docbuild/__init__.py\", line 1671, in main\n    builder()\n  File \"/nix/store/i0gjbmskaxkmj2qif96ayvb803l6hm4k-python3.7-sagelib-9.0.beta6/lib/python3.7/site-packages/sage_setup/docbuild/__init__.py\", line 310, in _wrapper\n    getattr(get_builder(document), name)(*args, **kwds)\n  File \"/nix/store/i0gjbmskaxkmj2qif96ayvb803l6hm4k-python3.7-sagelib-9.0.beta6/lib/python3.7/site-packages/sage_setup/docbuild/__init__.py\", line 504, in _wrapper\n    build_many(build_ref_doc, L)\n  File \"/nix/store/i0gjbmskaxkmj2qif96ayvb803l6hm4k-python3.7-sagelib-9.0.beta6/lib/python3.7/site-packages/sage_setup/docbuild/__init__.py\", line 258, in build_many\n    _build_many(target, args, processes=NUM_THREADS)\n  File \"/nix/store/i0gjbmskaxkmj2qif96ayvb803l6hm4k-python3.7-sagelib-9.0.beta6/lib/python3.7/site-packages/sage_setup/docbuild/utils.py\", line 283, in build_many\n    raise worker_exc.original_exception\nsubprocess.CalledProcessError: Command '['python', '-um', 'sage_setup.docbuild.sphinxbuild', '-N', '-b', 'html', '-d', '/build/share/doc/sage/doctrees/en/reference/manifolds', '-D', 'multidoc_first_pass=0', '/bui>\nbuilder for '/nix/store/rbwjmqg1dp0padhni45xkhj4vqmxc4x9-sagedoc-9.0.beta6.drv' failed with exit code 1\n```\n\n\nRelated to https://github.com/sphinx-doc/sphinx/pull/5826 and the way we use intersphinx.",
    "created_at": "2019-12-11T23:06:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403460",
    "user": "https://github.com/timokau"
}
```

Remaining problem:


```
[manifolds] Exception occurred:
[manifolds]   File "/nix/store/ldl3rb92yvl070c7q3nnjgwl5mdx2wvb-python3.7-sphinx-2.0.0/lib/python3.7/site-packages/sphinx/ext/intersphinx.py", line 207, in load_mappings
[manifolds]     for key, (name, (uri, invs)) in app.config.intersphinx_mapping.items():
[manifolds] ValueError: too many values to unpack (expected 2)
[manifolds] The full traceback has been saved in /build/sphinx-err-erras5d4.log, if you want to report the issue to the developers.
[manifolds] Please also report this if it was a user error, so that a better error message can be provided next time.
[manifolds] A bug report can be filed in the tracker at <https://github.com/sphinx-doc/sphinx/issues>. Thanks!
Traceback (most recent call last):
  File "/nix/store/9894fxjpg8v99j14kip6b13rdfgf4m5k-python3-3.7.5/lib/python3.7/runpy.py", line 193, in _run_module_as_main
    "__main__", mod_spec)
  File "/nix/store/9894fxjpg8v99j14kip6b13rdfgf4m5k-python3-3.7.5/lib/python3.7/runpy.py", line 85, in _run_code
    exec(code, run_globals)
  File "/nix/store/i0gjbmskaxkmj2qif96ayvb803l6hm4k-python3.7-sagelib-9.0.beta6/lib/python3.7/site-packages/sage_setup/docbuild/sphinxbuild.py", line 328, in <module>
    runsphinx()
  File "/nix/store/i0gjbmskaxkmj2qif96ayvb803l6hm4k-python3.7-sagelib-9.0.beta6/lib/python3.7/site-packages/sage_setup/docbuild/sphinxbuild.py", line 317, in runsphinx
    sys.stderr.raise_errors()
  File "/nix/store/i0gjbmskaxkmj2qif96ayvb803l6hm4k-python3.7-sagelib-9.0.beta6/lib/python3.7/site-packages/sage_setup/docbuild/sphinxbuild.py", line 252, in raise_errors
    raise OSError(self._error)
OSError: Exception occurred:
Error building the documentation.
Traceback (most recent call last):
  File "/nix/store/9894fxjpg8v99j14kip6b13rdfgf4m5k-python3-3.7.5/lib/python3.7/runpy.py", line 193, in _run_module_as_main
    "__main__", mod_spec)
  File "/nix/store/9894fxjpg8v99j14kip6b13rdfgf4m5k-python3-3.7.5/lib/python3.7/runpy.py", line 85, in _run_code
    exec(code, run_globals)
  File "/nix/store/i0gjbmskaxkmj2qif96ayvb803l6hm4k-python3.7-sagelib-9.0.beta6/lib/python3.7/site-packages/sage_setup/docbuild/__main__.py", line 2, in <module>
    main()
  File "/nix/store/i0gjbmskaxkmj2qif96ayvb803l6hm4k-python3.7-sagelib-9.0.beta6/lib/python3.7/site-packages/sage_setup/docbuild/__init__.py", line 1671, in main
    builder()
  File "/nix/store/i0gjbmskaxkmj2qif96ayvb803l6hm4k-python3.7-sagelib-9.0.beta6/lib/python3.7/site-packages/sage_setup/docbuild/__init__.py", line 310, in _wrapper
    getattr(get_builder(document), name)(*args, **kwds)
  File "/nix/store/i0gjbmskaxkmj2qif96ayvb803l6hm4k-python3.7-sagelib-9.0.beta6/lib/python3.7/site-packages/sage_setup/docbuild/__init__.py", line 504, in _wrapper
    build_many(build_ref_doc, L)
  File "/nix/store/i0gjbmskaxkmj2qif96ayvb803l6hm4k-python3.7-sagelib-9.0.beta6/lib/python3.7/site-packages/sage_setup/docbuild/__init__.py", line 258, in build_many
    _build_many(target, args, processes=NUM_THREADS)
  File "/nix/store/i0gjbmskaxkmj2qif96ayvb803l6hm4k-python3.7-sagelib-9.0.beta6/lib/python3.7/site-packages/sage_setup/docbuild/utils.py", line 283, in build_many
    raise worker_exc.original_exception
subprocess.CalledProcessError: Command '['python', '-um', 'sage_setup.docbuild.sphinxbuild', '-N', '-b', 'html', '-d', '/build/share/doc/sage/doctrees/en/reference/manifolds', '-D', 'multidoc_first_pass=0', '/bui>
builder for '/nix/store/rbwjmqg1dp0padhni45xkhj4vqmxc4x9-sagedoc-9.0.beta6.drv' failed with exit code 1
```


Related to https://github.com/sphinx-doc/sphinx/pull/5826 and the way we use intersphinx.



---

archive/issue_comments_403461.json:
```json
{
    "body": "Changing keywords from \"\" to \"sphinx\".",
    "created_at": "2019-12-12T03:52:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403461",
    "user": "https://github.com/slel"
}
```

Changing keywords from "" to "sphinx".



---

archive/issue_comments_403462.json:
```json
{
    "body": "Since I have little experience with sphinx and don't know how and why our intersphinx usage differs from normal usage, I'm having issues fixing this issue.\n\nI've CC'ed some people who have touched the sphinx config in the past. Can anybody help with the second issue described in the top post (regarding intersphinx)?",
    "created_at": "2019-12-12T14:42:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403462",
    "user": "https://github.com/timokau"
}
```

Since I have little experience with sphinx and don't know how and why our intersphinx usage differs from normal usage, I'm having issues fixing this issue.

I've CC'ed some people who have touched the sphinx config in the past. Can anybody help with the second issue described in the top post (regarding intersphinx)?



---

archive/issue_comments_403463.json:
```json
{
    "body": "Does anyone have experience with sphinx hooks? Understanding why the hook introduced in https://github.com/sphinx-doc/sphinx/pull/5826 isn't called would help a lot.",
    "created_at": "2019-12-22T17:34:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403463",
    "user": "https://github.com/timokau"
}
```

Does anyone have experience with sphinx hooks? Understanding why the hook introduced in https://github.com/sphinx-doc/sphinx/pull/5826 isn't called would help a lot.



---

archive/issue_comments_403464.json:
```json
{
    "body": "I do not have much experience with sphinx, but, at the bottom of `src/sage/docs/conf.py`, it appears that intersphinx is not loaded the usual way by adding it to the `extensions` list, but instead it is manually initialized in order to inject a custom function for `missing_reference`.\n\n\n```python\n        app.add_config_value('intersphinx_mapping', {}, False)\n        app.add_config_value('intersphinx_cache_limit', 5, False)\n        # We do *not* fully initialize intersphinx since we call it by hand\n        # in find_sage_dangling_links.\n        #   app.connect('missing-reference', missing_reference)\n        app.connect('missing-reference', find_sage_dangling_links)\n        import sphinx.ext.intersphinx\n        app.connect('builder-inited', set_intersphinx_mappings)\n        app.connect('builder-inited', sphinx.ext.intersphinx.load_mappings)\n```\n\n\nProbably this means that `normalize_intersphinx_mapping` is never called, but adjusting the code above as [in the PR](https://github.com/sphinx-doc/sphinx/pull/5826/commits/556f599e6ec343e2594b39f55d72d651a64e2458#diff-f4c986083e6865961f08356c4b080199L363-R372) might fix it.",
    "created_at": "2019-12-22T21:38:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403464",
    "user": "https://github.com/mwageringel"
}
```

I do not have much experience with sphinx, but, at the bottom of `src/sage/docs/conf.py`, it appears that intersphinx is not loaded the usual way by adding it to the `extensions` list, but instead it is manually initialized in order to inject a custom function for `missing_reference`.


```python
        app.add_config_value('intersphinx_mapping', {}, False)
        app.add_config_value('intersphinx_cache_limit', 5, False)
        # We do *not* fully initialize intersphinx since we call it by hand
        # in find_sage_dangling_links.
        #   app.connect('missing-reference', missing_reference)
        app.connect('missing-reference', find_sage_dangling_links)
        import sphinx.ext.intersphinx
        app.connect('builder-inited', set_intersphinx_mappings)
        app.connect('builder-inited', sphinx.ext.intersphinx.load_mappings)
```


Probably this means that `normalize_intersphinx_mapping` is never called, but adjusting the code above as [in the PR](https://github.com/sphinx-doc/sphinx/pull/5826/commits/556f599e6ec343e2594b39f55d72d651a64e2458#diff-f4c986083e6865961f08356c4b080199L363-R372) might fix it.



---

archive/issue_events_072985.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2020-01-06T14:10:03Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "milestone": "sage-9.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28619#event-72985"
}
```



---

archive/issue_comments_403465.json:
```json
{
    "body": "Ticket retargeted after milestone closed",
    "created_at": "2020-01-06T14:10:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403465",
    "user": "https://github.com/embray"
}
```

Ticket retargeted after milestone closed



---

archive/issue_comments_403466.json:
```json
{
    "body": "For what it's worth, I have not been able to get this working and don't have time to work on it any further right now. My current attempt (trying to get the normalization in there at the right point):\n\n\n```\ndiff --git a/src/sage/docs/conf.py b/src/sage/docs/conf.py\nindex d86fc9c6d1..013f1794e4 100644\n--- a/src/sage/docs/conf.py\n+++ b/src/sage/docs/conf.py\n@@ -8,6 +8,7 @@ from docutils import nodes\n from docutils.transforms import Transform\n from sphinx.ext.doctest import blankline_re\n from sphinx import highlighting\n+import sphinx.ext.intersphinx as intersphinx\n from IPython.lib.lexers import IPythonConsoleLexer, IPyLexer\n \n # If your extensions are in another directory, add it here.\n@@ -175,7 +176,7 @@ intersphinx_mapping = {\n                              \"python{}.inv\".format(python_version))),\n     'pplpy': (PPLPY_DOCS, None)}\n \n-def set_intersphinx_mappings(app, _config):\n+def set_intersphinx_mappings(app, config):\n     \"\"\"\n     Add precompiled inventory (the objects.inv)\n     \"\"\"\n@@ -201,6 +202,8 @@ def set_intersphinx_mappings(app, _config):\n             dst = os.path.join(invpath, directory, 'objects.inv')\n             app.config.intersphinx_mapping[src] = dst\n \n+    intersphinx.normalize_intersphinx_mapping(app, config)\n+\n \n # By default document are not master.\n multidocs_is_master = True\n@@ -669,7 +672,7 @@ def call_intersphinx(app, env, node, contnode):\n     \"\"\"\n     debug_inf(app, \"???? Trying intersphinx for %s\" % node['reftarget'])\n     builder = app.builder\n-    res =  sphinx.ext.intersphinx.missing_reference(\n+    res =  intersphinx.missing_reference(\n         app, env, node, contnode)\n     if res:\n         # Replace absolute links to $SAGE_DOC by relative links: this\n@@ -852,12 +855,11 @@ def setup(app):\n     if app.srcdir.startswith(SAGE_DOC_SRC):\n         app.add_config_value('intersphinx_mapping', {}, False)\n         app.add_config_value('intersphinx_cache_limit', 5, False)\n+        app.connect('config-inited', set_intersphinx_mappings)\n+        # app.connect('config-inited', intersphinx.normalize_intersphinx_mapping)\n+        app.connect('builder-inited', intersphinx.load_mappings)\n         # We do *not* fully initialize intersphinx since we call it by hand\n         # in find_sage_dangling_links.\n         #   app.connect('missing-reference', missing_reference)\n         app.connect('missing-reference', find_sage_dangling_links)\n-        import sphinx.ext.intersphinx\n-        app.connect('config-inited', set_intersphinx_mappings)\n-        app.connect('config-inited', sphinx.ext.intersphinx.normalize_intersphinx_mapping)\n-        app.connect('builder-inited', sphinx.ext.intersphinx.load_mappings)\n         app.connect('builder-inited', nitpick_patch_config)\n\n```\n",
    "created_at": "2020-01-20T10:52:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403466",
    "user": "https://github.com/timokau"
}
```

For what it's worth, I have not been able to get this working and don't have time to work on it any further right now. My current attempt (trying to get the normalization in there at the right point):


```
diff --git a/src/sage/docs/conf.py b/src/sage/docs/conf.py
index d86fc9c6d1..013f1794e4 100644
--- a/src/sage/docs/conf.py
+++ b/src/sage/docs/conf.py
@@ -8,6 +8,7 @@ from docutils import nodes
 from docutils.transforms import Transform
 from sphinx.ext.doctest import blankline_re
 from sphinx import highlighting
+import sphinx.ext.intersphinx as intersphinx
 from IPython.lib.lexers import IPythonConsoleLexer, IPyLexer
 
 # If your extensions are in another directory, add it here.
@@ -175,7 +176,7 @@ intersphinx_mapping = {
                              "python{}.inv".format(python_version))),
     'pplpy': (PPLPY_DOCS, None)}
 
-def set_intersphinx_mappings(app, _config):
+def set_intersphinx_mappings(app, config):
     """
     Add precompiled inventory (the objects.inv)
     """
@@ -201,6 +202,8 @@ def set_intersphinx_mappings(app, _config):
             dst = os.path.join(invpath, directory, 'objects.inv')
             app.config.intersphinx_mapping[src] = dst
 
+    intersphinx.normalize_intersphinx_mapping(app, config)
+
 
 # By default document are not master.
 multidocs_is_master = True
@@ -669,7 +672,7 @@ def call_intersphinx(app, env, node, contnode):
     """
     debug_inf(app, "???? Trying intersphinx for %s" % node['reftarget'])
     builder = app.builder
-    res =  sphinx.ext.intersphinx.missing_reference(
+    res =  intersphinx.missing_reference(
         app, env, node, contnode)
     if res:
         # Replace absolute links to $SAGE_DOC by relative links: this
@@ -852,12 +855,11 @@ def setup(app):
     if app.srcdir.startswith(SAGE_DOC_SRC):
         app.add_config_value('intersphinx_mapping', {}, False)
         app.add_config_value('intersphinx_cache_limit', 5, False)
+        app.connect('config-inited', set_intersphinx_mappings)
+        # app.connect('config-inited', intersphinx.normalize_intersphinx_mapping)
+        app.connect('builder-inited', intersphinx.load_mappings)
         # We do *not* fully initialize intersphinx since we call it by hand
         # in find_sage_dangling_links.
         #   app.connect('missing-reference', missing_reference)
         app.connect('missing-reference', find_sage_dangling_links)
-        import sphinx.ext.intersphinx
-        app.connect('config-inited', set_intersphinx_mappings)
-        app.connect('config-inited', sphinx.ext.intersphinx.normalize_intersphinx_mapping)
-        app.connect('builder-inited', sphinx.ext.intersphinx.load_mappings)
         app.connect('builder-inited', nitpick_patch_config)

```




---

archive/issue_comments_403467.json:
```json
{
    "body": "I have been attempting to initialize intersphinx as an ordinary Sphinx extension. The reference manual builds this way, but other pieces of the documentation fail because of missing citations, and I don't know why. But succeeding with the reference manual seems like progress. Anyway, here is my current attempt; this is using the version of Sphinx which is included in Sage \u2014 I thought I would try get that to work first with this approach, and then move on to a more recent version of Sphinx.\n\n```diff\ndiff --git a/src/sage/docs/conf.py b/src/sage/docs/conf.py\nindex 23cf5d6792..226e68a31b 100644\n--- a/src/sage/docs/conf.py\n+++ b/src/sage/docs/conf.py\n@@ -25,6 +25,7 @@ extensions = ['inventory_builder',\n               'sphinx.ext.inheritance_diagram',\n               'sphinx.ext.todo',\n               'sphinx.ext.extlinks',\n+              'sphinx.ext.intersphinx',\n               'IPython.sphinxext.ipython_directive',\n               'matplotlib.sphinxext.plot_directive']\n \n@@ -88,11 +89,6 @@ from sage.all_cmdline import *\n plot_html_show_formats = False\n plot_formats = ['svg', 'pdf', 'png']\n \n-# We do *not* fully initialize intersphinx since we call it by hand\n-# in find_sage_dangling_links.\n-#, 'sphinx.ext.intersphinx']\n-\n-\n # Add any paths that contain templates here, relative to this directory.\n templates_path = [os.path.join(SAGE_DOC_SRC, 'common', 'templates'), 'templates']\n \n@@ -850,10 +846,6 @@ def setup(app):\n     # set to a temporary directory.  We don't want to use intersphinx,\n     # etc., when doing introspection.\n     if app.srcdir.startswith(SAGE_DOC_SRC):\n-        app.add_config_value('intersphinx_mapping', {}, False)\n-        app.add_config_value('intersphinx_cache_limit', 5, False)\n-        # We do *not* fully initialize intersphinx since we call it by hand\n-        # in find_sage_dangling_links.\n         #   app.connect('missing-reference', missing_reference)\n         app.connect('missing-reference', find_sage_dangling_links)\n         import sphinx.ext.intersphinx\n```\n",
    "created_at": "2020-01-25T00:18:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403467",
    "user": "https://github.com/jhpalmieri"
}
```

I have been attempting to initialize intersphinx as an ordinary Sphinx extension. The reference manual builds this way, but other pieces of the documentation fail because of missing citations, and I don't know why. But succeeding with the reference manual seems like progress. Anyway, here is my current attempt; this is using the version of Sphinx which is included in Sage — I thought I would try get that to work first with this approach, and then move on to a more recent version of Sphinx.

```diff
diff --git a/src/sage/docs/conf.py b/src/sage/docs/conf.py
index 23cf5d6792..226e68a31b 100644
--- a/src/sage/docs/conf.py
+++ b/src/sage/docs/conf.py
@@ -25,6 +25,7 @@ extensions = ['inventory_builder',
               'sphinx.ext.inheritance_diagram',
               'sphinx.ext.todo',
               'sphinx.ext.extlinks',
+              'sphinx.ext.intersphinx',
               'IPython.sphinxext.ipython_directive',
               'matplotlib.sphinxext.plot_directive']
 
@@ -88,11 +89,6 @@ from sage.all_cmdline import *
 plot_html_show_formats = False
 plot_formats = ['svg', 'pdf', 'png']
 
-# We do *not* fully initialize intersphinx since we call it by hand
-# in find_sage_dangling_links.
-#, 'sphinx.ext.intersphinx']
-
-
 # Add any paths that contain templates here, relative to this directory.
 templates_path = [os.path.join(SAGE_DOC_SRC, 'common', 'templates'), 'templates']
 
@@ -850,10 +846,6 @@ def setup(app):
     # set to a temporary directory.  We don't want to use intersphinx,
     # etc., when doing introspection.
     if app.srcdir.startswith(SAGE_DOC_SRC):
-        app.add_config_value('intersphinx_mapping', {}, False)
-        app.add_config_value('intersphinx_cache_limit', 5, False)
-        # We do *not* fully initialize intersphinx since we call it by hand
-        # in find_sage_dangling_links.
         #   app.connect('missing-reference', missing_reference)
         app.connect('missing-reference', find_sage_dangling_links)
         import sphinx.ext.intersphinx
```




---

archive/issue_comments_403468.json:
```json
{
    "body": "Sounds like good progress indeed! Throwing away our hacks and becoming a \"normal\" intersphinx consumer would be the best solution.",
    "created_at": "2020-01-25T16:33:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403468",
    "user": "https://github.com/timokau"
}
```

Sounds like good progress indeed! Throwing away our hacks and becoming a "normal" intersphinx consumer would be the best solution.



---

archive/issue_comments_403469.json:
```json
{
    "body": "Opened #29095 for the runtime issues with latest sphinx (which are much easier to fix)",
    "created_at": "2020-01-28T20:14:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403469",
    "user": "https://github.com/antonio-rojas"
}
```

Opened #29095 for the runtime issues with latest sphinx (which are much easier to fix)



---

archive/issue_comments_403470.json:
```json
{
    "body": "Just as a heads-up: The combination of an outdated sphinx version and a newer (>=0.15) docutils version leads to (harmless) doctest failures:\n\n\n```\nFile \"/nix/store/kyzn2mbdpjgdh1n8ldqwah3s1k4b6mza-sage-src-8.9/src/sage/interfaces/tachyon.py\", line 191, in sage.interfaces.tachyon.TachyonRT.help\nFailed example:\n    t.help(use_pager=False)\nExpected:\n    This help, which was written by John Stone, describes ...\nGot:\n    doctest:warning\n      File \"/nix/store/kra72yycg2ixhkmx944qgrlgaqhr6ia4-sage-with-env-8.9/bin/sage-runtests\", line 179, in <module>\n        err = DC.run()\n      File \"/nix/store/3j74nni97qk6pj1slbbgn67q5qw4r51s-python-2.7.17-env/lib/python2.7/site-packages/sage/doctest/control.py\", line 1227, in run\n        self.run_doctests()\n      File \"/nix/store/3j74nni97qk6pj1slbbgn67q5qw4r51s-python-2.7.17-env/lib/python2.7/site-packages/sage/doctest/control.py\", line 928, in run_doctests\n        self.dispatcher.dispatch()\n      File \"/nix/store/3j74nni97qk6pj1slbbgn67q5qw4r51s-python-2.7.17-env/lib/python2.7/site-packages/sage/doctest/forker.py\", line 2041, in dispatch\n        self.parallel_dispatch()\n      File \"/nix/store/3j74nni97qk6pj1slbbgn67q5qw4r51s-python-2.7.17-env/lib/python2.7/site-packages/sage/doctest/forker.py\", line 1933, in parallel_dispatch\n        w.start()  # This might take some time\n      File \"/nix/store/3j74nni97qk6pj1slbbgn67q5qw4r51s-python-2.7.17-env/lib/python2.7/site-packages/sage/doctest/forker.py\", line 2208, in start\n        super(DocTestWorker, self).start()\n      File \"/nix/store/k5iyhnvy9cdlq3mpavw6s8blyr0px522-python-2.7.17/lib/python2.7/multiprocessing/process.py\", line 130, in start\n        self._popen = Popen(self)\n      File \"/nix/store/k5iyhnvy9cdlq3mpavw6s8blyr0px522-python-2.7.17/lib/python2.7/multiprocessing/forking.py\", line 126, in __init__\n        code = process_obj._bootstrap()\n      File \"/nix/store/k5iyhnvy9cdlq3mpavw6s8blyr0px522-python-2.7.17/lib/python2.7/multiprocessing/process.py\", line 267, in _bootstrap\n        self.run()\n      File \"/nix/store/3j74nni97qk6pj1slbbgn67q5qw4r51s-python-2.7.17-env/lib/python2.7/site-packages/sage/doctest/forker.py\", line 2180, in run\n        task(self.options, self.outtmpfile, msgpipe, self.result_queue)\n      File \"/nix/store/3j74nni97qk6pj1slbbgn67q5qw4r51s-python-2.7.17-env/lib/python2.7/site-packages/sage/doctest/forker.py\", line 2512, in __call__\n        doctests, extras = self._run(runner, options, results)\n      File \"/nix/store/3j74nni97qk6pj1slbbgn67q5qw4r51s-python-2.7.17-env/lib/python2.7/site-packages/sage/doctest/forker.py\", line 2561, in _run\n        result = runner.run(test)\n      File \"/nix/store/3j74nni97qk6pj1slbbgn67q5qw4r51s-python-2.7.17-env/lib/python2.7/site-packages/sage/doctest/forker.py\", line 897, in run\n        return self._run(test, compileflags, out)\n      File \"/nix/store/3j74nni97qk6pj1slbbgn67q5qw4r51s-python-2.7.17-env/lib/python2.7/site-packages/sage/doctest/forker.py\", line 681, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/nix/store/3j74nni97qk6pj1slbbgn67q5qw4r51s-python-2.7.17-env/lib/python2.7/site-packages/sage/doctest/forker.py\", line 1131, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.interfaces.tachyon.TachyonRT.help[2]>\", line 1, in <module>\n        t.help(use_pager=False)\n      File \"/nix/store/3j74nni97qk6pj1slbbgn67q5qw4r51s-python-2.7.17-env/lib/python2.7/site-packages/sage/interfaces/tachyon.py\", line 784, in help\n        f = format(s)\n      File \"/nix/store/3j74nni97qk6pj1slbbgn67q5qw4r51s-python-2.7.17-env/lib/python2.7/site-packages/sage/misc/sagedoc.py\", line 720, in format\n        s = detex(s, embedded=embedded)\n      File \"/nix/store/3j74nni97qk6pj1slbbgn67q5qw4r51s-python-2.7.17-env/lib/python2.7/site-packages/sage/misc/sagedoc.py\", line 228, in detex\n        s = sphinxify(s, format='text')\n      File \"/nix/store/3j74nni97qk6pj1slbbgn67q5qw4r51s-python-2.7.17-env/lib/python2.7/site-packages/sage/misc/sphinxify.py\", line 123, in sphinxify\n        sphinx_app.build(None, [rst_name])\n      File \"/nix/store/3j74nni97qk6pj1slbbgn67q5qw4r51s-python-2.7.17-env/lib/python2.7/site-packages/sphinx/application.py\", line 338, in build\n        self.builder.build_specific(filenames)\n      File \"/nix/store/3j74nni97qk6pj1slbbgn67q5qw4r51s-python-2.7.17-env/lib/python2.7/site-packages/sphinx/builders/__init__.py\", line 335, in build_specific\n        summary=__('%d source files given on command line') % len(to_write))\n      File \"/nix/store/3j74nni97qk6pj1slbbgn67q5qw4r51s-python-2.7.17-env/lib/python2.7/site-packages/sphinx/builders/__init__.py\", line 360, in build\n        updated_docnames = set(self.read())\n      File \"/nix/store/3j74nni97qk6pj1slbbgn67q5qw4r51s-python-2.7.17-env/lib/python2.7/site-packages/sphinx/builders/__init__.py\", line 468, in read\n        self._read_serial(docnames)\n      File \"/nix/store/3j74nni97qk6pj1slbbgn67q5qw4r51s-python-2.7.17-env/lib/python2.7/site-packages/sphinx/builders/__init__.py\", line 490, in _read_serial\n        self.read_doc(docname)\n      File \"/nix/store/3j74nni97qk6pj1slbbgn67q5qw4r51s-python-2.7.17-env/lib/python2.7/site-packages/sphinx/builders/__init__.py\", line 534, in read_doc\n        doctree = read_doc(self.app, self.env, self.env.doc2path(docname))\n      File \"/nix/store/3j74nni97qk6pj1slbbgn67q5qw4r51s-python-2.7.17-env/lib/python2.7/site-packages/sphinx/io.py\", line 318, in read_doc\n        pub.publish()\n      File \"/nix/store/3j74nni97qk6pj1slbbgn67q5qw4r51s-python-2.7.17-env/lib/python2.7/site-packages/docutils/core.py\", line 219, in publish\n        self.apply_transforms()\n      File \"/nix/store/3j74nni97qk6pj1slbbgn67q5qw4r51s-python-2.7.17-env/lib/python2.7/site-packages/docutils/core.py\", line 200, in apply_transforms\n        self.document.transformer.apply_transforms()\n      File \"/nix/store/3j74nni97qk6pj1slbbgn67q5qw4r51s-python-2.7.17-env/lib/python2.7/site-packages/sphinx/transforms/__init__.py\", line 90, in apply_transforms\n        Transformer.apply_transforms(self)\n      File \"/nix/store/3j74nni97qk6pj1slbbgn67q5qw4r51s-python-2.7.17-env/lib/python2.7/site-packages/docutils/transforms/__init__.py\", line 171, in apply_transforms\n        transform.apply(**kwargs)\n      File \"/nix/store/3j74nni97qk6pj1slbbgn67q5qw4r51s-python-2.7.17-env/lib/python2.7/site-packages/sphinx/transforms/__init__.py\", line 245, in apply\n        apply_source_workaround(n)\n      File \"/nix/store/3j74nni97qk6pj1slbbgn67q5qw4r51s-python-2.7.17-env/lib/python2.7/site-packages/sphinx/util/nodes.py\", line 94, in apply_source_workaround\n        for classifier in reversed(node.parent.traverse(nodes.classifier)):\n      File \"/nix/store/3j74nni97qk6pj1slbbgn67q5qw4r51s-python-2.7.17-env/lib/python2.7/site-packages/docutils/nodes.py\", line 46, in wrapper\n        warnings.warn(msg, FutureWarning, stacklevel=2)\n    :\n    FutureWarning: \n       The iterable returned by Node.traverse()\n       will become an iterator instead of a list in Docutils > 0.16.\n    This help, which was written by John Stone, describes how to create\n    scene files.\n    <BLANKLINE>\n    At the present time, scene description files are very simple. The\n    parser can't handle multiple file scene descriptions, although they\n    may be added in the future.  Most of the objects and their scene\n    description are closely related to the RAY API *(See the API docs for\n    additional info.)*\n```\n\nThese will likely turn into errors for docutils 0.16, but are already fixed in sphinx upstream: https://github.com/sphinx-doc/sphinx/commit/faedcc48ccb942b9a7b758b699b30f0d026c0771",
    "created_at": "2020-03-09T11:06:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403470",
    "user": "https://github.com/timokau"
}
```

Just as a heads-up: The combination of an outdated sphinx version and a newer (>=0.15) docutils version leads to (harmless) doctest failures:


```
File "/nix/store/kyzn2mbdpjgdh1n8ldqwah3s1k4b6mza-sage-src-8.9/src/sage/interfaces/tachyon.py", line 191, in sage.interfaces.tachyon.TachyonRT.help
Failed example:
    t.help(use_pager=False)
Expected:
    This help, which was written by John Stone, describes ...
Got:
    doctest:warning
      File "/nix/store/kra72yycg2ixhkmx944qgrlgaqhr6ia4-sage-with-env-8.9/bin/sage-runtests", line 179, in <module>
        err = DC.run()
      File "/nix/store/3j74nni97qk6pj1slbbgn67q5qw4r51s-python-2.7.17-env/lib/python2.7/site-packages/sage/doctest/control.py", line 1227, in run
        self.run_doctests()
      File "/nix/store/3j74nni97qk6pj1slbbgn67q5qw4r51s-python-2.7.17-env/lib/python2.7/site-packages/sage/doctest/control.py", line 928, in run_doctests
        self.dispatcher.dispatch()
      File "/nix/store/3j74nni97qk6pj1slbbgn67q5qw4r51s-python-2.7.17-env/lib/python2.7/site-packages/sage/doctest/forker.py", line 2041, in dispatch
        self.parallel_dispatch()
      File "/nix/store/3j74nni97qk6pj1slbbgn67q5qw4r51s-python-2.7.17-env/lib/python2.7/site-packages/sage/doctest/forker.py", line 1933, in parallel_dispatch
        w.start()  # This might take some time
      File "/nix/store/3j74nni97qk6pj1slbbgn67q5qw4r51s-python-2.7.17-env/lib/python2.7/site-packages/sage/doctest/forker.py", line 2208, in start
        super(DocTestWorker, self).start()
      File "/nix/store/k5iyhnvy9cdlq3mpavw6s8blyr0px522-python-2.7.17/lib/python2.7/multiprocessing/process.py", line 130, in start
        self._popen = Popen(self)
      File "/nix/store/k5iyhnvy9cdlq3mpavw6s8blyr0px522-python-2.7.17/lib/python2.7/multiprocessing/forking.py", line 126, in __init__
        code = process_obj._bootstrap()
      File "/nix/store/k5iyhnvy9cdlq3mpavw6s8blyr0px522-python-2.7.17/lib/python2.7/multiprocessing/process.py", line 267, in _bootstrap
        self.run()
      File "/nix/store/3j74nni97qk6pj1slbbgn67q5qw4r51s-python-2.7.17-env/lib/python2.7/site-packages/sage/doctest/forker.py", line 2180, in run
        task(self.options, self.outtmpfile, msgpipe, self.result_queue)
      File "/nix/store/3j74nni97qk6pj1slbbgn67q5qw4r51s-python-2.7.17-env/lib/python2.7/site-packages/sage/doctest/forker.py", line 2512, in __call__
        doctests, extras = self._run(runner, options, results)
      File "/nix/store/3j74nni97qk6pj1slbbgn67q5qw4r51s-python-2.7.17-env/lib/python2.7/site-packages/sage/doctest/forker.py", line 2561, in _run
        result = runner.run(test)
      File "/nix/store/3j74nni97qk6pj1slbbgn67q5qw4r51s-python-2.7.17-env/lib/python2.7/site-packages/sage/doctest/forker.py", line 897, in run
        return self._run(test, compileflags, out)
      File "/nix/store/3j74nni97qk6pj1slbbgn67q5qw4r51s-python-2.7.17-env/lib/python2.7/site-packages/sage/doctest/forker.py", line 681, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/nix/store/3j74nni97qk6pj1slbbgn67q5qw4r51s-python-2.7.17-env/lib/python2.7/site-packages/sage/doctest/forker.py", line 1131, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.interfaces.tachyon.TachyonRT.help[2]>", line 1, in <module>
        t.help(use_pager=False)
      File "/nix/store/3j74nni97qk6pj1slbbgn67q5qw4r51s-python-2.7.17-env/lib/python2.7/site-packages/sage/interfaces/tachyon.py", line 784, in help
        f = format(s)
      File "/nix/store/3j74nni97qk6pj1slbbgn67q5qw4r51s-python-2.7.17-env/lib/python2.7/site-packages/sage/misc/sagedoc.py", line 720, in format
        s = detex(s, embedded=embedded)
      File "/nix/store/3j74nni97qk6pj1slbbgn67q5qw4r51s-python-2.7.17-env/lib/python2.7/site-packages/sage/misc/sagedoc.py", line 228, in detex
        s = sphinxify(s, format='text')
      File "/nix/store/3j74nni97qk6pj1slbbgn67q5qw4r51s-python-2.7.17-env/lib/python2.7/site-packages/sage/misc/sphinxify.py", line 123, in sphinxify
        sphinx_app.build(None, [rst_name])
      File "/nix/store/3j74nni97qk6pj1slbbgn67q5qw4r51s-python-2.7.17-env/lib/python2.7/site-packages/sphinx/application.py", line 338, in build
        self.builder.build_specific(filenames)
      File "/nix/store/3j74nni97qk6pj1slbbgn67q5qw4r51s-python-2.7.17-env/lib/python2.7/site-packages/sphinx/builders/__init__.py", line 335, in build_specific
        summary=__('%d source files given on command line') % len(to_write))
      File "/nix/store/3j74nni97qk6pj1slbbgn67q5qw4r51s-python-2.7.17-env/lib/python2.7/site-packages/sphinx/builders/__init__.py", line 360, in build
        updated_docnames = set(self.read())
      File "/nix/store/3j74nni97qk6pj1slbbgn67q5qw4r51s-python-2.7.17-env/lib/python2.7/site-packages/sphinx/builders/__init__.py", line 468, in read
        self._read_serial(docnames)
      File "/nix/store/3j74nni97qk6pj1slbbgn67q5qw4r51s-python-2.7.17-env/lib/python2.7/site-packages/sphinx/builders/__init__.py", line 490, in _read_serial
        self.read_doc(docname)
      File "/nix/store/3j74nni97qk6pj1slbbgn67q5qw4r51s-python-2.7.17-env/lib/python2.7/site-packages/sphinx/builders/__init__.py", line 534, in read_doc
        doctree = read_doc(self.app, self.env, self.env.doc2path(docname))
      File "/nix/store/3j74nni97qk6pj1slbbgn67q5qw4r51s-python-2.7.17-env/lib/python2.7/site-packages/sphinx/io.py", line 318, in read_doc
        pub.publish()
      File "/nix/store/3j74nni97qk6pj1slbbgn67q5qw4r51s-python-2.7.17-env/lib/python2.7/site-packages/docutils/core.py", line 219, in publish
        self.apply_transforms()
      File "/nix/store/3j74nni97qk6pj1slbbgn67q5qw4r51s-python-2.7.17-env/lib/python2.7/site-packages/docutils/core.py", line 200, in apply_transforms
        self.document.transformer.apply_transforms()
      File "/nix/store/3j74nni97qk6pj1slbbgn67q5qw4r51s-python-2.7.17-env/lib/python2.7/site-packages/sphinx/transforms/__init__.py", line 90, in apply_transforms
        Transformer.apply_transforms(self)
      File "/nix/store/3j74nni97qk6pj1slbbgn67q5qw4r51s-python-2.7.17-env/lib/python2.7/site-packages/docutils/transforms/__init__.py", line 171, in apply_transforms
        transform.apply(**kwargs)
      File "/nix/store/3j74nni97qk6pj1slbbgn67q5qw4r51s-python-2.7.17-env/lib/python2.7/site-packages/sphinx/transforms/__init__.py", line 245, in apply
        apply_source_workaround(n)
      File "/nix/store/3j74nni97qk6pj1slbbgn67q5qw4r51s-python-2.7.17-env/lib/python2.7/site-packages/sphinx/util/nodes.py", line 94, in apply_source_workaround
        for classifier in reversed(node.parent.traverse(nodes.classifier)):
      File "/nix/store/3j74nni97qk6pj1slbbgn67q5qw4r51s-python-2.7.17-env/lib/python2.7/site-packages/docutils/nodes.py", line 46, in wrapper
        warnings.warn(msg, FutureWarning, stacklevel=2)
    :
    FutureWarning: 
       The iterable returned by Node.traverse()
       will become an iterator instead of a list in Docutils > 0.16.
    This help, which was written by John Stone, describes how to create
    scene files.
    <BLANKLINE>
    At the present time, scene description files are very simple. The
    parser can't handle multiple file scene descriptions, although they
    may be added in the future.  Most of the objects and their scene
    description are closely related to the RAY API *(See the API docs for
    additional info.)*
```

These will likely turn into errors for docutils 0.16, but are already fixed in sphinx upstream: https://github.com/sphinx-doc/sphinx/commit/faedcc48ccb942b9a7b758b699b30f0d026c0771



---

archive/issue_comments_403471.json:
```json
{
    "body": "In the meantime, a beta for Sphinx 3.0.0 is available: see https://github.com/sphinx-doc/sphinx/blob/3.0.x/CHANGES",
    "created_at": "2020-03-22T18:50:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403471",
    "user": "https://github.com/jhpalmieri"
}
```

In the meantime, a beta for Sphinx 3.0.0 is available: see https://github.com/sphinx-doc/sphinx/blob/3.0.x/CHANGES



---

archive/issue_comments_403472.json:
```json
{
    "body": "A user of sage-on-gentoo did go and talk to upstream about our difficulties with intersphinx in https://github.com/sphinx-doc/sphinx/issues/7409 and one of the dev took it to heart. Apparently we have to switch from `builder-inetd` to `config-inetd` and make sure we have sphinx including https://github.com/sphinx-doc/sphinx/pull/7415\n\nI haven't got around figuring out how to use all that information.",
    "created_at": "2020-04-07T10:04:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403472",
    "user": "https://github.com/kiwifb"
}
```

A user of sage-on-gentoo did go and talk to upstream about our difficulties with intersphinx in https://github.com/sphinx-doc/sphinx/issues/7409 and one of the dev took it to heart. Apparently we have to switch from `builder-inetd` to `config-inetd` and make sure we have sphinx including https://github.com/sphinx-doc/sphinx/pull/7415

I haven't got around figuring out how to use all that information.



---

archive/issue_comments_403473.json:
```json
{
    "body": "And now that I have looked more closely, it is all included in the newly released sphinx-3.0.",
    "created_at": "2020-04-07T10:29:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403473",
    "user": "https://github.com/kiwifb"
}
```

And now that I have looked more closely, it is all included in the newly released sphinx-3.0.



---

archive/issue_comments_403474.json:
```json
{
    "body": "I am trying to get to support sphinx 3.0 in gentoo in time for sage-9.1. So far I have combined the branch attached to this ticket plus comment:15. \n\n```diff\n--- a/sage/docs/conf.py\n+++ b/sage/docs/conf.py\n@@ -8,6 +8,7 @@ from docutils import nodes\n from docutils.transforms import Transform\n from sphinx.ext.doctest import blankline_re\n from sphinx import highlighting\n+import sphinx.ext.intersphinx as intersphinx\n from IPython.lib.lexers import IPythonConsoleLexer, IPyLexer\n \n # If your extensions are in another directory, add it here.\n@@ -175,7 +176,7 @@ intersphinx_mapping = {\n                              \"python{}.inv\".format(python_version))),\n     'pplpy': (PPLPY_DOCS, None)}\n \n-def set_intersphinx_mappings(app):\n+def set_intersphinx_mappings(app, config):\n     \"\"\"\n     Add precompiled inventory (the objects.inv)\n     \"\"\"\n@@ -201,6 +202,8 @@ def set_intersphinx_mappings(app):\n             dst = os.path.join(invpath, directory, 'objects.inv')\n             app.config.intersphinx_mapping[src] = dst\n \n+    intersphinx.normalize_intersphinx_mapping(app, config)\n+\n \n # By default document are not master.\n multidocs_is_master = True\n@@ -669,7 +672,7 @@ def call_intersphinx(app, env, node, contnode):\n     \"\"\"\n     debug_inf(app, \"???? Trying intersphinx for %s\" % node['reftarget'])\n     builder = app.builder\n-    res =  sphinx.ext.intersphinx.missing_reference(\n+    res =  intersphinx.missing_reference(\n         app, env, node, contnode)\n     if res:\n         # Replace absolute links to $SAGE_DOC by relative links: this\n@@ -852,11 +855,11 @@ def setup(app):\n     if app.srcdir.startswith(SAGE_DOC_SRC):\n         app.add_config_value('intersphinx_mapping', {}, False)\n         app.add_config_value('intersphinx_cache_limit', 5, False)\n+        app.connect('config-inited', set_intersphinx_mappings)\n+        # app.connect('config-inited', intersphinx.normalize_intersphinx_mapping)\n+        app.connect('builder-inited', intersphinx.load_mappings)\n         # We do *not* fully initialize intersphinx since we call it by hand\n         # in find_sage_dangling_links.\n         #   app.connect('missing-reference', missing_reference)\n         app.connect('missing-reference', find_sage_dangling_links)\n-        import sphinx.ext.intersphinx\n-        app.connect('builder-inited', set_intersphinx_mappings)\n-        app.connect('builder-inited', sphinx.ext.intersphinx.load_mappings)\n         app.connect('builder-inited', nitpick_patch_config)\ndiff --git a/sage_setup/docbuild/ext/multidocs.py b/sage_setup/docbuild/ext/multidocs.py\nindex 71a08cd..3a3d09a 100644\n--- a/sage_setup/docbuild/ext/multidocs.py\n+++ b/sage_setup/docbuild/ext/multidocs.py\n@@ -47,24 +47,30 @@ def merge_environment(app, env):\n     - domaindata['py']['modules'] # list of python modules\n     \"\"\"\n     logger.info(bold('Merging environment/index files...'))\n+    if not hasattr(env, \"todo_all_todos\"):\n+        env.todo_all_todos = []\n+    if not hasattr(env.domaindata[\"std\"], \"citations\"):\n+        env.domaindata[\"std\"][\"citations\"] = dict()\n     for curdoc in app.env.config.multidocs_subdoc_list:\n         logger.info(\"    %s:\"%curdoc, nonl=1)\n         docenv = get_env(app, curdoc)\n         if docenv is not None:\n             fixpath = lambda path: os.path.join(curdoc, path)\n+            todos = docenv.todo_all_todos if hasattr(docenv, \"todo_all_todos\") else []\n+            citations = docenv.domaindata[\"std\"].get(\"citations\", dict())\n             logger.info(\" %s todos, %s index, %s citations\"%(\n-                    len(docenv.todo_all_todos),\n+                    len(todos),\n                     len(docenv.indexentries),\n-                    len(docenv.domaindata[\"std\"][\"citations\"])\n+                    len(citations)\n                     ), nonl=1)\n \n             # merge titles\n             for t in docenv.titles:\n                 env.titles[fixpath(t)] = docenv.titles[t]\n             # merge the todo links\n-            for dct in docenv.todo_all_todos:\n+            for dct in todos:\n                 dct['docname'] = fixpath(dct['docname'])\n-            env.todo_all_todos += docenv.todo_all_todos\n+            env.todo_all_todos += todos\n             # merge the html index links\n             newindex = {}\n             for ind in docenv.indexentries:\n@@ -86,8 +92,7 @@ def merge_environment(app, env):\n                 env.metadata[ind] = md\n             # merge the citations\n             newcite = {}\n-            citations = docenv.domaindata[\"std\"][\"citations\"]\n-            for ind, (path, tag, lineno) in six.iteritems(docenv.domaindata[\"std\"][\"citations\"]):\n+            for ind, (path, tag, lineno) in six.iteritems(citations):\n                 # TODO: Warn on conflicts\n                 newcite[ind] = (fixpath(path), tag, lineno)\n             env.domaindata[\"std\"][\"citations\"].update(newcite)\n@@ -253,7 +258,7 @@ def fetch_citation(app, env):\n     with open(filename, 'rb') as f:\n         cache = cPickle.load(f)\n     logger.info(\"done (%s citations).\"%len(cache))\n-    cite = env.domaindata[\"std\"][\"citations\"]\n+    cite = env.domaindata[\"std\"].get(\"citations\", dict())\n     for ind, (path, tag, lineno) in six.iteritems(cache):\n         if ind not in cite: # don't override local citation\n             cite[ind] = (os.path.join(\"..\", path), tag, lineno)\n```\n\nAnd it goes some way with multiple warnings\n\n```\n[plot3d   ] /usr/lib/python3.7/site-packages/sphinx/pycode/__init__.py:186: RemovedInSphinx40Warning: ModuleAnalyzer.encoding is deprecated.\n[plot3d   ]   RemovedInSphinx40Warning)\n```\n\nwhich is probably coming from something else (like docutils - I have to track it). But ultimately it breaks down at\n\n\n```\n[combinat ] /dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python3_7/build/lib/sage/combinat/permutation.py:docstring of sage.combinat.permutation.Permutation.left_action_product:1: WARNING: duplicate object description of sage.combinat.permutation.Permutation.left_action_product, other instance in sage/combinat/permutation, use :noindex: for one of them\n[combinat ] /dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python3_7/build/lib/sage/combinat/permutation.py:docstring of sage.combinat.permutation.Permutation.right_action_product:1: WARNING: duplicate object description of sage.combinat.permutation.Permutation.right_action_product, other instance in sage/combinat/permutation, use :noindex: for one of them\n```\n\nwhich leads to the build of documentation stopping\n\n```\nError building the documentation.\nTraceback (most recent call last):\n  File \"sage_setup/docbuild/__main__.py\", line 2, in <module>\n    main()\n  File \"/dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python3_7/sage_setup/docbuild/__init__.py\", line 1720, in main\n    builder()\n  File \"/dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python3_7/sage_setup/docbuild/__init__.py\", line 327, in _wrapper\n    getattr(get_builder(document), 'inventory')(*args, **kwds)\n  File \"/dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python3_7/sage_setup/docbuild/__init__.py\", line 552, in _wrapper\n    self._build_everything_except_bibliography(lang, format, *args, **kwds)\n  File \"/dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python3_7/sage_setup/docbuild/__init__.py\", line 538, in _build_everything_except_bibliography\n    build_many(build_ref_doc, non_references)\n  File \"/dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python3_7/sage_setup/docbuild/__init__.py\", line 280, in build_many\n    _build_many(target, args, processes=NUM_THREADS)\n  File \"/dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python3_7/sage_setup/docbuild/utils.py\", line 283, in build_many\n    raise worker_exc.original_exception\nOSError: /dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python3_7/build/lib/`sage/combinat/permutation.py:docstring of sage.combinat.permutation.Permutation.left_action_product:1: WARNING: duplicate object description of sage.combinat.permutation.Permutation.left_action_product, other instance in sage/combinat/permutation, use :noindex: for one of them\n```\n\nI have looked at `sage/combinat/permutation.py` but I cannot figure where I should add `:noindex:`. Some assistance at this stage would be welcome.",
    "created_at": "2020-04-14T03:09:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403474",
    "user": "https://github.com/kiwifb"
}
```

I am trying to get to support sphinx 3.0 in gentoo in time for sage-9.1. So far I have combined the branch attached to this ticket plus comment:15. 

```diff
--- a/sage/docs/conf.py
+++ b/sage/docs/conf.py
@@ -8,6 +8,7 @@ from docutils import nodes
 from docutils.transforms import Transform
 from sphinx.ext.doctest import blankline_re
 from sphinx import highlighting
+import sphinx.ext.intersphinx as intersphinx
 from IPython.lib.lexers import IPythonConsoleLexer, IPyLexer
 
 # If your extensions are in another directory, add it here.
@@ -175,7 +176,7 @@ intersphinx_mapping = {
                              "python{}.inv".format(python_version))),
     'pplpy': (PPLPY_DOCS, None)}
 
-def set_intersphinx_mappings(app):
+def set_intersphinx_mappings(app, config):
     """
     Add precompiled inventory (the objects.inv)
     """
@@ -201,6 +202,8 @@ def set_intersphinx_mappings(app):
             dst = os.path.join(invpath, directory, 'objects.inv')
             app.config.intersphinx_mapping[src] = dst
 
+    intersphinx.normalize_intersphinx_mapping(app, config)
+
 
 # By default document are not master.
 multidocs_is_master = True
@@ -669,7 +672,7 @@ def call_intersphinx(app, env, node, contnode):
     """
     debug_inf(app, "???? Trying intersphinx for %s" % node['reftarget'])
     builder = app.builder
-    res =  sphinx.ext.intersphinx.missing_reference(
+    res =  intersphinx.missing_reference(
         app, env, node, contnode)
     if res:
         # Replace absolute links to $SAGE_DOC by relative links: this
@@ -852,11 +855,11 @@ def setup(app):
     if app.srcdir.startswith(SAGE_DOC_SRC):
         app.add_config_value('intersphinx_mapping', {}, False)
         app.add_config_value('intersphinx_cache_limit', 5, False)
+        app.connect('config-inited', set_intersphinx_mappings)
+        # app.connect('config-inited', intersphinx.normalize_intersphinx_mapping)
+        app.connect('builder-inited', intersphinx.load_mappings)
         # We do *not* fully initialize intersphinx since we call it by hand
         # in find_sage_dangling_links.
         #   app.connect('missing-reference', missing_reference)
         app.connect('missing-reference', find_sage_dangling_links)
-        import sphinx.ext.intersphinx
-        app.connect('builder-inited', set_intersphinx_mappings)
-        app.connect('builder-inited', sphinx.ext.intersphinx.load_mappings)
         app.connect('builder-inited', nitpick_patch_config)
diff --git a/sage_setup/docbuild/ext/multidocs.py b/sage_setup/docbuild/ext/multidocs.py
index 71a08cd..3a3d09a 100644
--- a/sage_setup/docbuild/ext/multidocs.py
+++ b/sage_setup/docbuild/ext/multidocs.py
@@ -47,24 +47,30 @@ def merge_environment(app, env):
     - domaindata['py']['modules'] # list of python modules
     """
     logger.info(bold('Merging environment/index files...'))
+    if not hasattr(env, "todo_all_todos"):
+        env.todo_all_todos = []
+    if not hasattr(env.domaindata["std"], "citations"):
+        env.domaindata["std"]["citations"] = dict()
     for curdoc in app.env.config.multidocs_subdoc_list:
         logger.info("    %s:"%curdoc, nonl=1)
         docenv = get_env(app, curdoc)
         if docenv is not None:
             fixpath = lambda path: os.path.join(curdoc, path)
+            todos = docenv.todo_all_todos if hasattr(docenv, "todo_all_todos") else []
+            citations = docenv.domaindata["std"].get("citations", dict())
             logger.info(" %s todos, %s index, %s citations"%(
-                    len(docenv.todo_all_todos),
+                    len(todos),
                     len(docenv.indexentries),
-                    len(docenv.domaindata["std"]["citations"])
+                    len(citations)
                     ), nonl=1)
 
             # merge titles
             for t in docenv.titles:
                 env.titles[fixpath(t)] = docenv.titles[t]
             # merge the todo links
-            for dct in docenv.todo_all_todos:
+            for dct in todos:
                 dct['docname'] = fixpath(dct['docname'])
-            env.todo_all_todos += docenv.todo_all_todos
+            env.todo_all_todos += todos
             # merge the html index links
             newindex = {}
             for ind in docenv.indexentries:
@@ -86,8 +92,7 @@ def merge_environment(app, env):
                 env.metadata[ind] = md
             # merge the citations
             newcite = {}
-            citations = docenv.domaindata["std"]["citations"]
-            for ind, (path, tag, lineno) in six.iteritems(docenv.domaindata["std"]["citations"]):
+            for ind, (path, tag, lineno) in six.iteritems(citations):
                 # TODO: Warn on conflicts
                 newcite[ind] = (fixpath(path), tag, lineno)
             env.domaindata["std"]["citations"].update(newcite)
@@ -253,7 +258,7 @@ def fetch_citation(app, env):
     with open(filename, 'rb') as f:
         cache = cPickle.load(f)
     logger.info("done (%s citations)."%len(cache))
-    cite = env.domaindata["std"]["citations"]
+    cite = env.domaindata["std"].get("citations", dict())
     for ind, (path, tag, lineno) in six.iteritems(cache):
         if ind not in cite: # don't override local citation
             cite[ind] = (os.path.join("..", path), tag, lineno)
```

And it goes some way with multiple warnings

```
[plot3d   ] /usr/lib/python3.7/site-packages/sphinx/pycode/__init__.py:186: RemovedInSphinx40Warning: ModuleAnalyzer.encoding is deprecated.
[plot3d   ]   RemovedInSphinx40Warning)
```

which is probably coming from something else (like docutils - I have to track it). But ultimately it breaks down at


```
[combinat ] /dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python3_7/build/lib/sage/combinat/permutation.py:docstring of sage.combinat.permutation.Permutation.left_action_product:1: WARNING: duplicate object description of sage.combinat.permutation.Permutation.left_action_product, other instance in sage/combinat/permutation, use :noindex: for one of them
[combinat ] /dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python3_7/build/lib/sage/combinat/permutation.py:docstring of sage.combinat.permutation.Permutation.right_action_product:1: WARNING: duplicate object description of sage.combinat.permutation.Permutation.right_action_product, other instance in sage/combinat/permutation, use :noindex: for one of them
```

which leads to the build of documentation stopping

```
Error building the documentation.
Traceback (most recent call last):
  File "sage_setup/docbuild/__main__.py", line 2, in <module>
    main()
  File "/dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python3_7/sage_setup/docbuild/__init__.py", line 1720, in main
    builder()
  File "/dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python3_7/sage_setup/docbuild/__init__.py", line 327, in _wrapper
    getattr(get_builder(document), 'inventory')(*args, **kwds)
  File "/dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python3_7/sage_setup/docbuild/__init__.py", line 552, in _wrapper
    self._build_everything_except_bibliography(lang, format, *args, **kwds)
  File "/dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python3_7/sage_setup/docbuild/__init__.py", line 538, in _build_everything_except_bibliography
    build_many(build_ref_doc, non_references)
  File "/dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python3_7/sage_setup/docbuild/__init__.py", line 280, in build_many
    _build_many(target, args, processes=NUM_THREADS)
  File "/dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python3_7/sage_setup/docbuild/utils.py", line 283, in build_many
    raise worker_exc.original_exception
OSError: /dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python3_7/build/lib/`sage/combinat/permutation.py:docstring of sage.combinat.permutation.Permutation.left_action_product:1: WARNING: duplicate object description of sage.combinat.permutation.Permutation.left_action_product, other instance in sage/combinat/permutation, use :noindex: for one of them
```

I have looked at `sage/combinat/permutation.py` but I cannot figure where I should add `:noindex:`. Some assistance at this stage would be welcome.



---

archive/issue_comments_403475.json:
```json
{
    "body": "The deprecation warnings come from sage itself, specifically from https://github.com/sagemath/sagetrac-mirror/blob/master/src/sage_setup/docbuild/ext/sage_autodoc.py#n539 - fixing it gives a similar amount of warnings, this time about safe_getmembers. Haven't looked into the replacement for that one yet.\n\nBuilding with -k makes it go past the duplicate object error, but then one gets again the `ValueError: too many values to unpack` error when it reaches the second pass.",
    "created_at": "2020-04-14T09:41:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403475",
    "user": "https://github.com/antonio-rojas"
}
```

The deprecation warnings come from sage itself, specifically from https://github.com/sagemath/sagetrac-mirror/blob/master/src/sage_setup/docbuild/ext/sage_autodoc.py#n539 - fixing it gives a similar amount of warnings, this time about safe_getmembers. Haven't looked into the replacement for that one yet.

Building with -k makes it go past the duplicate object error, but then one gets again the `ValueError: too many values to unpack` error when it reaches the second pass.



---

archive/issue_comments_403476.json:
```json
{
    "body": "I see the `safe_getmembers` warnings as well - without fixing sage_autodoc. It floods a little less :) I thought sphinx-3.0 was supposed to help with the \"too many value to unpack\". I guess that was too optimistic.",
    "created_at": "2020-04-14T09:58:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403476",
    "user": "https://github.com/kiwifb"
}
```

I see the `safe_getmembers` warnings as well - without fixing sage_autodoc. It floods a little less :) I thought sphinx-3.0 was supposed to help with the "too many value to unpack". I guess that was too optimistic.



---

archive/issue_comments_403477.json:
```json
{
    "body": "I added some debug, seems that normalize_intersphinx_mapping is never being run",
    "created_at": "2020-04-14T18:20:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403477",
    "user": "https://github.com/antonio-rojas"
}
```

I added some debug, seems that normalize_intersphinx_mapping is never being run



---

archive/issue_comments_403478.json:
```json
{
    "body": "Alright, turns out that was my fault... conf.py was moved to sagelib a while ago so I was using the (unpatched) version from the installed sagemath instead of the patched one in the source code when building sagemath-doc.\n\nNow, after sorting it out, the new errors (on the second pass) are:\n\n```\n[tutorial ]   File \"/usr/lib/python3.8/urllib/parse.py\", line 108, in <genexpr>\n[tutorial ]     return tuple(x.decode(encoding, errors) if x else '' for x in args)\n[tutorial ] AttributeError: 'tuple' object has no attribute 'decode'\n```\n\nThese seem to be cause by a bad intersphinx mapping normalization... looks like normalize_intersphinx_mapping is not idempotent, and when running it on an already normalized item it will try to renormalize it and break its format.",
    "created_at": "2020-04-16T11:38:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403478",
    "user": "https://github.com/antonio-rojas"
}
```

Alright, turns out that was my fault... conf.py was moved to sagelib a while ago so I was using the (unpatched) version from the installed sagemath instead of the patched one in the source code when building sagemath-doc.

Now, after sorting it out, the new errors (on the second pass) are:

```
[tutorial ]   File "/usr/lib/python3.8/urllib/parse.py", line 108, in <genexpr>
[tutorial ]     return tuple(x.decode(encoding, errors) if x else '' for x in args)
[tutorial ] AttributeError: 'tuple' object has no attribute 'decode'
```

These seem to be cause by a bad intersphinx mapping normalization... looks like normalize_intersphinx_mapping is not idempotent, and when running it on an already normalized item it will try to renormalize it and break its format.



---

archive/issue_comments_403479.json:
```json
{
    "body": "Getting closer: with the attached patch the double normalization issue is worked around and the compilation finishes (with -k). It also fixes the most annoying deprecation warnings. However, there are many files missing which were present when compiling with sphinx 1.\n\nNot sure if it's related, but at the end of the first pass one gets the error:\n\n```\n[reference] Extension error:\n[reference] Domain 'index' is not registered\n```\n\nso it seems that the `index` attribute also needs to be explicitely initialized now, similar to `citations` and `todo_all_todos`\n\n\n**obsolete patch removed**",
    "created_at": "2020-04-16T16:40:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403479",
    "user": "https://github.com/antonio-rojas"
}
```

Getting closer: with the attached patch the double normalization issue is worked around and the compilation finishes (with -k). It also fixes the most annoying deprecation warnings. However, there are many files missing which were present when compiling with sphinx 1.

Not sure if it's related, but at the end of the first pass one gets the error:

```
[reference] Extension error:
[reference] Domain 'index' is not registered
```

so it seems that the `index` attribute also needs to be explicitely initialized now, similar to `citations` and `todo_all_todos`


**obsolete patch removed**



---

archive/issue_comments_403480.json:
```json
{
    "body": "Updated patch that fixes the `Domain 'index' is not registered` error and all sphinx deprecation warnings. Still, html for the reference manual subdirs is not being generated.\n\n**obsolete patch removed**",
    "created_at": "2020-04-16T19:50:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403480",
    "user": "https://github.com/antonio-rojas"
}
```

Updated patch that fixes the `Domain 'index' is not registered` error and all sphinx deprecation warnings. Still, html for the reference manual subdirs is not being generated.

**obsolete patch removed**



---

archive/issue_comments_403481.json:
```json
{
    "body": "Well, that's some progress I guess. I think we should move this ticket milestone to 9.2 and make it \"upgrade to sphinx 3\", that would be more honest because I don't think we can keep it compatible with sphinx-1.8 at the same time.",
    "created_at": "2020-04-16T20:51:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403481",
    "user": "https://github.com/kiwifb"
}
```

Well, that's some progress I guess. I think we should move this ticket milestone to 9.2 and make it "upgrade to sphinx 3", that would be more honest because I don't think we can keep it compatible with sphinx-1.8 at the same time.



---

archive/issue_comments_403482.json:
```json
{
    "body": "Found the problem, some used sphinx API has been removed. With the attached version the docs compile (still with -k). Next issue: citation links are not working.\n\n\n```diff\n--- a/src/sage_setup/docbuild/__init__.py\n+++ b/src/sage_setup/docbuild/__init__.py\n@@ -817,9 +817,13 @@ class ReferenceSubBuilder(DocBuilder):\n \n         env_pickle = os.path.join(self._doctrees_dir(), 'environment.pickle')\n         try:\n-            env = BuildEnvironment.frompickle(env_pickle, FakeApp(self.dir))\n-            logger.debug(\"Opened Sphinx environment: %s\", env_pickle)\n-            return env\n+            with open(env_pickle, 'rb') as f:\n+                import pickle\n+                env = pickle.load(f)\n+                env.app = FakeApp(self.dir)\n+                env.config.values = env.app.config.values\n+                logger.debug(\"Opened Sphinx environment: %s\", env_pickle)\n+                return env\n         except IOError as err:\n             logger.debug(\"Failed to open Sphinx environment: %s\", err)\n \n--- a/src/sage/docs/conf.py\n+++ b/src/sage/docs/conf.py\n@@ -8,6 +8,7 @@ from docutils import nodes\n from docutils.transforms import Transform\n from sphinx.ext.doctest import blankline_re\n from sphinx import highlighting\n+import sphinx.ext.intersphinx as intersphinx\n from IPython.lib.lexers import IPythonConsoleLexer, IPyLexer\n \n # If your extensions are in another directory, add it here.\n@@ -169,13 +169,8 @@ todo_include_todos = True\n \n # Cross-links to other project's online documentation.\n python_version = sys.version_info.major\n-intersphinx_mapping = {\n-    'python': ('https://docs.python.org/',\n-                os.path.join(SAGE_DOC_SRC, \"common\",\n-                             \"python{}.inv\".format(python_version))),\n-    'pplpy': (PPLPY_DOCS, None)}\n \n-def set_intersphinx_mappings(app):\n+def set_intersphinx_mappings(app, config):\n     \"\"\"\n     Add precompiled inventory (the objects.inv)\n     \"\"\"\n@@ -186,7 +182,11 @@ def set_intersphinx_mappings(app):\n         app.config.intersphinx_mapping = {}\n         return\n \n-    app.config.intersphinx_mapping = intersphinx_mapping\n+    app.config.intersphinx_mapping =  {\n+    'python': ('https://docs.python.org/',\n+                os.path.join(SAGE_DOC_SRC, \"common\",\n+                             \"python{}.inv\".format(python_version))),\n+    'pplpy': (PPLPY_DOCS, None)}\n \n     # Add master intersphinx mapping\n     dst = os.path.join(invpath, 'objects.inv')\n@@ -201,6 +201,7 @@ def set_intersphinx_mappings(app):\n             dst = os.path.join(invpath, directory, 'objects.inv')\n             app.config.intersphinx_mapping[src] = dst\n \n+    intersphinx.normalize_intersphinx_mapping(app, config)\n \n # By default document are not master.\n multidocs_is_master = True\n@@ -669,7 +672,7 @@ def call_intersphinx(app, env, node, contnode):\n     \"\"\"\n     debug_inf(app, \"???? Trying intersphinx for %s\" % node['reftarget'])\n     builder = app.builder\n-    res =  sphinx.ext.intersphinx.missing_reference(\n+    res =  intersphinx.missing_reference(\n         app, env, node, contnode)\n     if res:\n         # Replace absolute links to $SAGE_DOC by relative links: this\n@@ -852,11 +855,10 @@ def setup(app):\n     if app.srcdir.startswith(SAGE_DOC_SRC):\n         app.add_config_value('intersphinx_mapping', {}, False)\n         app.add_config_value('intersphinx_cache_limit', 5, False)\n+        app.connect('config-inited', set_intersphinx_mappings)\n+        app.connect('builder-inited', intersphinx.load_mappings)\n         # We do *not* fully initialize intersphinx since we call it by hand\n         # in find_sage_dangling_links.\n         #   app.connect('missing-reference', missing_reference)\n         app.connect('missing-reference', find_sage_dangling_links)\n-        import sphinx.ext.intersphinx\n-        app.connect('builder-inited', set_intersphinx_mappings)\n-        app.connect('builder-inited', sphinx.ext.intersphinx.load_mappings)\n         app.connect('builder-inited', nitpick_patch_config)\n--- a/src/sage_setup/docbuild/ext/multidocs.py\n+++ b/src/sage_setup/docbuild/ext/multidocs.py\n@@ -47,32 +47,39 @@ def merge_environment(app, env):\n     - domaindata['py']['modules'] # list of python modules\n     \"\"\"\n     logger.info(bold('Merging environment/index files...'))\n+    if not hasattr(env, \"todo_all_todos\"):\n+        env.todo_all_todos = []\n+    if not env.domaindata[\"std\"].get(\"citations\"):\n+        env.domaindata[\"std\"][\"citations\"] = dict()\n     for curdoc in app.env.config.multidocs_subdoc_list:\n         logger.info(\"    %s:\"%curdoc, nonl=1)\n         docenv = get_env(app, curdoc)\n         if docenv is not None:\n             fixpath = lambda path: os.path.join(curdoc, path)\n+            todos = docenv.todo_all_todos if hasattr(docenv, \"todo_all_todos\") else []\n+            citations = docenv.domaindata[\"std\"].get(\"citations\", dict())\n+            indexentries = docenv.domaindata[\"index\"].get(\"entries\", dict())\n             logger.info(\" %s todos, %s index, %s citations\"%(\n-                    len(docenv.todo_all_todos),\n-                    len(docenv.indexentries),\n-                    len(docenv.domaindata[\"std\"][\"citations\"])\n+                    len(todos),\n+                    len(indexentries),\n+                    len(citations)\n                     ), nonl=1)\n \n             # merge titles\n             for t in docenv.titles:\n                 env.titles[fixpath(t)] = docenv.titles[t]\n             # merge the todo links\n-            for dct in docenv.todo_all_todos:\n+            for dct in todos:\n                 dct['docname'] = fixpath(dct['docname'])\n-            env.todo_all_todos += docenv.todo_all_todos\n+            env.todo_all_todos += todos\n             # merge the html index links\n             newindex = {}\n-            for ind in docenv.indexentries:\n+            for ind in indexentries:\n                 if ind.startswith('sage/'):\n-                    newindex[fixpath(ind)] = docenv.indexentries[ind]\n+                    newindex[fixpath(ind)] = indexentries[ind]\n                 else:\n-                    newindex[ind] = docenv.indexentries[ind]\n-            env.indexentries.update(newindex)\n+                    newindex[ind] = indexentries[ind]\n+            env.domaindata['index']['entries'].update(newindex)\n             # merge the all_docs links, needed by the js index\n             newalldoc = {}\n             for ind in docenv.all_docs:\n@@ -86,24 +93,23 @@ def merge_environment(app, env):\n                 env.metadata[ind] = md\n             # merge the citations\n             newcite = {}\n-            citations = docenv.domaindata[\"std\"][\"citations\"]\n-            for ind, (path, tag, lineno) in six.iteritems(docenv.domaindata[\"std\"][\"citations\"]):\n+            for ind, (path, tag, lineno) in six.iteritems(citations):\n                 # TODO: Warn on conflicts\n                 newcite[ind] = (fixpath(path), tag, lineno)\n-            env.domaindata[\"std\"][\"citations\"].update(newcite)\n+            env.domaindata['std']['citations'].update(newcite)\n             # merge the py:module indexes\n             newmodules = {}\n-            for ind,(modpath,v1,v2,v3) in (\n+            for ind,(modpath,v1,v2,v3,v4) in (\n                 six.iteritems(docenv.domaindata['py']['modules'])):\n-                newmodules[ind] = (fixpath(modpath),v1,v2,v3)\n+                newmodules[ind] = (fixpath(modpath),v1,v2,v3,v4)\n             env.domaindata['py']['modules'].update(newmodules)\n             logger.info(\", %s modules\"%(len(newmodules)))\n     logger.info('... done (%s todos, %s index, %s citations, %s modules)'%(\n             len(env.todo_all_todos),\n-            len(env.indexentries),\n-            len(env.domaindata[\"std\"][\"citations\"]),\n+            len(env.domaindata['index']['entries']),\n+            len(env.domaindata['std']['citations']),\n             len(env.domaindata['py']['modules'])))\n-    write_citations(app, env.domaindata[\"std\"][\"citations\"])\n+    write_citations(app, env.domaindata['std']['citations'])\n \n \n def get_env(app, curdoc):\n@@ -253,7 +259,7 @@ def fetch_citation(app, env):\n     with open(filename, 'rb') as f:\n         cache = cPickle.load(f)\n     logger.info(\"done (%s citations).\"%len(cache))\n-    cite = env.domaindata[\"std\"][\"citations\"]\n+    cite = env.domaindata[\"std\"].get(\"citations\", dict())\n     for ind, (path, tag, lineno) in six.iteritems(cache):\n         if ind not in cite: # don't override local citation\n             cite[ind] = (os.path.join(\"..\", path), tag, lineno)\n--- a/src/sage_setup/docbuild/ext/sage_autodoc.py\n+++ b/src/sage_setup/docbuild/ext/sage_autodoc.py\n@@ -35,14 +35,15 @@ import sys\n from docutils.statemachine import ViewList\n \n import sphinx\n-from sphinx.ext.autodoc.importer import mock, import_object, get_object_members\n+from sphinx.ext.autodoc import mock\n+from sphinx.ext.autodoc.importer import import_object, get_object_members, get_module_members\n from sphinx.locale import _, __\n from sphinx.pycode import ModuleAnalyzer\n from sphinx.errors import PycodeError\n from sphinx.util import logging\n from sphinx.util import rpartition, force_decode\n from sphinx.util.docstrings import prepare_docstring\n-from sphinx.util.inspect import isdescriptor, safe_getmembers, \\\n+from sphinx.util.inspect import isdescriptor, \\\n     safe_getattr, object_description, is_builtin_class_method, \\\n     isenumattribute, isclassmethod, isstaticmethod, getdoc\n \n@@ -536,7 +537,7 @@ class Documenter(object):\n \n         # add content from docstrings\n         if not no_docstring:\n-            encoding = self.analyzer and self.analyzer.encoding\n+            encoding = self.analyzer and self.analyzer._encoding\n             docstrings = self.get_doc(encoding)\n             if not docstrings:\n                 # append at least a dummy docstring, so that the event\n@@ -882,7 +883,7 @@ class ModuleDocumenter(Documenter):\n             if not hasattr(self.object, '__all__'):\n                 # for implicit module members, check __module__ to avoid\n                 # documenting imported objects\n-                return True, safe_getmembers(self.object)\n+                return True, get_module_members(self.object)\n             else:\n                 memberlist = self.object.__all__\n                 # Sometimes __all__ is broken...\n@@ -893,7 +894,7 @@ class ModuleDocumenter(Documenter):\n                         '(in module %s) -- ignoring __all__' %\n                         (memberlist, self.fullname))\n                     # fall back to all members\n-                    return True, safe_getmembers(self.object)\n+                    return True, get_module_members(self.object)\n         else:\n             memberlist = self.options.members or []\n         ret = []\n```\n",
    "created_at": "2020-04-17T18:13:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403482",
    "user": "https://github.com/antonio-rojas"
}
```

Found the problem, some used sphinx API has been removed. With the attached version the docs compile (still with -k). Next issue: citation links are not working.


```diff
--- a/src/sage_setup/docbuild/__init__.py
+++ b/src/sage_setup/docbuild/__init__.py
@@ -817,9 +817,13 @@ class ReferenceSubBuilder(DocBuilder):
 
         env_pickle = os.path.join(self._doctrees_dir(), 'environment.pickle')
         try:
-            env = BuildEnvironment.frompickle(env_pickle, FakeApp(self.dir))
-            logger.debug("Opened Sphinx environment: %s", env_pickle)
-            return env
+            with open(env_pickle, 'rb') as f:
+                import pickle
+                env = pickle.load(f)
+                env.app = FakeApp(self.dir)
+                env.config.values = env.app.config.values
+                logger.debug("Opened Sphinx environment: %s", env_pickle)
+                return env
         except IOError as err:
             logger.debug("Failed to open Sphinx environment: %s", err)
 
--- a/src/sage/docs/conf.py
+++ b/src/sage/docs/conf.py
@@ -8,6 +8,7 @@ from docutils import nodes
 from docutils.transforms import Transform
 from sphinx.ext.doctest import blankline_re
 from sphinx import highlighting
+import sphinx.ext.intersphinx as intersphinx
 from IPython.lib.lexers import IPythonConsoleLexer, IPyLexer
 
 # If your extensions are in another directory, add it here.
@@ -169,13 +169,8 @@ todo_include_todos = True
 
 # Cross-links to other project's online documentation.
 python_version = sys.version_info.major
-intersphinx_mapping = {
-    'python': ('https://docs.python.org/',
-                os.path.join(SAGE_DOC_SRC, "common",
-                             "python{}.inv".format(python_version))),
-    'pplpy': (PPLPY_DOCS, None)}
 
-def set_intersphinx_mappings(app):
+def set_intersphinx_mappings(app, config):
     """
     Add precompiled inventory (the objects.inv)
     """
@@ -186,7 +182,11 @@ def set_intersphinx_mappings(app):
         app.config.intersphinx_mapping = {}
         return
 
-    app.config.intersphinx_mapping = intersphinx_mapping
+    app.config.intersphinx_mapping =  {
+    'python': ('https://docs.python.org/',
+                os.path.join(SAGE_DOC_SRC, "common",
+                             "python{}.inv".format(python_version))),
+    'pplpy': (PPLPY_DOCS, None)}
 
     # Add master intersphinx mapping
     dst = os.path.join(invpath, 'objects.inv')
@@ -201,6 +201,7 @@ def set_intersphinx_mappings(app):
             dst = os.path.join(invpath, directory, 'objects.inv')
             app.config.intersphinx_mapping[src] = dst
 
+    intersphinx.normalize_intersphinx_mapping(app, config)
 
 # By default document are not master.
 multidocs_is_master = True
@@ -669,7 +672,7 @@ def call_intersphinx(app, env, node, contnode):
     """
     debug_inf(app, "???? Trying intersphinx for %s" % node['reftarget'])
     builder = app.builder
-    res =  sphinx.ext.intersphinx.missing_reference(
+    res =  intersphinx.missing_reference(
         app, env, node, contnode)
     if res:
         # Replace absolute links to $SAGE_DOC by relative links: this
@@ -852,11 +855,10 @@ def setup(app):
     if app.srcdir.startswith(SAGE_DOC_SRC):
         app.add_config_value('intersphinx_mapping', {}, False)
         app.add_config_value('intersphinx_cache_limit', 5, False)
+        app.connect('config-inited', set_intersphinx_mappings)
+        app.connect('builder-inited', intersphinx.load_mappings)
         # We do *not* fully initialize intersphinx since we call it by hand
         # in find_sage_dangling_links.
         #   app.connect('missing-reference', missing_reference)
         app.connect('missing-reference', find_sage_dangling_links)
-        import sphinx.ext.intersphinx
-        app.connect('builder-inited', set_intersphinx_mappings)
-        app.connect('builder-inited', sphinx.ext.intersphinx.load_mappings)
         app.connect('builder-inited', nitpick_patch_config)
--- a/src/sage_setup/docbuild/ext/multidocs.py
+++ b/src/sage_setup/docbuild/ext/multidocs.py
@@ -47,32 +47,39 @@ def merge_environment(app, env):
     - domaindata['py']['modules'] # list of python modules
     """
     logger.info(bold('Merging environment/index files...'))
+    if not hasattr(env, "todo_all_todos"):
+        env.todo_all_todos = []
+    if not env.domaindata["std"].get("citations"):
+        env.domaindata["std"]["citations"] = dict()
     for curdoc in app.env.config.multidocs_subdoc_list:
         logger.info("    %s:"%curdoc, nonl=1)
         docenv = get_env(app, curdoc)
         if docenv is not None:
             fixpath = lambda path: os.path.join(curdoc, path)
+            todos = docenv.todo_all_todos if hasattr(docenv, "todo_all_todos") else []
+            citations = docenv.domaindata["std"].get("citations", dict())
+            indexentries = docenv.domaindata["index"].get("entries", dict())
             logger.info(" %s todos, %s index, %s citations"%(
-                    len(docenv.todo_all_todos),
-                    len(docenv.indexentries),
-                    len(docenv.domaindata["std"]["citations"])
+                    len(todos),
+                    len(indexentries),
+                    len(citations)
                     ), nonl=1)
 
             # merge titles
             for t in docenv.titles:
                 env.titles[fixpath(t)] = docenv.titles[t]
             # merge the todo links
-            for dct in docenv.todo_all_todos:
+            for dct in todos:
                 dct['docname'] = fixpath(dct['docname'])
-            env.todo_all_todos += docenv.todo_all_todos
+            env.todo_all_todos += todos
             # merge the html index links
             newindex = {}
-            for ind in docenv.indexentries:
+            for ind in indexentries:
                 if ind.startswith('sage/'):
-                    newindex[fixpath(ind)] = docenv.indexentries[ind]
+                    newindex[fixpath(ind)] = indexentries[ind]
                 else:
-                    newindex[ind] = docenv.indexentries[ind]
-            env.indexentries.update(newindex)
+                    newindex[ind] = indexentries[ind]
+            env.domaindata['index']['entries'].update(newindex)
             # merge the all_docs links, needed by the js index
             newalldoc = {}
             for ind in docenv.all_docs:
@@ -86,24 +93,23 @@ def merge_environment(app, env):
                 env.metadata[ind] = md
             # merge the citations
             newcite = {}
-            citations = docenv.domaindata["std"]["citations"]
-            for ind, (path, tag, lineno) in six.iteritems(docenv.domaindata["std"]["citations"]):
+            for ind, (path, tag, lineno) in six.iteritems(citations):
                 # TODO: Warn on conflicts
                 newcite[ind] = (fixpath(path), tag, lineno)
-            env.domaindata["std"]["citations"].update(newcite)
+            env.domaindata['std']['citations'].update(newcite)
             # merge the py:module indexes
             newmodules = {}
-            for ind,(modpath,v1,v2,v3) in (
+            for ind,(modpath,v1,v2,v3,v4) in (
                 six.iteritems(docenv.domaindata['py']['modules'])):
-                newmodules[ind] = (fixpath(modpath),v1,v2,v3)
+                newmodules[ind] = (fixpath(modpath),v1,v2,v3,v4)
             env.domaindata['py']['modules'].update(newmodules)
             logger.info(", %s modules"%(len(newmodules)))
     logger.info('... done (%s todos, %s index, %s citations, %s modules)'%(
             len(env.todo_all_todos),
-            len(env.indexentries),
-            len(env.domaindata["std"]["citations"]),
+            len(env.domaindata['index']['entries']),
+            len(env.domaindata['std']['citations']),
             len(env.domaindata['py']['modules'])))
-    write_citations(app, env.domaindata["std"]["citations"])
+    write_citations(app, env.domaindata['std']['citations'])
 
 
 def get_env(app, curdoc):
@@ -253,7 +259,7 @@ def fetch_citation(app, env):
     with open(filename, 'rb') as f:
         cache = cPickle.load(f)
     logger.info("done (%s citations)."%len(cache))
-    cite = env.domaindata["std"]["citations"]
+    cite = env.domaindata["std"].get("citations", dict())
     for ind, (path, tag, lineno) in six.iteritems(cache):
         if ind not in cite: # don't override local citation
             cite[ind] = (os.path.join("..", path), tag, lineno)
--- a/src/sage_setup/docbuild/ext/sage_autodoc.py
+++ b/src/sage_setup/docbuild/ext/sage_autodoc.py
@@ -35,14 +35,15 @@ import sys
 from docutils.statemachine import ViewList
 
 import sphinx
-from sphinx.ext.autodoc.importer import mock, import_object, get_object_members
+from sphinx.ext.autodoc import mock
+from sphinx.ext.autodoc.importer import import_object, get_object_members, get_module_members
 from sphinx.locale import _, __
 from sphinx.pycode import ModuleAnalyzer
 from sphinx.errors import PycodeError
 from sphinx.util import logging
 from sphinx.util import rpartition, force_decode
 from sphinx.util.docstrings import prepare_docstring
-from sphinx.util.inspect import isdescriptor, safe_getmembers, \
+from sphinx.util.inspect import isdescriptor, \
     safe_getattr, object_description, is_builtin_class_method, \
     isenumattribute, isclassmethod, isstaticmethod, getdoc
 
@@ -536,7 +537,7 @@ class Documenter(object):
 
         # add content from docstrings
         if not no_docstring:
-            encoding = self.analyzer and self.analyzer.encoding
+            encoding = self.analyzer and self.analyzer._encoding
             docstrings = self.get_doc(encoding)
             if not docstrings:
                 # append at least a dummy docstring, so that the event
@@ -882,7 +883,7 @@ class ModuleDocumenter(Documenter):
             if not hasattr(self.object, '__all__'):
                 # for implicit module members, check __module__ to avoid
                 # documenting imported objects
-                return True, safe_getmembers(self.object)
+                return True, get_module_members(self.object)
             else:
                 memberlist = self.object.__all__
                 # Sometimes __all__ is broken...
@@ -893,7 +894,7 @@ class ModuleDocumenter(Documenter):
                         '(in module %s) -- ignoring __all__' %
                         (memberlist, self.fullname))
                     # fall back to all members
-                    return True, safe_getmembers(self.object)
+                    return True, get_module_members(self.object)
         else:
             memberlist = self.options.members or []
         ret = []
```




---

archive/issue_comments_403483.json:
```json
{
    "body": "Replying to [comment:30 fbissey]:\n> Well, that's some progress I guess. I think we should move this ticket milestone to 9.2 and make it \"upgrade to sphinx 3\", that would be more honest because I don't think we can keep it compatible with sphinx-1.8 at the same time.\n\nThat seems totally reasonable to me - it's too late for 9.1, and I hope nobody will object to move on to py3-only for 9.2",
    "created_at": "2020-04-17T18:14:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403483",
    "user": "https://github.com/antonio-rojas"
}
```

Replying to [comment:30 fbissey]:
> Well, that's some progress I guess. I think we should move this ticket milestone to 9.2 and make it "upgrade to sphinx 3", that would be more honest because I don't think we can keep it compatible with sphinx-1.8 at the same time.

That seems totally reasonable to me - it's too late for 9.1, and I hope nobody will object to move on to py3-only for 9.2



---

archive/issue_comments_403484.json:
```json
{
    "body": "I've pushed the current status to the branch. This now builds fine with -k, including references and citations.\n\nIt remains to figure out the `WARNING: duplicate object description` so it builds without -k (or decide that it's not important and whitelist the warning)\n----\nNew commits:",
    "created_at": "2020-04-19T10:24:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403484",
    "user": "https://github.com/antonio-rojas"
}
```

I've pushed the current status to the branch. This now builds fine with -k, including references and citations.

It remains to figure out the `WARNING: duplicate object description` so it builds without -k (or decide that it's not important and whitelist the warning)
----
New commits:



---

archive/issue_comments_403485.json:
```json
{
    "body": "Replying to [comment:35 arojas]:\n> It remains to figure out the `WARNING: duplicate object description` so it builds without -k (or decide that it's not important and whitelist the warning)\n\nThe methods `left_action_product` and `right_action_product` actually do appear twice in [the documentation](https://doc.sagemath.org/html/en/reference/combinat/sage/combinat/permutation.html), which is caused by this block:\n\n```\n    .. automethod:: Permutation.left_action_product\n    .. automethod:: Permutation.right_action_product\n```\n\nIn the past, this block was referencing private functions `_left_to_right_multiply_on_right`/`_left_to_right_multiply_on_left`, so the `automethod` directive was used to make those underscore functions appear in the documentation. Since these functions are not private anymore and appear in the documentation by default, this block is not needed anymore and removing it should solve the problem I hope.",
    "created_at": "2020-04-19T11:00:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403485",
    "user": "https://github.com/mwageringel"
}
```

Replying to [comment:35 arojas]:
> It remains to figure out the `WARNING: duplicate object description` so it builds without -k (or decide that it's not important and whitelist the warning)

The methods `left_action_product` and `right_action_product` actually do appear twice in [the documentation](https://doc.sagemath.org/html/en/reference/combinat/sage/combinat/permutation.html), which is caused by this block:

```
    .. automethod:: Permutation.left_action_product
    .. automethod:: Permutation.right_action_product
```

In the past, this block was referencing private functions `_left_to_right_multiply_on_right`/`_left_to_right_multiply_on_left`, so the `automethod` directive was used to make those underscore functions appear in the documentation. Since these functions are not private anymore and appear in the documentation by default, this block is not needed anymore and removing it should solve the problem I hope.



---

archive/issue_comments_403486.json:
```json
{
    "body": "Removing those lines does indeed fix this warning. But then compilation stops a while later with another warning:\n\n```\nOSError: /build/sagemath-doc/src/sage-9.0/src/doc/en/thematic_tutorials/structures_in_coding_theory.rst:722: WARNING: Could not lex literal_block as \"python\". Highlighting skipped.\n```\n",
    "created_at": "2020-04-19T12:03:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403486",
    "user": "https://github.com/antonio-rojas"
}
```

Removing those lines does indeed fix this warning. But then compilation stops a while later with another warning:

```
OSError: /build/sagemath-doc/src/sage-9.0/src/doc/en/thematic_tutorials/structures_in_coding_theory.rst:722: WARNING: Could not lex literal_block as "python". Highlighting skipped.
```




---

archive/issue_comments_403487.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-04-19T12:06:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403487",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_403488.json:
```json
{
    "body": "Thanks for the patch. I tried it with sphinx 2.4.3 which is what we have in Debian now.\nIt failed with the following error:\n\n\n```\n[dochtml] [reference] Merging environment/index files...\n[dochtml] [reference] Exception occurred:\n[dochtml] [reference]   File \"/home/thansen/src/sage/sagemath/sagemath/sage/src/sage_setup/docbuild/ext/multidocs.py\", line 105, in merge_environment\n[dochtml] [reference]     for ind,(modpath,v1,v2,v3,v4) in (\n[dochtml] [reference] ValueError: not enough values to unpack (expected 5, got 4)\n```\n\n\nDo I have to change anything for sphinx 2.4? Which command are you running with -k?",
    "created_at": "2020-04-19T13:49:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403488",
    "user": "https://github.com/tobihan"
}
```

Thanks for the patch. I tried it with sphinx 2.4.3 which is what we have in Debian now.
It failed with the following error:


```
[dochtml] [reference] Merging environment/index files...
[dochtml] [reference] Exception occurred:
[dochtml] [reference]   File "/home/thansen/src/sage/sagemath/sagemath/sage/src/sage_setup/docbuild/ext/multidocs.py", line 105, in merge_environment
[dochtml] [reference]     for ind,(modpath,v1,v2,v3,v4) in (
[dochtml] [reference] ValueError: not enough values to unpack (expected 5, got 4)
```


Do I have to change anything for sphinx 2.4? Which command are you running with -k?



---

archive/issue_comments_403489.json:
```json
{
    "body": "Replying to [comment:39 thansen]:\n> Thanks for the patch. I tried it with sphinx 2.4.3 which is what we have in Debian now.\n> It failed with the following error:\n> \n> {{{\n> [dochtml] [reference] Merging environment/index files...\n> [dochtml] [reference] Exception occurred:\n> [dochtml] [reference]   File \"/home/thansen/src/sage/sagemath/sagemath/sage/src/sage_setup/docbuild/ext/multidocs.py\", line 105, in merge_environment\n> [dochtml] [reference]     for ind,(modpath,v1,v2,v3,v4) in (\n> [dochtml] [reference] ValueError: not enough values to unpack (expected 5, got 4)\n> }}}\n> \n> Do I have to change anything for sphinx 2.4? Which command are you running with -k?\n\n\nYes, the relevant sphinx change [1] is only in 3.x. For 2.4, remove the two line changes adding the `v4` parameter from the patch.\n\nThe command I'm using to build the docs is `python sage_setup/docbuild --no-pdf-links --mathjax all html -k`\n\n[1] https://github.com/sphinx-doc/sphinx/commit/5ff3b9dc4d07b5c324680e17b2aeaa298e619a9a",
    "created_at": "2020-04-19T14:19:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403489",
    "user": "https://github.com/antonio-rojas"
}
```

Replying to [comment:39 thansen]:
> Thanks for the patch. I tried it with sphinx 2.4.3 which is what we have in Debian now.
> It failed with the following error:
> 
> {{{
> [dochtml] [reference] Merging environment/index files...
> [dochtml] [reference] Exception occurred:
> [dochtml] [reference]   File "/home/thansen/src/sage/sagemath/sagemath/sage/src/sage_setup/docbuild/ext/multidocs.py", line 105, in merge_environment
> [dochtml] [reference]     for ind,(modpath,v1,v2,v3,v4) in (
> [dochtml] [reference] ValueError: not enough values to unpack (expected 5, got 4)
> }}}
> 
> Do I have to change anything for sphinx 2.4? Which command are you running with -k?


Yes, the relevant sphinx change [1] is only in 3.x. For 2.4, remove the two line changes adding the `v4` parameter from the patch.

The command I'm using to build the docs is `python sage_setup/docbuild --no-pdf-links --mathjax all html -k`

[1] https://github.com/sphinx-doc/sphinx/commit/5ff3b9dc4d07b5c324680e17b2aeaa298e619a9a



---

archive/issue_comments_403490.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-04-19T21:28:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403490",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_403491.json:
```json
{
    "body": "I see the `WARNING: Could not lex literal_block as \"python\"` issue already came up in https://groups.google.com/forum/#!msg/sage-release/xcGXMuHuEOw/eqISWOiDAAAJ but, in that case, it affected python2 only.",
    "created_at": "2020-04-20T09:52:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403491",
    "user": "https://github.com/antonio-rojas"
}
```

I see the `WARNING: Could not lex literal_block as "python"` issue already came up in https://groups.google.com/forum/#!msg/sage-release/xcGXMuHuEOw/eqISWOiDAAAJ but, in that case, it affected python2 only.



---

archive/issue_comments_403492.json:
```json
{
    "body": "With Sphinx 3.0.2 I see\n\n```\nBuilding reference manual, first pass.\n\n[reference] Exception occurred:\n[reference]   File \"/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.1.rc0/local/lib/python3.7/site-packages/matplotlib/sphinxext/plot_directive.py\", line 268, in setup\n[reference]     app.add_directive('plot', plot_directive, True, (0, 2, False), **options)\n[reference] TypeError: add_directive() got an unexpected keyword argument 'alt'\n```\n\nThis is coming from matplotlib 2.2.4. Do I need to upgrade matplotlib?\n\nBy the way, to install the new version of Sphinx in Sage, we need to add some other packages: `sphinxcontrib-applehelp` and about 5 others.",
    "created_at": "2020-04-20T21:48:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403492",
    "user": "https://github.com/jhpalmieri"
}
```

With Sphinx 3.0.2 I see

```
Building reference manual, first pass.

[reference] Exception occurred:
[reference]   File "/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.1.rc0/local/lib/python3.7/site-packages/matplotlib/sphinxext/plot_directive.py", line 268, in setup
[reference]     app.add_directive('plot', plot_directive, True, (0, 2, False), **options)
[reference] TypeError: add_directive() got an unexpected keyword argument 'alt'
```

This is coming from matplotlib 2.2.4. Do I need to upgrade matplotlib?

By the way, to install the new version of Sphinx in Sage, we need to add some other packages: `sphinxcontrib-applehelp` and about 5 others.



---

archive/issue_comments_403493.json:
```json
{
    "body": "To answer my own question: upgrading matplotlib helps.",
    "created_at": "2020-04-20T21:59:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403493",
    "user": "https://github.com/jhpalmieri"
}
```

To answer my own question: upgrading matplotlib helps.



---

archive/issue_comments_403494.json:
```json
{
    "body": "I'm now seeing another issue:\n\n```\n[plotting ] /Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.1.rc0/local/lib/python3.7/site-packages/sage/plot/contour_plot.py:docstring of sage.plot.contour_plot.contour_plot:438: WARNING: Exception occurred in plotting contour_plot-24\n[plotting ]  from /Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.1.rc0/src/doc/en/reference/plotting/sage/plot/contour_plot.rst:\n[plotting ] Traceback (most recent call last):\n[plotting ]   File \"/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.1.rc0/local/lib/python3.7/site-packages/matplotlib/sphinxext/plot_directive.py\", line 484, in run_code\n[plotting ]     exec(code, ns)\n[plotting ]   File \"<string>\", line 4, in <module>\n[plotting ]   File \"<string>\", line 28, in sphinx_plot\n[plotting ]   File \"/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.1.rc0/local/lib/python3.7/site-packages/sage/plot/graphics.py\", line 2778, in matplotlib\n[plotting ]     g._render_on_subplot(subplot)\n[plotting ]   File \"/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.1.rc0/local/lib/python3.7/site-packages/sage/plot/contour_plot.py\", line 222, in _render_on_subplot\n[plotting ]     cb = colorbar.Colorbar(cax, CSF, **kwds)\n[plotting ]   File \"/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.1.rc0/local/lib/python3.7/site-packages/matplotlib/colorbar.py\", line 1220, in __init__\n[plotting ]     ColorbarBase.__init__(self, ax, **kw)\n[plotting ]   File \"/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.1.rc0/local/lib/python3.7/site-packages/matplotlib/colorbar.py\", line 459, in __init__\n[plotting ]     ['uniform', 'proportional'], spacing=spacing)\n[plotting ]   File \"/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.1.rc0/local/lib/python3.7/site-packages/matplotlib/cbook/__init__.py\", line 2145, in _check_in_list\n[plotting ]     .format(v, k, ', '.join(map(repr, values))))\n[plotting ] ValueError: None is not a valid value for spacing; supported values are 'uniform', 'proportional'\n```\n",
    "created_at": "2020-04-20T23:00:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403494",
    "user": "https://github.com/jhpalmieri"
}
```

I'm now seeing another issue:

```
[plotting ] /Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.1.rc0/local/lib/python3.7/site-packages/sage/plot/contour_plot.py:docstring of sage.plot.contour_plot.contour_plot:438: WARNING: Exception occurred in plotting contour_plot-24
[plotting ]  from /Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.1.rc0/src/doc/en/reference/plotting/sage/plot/contour_plot.rst:
[plotting ] Traceback (most recent call last):
[plotting ]   File "/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.1.rc0/local/lib/python3.7/site-packages/matplotlib/sphinxext/plot_directive.py", line 484, in run_code
[plotting ]     exec(code, ns)
[plotting ]   File "<string>", line 4, in <module>
[plotting ]   File "<string>", line 28, in sphinx_plot
[plotting ]   File "/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.1.rc0/local/lib/python3.7/site-packages/sage/plot/graphics.py", line 2778, in matplotlib
[plotting ]     g._render_on_subplot(subplot)
[plotting ]   File "/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.1.rc0/local/lib/python3.7/site-packages/sage/plot/contour_plot.py", line 222, in _render_on_subplot
[plotting ]     cb = colorbar.Colorbar(cax, CSF, **kwds)
[plotting ]   File "/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.1.rc0/local/lib/python3.7/site-packages/matplotlib/colorbar.py", line 1220, in __init__
[plotting ]     ColorbarBase.__init__(self, ax, **kw)
[plotting ]   File "/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.1.rc0/local/lib/python3.7/site-packages/matplotlib/colorbar.py", line 459, in __init__
[plotting ]     ['uniform', 'proportional'], spacing=spacing)
[plotting ]   File "/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.1.rc0/local/lib/python3.7/site-packages/matplotlib/cbook/__init__.py", line 2145, in _check_in_list
[plotting ]     .format(v, k, ', '.join(map(repr, values))))
[plotting ] ValueError: None is not a valid value for spacing; supported values are 'uniform', 'proportional'
```




---

archive/issue_comments_403495.json:
```json
{
    "body": "Which version of matplotlib did you go for? I think arch has stuff for 3.2+ but 3.1 should be OK.",
    "created_at": "2020-04-20T23:20:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403495",
    "user": "https://github.com/kiwifb"
}
```

Which version of matplotlib did you go for? I think arch has stuff for 3.2+ but 3.1 should be OK.



---

archive/issue_comments_403496.json:
```json
{
    "body": "#29444\tupgraded matplotlib to 2.2.5, which is the last release supporting py2. Am I right that this ticket is for 9.2, in which we drop python 3 support?",
    "created_at": "2020-04-21T00:40:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403496",
    "user": "https://github.com/mkoeppe"
}
```

#29444	upgraded matplotlib to 2.2.5, which is the last release supporting py2. Am I right that this ticket is for 9.2, in which we drop python 3 support?



---

archive/issue_comments_403497.json:
```json
{
    "body": "Replying to [comment:46 fbissey]:\n> Which version of matplotlib did you go for? I think arch has stuff for 3.2+ but 3.1 should be OK.\nI upgraded to 3.2.1 (within Sage).",
    "created_at": "2020-04-21T00:56:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403497",
    "user": "https://github.com/jhpalmieri"
}
```

Replying to [comment:46 fbissey]:
> Which version of matplotlib did you go for? I think arch has stuff for 3.2+ but 3.1 should be OK.
I upgraded to 3.2.1 (within Sage).



---

archive/issue_comments_403498.json:
```json
{
    "body": "Replying to [comment:47 mkoeppe]:\n> #29444\tupgraded matplotlib to 2.2.5, which is the last release supporting py2. Am I right that this ticket is for 9.2, in which we drop python 3 support?\n\nYes, I think it has to be.",
    "created_at": "2020-04-21T00:56:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403498",
    "user": "https://github.com/jhpalmieri"
}
```

Replying to [comment:47 mkoeppe]:
> #29444	upgraded matplotlib to 2.2.5, which is the last release supporting py2. Am I right that this ticket is for 9.2, in which we drop python 3 support?

Yes, I think it has to be.



---

archive/issue_events_072986.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-04-21T01:06:32Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "milestone": "sage-9.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28619#event-72986"
}
```



---

archive/issue_events_072987.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-04-21T01:06:32Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "milestone": "sage-9.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28619#event-72987"
}
```



---

archive/issue_comments_403499.json:
```json
{
    "body": "Replying to [comment:45 jhpalmieri]:\n> I'm now seeing another issue:\n> {{{\n> [plotting ] /Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.1.rc0/local/lib/python3.7/site-packages/sage/plot/contour_plot.py:docstring of sage.plot.contour_plot.contour_plot:438: WARNING: Exception occurred in plotting contour_plot-24\n> [plotting ]  from /Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.1.rc0/src/doc/en/reference/plotting/sage/plot/contour_plot.rst:\n> [plotting ] Traceback (most recent call last):\n> [plotting ]   File \"/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.1.rc0/local/lib/python3.7/site-packages/matplotlib/sphinxext/plot_directive.py\", line 484, in run_code\n> [plotting ]     exec(code, ns)\n> [plotting ]   File \"<string>\", line 4, in <module>\n> [plotting ]   File \"<string>\", line 28, in sphinx_plot\n> [plotting ]   File \"/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.1.rc0/local/lib/python3.7/site-packages/sage/plot/graphics.py\", line 2778, in matplotlib\n> [plotting ]     g._render_on_subplot(subplot)\n> [plotting ]   File \"/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.1.rc0/local/lib/python3.7/site-packages/sage/plot/contour_plot.py\", line 222, in _render_on_subplot\n> [plotting ]     cb = colorbar.Colorbar(cax, CSF, **kwds)\n> [plotting ]   File \"/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.1.rc0/local/lib/python3.7/site-packages/matplotlib/colorbar.py\", line 1220, in __init__\n> [plotting ]     ColorbarBase.__init__(self, ax, **kw)\n> [plotting ]   File \"/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.1.rc0/local/lib/python3.7/site-packages/matplotlib/colorbar.py\", line 459, in __init__\n> [plotting ]     ['uniform', 'proportional'], spacing=spacing)\n> [plotting ]   File \"/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.1.rc0/local/lib/python3.7/site-packages/matplotlib/cbook/__init__.py\", line 2145, in _check_in_list\n> [plotting ]     .format(v, k, ', '.join(map(repr, values))))\n> [plotting ] ValueError: None is not a valid value for spacing; supported values are 'uniform', 'proportional'\n> }}}\n\nYou need another patch for matplotlib 3.2: https://git.archlinux.org/svntogit/community.git/tree/trunk/sagemath-matplotlib-3.2.patch?h=packages/sagemath",
    "created_at": "2020-04-21T06:54:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403499",
    "user": "https://github.com/antonio-rojas"
}
```

Replying to [comment:45 jhpalmieri]:
> I'm now seeing another issue:
> {{{
> [plotting ] /Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.1.rc0/local/lib/python3.7/site-packages/sage/plot/contour_plot.py:docstring of sage.plot.contour_plot.contour_plot:438: WARNING: Exception occurred in plotting contour_plot-24
> [plotting ]  from /Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.1.rc0/src/doc/en/reference/plotting/sage/plot/contour_plot.rst:
> [plotting ] Traceback (most recent call last):
> [plotting ]   File "/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.1.rc0/local/lib/python3.7/site-packages/matplotlib/sphinxext/plot_directive.py", line 484, in run_code
> [plotting ]     exec(code, ns)
> [plotting ]   File "<string>", line 4, in <module>
> [plotting ]   File "<string>", line 28, in sphinx_plot
> [plotting ]   File "/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.1.rc0/local/lib/python3.7/site-packages/sage/plot/graphics.py", line 2778, in matplotlib
> [plotting ]     g._render_on_subplot(subplot)
> [plotting ]   File "/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.1.rc0/local/lib/python3.7/site-packages/sage/plot/contour_plot.py", line 222, in _render_on_subplot
> [plotting ]     cb = colorbar.Colorbar(cax, CSF, **kwds)
> [plotting ]   File "/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.1.rc0/local/lib/python3.7/site-packages/matplotlib/colorbar.py", line 1220, in __init__
> [plotting ]     ColorbarBase.__init__(self, ax, **kw)
> [plotting ]   File "/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.1.rc0/local/lib/python3.7/site-packages/matplotlib/colorbar.py", line 459, in __init__
> [plotting ]     ['uniform', 'proportional'], spacing=spacing)
> [plotting ]   File "/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.1.rc0/local/lib/python3.7/site-packages/matplotlib/cbook/__init__.py", line 2145, in _check_in_list
> [plotting ]     .format(v, k, ', '.join(map(repr, values))))
> [plotting ] ValueError: None is not a valid value for spacing; supported values are 'uniform', 'proportional'
> }}}

You need another patch for matplotlib 3.2: https://git.archlinux.org/svntogit/community.git/tree/trunk/sagemath-matplotlib-3.2.patch?h=packages/sagemath



---

archive/issue_comments_403500.json:
```json
{
    "body": "The remaining warning comes from the lines\n\n```\n.. CODE-BLOCK:: python\n\n    :class:`sage.coding.repetition_code.BinaryRepetitionCode <sage.coding.repetition_code.BinaryRepetitionCode>`\n    #the line above creates a link to the class in the html documentation of coding theory library\n    from sage.coding.repetition_code import BinaryRepetitionCode\n```\n\nin `structures_in_coding_theory.rst`. This is because the backtick is no longer valid syntax in python3.\n\nI don't understand what this code block is meant to do. In the python2 version, it displayed a code block with those three lines, which doesn't make much sense to me (the first line is not python code). Perhaps the link to the class is meant to be outside the code block? (which still doesn't make sense to me in the overall context of the page)",
    "created_at": "2020-04-21T07:00:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403500",
    "user": "https://github.com/antonio-rojas"
}
```

The remaining warning comes from the lines

```
.. CODE-BLOCK:: python

    :class:`sage.coding.repetition_code.BinaryRepetitionCode <sage.coding.repetition_code.BinaryRepetitionCode>`
    #the line above creates a link to the class in the html documentation of coding theory library
    from sage.coding.repetition_code import BinaryRepetitionCode
```

in `structures_in_coding_theory.rst`. This is because the backtick is no longer valid syntax in python3.

I don't understand what this code block is meant to do. In the python2 version, it displayed a code block with those three lines, which doesn't make much sense to me (the first line is not python code). Perhaps the link to the class is meant to be outside the code block? (which still doesn't make sense to me in the overall context of the page)



---

archive/issue_comments_403501.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-04-21T10:14:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403501",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_403502.json:
```json
{
    "body": "Nice little commit. So far building without `-k` and I passed the point where it would have bailed out because of missing citations in `[tensor_fr]`. But `citation` and `citations`, we have to be careful not to get too confused.",
    "created_at": "2020-04-21T10:59:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403502",
    "user": "https://github.com/kiwifb"
}
```

Nice little commit. So far building without `-k` and I passed the point where it would have bailed out because of missing citations in `[tensor_fr]`. But `citation` and `citations`, we have to be careful not to get too confused.



---

archive/issue_comments_403503.json:
```json
{
    "body": "But bail out at `structures_in_coding_theory.rst` as should have been expected. Until that one is sorted we still need the `-k`.",
    "created_at": "2020-04-21T11:04:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403503",
    "user": "https://github.com/kiwifb"
}
```

But bail out at `structures_in_coding_theory.rst` as should have been expected. Until that one is sorted we still need the `-k`.



---

archive/issue_comments_403504.json:
```json
{
    "body": "For now I'm removing the first two lines of the affected code block downstream until someone clears that up. Doesn't seem much of a loss. After that it builds fine without `-k`",
    "created_at": "2020-04-21T11:07:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403504",
    "user": "https://github.com/antonio-rojas"
}
```

For now I'm removing the first two lines of the affected code block downstream until someone clears that up. Doesn't seem much of a loss. After that it builds fine without `-k`



---

archive/issue_comments_403505.json:
```json
{
    "body": "FTR, this was marked as a python code block in #27549",
    "created_at": "2020-04-21T11:33:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403505",
    "user": "https://github.com/antonio-rojas"
}
```

FTR, this was marked as a python code block in #27549



---

archive/issue_comments_403506.json:
```json
{
    "body": "I think it's fine to delete the first two lines of that code block.",
    "created_at": "2020-04-21T16:15:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403506",
    "user": "https://github.com/jhpalmieri"
}
```

I think it's fine to delete the first two lines of that code block.



---

archive/issue_comments_403507.json:
```json
{
    "body": "Replying to [comment:51 arojas]:\n> You need another patch for matplotlib 3.2: https://git.archlinux.org/svntogit/community.git/tree/trunk/sagemath-matplotlib-3.2.patch?h=packages/sagemath\n\nThanks, that works.\n\nNow I'm seeing a ton of messages like\n\n```\nWARNING: citation not found: BM2012\n```\n\nwhich causes the build to fail unless I use `-k`.",
    "created_at": "2020-04-21T16:40:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403507",
    "user": "https://github.com/jhpalmieri"
}
```

Replying to [comment:51 arojas]:
> You need another patch for matplotlib 3.2: https://git.archlinux.org/svntogit/community.git/tree/trunk/sagemath-matplotlib-3.2.patch?h=packages/sagemath

Thanks, that works.

Now I'm seeing a ton of messages like

```
WARNING: citation not found: BM2012
```

which causes the build to fail unless I use `-k`.



---

archive/issue_comments_403508.json:
```json
{
    "body": "Replying to [comment:59 jhpalmieri]:\n> Replying to [comment:51 arojas]:\n> > You need another patch for matplotlib 3.2: https://git.archlinux.org/svntogit/community.git/tree/trunk/sagemath-matplotlib-3.2.patch?h=packages/sagemath\n> \n> Thanks, that works.\n> \n> Now I'm seeing a ton of messages like\n> {{{\n> WARNING: citation not found: BM2012\n> }}}\n> which causes the build to fail unless I use `-k`.\n\nDid you pull the latest commit?",
    "created_at": "2020-04-21T16:41:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403508",
    "user": "https://github.com/antonio-rojas"
}
```

Replying to [comment:59 jhpalmieri]:
> Replying to [comment:51 arojas]:
> > You need another patch for matplotlib 3.2: https://git.archlinux.org/svntogit/community.git/tree/trunk/sagemath-matplotlib-3.2.patch?h=packages/sagemath
> 
> Thanks, that works.
> 
> Now I'm seeing a ton of messages like
> {{{
> WARNING: citation not found: BM2012
> }}}
> which causes the build to fail unless I use `-k`.

Did you pull the latest commit?



---

archive/issue_comments_403509.json:
```json
{
    "body": "Replying to [comment:60 arojas]:\n> Replying to [comment:59 jhpalmieri]:\n> > Replying to [comment:51 arojas]:\n> > > You need another patch for matplotlib 3.2: https://git.archlinux.org/svntogit/community.git/tree/trunk/sagemath-matplotlib-3.2.patch?h=packages/sagemath\n> > \n> > Thanks, that works.\n> > \n> > Now I'm seeing a ton of messages like\n> > {{{\n> > WARNING: citation not found: BM2012\n> > }}}\n> > which causes the build to fail unless I use `-k`.\n> \n> Did you pull the latest commit?\n\nI'm sorry, no. I meant to and then started having computer problems, which distracted me. With the latest commit, everything builds!",
    "created_at": "2020-04-21T16:56:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403509",
    "user": "https://github.com/jhpalmieri"
}
```

Replying to [comment:60 arojas]:
> Replying to [comment:59 jhpalmieri]:
> > Replying to [comment:51 arojas]:
> > > You need another patch for matplotlib 3.2: https://git.archlinux.org/svntogit/community.git/tree/trunk/sagemath-matplotlib-3.2.patch?h=packages/sagemath
> > 
> > Thanks, that works.
> > 
> > Now I'm seeing a ton of messages like
> > {{{
> > WARNING: citation not found: BM2012
> > }}}
> > which causes the build to fail unless I use `-k`.
> 
> Did you pull the latest commit?

I'm sorry, no. I meant to and then started having computer problems, which distracted me. With the latest commit, everything builds!



---

archive/issue_comments_403510.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-04-21T17:01:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403510",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_403511.json:
```json
{
    "body": "It remains to sort out the Sage packaging side: add the missing sphinx dependencies, open a ticket to upgrade matplotlib and make it a dependency of this one. I'll leave that to someone else, I've had enough of this ticket for a while.",
    "created_at": "2020-04-21T17:06:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403511",
    "user": "https://github.com/antonio-rojas"
}
```

It remains to sort out the Sage packaging side: add the missing sphinx dependencies, open a ticket to upgrade matplotlib and make it a dependency of this one. I'll leave that to someone else, I've had enough of this ticket for a while.



---

archive/issue_comments_403512.json:
```json
{
    "body": "Replying to [comment:63 arojas]:\n> It remains to sort out the Sage packaging side: add the missing sphinx dependencies, open a ticket to upgrade matplotlib and make it a dependency of this one. I'll leave that to someone else, I've had enough of this ticket for a while.\n\nThat's fine, you did a good job here and we in distros are now ready to tackle 9.1 in python3 only. Thank you very much for your work here.\n\nI should be able to find time to shepherd the rest in early 9.2.",
    "created_at": "2020-04-21T19:55:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403512",
    "user": "https://github.com/kiwifb"
}
```

Replying to [comment:63 arojas]:
> It remains to sort out the Sage packaging side: add the missing sphinx dependencies, open a ticket to upgrade matplotlib and make it a dependency of this one. I'll leave that to someone else, I've had enough of this ticket for a while.

That's fine, you did a good job here and we in distros are now ready to tackle 9.1 in python3 only. Thank you very much for your work here.

I should be able to find time to shepherd the rest in early 9.2.



---

archive/issue_comments_403513.json:
```json
{
    "body": "`@`jhpalmieri do you have something ready for `matplotlib` or should I go ahead with a new ticket and branch?",
    "created_at": "2020-04-21T21:58:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403513",
    "user": "https://github.com/kiwifb"
}
```

`@`jhpalmieri do you have something ready for `matplotlib` or should I go ahead with a new ticket and branch?



---

archive/issue_comments_403514.json:
```json
{
    "body": "I am going to add the following `sphinxcontrib` packages following the dependencies of the Gentoo ebuild\n* `sphinxcontrib-applehelp`\n* `sphinxcontrib-devhelp`\n* `sphinxcontrib-jsmath`\n* `sphinxcontrib-htmlhelp`\n* `sphinxcontrib-serializinghtml`\n* `sphinxcontrib-qthelp`\n\nwhich should cover `@`jhpalmieri's remark about needing 6 new `sphinxcontrib` packages. Did anyone identify something else missing from the current list of sage packages?",
    "created_at": "2020-04-21T22:12:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403514",
    "user": "https://github.com/kiwifb"
}
```

I am going to add the following `sphinxcontrib` packages following the dependencies of the Gentoo ebuild
* `sphinxcontrib-applehelp`
* `sphinxcontrib-devhelp`
* `sphinxcontrib-jsmath`
* `sphinxcontrib-htmlhelp`
* `sphinxcontrib-serializinghtml`
* `sphinxcontrib-qthelp`

which should cover `@`jhpalmieri's remark about needing 6 new `sphinxcontrib` packages. Did anyone identify something else missing from the current list of sage packages?



---

archive/issue_comments_403515.json:
```json
{
    "body": "Those are the ones. With those, Sphinx 3.0.2 builds for me with Sage 9.1.rc0 (py3) on OS X.",
    "created_at": "2020-04-21T22:36:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403515",
    "user": "https://github.com/jhpalmieri"
}
```

Those are the ones. With those, Sphinx 3.0.2 builds for me with Sage 9.1.rc0 (py3) on OS X.



---

archive/issue_comments_403516.json:
```json
{
    "body": "Replying to [comment:65 fbissey]:\n> `@`jhpalmieri do you have something ready for `matplotlib` or should I go ahead with a new ticket and branch?\n\nI can open up a ticket. I have a version which builds, but I haven't run doctests yet.\n\nEdit: #29547",
    "created_at": "2020-04-21T22:36:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403516",
    "user": "https://github.com/jhpalmieri"
}
```

Replying to [comment:65 fbissey]:
> `@`jhpalmieri do you have something ready for `matplotlib` or should I go ahead with a new ticket and branch?

I can open up a ticket. I have a version which builds, but I haven't run doctests yet.

Edit: #29547



---

archive/issue_comments_403517.json:
```json
{
    "body": "Darn, we are still on 3.0.1. I'll bump to 3.0.2 while I am at it. Do open the ticket for the new matplotlib. We do know that some doctests needs fixing from 3.1 onwards. I'll fill the details on #29547 if it is not there already.",
    "created_at": "2020-04-21T22:41:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403517",
    "user": "https://github.com/kiwifb"
}
```

Darn, we are still on 3.0.1. I'll bump to 3.0.2 while I am at it. Do open the ticket for the new matplotlib. We do know that some doctests needs fixing from 3.1 onwards. I'll fill the details on #29547 if it is not there already.



---

archive/issue_comments_403518.json:
```json
{
    "body": "Branch with sphinx 3.0.2 and all new packages.\n----\nNew commits:",
    "created_at": "2020-04-21T23:18:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403518",
    "user": "https://github.com/kiwifb"
}
```

Branch with sphinx 3.0.2 and all new packages.
----
New commits:



---

archive/issue_comments_403519.json:
```json
{
    "body": "Ready for review?",
    "created_at": "2020-04-22T02:45:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403519",
    "user": "https://github.com/jhpalmieri"
}
```

Ready for review?



---

archive/issue_comments_403520.json:
```json
{
    "body": "I'd say. I haven't tested everything in vanilla sage but this builds on sage-on-gentoo and presumably sage-on-arch [with sphinx 3.0.1 in gentoo so we could find an issue]. My packaging needs to be checked.",
    "created_at": "2020-04-22T02:52:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403520",
    "user": "https://github.com/kiwifb"
}
```

I'd say. I haven't tested everything in vanilla sage but this builds on sage-on-gentoo and presumably sage-on-arch [with sphinx 3.0.1 in gentoo so we could find an issue]. My packaging needs to be checked.



---

archive/issue_comments_403521.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2020-04-22T03:16:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403521",
    "user": "https://github.com/kiwifb"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_403522.json:
```json
{
    "body": "It builds for me on OS X (with some homebrew packages).",
    "created_at": "2020-04-22T04:38:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403522",
    "user": "https://github.com/jhpalmieri"
}
```

It builds for me on OS X (with some homebrew packages).



---

archive/issue_comments_403523.json:
```json
{
    "body": "I get two doctest failures (this is combined with #29547):\n\n```\nsage -t --long --warn-long 80.3 src/sage/misc/sagedoc.py\n**********************************************************************\nFile \"src/sage/misc/sagedoc.py\", line 23, in sage.misc.sagedoc\nFailed example:\n    with open(docfilename) as fobj:  # optional - dochtml\n        for line in fobj:\n            if \"#sage.symbolic.expression.Expression.numerical_approx\" in line:\n                print(line)\nExpected:\n    <code class=\"descname\">numerical_approx</code><span class=\"sig-paren\">(</span><em>prec=None</em>, <em>digits=None</em>, <em>algorithm=None</em><span class=\"sig-paren\">)</span>...\nGot:\n    <code class=\"sig-name descname\">numerical_approx</code><span class=\"sig-paren\">(</span><em class=\"sig-param\"><span class=\"n\">prec</span><span class=\"o\">=</span><span class=\"default_value\">None</span></em>, <em class=\"sig-param\"><span class=\"n\">digits</span><span class=\"o\">=</span><span class=\"default_value\">None</span></em>, <em class=\"sig-param\"><span class=\"n\">algorithm</span><span class=\"o\">=</span><span class=\"default_value\">None</span></em><span class=\"sig-paren\">)</span><a class=\"headerlink\" href=\"#sage.symbolic.expression.Expression.numerical_approx\" title=\"Permalink to this definition\">\u00b6</a></dt>\n    <BLANKLINE>\n```\n\nand\n\n```\nsage -t --long --warn-long 80.3 src/sage/docs/conf.py\n**********************************************************************\nFile \"src/sage/docs/conf.py\", line 666, in sage.docs.conf.call_intersphinx\nFailed example:\n    for line in open(thematic_index).readlines():  # optional - dochtml\n        if \"padics\" in line:\n            _ = sys.stdout.write(line)\nExpected:\n    <li><a class=\"reference external\" href=\"../reference/padics/sage/rings/padics/tutorial.html#sage-rings-padics-tutorial\" title=\"(in Sage... Reference Manual: p-Adics v...)\"><span>Introduction to the p-adics</span></a></li>\nGot:\n    <li><p><a class=\"reference external\" href=\"../reference/padics/sage/rings/padics/tutorial.html#sage-rings-padics-tutorial\" title=\"(in Sage 9.1.rc0 Reference Manual: p-Adics v9.1.rc0)\"><span>Introduction to the p-adics</span></a></p></li>\n```\n\nThey don't look hard to fix.",
    "created_at": "2020-04-22T05:27:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403523",
    "user": "https://github.com/jhpalmieri"
}
```

I get two doctest failures (this is combined with #29547):

```
sage -t --long --warn-long 80.3 src/sage/misc/sagedoc.py
**********************************************************************
File "src/sage/misc/sagedoc.py", line 23, in sage.misc.sagedoc
Failed example:
    with open(docfilename) as fobj:  # optional - dochtml
        for line in fobj:
            if "#sage.symbolic.expression.Expression.numerical_approx" in line:
                print(line)
Expected:
    <code class="descname">numerical_approx</code><span class="sig-paren">(</span><em>prec=None</em>, <em>digits=None</em>, <em>algorithm=None</em><span class="sig-paren">)</span>...
Got:
    <code class="sig-name descname">numerical_approx</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">prec</span><span class="o">=</span><span class="default_value">None</span></em>, <em class="sig-param"><span class="n">digits</span><span class="o">=</span><span class="default_value">None</span></em>, <em class="sig-param"><span class="n">algorithm</span><span class="o">=</span><span class="default_value">None</span></em><span class="sig-paren">)</span><a class="headerlink" href="#sage.symbolic.expression.Expression.numerical_approx" title="Permalink to this definition">¶</a></dt>
    <BLANKLINE>
```

and

```
sage -t --long --warn-long 80.3 src/sage/docs/conf.py
**********************************************************************
File "src/sage/docs/conf.py", line 666, in sage.docs.conf.call_intersphinx
Failed example:
    for line in open(thematic_index).readlines():  # optional - dochtml
        if "padics" in line:
            _ = sys.stdout.write(line)
Expected:
    <li><a class="reference external" href="../reference/padics/sage/rings/padics/tutorial.html#sage-rings-padics-tutorial" title="(in Sage... Reference Manual: p-Adics v...)"><span>Introduction to the p-adics</span></a></li>
Got:
    <li><p><a class="reference external" href="../reference/padics/sage/rings/padics/tutorial.html#sage-rings-padics-tutorial" title="(in Sage 9.1.rc0 Reference Manual: p-Adics v9.1.rc0)"><span>Introduction to the p-adics</span></a></p></li>
```

They don't look hard to fix.



---

archive/issue_comments_403524.json:
```json
{
    "body": "Unexpected. I didn't see that in my doctesting in Gentoo, may be one of the package sphinx/sphinxcontrib bumps caused this. But as you say, it is trivial to fix.",
    "created_at": "2020-04-22T05:35:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403524",
    "user": "https://github.com/kiwifb"
}
```

Unexpected. I didn't see that in my doctesting in Gentoo, may be one of the package sphinx/sphinxcontrib bumps caused this. But as you say, it is trivial to fix.



---

archive/issue_comments_403525.json:
```json
{
    "body": "I'm trying again, building from scratch, just to make sure.",
    "created_at": "2020-04-22T17:19:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403525",
    "user": "https://github.com/jhpalmieri"
}
```

I'm trying again, building from scratch, just to make sure.



---

archive/issue_comments_403526.json:
```json
{
    "body": "Needs rebasing on top of 9.1.rc1.\n\nAlso please add an `upstream_url` field (see https://wiki.sagemath.org/ReleaseTours/sage-9.1)",
    "created_at": "2020-04-23T03:10:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403526",
    "user": "https://github.com/mkoeppe"
}
```

Needs rebasing on top of 9.1.rc1.

Also please add an `upstream_url` field (see https://wiki.sagemath.org/ReleaseTours/sage-9.1)



---

archive/issue_comments_403527.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2020-04-23T03:12:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403527",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_403528.json:
```json
{
    "body": "That's a cool new feature considering all the instances of \"please the package is not on the mirror\" on sage-release and sage-devel.",
    "created_at": "2020-04-23T03:17:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403528",
    "user": "https://github.com/kiwifb"
}
```

That's a cool new feature considering all the instances of "please the package is not on the mirror" on sage-release and sage-devel.



---

archive/issue_comments_403529.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-04-23T03:37:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403529",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_403530.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2020-04-23T03:38:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403530",
    "user": "https://github.com/kiwifb"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_403531.json:
```json
{
    "body": "I see the same doctest failures on two different machines, so I think they're real.",
    "created_at": "2020-04-23T05:26:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403531",
    "user": "https://github.com/jhpalmieri"
}
```

I see the same doctest failures on two different machines, so I think they're real.



---

archive/issue_comments_403532.json:
```json
{
    "body": "I'll fix them then. Having trouble building sage-on-gentoo right now. The head from Volker (past 9.1.rc1) doesn't build for me. I will have to test on the plain develop branch which is unusual for me these days.",
    "created_at": "2020-04-23T05:29:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403532",
    "user": "https://github.com/kiwifb"
}
```

I'll fix them then. Having trouble building sage-on-gentoo right now. The head from Volker (past 9.1.rc1) doesn't build for me. I will have to test on the plain develop branch which is unusual for me these days.



---

archive/issue_comments_403533.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-04-23T10:27:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403533",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_403534.json:
```json
{
    "body": "All fixed now.",
    "created_at": "2020-04-23T10:28:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403534",
    "user": "https://github.com/kiwifb"
}
```

All fixed now.



---

archive/issue_comments_403535.json:
```json
{
    "body": "Only one of them is fixed AFAICS",
    "created_at": "2020-04-23T16:54:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403535",
    "user": "https://github.com/antonio-rojas"
}
```

Only one of them is fixed AFAICS



---

archive/issue_comments_403536.json:
```json
{
    "body": "For `upstream_url`, it's better to use pypi.io URLs because they will be stable for the next updates\n(see matplotlib, for example)",
    "created_at": "2020-04-23T17:40:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403536",
    "user": "https://github.com/mkoeppe"
}
```

For `upstream_url`, it's better to use pypi.io URLs because they will be stable for the next updates
(see matplotlib, for example)



---

archive/issue_comments_403537.json:
```json
{
    "body": "Replying to [comment:81 fbissey]:\n> That's a cool new feature considering all the instances of \"please the package is not on the mirror\" on sage-release and sage-devel.\nGlad you like it. Note that it's not enabled by default, so that developers still complain when the release manager forgets to upload it to the mirror.",
    "created_at": "2020-04-23T17:42:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403537",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:81 fbissey]:
> That's a cool new feature considering all the instances of "please the package is not on the mirror" on sage-release and sage-devel.
Glad you like it. Note that it's not enabled by default, so that developers still complain when the release manager forgets to upload it to the mirror.



---

archive/issue_comments_403538.json:
```json
{
    "body": "Replying to [comment:88 arojas]:\n> Only one of them is fixed AFAICS\n\nWeird only one of my changes made it up. I must have fumbled a git command last night.",
    "created_at": "2020-04-23T19:57:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403538",
    "user": "https://github.com/kiwifb"
}
```

Replying to [comment:88 arojas]:
> Only one of them is fixed AFAICS

Weird only one of my changes made it up. I must have fumbled a git command last night.



---

archive/issue_comments_403539.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-04-23T20:01:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403539",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_403540.json:
```json
{
    "body": "Replying to [comment:89 mkoeppe]:\n> For `upstream_url`, it's better to use pypi.io URLs because they will be stable for the next updates\n> (see matplotlib, for example)\n\nOK, is this some sort of secret API or something? Because it is not visible (anymore) from the pypi website. I do vaguely recall it being done that way in the past. Will it go away completely sometime in the future?",
    "created_at": "2020-04-23T20:07:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403540",
    "user": "https://github.com/kiwifb"
}
```

Replying to [comment:89 mkoeppe]:
> For `upstream_url`, it's better to use pypi.io URLs because they will be stable for the next updates
> (see matplotlib, for example)

OK, is this some sort of secret API or something? Because it is not visible (anymore) from the pypi website. I do vaguely recall it being done that way in the past. Will it go away completely sometime in the future?



---

archive/issue_comments_403541.json:
```json
{
    "body": "Replying to [comment:91 fbissey]:\n> Replying to [comment:88 arojas]:\n> > Only one of them is fixed AFAICS\n> \n> Weird only one of my changes made it up. I must have fumbled a git command last night.\n\nFixed now.",
    "created_at": "2020-04-23T20:08:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403541",
    "user": "https://github.com/kiwifb"
}
```

Replying to [comment:91 fbissey]:
> Replying to [comment:88 arojas]:
> > Only one of them is fixed AFAICS
> 
> Weird only one of my changes made it up. I must have fumbled a git command last night.

Fixed now.



---

archive/issue_comments_403542.json:
```json
{
    "body": "Replying to [comment:93 fbissey]:\n> Replying to [comment:89 mkoeppe]:\n> > For `upstream_url`, it's better to use pypi.io URLs because they will be stable for the next updates\n> > (see matplotlib, for example)\n> \n> OK, is this some sort of secret API or something? Because it is not visible (anymore) from the pypi website. I do vaguely recall it being done that way in the past. Will it go away completely sometime in the future?\n`@`isuruf showed me this trick, I don't know where this is documented. It's also mentioned here: https://stackoverflow.com/questions/47781035/does-pypi-have-simple-urls-for-package-downloads",
    "created_at": "2020-04-23T21:16:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403542",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:93 fbissey]:
> Replying to [comment:89 mkoeppe]:
> > For `upstream_url`, it's better to use pypi.io URLs because they will be stable for the next updates
> > (see matplotlib, for example)
> 
> OK, is this some sort of secret API or something? Because it is not visible (anymore) from the pypi website. I do vaguely recall it being done that way in the past. Will it go away completely sometime in the future?
`@`isuruf showed me this trick, I don't know where this is documented. It's also mentioned here: https://stackoverflow.com/questions/47781035/does-pypi-have-simple-urls-for-package-downloads



---

archive/issue_comments_403543.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-04-23T21:25:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403543",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_403544.json:
```json
{
    "body": "Replying to [comment:95 mkoeppe]:\n> Replying to [comment:93 fbissey]:\n> > Replying to [comment:89 mkoeppe]:\n> > > For `upstream_url`, it's better to use pypi.io URLs because they will be stable for the next updates\n> > > (see matplotlib, for example)\n> > \n> > OK, is this some sort of secret API or something? Because it is not visible (anymore) from the pypi website. I do vaguely recall it being done that way in the past. Will it go away completely sometime in the future?\n> `@`isuruf showed me this trick, I don't know where this is documented. It's also mentioned here: https://stackoverflow.com/questions/47781035/does-pypi-have-simple-urls-for-package-downloads\n\nOK, I have gone ahead and made the change. I think we are all done here.",
    "created_at": "2020-04-23T21:26:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403544",
    "user": "https://github.com/kiwifb"
}
```

Replying to [comment:95 mkoeppe]:
> Replying to [comment:93 fbissey]:
> > Replying to [comment:89 mkoeppe]:
> > > For `upstream_url`, it's better to use pypi.io URLs because they will be stable for the next updates
> > > (see matplotlib, for example)
> > 
> > OK, is this some sort of secret API or something? Because it is not visible (anymore) from the pypi website. I do vaguely recall it being done that way in the past. Will it go away completely sometime in the future?
> `@`isuruf showed me this trick, I don't know where this is documented. It's also mentioned here: https://stackoverflow.com/questions/47781035/does-pypi-have-simple-urls-for-package-downloads

OK, I have gone ahead and made the change. I think we are all done here.



---

archive/issue_comments_403545.json:
```json
{
    "body": "Best to replace `pip` in `dependencies` by `$(PYTHON_TOOLCHAIN)`, see #26018",
    "created_at": "2020-04-23T21:30:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403545",
    "user": "https://github.com/mkoeppe"
}
```

Best to replace `pip` in `dependencies` by `$(PYTHON_TOOLCHAIN)`, see #26018



---

archive/issue_comments_403546.json:
```json
{
    "body": "Oh, right. I had seen that. Doing after my (ongoing) morning meeting.",
    "created_at": "2020-04-23T21:34:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403546",
    "user": "https://github.com/kiwifb"
}
```

Oh, right. I had seen that. Doing after my (ongoing) morning meeting.



---

archive/issue_comments_403547.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-04-23T21:40:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403547",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_403548.json:
```json
{
    "body": "Was bored. Done. Any other things that should be migrated to new toys?",
    "created_at": "2020-04-23T21:40:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403548",
    "user": "https://github.com/kiwifb"
}
```

Was bored. Done. Any other things that should be migrated to new toys?



---

archive/issue_comments_403549.json:
```json
{
    "body": "Replying to [comment:101 fbissey]:\n> Any other things that should be migrated to new toys?\n\nMigrate, I don't know, but you could test this branch with the new CI system by pushing the branch to a github repo.\nFor extra fun, use a pull request against the branch of #29530.",
    "created_at": "2020-04-23T22:44:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403549",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:101 fbissey]:
> Any other things that should be migrated to new toys?

Migrate, I don't know, but you could test this branch with the new CI system by pushing the branch to a github repo.
For extra fun, use a pull request against the branch of #29530.



---

archive/issue_comments_403550.json:
```json
{
    "body": "Replying to [comment:102 mkoeppe]:\n> Replying to [comment:101 fbissey]:\n> > Any other things that should be migrated to new toys?\n> \n> Migrate, I don't know, but you could test this branch with the new CI system by pushing the branch to a github repo.\n> For extra fun, use a pull request against the branch of #29530.\n\nI really should give that a try. Not sure about #29530 though.",
    "created_at": "2020-04-23T22:46:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403550",
    "user": "https://github.com/kiwifb"
}
```

Replying to [comment:102 mkoeppe]:
> Replying to [comment:101 fbissey]:
> > Any other things that should be migrated to new toys?
> 
> Migrate, I don't know, but you could test this branch with the new CI system by pushing the branch to a github repo.
> For extra fun, use a pull request against the branch of #29530.

I really should give that a try. Not sure about #29530 though.



---

archive/issue_comments_403551.json:
```json
{
    "body": "Anyone tried to build the pdf doc? I got difficulties with it in sage-on-gentoo. Volker usually doesn't think it is critical though, more a nice to have.",
    "created_at": "2020-04-24T06:00:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403551",
    "user": "https://github.com/kiwifb"
}
```

Anyone tried to build the pdf doc? I got difficulties with it in sage-on-gentoo. Volker usually doesn't think it is critical though, more a nice to have.



---

archive/issue_comments_403552.json:
```json
{
    "body": "That's what I get at the end of a serial build, it is a bit scary\n\n```\n[1528]\n\nLaTeX Warning: Hyper reference `sage/combinat/tableau:sage.combinat.tableau.Row\nStandardTableaux' on page 1529 undefined on input line 132175.\n\n[1529]\n! TeX capacity exceeded, sorry [input stack size=5000].\n\\font@name ->\n             \\TS1/ptm/m/n/10 \nl.132260 ...ikipedia article Zolotarev\u2019s\\_lemma}\n                                                  ^^M\nIf you really absolutely need more capacity,\nyou can ask a wizard to enlarge me.\n\n \nHere is how much of TeX's memory you used:\n 21911 strings out of 481640\n 403969 string characters out of 5928785\n 1146413 words of memory out of 5000000\n 31270 multiletter control sequences out of 15000+600000\n 610234 words of font info for 159 fonts, out of 8000000 for 9000\n 817 hyphenation exceptions out of 8191\n 5000i,29n,9989p,5239b,810s stack positions out of 5000i,500n,10000p,200000b,80000s\n!  ==> Fatal error occurred, no output PDF file produced!\n```\n",
    "created_at": "2020-04-24T07:53:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403552",
    "user": "https://github.com/kiwifb"
}
```

That's what I get at the end of a serial build, it is a bit scary

```
[1528]

LaTeX Warning: Hyper reference `sage/combinat/tableau:sage.combinat.tableau.Row
StandardTableaux' on page 1529 undefined on input line 132175.

[1529]
! TeX capacity exceeded, sorry [input stack size=5000].
\font@name ->
             \TS1/ptm/m/n/10 
l.132260 ...ikipedia article Zolotarev’s\_lemma}
                                                  ^^M
If you really absolutely need more capacity,
you can ask a wizard to enlarge me.

 
Here is how much of TeX's memory you used:
 21911 strings out of 481640
 403969 string characters out of 5928785
 1146413 words of memory out of 5000000
 31270 multiletter control sequences out of 15000+600000
 610234 words of font info for 159 fonts, out of 8000000 for 9000
 817 hyphenation exceptions out of 8191
 5000i,29n,9989p,5239b,810s stack positions out of 5000i,500n,10000p,200000b,80000s
!  ==> Fatal error occurred, no output PDF file produced!
```




---

archive/issue_comments_403553.json:
```json
{
    "body": "I explored some of this \"by hand\": I did `./sage --docbuild all latex` and then ran `pdflatex` on a bunch of the LaTeX files. I've found three errors like this, and they all arise from this sort of line:\n\n```\nSee \\sphinxhref{https://en.wikipedia.org/wiki/Dilworth\\textquotesingle{}s\\_theorem}{Wikipedia article Dilworth\u2019s\\_theorem}.\n```\n\nRemoving `\\textquotesingle{}` allows the file to compile.\n\nCan we rewrite our `:wikipedia:` markup converter to fix this? Or is it an issue with a change in Sphinx?",
    "created_at": "2020-04-24T19:00:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403553",
    "user": "https://github.com/jhpalmieri"
}
```

I explored some of this "by hand": I did `./sage --docbuild all latex` and then ran `pdflatex` on a bunch of the LaTeX files. I've found three errors like this, and they all arise from this sort of line:

```
See \sphinxhref{https://en.wikipedia.org/wiki/Dilworth\textquotesingle{}s\_theorem}{Wikipedia article Dilworth’s\_theorem}.
```

Removing `\textquotesingle{}` allows the file to compile.

Can we rewrite our `:wikipedia:` markup converter to fix this? Or is it an issue with a change in Sphinx?



---

archive/issue_comments_403554.json:
```json
{
    "body": "The file `sphinx/util/texescape.py` seems to contain the change causing the issue, so the question is how we handle this within the Sage library. \n\n(In Sphinx, commenting out the line\n\n```\n(\"'\", r'\\textquotesingle{}'),  # else ' renders curly, and '' is a ligature\n```\n\nin `sphinx/util/texescape.py` fixes it, but we want to avoid patching Sphinx. I'm guessing that our introduction of the `:wikipedia:` markup is not done the \"right way\".)",
    "created_at": "2020-04-24T19:10:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403554",
    "user": "https://github.com/jhpalmieri"
}
```

The file `sphinx/util/texescape.py` seems to contain the change causing the issue, so the question is how we handle this within the Sage library. 

(In Sphinx, commenting out the line

```
("'", r'\textquotesingle{}'),  # else ' renders curly, and '' is a ligature
```

in `sphinx/util/texescape.py` fixes it, but we want to avoid patching Sphinx. I'm guessing that our introduction of the `:wikipedia:` markup is not done the "right way".)



---

archive/issue_comments_403555.json:
```json
{
    "body": "You could try to escape single quotes in external links by `%27` in `process_extlinks` in `sagedoc.py`, e.g. https://en.wikipedia.org/wiki/Dilworth%27s_theorem.\n\nEdit: Or use `urllib.parse.quote` (actually, this might escape too much).",
    "created_at": "2020-04-24T19:37:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403555",
    "user": "https://github.com/mwageringel"
}
```

You could try to escape single quotes in external links by `%27` in `process_extlinks` in `sagedoc.py`, e.g. https://en.wikipedia.org/wiki/Dilworth%27s_theorem.

Edit: Or use `urllib.parse.quote` (actually, this might escape too much).



---

archive/issue_comments_403556.json:
```json
{
    "body": "I am running a sage-on-gentoo github issue in parallel at https://github.com/cschwan/sage-on-gentoo/issues/582 I have more details on some of my failures. Both you in here and Steven Trogdon on github have been busy while I was snoozing. \n\nHave to assemble the info from both threads sometimes today.",
    "created_at": "2020-04-24T20:34:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403556",
    "user": "https://github.com/kiwifb"
}
```

I am running a sage-on-gentoo github issue in parallel at https://github.com/cschwan/sage-on-gentoo/issues/582 I have more details on some of my failures. Both you in here and Steven Trogdon on github have been busy while I was snoozing. 

Have to assemble the info from both threads sometimes today.



---

archive/issue_comments_403557.json:
```json
{
    "body": "Indication seem to be that using `%27` after `:wikipedia:` is effective, but there are quite a few place that replacement can be made. I would aim for consistency\n\n```\nsrc/sage/categories/semigroups.py:                - :wikipedia:`Green's_relations`\nsrc/sage/categories/semigroups.py:                - :wikipedia:`Green's_relations`\nsrc/sage/categories/semigroups.py:                - :wikipedia:`Green's_relations`\nsrc/sage/categories/semigroups.py:                - :wikipedia:`Green's_relations`\nsrc/sage/combinat/partition.py:        - :wikipedia:`Zolotarev's_lemma`\nsrc/sage/combinat/posets/posets.py:        :wikipedia:`Dilworth's_theorem` for more information. The width is\nsrc/sage/combinat/posets/posets.py:        See :wikipedia:`Dilworth's_theorem`.\nsrc/sage/combinat/root_system/plot.py::wikipedia:`Wikipedia's E8 3D picture <File:E8_3D.png>`::\nsrc/sage/functions/jacobi.py:- :wikipedia:`Jacobi's_elliptic_functions`\nsrc/sage/geometry/riemannian_manifolds/surface3d_generators.py:        For more information, see :wikipedia:`Dini's_surface`.\nsrc/sage/graphs/generators/smallgraphs.py:    :wikipedia:`Tietze's_graph`.\nsrc/sage/graphs/path_enumeration.pyx:    See [Yen1970]_ and the :wikipedia:`Yen's_algorithm` for more details on the\nsrc/sage/graphs/base/static_sparse_graph.pyx:    :wikipedia:`Tarjan's_strongly_connected_components_algorithm`.\nsrc/sage/graphs/bipartite_graph.py:            algorithm (:wikipedia:`K\u0151nig's_theorem_(graph_theory)`)\nsrc/sage/graphs/spanning_tree.pyx:        - :wikipedia:`Kruskal's_algorithm`\nsrc/sage/graphs/spanning_tree.pyx:        - :wikipedia:`Kruskal's_algorithm`\nsrc/sage/matroids/linear_matroid.pyx:        See also :wikipedia:`Kirchhoff's_theorem`.\n```\n\nPlus\n\n```\nsrc/sage/plot/plot3d/parametric_plot3d.py:    Boy's surface (:wikipedia:`Boy%27s_surface` and https://mathcurve.com/surfaces/boy/boy.shtml)::\n```\n\nwhich I just changed.",
    "created_at": "2020-04-24T22:39:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403557",
    "user": "https://github.com/kiwifb"
}
```

Indication seem to be that using `%27` after `:wikipedia:` is effective, but there are quite a few place that replacement can be made. I would aim for consistency

```
src/sage/categories/semigroups.py:                - :wikipedia:`Green's_relations`
src/sage/categories/semigroups.py:                - :wikipedia:`Green's_relations`
src/sage/categories/semigroups.py:                - :wikipedia:`Green's_relations`
src/sage/categories/semigroups.py:                - :wikipedia:`Green's_relations`
src/sage/combinat/partition.py:        - :wikipedia:`Zolotarev's_lemma`
src/sage/combinat/posets/posets.py:        :wikipedia:`Dilworth's_theorem` for more information. The width is
src/sage/combinat/posets/posets.py:        See :wikipedia:`Dilworth's_theorem`.
src/sage/combinat/root_system/plot.py::wikipedia:`Wikipedia's E8 3D picture <File:E8_3D.png>`::
src/sage/functions/jacobi.py:- :wikipedia:`Jacobi's_elliptic_functions`
src/sage/geometry/riemannian_manifolds/surface3d_generators.py:        For more information, see :wikipedia:`Dini's_surface`.
src/sage/graphs/generators/smallgraphs.py:    :wikipedia:`Tietze's_graph`.
src/sage/graphs/path_enumeration.pyx:    See [Yen1970]_ and the :wikipedia:`Yen's_algorithm` for more details on the
src/sage/graphs/base/static_sparse_graph.pyx:    :wikipedia:`Tarjan's_strongly_connected_components_algorithm`.
src/sage/graphs/bipartite_graph.py:            algorithm (:wikipedia:`Kőnig's_theorem_(graph_theory)`)
src/sage/graphs/spanning_tree.pyx:        - :wikipedia:`Kruskal's_algorithm`
src/sage/graphs/spanning_tree.pyx:        - :wikipedia:`Kruskal's_algorithm`
src/sage/matroids/linear_matroid.pyx:        See also :wikipedia:`Kirchhoff's_theorem`.
```

Plus

```
src/sage/plot/plot3d/parametric_plot3d.py:    Boy's surface (:wikipedia:`Boy%27s_surface` and https://mathcurve.com/surfaces/boy/boy.shtml)::
```

which I just changed.



---

archive/issue_comments_403558.json:
```json
{
    "body": "\n```\nsage: from sage.misc.sagedoc import process_extlinks\nsage: process_extlinks(\":wikipedia:`Boy's`\")\n\"https://en.wikipedia.org/wiki/Boy's\"\n```\n\nSo, can `process_extlinks` be modified to replace `'` with `%27`? Or is `process_extlinks` the wrong place?",
    "created_at": "2020-04-24T22:55:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403558",
    "user": "https://github.com/strogdon"
}
```


```
sage: from sage.misc.sagedoc import process_extlinks
sage: process_extlinks(":wikipedia:`Boy's`")
"https://en.wikipedia.org/wiki/Boy's"
```

So, can `process_extlinks` be modified to replace `'` with `%27`? Or is `process_extlinks` the wrong place?



---

archive/issue_comments_403559.json:
```json
{
    "body": "`process_extlinks` won't help: as far as I can tell, the `extlinks` dictionary is passes as is to Sphinx for processing. (`process_extlinks` is for printing docstrings for introspection at the command line.)",
    "created_at": "2020-04-24T23:03:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403559",
    "user": "https://github.com/jhpalmieri"
}
```

`process_extlinks` won't help: as far as I can tell, the `extlinks` dictionary is passes as is to Sphinx for processing. (`process_extlinks` is for printing docstrings for introspection at the command line.)



---

archive/issue_comments_403560.json:
```json
{
    "body": "I am currently replacing all those pesky `'` that I have quoted earlier. I will let you know how that goes.",
    "created_at": "2020-04-24T23:05:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403560",
    "user": "https://github.com/kiwifb"
}
```

I am currently replacing all those pesky `'` that I have quoted earlier. I will let you know how that goes.



---

archive/issue_comments_403561.json:
```json
{
    "body": "Replying to [comment:114 fbissey]:\n> I am currently replacing all those pesky `'` that I have quoted earlier. I will let you know how that goes.\n\nIndependently I was doing the same thing. Here is a branch. It works for me; please test it.\n\n(The html and pdf are uglier, since the links now include \"%27\" instead of an apostrophe, but I think we have to settle for that.)\n----\nNew commits:",
    "created_at": "2020-04-24T23:07:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403561",
    "user": "https://github.com/jhpalmieri"
}
```

Replying to [comment:114 fbissey]:
> I am currently replacing all those pesky `'` that I have quoted earlier. I will let you know how that goes.

Independently I was doing the same thing. Here is a branch. It works for me; please test it.

(The html and pdf are uglier, since the links now include "%27" instead of an apostrophe, but I think we have to settle for that.)
----
New commits:



---

archive/issue_comments_403562.json:
```json
{
    "body": "I had two left to go :) oh well, you beat me to it.",
    "created_at": "2020-04-24T23:09:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403562",
    "user": "https://github.com/kiwifb"
}
```

I had two left to go :) oh well, you beat me to it.



---

archive/issue_comments_403563.json:
```json
{
    "body": "There was also a missing space in `matrix_gps/finitely_generated.py` that caused problems.",
    "created_at": "2020-04-24T23:40:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403563",
    "user": "https://github.com/jhpalmieri"
}
```

There was also a missing space in `matrix_gps/finitely_generated.py` that caused problems.



---

archive/issue_comments_403564.json:
```json
{
    "body": "Works for me. I guess modulo a rebase when 9.1 is out, we are ready.",
    "created_at": "2020-04-25T00:09:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403564",
    "user": "https://github.com/kiwifb"
}
```

Works for me. I guess modulo a rebase when 9.1 is out, we are ready.



---

archive/issue_comments_403565.json:
```json
{
    "body": "Did you try searching in the html documentation? For me this does not work anymore with Sphinx 2.4 and the patches from here. It never returns any results.\n\nThe reason I tested it is that the Debian packaging tool dh_sphinxdoc performs some sanity checks on sphinx documentation and complained that (at least) one of the search.html does not load searchindex.js. The checks it performs can be seen here:\nhttps://salsa.debian.org/python-team/modules/sphinx/-/blob/debian/master/debian/dh-sphinxdoc/dh_sphinxdoc#L284",
    "created_at": "2020-04-25T06:56:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403565",
    "user": "https://github.com/tobihan"
}
```

Did you try searching in the html documentation? For me this does not work anymore with Sphinx 2.4 and the patches from here. It never returns any results.

The reason I tested it is that the Debian packaging tool dh_sphinxdoc performs some sanity checks on sphinx documentation and complained that (at least) one of the search.html does not load searchindex.js. The checks it performs can be seen here:
https://salsa.debian.org/python-team/modules/sphinx/-/blob/debian/master/debian/dh-sphinxdoc/dh_sphinxdoc#L284



---

archive/issue_comments_403566.json:
```json
{
    "body": "Replying to [comment:120 thansen]:\n> Did you try searching in the html documentation? For me this does not work anymore with Sphinx 2.4 and the patches from here. It never returns any results.\n\nWorks for me. I do get some missing labels and icons on the search page, but I see the exact same thing when using sphinx 1 and on the online version",
    "created_at": "2020-04-25T07:26:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403566",
    "user": "https://github.com/antonio-rojas"
}
```

Replying to [comment:120 thansen]:
> Did you try searching in the html documentation? For me this does not work anymore with Sphinx 2.4 and the patches from here. It never returns any results.

Works for me. I do get some missing labels and icons on the search page, but I see the exact same thing when using sphinx 1 and on the online version



---

archive/issue_comments_403567.json:
```json
{
    "body": "Replying to [comment:120 thansen]:\n> Did you try searching in the html documentation? For me this does not work anymore with Sphinx 2.4 and the patches from here. It never returns any results.\n> \n> The reason I tested it is that the Debian packaging tool dh_sphinxdoc performs some sanity checks on sphinx documentation and complained that (at least) one of the search.html does not load searchindex.js. The checks it performs can be seen here:\n> https://salsa.debian.org/python-team/modules/sphinx/-/blob/debian/master/debian/dh-sphinxdoc/dh_sphinxdoc#L284\n\nMost of my development is remote and I must say it must have been years since I tried that particular functionality.",
    "created_at": "2020-04-25T07:27:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403567",
    "user": "https://github.com/kiwifb"
}
```

Replying to [comment:120 thansen]:
> Did you try searching in the html documentation? For me this does not work anymore with Sphinx 2.4 and the patches from here. It never returns any results.
> 
> The reason I tested it is that the Debian packaging tool dh_sphinxdoc performs some sanity checks on sphinx documentation and complained that (at least) one of the search.html does not load searchindex.js. The checks it performs can be seen here:
> https://salsa.debian.org/python-team/modules/sphinx/-/blob/debian/master/debian/dh-sphinxdoc/dh_sphinxdoc#L284

Most of my development is remote and I must say it must have been years since I tried that particular functionality.



---

archive/issue_comments_403568.json:
```json
{
    "body": "I've opened #29576 for the broken search page",
    "created_at": "2020-04-25T07:53:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403568",
    "user": "https://github.com/antonio-rojas"
}
```

I've opened #29576 for the broken search page



---

archive/issue_comments_403569.json:
```json
{
    "body": "`@`jhpalmieri you own the branch on this ticket and #29547. May be we should rebase them. I think we should go ahead with #29547, although we could try upgrading freetype to 2.10.2 for the people who experience the crash.",
    "created_at": "2020-05-21T07:59:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403569",
    "user": "https://github.com/kiwifb"
}
```

`@`jhpalmieri you own the branch on this ticket and #29547. May be we should rebase them. I think we should go ahead with #29547, although we could try upgrading freetype to 2.10.2 for the people who experience the crash.



---

archive/issue_comments_403570.json:
```json
{
    "body": "I'm getting a new error now, not sure when it started (with 3.0.3)\n\n```\nOSError: /build/sagemath-doc/src/sage-9.1/src/doc/en/installation/source.rst:237: WARNING: Include file '/build/sagemath-doc/src/sage-9.1/src/doc/en/installation/debian.txt' not found or reading it failed\n```\n",
    "created_at": "2020-05-21T08:19:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403570",
    "user": "https://github.com/antonio-rojas"
}
```

I'm getting a new error now, not sure when it started (with 3.0.3)

```
OSError: /build/sagemath-doc/src/sage-9.1/src/doc/en/installation/source.rst:237: WARNING: Include file '/build/sagemath-doc/src/sage-9.1/src/doc/en/installation/debian.txt' not found or reading it failed
```




---

archive/issue_comments_403571.json:
```json
{
    "body": "During the development of 9.1 a bootstrap step has been added for the documentation. I think I mentioned it somewhere else, did you run it? https://github.com/cschwan/sage-on-gentoo/blob/master/sci-mathematics/sage/sage-9.1.ebuild#L328 in sage-on-gentoo (`${S}`  is `SAGE_ROOT/src` in vanilla sage terms).",
    "created_at": "2020-05-21T08:26:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403571",
    "user": "https://github.com/kiwifb"
}
```

During the development of 9.1 a bootstrap step has been added for the documentation. I think I mentioned it somewhere else, did you run it? https://github.com/cschwan/sage-on-gentoo/blob/master/sci-mathematics/sage/sage-9.1.ebuild#L328 in sage-on-gentoo (`${S}`  is `SAGE_ROOT/src` in vanilla sage terms).



---

archive/issue_comments_403572.json:
```json
{
    "body": "Replying to [comment:125 arojas]:\n> I'm getting a new error now, not sure when it started (with 3.0.3)\n> {{{\n> OSError: /build/sagemath-doc/src/sage-9.1/src/doc/en/installation/source.rst:237: WARNING: Include file '/build/sagemath-doc/src/sage-9.1/src/doc/en/installation/debian.txt' not found or reading it failed\n> }}}\n\nYes this is totally what happened to you. Look at my comment #29053#comment:78 on the ticket that introduced the change.",
    "created_at": "2020-05-21T08:40:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403572",
    "user": "https://github.com/kiwifb"
}
```

Replying to [comment:125 arojas]:
> I'm getting a new error now, not sure when it started (with 3.0.3)
> {{{
> OSError: /build/sagemath-doc/src/sage-9.1/src/doc/en/installation/source.rst:237: WARNING: Include file '/build/sagemath-doc/src/sage-9.1/src/doc/en/installation/debian.txt' not found or reading it failed
> }}}

Yes this is totally what happened to you. Look at my comment #29053#comment:78 on the ticket that introduced the change.



---

archive/issue_comments_403573.json:
```json
{
    "body": "Replying to [comment:127 fbissey]:\n\n> Yes this is totally what happened to you. Look at my comment #29053#comment:78 on the ticket that introduced the change.\n\nThanks, clearly I wasn't paying much attention to that ticket.",
    "created_at": "2020-05-21T09:23:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403573",
    "user": "https://github.com/antonio-rojas"
}
```

Replying to [comment:127 fbissey]:

> Yes this is totally what happened to you. Look at my comment #29053#comment:78 on the ticket that introduced the change.

Thanks, clearly I wasn't paying much attention to that ticket.



---

archive/issue_comments_403574.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:",
    "created_at": "2020-05-21T21:02:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403574",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:



---

archive/issue_comments_403575.json:
```json
{
    "body": "Replying to [comment:124 fbissey]:\n> `@`jhpalmieri you own the branch on this ticket and #29547. May be we should rebase them. \n\nI just rebased this one. \n\n> I think we should go ahead with #29547, although we could try upgrading freetype to 2.10.2 for the people who experience the crash.\n\nWith #29547, `git rebase develop` works with no intervention, but also upgrading freetype doesn't seem to fix the doctest failures, so I'm not sure what to do with that ticket.",
    "created_at": "2020-05-21T21:04:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403575",
    "user": "https://github.com/jhpalmieri"
}
```

Replying to [comment:124 fbissey]:
> `@`jhpalmieri you own the branch on this ticket and #29547. May be we should rebase them. 

I just rebased this one. 

> I think we should go ahead with #29547, although we could try upgrading freetype to 2.10.2 for the people who experience the crash.

With #29547, `git rebase develop` works with no intervention, but also upgrading freetype doesn't seem to fix the doctest failures, so I'm not sure what to do with that ticket.



---

archive/issue_comments_403576.json:
```json
{
    "body": "We need at least Matplotlib 3.1 but I suspect even that could have an issue with freetype. Note that the problem may not be freetype itself but the interface to it in matplotlib.",
    "created_at": "2020-05-21T21:15:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403576",
    "user": "https://github.com/kiwifb"
}
```

We need at least Matplotlib 3.1 but I suspect even that could have an issue with freetype. Note that the problem may not be freetype itself but the interface to it in matplotlib.



---

archive/issue_comments_403577.json:
```json
{
    "body": "We have a merge conflict with #28000 (removal of py2 support from sagelib). Not very surprising. I will try to merge our branch with it and fix all the conflicts (removal of all calls to `six`). Volker is currently merging #28000 in his dev branch where he merges tickets incrementally before doing releases.",
    "created_at": "2020-05-23T03:07:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403577",
    "user": "https://github.com/kiwifb"
}
```

We have a merge conflict with #28000 (removal of py2 support from sagelib). Not very surprising. I will try to merge our branch with it and fix all the conflicts (removal of all calls to `six`). Volker is currently merging #28000 in his dev branch where he merges tickets incrementally before doing releases.



---

archive/issue_comments_403578.json:
```json
{
    "body": "I should mention that #29547 is not affected by #28000 which is already something.",
    "created_at": "2020-05-23T03:07:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403578",
    "user": "https://github.com/kiwifb"
}
```

I should mention that #29547 is not affected by #28000 which is already something.



---

archive/issue_comments_403579.json:
```json
{
    "body": "Merged with #28000 so no more merge conflicts there.\n----\nNew commits:",
    "created_at": "2020-05-23T04:55:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403579",
    "user": "https://github.com/kiwifb"
}
```

Merged with #28000 so no more merge conflicts there.
----
New commits:



---

archive/issue_comments_403580.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-05-23T05:10:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403580",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_403581.json:
```json
{
    "body": "Ticket to keep a lookout on: #29633 it changes `SPKG.txt` to `SPKG.rst`. We may want to align the format if it is merged first.",
    "created_at": "2020-05-25T22:39:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403581",
    "user": "https://github.com/kiwifb"
}
```

Ticket to keep a lookout on: #29633 it changes `SPKG.txt` to `SPKG.rst`. We may want to align the format if it is merged first.



---

archive/issue_comments_403582.json:
```json
{
    "body": "I will make a last bump to 3.0.4 which I know is safe. I don't know yet about 3.1.0 released in the last 24 hours. But I think it is time we move this ticket to positive review. Any volunteer reviewers?",
    "created_at": "2020-06-09T01:54:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403582",
    "user": "https://github.com/kiwifb"
}
```

I will make a last bump to 3.0.4 which I know is safe. I don't know yet about 3.1.0 released in the last 24 hours. But I think it is time we move this ticket to positive review. Any volunteer reviewers?



---

archive/issue_comments_403583.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-06-09T01:55:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403583",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_403584.json:
```json
{
    "body": "Unsurprisingly, 3.1 doesn't work\n\n\n```\n[reference] dumping object inventory... failed\n[reference] Exception occurred:\n[reference]   File \"/usr/lib/python3.8/site-packages/sphinx/domains/python.py\", line 1325, in get_objects\n[reference]     yield (modname, modname, 'module', mod.docname, mod.node_id, 0)\n[reference] AttributeError: 'tuple' object has no attribute 'docname'\n```\n",
    "created_at": "2020-06-09T06:36:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403584",
    "user": "https://github.com/antonio-rojas"
}
```

Unsurprisingly, 3.1 doesn't work


```
[reference] dumping object inventory... failed
[reference] Exception occurred:
[reference]   File "/usr/lib/python3.8/site-packages/sphinx/domains/python.py", line 1325, in get_objects
[reference]     yield (modname, modname, 'module', mod.docname, mod.node_id, 0)
[reference] AttributeError: 'tuple' object has no attribute 'docname'
```




---

archive/issue_comments_403585.json:
```json
{
    "body": "I would prefer if we could merge this one already as is and open a new one for 3.1.x.",
    "created_at": "2020-06-09T07:54:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403585",
    "user": "https://github.com/kiwifb"
}
```

I would prefer if we could merge this one already as is and open a new one for 3.1.x.



---

archive/issue_comments_403586.json:
```json
{
    "body": "This doesn't merge cleanly with 9.2.beta0.",
    "created_at": "2020-06-12T18:01:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403586",
    "user": "https://github.com/jhpalmieri"
}
```

This doesn't merge cleanly with 9.2.beta0.



---

archive/issue_comments_403587.json:
```json
{
    "body": "Let's move forward with this, though. (Maybe the merge problems can be fixed by squashing some commits? I don't really see what needs doing: the rebasing fails for multidocs.py, but after I clean up the rebasing, my diff looks just like the diff on this ticket.)",
    "created_at": "2020-06-12T22:25:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403587",
    "user": "https://github.com/jhpalmieri"
}
```

Let's move forward with this, though. (Maybe the merge problems can be fixed by squashing some commits? I don't really see what needs doing: the rebasing fails for multidocs.py, but after I clean up the rebasing, my diff looks just like the diff on this ticket.)



---

archive/issue_comments_403588.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-06-12T22:25:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403588",
    "user": "https://github.com/jhpalmieri"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_403589.json:
```json
{
    "body": "I actually have a branch that merges 9.2.beta0 and #29547. I should double check it and push it. It should merge cleanly.",
    "created_at": "2020-06-13T01:28:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403589",
    "user": "https://github.com/kiwifb"
}
```

I actually have a branch that merges 9.2.beta0 and #29547. I should double check it and push it. It should merge cleanly.



---

archive/issue_comments_403590.json:
```json
{
    "body": "Changing status from positive_review to needs_review.",
    "created_at": "2020-06-13T01:33:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403590",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing status from positive_review to needs_review.



---

archive/issue_comments_403591.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:",
    "created_at": "2020-06-13T01:33:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403591",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:



---

archive/issue_comments_403592.json:
```json
{
    "body": "It should merge cleanly now.",
    "created_at": "2020-06-13T01:34:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403592",
    "user": "https://github.com/kiwifb"
}
```

It should merge cleanly now.



---

archive/issue_comments_403593.json:
```json
{
    "body": "Now `git merge develop` works for me. Thank you for rebasing!",
    "created_at": "2020-06-13T03:42:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403593",
    "user": "https://github.com/jhpalmieri"
}
```

Now `git merge develop` works for me. Thank you for rebasing!



---

archive/issue_comments_403594.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-06-13T03:42:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403594",
    "user": "https://github.com/jhpalmieri"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_403595.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-06-21T22:37:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403595",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_072988.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2020-06-21T22:37:15Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28619#event-72988"
}
```



---

archive/issue_comments_403596.json:
```json
{
    "body": "3.1 upgrade up at #30001",
    "created_at": "2020-06-27T11:16:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403596",
    "user": "https://github.com/antonio-rojas"
}
```

3.1 upgrade up at #30001



---

archive/issue_comments_403597.json:
```json
{
    "body": "It seems that this ticket breaks building sage on centos 7.\n\nI opened #30008, please fix.",
    "created_at": "2020-06-28T12:45:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28619#issuecomment-403597",
    "user": "https://github.com/kliem"
}
```

It seems that this ticket breaks building sage on centos 7.

I opened #30008, please fix.
