# Issue 13729: BuiltinFunction.__call__ is unnecessarily slow

archive/issues_013729.json:
```json
{
    "body": "Assignee: @burcin\n\nCC:  @burcin\n\nThis was discovered when looking at #12615. Basically, foo(x) eventually calls x.foo() if it exists, but only after doing a lot of symbolic work (resulting in an order of magnitude slowdown for that example).\n\nIssue created by migration from https://trac.sagemath.org/ticket/13933\n\n",
    "created_at": "2013-01-09T10:32:29Z",
    "labels": [
        "component: symbolics",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-5.11",
    "title": "BuiltinFunction.__call__ is unnecessarily slow",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/13729",
    "user": "https://github.com/robertwb"
}
```
Assignee: @burcin

CC:  @burcin

This was discovered when looking at #12615. Basically, foo(x) eventually calls x.foo() if it exists, but only after doing a lot of symbolic work (resulting in an order of magnitude slowdown for that example).

Issue created by migration from https://trac.sagemath.org/ticket/13933





---

archive/issue_comments_170075.json:
```json
{
    "body": "Any reason why this isn't a good idea?",
    "created_at": "2013-01-09T10:34:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13729",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13729#issuecomment-170075",
    "user": "https://github.com/robertwb"
}
```

Any reason why this isn't a good idea?



---

archive/issue_comments_170076.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2013-01-09T10:35:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13729",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13729#issuecomment-170076",
    "user": "https://github.com/robertwb"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_170077.json:
```json
{
    "body": "Attachment [13933-slow-call.patch](tarball://root/attachments/some-uuid/ticket13933/13933-slow-call.patch) by @robertwb created at 2013-01-09 10:35:58",
    "created_at": "2013-01-09T10:35:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13729",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13729#issuecomment-170077",
    "user": "https://github.com/robertwb"
}
```

Attachment [13933-slow-call.patch](tarball://root/attachments/some-uuid/ticket13933/13933-slow-call.patch) by @robertwb created at 2013-01-09 10:35:58



---

archive/issue_comments_170078.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2013-01-09T10:58:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13729",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13729#issuecomment-170078",
    "user": "https://github.com/burcin"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_170079.json:
```json
{
    "body": "In principle it is a good idea. I did something similar in attachment:trac_1173-move_call.patch:ticket:1173.\n\nPutting this in the `Function` class is overkill. User defined symbolic functions also inherit from that class. People might be very surprised if all symbolic functions magically tried to call methods of the same name before doing anything else. `BuiltinFunction` is the right place for this, as that is supposed to be the base class for all functions we define in the Sage library.\n\nI agree that extracting the original parent can be delayed. The `alt_name` parameter is also a good idea.\n\nShall I adapt my patch? or are you going to revise yours?",
    "created_at": "2013-01-09T10:58:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13729",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13729#issuecomment-170079",
    "user": "https://github.com/burcin"
}
```

In principle it is a good idea. I did something similar in attachment:trac_1173-move_call.patch:ticket:1173.

Putting this in the `Function` class is overkill. User defined symbolic functions also inherit from that class. People might be very surprised if all symbolic functions magically tried to call methods of the same name before doing anything else. `BuiltinFunction` is the right place for this, as that is supposed to be the base class for all functions we define in the Sage library.

I agree that extracting the original parent can be delayed. The `alt_name` parameter is also a good idea.

Shall I adapt my patch? or are you going to revise yours?



---

archive/issue_comments_170080.json:
```json
{
    "body": "Attachment [trac_13933-move_call.patch](tarball://root/attachments/some-uuid/ticket13933/trac_13933-move_call.patch) by @burcin created at 2013-01-10 07:50:50",
    "created_at": "2013-01-10T07:50:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13729",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13729#issuecomment-170080",
    "user": "https://github.com/burcin"
}
```

Attachment [trac_13933-move_call.patch](tarball://root/attachments/some-uuid/ticket13933/trac_13933-move_call.patch) by @burcin created at 2013-01-10 07:50:50



---

archive/issue_comments_170081.json:
```json
{
    "body": "robert's patch rebased on top of move_call.patch",
    "created_at": "2013-01-10T07:51:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13729",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13729#issuecomment-170081",
    "user": "https://github.com/burcin"
}
```

robert's patch rebased on top of move_call.patch



---

archive/issue_comments_170082.json:
```json
{
    "body": "Attachment [13933-slow-call.v2.patch](tarball://root/attachments/some-uuid/ticket13933/13933-slow-call.v2.patch) by @robertwb created at 2013-01-10 07:55:17\n\napply only this patch",
    "created_at": "2013-01-10T07:55:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13729",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13729#issuecomment-170082",
    "user": "https://github.com/robertwb"
}
```

Attachment [13933-slow-call.v2.patch](tarball://root/attachments/some-uuid/ticket13933/13933-slow-call.v2.patch) by @robertwb created at 2013-01-10 07:55:17

apply only this patch



---

archive/issue_comments_170083.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2013-01-10T07:58:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13729",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13729#issuecomment-170083",
    "user": "https://github.com/robertwb"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_170084.json:
```json
{
    "body": "Looks like our patches crossed mid-air... I just posted a patch that moves the `__call__` up.\n\nNote that using the 3-arg getattr is better than catching an AttributeError both for performance and so we don't mask an error during the call.",
    "created_at": "2013-01-10T07:58:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13729",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13729#issuecomment-170084",
    "user": "https://github.com/robertwb"
}
```

Looks like our patches crossed mid-air... I just posted a patch that moves the `__call__` up.

Note that using the 3-arg getattr is better than catching an AttributeError both for performance and so we don't mask an error during the call.



---

archive/issue_comments_170085.json:
```json
{
    "body": "Yep, you posted your patch while I was writing this comment.\n\nI rebased your patch on my `move_call.patch` from #1173, but we can just apply yours.\n\nHere are the timings for `sgn()`:\n\n\n```\nsage: load /home/burcin/sage/sign_fn.py\nsage: sf = SignFunc()\nsage: %timeit sf(5) \n625 loops, best of 3: 378 ns per loop\nsage: %timeit sgn(5)                   \n625 loops, best of 3: 3.49 \u00b5s per loop\n```\n\n\nContents of the file `sign_fn.py`:\n\n\n```\nfrom sage.symbolic.function import BuiltinFunction\n\nclass SignFunc(BuiltinFunction):\n    def __init__(self):\n        BuiltinFunction.__init__(self, \"sign\")\n```\n\n\nThe `_alt_name` code path is still taking up valuable time. It would be better to settle what name we use in the constructor and only try one option. If `alt_name` is set, we use that, otherwise, we use `name`.\n\nThere are a couple of doctest failures in `sage/functions` due to precision changes.",
    "created_at": "2013-01-10T08:11:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13729",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13729#issuecomment-170085",
    "user": "https://github.com/burcin"
}
```

Yep, you posted your patch while I was writing this comment.

I rebased your patch on my `move_call.patch` from #1173, but we can just apply yours.

Here are the timings for `sgn()`:


```
sage: load /home/burcin/sage/sign_fn.py
sage: sf = SignFunc()
sage: %timeit sf(5) 
625 loops, best of 3: 378 ns per loop
sage: %timeit sgn(5)                   
625 loops, best of 3: 3.49 Âµs per loop
```


Contents of the file `sign_fn.py`:


```
from sage.symbolic.function import BuiltinFunction

class SignFunc(BuiltinFunction):
    def __init__(self):
        BuiltinFunction.__init__(self, "sign")
```


The `_alt_name` code path is still taking up valuable time. It would be better to settle what name we use in the constructor and only try one option. If `alt_name` is set, we use that, otherwise, we use `name`.

There are a couple of doctest failures in `sage/functions` due to precision changes.



---

archive/issue_comments_170086.json:
```json
{
    "body": "Attachment [13933-doctests.patch](tarball://root/attachments/some-uuid/ticket13933/13933-doctests.patch) by @robertwb created at 2013-01-22 05:12:26\n\nAdded attachment that fixes some doctests, in each case the returned result has been changed to be of the same parent as the input.",
    "created_at": "2013-01-22T05:12:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13729",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13729#issuecomment-170086",
    "user": "https://github.com/robertwb"
}
```

Attachment [13933-doctests.patch](tarball://root/attachments/some-uuid/ticket13933/13933-doctests.patch) by @robertwb created at 2013-01-22 05:12:26

Added attachment that fixes some doctests, in each case the returned result has been changed to be of the same parent as the input.



---

archive/issue_comments_170087.json:
```json
{
    "body": "> The _alt_name code path is still taking up valuable time. It would be better to settle what name we use in the constructor and only try one option. If alt_name is set, we use that, otherwise, we use name.\nSo... is this needs work? Just trying to clarify what the situation is here.",
    "created_at": "2013-06-12T20:08:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13729",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13729#issuecomment-170087",
    "user": "https://github.com/kcrisman"
}
```

> The _alt_name code path is still taking up valuable time. It would be better to settle what name we use in the constructor and only try one option. If alt_name is set, we use that, otherwise, we use name.
So... is this needs work? Just trying to clarify what the situation is here.



---

archive/issue_comments_170088.json:
```json
{
    "body": "Attachment [13933-more-doctests.patch](tarball://root/attachments/some-uuid/ticket13933/13933-more-doctests.patch) by @robertwb created at 2013-06-13 06:39:52\n\nI fixed the failed doctest and removed the old-style line continuations. Let's not let the perfect be the enemy of the good here. I disagree that the altname taking up time is a big issue--getting rid of this functionality is a much larger (and backwards incompatible) change, and for those functions without an alt name (most of them) the overhead is a single pointer comparison.",
    "created_at": "2013-06-13T06:39:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13729",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13729#issuecomment-170088",
    "user": "https://github.com/robertwb"
}
```

Attachment [13933-more-doctests.patch](tarball://root/attachments/some-uuid/ticket13933/13933-more-doctests.patch) by @robertwb created at 2013-06-13 06:39:52

I fixed the failed doctest and removed the old-style line continuations. Let's not let the perfect be the enemy of the good here. I disagree that the altname taking up time is a big issue--getting rid of this functionality is a much larger (and backwards incompatible) change, and for those functions without an alt name (most of them) the overhead is a single pointer comparison.



---

archive/issue_comments_170089.json:
```json
{
    "body": "I would be likely to agree with this sentiment.  Burcin, are you okay with Robert's main patch in that case, as it seems?  Then we can just look at the doctests and make sure that was all of the fixes.\n\nI'm not clear on what would be backwards-incompatible, though?",
    "created_at": "2013-06-13T14:30:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13729",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13729#issuecomment-170089",
    "user": "https://github.com/kcrisman"
}
```

I would be likely to agree with this sentiment.  Burcin, are you okay with Robert's main patch in that case, as it seems?  Then we can just look at the doctests and make sure that was all of the fixes.

I'm not clear on what would be backwards-incompatible, though?



---

archive/issue_comments_170090.json:
```json
{
    "body": "It's backwards incompatible because if some objects (defined within or outside of Sage) define sgn() and others define sign(), removing this aliasing would cause one or the other break. \n\nIf we decide to go this route, I think it should be a separate ticket than this performance enhancement.",
    "created_at": "2013-06-13T16:19:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13729",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13729#issuecomment-170090",
    "user": "https://github.com/robertwb"
}
```

It's backwards incompatible because if some objects (defined within or outside of Sage) define sgn() and others define sign(), removing this aliasing would cause one or the other break. 

If we decide to go this route, I think it should be a separate ticket than this performance enhancement.



---

archive/issue_comments_170091.json:
```json
{
    "body": "Okay, you're not saying that anything in *this* ticket is breaking anything.  I didn't think so...",
    "created_at": "2013-06-13T16:30:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13729",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13729#issuecomment-170091",
    "user": "https://github.com/kcrisman"
}
```

Okay, you're not saying that anything in *this* ticket is breaking anything.  I didn't think so...



---

archive/issue_comments_170092.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2013-06-17T23:12:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13729",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13729#issuecomment-170092",
    "user": "https://github.com/burcin"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_170093.json:
```json
{
    "body": "Changing keywords from \"\" to \"sd48\".",
    "created_at": "2013-06-17T23:12:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13729",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13729#issuecomment-170093",
    "user": "https://github.com/burcin"
}
```

Changing keywords from "" to "sd48".



---

archive/issue_comments_170094.json:
```json
{
    "body": "Patchbot, apply 13933-slow-call.v2.patch 13933-doctests.patch 13933-more-doctests.patch",
    "created_at": "2013-06-18T22:07:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13729",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13729#issuecomment-170094",
    "user": "https://github.com/kcrisman"
}
```

Patchbot, apply 13933-slow-call.v2.patch 13933-doctests.patch 13933-more-doctests.patch



---

archive/issue_comments_170095.json:
```json
{
    "body": "All tests pass.",
    "created_at": "2013-06-19T00:16:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13729",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13729#issuecomment-170095",
    "user": "https://github.com/kcrisman"
}
```

All tests pass.



---

archive/issue_events_013572.json:
```json
{
    "actor": "@jdemeyer",
    "created_at": "2013-06-19T12:25:07Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/13729",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/13729#event-13572"
}
```



---

archive/issue_comments_170096.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2013-06-19T12:25:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13729",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13729#issuecomment-170096",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: fixed



---

archive/issue_comments_170097.json:
```json
{
    "body": "Hi guys!  This seems to have either\n* exposed inadequate case-checking in trig.py, or\n* contained a bug for functions which are `BuiltinFunction`s but used to be directly evaluated using `Function`'s `__call__` method, as opposed to the one now in `BuiltinFunction` (which used to only be used for `GinacFunction`).\nCan one of you take a look at comment:31:ticket:13246 to help us ascertain which one it is?   Thanks!",
    "created_at": "2014-06-04T13:07:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13729",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13729#issuecomment-170097",
    "user": "https://github.com/kcrisman"
}
```

Hi guys!  This seems to have either
* exposed inadequate case-checking in trig.py, or
* contained a bug for functions which are `BuiltinFunction`s but used to be directly evaluated using `Function`'s `__call__` method, as opposed to the one now in `BuiltinFunction` (which used to only be used for `GinacFunction`).
Can one of you take a look at comment:31:ticket:13246 to help us ascertain which one it is?   Thanks!
