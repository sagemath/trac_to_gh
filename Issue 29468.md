# Issue 29468: Meta-ticket: Modularize sagelib into separate distutils packages

archive/issues_029468.json:
```json
{
    "body": "CC:  vdelecroix mjo fbissey isuruf tscrim @kliem jhpalmieri @tobiasdiez defeo @thierry-freebsd aschilling\n\n(From https://groups.google.com/d/msg/sage-devel/M9QTWtln6zU/UHwkrmTKBQAJ)\n\nModularize sagelib into separate distutils packages, so that these can be built and run with a much smaller set of libraries. The packages can be made available individually on !PyPI. The goal would be to do this **without changing the overall structure of the source tree**.\n\n1. In particular, create a package `sage_objects` that makes Sage objects, the element/parent framework, categories, the coercion system and the related metaclasses available. This package would, for example, not provide or know about integers, polynomials, or matrices (thus avoiding all the dependencies on the various libraries implementing these). Ideally it would only have a build dependency on Cython and no runtime dependencies. \n\n   (Doctesting `sage_objects` would still need more of Sage, but some it could also be done by mocking instead of with the real classes.)\n\n   a) These facilities could see a wider use in the mathematical Python community, and in this way we could hope to benefit from a larger developer base. For example, we would hope that `sage_objects` could be ported for use with PyPy instead of !CPython.\n\n   b) Building and deploying a user package would be easier if it could depend on a small package such as `sage_objects` only instead of the whole multigigabyteness of Sage.\n\n2. Remove the mechanism of `OptionalExtension`s from `sagelib`.\n\n   This is #29701 Meta-ticket: Replace use of `OptionalExtension` by namespace packages\n\n\n**Not** within the scope of this ticket:\n\n- We will not change the overall structure of the source tree (`SAGE_ROOT/src/sage`). We will achieve this by using the mechanism of native namespace packages introduced in Python 3.3 (see #28925).\n\n- It is not a prerequisite to fight against all circular imports. In particular, a parent class and its corresponding element class would certainly not be separated into separate distutils packages. \n\n**Constraints and challenges:**\n\n- The category framework can not really be separated from the `Parent`/`Element`/`CategoryObject` (e.g. coercion is involved in comparisons and binary operations).\n\n  Solution: These should therefore be in the same package `sage_objects`.\n\n- The category framework cannot live without the integers (e.g. the output of `.cardinality()` expects an integer). \n\n  Possible solution: The coercion system already has the notion of a global coercion model - which is determined at runtime, not compile time (`sage.structure.element.get_coercion_model`). When methods in `sage_objects` need to create an integer, they should obtain the appropriate class of integers in the same way.\n\n- Imports in `sage.categories`:\n\n```\n  bimodules imports QQ, RR\n  classical_crystals imports SR\n  finite_coxeter_groups imports QQbar\n```\n\n\n  One can try to not populate the whole category system.\n\n**Tickets and steps:**\n\n- #29411: make sagelib a script package\n- #29702: Move all code from `src/setup.py` to `sage_setup`\n- #21516: Fix sagelib sdist (src/setup.py sdist)\n- #29701: Meta-ticket: Replace use of `OptionalExtension` by namespace packages\n\n**Related:**\n- #21508 Meta-ticket: Clean up `src/setup.py` to bring it to standard distutils behavior\n\nIssue created by migration from https://trac.sagemath.org/ticket/29705\n\n",
    "created_at": "2020-05-17T19:27:41Z",
    "labels": [
        "refactoring",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "Meta-ticket: Modularize sagelib into separate distutils packages",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/29468",
    "user": "mkoeppe"
}
```
CC:  vdelecroix mjo fbissey isuruf tscrim @kliem jhpalmieri @tobiasdiez defeo @thierry-freebsd aschilling

(From https://groups.google.com/d/msg/sage-devel/M9QTWtln6zU/UHwkrmTKBQAJ)

Modularize sagelib into separate distutils packages, so that these can be built and run with a much smaller set of libraries. The packages can be made available individually on !PyPI. The goal would be to do this **without changing the overall structure of the source tree**.

1. In particular, create a package `sage_objects` that makes Sage objects, the element/parent framework, categories, the coercion system and the related metaclasses available. This package would, for example, not provide or know about integers, polynomials, or matrices (thus avoiding all the dependencies on the various libraries implementing these). Ideally it would only have a build dependency on Cython and no runtime dependencies. 

   (Doctesting `sage_objects` would still need more of Sage, but some it could also be done by mocking instead of with the real classes.)

   a) These facilities could see a wider use in the mathematical Python community, and in this way we could hope to benefit from a larger developer base. For example, we would hope that `sage_objects` could be ported for use with PyPy instead of !CPython.

   b) Building and deploying a user package would be easier if it could depend on a small package such as `sage_objects` only instead of the whole multigigabyteness of Sage.

2. Remove the mechanism of `OptionalExtension`s from `sagelib`.

   This is #29701 Meta-ticket: Replace use of `OptionalExtension` by namespace packages


**Not** within the scope of this ticket:

- We will not change the overall structure of the source tree (`SAGE_ROOT/src/sage`). We will achieve this by using the mechanism of native namespace packages introduced in Python 3.3 (see #28925).

- It is not a prerequisite to fight against all circular imports. In particular, a parent class and its corresponding element class would certainly not be separated into separate distutils packages. 

**Constraints and challenges:**

- The category framework can not really be separated from the `Parent`/`Element`/`CategoryObject` (e.g. coercion is involved in comparisons and binary operations).

  Solution: These should therefore be in the same package `sage_objects`.

- The category framework cannot live without the integers (e.g. the output of `.cardinality()` expects an integer). 

  Possible solution: The coercion system already has the notion of a global coercion model - which is determined at runtime, not compile time (`sage.structure.element.get_coercion_model`). When methods in `sage_objects` need to create an integer, they should obtain the appropriate class of integers in the same way.

- Imports in `sage.categories`:

```
  bimodules imports QQ, RR
  classical_crystals imports SR
  finite_coxeter_groups imports QQbar
```


  One can try to not populate the whole category system.

**Tickets and steps:**

- #29411: make sagelib a script package
- #29702: Move all code from `src/setup.py` to `sage_setup`
- #21516: Fix sagelib sdist (src/setup.py sdist)
- #29701: Meta-ticket: Replace use of `OptionalExtension` by namespace packages

**Related:**
- #21508 Meta-ticket: Clean up `src/setup.py` to bring it to standard distutils behavior

Issue created by migration from https://trac.sagemath.org/ticket/29705





---

archive/issue_comments_418227.json:
```json
{
    "body": "Changing keywords from \"\" to \"sd109\".",
    "created_at": "2020-05-28T06:10:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29468",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29468#issuecomment-418227",
    "user": "mkoeppe"
}
```

Changing keywords from "" to "sd109".



---

archive/issue_comments_418228.json:
```json
{
    "body": "Last 10 new commits:",
    "created_at": "2020-06-03T18:20:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29468",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29468#issuecomment-418228",
    "user": "mkoeppe"
}
```

Last 10 new commits:



---

archive/issue_comments_418229.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-06-03T19:05:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29468",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29468#issuecomment-418229",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_418230.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-06-03T19:27:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29468",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29468#issuecomment-418230",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_418231.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2020-06-03T20:37:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29468",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29468#issuecomment-418231",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_418232.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-06-03T21:46:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29468",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29468#issuecomment-418232",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_418233.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-06-03T23:36:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29468",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29468#issuecomment-418233",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_418234.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-06-04T06:22:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29468",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29468#issuecomment-418234",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_418235.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:",
    "created_at": "2020-06-11T01:19:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29468",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29468#issuecomment-418235",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:



---

archive/issue_comments_418236.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-06-11T02:52:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29468",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29468#issuecomment-418236",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_418237.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-06-11T03:56:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29468",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29468#issuecomment-418237",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_418238.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-06-11T06:20:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29468",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29468#issuecomment-418238",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_418239.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2020-06-11T07:07:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29468",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29468#issuecomment-418239",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_418240.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-06-15T01:17:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29468",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29468#issuecomment-418240",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_418241.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-06-15T02:25:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29468",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29468#issuecomment-418241",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_418242.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-06-15T04:03:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29468",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29468#issuecomment-418242",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_418243.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-06-15T04:07:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29468",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29468#issuecomment-418243",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_418244.json:
```json
{
    "body": "Changing keywords from \"sd109\" to \"sd109, sd110\".",
    "created_at": "2020-10-26T21:37:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29468",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29468#issuecomment-418244",
    "user": "mkoeppe"
}
```

Changing keywords from "sd109" to "sd109, sd110".



---

archive/issue_comments_418245.json:
```json
{
    "body": "Changing keywords from \"sd109, sd110\" to \"sd109, sd110, sd111\".",
    "created_at": "2020-11-22T19:36:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29468",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29468#issuecomment-418245",
    "user": "mkoeppe"
}
```

Changing keywords from "sd109, sd110" to "sd109, sd110, sd111".
