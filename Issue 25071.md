# Issue 25071: sage -t --show-skipped says "5 latex tests not run" while they are

Issue created by migration from Trac.

Original creator: slabbe

Original creation time: 2018-05-08 09:11:33

First I add a problem in the output of a `#optional - latex` doctest:

```diff
diff --git a/src/sage/misc/latex.py b/src/sage/misc/latex.py
index 4771a1c..01e9cb4 100644
--- a/src/sage/misc/latex.py
+++ b/src/sage/misc/latex.py
`@``@` -1548,7 +1548,7 `@``@` Warning: `{}` is not part of this computer's TeX installation.""".format(file_na
             sage: latex.add_package_to_preamble_if_available("xypic")
             sage: latex.add_package_to_preamble_if_available("nonexistent_package")
             sage: latex.extra_preamble()       # optional - latex
-            '\\usepackage{xypic}\n'
+            '\\usepackage{xypic}\n' PROBLEM
             sage: latex.extra_preamble('')
         """
         assert isinstance(package_name, str)
```


Then this is OK:


```
$ sage -t --show-skipped src/sage/misc/latex.py
Using --optional=ccache,dot2tex,mpir,notedown,pandoc_attributes,python2,rst2ipynb,sage
Doctesting 1 file.
sage -t src/sage/misc/latex.py
    1 imagemagick test not run
    5 latex tests not run
    3 other tests skipped
    [310 tests, 1.23 s]
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
```


Then, writing `--optional=sage,external` detects that `latex` is available and runs the 5  `latex` optional tests.


```
$ sage -t --show-skipped --optional=sage,external src/sage/misc/latex.py
Using --optional=external,sage
External software to be detected: cplex,gurobi,internet,latex,macaulay2,magma,maple,mathematica,matlab,octave,scilab
Doctesting 1 file.
sage -t src/sage/misc/latex.py
**********************************************************************
File "src/sage/misc/latex.py", line 1550, in sage.misc.latex.Latex.add_package_to_preamble_if_available
Failed example:
    latex.extra_preamble()       # optional - latex
Expected:
    '\\usepackage{xypic}\n' PROBLEM
Got:
    '\\usepackage{xypic}\n'
**********************************************************************
1 item had failures:
   1 of   5 in sage.misc.latex.Latex.add_package_to_preamble_if_available
    1 imagemagick test not run
    5 latex tests not run
    3 other tests skipped
    [315 tests, 1 failure, 1.55 s]
----------------------------------------------------------------------
sage -t src/sage/misc/latex.py  # 1 doctest failed
----------------------------------------------------------------------
Total time for all tests: 1.8 seconds
    cpu time: 0.6 seconds
    cumulative wall time: 1.5 seconds
External software detected for doctesting: latex
```


But `--show-skipped` still says that `5 latex tests not run`.


---

Comment by slabbe created at 2018-05-08 09:36:26

Changing status from new to needs_review.


---

Comment by slabbe created at 2018-05-08 09:36:26

New commits:


---

Comment by jdemeyer created at 2018-05-08 10:25:37

While this probably solves the problem, I wonder if we could just update `self.controller.options.optional` or have some API to return the optional tags.


---

Comment by slabbe created at 2018-05-08 12:21:08

The header of the `external.py` says that the detection of external software is done lazily:


```
"""
Detecting external software

This module makes up a list of external software that Sage interfaces. Availability
of each software is tested only when necessary. This is mainly used for the doctests
which require certain external software installed on the system.

...

class AvailableSoftware(object):
    """
    This class keeps the set of available software whose availability is detected lazily
    from the list of external software.

...

```


So what you mean is to update `self.controller.options.optional` every time an external software is detected?


---

Comment by jdemeyer created at 2018-05-09 07:49:58

To be honest, I don't know exactly what I mean. I was more thinking of abstracting this check in a method like

```python
def have_optional_tag(self, tag):
    if tag in self.controller.options.optional:
        return True
    if 'external' in self.controller.options.optional:
        if tag in available_software.seen():
            return True
    return False
```

and then using that.


---

Comment by git created at 2018-05-10 08:32:58

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by slabbe created at 2018-05-10 08:34:07

Good idea. I added such a method. And I rebased the branch on top on 8.3.beta0 to avoid merge commits.


---

Comment by git created at 2018-05-10 08:37:56

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by slabbe created at 2018-05-10 08:41:50

Improved doc. Re-needs review.


---

Comment by slabbe created at 2018-06-19 20:58:22

ping


---

Comment by vklein created at 2018-06-20 12:56:24

Changing status from needs_review to positive_review.


---

Comment by vklein created at 2018-06-20 12:56:24

Tested. It's fine for me.


---

Comment by slabbe created at 2018-06-20 20:13:14

Thanks for the review.


---

Comment by vbraun created at 2018-06-21 17:26:23

Resolution: fixed
