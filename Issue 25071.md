# Issue 25071: sage -t --show-skipped says "5 latex tests not run" while they are

archive/issues_025071.json:
```json
{
    "body": "First I add a problem in the output of a `#optional - latex` doctest:\n\n```diff\ndiff --git a/src/sage/misc/latex.py b/src/sage/misc/latex.py\nindex 4771a1c..01e9cb4 100644\n--- a/src/sage/misc/latex.py\n+++ b/src/sage/misc/latex.py\n@@ -1548,7 +1548,7 @@ Warning: `{}` is not part of this computer's TeX installation.\"\"\".format(file_na\n             sage: latex.add_package_to_preamble_if_available(\"xypic\")\n             sage: latex.add_package_to_preamble_if_available(\"nonexistent_package\")\n             sage: latex.extra_preamble()       # optional - latex\n-            '\\\\usepackage{xypic}\\n'\n+            '\\\\usepackage{xypic}\\n' PROBLEM\n             sage: latex.extra_preamble('')\n         \"\"\"\n         assert isinstance(package_name, str)\n```\n\n\nThen this is OK:\n\n\n```\n$ sage -t --show-skipped src/sage/misc/latex.py\nUsing --optional=ccache,dot2tex,mpir,notedown,pandoc_attributes,python2,rst2ipynb,sage\nDoctesting 1 file.\nsage -t src/sage/misc/latex.py\n    1 imagemagick test not run\n    5 latex tests not run\n    3 other tests skipped\n    [310 tests, 1.23 s]\n----------------------------------------------------------------------\nAll tests passed!\n----------------------------------------------------------------------\n```\n\n\nThen, writing `--optional=sage,external` detects that `latex` is available and runs the 5  `latex` optional tests.\n\n\n```\n$ sage -t --show-skipped --optional=sage,external src/sage/misc/latex.py\nUsing --optional=external,sage\nExternal software to be detected: cplex,gurobi,internet,latex,macaulay2,magma,maple,mathematica,matlab,octave,scilab\nDoctesting 1 file.\nsage -t src/sage/misc/latex.py\n**********************************************************************\nFile \"src/sage/misc/latex.py\", line 1550, in sage.misc.latex.Latex.add_package_to_preamble_if_available\nFailed example:\n    latex.extra_preamble()       # optional - latex\nExpected:\n    '\\\\usepackage{xypic}\\n' PROBLEM\nGot:\n    '\\\\usepackage{xypic}\\n'\n**********************************************************************\n1 item had failures:\n   1 of   5 in sage.misc.latex.Latex.add_package_to_preamble_if_available\n    1 imagemagick test not run\n    5 latex tests not run\n    3 other tests skipped\n    [315 tests, 1 failure, 1.55 s]\n----------------------------------------------------------------------\nsage -t src/sage/misc/latex.py  # 1 doctest failed\n----------------------------------------------------------------------\nTotal time for all tests: 1.8 seconds\n    cpu time: 0.6 seconds\n    cumulative wall time: 1.5 seconds\nExternal software detected for doctesting: latex\n```\n\n\nBut `--show-skipped` still says that `5 latex tests not run`.\n\nIssue created by migration from https://trac.sagemath.org/ticket/25308\n\n",
    "created_at": "2018-05-08T09:11:33Z",
    "labels": [
        "doctest framework",
        "major",
        "bug"
    ],
    "title": "sage -t --show-skipped says \"5 latex tests not run\" while they are",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/25071",
    "user": "slabbe"
}
```
First I add a problem in the output of a `#optional - latex` doctest:

```diff
diff --git a/src/sage/misc/latex.py b/src/sage/misc/latex.py
index 4771a1c..01e9cb4 100644
--- a/src/sage/misc/latex.py
+++ b/src/sage/misc/latex.py
@@ -1548,7 +1548,7 @@ Warning: `{}` is not part of this computer's TeX installation.""".format(file_na
             sage: latex.add_package_to_preamble_if_available("xypic")
             sage: latex.add_package_to_preamble_if_available("nonexistent_package")
             sage: latex.extra_preamble()       # optional - latex
-            '\\usepackage{xypic}\n'
+            '\\usepackage{xypic}\n' PROBLEM
             sage: latex.extra_preamble('')
         """
         assert isinstance(package_name, str)
```


Then this is OK:


```
$ sage -t --show-skipped src/sage/misc/latex.py
Using --optional=ccache,dot2tex,mpir,notedown,pandoc_attributes,python2,rst2ipynb,sage
Doctesting 1 file.
sage -t src/sage/misc/latex.py
    1 imagemagick test not run
    5 latex tests not run
    3 other tests skipped
    [310 tests, 1.23 s]
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
```


Then, writing `--optional=sage,external` detects that `latex` is available and runs the 5  `latex` optional tests.


```
$ sage -t --show-skipped --optional=sage,external src/sage/misc/latex.py
Using --optional=external,sage
External software to be detected: cplex,gurobi,internet,latex,macaulay2,magma,maple,mathematica,matlab,octave,scilab
Doctesting 1 file.
sage -t src/sage/misc/latex.py
**********************************************************************
File "src/sage/misc/latex.py", line 1550, in sage.misc.latex.Latex.add_package_to_preamble_if_available
Failed example:
    latex.extra_preamble()       # optional - latex
Expected:
    '\\usepackage{xypic}\n' PROBLEM
Got:
    '\\usepackage{xypic}\n'
**********************************************************************
1 item had failures:
   1 of   5 in sage.misc.latex.Latex.add_package_to_preamble_if_available
    1 imagemagick test not run
    5 latex tests not run
    3 other tests skipped
    [315 tests, 1 failure, 1.55 s]
----------------------------------------------------------------------
sage -t src/sage/misc/latex.py  # 1 doctest failed
----------------------------------------------------------------------
Total time for all tests: 1.8 seconds
    cpu time: 0.6 seconds
    cumulative wall time: 1.5 seconds
External software detected for doctesting: latex
```


But `--show-skipped` still says that `5 latex tests not run`.

Issue created by migration from https://trac.sagemath.org/ticket/25308





---

archive/issue_comments_352743.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-05-08T09:36:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25071#issuecomment-352743",
    "user": "slabbe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_352744.json:
```json
{
    "body": "New commits:",
    "created_at": "2018-05-08T09:36:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25071#issuecomment-352744",
    "user": "slabbe"
}
```

New commits:



---

archive/issue_comments_352745.json:
```json
{
    "body": "While this probably solves the problem, I wonder if we could just update `self.controller.options.optional` or have some API to return the optional tags.",
    "created_at": "2018-05-08T10:25:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25071#issuecomment-352745",
    "user": "jdemeyer"
}
```

While this probably solves the problem, I wonder if we could just update `self.controller.options.optional` or have some API to return the optional tags.



---

archive/issue_comments_352746.json:
```json
{
    "body": "The header of the `external.py` says that the detection of external software is done lazily:\n\n\n```\n\"\"\"\nDetecting external software\n\nThis module makes up a list of external software that Sage interfaces. Availability\nof each software is tested only when necessary. This is mainly used for the doctests\nwhich require certain external software installed on the system.\n\n...\n\nclass AvailableSoftware(object):\n    \"\"\"\n    This class keeps the set of available software whose availability is detected lazily\n    from the list of external software.\n\n...\n\n```\n\n\nSo what you mean is to update `self.controller.options.optional` every time an external software is detected?",
    "created_at": "2018-05-08T12:21:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25071#issuecomment-352746",
    "user": "slabbe"
}
```

The header of the `external.py` says that the detection of external software is done lazily:


```
"""
Detecting external software

This module makes up a list of external software that Sage interfaces. Availability
of each software is tested only when necessary. This is mainly used for the doctests
which require certain external software installed on the system.

...

class AvailableSoftware(object):
    """
    This class keeps the set of available software whose availability is detected lazily
    from the list of external software.

...

```


So what you mean is to update `self.controller.options.optional` every time an external software is detected?



---

archive/issue_comments_352747.json:
```json
{
    "body": "To be honest, I don't know exactly what I mean. I was more thinking of abstracting this check in a method like\n\n```python\ndef have_optional_tag(self, tag):\n    if tag in self.controller.options.optional:\n        return True\n    if 'external' in self.controller.options.optional:\n        if tag in available_software.seen():\n            return True\n    return False\n```\n\nand then using that.",
    "created_at": "2018-05-09T07:49:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25071#issuecomment-352747",
    "user": "jdemeyer"
}
```

To be honest, I don't know exactly what I mean. I was more thinking of abstracting this check in a method like

```python
def have_optional_tag(self, tag):
    if tag in self.controller.options.optional:
        return True
    if 'external' in self.controller.options.optional:
        if tag in available_software.seen():
            return True
    return False
```

and then using that.



---

archive/issue_comments_352748.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-05-10T08:32:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25071#issuecomment-352748",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_352749.json:
```json
{
    "body": "Good idea. I added such a method. And I rebased the branch on top on 8.3.beta0 to avoid merge commits.",
    "created_at": "2018-05-10T08:34:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25071#issuecomment-352749",
    "user": "slabbe"
}
```

Good idea. I added such a method. And I rebased the branch on top on 8.3.beta0 to avoid merge commits.



---

archive/issue_comments_352750.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-05-10T08:37:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25071#issuecomment-352750",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_352751.json:
```json
{
    "body": "Improved doc. Re-needs review.",
    "created_at": "2018-05-10T08:41:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25071#issuecomment-352751",
    "user": "slabbe"
}
```

Improved doc. Re-needs review.



---

archive/issue_comments_352752.json:
```json
{
    "body": "ping",
    "created_at": "2018-06-19T20:58:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25071#issuecomment-352752",
    "user": "slabbe"
}
```

ping



---

archive/issue_comments_352753.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-06-20T12:56:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25071#issuecomment-352753",
    "user": "vklein"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_352754.json:
```json
{
    "body": "Tested. It's fine for me.",
    "created_at": "2018-06-20T12:56:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25071#issuecomment-352754",
    "user": "vklein"
}
```

Tested. It's fine for me.



---

archive/issue_comments_352755.json:
```json
{
    "body": "Thanks for the review.",
    "created_at": "2018-06-20T20:13:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25071#issuecomment-352755",
    "user": "slabbe"
}
```

Thanks for the review.



---

archive/issue_comments_352756.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-06-21T17:26:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25071#issuecomment-352756",
    "user": "vbraun"
}
```

Resolution: fixed
